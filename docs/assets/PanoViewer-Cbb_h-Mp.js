const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./tile-ktx2-B4BUbLBp.js","./index-CGaPg6Yv.js","./three-core-0fX1SOzE.js","./externalImage-DivuH3Vy.js","./three-extras-9r4FsFIk.js","./index-BfJu72vJ.css"])))=>i.map(i=>d[i]);
var me=Object.defineProperty;var pe=(m,e,t)=>e in m?me(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var r=(m,e,t)=>pe(m,typeof e!="symbol"?e+"":e,t);import{b as ae,i as M,n as ge,o as fe,d as f,e as V,r as R,A as Y,L as w,_ as we,s as re,c as be}from"./index-CGaPg6Yv.js";import{aM as x,r as $,aN as ve,a2 as _,a1 as ye,M as H,aO as Le,aP as Me,j as P,aQ as Se,aR as Ie,V as ce,R as Te,e as Pe,_ as k,U,an as B,c as de,S as ke,P as Ce,H as oe,aS as Ee,aT as xe,W as Ae}from"./three-core-0fX1SOzE.js";import{loadExternalImageBitmap as F,ExternalImageLoadError as De}from"./externalImage-DivuH3Vy.js";function Re(m=512){const e=document.createElement("canvas");e.width=m,e.height=m;const t=e.getContext("2d");if(!t){const l=new x(e);return l.needsUpdate=!0,l}const s=m/2,i=m/2,a=m/2*.92;t.clearRect(0,0,m,m);const o=t.createRadialGradient(s,i,a*.25,s,i,a);o.addColorStop(0,"rgba(0,0,0,0.00)"),o.addColorStop(.55,"rgba(0,0,0,0.18)"),o.addColorStop(1,"rgba(0,0,0,0.55)"),t.fillStyle=o,t.beginPath(),t.arc(s,i,a,0,Math.PI*2),t.closePath(),t.fill(),t.fillStyle="rgba(0,0,0,0.55)",t.beginPath(),t.arc(s,i,a*.28,0,Math.PI*2),t.closePath(),t.fill();const h=t.createRadialGradient(s,i,0,s,i,a*.42);h.addColorStop(0,"rgba(0,0,0,0.22)"),h.addColorStop(1,"rgba(0,0,0,0.00)"),t.fillStyle=h,t.beginPath(),t.arc(s,i,a*.42,0,Math.PI*2),t.closePath(),t.fill(),t.save(),t.translate(s,i);for(let l=0;l<360;l+=30){const u=l*Math.PI/180,c=l%90===0,d=c?a*.12:a*.07,g=c?2:1;t.strokeStyle=c?"rgba(255,255,255,0.25)":"rgba(255,255,255,0.14)",t.lineWidth=g,t.beginPath(),t.moveTo(Math.sin(u)*(a-d),-Math.cos(u)*(a-d)),t.lineTo(Math.sin(u)*a,-Math.cos(u)*a),t.stroke()}t.restore(),t.strokeStyle="rgba(255,255,255,0.08)",t.lineWidth=2,t.beginPath(),t.arc(s,i,a,0,Math.PI*2),t.closePath(),t.stroke();const n=new x(e);return n.colorSpace=$,n.center.set(.5,.5),n.rotation=0,n.flipY=!1,n.needsUpdate=!0,n}function Ye(m){return Math.max(0,Math.min(1,m))}function Ne(m){const e=Ye(m);return e*e*(3-2*e)}class _e{constructor(e,t){r(this,"mesh");r(this,"needleMesh",null);r(this,"texture");r(this,"radius");r(this,"opacity",0);r(this,"northYaw",0);r(this,"debugHelper",null);r(this,"labelSprites",new Map);r(this,"patchRadius",0);r(this,"showPitchDeg",-45);r(this,"fadeRangeDeg",18);r(this,"fadeTauMs",140);r(this,"lastRotationY",0);r(this,"debugFrameCount",0);r(this,"isDebugVisible",!0);this.radius=t;const s=t*.18;this.patchRadius=s;const i=new ve(s,96);i.rotateX(Math.PI/2),this.texture=Re(512);const a=new _({map:this.texture,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1,side:ye});this.mesh=new H(i,a),this.mesh.name="NadirPatch-compass-disk",this.mesh.position.set(0,-t+.5,0),this.mesh.renderOrder=9999,this.mesh.visible=!1,this.mesh.rotation.y=0,e.add(this.mesh);const o=s*.008,h=s*.35,n=new Le(o,o,h,8);n.rotateX(Math.PI/2),n.translate(0,0,h/2);const l=new _({color:16777215,transparent:!0,opacity:.9,depthTest:!1,depthWrite:!1});if(this.needleMesh=new H(n,l),this.needleMesh.name="NadirPatch-compass-needle",this.needleMesh.position.set(0,-t+.51,0),this.needleMesh.rotation.order="YXZ",this.needleMesh.renderOrder=1e4,this.needleMesh.visible=!1,e.add(this.needleMesh),this.createLabelSprites(e,s,t),ae&&(a.color.setHex(65535),this.debugHelper=new Me(s*.5),this.debugHelper.position.copy(this.mesh.position),this.debugHelper.renderOrder=10001,e.add(this.debugHelper),console.debug("[NadirPatch] 对象已创建:",{uuid:this.mesh.uuid,name:this.mesh.name,type:this.mesh.type,position:this.mesh.position,rotation:this.mesh.rotation})),typeof window<"u"){const u=c=>{(c.key==="N"||c.key==="n")&&!(c.target instanceof HTMLInputElement||c.target instanceof HTMLTextAreaElement)&&(c.preventDefault(),this.isDebugVisible=!this.isDebugVisible,this.mesh.visible=this.isDebugVisible&&this.opacity>.01,this.needleMesh&&(this.needleMesh.visible=this.isDebugVisible&&this.opacity>.01),this.debugHelper&&(this.debugHelper.visible=this.isDebugVisible&&this.opacity>.01),console.debug(`[NadirPatch] 显示状态切换为: ${this.isDebugVisible?"显示":"隐藏"}`))};window.addEventListener("keydown",u)}}setNorthYaw(e){this.northYaw=e}update(e,t,s){var g;const i=t.yaw,a=this.northYaw??0,o=P.degToRad(-a);this.mesh.rotation.y=o,this.texture.rotation=0,this.texture.center.set(.5,.5);const h=-a;this.updateLabelSprites(h),this.needleMesh&&(this.needleMesh.rotation.y=P.degToRad(i)),ae&&(this.debugFrameCount++,this.debugFrameCount%30===0&&(Math.abs(this.mesh.rotation.y-this.lastRotationY)>.001&&console.debug("[NadirPatch] 旋转变化:",{frame:this.debugFrameCount,cameraYaw:i.toFixed(2),northYaw:a.toFixed(2),needleYaw:i.toFixed(2),diskRotationY:this.mesh.rotation.y,needleRotationY:(g=this.needleMesh)==null?void 0:g.rotation.y,diskPosition:this.mesh.position}),this.lastRotationY=this.mesh.rotation.y));const l=Ne((this.showPitchDeg-t.pitch)/this.fadeRangeDeg),u=1-Math.exp(-(s||16.7)/this.fadeTauMs);this.opacity=this.opacity+(l-this.opacity)*u;const c=this.mesh.material;c.opacity=this.opacity;const d=this.isDebugVisible&&this.opacity>.01;if(this.mesh.visible=d,this.needleMesh){this.needleMesh.visible=d;const p=this.needleMesh.material;p.opacity=this.opacity*.9}this.labelSprites.forEach(p=>{p.visible=d;const v=p.material;v.opacity=this.opacity*.85}),this.debugHelper&&(this.debugHelper.visible=d)}createLabelSprites(e,t,s){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:a})=>{const o=document.createElement("canvas"),h=128;o.width=h,o.height=h;const n=o.getContext("2d");if(!n)return;n.clearRect(0,0,h,h),n.save(),n.shadowColor="rgba(255, 255, 255, 0.8)",n.shadowBlur=8,n.shadowOffsetX=0,n.shadowOffsetY=0,n.fillStyle="rgba(255, 255, 255, 0.85)",n.font=`600 ${Math.round(h*.5)}px system-ui, -apple-system, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(a,h/2,h/2),n.restore();const l=new x(o);l.colorSpace=$,l.needsUpdate=!0;const u=new Se({map:l,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1}),c=new Ie(u);c.name=`NadirPatch-label-${a}`,c.position.set(0,-s+.52,0),c.renderOrder=10001,c.visible=!1;const d=t*.15;c.scale.set(d,d,1),e.add(c),this.labelSprites.set(a,c)})}updateLabelSprites(e){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:s,baseAngle:i})=>{const a=this.labelSprites.get(s);if(!a)return;const o=i+e,h=this.patchRadius*.56,n=P.degToRad(o),l=-this.radius+.5,u=Math.sin(n)*h,c=Math.cos(n)*h;a.position.set(u,l+.02,c);const d=new ce(0,0,0);a.lookAt(d)})}dispose(e){e.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose(),this.needleMesh&&(e.remove(this.needleMesh),this.needleMesh.geometry.dispose(),this.needleMesh.material.dispose()),this.labelSprites.forEach(t=>{e.remove(t),t.material.dispose(),t.material.map&&t.material.map.dispose()}),this.labelSprites.clear(),this.debugHelper&&(e.remove(this.debugHelper),this.debugHelper.dispose())}}function He(m,e,t){const s=(m-t.left)/t.width*2-1,i=-((e-t.top)/t.height*2-1);return{x:s,y:i}}function Fe(m,e,t,s=500){const i=new Te;i.setFromCamera(new Pe(m,e),t);const a=i.ray.direction;if(!a||a.length()===0)return null;const o=a.normalize(),h=Math.asin(Math.max(-1,Math.min(1,o.y))),n=P.radToDeg(h),l=Math.atan2(o.x,o.z);return{yaw:P.radToDeg(l),pitch:n}}const Q=-55,$e=-90;function q(m){const e=Math.max(0,Math.min(1,(m-Q)/($e-Q))),t=e,s=-e*8,i=1-e*.7,a=e*2;return{opacity:t,translateY:s,scaleY:i,blur:a,clarity:e}}function Z(m){return m<=Q}class Ve{constructor(e={}){r(this,"root");r(this,"disk");r(this,"mask");r(this,"polemask");r(this,"northLabel");r(this,"eastLabel");r(this,"southLabel");r(this,"westLabel");r(this,"needle");r(this,"currentYaw",0);r(this,"currentPitch",0);r(this,"northYaw",0);r(this,"sceneId","");r(this,"northYawLabel",null);r(this,"isVisible",!1);r(this,"unsubscribeInteracting",null);r(this,"unsubscribeIdle",null);r(this,"unsubscribeUIEngaged",null);r(this,"baseOpacity",0);this.root=document.createElement("div"),this.root.className="vr-compass",this.root.setAttribute("data-ui","CompassDisk"),this.root.style.outline="2px solid #ff00ff",this.disk=document.createElement("div"),this.disk.className="vr-compass__disk",this.disk.setAttribute("data-ui","CompassDisk-disk"),this.mask=document.createElement("div"),this.mask.className="vr-compass__mask",this.polemask=document.createElement("div"),this.polemask.className="vr-compass__polemask",this.polemask.setAttribute("aria-hidden","true"),this.northLabel=document.createElement("div"),this.northLabel.className="vr-compass__label vr-compass__label--north",this.northLabel.textContent="北",this.eastLabel=document.createElement("div"),this.eastLabel.className="vr-compass__label vr-compass__label--east",this.eastLabel.textContent="东",this.southLabel=document.createElement("div"),this.southLabel.className="vr-compass__label vr-compass__label--south",this.southLabel.textContent="南",this.westLabel=document.createElement("div"),this.westLabel.className="vr-compass__label vr-compass__label--west",this.westLabel.textContent="西",this.needle=document.createElement("div"),this.needle.className="vr-compass__needle",this.needle.setAttribute("data-ui","CompassDisk-needle"),this.northYawLabel=document.createElement("div"),this.northYawLabel.className="vr-compass__north-yaw-label",this.northYawLabel.style.cssText=`
      position: absolute;
      bottom: -20px;
      right: 10px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
      font-family: monospace;
      pointer-events: none;
      display: none;
    `,this.disk.appendChild(this.mask),this.disk.appendChild(this.polemask),this.disk.appendChild(this.northLabel),this.disk.appendChild(this.eastLabel),this.disk.appendChild(this.southLabel),this.disk.appendChild(this.westLabel),this.disk.appendChild(this.needle),this.root.appendChild(this.disk),this.root.appendChild(this.northYawLabel),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--compass-disk-rot","0deg"),this.root.style.setProperty("--compass-needle-rot","0deg"),this.root.style.setProperty("--compass-label-counter-rot","0deg"),this.setupInteractionListeners()}setupInteractionListeners(){this.unsubscribeInteracting=M.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=M.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=M.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}mount(e){e.appendChild(this.root)}setSceneId(e){this.sceneId=e,this.updateNorthYawLabel()}setNorthYaw(e){this.northYaw=e,this.updateNorthYawLabel()}updateNorthYawLabel(){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}updateYawLabel(e){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)} Yaw=${e.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,Z(t)){const i=q(t);this.baseOpacity=i.opacity,this.root.style.setProperty("--vr-ground-clarity",String(i.clarity)),this.root.style.opacity=i.opacity.toString();const a=`translateX(-50%) translateY(${i.translateY}px) scaleY(${i.scaleY})`;this.root.classList.contains("vr-ui-interacting")?this.root.style.transform=a:this.root.style.transform=a,this.root.style.setProperty("--vr-ground-base-blur",`${i.blur}px`);const o=e,n=-(this.northYaw??0),l=o;this.root.style.setProperty("--compass-disk-rot",`${n}deg`),this.root.style.setProperty("--compass-needle-rot",`${l}deg`);const u=42,c=(d,g)=>{const p=g+n,v=p+180;d.style.transform=`rotate(${p}deg) translateY(-${u}%) rotate(${v}deg)`};c(this.northLabel,0),c(this.eastLabel,270),c(this.southLabel,180),c(this.westLabel,90),this.updateYawLabel(e),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.northLabel.style.transform="",this.eastLabel.style.transform="",this.southLabel.style.transform="",this.westLabel.style.transform="",this.isVisible=!1,this.baseOpacity=0)}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=null),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=null),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=null),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}const ne=60,G=14,ze=4,he=650,Ue=120,le=900,z=-62,Oe=150;class We{constructor(e){r(this,"root");r(this,"container");r(this,"dots",new Map);r(this,"dotYawDeg",new Map);r(this,"currentYaw",0);r(this,"currentPitch",0);r(this,"isVisible",!1);r(this,"museumId");r(this,"currentSceneId");r(this,"sceneHotspots");r(this,"hoverSceneId",null);r(this,"onNavigateToScene");r(this,"unsubscribeFocus");r(this,"lastYawDeg",0);r(this,"lastPitchDeg",0);r(this,"aimedSceneId",null);r(this,"isInteracting",!1);r(this,"unsubscribeInteracting");r(this,"unsubscribeIdle");r(this,"unsubscribeUIEngaged");r(this,"idleRecoveryTimer",null);r(this,"lastAimChangeTs",0);r(this,"autoNavTimer",null);r(this,"autoNavTargetSceneId",null);r(this,"lastAutoNavTs",0);r(this,"aimDebounceTimer",null);this.museumId=e.museumId,this.currentSceneId=e.currentSceneId,this.sceneHotspots=e.sceneHotspots,this.onNavigateToScene=e.onNavigateToScene||ge,this.root=document.createElement("div"),this.root.className="vr-groundnav",this.root.setAttribute("data-ui","GroundNavDots"),this.root.style.outline="2px solid #00ffff",this.container=document.createElement("div"),this.container.className="vr-groundnav__container",this.root.appendChild(this.container),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.unsubscribeFocus=fe(t=>{this.handleSceneFocus(t)}),this.setupInteractionListeners(),this.renderDots()}setupInteractionListeners(){this.unsubscribeInteracting=M.on("user-interacting",()=>{f("统一终止触发点: 用户交互"),this.isInteracting=!0,this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav()}),this.unsubscribeIdle=M.on("user-idle",()=>{this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.idleRecoveryTimer=window.setTimeout(()=>{if(this.idleRecoveryTimer=null,!this.root.parentNode){f("idleRecoveryTimer: component disposed, skipping");return}this.isInteracting=!1},400)}),this.unsubscribeUIEngaged=M.on("ui-engaged",()=>{f("统一终止触发点: UI 点击"),this.clearAllTimers(),this.isInteracting=!1,this.clearAimed(),this.cancelAutoNav()})}clearAimDebounce(){this.aimDebounceTimer!==null&&(window.clearTimeout(this.aimDebounceTimer),this.aimDebounceTimer=null)}clearAllTimers(){this.clearAimDebounce(),this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.autoNavTimer!==null&&(clearTimeout(this.autoNavTimer),this.autoNavTimer=null)}normalizeDeg(e){return(e%360+360)%360}shortestDeltaDeg(e,t){return(this.normalizeDeg(e)-this.normalizeDeg(t)+180)%360-180}clearAimed(){if(this.aimedSceneId!==null){const e=this.dots.get(this.aimedSceneId);e&&(e.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId)),this.aimedSceneId=null,this.clearAimDebounce(),this.emitSceneAim("clear",null)}this.cancelAutoNav()}cancelAutoNav(){if(this.autoNavTimer!=null&&(window.clearTimeout(this.autoNavTimer),this.autoNavTimer=null),this.autoNavTargetSceneId!==null){const e=this.autoNavTargetSceneId;if(e){this.removeProgress(e);const t=this.dots.get(e);t&&t.classList.remove("is-autonav","is-autonav-progress"),this.emitSceneAutoNav("cancel",e)}this.autoNavTargetSceneId=null}}removeProgress(e){const t=this.dots.get(e);if(!t)return;const s=t.querySelector(".vr-groundnav__progress");s&&t.removeChild(s)}addProgress(e){const t=this.dots.get(e);if(!t)return;this.removeProgress(e);const s=document.createElement("div");s.className="vr-groundnav__progress",s.style.setProperty("--progress-duration",`${he}ms`),t.appendChild(s),t.classList.add("is-autonav-progress")}scheduleAutoNavIfAllowed(e){if(!e){f("scheduleAutoNavIfAllowed: sceneId is missing, skipping");return}const t=Date.now();if(this.isInteracting){f("scheduleAutoNavIfAllowed: isInteracting, skipping");return}if(this.lastPitchDeg>z){f("scheduleAutoNavIfAllowed: pitch too high, skipping",this.lastPitchDeg);return}if(t-this.lastAutoNavTs<le){f("scheduleAutoNavIfAllowed: cooldown, skipping");return}if(t-this.lastAimChangeTs<Ue){f("scheduleAutoNavIfAllowed: min dwell, skipping");return}if(this.currentSceneId&&e===this.currentSceneId){f("scheduleAutoNavIfAllowed: same as current scene, skipping");return}this.autoNavTargetSceneId!==null&&this.autoNavTargetSceneId!==e&&this.cancelAutoNav(),f("scene-autonav: start",{sceneId:e}),this.autoNavTargetSceneId=e;const s=this.dots.get(e);s&&(s.classList.add("is-autonav"),this.addProgress(e)),this.emitSceneAutoNav("start",e),this.autoNavTimer=window.setTimeout(()=>{if(this.autoNavTimer=null,!this.root.parentNode){f("autoNavTimer: component disposed, skipping");return}if(!e){f("autoNavTimer: sceneId is missing, skipping");return}this.tryAutoNavigate(e)},he)}tryAutoNavigate(e){if(!e){f("tryAutoNavigate: sceneId is missing, skipping"),this.cancelAutoNav();return}if(this.isInteracting){f("tryAutoNavigate: isInteracting, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.aimedSceneId||this.aimedSceneId!==e){f("tryAutoNavigate: aimedSceneId mismatch, canceling",{aimedSceneId:this.aimedSceneId,sceneId:e}),this.cancelAutoNav(),this.clearAimed();return}if(this.lastPitchDeg>z){f("tryAutoNavigate: pitch too high, canceling",this.lastPitchDeg),this.cancelAutoNav(),this.clearAimed();return}const t=Date.now();if(t-this.lastAutoNavTs<le){f("tryAutoNavigate: cooldown, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.museumId){f("tryAutoNavigate: museumId is missing, canceling"),this.cancelAutoNav(),this.clearAimed();return}f("scene-autonav: trigger",{museumId:this.museumId,sceneId:e});const s=e;this.cancelAutoNav(),this.clearAimed(),this.lastAutoNavTs=t,window.dispatchEvent(new CustomEvent("vr:close-panels")),V({type:"focus",museumId:this.museumId,sceneId:s,source:"pano-auto",ts:t}),this.onNavigateToScene(this.museumId,s)}maybeRescheduleOrCancelByPitch(e){e>z?(this.autoNavTargetSceneId&&this.cancelAutoNav(),this.aimedSceneId&&this.clearAimed()):this.aimedSceneId&&e<=z&&!this.isInteracting&&!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(this.aimedSceneId)}emitSceneAim(e,t){if(!this.museumId){f("emitSceneAim: museumId is missing, skipping");return}f("scene-aim",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-aim",{detail:{type:e,museumId:this.museumId,sceneId:t||void 0,source:"groundnav",ts:Date.now()}}))}emitSceneAutoNav(e,t){if(!this.museumId){f("emitSceneAutoNav: museumId is missing, skipping");return}f("scene-autonav",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-autonav",{detail:{type:e,museumId:this.museumId,sceneId:t??void 0,ts:Date.now()}}))}updateAimed(e){if(this.isInteracting||!this.isVisible){this.clearAimed();return}const t=this.sceneHotspots.filter(o=>{var h;return(h=o.target)==null?void 0:h.sceneId});if(t.length===0){this.clearAimed();return}let s=null,i=1/0;t.forEach(o=>{const h=o.target.sceneId;if(h===this.currentSceneId)return;const n=o.yaw,l=Math.abs(this.shortestDeltaDeg(e,n));l<i&&(i=l,s=h)});let a=!1;if(s!==null&&(this.aimedSceneId===null?a=i<=G:s===this.aimedSceneId?a=i<=G+ze:a=i<=G),this.isInteracting){this.clearAimed();return}if(a&&s!==null)if(this.aimedSceneId!==s){if(this.lastAimChangeTs=Date.now(),this.cancelAutoNav(),this.aimedSceneId!==null){const h=this.dots.get(this.aimedSceneId);h&&(h.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId))}this.aimedSceneId=s;const o=this.dots.get(s);o&&o.classList.add("is-aimed"),this.clearAimDebounce(),this.aimDebounceTimer=window.setTimeout(()=>{if(this.aimDebounceTimer=null,!this.root.parentNode){f("aimDebounceTimer: component disposed, skipping");return}this.aimedSceneId===s&&!this.isInteracting&&this.isVisible?(this.emitSceneAim("aim",s),this.scheduleAutoNavIfAllowed(s)):this.aimedSceneId===s&&this.clearAimed()},Oe)}else!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(s);else this.clearAimed()}handleSceneFocus(e){e.type==="hover"?this.hoverSceneId=e.sceneId:e.type==="focus"&&(f("统一终止触发点: 场景切换",{sceneId:e.sceneId}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),e.sceneId&&(this.currentSceneId=e.sceneId),this.hoverSceneId=null),this.updateDotStates()}updateDotStates(){this.dots.forEach((e,t)=>{e.classList.remove("is-current","is-hover"),t===this.currentSceneId?e.classList.add("is-current"):t===this.hoverSceneId&&e.classList.add("is-hover")})}renderDots(){this.container.innerHTML="",this.dots.clear(),this.dotYawDeg.clear(),this.aimedSceneId=null,this.sceneHotspots.filter(t=>{var s;return(s=t.target)==null?void 0:s.sceneId}).forEach(t=>{const s=t.target.sceneId,i=document.createElement("div");i.className="vr-groundnav__dot",i.setAttribute("data-scene-id",s),i.setAttribute("title",t.label),this.dotYawDeg.set(s,t.yaw),i.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),M.emitUIEngaged(),V({type:"focus",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()}),window.dispatchEvent(new CustomEvent("vr:close-panels")),t.target.museumId&&t.target.sceneId?this.onNavigateToScene(t.target.museumId,t.target.sceneId):f("dot click: museumId or sceneId is missing, skipping navigation")}),i.addEventListener("mouseenter",()=>{V({type:"hover",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()})}),i.addEventListener("mouseleave",()=>{V({type:"hover",museumId:t.target.museumId,sceneId:null,source:"pano",ts:Date.now()})}),this.container.appendChild(i),this.dots.set(t.target.sceneId,i)}),this.updateDotStates(),this.updateDotPositions()}updateDotPositions(){this.sceneHotspots.filter(t=>{var s;return(s=t.target)==null?void 0:s.sceneId}).forEach(t=>{const s=this.dots.get(t.target.sceneId);if(!s)return;const i=t.yaw*Math.PI/180,a=Math.sin(i)*ne,o=-Math.cos(i)*ne;s.style.transform=`translate(${a}px, ${o}px)`})}setYawPitch(e,t){this.currentYaw=e,this.currentPitch=t;const s=Math.abs(this.lastYawDeg-e)>.1;if(this.lastYawDeg=e,this.lastPitchDeg=t,Z(t)){const a=q(t),o=String(a.clarity);this.root.style.getPropertyValue("--vr-ground-clarity")!==o&&this.root.style.setProperty("--vr-ground-clarity",o);const h=a.opacity.toString();this.root.style.opacity!==h&&(this.root.style.opacity=h);const n=`translateX(-50%) translateY(${a.translateY}px) scaleY(${a.scaleY})`;this.root.style.transform!==n&&(this.root.style.transform=n);const l=`${a.blur}px`;this.root.style.getPropertyValue("--vr-ground-base-blur")!==l&&this.root.style.setProperty("--vr-ground-base-blur",l),this.isVisible||(this.isVisible=!0),!this.isInteracting&&s&&(this.updateAimed(e),this.maybeRescheduleOrCancelByPitch(t))}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1,this.clearAimed());s&&this.updateDotPositions()}updateScene(e,t,s){if(f("统一终止触发点: 博物馆/场景切换",{museumId:e,currentSceneId:t}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),!e){f("updateScene: museumId is missing");return}this.museumId=e,this.currentSceneId=t,this.sceneHotspots=s,this.hoverSceneId=null,this.renderDots()}mount(e){e.appendChild(this.root)}dispose(){this.clearAllTimers(),this.cancelAutoNav(),this.clearAimed(),this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=void 0),this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}class Xe{constructor(e,t={}){r(this,"root");r(this,"inner");r(this,"wedge");r(this,"northTick");r(this,"needle");r(this,"currentYaw",0);r(this,"currentPitch",0);r(this,"northYaw",0);r(this,"isVisible",!1);r(this,"unsubscribeInteracting");r(this,"unsubscribeIdle");r(this,"unsubscribeUIEngaged");this.root=document.createElement("div"),this.root.className="vr-groundheading",this.root.setAttribute("data-ui","GroundHeadingMarker"),this.root.style.outline="2px solid #00ffff",this.inner=document.createElement("div"),this.inner.className="vr-groundheading__inner",this.wedge=document.createElement("div"),this.wedge.className="vr-groundheading__wedge",this.northTick=document.createElement("div"),this.northTick.className="vr-groundheading__northTick",this.needle=document.createElement("div"),this.needle.className="vr-groundheading__needle",this.inner.appendChild(this.wedge),this.inner.appendChild(this.northTick),this.inner.appendChild(this.needle),this.root.appendChild(this.inner),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--groundheading-disk-rot","0deg"),this.root.style.setProperty("--groundheading-needle-rot","0deg"),e.appendChild(this.root),this.setupInteractionListeners()}setNorthYaw(e){this.northYaw=e}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,Z(t)){const i=q(t);this.root.style.setProperty("--vr-ground-clarity",String(i.clarity)),this.root.style.opacity=i.opacity.toString(),this.root.style.transform=`translateX(-50%) translateY(${i.translateY}px) scaleY(${i.scaleY})`,this.root.style.setProperty("--vr-ground-base-blur",`${i.blur}px`);const a=e,h=-(this.northYaw??0),n=a;this.root.style.setProperty("--groundheading-disk-rot",`${h}deg`),this.root.style.setProperty("--groundheading-needle-rot",`${n}deg`),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1)}setInteracting(e){e?this.root.classList.add("vr-ui-interacting"):this.root.classList.remove("vr-ui-interacting")}setupInteractionListeners(){this.unsubscribeInteracting=M.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=M.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=M.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}const C=class C{constructor(){r(this,"element",null);r(this,"textEl",null);r(this,"hideTimer",null)}ensure(){this.element||(this.element=document.createElement("div"),this.element.className="vr-zoom-hud",this.textEl=document.createElement("div"),this.textEl.className="vr-zoom-hud__text",this.textEl.textContent="缩放 100%",this.element.appendChild(this.textEl),document.body.appendChild(this.element))}show(e){this.ensure(),!(!this.element||!this.textEl)&&(this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.textEl.textContent=`缩放 ${e}%`,this.element.classList.add("is-on"),this.hideTimer=window.setTimeout(()=>{this.hide()},600))}hide(){this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.element&&this.element.classList.remove("is-on")}static ensure(){return C.instance||(C.instance=new C),C.instance}static show(e){C.ensure().show(e)}static hide(){C.instance&&C.instance.hide()}};r(C,"instance",null);let j=C,A=null,Ge=0;const N=new Map;function Be(){return typeof Worker>"u"?null:A||(A=new Worker(new URL(""+new URL("bitmapDecode.worker-FGbDVlpY.js",import.meta.url).href,import.meta.url),{type:"module"}),A.onmessage=m=>{const{id:e,bitmap:t,error:s}=m.data||{},i=N.get(e);i&&(N.delete(e),i.timer&&window.clearTimeout(i.timer),s?i.reject(new Error(s)):t?i.resolve(t):i.reject(new Error("worker 返回空结果")))},A.onerror=()=>{N.forEach(m=>m.reject(new Error("worker error"))),N.clear()},A)}async function Qe(m,e={}){const t=Be();if(!t||typeof createImageBitmap>"u")return null;const s=++Ge,i=Math.max(1e3,e.timeoutMs??12e3),a=e.priority??"high",o=e.imageOrientation??"from-image";return new Promise((h,n)=>{const l={resolve:h,reject:n};l.timer=window.setTimeout(()=>{N.delete(s),n(new Error("worker decode timeout"))},i+500),N.set(s,l),t.postMessage({id:s,url:m,timeoutMs:i,priority:a,imageOrientation:o})})}class je{constructor(e,t,s,i=0){r(this,"maxTextureSize");r(this,"manifest",null);r(this,"canvas",null);r(this,"ctx",null);r(this,"texture",null);r(this,"mesh",null);r(this,"pendingLow",[]);r(this,"pendingHigh",[]);r(this,"activeLoads",0);r(this,"activeLowLoads",0);r(this,"activeHighLoads",0);r(this,"maxConcurrent",6);r(this,"maxHighWhileLow",2);r(this,"defaultMaxConcurrent",6);r(this,"defaultMaxHighWhileLow",2);r(this,"lastUpdate",0);r(this,"tilesMap",new Map);r(this,"highestLevel",null);r(this,"lowLevel",null);r(this,"lowReadyCount",0);r(this,"lowTotalCount",0);r(this,"lowFullyReady",!1);r(this,"highSeeded",!1);r(this,"tilesVisible",!1);r(this,"tilesLoadedCount",0);r(this,"tilesLoadingCount",0);r(this,"tilesQueuedCount",0);r(this,"tilesFailedCount",0);r(this,"tilesRetryCount",0);r(this,"lastTileUrl","");r(this,"lastError","");r(this,"lruLimit",64);r(this,"highReady",!1);r(this,"canvasScale",1);r(this,"fallbackVisible",!1);r(this,"prefetchSeeded",!1);this.scene=e,this.onFirstDraw=t,this.onHighReady=s,this.maxTextureSize=Math.max(0,i)}async load(e,t){var g;if(this.manifest=e,this.fallbackVisible=!!(t!=null&&t.fallbackVisible),this.highestLevel=e.levels.reduce((p,v)=>v.z>p.z?v:p),!this.highestLevel)throw new Error("manifest 缺少 level");this.lruLimit=Math.max(64,Math.min(this.highestLevel.cols*this.highestLevel.rows,256));const s=e.levels.filter(p=>p.z<this.highestLevel.z);this.lowLevel=s.length?s.reduce((p,v)=>v.z>p.z?v:p):null,this.lowReadyCount=0,this.lowTotalCount=this.lowLevel?this.lowLevel.cols*this.lowLevel.rows:0,this.lowFullyReady=this.lowTotalCount===0,this.highSeeded=!1,this.prefetchSeeded=!1,this.tilesVisible=!1,this.tilesLoadedCount=0,this.tilesLoadingCount=0,this.tilesQueuedCount=0,this.tilesFailedCount=0,this.tilesRetryCount=0,this.activeLoads=0,this.activeLowLoads=0,this.activeHighLoads=0;const i=this.highestLevel.cols,a=this.highestLevel.rows,o=e.tileSize,h=o*i,n=o*a;let l=h,u=n;if(this.canvasScale=1,this.maxTextureSize>0&&(l>this.maxTextureSize||u>this.maxTextureSize)){const p=Math.min(this.maxTextureSize/l,this.maxTextureSize/u);l=Math.max(1,Math.floor(l*p)),u=Math.max(1,Math.floor(u*p)),this.canvasScale=p}this.canvas=document.createElement("canvas"),this.canvas.width=l,this.canvas.height=u,this.ctx=this.canvas.getContext("2d",{alpha:!0}),this.fallbackVisible&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.texture=new x(this.canvas),this.texture.flipY=!1,this.texture.wrapS=k,this.texture.wrapT=k,this.texture.minFilter=U,this.texture.magFilter=U,this.texture.generateMipmaps=!1,"colorSpace"in this.texture?this.texture.colorSpace=$:this.texture.encoding=B,this.texture.needsUpdate=!0;const c=new de(500,64,64);c.scale(-1,1,1);const d=new _({map:this.texture,transparent:!0,opacity:0,depthWrite:!1,depthTest:!1});if(d.toneMapped=!1,this.mesh=new H(c,d),this.mesh.renderOrder=1,this.mesh.frustumCulled=!1,this.scene.add(this.mesh),!this.fallbackVisible){if(!e.levels.find(y=>y.z===0))throw new Error("manifest 缺少 z0");const v=`${e.baseUrl}/z0/0_0.jpg`,S=await this.fetchTileBitmap(v,"high"),I={z:0,col:0,row:0,url:v,state:"ready",priority:"low",bitmap:S,lastUsed:performance.now(),failCount:0};await this.drawTile(I),(g=S.close)==null||g.call(S)}this.lowLevel&&this.enqueueLevel(this.lowLevel,"low")}setPerformanceMode(e){e==="throttle"?(this.maxConcurrent=2,this.maxHighWhileLow=0):(this.maxConcurrent=this.defaultMaxConcurrent,this.maxHighWhileLow=this.defaultMaxHighWhileLow)}dispose(){if(this.tilesMap.forEach(e=>{var t,s;return(s=(t=e.bitmap)==null?void 0:t.close)==null?void 0:s.call(t)}),this.tilesMap.clear(),this.mesh){this.mesh.geometry&&this.mesh.geometry.dispose();const e=this.mesh.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.mesh)}}update(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;const t=performance.now();if(t-this.lastUpdate<150)return;if(this.lastUpdate=t,(!this.lowLevel||this.lowFullyReady||this.highSeeded)&&this.highestLevel){const o=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});for(const{col:h,row:n,rank:l}of o){const u=`${this.highestLevel.z}_${h}_${n}`;let c=this.tilesMap.get(u);c||(c={z:this.highestLevel.z,col:h,row:n,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${h}_${n}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(u,c)),c.priority="high",c.priorityRank=l,c.lastUsed=t,c.state==="empty"&&!c.retryTimer&&(c.state="loading",this.pendingHigh.push(c))}}const i=Array.from(this.tilesMap.values()).filter(o=>o.state==="loading").length,a=Array.from(this.tilesMap.values()).filter(o=>o.state==="ready").length;if(this.lowLevel&&!this.lowFullyReady){const o=Array.from(this.tilesMap.values()).filter(h=>h.z===this.lowLevel.z&&h.state==="loading").length;this.pendingLow.length===0&&o===0&&(this.lowFullyReady=!0)}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=i,this.tilesLoadedCount=a,this.processQueue(),this.runLru(t)}prime(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;e.updateMatrixWorld(!0);const t=performance.now();if(this.highestLevel&&!this.highSeeded){const s=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});if(s.length>0){for(const{col:i,row:a,rank:o}of s){const h=`${this.highestLevel.z}_${i}_${a}`;let n=this.tilesMap.get(h);n||(n={z:this.highestLevel.z,col:i,row:a,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${i}_${a}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(h,n)),n.priority="high",n.priorityRank=o,n.lastUsed=t,n.state==="empty"&&!n.retryTimer&&(n.state="loading",this.pendingHigh.push(n))}this.highSeeded=!0}}this.reprioritizeLowQueue(e),this.seedHighPreload(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(s=>s.state==="loading").length,this.processQueue()}getStatus(){var e,t;return{tilesVisible:this.tilesVisible,fallbackVisible:this.fallbackVisible,tilesLoadedCount:this.tilesLoadedCount,tilesLoadingCount:this.tilesLoadingCount,tilesQueuedCount:this.tilesQueuedCount,tilesFailedCount:this.tilesFailedCount,tilesRetryCount:this.tilesRetryCount,lastTileUrl:this.lastTileUrl,lastError:this.lastError,canvasSize:this.canvas?`${this.canvas.width}x${this.canvas.height}`:"0x0",canvasScale:this.canvasScale,maxLevel:this.highestLevel?`${this.highestLevel.cols}x${this.highestLevel.rows}`:"",highReady:this.highReady,zMax:((e=this.highestLevel)==null?void 0:e.z)??0,levels:this.manifest?this.manifest.levels.map(s=>s.z).join(","):"",lowReady:this.lowFullyReady,lowLevel:((t=this.lowLevel)==null?void 0:t.z)??""}}enqueueLevel(e,t){const s=performance.now();for(let i=0;i<e.rows;i++)for(let a=0;a<e.cols;a++){const o=`${e.z}_${a}_${i}`;let h=this.tilesMap.get(o);h||(h={z:e.z,col:a,row:i,url:`${this.manifest.baseUrl}/z${e.z}/${a}_${i}.jpg`,state:"empty",priority:t,lastUsed:s,failCount:0},this.tilesMap.set(o,h)),h.priority=t,h.lastUsed=s,h.state==="empty"&&!h.retryTimer&&(h.state="loading",t==="low"?this.pendingLow.push(h):this.pendingHigh.push(h))}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(i=>i.state==="loading").length,this.processQueue()}processQueue(){for(this.sortPendingHighQueue();this.activeLoads<this.maxConcurrent&&(this.pendingLow.length>0||this.pendingHigh.length>0);){const e=this.pendingLow.length>0,s=this.pendingHigh.length>0&&(!e||this.activeHighLoads<this.maxHighWhileLow)?this.pendingHigh.shift():this.pendingLow.shift();this.loadTile(s)}}async loadTile(e){(e.failCount===void 0||e.failCount===null)&&(e.failCount=0),e.priority||(e.priority="high"),this.activeLoads+=1,e.priority==="high"?this.activeHighLoads+=1:this.activeLowLoads+=1,this.lastTileUrl=e.url;try{const t=await this.fetchTileBitmap(e.url,e.priority);e.bitmap=t,e.state="ready",e.failCount=0,e.retryTimer&&(clearTimeout(e.retryTimer),e.retryTimer=void 0),this.drawTile(e),this.tilesLoadedCount+=1,this.lowLevel&&e.z===this.lowLevel.z&&(this.lowReadyCount+=1,this.lowReadyCount>=this.lowTotalCount&&(this.lowFullyReady=!0))}catch(t){this.lastError=t instanceof Error?t.message:String(t),e.state="empty",e.failCount+=1,this.tilesFailedCount+=1;const s=Math.min(1e3*Math.pow(2,Math.max(0,e.failCount-1)),15e3);this.scheduleRetry(e,s)}finally{this.activeLoads-=1,e.priority==="high"?this.activeHighLoads=Math.max(0,this.activeHighLoads-1):this.activeLowLoads=Math.max(0,this.activeLowLoads-1),this.processQueue()}}scheduleRetry(e,t){e.retryTimer||(this.tilesRetryCount+=1,e.retryTimer=window.setTimeout(()=>{e.retryTimer=void 0,e.state==="empty"&&(e.priority==="low"?this.pendingLow.push(e):this.pendingHigh.push(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.processQueue())},t))}async fetchTileBitmap(e,t,s=12e3){try{const o=await Qe(e,{timeoutMs:s,priority:t});if(o)return o}catch{}const i=new AbortController,a=window.setTimeout(()=>i.abort(),s);try{const o={mode:"cors",cache:"default",referrerPolicy:"no-referrer",signal:i.signal};o.priority=t==="high"?"high":"low";const h=await fetch(e,o);if(!h.ok)throw new Error(`tile HTTP ${h.status}: ${e}`);const n=await h.blob();return await createImageBitmap(n)}finally{clearTimeout(a)}}hasHigherReadyTile(e,t,s){if(!this.highestLevel)return!1;const i=this.highestLevel.z;if(e>=i)return!1;const a=1<<i-e;for(let o=0;o<a;o++)for(let h=0;h<a;h++){const n=`${i}_${t*a+h}_${s*a+o}`,l=this.tilesMap.get(n);if(l&&l.state==="ready")return!0}return!1}async drawTile(e){var l,u;if(!this.manifest||!this.highestLevel||!this.ctx||!this.canvas)return;const t=this.manifest.levels.find(c=>c.z===e.z);if(!t||this.hasHigherReadyTile(e.z,e.col,e.row))return;const s=this.canvas.width/t.cols,i=this.canvas.height/t.rows,a=e.col*s,o=e.row*i;if(a<0||o<0||a+s>this.canvas.width||o+i>this.canvas.height){this.lastError=`tile out of canvas: z${e.z} ${e.col}_${e.row}`;return}const h=e.bitmap;if(h)this.ctx.drawImage(h,a,o,s,i);else{const c=e.url||`${this.manifest.baseUrl}/z${e.z}/${e.col}_${e.row}.jpg`,d=await F(c,{timeoutMs:12e3,retries:1,priority:e.priority});this.ctx.drawImage(d,a,o,s,i),(l=d.close)==null||l.call(d)}this.texture&&(this.texture.needsUpdate=!0),this.tilesVisible||(this.tilesVisible=!0,this.onFirstDraw());const n=(u=this.mesh)==null?void 0:u.material;n&&(n.opacity=1,n.needsUpdate=!0),this.highestLevel&&e.z===this.highestLevel.z&&!this.highReady&&(this.highReady=!0,this.onHighReady())}computeNeededTiles(e,t,s={}){const{yaw:i,pitch:a}=this.getViewAngles(e),o=P.degToRad(e.fov),h=P.degToRad(s.marginDeg??20),n=o/2+h,l=o*e.aspect/2+h,u=this.normAngle(i-l),c=this.normAngle(i+l),d=P.clamp(a-n,-Math.PI/2,Math.PI/2),g=P.clamp(a+n,-Math.PI/2,Math.PI/2),p=this.yawToCols(u,c,t.cols),v=this.yawToCols(i-1e-6,i+1e-6,t.cols)[0]??0;p.includes(v)||p.push(v);const S=Math.max(0,Math.floor((g*-1+Math.PI/2)/Math.PI*t.rows)),I=Math.min(t.rows-1,Math.floor((d*-1+Math.PI/2)/Math.PI*t.rows)),y=[];for(let b=S;b<=I;b++)y.push(b);const E=Math.min(t.rows-1,Math.max(0,Math.floor((-a+Math.PI/2)/Math.PI*t.rows)));y.includes(E)||y.push(E);const L=s.expandNeighbors!==!1,O=[...p];if(L)for(const b of p)O.push(((b+1)%t.cols+t.cols)%t.cols),O.push(((b-1)%t.cols+t.cols)%t.cols);const W=[...y];if(L)for(const b of y)b+1<t.rows&&W.push(b+1),b-1>=0&&W.push(b-1);const X=new Map,ue=(b,T)=>{const K=`${b}_${T}`,J=Math.abs(b-v),ee=Math.min(J,t.cols-J),te=Math.abs(T-E),se=ee*ee+te*te,ie=X.get(K);(!ie||se<ie.rank)&&X.set(K,{col:b,row:T,rank:se})};for(const b of O)for(const T of W)ue(b,T);return Array.from(X.values()).sort((b,T)=>b.rank!==T.rank?b.rank-T.rank:b.row!==T.row?b.row-T.row:b.col-T.col)}sortPendingHighQueue(){this.pendingHigh.length<2||this.pendingHigh.sort((e,t)=>{const s=e.priorityRank??Number.POSITIVE_INFINITY,i=t.priorityRank??Number.POSITIVE_INFINITY;return s!==i?s-i:t.lastUsed-e.lastUsed})}reprioritizeLowQueue(e){if(!this.lowLevel||this.pendingLow.length<2)return;const t=this.computeNeededTiles(e,this.lowLevel);if(t.length===0)return;const s=new Map;for(const a of t)s.set(`${a.col}_${a.row}`,a.rank);const i=new Map;this.pendingLow.forEach((a,o)=>i.set(a,o)),this.pendingLow.sort((a,o)=>{const h=s.get(`${a.col}_${a.row}`),n=s.get(`${o.col}_${o.row}`),l=h!==void 0,u=n!==void 0;return l&&u&&h!==n?h-n:l&&!u?-1:!l&&u?1:(i.get(a)??0)-(i.get(o)??0)})}seedHighPreload(e){if(this.prefetchSeeded||!this.manifest||!this.highestLevel)return;this.prefetchSeeded=!0;const{yaw:t,pitch:s}=this.getViewAngles(e),i=this.highestLevel,a=Math.PI*2/i.cols,o=Math.PI/i.rows,h=performance.now();for(let n=0;n<i.rows;n++){const l=Math.PI/2-(n+.5)*o,u=Math.abs(l-s);for(let c=0;c<i.cols;c++){const d=-Math.PI+(c+.5)*a,g=this.angularDistance(d,t),v=(g<=Math.PI/2?0:1)*1e6+Math.round(g*1e3)+Math.round(u*10),S=`${i.z}_${c}_${n}`;if(this.tilesMap.has(S))continue;const I={z:i.z,col:c,row:n,url:`${this.manifest.baseUrl}/z${i.z}/${c}_${n}.jpg`,state:"loading",priority:"high",priorityRank:v,lastUsed:h,failCount:0};this.tilesMap.set(S,I),this.pendingHigh.push(I)}}}yawToCols(e,t,s){const i=d=>(d%(Math.PI*2)+Math.PI*2)%(Math.PI*2),a=Math.PI,o=i(e+a),h=i(t+a),n=[],l=d=>{const g=(d%s+s)%s;n.includes(g)||n.push(g)},u=Math.floor(o/(Math.PI*2)*s),c=Math.floor(h/(Math.PI*2)*s);if(o<=h)for(let d=u;d<=c;d++)l(d);else{for(let d=u;d<s;d++)l(d);for(let d=0;d<=c;d++)l(d)}return n}normAngle(e){return(e+Math.PI)%(2*Math.PI)-Math.PI}angularDistance(e,t){return Math.abs(this.normAngle(e-t))}getViewAngles(e){const t=new ce;return e.getWorldDirection(t),{yaw:-Math.atan2(t.x,t.z),pitch:Math.asin(t.y)}}runLru(e){var i,a;if(!this.highestLevel)return;const t=Array.from(this.tilesMap.values()).filter(o=>o.z===this.highestLevel.z&&o.state==="ready");if(t.length<=this.lruLimit)return;t.sort((o,h)=>o.lastUsed-h.lastUsed);const s=t.slice(0,t.length-this.lruLimit);for(const o of s)(a=(i=o.bitmap)==null?void 0:i.close)==null||a.call(i),o.bitmap=void 0,o.state="empty",this.tilesMap.delete(`${o.z}_${o.col}_${o.row}`)}}function qe(m,e){var s;const t=m.trim();if(!t||t.startsWith("/")||t.startsWith("//")||/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(t))return t;try{const i=new URL(t,e),a=typeof window<"u"&&((s=window.location)!=null&&s.origin)?window.location.origin:typeof location<"u"?location.origin:"";return a&&i.origin===a?`${i.pathname}${i.search}${i.hash}`:i.toString()}catch{return t}}async function Ze(m){const e={cache:"default"};e.priority="high";const t=await fetch(m,e);if(!t.ok)throw new Error(`manifest 加载失败: ${m}`);const s=await t.json();return s.tileFormat||(s.tileFormat="jpg"),s.baseUrl=R(qe(s.baseUrl,m),Y.PANO),s}const D={original:{renderer:{pixelRatio:Math.min(window.devicePixelRatio||1,2),toneMapping:xe,toneMappingExposure:1,output:"srgb",clearColor:void 0},camera:{defaultFov:75},texture:{anisotropyLimit:8,minFilter:oe,magFilter:U,generateMipmaps:!0,colorSpace:"srgb"}},enhanced:{renderer:{pixelRatio:Math.min(window.devicePixelRatio,2),toneMapping:Ee,toneMappingExposure:.95,output:"srgb",clearColor:{color:0,alpha:1}},camera:{defaultFov:70},texture:{anisotropyLimit:12,minFilter:oe,magFilter:U,generateMipmaps:!0,colorSpace:"srgb"}}};class Ke{constructor(e,t=!1){r(this,"scene");r(this,"camera");r(this,"renderer");r(this,"sphere",null);r(this,"tilePano",null);r(this,"fallbackSphere",null);r(this,"container");r(this,"handleWindowResize",()=>this.handleResize());r(this,"frameListeners",[]);r(this,"nadirPatch",null);r(this,"compassDisk",null);r(this,"groundNavDots",null);r(this,"groundHeading",null);r(this,"renderProfile","enhanced");r(this,"isDragging",!1);r(this,"lastMouseX",0);r(this,"lastMouseY",0);r(this,"yaw",0);r(this,"pitch",0);r(this,"fov",75);r(this,"onLoadCallback");r(this,"onErrorCallback");r(this,"onStatusChangeCallback");r(this,"debugMode",!1);r(this,"onDebugClick");r(this,"longPressTimer",null);r(this,"tilesDebugEl",null);r(this,"tilesVisibleStableFrames",0);r(this,"tilesLastError","");r(this,"tilesLowReady",!1);r(this,"tilesLastLoadedCount",0);r(this,"tilesLastProgressAt",0);r(this,"tilesHighStartAt",0);r(this,"tilesDegradedNotified",!1);r(this,"longPressThreshold",500);r(this,"renderSource","none");r(this,"perfSamples",[]);r(this,"perfMode","normal");r(this,"perfLastChangeAt",0);r(this,"renderSwitchReason","");r(this,"clearedCount",0);r(this,"aspectWarnedUrls",new Set);r(this,"metrics",{sceneId:"",startAt:0,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:"normal",renderSource:"none",lastError:""});r(this,"lastMetricsEmitAt",0);r(this,"loadStatus",w.LOADING_LOW);r(this,"isDegradedMode",!1);r(this,"pickMode",!1);r(this,"pickModeListeners",[]);r(this,"pickStartX",0);r(this,"pickStartY",0);r(this,"pickStartTime",0);r(this,"pickHasMoved",!1);r(this,"pickDragThreshold",8);r(this,"pickTimeThreshold",250);r(this,"lastYaw",0);r(this,"lastPitch",0);r(this,"lastFov",75);r(this,"isViewChanging",!1);r(this,"viewChangeThreshold",.5);r(this,"vrModeEnabled",!1);r(this,"touchStartX",0);r(this,"touchStartY",0);r(this,"lastTouchDistance",0);r(this,"isPinching",!1);r(this,"lastFrameTimeMs",null);this.container=e,this.debugMode=t,this.renderProfile=this.detectRenderProfile(),this.scene=new ke,this.camera=new Ce(D[this.renderProfile].camera.defaultFov,e.clientWidth/e.clientHeight,.1,1e3),this.camera.position.set(0,0,0),this.fov=D[this.renderProfile].camera.defaultFov,this.renderer=new Ae({antialias:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.applyRendererProfile(),e.appendChild(this.renderer.domElement),this.nadirPatch=new _e(this.scene,500),this.compassDisk=new Ve,this.compassDisk.mount(e),this.compassDisk.getElement().style.display="none",this.groundNavDots=new We({museumId:"",currentSceneId:"",sceneHotspots:[]}),this.groundNavDots.mount(e),this.groundNavDots.getElement().style.display="none",this.groundHeading=new Xe(e),this.groundHeading.getElement().style.display="none",this.setupEvents(),this.animate(),window.addEventListener("resize",this.handleWindowResize)}setupEvents(){const e=this.renderer.domElement;if(e.addEventListener("mousedown",t=>this.onPointerDown(t)),e.addEventListener("mousemove",t=>this.onPointerMove(t)),e.addEventListener("mouseup",()=>this.onPointerUp()),e.addEventListener("mouseleave",()=>this.onPointerUp()),e.addEventListener("touchstart",t=>this.onTouchStart(t),{passive:!1}),e.addEventListener("touchmove",t=>this.onTouchMove(t),{passive:!1}),e.addEventListener("touchend",()=>this.onTouchEnd()),e.addEventListener("wheel",t=>this.onWheel(t),{passive:!1}),this.debugMode){e.addEventListener("dblclick",i=>this.handleDebugClick(i.clientX,i.clientY));let t=0,s=0;e.addEventListener("touchstart",i=>{i.touches.length===1&&(t=i.touches[0].clientX,s=i.touches[0].clientY,this.longPressTimer=window.setTimeout(()=>{this.handleDebugClick(t,s)},this.longPressThreshold))},{passive:!0}),e.addEventListener("touchmove",()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},{passive:!0}),e.addEventListener("touchend",()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},{passive:!0})}}handleDebugClick(e,t){if(this.onDebugClick&&this.debugMode){const s=this.getCurrentView();this.onDebugClick(e,t,s.yaw,s.pitch,s.fov)}}setOnDebugClick(e){this.onDebugClick=e}onPointerDown(e){this.isDragging=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,M.emitInteracting()}onPointerMove(e){if(!this.isDragging)return;const t=e.clientX-this.lastMouseX,s=e.clientY-this.lastMouseY;if(this.yaw+=t*.5,this.pitch+=s*.5,this.pitch=Math.max(-90,Math.min(90,this.pitch)),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,this.updateCamera(),this.debugMode&&this.onDebugClick){const i=this.getCurrentView();this.onDebugClick(this.lastMouseX,this.lastMouseY,i.yaw,i.pitch,i.fov)}}onPointerUp(){this.isDragging=!1}onTouchStart(e){if(e.touches.length===1)this.isDragging=!0,this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY,this.lastMouseX=this.touchStartX,this.lastMouseY=this.touchStartY,M.emitInteracting();else if(e.touches.length===2){this.isPinching=!0,this.isDragging=!1;const t=e.touches[0].clientX-e.touches[1].clientX,s=e.touches[0].clientY-e.touches[1].clientY;this.lastTouchDistance=Math.sqrt(t*t+s*s),M.emitInteracting()}}onTouchMove(e){if(e.preventDefault(),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),e.touches.length===1&&this.isDragging){const t=e.touches[0].clientX-this.lastMouseX,s=e.touches[0].clientY-this.lastMouseY;this.yaw+=t*.5,this.pitch+=s*.5,this.pitch=Math.max(-90,Math.min(90,this.pitch)),this.lastMouseX=e.touches[0].clientX,this.lastMouseY=e.touches[0].clientY,this.updateCamera()}else if(e.touches.length===2&&this.isPinching){const t=e.touches[0].clientX-e.touches[1].clientX,s=e.touches[0].clientY-e.touches[1].clientY,i=Math.sqrt(t*t+s*s),a=this.lastTouchDistance-i,o=this.fov+a*.5;this.setFovInternal(o),this.lastTouchDistance=i}}onTouchEnd(){this.isDragging=!1,this.isPinching=!1}onWheel(e){e.preventDefault();const t=this.fov+e.deltaY*.1;if(this.setFovInternal(t),M.emitInteracting(),this.debugMode&&this.onDebugClick){const s=this.getCurrentView();this.onDebugClick(this.lastMouseX,this.lastMouseY,s.yaw,s.pitch,s.fov)}}updateCamera(){const e=P.degToRad(this.yaw),t=P.degToRad(this.pitch),s=Math.cos(t)*Math.sin(e),i=Math.sin(t),a=Math.cos(t)*Math.cos(e);this.camera.lookAt(s,i,a)}loadScene(e,t){var c;if(this.isDegradedMode=!1,this.resetMetrics(e.id),this.updateLoadStatus(w.LOADING_LOW),this.renderSource="none",this.clearedCount=0,this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const d=this.sphere.material;d.map&&d.map.dispose(),d.dispose()}if(!((t==null?void 0:t.preserveView)===!0)){const d=e.initialView,g=d.yaw||0;this.yaw===0&&g!==0&&(this.yaw=-g),this.pitch=d.pitch||0;const p=D[this.renderProfile];this.fov=d.fov!==void 0?d.fov:p.camera.defaultFov,this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),this.updateCamera()}this.lastYaw=this.yaw,this.lastPitch=this.pitch,this.lastFov=this.fov,this.isViewChanging=!1;const a=-(typeof e.northYaw=="number"?e.northYaw:((c=e.initialView)==null?void 0:c.yaw)??0);this.nadirPatch&&this.nadirPatch.setNorthYaw(a),this.compassDisk&&(this.compassDisk.setSceneId(e.id),this.compassDisk.setNorthYaw(a)),this.groundHeading&&this.groundHeading.setNorthYaw(a);const o=new de(500,64,64);o.scale(-1,1,1);const h=e.panoTiles;if(h!=null&&h.manifest){const d=R(h.manifest,Y.PANO),g=h.fallbackPanoLow||e.panoLow,p=h.fallbackPano||e.pano,v=!!(g||p);this.tilesVisibleStableFrames=0,this.tilesLastError="",this.tilesLowReady=!1,this.tilesLastLoadedCount=0,this.tilesLastProgressAt=performance.now(),this.tilesHighStartAt=0,this.tilesDegradedNotified=!1,g?this.showFallbackTexture(R(g,Y.PANO_LOW),o,!0):p&&this.showFallbackTexture(R(p,Y.PANO),o,!1);const S=()=>{this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(w.LOW_READY),this.setRenderSource("low","tiles 首屏可见"),this.onLoadCallback&&this.onLoadCallback()),this.loadStatus!==w.HIGH_READY&&this.updateLoadStatus(w.LOADING_HIGH)},I=()=>{this.updateLoadStatus(w.HIGH_READY),this.setRenderSource("tiles","tiles 高清可见"),this.isDegradedMode=!1};Ze(d).then(async y=>{if(y.tileFormat==="ktx2"){const{TileMeshPano:E}=await we(async()=>{const{TileMeshPano:L}=await import("./tile-ktx2-B4BUbLBp.js");return{TileMeshPano:L}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url);this.tilePano=new E(this.scene,this.renderer,S,I)}else this.tilePano=new je(this.scene,S,I,this.renderer.capabilities.maxTextureSize||0);return this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode(this.perfMode),this.tilePano.load(y,{fallbackVisible:v})}).then(()=>{var y;this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(w.LOW_READY),this.onLoadCallback&&this.onLoadCallback()),(y=this.tilePano)==null||y.prime(this.camera)}).catch(y=>{console.error("瓦片加载失败，回退传统全景",y),this.tilesLastError=y instanceof Error?y.message:String(y),re("瓦片加载失败，已回退到全景图",2e3),this.fallbackToLegacy(e,h)});return}const n=R(e.panoLow,Y.PANO_LOW),l=R(e.pano,Y.PANO);if(be()==="low"){if(n){this.loadSingleTexture(o,n,!0);return}if(l){this.loadSingleTexture(o,l,!1);return}}else{if(!n&&l){this.loadSingleTexture(o,l,!1);return}if(n&&!l){this.loadSingleTexture(o,n,!0);return}if(n&&l){this.loadProgressiveTextures(o,n,l);return}}this.updateLoadStatus(w.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("场景未提供全景图 URL"))}async loadSingleTexture(e,t,s){s?this.updateLoadStatus(w.LOADING_LOW):this.updateLoadStatus(w.LOADING_HIGH);try{const i=await F(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY"}),a=new x(i);this.applyTextureSettings(a),this.warnIfNotPanoAspect(a,t),a.flipY=!1,a.wrapS=k,a.wrapT=k,a.needsUpdate=!0;const o=new _({map:a});this.sphere=new H(e,o),this.scene.add(this.sphere),this.setRenderSource(s?"low":"tiles",s?"panoLow 可见":"pano 可见"),s?this.updateLoadStatus(w.LOW_READY):this.updateLoadStatus(w.HIGH_READY),this.onLoadCallback&&this.onLoadCallback()}catch(i){if(console.error("加载全景图失败",t,i),this.updateLoadStatus(w.ERROR),this.onErrorCallback){const a=i instanceof De?`加载全景图失败：${t} - ${i.message}`:`加载全景图失败：${t}`;this.onErrorCallback(new Error(a))}}}async loadProgressiveTextures(e,t,s){this.updateLoadStatus(w.LOADING_LOW);try{const i=await F(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY"}),a=new x(i);this.applyTextureSettings(a),this.warnIfNotPanoAspect(a,t),a.flipY=!1,a.wrapS=k,a.wrapT=k,a.needsUpdate=!0;const o=new _({map:a});this.sphere=new H(e,o),this.scene.add(this.sphere),this.setRenderSource("low","panoLow 可见"),this.updateLoadStatus(w.LOW_READY),this.onLoadCallback&&this.onLoadCallback(),this.updateLoadStatus(w.LOADING_HIGH);try{const h=await F(s,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"low",imageOrientation:"flipY"}),n=new x(h);this.applyTextureSettings(n),this.warnIfNotPanoAspect(n,s),n.flipY=!1,n.wrapS=k,n.wrapT=k,n.needsUpdate=!0;const l=this.getCurrentView();if(this.sphere&&this.sphere.material&&"map"in this.sphere.material){const u=this.sphere.material;u.map&&u.map.dispose(),u.map=n,u.needsUpdate=!0,this.setRenderSource("tiles","pano 高清可见")}this.setView(l.yaw,l.pitch,l.fov),this.updateLoadStatus(w.HIGH_READY),this.isDegradedMode=!1}catch(h){console.error("高清全景图加载失败，继续使用低清",s,h),this.isDegradedMode=!0,this.updateLoadStatus(w.DEGRADED)}}catch(i){console.error("低清全景图加载失败，尝试加载高清兜底",t,i),await this.loadSingleTexture(e,s,!1)}}setOnLoad(e){this.onLoadCallback=e}setOnError(e){this.onErrorCallback=e}setOnStatusChange(e){this.onStatusChangeCallback=e}getLoadStatus(){return this.loadStatus}resetMetrics(e){const t=performance.now();this.metrics={sceneId:e,startAt:t,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:this.perfMode,renderSource:this.renderSource,lastError:""},this.emitMetrics("reset",!0)}emitMetrics(e,t=!1){var g;const s=performance.now();if(!t&&s-this.lastMetricsEmitAt<800)return;const i=(g=this.tilePano)==null?void 0:g.getStatus(),a=(i==null?void 0:i.tilesLoadedCount)??0,o=(i==null?void 0:i.tilesFailedCount)??0,h=(i==null?void 0:i.tilesRetryCount)??0,n=a+o,l=n>0?Number((a/n*100).toFixed(2)):0;this.metrics.tilesLoaded=a,this.metrics.tilesFailed=o,this.metrics.tilesRetries=h,this.metrics.tileHitRate=l,this.metrics.perfMode=this.perfMode,this.metrics.renderSource=this.renderSource,this.metrics.lastError=this.tilesLastError||((i==null?void 0:i.lastError)??"");const u=this.metrics.lowReadyAt?Math.round(this.metrics.lowReadyAt-this.metrics.startAt):-1,c=this.metrics.highReadyAt?Math.round(this.metrics.highReadyAt-this.metrics.startAt):-1,d={...this.metrics,lowReadyMs:u,highReadyMs:c,reason:e,at:Math.round(s)};window.__VR_METRICS__=d,window.dispatchEvent(new CustomEvent("vr:metrics",{detail:d})),this.lastMetricsEmitAt=s}isInDegradedMode(){return this.isDegradedMode}updateLoadStatus(e){if(this.loadStatus===e)return;this.loadStatus=e;const t=performance.now();e===w.LOW_READY&&this.metrics.lowReadyAt===0&&(this.metrics.lowReadyAt=t),e===w.HIGH_READY&&this.metrics.highReadyAt===0&&(this.metrics.highReadyAt=t),this.onStatusChangeCallback&&this.onStatusChangeCallback(e),this.emitMetrics(`status:${e}`)}getCurrentView(){return{yaw:this.yaw,pitch:this.pitch,fov:this.fov}}setView(e,t,s){this.yaw=e,this.pitch=Math.max(-90,Math.min(90,t)),s!==void 0&&this.setFovInternal(s,!1),this.updateCamera()}setFovInternal(e,t=!0){if(this.fov=Math.max(30,Math.min(120,e)),this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),t){const s=D[this.renderProfile].camera.defaultFov,i=Math.round(s/this.fov*100),a=Math.max(50,Math.min(250,i));j.show(a)}}setFov(e){this.setFovInternal(e,!0)}setVrModeEnabled(e){this.vrModeEnabled=e,e||(this.isDragging=!1)}isVrModeEnabled(){return this.vrModeEnabled}isInteracting(){return this.isDragging||this.isPinching}handleResize(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}updatePerformanceGuard(e){const t=1e3/Math.max(1,e);this.perfSamples.push(t),this.perfSamples.length>30&&this.perfSamples.shift();const s=this.perfSamples.reduce((a,o)=>a+o,0)/this.perfSamples.length,i=performance.now();s<28&&this.perfMode==="normal"&&i-this.perfLastChangeAt>2e3&&(this.perfMode="throttle",this.perfLastChangeAt=i,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("throttle"),this.emitMetrics("perf:throttle",!0)),s>45&&this.perfMode==="throttle"&&i-this.perfLastChangeAt>3e3&&(this.perfMode="normal",this.perfLastChangeAt=i,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("normal"),this.emitMetrics("perf:normal",!0))}updateTilesDebug(){var E;const e=new URLSearchParams(window.location.search);if(!(e.get("tilesDebug")==="1"||e.get("tilesDebug")==="true"||e.get("tilesDebug")==="on")){this.tilesDebugEl&&(this.tilesDebugEl.remove(),this.tilesDebugEl=null);return}if(!this.tilesDebugEl){const L=document.createElement("div");L.style.position="absolute",L.style.left="8px",L.style.top="8px",L.style.padding="6px 8px",L.style.background="rgba(0,0,0,0.55)",L.style.color="#fff",L.style.fontSize="12px",L.style.lineHeight="1.4",L.style.borderRadius="6px",L.style.zIndex="9999",L.style.pointerEvents="none",this.tilesDebugEl=L,this.container.appendChild(L)}const s=(E=this.tilePano)==null?void 0:E.getStatus(),i=this.tilePano?"tiles":"fallback",a=s!=null&&s.tilesVisible?"true":"false",o=(s==null?void 0:s.tilesLoadedCount)??0,h=(s==null?void 0:s.tilesLoadingCount)??0,n=(s==null?void 0:s.tilesQueuedCount)??0,l=(s==null?void 0:s.lastTileUrl)??"",u=this.tilesLastError||(s==null?void 0:s.lastError)||"",c=this.fallbackSphere?"true":"false",d=(s==null?void 0:s.canvasSize)??"",g=(s==null?void 0:s.maxLevel)??"",p=s!=null&&s.highReady?"true":"false",v=(s==null?void 0:s.levels)??"",S=this.renderSource,I=this.renderSwitchReason,y=this.clearedCount;this.tilesDebugEl.textContent=`mode=${i}
renderSource=${S}
switchReason=${I}
cleared=${y}
fallbackVisible=${c}
tilesVisible=${a}
tilesLoaded=${o}
tilesLoading=${h}
tilesQueued=${n}
lastTileUrl=${l}
lastError=${u}
canvas=${d} zMax=${g} levels=${v} highReady=${p}
lowReady=${this.tilesLowReady}`}animate(){requestAnimationFrame(()=>this.animate());const e=performance.now(),t=this.lastFrameTimeMs?e-this.lastFrameTimeMs:16.7;this.updatePerformanceGuard(t),this.lastFrameTimeMs=e;const s=this.getCurrentView(),i=Math.abs(s.yaw-this.lastYaw),a=Math.abs(s.pitch-this.lastPitch),o=Math.abs(s.fov-this.lastFov);if(i>this.viewChangeThreshold||a>this.viewChangeThreshold||o>this.viewChangeThreshold?this.isViewChanging||(this.isViewChanging=!0,M.emitInteracting()):this.isViewChanging&&(this.isViewChanging=!1,M.scheduleIdle()),this.lastYaw=s.yaw,this.lastPitch=s.pitch,this.lastFov=s.fov,this.updateCamera(),this.tilePano){this.tilePano.update(this.camera);const n=this.tilePano.getStatus(),l=!!this.fallbackSphere,u=n.tilesVisible,c=n.lowReady;l&&u&&c?(this.tilesVisibleStableFrames+=1,this.tilesVisibleStableFrames>=2&&this.clearFallback()):this.tilesVisibleStableFrames=0,!l&&!u&&this.noteCleared("无可见源"),u&&this.renderSource==="fallback"&&this.tilesLowReady&&this.setRenderSource("low","tiles 低清覆盖可见"),u&&n.highReady&&this.setRenderSource("tiles","tiles 高清可见"),n.lastError&&(this.tilesLastError=n.lastError),!this.tilesLowReady&&n.tilesLoadedCount>0&&(this.tilesLowReady=!0,this.updateLoadStatus(w.LOW_READY)),n.highReady&&(this.updateLoadStatus(w.HIGH_READY),this.isDegradedMode=!1,this.tilesDegradedNotified=!1),n.tilesLoadedCount>this.tilesLastLoadedCount&&(this.tilesLastLoadedCount=n.tilesLoadedCount,this.tilesLastProgressAt=e,this.tilesDegradedNotified&&!n.highReady&&(this.tilesDegradedNotified=!1)),this.tilesHighStartAt===0&&(n.tilesQueuedCount>0||n.tilesLoadingCount>0)&&(this.tilesHighStartAt=e,this.tilesLastProgressAt===0&&(this.tilesLastProgressAt=e)),this.tilesHighStartAt>0&&e-this.tilesLastProgressAt>12e3&&!n.highReady&&!this.tilesDegradedNotified&&this.tilesLowReady&&(this.isDegradedMode=!0,this.updateLoadStatus(w.DEGRADED),this.tilesDegradedNotified=!0)}this.updateTilesDebug(),this.emitMetrics("frame"),this.nadirPatch&&this.nadirPatch.update(this.camera,{yaw:s.yaw,pitch:s.pitch},t),this.compassDisk&&this.compassDisk.setYawPitch(s.yaw,s.pitch),this.groundNavDots&&this.groundNavDots.setYawPitch(s.yaw,s.pitch),this.groundHeading&&this.groundHeading.setYawPitch(s.yaw,s.pitch);for(const n of this.frameListeners)n(t);this.renderer.render(this.scene,this.camera)}onFrame(e){return this.frameListeners.push(e),()=>{const t=this.frameListeners.indexOf(e);t>=0&&this.frameListeners.splice(t,1)}}getCamera(){return this.camera}getDomElement(){return this.renderer.domElement}setSceneData(e,t,s){if(this.groundNavDots){const i=s.filter(a=>{var o;return a.type==="scene"&&((o=a.target)==null?void 0:o.sceneId)}).map(a=>({id:a.id,label:a.label,yaw:a.yaw,pitch:a.pitch,target:{museumId:a.target.museumId,sceneId:a.target.sceneId}}));this.groundNavDots.updateScene(e,t,i)}}getSphereRadius(){return 500}getViewportSize(){return{width:this.container.clientWidth,height:this.container.clientHeight}}enablePickMode(){this.pickMode||(this.pickMode=!0,this.setupPickModeListeners())}disablePickMode(){this.pickMode&&(this.pickMode=!1,this.removePickModeListeners())}togglePickMode(){return this.pickMode?this.disablePickMode():this.enablePickMode(),this.pickMode}isPickModeEnabled(){return this.pickMode}setupPickModeListeners(){const e=this.renderer.domElement,t=a=>{if(!this.pickMode)return;let o,h;if(a instanceof TouchEvent){if(a.touches.length!==1)return;o=a.touches[0].clientX,h=a.touches[0].clientY}else o=a.clientX,h=a.clientY;this.pickStartX=o,this.pickStartY=h,this.pickStartTime=Date.now(),this.pickHasMoved=!1},s=a=>{if(!this.pickMode)return;let o,h;if(a instanceof TouchEvent){if(a.touches.length!==1)return;o=a.touches[0].clientX,h=a.touches[0].clientY}else o=a.clientX,h=a.clientY;const n=Math.abs(o-this.pickStartX),l=Math.abs(h-this.pickStartY);Math.sqrt(n*n+l*l)>this.pickDragThreshold&&(this.pickHasMoved=!0)},i=a=>{if(!this.pickMode)return;let o,h;if(a instanceof TouchEvent){if(a.changedTouches.length!==1)return;o=a.changedTouches[0].clientX,h=a.changedTouches[0].clientY}else o=a.clientX,h=a.clientY;const n=Date.now()-this.pickStartTime,l=Math.abs(o-this.pickStartX),u=Math.abs(h-this.pickStartY);Math.sqrt(l*l+u*u)>this.pickDragThreshold||n>this.pickTimeThreshold&&this.pickHasMoved||this.handlePick(o,h),this.pickHasMoved=!1};e.addEventListener("pointerdown",t),e.addEventListener("mousedown",t),e.addEventListener("touchstart",t,{passive:!0}),e.addEventListener("pointermove",s),e.addEventListener("mousemove",s),e.addEventListener("touchmove",s,{passive:!0}),e.addEventListener("pointerup",i),e.addEventListener("mouseup",i),e.addEventListener("touchend",i,{passive:!0}),this.pickModeListeners.push(()=>{e.removeEventListener("pointerdown",t),e.removeEventListener("mousedown",t),e.removeEventListener("touchstart",t),e.removeEventListener("pointermove",s),e.removeEventListener("mousemove",s),e.removeEventListener("touchmove",s),e.removeEventListener("pointerup",i),e.removeEventListener("mouseup",i),e.removeEventListener("touchend",i)})}removePickModeListeners(){this.pickModeListeners.forEach(e=>e()),this.pickModeListeners=[]}handlePick(e,t){const s=this.renderer.domElement.getBoundingClientRect(),i=He(e,t,s),a=Fe(i.x,i.y,this.camera,this.getSphereRadius());if(!a){typeof __VR_DEBUG__<"u"&&__VR_DEBUG__&&console.debug("[pick] 无法计算 yaw/pitch（ray.direction 为空）");return}const{yaw:o,pitch:h}=a,n=`yaw: ${o.toFixed(2)}, pitch: ${h.toFixed(2)}`;console.log(`[pick] yaw=${o.toFixed(2)}, pitch=${h.toFixed(2)}`),navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(n).catch(()=>{}),window.dispatchEvent(new CustomEvent("vr:pick",{detail:{x:e,y:t,yaw:o,pitch:h}}))}warnIfNotPanoAspect(e,t){if(!e.image)return;const s=e.image,i=s.width,a=s.height;if(!i||!a)return;const o=i/a;Math.abs(o-2)>.02&&!this.aspectWarnedUrls.has(t)&&(console.warn(`[PanoViewer] 全景图比例不是 2:1，可能出现轻微变形（实际 ${o.toFixed(2)}），来源: ${t}`),this.aspectWarnedUrls.add(t))}dispose(){if(this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const e=this.sphere.material;e.map&&e.map.dispose(),e.dispose()}this.nadirPatch&&(this.nadirPatch.dispose(this.scene),this.nadirPatch=null),this.compassDisk&&(this.compassDisk.dispose(),this.compassDisk=null),this.groundNavDots&&(this.groundNavDots.dispose(),this.groundNavDots=null),this.groundHeading&&(this.groundHeading.dispose(),this.groundHeading=null),this.renderer.dispose(),window.removeEventListener("resize",this.handleWindowResize)}applyRendererProfile(){const e=D[this.renderProfile];this.renderer.setPixelRatio(e.renderer.pixelRatio),"outputColorSpace"in this.renderer?this.renderer.outputColorSpace=$:this.renderer.outputEncoding=B,this.renderer.toneMapping=e.renderer.toneMapping,this.renderer.toneMappingExposure=e.renderer.toneMappingExposure,e.renderer.clearColor&&this.renderer.setClearColor(e.renderer.clearColor.color,e.renderer.clearColor.alpha)}detectRenderProfile(){try{const t=new URLSearchParams(window.location.search).get("render");if(t&&t.toLowerCase()==="original")return"original"}catch{}return"enhanced"}fallbackToLegacy(e,t){const s={...e,pano:(t==null?void 0:t.fallbackPano)??e.pano,panoLow:(t==null?void 0:t.fallbackPanoLow)??e.panoLow,panoTiles:void 0};s.pano||s.panoLow?(re("瓦片加载失败，已回退到全景图",2e3),this.setRenderSource("fallback","tiles 失败自动回退"),this.loadScene(s,{preserveView:!0})):(this.updateLoadStatus(w.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("瓦片与全景资源均不可用")))}setRenderSource(e,t){(this.renderSource!==e||t)&&(this.renderSource=e,this.renderSwitchReason=t)}noteCleared(e){this.clearedCount+=1,this.renderSwitchReason=e}async showFallbackTexture(e,t,s){try{const i=await F(e,{timeoutMs:15e3,retries:1,allowFetchFallback:!0,priority:"high",imageOrientation:"flipY"}),a=new x(i);this.applyTextureSettings(a),a.flipY=!1,a.wrapS=k,a.wrapT=k,a.needsUpdate=!0;const o=new _({map:a,depthWrite:!1,depthTest:!1}),h=new H(t.clone(),o);h.renderOrder=0,this.fallbackSphere=h,this.scene.add(h),this.updateLoadStatus(s?w.LOW_READY:w.HIGH_READY),this.setRenderSource("fallback",s?"fallback 低清可见":"fallback 高清可见"),s&&(this.tilesLowReady=!0),this.onLoadCallback&&this.onLoadCallback()}catch(i){console.error("fallback 贴图加载失败",i)}}clearFallback(){if(this.fallbackSphere){this.fallbackSphere.geometry&&this.fallbackSphere.geometry.dispose();const e=this.fallbackSphere.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.fallbackSphere),this.fallbackSphere=null}}applyTextureSettings(e){const t=D[this.renderProfile],s=this.renderer.capabilities.getMaxAnisotropy?this.renderer.capabilities.getMaxAnisotropy():1;if(e.anisotropy=Math.min(t.texture.anisotropyLimit,Math.max(1,s||1)),e.minFilter=t.texture.minFilter,e.magFilter=t.texture.magFilter,e.generateMipmaps=t.texture.generateMipmaps,"colorSpace"in e?e.colorSpace=$:e.encoding=B,e.needsUpdate=!0,this.debugMode){const i=e.image||{};console.log("pano texture",{w:i.width,h:i.height,colorSpace:e.colorSpace,encoding:e.encoding,anisotropy:e.anisotropy,minFilter:e.minFilter,magFilter:e.magFilter})}}}const it=Object.freeze(Object.defineProperty({__proto__:null,PanoViewer:Ke},Symbol.toStringTag,{value:"Module"}));export{it as P,Qe as d};
