const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./three-extras-3VrNSzCK.js","./three-renderer-toiwjbvW.js","./chat-community-C6ZbaM52.js","./store-B83L8bDT.js","./index-DInc35Wk.js","./index-BfJu72vJ.css","./dollhouseScene-B0yu9WMj.js"])))=>i.map(i=>d[i]);
var O=Object.defineProperty;var R=(f,e,t)=>e in f?O(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var n=(f,e,t)=>R(f,typeof e!="symbol"?e+"":e,t);import{_ as g,r as H,A as F,i as W,o as V,e as S,n as k}from"./index-DInc35Wk.js";import{S as $,P as U,W as B,A as j,D as X,G as I,M as b,B as T,V as C,a as Y,L as q,b as K,c as Z,d as J,R as x,e as D}from"./three-renderer-toiwjbvW.js";import{getNodeDegree as Q}from"./sceneGraph-CaQzl5R8.js";import{s as ee,f as te}from"./autoLayout-ZgSeGcPI.js";class se{constructor(e){n(this,"element");n(this,"container");n(this,"scene",null);n(this,"camera",null);n(this,"renderer",null);n(this,"controls");n(this,"museum");n(this,"graph");n(this,"currentSceneId");n(this,"onClose");n(this,"onNodeClick");n(this,"animationId",null);n(this,"sceneNodes",new Map);n(this,"edgeLines",[]);n(this,"hoveredSceneId",null);n(this,"resizeObserver",null);n(this,"handleWindowResize",()=>this.handleResize());n(this,"statusEl",null);n(this,"webglErrorEl",null);n(this,"modelErrorEl",null);n(this,"modelGroup",null);n(this,"modelLoaded",!1);n(this,"animate",()=>{if(!this.renderer||!this.scene||!this.camera)return;this.animationId=requestAnimationFrame(this.animate),this.controls&&this.controls.update();const e=Date.now()*.001;this.sceneNodes.forEach(t=>{if(t.userData.isCurrent){const s=Math.sin(e*2)*.1+1;t.scale.set(s*1.2,s*1.2,s*1.2);const i=t.material;i.opacity=.7+Math.sin(e*2)*.2}}),this.renderer.render(this.scene,this.camera)});this.museum=e.museum,this.graph=e.graph,this.currentSceneId=e.currentSceneId,this.onClose=e.onClose,this.onNodeClick=e.onNodeClick,this.element=document.createElement("div"),this.element.className="vr-structure3d-overlay",this.container=document.createElement("div"),this.container.className="vr-structure3d-canvas",this.render(),this.init3D().then(()=>{this.bindEvents()})}render(){const e=document.createElement("div");e.className="vr-structure3d-header";const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="4px";const s=document.createElement("div");s.className="vr-structure3d-title",s.textContent="三维模型",this.statusEl=document.createElement("div"),this.statusEl.className="vr-structure3d-status",this.updateStatusText(),t.appendChild(s),t.appendChild(this.statusEl);const i=document.createElement("button");i.className="vr-btn vr-structure3d-close",i.innerHTML="✕",i.setAttribute("aria-label","关闭"),i.addEventListener("click",()=>{this.close()}),e.appendChild(t),e.appendChild(i),this.webglErrorEl=document.createElement("div"),this.webglErrorEl.className="vr-structure3d-webgl-error",this.webglErrorEl.style.display="none",this.webglErrorEl.innerHTML=`
      <div style="text-align: center; padding: 40px 20px;">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">WebGL 不可用</div>
        <div style="font-size: 13px; opacity: 0.8;">请尝试更换浏览器或设备</div>
      </div>
    `,this.modelErrorEl=document.createElement("div"),this.modelErrorEl.className="vr-structure3d-model-error",this.modelErrorEl.style.display="none",this.modelErrorEl.innerHTML=`
      <div style="text-align: center; padding: 40px 20px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: rgba(255,200,100,0.95);">模型加载失败</div>
        <div style="font-size: 13px; opacity: 0.8;">请检查 URL 或网络连接</div>
      </div>
    `,this.element.appendChild(e),this.element.appendChild(this.container),this.element.appendChild(this.webglErrorEl),this.element.appendChild(this.modelErrorEl)}updateStatusText(){var l,r,h;if(!this.statusEl)return;const e=this.graph.nodes.length,t=this.graph.edges.length,s=((l=this.container)==null?void 0:l.clientWidth)||0,i=((r=this.container)==null?void 0:r.clientHeight)||0,o=this.modelLoaded?"loaded":(h=this.museum.dollhouse)!=null&&h.modelUrl?"loading":"none";e===0?(this.statusEl.textContent=`model: ${o}, No nodes (check museum.scenes)`,this.statusEl.style.color="rgba(255,200,100,0.9)"):(this.statusEl.textContent=`model: ${o}, nodes: ${e}, edges: ${t}, size: ${s}x${i}`,this.statusEl.style.color="rgba(255,255,255,0.65)")}async init3D(){var e;try{this.scene=new $,this.scene.background=null;const t=this.container.clientWidth>0?this.container.clientWidth/this.container.clientHeight:window.innerWidth/window.innerHeight;this.camera=new U(60,t,.1,1e3),this.camera.position.set(0,12,18),this.camera.lookAt(0,0,0);try{this.renderer=new B({antialias:!0,alpha:!0}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.container.appendChild(this.renderer.domElement)}catch{this.webglErrorEl&&(this.webglErrorEl.style.display="block");return}try{const{OrbitControls:o}=await g(async()=>{const{OrbitControls:l}=await import("./three-extras-3VrNSzCK.js").then(r=>r.i);return{OrbitControls:l}},__vite__mapDeps([0,1]),import.meta.url);this.controls=new o(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=3,this.controls.maxDistance=50,this.controls.maxPolarAngle=Math.PI/2.2,this.controls.minPolarAngle=Math.PI/6,this.controls.target.set(0,0,0)}catch{}const s=new j(16777215,.6);this.scene.add(s);const i=new X(16777215,.4);i.position.set(5,10,5),this.scene.add(i),this.modelGroup=new I,this.scene.add(this.modelGroup),(e=this.museum.dollhouse)!=null&&e.modelUrl?this.loadModel():this.generateGraph(),this.setupResizeObserver(),this.updateStatusText()}catch{this.webglErrorEl&&(this.webglErrorEl.style.display="block")}}async loadModel(){var t;if(!((t=this.museum.dollhouse)!=null&&t.modelUrl)||!this.scene||!this.modelGroup)return;const e=H(this.museum.dollhouse.modelUrl,F.DOLLHOUSE);if(e)try{const{GLTFLoader:s}=await g(async()=>{const{GLTFLoader:p}=await import("./three-extras-3VrNSzCK.js").then(a=>a.G);return{GLTFLoader:p}},__vite__mapDeps([0,1]),import.meta.url),o=await new s().loadAsync(e);for(;this.modelGroup.children.length>0;){const p=this.modelGroup.children[0];this.modelGroup.remove(p),(p instanceof b||p instanceof I)&&p.traverse(a=>{var d,c;a instanceof b&&((d=a.geometry)==null||d.dispose(),Array.isArray(a.material)?a.material.forEach(u=>u.dispose()):(c=a.material)==null||c.dispose())})}const l=o.scene,r=this.museum.dollhouse.scale??1,h=this.museum.dollhouse.offset??{x:0,y:0,z:0};l.scale.set(r,r,r),l.position.set(h.x,h.y,h.z),this.modelGroup.add(l),this.modelLoaded=!0,this.generateGraph(),this.fitModelToView(),this.updateStatusText(),this.modelErrorEl&&(this.modelErrorEl.style.display="none")}catch{this.modelLoaded=!1,this.updateStatusText(),this.modelErrorEl&&(this.modelErrorEl.style.display="block"),this.generateGraph()}}fitModelToView(){if(!this.modelGroup||!this.scene||!this.camera||!this.controls)return;const e=new T().setFromObject(this.modelGroup),t=e.getCenter(new C),s=e.getSize(new C),i=Math.max(s.x,s.y,s.z),o=i*2;this.camera.position.set(t.x,t.y+s.y*.5,t.z+o),this.camera.lookAt(t),this.camera.updateProjectionMatrix(),this.controls.target.copy(t),this.controls.update(),this.controls.minDistance=i*.5,this.controls.maxDistance=i*5}setupResizeObserver(){if(!this.container||typeof ResizeObserver>"u"){window.addEventListener("resize",this.handleWindowResize);return}this.resizeObserver=new ResizeObserver(()=>{this.handleResize()}),this.resizeObserver.observe(this.container)}handleResize(){if(!this.renderer||!this.camera||!this.container)return;const e=this.container.clientWidth,t=this.container.clientHeight;e===0||t===0||(this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t,!1),this.updateStatusText())}generateGraph(){var h,p;if(!this.scene)return;this.sceneNodes.forEach(a=>{this.scene.remove(a),a.geometry.dispose(),Array.isArray(a.material)?a.material.forEach(d=>d.dispose()):a.material.dispose()}),this.sceneNodes.clear(),this.edgeLines.forEach(a=>{this.scene.remove(a),a.geometry.dispose(),Array.isArray(a.material)?a.material.forEach(d=>d.dispose()):a.material.dispose()}),this.edgeLines=[];const e=this.modelLoaded&&this.modelGroup&&this.modelGroup.children.length>0,t=ee(this.graph.nodes),s=((h=this.museum.map)==null?void 0:h.width)||1e3,i=((p=this.museum.map)==null?void 0:p.height)||600;let o={};if(t)o=te(this.graph.nodes,this.graph.edges,{width:s,height:i,iterations:300,padding:40});else for(const a of this.graph.nodes)a.mapPoint&&(o[a.id]={x:a.mapPoint.x,y:a.mapPoint.y});const r=(a=>{const d=Object.entries(a);if(d.length===0)return{};let c=1/0,u=-1/0,v=1/0,m=-1/0;for(const[,y]of d)c=Math.min(c,y.x),u=Math.max(u,y.x),v=Math.min(v,y.y),m=Math.max(m,y.y);const P=u-c||1,E=m-v||1,w=20/P,N=20/E,z=(c+u)/2,_=(v+m)/2,L={};for(const[y,M]of d){const A=Q(this.graph,y),G=(Math.random()-.5)*.5;L[y]={x:(M.x-z)*w,y:A*1.5+G,z:(M.y-_)*N}}return L})(o);if(!e)for(const a of this.graph.edges){const d=r[a.from],c=r[a.to];if(!d||!c)continue;const u=new Y().setFromPoints([new C(d.x,d.y,d.z),new C(c.x,c.y,c.z)]),v=new q({color:16777215,opacity:.3,transparent:!0}),m=new K(u,v);this.scene.add(m),this.edgeLines.push(m)}for(const a of this.graph.nodes){const d=r[a.id];if(!d)continue;const c=a.id===this.currentSceneId,u=new Z(c?.8:.6,16,16),v=new J({color:c?4886754:8947848,opacity:c?.9:.7,transparent:!0,metalness:.1,roughness:.7}),m=new b(u,v);if(e&&this.modelGroup){const P=new T().setFromObject(this.modelGroup),E=P.getCenter(new C),w=P.getSize(new C);m.position.set(E.x+d.x*.1,E.y+w.y*.5+d.y*.1+1,E.z+d.z*.1)}else m.position.set(d.x,d.y,d.z);m.userData={sceneId:a.id,sceneName:a.name},c&&(m.userData.isCurrent=!0,m.scale.set(1.2,1.2,1.2)),this.scene.add(m),this.sceneNodes.set(a.id,m)}}handleClick(e){if(!this.renderer||!this.camera||this.sceneNodes.size===0)return;const t=this.renderer.domElement.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*2-1,i=-((e.clientY-t.top)/t.height)*2+1,o=new x;o.setFromCamera(new D(s,i),this.camera);const l=o.intersectObjects(Array.from(this.sceneNodes.values()));if(l.length>0){const h=l[0].object.userData.sceneId;h&&this.onNodeClick&&this.onNodeClick(this.museum.id,h)}}handleMouseMove(e){if(!this.renderer||!this.camera||this.sceneNodes.size===0)return;const t=this.renderer.domElement.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*2-1,i=-((e.clientY-t.top)/t.height)*2+1,o=new x;o.setFromCamera(new D(s,i),this.camera);const l=o.intersectObjects(Array.from(this.sceneNodes.values()));if(this.sceneNodes.forEach(r=>{const h=r.material;r.userData.isCurrent||(h.opacity=.7)}),l.length>0){const r=l[0].object,h=r.material,p=r.userData.sceneId;r.userData.isCurrent||(h.opacity=.9),this.hoveredSceneId=p,this.renderer.domElement.style.cursor="pointer"}else this.hoveredSceneId=null,this.renderer.domElement.style.cursor="default"}bindEvents(){if(!this.renderer)return;const e=this.renderer.domElement;e.addEventListener("click",s=>this.handleClick(s)),e.addEventListener("mousemove",s=>this.handleMouseMove(s));const t=s=>{s.key==="Escape"&&this.close()};document.addEventListener("keydown",t),this.element.addEventListener("vr:cleanup",()=>{document.removeEventListener("keydown",t)})}updateContext(e){var t,s;if(this.museum=e.museum,this.graph=e.graph,this.currentSceneId=e.currentSceneId,this.scene){const i=(t=e.museum.dollhouse)==null?void 0:t.modelUrl,o=(s=this.museum.dollhouse)==null?void 0:s.modelUrl;if(i!==o){if(this.modelGroup)for(;this.modelGroup.children.length>0;){const l=this.modelGroup.children[0];this.modelGroup.remove(l)}this.modelLoaded=!1,i?this.loadModel():this.generateGraph()}else this.generateGraph();this.updateStatusText()}}open(){this.element.classList.add("is-visible"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.handleResize(),!this.animationId&&this.renderer&&this.scene&&this.camera&&this.animate()})})}close(){this.element.classList.remove("is-visible"),this.onClose&&this.onClose()}getElement(){return this.element}remove(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.scene&&(this.sceneNodes.forEach(e=>{this.scene.remove(e),e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()}),this.sceneNodes.clear(),this.edgeLines.forEach(e=>{this.scene.remove(e),e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()}),this.edgeLines=[],this.modelGroup&&(this.modelGroup.traverse(e=>{var t,s;e instanceof b&&((t=e.geometry)==null||t.dispose(),Array.isArray(e.material)?e.material.forEach(i=>i.dispose()):(s=e.material)==null||s.dispose())}),this.scene.remove(this.modelGroup),this.modelGroup=null)),this.renderer&&(this.renderer.dispose(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.renderer=null),this.controls&&(this.controls.dispose(),this.controls=null),window.removeEventListener("resize",this.handleWindowResize),this.scene=null,this.camera=null,this.element.remove()}}const ue=Object.freeze(Object.defineProperty({__proto__:null,StructureView3D:se},Symbol.toStringTag,{value:"Module"}));class ne{constructor(e){n(this,"element");n(this,"currentTab");n(this,"sceneId");n(this,"sceneName");n(this,"museum");n(this,"scenes");n(this,"currentSceneId");n(this,"communityPanel",null);n(this,"mapPanel",null);n(this,"dollhousePanel",null);n(this,"handleClosePanels",null);n(this,"handlePanelClickCapture",null);n(this,"renderToken",0);this.currentTab=e.initialTab,this.sceneId=e.sceneId,this.sceneName=e.sceneName,this.museum=e.museum,this.scenes=e.scenes,this.currentSceneId=e.currentSceneId||e.sceneId,this.element=document.createElement("div"),this.element.className="vr-panl vr-glass hidden",this.handlePanelClickCapture=()=>{W.emitUIEngaged()},this.element.addEventListener("click",this.handlePanelClickCapture,!0),this.handleClosePanels=()=>{this.closeAllPanels()},window.addEventListener("vr:close-panels",this.handleClosePanels),this.render()}disposeCommunityPanel(){this.communityPanel&&(this.communityPanel.remove(),this.communityPanel=null)}disposeMapPanel(){this.mapPanel&&(this.mapPanel.remove(),this.mapPanel=null)}disposeDollhousePanel(){this.dollhousePanel&&(this.dollhousePanel.remove(),this.dollhousePanel=null)}async ensureCommunityPanel(){const e=this.sceneId||"unknown";if(this.communityPanel)this.communityPanel.setScene(e,this.sceneName);else{const{CommunityPanel:t}=await g(async()=>{const{CommunityPanel:s}=await import("./chat-community-C6ZbaM52.js").then(i=>i.C);return{CommunityPanel:s}},__vite__mapDeps([2,3,4,5]),import.meta.url);this.communityPanel=new t({sceneId:e,sceneName:this.sceneName,onClose:()=>{this.disposeCommunityPanel(),this.element.classList.add("hidden"),this.element.innerHTML=""}})}return this.communityPanel}async ensureMapPanel(e){if(!this.museum||!this.scenes||this.scenes.length===0)return null;if(this.mapPanel)this.mapPanel.updateCurrentScene(e);else{const{MapPanel:t}=await g(async()=>{const{MapPanel:s}=await Promise.resolve().then(()=>oe);return{MapPanel:s}},void 0,import.meta.url);this.mapPanel=new t({museum:this.museum,scenes:this.scenes,currentSceneId:e,onClose:()=>{window.dispatchEvent(new CustomEvent("vr:close-panels"))}})}return this.mapPanel}async ensureDollhousePanel(e){if(!this.museum||!this.scenes||this.scenes.length===0)return null;if(this.dollhousePanel)this.dollhousePanel.updateCurrentScene(e);else{const{Dollhouse3DPanel:t}=await g(async()=>{const{Dollhouse3DPanel:s}=await Promise.resolve().then(()=>ae);return{Dollhouse3DPanel:s}},void 0,import.meta.url);this.dollhousePanel=new t({museum:this.museum,scenes:this.scenes,currentSceneId:e,onClose:()=>{window.dispatchEvent(new CustomEvent("vr:close-panels"))}})}return this.dollhousePanel}async render(){var t,s,i,o;const e=++this.renderToken;if(this.element.classList.remove("vr-panel--community","vr-panel--map","vr-panel--dollhouse"),!this.currentTab){this.element.classList.add("hidden"),this.element.innerHTML="",this.disposeCommunityPanel(),this.disposeMapPanel(),this.disposeDollhousePanel();return}if(this.currentTab==="community"){this.element.classList.add("vr-panel--community"),this.element.innerHTML="",this.disposeMapPanel(),this.disposeDollhousePanel();const l=await this.ensureCommunityPanel();if(!l||e!==this.renderToken||this.currentTab!=="community")return;this.element.appendChild(l.getElement());return}if(this.currentTab==="map"){this.element.classList.add("vr-panel--map"),this.element.innerHTML="",this.disposeCommunityPanel(),this.disposeDollhousePanel();const l=this.currentSceneId||this.sceneId||((s=(t=this.scenes)==null?void 0:t[0])==null?void 0:s.id);if(!l){this.element.innerHTML=`
          <div class="vr-panel-title">平面图</div>
          <div class="vr-panel-body">此展馆暂无平面图</div>
        `;return}const r=await this.ensureMapPanel(l);if(!r||e!==this.renderToken||this.currentTab!=="map")return;this.element.appendChild(r.getElement());return}if(this.currentTab==="dollhouse"){this.element.classList.add("vr-panel--dollhouse"),this.element.innerHTML="",this.disposeCommunityPanel(),this.disposeMapPanel();const l=this.currentSceneId||this.sceneId||((o=(i=this.scenes)==null?void 0:i[0])==null?void 0:o.id);if(!l){this.element.innerHTML=`
          <div class="vr-panel-title">三维图</div>
          <div class="vr-panel-body">此展馆暂无三维图</div>
        `;return}const r=await this.ensureDollhousePanel(l);if(!r||e!==this.renderToken||this.currentTab!=="dollhouse")return;this.element.appendChild(r.getElement());return}this.disposeCommunityPanel(),this.disposeMapPanel(),this.disposeDollhousePanel(),this.element.classList.add("hidden"),this.element.innerHTML=""}setSceneContext(e,t){this.sceneId=e,this.sceneName=t,this.currentSceneId=e,this.currentTab==="community"&&(this.communityPanel?this.communityPanel.setScene(e,t):this.render()),this.currentTab==="map"&&(this.mapPanel?this.mapPanel.updateCurrentScene(e):this.render()),this.currentTab==="dollhouse"&&(this.dollhousePanel?this.dollhousePanel.updateCurrentScene(e):this.render())}setMuseumContext(e,t,s){this.museum=e,this.scenes=t,this.currentSceneId=s,this.currentTab==="map"&&(this.mapPanel?this.mapPanel.updateMuseum(e,t,s):this.render()),this.currentTab==="dollhouse"&&(this.dollhousePanel?this.dollhousePanel.updateMuseum(e,t,s):this.render())}setVisible(e){this.element.classList.remove("hidden","visible"),this.element.classList.add(e?"visible":"hidden")}setTab(e){this.currentTab=e,this.setVisible(!1),window.setTimeout(()=>{this.render(),this.setVisible(!0)},40)}closeAllPanels(){this.renderToken+=1,this.currentTab=null,this.disposeCommunityPanel(),this.disposeMapPanel(),this.disposeDollhousePanel(),this.element.classList.add("hidden"),this.element.innerHTML=""}getElement(){return this.element}remove(){this.renderToken+=1,this.handleClosePanels&&(window.removeEventListener("vr:close-panels",this.handleClosePanels),this.handleClosePanels=null),this.handlePanelClickCapture&&(this.element.removeEventListener("click",this.handlePanelClickCapture,!0),this.handlePanelClickCapture=null),this.disposeCommunityPanel(),this.disposeMapPanel(),this.disposeDollhousePanel(),this.element.remove()}}const pe=Object.freeze(Object.defineProperty({__proto__:null,DockPanels:ne},Symbol.toStringTag,{value:"Module"}));class ie{constructor(e){n(this,"element");n(this,"museum");n(this,"scenes");n(this,"currentSceneId");n(this,"onClose");n(this,"mapContainer");n(this,"mapImage");n(this,"pointsContainer");n(this,"unsubscribeFocus",null);this.museum=e.museum,this.scenes=e.scenes,this.currentSceneId=e.currentSceneId,this.onClose=e.onClose,this.element=document.createElement("div"),this.element.className="vr-map-panel",this.render()}render(){const e=document.createElement("div");e.className="vr-map-header";const t=document.createElement("div");t.className="vr-map-title",t.textContent="平面图";const s=document.createElement("button");s.className="vr-btn vr-map-close",s.innerHTML="✕",s.setAttribute("aria-label","关闭"),s.addEventListener("click",()=>{this.onClose&&this.onClose()}),e.appendChild(t),e.appendChild(s),this.mapContainer=document.createElement("div"),this.mapContainer.className="vr-map-container",this.mapImage=document.createElement("img"),this.mapImage.className="vr-map-image",this.mapImage.src=this.museum.map.image,this.mapImage.alt=`${this.museum.name} 平面图`,this.mapImage.style.width="100%",this.mapImage.style.height="auto",this.mapImage.style.display="block",this.pointsContainer=document.createElement("div"),this.pointsContainer.className="vr-map-points",this.mapContainer.appendChild(this.mapImage),this.mapContainer.appendChild(this.pointsContainer);const i=document.createElement("div");i.className="vr-map-body",i.appendChild(this.mapContainer),this.element.appendChild(e),this.element.appendChild(i),this.mapImage.addEventListener("load",()=>{this.renderPoints()}),this.mapImage.complete&&this.renderPoints(),this.unsubscribeFocus=V(o=>{this.handleSceneFocus(o)})}handleSceneFocus(e){if(e.type==="focus"&&e.source!=="map"){const t=this.pointsContainer.querySelector(`[data-scene-id="${e.sceneId}"]`);t&&(t.classList.add("vr-map-point--focus-flash"),setTimeout(()=>{t.classList.remove("vr-map-point--focus-flash")},300))}}renderPoints(){if(this.pointsContainer.innerHTML="",!this.mapImage.complete||!this.mapContainer.offsetWidth){setTimeout(()=>this.renderPoints(),100);return}const e=this.museum.map.width,t=this.museum.map.height,s=this.mapContainer.offsetWidth,i=s*t/e;this.mapContainer.style.height=`${i}px`;const o=s/e,l=i/t;this.scenes.forEach(r=>{if(!r.mapPoint)return;const h=document.createElement("button");h.className="vr-btn vr-map-point",h.setAttribute("data-scene-id",r.id),h.setAttribute("aria-label",r.name),r.id===this.currentSceneId&&h.classList.add("vr-map-point--current");const a=r.mapPoint.x*o,d=r.mapPoint.y*l;h.style.left=`${a}px`,h.style.top=`${d}px`;const c=document.createElement("div");c.className="vr-map-point-marker",h.appendChild(c);const u=document.createElement("div");u.className="vr-map-point-tooltip",u.textContent=r.name,h.appendChild(u),h.addEventListener("mouseenter",()=>{S({type:"hover",museumId:this.museum.id,sceneId:r.id,source:"map",ts:Date.now()})}),h.addEventListener("mouseleave",()=>{S({type:"hover",museumId:this.museum.id,sceneId:null,source:"map",ts:Date.now()})}),h.addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),S({type:"focus",museumId:this.museum.id,sceneId:r.id,source:"map",ts:Date.now()}),k(this.museum.id,r.id),this.onClose&&this.onClose()}),this.pointsContainer.appendChild(h)})}updateCurrentScene(e){this.currentSceneId=e,this.renderPoints()}updateMuseum(e,t,s){this.museum=e,this.scenes=t,this.currentSceneId=s,this.mapImage.src=e.map.image,this.renderPoints()}getElement(){return this.element}remove(){this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=null),this.element.remove()}}const oe=Object.freeze(Object.defineProperty({__proto__:null,MapPanel:ie},Symbol.toStringTag,{value:"Module"}));class re{constructor(e){n(this,"element");n(this,"museum");n(this,"scenes");n(this,"currentSceneId");n(this,"onClose");n(this,"container");n(this,"dollhouseScene",null);n(this,"initToken",0);n(this,"handleCanvasClick",null);n(this,"handleCanvasMove",null);this.museum=e.museum,this.scenes=e.scenes,this.currentSceneId=e.currentSceneId,this.onClose=e.onClose,this.element=document.createElement("div"),this.element.className="vr-dollhouse-panel",this.render()}render(){const e=document.createElement("div");e.className="vr-dollhouse-header";const t=document.createElement("div");t.className="vr-dollhouse-title",t.textContent="三维图";const s=document.createElement("button");s.className="vr-btn vr-dollhouse-close",s.innerHTML="✕",s.setAttribute("aria-label","关闭"),s.addEventListener("click",()=>{this.onClose&&this.onClose()}),e.appendChild(t),e.appendChild(s),this.container=document.createElement("div"),this.container.className="vr-dollhouse-container";const i=document.createElement("div");i.className="vr-dollhouse-body",i.appendChild(this.container),this.element.appendChild(e),this.element.appendChild(i),this.initDollhouseScene()}teardownDollhouseScene(){if(!this.dollhouseScene)return;const e=this.dollhouseScene.getDomElement();this.handleCanvasClick&&(e.removeEventListener("click",this.handleCanvasClick),this.handleCanvasClick=null),this.handleCanvasMove&&(e.removeEventListener("mousemove",this.handleCanvasMove),this.handleCanvasMove=null),this.dollhouseScene.dispose(),this.dollhouseScene=null}async initDollhouseScene(){this.initToken+=1;const e=this.initToken;this.teardownDollhouseScene();const{DollhouseScene:t}=await g(async()=>{const{DollhouseScene:o}=await import("./dollhouseScene-B0yu9WMj.js");return{DollhouseScene:o}},__vite__mapDeps([6,4,1,5]),import.meta.url);if(e!==this.initToken)return;const s=new t(this.container,this.museum.id,this.scenes,this.currentSceneId,(o,l)=>{k(o,l),this.onClose&&this.onClose()},this.museum);if(e!==this.initToken){s.dispose();return}this.dollhouseScene=s;const i=this.dollhouseScene.getDomElement();this.handleCanvasClick=o=>{var l;(l=this.dollhouseScene)==null||l.handleClick(o)},this.handleCanvasMove=o=>{var l;(l=this.dollhouseScene)==null||l.handleMouseMove(o)},i.addEventListener("click",this.handleCanvasClick),i.addEventListener("mousemove",this.handleCanvasMove)}updateCurrentScene(e){this.currentSceneId=e,this.dollhouseScene&&this.dollhouseScene.updateCurrentScene(e)}updateMuseum(e,t,s){this.museum=e,this.scenes=t,this.currentSceneId=s,this.dollhouseScene?this.dollhouseScene.updateScenes(t,s):this.initDollhouseScene()}getElement(){return this.element}remove(){this.initToken+=1,this.teardownDollhouseScene(),this.element.remove()}}const ae=Object.freeze(Object.defineProperty({__proto__:null,Dollhouse3DPanel:re},Symbol.toStringTag,{value:"Module"}));export{pe as D,ue as S};
