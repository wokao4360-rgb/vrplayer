const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./three-extras-F77eSNTx.js","./three.module-Brkpord5.js"])))=>i.map(i=>d[i]);
var C=Object.defineProperty;var D=(p,e,t)=>e in p?C(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var h=(p,e,t)=>D(p,typeof e!="symbol"?e+"":e,t);import{_ as S,r as A,A as I}from"./index-CntEWe8z.js";import{S as R,P as O,W as P,G,A as N,D as U,B as M,V as g,R as z,a as L,b as _,L as W,c as k,d as F,M as T,e as x}from"./three.module-Brkpord5.js";import{s as H,f as V}from"./autoLayout-ZgSeGcPI.js";import{getNodeDegree as X}from"./sceneGraph-CaQzl5R8.js";class J{constructor(e){h(this,"options");h(this,"scene",null);h(this,"camera",null);h(this,"renderer",null);h(this,"controls",null);h(this,"modelGroup",null);h(this,"sceneNodes",new Map);h(this,"edgeLines",[]);h(this,"animationId",null);h(this,"resizeObserver",null);h(this,"handleWindowResize",()=>this.handleResize());h(this,"canvasListeners",[]);h(this,"disposed",!1);h(this,"modelStatus","none");h(this,"hoveredSceneId",null);this.options=e}async init(){var s,i,n;if(this.disposed)return!1;const e=this.options.container,t=e.clientWidth>0&&e.clientHeight>0?e.clientWidth/e.clientHeight:window.innerWidth/Math.max(1,window.innerHeight);this.scene=new R,this.scene.background=null,this.camera=new O(60,t,.1,1e3),this.camera.position.set(0,12,18),this.camera.lookAt(0,0,0);try{this.renderer=new P({antialias:!0,alpha:!0}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),e.appendChild(this.renderer.domElement)}catch{return(i=(s=this.options).onWebGlUnavailable)==null||i.call(s),!1}return await this.initControls(),this.mountLights(),this.modelGroup=new G,this.scene.add(this.modelGroup),(n=this.options.museum.dollhouse)!=null&&n.modelUrl?(this.modelStatus="loading",this.emitStatus(),await this.loadModel()):(this.modelStatus="none",this.generateGraph(),this.emitStatus()),this.setupResizeObserver(),this.bindCanvasEvents(),this.handleResize(),!0}open(){if(!this.renderer||!this.scene||!this.camera||this.animationId!==null||this.disposed)return;const e=()=>{if(this.disposed||!this.renderer||!this.scene||!this.camera)return;this.animationId=requestAnimationFrame(e),this.controls&&this.controls.update();const t=Date.now()*.001;this.sceneNodes.forEach(s=>{if(s.userData.isCurrent){const i=Math.sin(t*2)*.1+1;s.scale.setScalar(i*1.2);const n=s.material;n.opacity=.7+Math.sin(t*2)*.2}}),this.renderer.render(this.scene,this.camera)};this.animationId=requestAnimationFrame(e)}updateContext(e){var i,n;if(this.disposed)return;const t=(i=this.options.museum.dollhouse)==null?void 0:i.modelUrl;this.options.museum=e.museum,this.options.graph=e.graph,this.options.currentSceneId=e.currentSceneId;const s=(n=e.museum.dollhouse)==null?void 0:n.modelUrl;if(t!==s){this.reloadModel().catch(()=>{});return}this.generateGraph(),this.emitStatus()}dispose(){var e;if(!this.disposed){this.disposed=!0,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null);for(const t of this.canvasListeners)t();this.canvasListeners.length=0,this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),window.removeEventListener("resize",this.handleWindowResize),this.clearGraph(),this.clearModelGroup(),(e=this.controls)==null||e.dispose(),this.controls=null,this.renderer&&(this.renderer.dispose(),this.renderer.domElement.remove(),this.renderer=null),this.camera=null,this.scene=null}}async initControls(){if(!(!this.renderer||!this.camera))try{const{OrbitControls:e}=await S(async()=>{const{OrbitControls:s}=await import("./three-extras-F77eSNTx.js").then(i=>i.i);return{OrbitControls:s}},__vite__mapDeps([0,1]),import.meta.url),t=new e(this.camera,this.renderer.domElement);t.enableDamping=!0,t.dampingFactor=.05,t.minDistance=3,t.maxDistance=50,t.maxPolarAngle=Math.PI/2.2,t.minPolarAngle=Math.PI/6,t.target.set(0,0,0),this.controls=t}catch{this.controls=null}}mountLights(){if(!this.scene)return;const e=new N(16777215,.6),t=new U(16777215,.4);t.position.set(5,10,5),this.scene.add(e),this.scene.add(t)}async reloadModel(){var e;if(this.clearModelGroup(),!!this.scene){if(this.modelGroup=new G,this.scene.add(this.modelGroup),(e=this.options.museum.dollhouse)!=null&&e.modelUrl){this.modelStatus="loading",this.emitStatus(),await this.loadModel();return}this.modelStatus="none",this.generateGraph(),this.emitStatus()}}async loadModel(){var s,i,n,o,r,c,a,u,m;if(!this.scene||!this.modelGroup)return;const e=(s=this.options.museum.dollhouse)==null?void 0:s.modelUrl;if(!e){this.modelStatus="none",this.generateGraph(),this.emitStatus();return}const t=A(e,I.DOLLHOUSE);if(!t){this.modelStatus="error",(n=(i=this.options).onModelError)==null||n.call(i,"模型 URL 无效"),this.generateGraph(),this.emitStatus();return}try{const{GLTFLoader:l}=await S(async()=>{const{GLTFLoader:E}=await import("./three-extras-F77eSNTx.js").then(b=>b.G);return{GLTFLoader:E}},__vite__mapDeps([0,1]),import.meta.url),d=await new l().loadAsync(t);this.clearModelGroup(),this.modelGroup=new G,this.scene.add(this.modelGroup);const f=d.scene,w=((o=this.options.museum.dollhouse)==null?void 0:o.scale)??1,v=((r=this.options.museum.dollhouse)==null?void 0:r.offset)??{x:0,y:0,z:0};f.scale.set(w,w,w),f.position.set(v.x,v.y,v.z),this.modelGroup.add(f),this.modelStatus="loaded",this.generateGraph(),this.fitModelToView(),(a=(c=this.options).onModelError)==null||a.call(c,""),this.emitStatus()}catch(l){this.modelStatus="error";const y=l instanceof Error?l.message:String(l);(m=(u=this.options).onModelError)==null||m.call(u,y),this.generateGraph(),this.emitStatus()}}fitModelToView(){if(!this.modelGroup||!this.scene||!this.camera||!this.controls)return;const e=new M().setFromObject(this.modelGroup),t=e.getCenter(new g),s=e.getSize(new g),i=Math.max(s.x,s.y,s.z),n=i*2;this.camera.position.set(t.x,t.y+s.y*.5,t.z+n),this.camera.lookAt(t),this.camera.updateProjectionMatrix(),this.controls.target.copy(t),this.controls.update(),this.controls.minDistance=i*.5,this.controls.maxDistance=i*5}bindCanvasEvents(){if(!this.renderer)return;const e=this.renderer.domElement,t=i=>this.handleClick(i),s=i=>this.handleMouseMove(i);e.addEventListener("click",t),e.addEventListener("mousemove",s),this.canvasListeners.push(()=>{e.removeEventListener("click",t),e.removeEventListener("mousemove",s)})}handleClick(e){if(!this.renderer||!this.camera||this.sceneNodes.size===0)return;const t=this.renderer.domElement.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*2-1,i=-((e.clientY-t.top)/t.height)*2+1,n=new z;n.setFromCamera(new L(s,i),this.camera);const o=n.intersectObjects(Array.from(this.sceneNodes.values()));if(o.length===0)return;const c=o[0].object.userData.sceneId;c&&this.options.onNodeClick&&this.options.onNodeClick(this.options.museum.id,c)}handleMouseMove(e){if(!this.renderer||!this.camera||this.sceneNodes.size===0)return;const t=this.renderer.domElement.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*2-1,i=-((e.clientY-t.top)/t.height)*2+1,n=new z;n.setFromCamera(new L(s,i),this.camera);const o=n.intersectObjects(Array.from(this.sceneNodes.values()));if(this.sceneNodes.forEach(r=>{if(!r.userData.isCurrent){const c=r.material;c.opacity=.7}}),o.length>0){const r=o[0].object,c=r.userData.sceneId;if(!r.userData.isCurrent){const a=r.material;a.opacity=.9}this.hoveredSceneId=c??null,this.renderer.domElement.style.cursor="pointer";return}this.hoveredSceneId=null,this.renderer.domElement.style.cursor="default"}setupResizeObserver(){if(typeof ResizeObserver>"u"){window.addEventListener("resize",this.handleWindowResize);return}this.resizeObserver=new ResizeObserver(()=>{this.handleResize()}),this.resizeObserver.observe(this.options.container)}handleResize(){if(!this.renderer||!this.camera)return;const e=this.options.container.clientWidth,t=this.options.container.clientHeight;e<=0||t<=0||(this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t,!1),this.emitStatus())}generateGraph(){if(!this.scene)return;this.clearGraph();const e=this.modelStatus==="loaded"&&this.modelGroup&&this.modelGroup.children.length>0,t=this.computeLayout2D(),s=this.normalizeTo3D(t);if(!e)for(const i of this.options.graph.edges){const n=s[i.from],o=s[i.to];if(!n||!o)continue;const r=new _().setFromPoints([new g(n.x,n.y,n.z),new g(o.x,o.y,o.z)]),c=new W({color:16777215,opacity:.3,transparent:!0}),a=new k(r,c);this.scene.add(a),this.edgeLines.push(a)}for(const i of this.options.graph.nodes){const n=s[i.id];if(!n)continue;const o=i.id===this.options.currentSceneId,r=new F(o?.8:.6,16,16),c=new T({color:o?4886754:8947848,opacity:o?.9:.7,transparent:!0,metalness:.1,roughness:.7}),a=new x(r,c);if(e&&this.modelGroup){const u=new M().setFromObject(this.modelGroup),m=u.getCenter(new g),l=u.getSize(new g);a.position.set(m.x+n.x*.1,m.y+l.y*.5+n.y*.1+1,m.z+n.z*.1)}else a.position.set(n.x,n.y,n.z);a.userData={sceneId:i.id,sceneName:i.name,isCurrent:o},o&&a.scale.setScalar(1.2),this.scene.add(a),this.sceneNodes.set(i.id,a)}}computeLayout2D(){var n,o;const e=H(this.options.graph.nodes),t=((n=this.options.museum.map)==null?void 0:n.width)||1e3,s=((o=this.options.museum.map)==null?void 0:o.height)||600;if(e)return V(this.options.graph.nodes,this.options.graph.edges,{width:t,height:s,iterations:300,padding:40});const i={};for(const r of this.options.graph.nodes)r.mapPoint&&(i[r.id]={x:r.mapPoint.x,y:r.mapPoint.y});return i}normalizeTo3D(e){const t=Object.entries(e);if(t.length===0)return{};let s=1/0,i=-1/0,n=1/0,o=-1/0;for(const[,d]of t)s=Math.min(s,d.x),i=Math.max(i,d.x),n=Math.min(n,d.y),o=Math.max(o,d.y);const r=i-s||1,c=o-n||1,a=20/r,u=20/c,m=(s+i)/2,l=(n+o)/2,y={};for(const[d,f]of t){const w=X(this.options.graph,d),v=(Math.random()-.5)*.5;y[d]={x:(f.x-m)*a,y:w*1.5+v,z:(f.y-l)*u}}return y}clearGraph(){this.scene&&(this.sceneNodes.forEach(e=>{var t;(t=this.scene)==null||t.remove(e),e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(s=>s.dispose()):e.material.dispose()}),this.sceneNodes.clear(),this.edgeLines.forEach(e=>{var t;(t=this.scene)==null||t.remove(e),e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(s=>s.dispose()):e.material.dispose()}),this.edgeLines=[])}clearModelGroup(){!this.scene||!this.modelGroup||(this.modelGroup.traverse(e=>{var t,s;e instanceof x&&((t=e.geometry)==null||t.dispose(),Array.isArray(e.material)?e.material.forEach(i=>i.dispose()):(s=e.material)==null||s.dispose())}),this.scene.remove(this.modelGroup),this.modelGroup.clear(),this.modelGroup=null)}emitStatus(){var e,t;(t=(e=this.options).onStatusChange)==null||t.call(e,{modelStatus:this.modelStatus,nodeCount:this.options.graph.nodes.length,edgeCount:this.options.graph.edges.length,width:this.options.container.clientWidth||0,height:this.options.container.clientHeight||0})}}export{J as StructureSceneRuntime};
