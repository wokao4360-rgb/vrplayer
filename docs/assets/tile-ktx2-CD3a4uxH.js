var Rt=Object.defineProperty;var Mt=(p,t,e)=>t in p?Rt(p,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):p[t]=e;var c=(p,t,e)=>Mt(p,typeof t!="symbol"?t+"":t,e);import{_ as Pt}from"./index-CH8d6S_0.js";import{G as Et,S as tt,s as it,T as vt,C as rt,L as V,M as At,a as Bt,b as kt,c as $,V as bt,d as Ut,F as Q,e as Ht,U as R,f as It,g as ct,h as Gt,i as zt,D as Dt,j as $t,N as ot,R as at,k as z,l as D,m as b,H as W,n as O,o as Wt,p as Ot,q as Vt,r as Kt,t as Nt,u as Xt,v as Qt,w as jt,x as Yt,y as Jt,z as qt}from"./three.module-BpE9LMaq.js";import{loadExternalImageBitmap as Zt}from"./externalImage-Cn8sVw7v.js";import{d as te}from"./PanoViewer-Df-P4sy5.js";import{W as ee,p as se,P as ie,n as re,F as oe,x as nt,X as ae,E as ne,a as ht,Q as he,t as le,S as dt,I as ut,c as pt,g as gt,$ as mt,b as ft,d as wt,y as Tt,s as Ct,e as yt,f as _t,O as Lt,h as xt,A as St}from"./three-extras-DfqxZlMR.js";import"./three-renderer-DqCmgmK_.js";import"./qualityPreference-BRkZdVpy.js";const A=class A{constructor(t,e,i,s){c(this,"manifest",null);c(this,"group",null);c(this,"pendingLow",[]);c(this,"pendingHigh",[]);c(this,"activeLoads",0);c(this,"activeLowLoads",0);c(this,"activeHighLoads",0);c(this,"maxConcurrent",6);c(this,"maxHighWhileLow",2);c(this,"defaultMaxConcurrent",6);c(this,"defaultMaxHighWhileLow",2);c(this,"lastUpdate",0);c(this,"tilesMap",new Map);c(this,"highestLevel",null);c(this,"lowLevel",null);c(this,"lowReadyCount",0);c(this,"lowTotalCount",0);c(this,"lowFullyReady",!1);c(this,"highSeeded",!1);c(this,"tilesVisible",!1);c(this,"tilesLoadedCount",0);c(this,"tilesLoadingCount",0);c(this,"tilesQueuedCount",0);c(this,"tilesFailedCount",0);c(this,"tilesRetryCount",0);c(this,"lastTileUrl","");c(this,"lastError","");c(this,"lruLimit",64);c(this,"highReady",!1);c(this,"fallbackVisible",!1);c(this,"useKtx2",!1);c(this,"ktx2Disabled",!1);c(this,"ktx2FailCount",0);c(this,"prefetchSeeded",!1);c(this,"ktx2Loader",null);this.scene=t,this.renderer=e,this.onFirstDraw=i,this.onHighReady=s}async load(t,e){if(this.manifest=t,this.useKtx2=t.tileFormat==="ktx2",this.ktx2Disabled=!1,this.ktx2FailCount=0,this.prefetchSeeded=!1,this.fallbackVisible=!!(e!=null&&e.fallbackVisible),this.highestLevel=t.levels.reduce((s,r)=>r.z>s.z?r:s),!this.highestLevel)throw new Error("manifest 缺少 level");this.lruLimit=Math.max(64,Math.min(this.highestLevel.cols*this.highestLevel.rows,256));const i=t.levels.filter(s=>s.z<this.highestLevel.z);if(this.lowLevel=i.length?i.reduce((s,r)=>r.z>s.z?r:s):null,this.lowReadyCount=0,this.lowTotalCount=this.lowLevel?this.lowLevel.cols*this.lowLevel.rows:0,this.lowFullyReady=this.lowTotalCount===0,this.highSeeded=!1,this.tilesVisible=!1,this.tilesLoadedCount=0,this.tilesLoadingCount=0,this.tilesQueuedCount=0,this.tilesFailedCount=0,this.tilesRetryCount=0,this.activeLoads=0,this.activeLowLoads=0,this.activeHighLoads=0,this.group&&this.scene.remove(this.group),this.group=new Et,this.group.renderOrder=1,this.scene.add(this.group),!this.fallbackVisible){const s=t.levels.find(r=>r.z===0);if(!s)throw new Error("manifest 缺少 z0");await this.loadSingleTile(s.z,0,0,"low")}this.lowLevel&&this.enqueueLevel(this.lowLevel,"low")}setPerformanceMode(t){t==="throttle"?(this.maxConcurrent=2,this.maxHighWhileLow=0):(this.maxConcurrent=this.defaultMaxConcurrent,this.maxHighWhileLow=this.defaultMaxHighWhileLow)}dispose(){this.tilesMap.forEach(t=>{var e;(e=t.texture)==null||e.dispose(),t.mesh&&(t.mesh.geometry.dispose(),t.mesh.material.dispose())}),this.tilesMap.clear(),this.group&&(this.scene.remove(this.group),this.group=null),this.ktx2Loader&&(this.ktx2Loader.dispose(),this.ktx2Loader=null)}update(t){if(!this.manifest||!this.highestLevel)return;const e=performance.now();if(e-this.lastUpdate<150)return;if(this.lastUpdate=e,(!this.lowLevel||this.lowFullyReady||this.highSeeded)&&this.highestLevel){const o=this.computeNeededTiles(t,this.highestLevel,{marginDeg:10,expandNeighbors:!1});for(const{col:a,row:n,rank:f}of o){const h=`${this.highestLevel.z}_${a}_${n}`;let u=this.tilesMap.get(h);u||(u={z:this.highestLevel.z,col:a,row:n,url:this.buildTileUrl(this.highestLevel.z,a,n,this.useKtx2),state:"empty",priority:"high",lastUsed:e,failCount:0},this.tilesMap.set(h,u)),u.priority="high",u.priorityRank=f,u.lastUsed=e,u.state==="empty"&&!u.retryTimer&&(u.state="loading",this.pendingHigh.push(u))}}const s=Array.from(this.tilesMap.values()).filter(o=>o.state==="loading").length,r=Array.from(this.tilesMap.values()).filter(o=>o.state==="ready").length;if(this.lowLevel&&!this.lowFullyReady){const o=Array.from(this.tilesMap.values()).filter(a=>a.z===this.lowLevel.z&&a.state==="loading").length;this.pendingLow.length===0&&o===0&&(this.lowFullyReady=!0)}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=s,this.tilesLoadedCount=r,this.processQueue(),this.runLru(e)}prime(t){if(!this.manifest||!this.highestLevel)return;t.updateMatrixWorld(!0);const e=performance.now();if(this.highestLevel&&!this.highSeeded){const i=this.computeNeededTiles(t,this.highestLevel,{marginDeg:10,expandNeighbors:!1});if(i.length>0){for(const{col:s,row:r,rank:o}of i){const a=`${this.highestLevel.z}_${s}_${r}`;let n=this.tilesMap.get(a);n||(n={z:this.highestLevel.z,col:s,row:r,url:this.buildTileUrl(this.highestLevel.z,s,r,this.useKtx2),state:"empty",priority:"high",lastUsed:e,failCount:0},this.tilesMap.set(a,n)),n.priority="high",n.priorityRank=o,n.lastUsed=e,n.state==="empty"&&!n.retryTimer&&(n.state="loading",this.pendingHigh.push(n))}this.highSeeded=!0}}this.reprioritizeLowQueue(t),this.seedHighPreload(t),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(i=>i.state==="loading").length,this.processQueue()}getStatus(){var t,e;return{tilesVisible:this.tilesVisible,fallbackVisible:this.fallbackVisible,tilesLoadedCount:this.tilesLoadedCount,tilesLoadingCount:this.tilesLoadingCount,tilesQueuedCount:this.tilesQueuedCount,tilesFailedCount:this.tilesFailedCount,tilesRetryCount:this.tilesRetryCount,lastTileUrl:this.lastTileUrl,lastError:this.lastError,canvasSize:"",canvasScale:1,maxLevel:this.highestLevel?`${this.highestLevel.cols}x${this.highestLevel.rows}`:"",highReady:this.highReady,zMax:((t=this.highestLevel)==null?void 0:t.z)??0,levels:this.manifest?this.manifest.levels.map(i=>i.z).join(","):"",lowReady:this.lowFullyReady,lowLevel:((e=this.lowLevel)==null?void 0:e.z)??""}}enqueueLevel(t,e){const i=performance.now();for(let s=0;s<t.rows;s++)for(let r=0;r<t.cols;r++){const o=`${t.z}_${r}_${s}`;let a=this.tilesMap.get(o);a||(a={z:t.z,col:r,row:s,url:this.buildTileUrl(t.z,r,s,this.useKtx2),state:"empty",priority:e,lastUsed:i,failCount:0},this.tilesMap.set(o,a)),a.priority=e,a.lastUsed=i,a.state==="empty"&&!a.retryTimer&&(a.state="loading",e==="low"?this.pendingLow.push(a):this.pendingHigh.push(a))}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(s=>s.state==="loading").length,this.processQueue()}processQueue(){for(this.sortPendingHighQueue();this.activeLoads<this.maxConcurrent&&(this.pendingLow.length>0||this.pendingHigh.length>0);){const t=this.pendingLow.length>0,i=this.pendingHigh.length>0&&(!t||this.activeHighLoads<this.maxHighWhileLow)?this.pendingHigh.shift():this.pendingLow.shift();this.loadTile(i)}}async loadTile(t){(t.failCount===void 0||t.failCount===null)&&(t.failCount=0),t.priority||(t.priority="high"),this.activeLoads+=1,t.priority==="high"?this.activeHighLoads+=1:this.activeLowLoads+=1,this.lastTileUrl=t.url;try{const e=await this.fetchTileTexture(t);t.texture=e,t.state="ready",t.failCount=0,t.retryTimer&&(clearTimeout(t.retryTimer),t.retryTimer=void 0),this.drawTile(t),this.tilesLoadedCount+=1,this.lowLevel&&t.z===this.lowLevel.z&&(this.lowReadyCount+=1,this.lowReadyCount>=this.lowTotalCount&&(this.lowFullyReady=!0))}catch(e){this.lastError=e instanceof Error?e.message:String(e),t.state="empty",t.failCount+=1,this.tilesFailedCount+=1;const i=Math.min(1e3*Math.pow(2,Math.max(0,t.failCount-1)),15e3);this.scheduleRetry(t,i)}finally{this.activeLoads-=1,t.priority==="high"?this.activeHighLoads=Math.max(0,this.activeHighLoads-1):this.activeLowLoads=Math.max(0,this.activeLowLoads-1),this.processQueue()}}scheduleRetry(t,e){t.retryTimer||(this.tilesRetryCount+=1,t.retryTimer=window.setTimeout(()=>{t.retryTimer=void 0,t.state==="empty"&&(t.priority==="low"?this.pendingLow.push(t):this.pendingHigh.push(t),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.processQueue())},e))}async fetchTileTexture(t){const e=`${this.manifest.baseUrl}/z${t.z}/${t.col}_${t.row}`,i=`${e}.ktx2`,s=`${e}.jpg`;if(this.useKtx2&&!this.ktx2Disabled)try{const o=await this.loadKtx2Texture(i,t.priority);return o.name=i,this.ktx2FailCount=0,o}catch(o){this.recordKtx2Failure(o)}const r=await this.loadJpgTexture(s,t.priority);return r.name=s,r}async loadKtx2Texture(t,e){const i={mode:"cors",cache:"default",referrerPolicy:"no-referrer"};i.priority=e==="high"?"high":"low";const s=await fetch(t,i);if(!s.ok)throw new Error(`tile HTTP ${s.status}: ${t}`);const r=await s.arrayBuffer(),a=await(await this.ensureKtx2Loader())._createTexture(r);return a.flipY=!1,"colorSpace"in a?a.colorSpace=tt:a.encoding=it,a.needsUpdate=!0,a}async ensureKtx2Loader(){if(this.ktx2Loader)return this.ktx2Loader;const{KTX2Loader:t}=await Pt(async()=>{const{KTX2Loader:i}=await Promise.resolve().then(()=>ue);return{KTX2Loader:i}},void 0,import.meta.url),e=new t;return e.setTranscoderPath("/assets/basis/"),e.detectSupport(this.renderer),e.setWorkerLimit(2),this.ktx2Loader=e,e}async loadJpgTexture(t,e){let i=null;try{i=await te(t,{timeoutMs:12e3,priority:e})}catch{i=null}i||(i=await Zt(t,{timeoutMs:12e3,retries:1,allowFetchFallback:!0,priority:e,channel:"tile"}));const s=new vt(i);return s.flipY=!1,s.wrapS=rt,s.wrapT=rt,s.minFilter=V,s.magFilter=V,s.generateMipmaps=!1,"colorSpace"in s?s.colorSpace=tt:s.encoding=it,s.needsUpdate=!0,s}async loadSingleTile(t,e,i,s){const r={z:t,col:e,row:i,url:this.buildTileUrl(t,e,i,this.useKtx2),state:"loading",priority:s,lastUsed:performance.now(),failCount:0};this.tilesMap.set(`${t}_${e}_${i}`,r),await this.loadTile(r)}drawTile(t){if(!this.manifest||!this.group||!t.texture)return;const e=this.manifest.levels.find(o=>o.z===t.z);if(!e)return;const i=this.buildTileGeometry(e,t.col,t.row),s=new At({map:t.texture,depthWrite:!0,depthTest:!0});s.toneMapped=!1;const r=new Bt(i,s);r.renderOrder=t.priority==="high"?3:2,r.frustumCulled=!1,t.mesh=r,this.group.add(r),this.tilesVisible||(this.tilesVisible=!0,this.onFirstDraw()),this.highestLevel&&t.z===this.highestLevel.z&&!this.highReady&&(this.highReady=!0,this.onHighReady()),this.pruneCoveredAncestors(t.z,t.col,t.row)}pruneCoveredAncestors(t,e,i){if(t<=0)return;const s=t-1,r=Math.floor(e/2),o=Math.floor(i/2);if(!this.areDirectChildrenReady(s,r,o))return;const a=`${s}_${r}_${o}`,n=this.tilesMap.get(a);n!=null&&n.mesh&&(this.disposeTileMesh(n),n.mesh=void 0,n.texture=void 0,this.pruneCoveredAncestors(s,r,o))}areDirectChildrenReady(t,e,i){const s=t+1;for(let r=0;r<2;r+=1)for(let o=0;o<2;o+=1){const a=`${s}_${e*2+o}_${i*2+r}`,n=this.tilesMap.get(a);if(!n||n.state!=="ready"||!n.mesh)return!1}return!0}disposeTileMesh(t){var i;if(!t.mesh)return;(i=t.mesh.parent)==null||i.remove(t.mesh),t.mesh.geometry.dispose();const e=t.mesh.material;e.map&&e.map===t.texture&&e.map.dispose(),e.dispose()}buildTileGeometry(t,e,i){const r=Math.PI*2/t.cols,o=Math.PI/t.rows,a=e*r,n=i*o,f=Math.max(4,Math.round(64/t.cols)),h=Math.max(4,Math.round(32/t.rows)),u=new kt(500,f,h,a,r,n,o);u.scale(-1,1,1);const y=u.attributes.uv;let F=1/0,d=-1/0,l=1/0,T=-1/0;for(let g=0;g<y.count;g+=1){const L=y.getX(g),C=y.getY(g);L<F&&(F=L),L>d&&(d=L),C<l&&(l=C),C>T&&(T=C)}const _=d-F||1,m=T-l||1;for(let g=0;g<y.count;g+=1){const L=y.getX(g),C=y.getY(g),x=(L-F)/_,E=(C-l)/m;y.setXY(g,x,1-E)}return y.needsUpdate=!0,u}buildTileUrl(t,e,i,s){const r=s?"ktx2":"jpg";return`${this.manifest.baseUrl}/z${t}/${e}_${i}.${r}`}computeNeededTiles(t,e,i={}){const{yaw:s,pitch:r}=this.getViewAngles(t),o=$.degToRad(t.fov),a=$.degToRad(i.marginDeg??20),n=o/2+a,f=o*t.aspect/2+a,h=this.normAngle(s-f),u=this.normAngle(s+f),y=$.clamp(r-n,-Math.PI/2,Math.PI/2),F=$.clamp(r+n,-Math.PI/2,Math.PI/2),d=this.yawToCols(h,u,e.cols),l=this.yawToCols(s-1e-6,s+1e-6,e.cols)[0]??0;d.includes(l)||d.push(l);const T=Math.max(0,Math.floor((F*-1+Math.PI/2)/Math.PI*e.rows)),_=Math.min(e.rows-1,Math.floor((y*-1+Math.PI/2)/Math.PI*e.rows)),m=[];for(let w=T;w<=_;w++)m.push(w);const g=Math.min(e.rows-1,Math.max(0,Math.floor((-r+Math.PI/2)/Math.PI*e.rows)));m.includes(g)||m.push(g);const L=i.expandNeighbors!==!1,C=[...d];if(L)for(const w of d)C.push(((w+1)%e.cols+e.cols)%e.cols),C.push(((w-1)%e.cols+e.cols)%e.cols);const x=[...m];if(L)for(const w of m)w+1<e.rows&&x.push(w+1),w-1>=0&&x.push(w-1);const E=new Map,K=(w,S)=>{const U=`${w}_${S}`,H=Math.abs(w-l),v=Math.min(H,e.cols-H),I=Math.abs(S-g),P=v*v+I*I,G=E.get(U);(!G||P<G.rank)&&E.set(U,{col:w,row:S,rank:P})};for(const w of C)for(const S of x)K(w,S);return Array.from(E.values()).sort((w,S)=>w.rank!==S.rank?w.rank-S.rank:w.row!==S.row?w.row-S.row:w.col-S.col)}sortPendingHighQueue(){this.pendingHigh.length<2||this.pendingHigh.sort((t,e)=>{const i=t.priorityRank??Number.POSITIVE_INFINITY,s=e.priorityRank??Number.POSITIVE_INFINITY;return i!==s?i-s:e.lastUsed-t.lastUsed})}reprioritizeLowQueue(t){if(!this.lowLevel||this.pendingLow.length<2)return;const e=this.computeNeededTiles(t,this.lowLevel);if(e.length===0)return;const i=new Map;for(const r of e)i.set(`${r.col}_${r.row}`,r.rank);const s=new Map;this.pendingLow.forEach((r,o)=>s.set(r,o)),this.pendingLow.sort((r,o)=>{const a=i.get(`${r.col}_${r.row}`),n=i.get(`${o.col}_${o.row}`),f=a!==void 0,h=n!==void 0;return f&&h&&a!==n?a-n:f&&!h?-1:!f&&h?1:(s.get(r)??0)-(s.get(o)??0)})}seedHighPreload(t){if(this.prefetchSeeded||!this.manifest||!this.highestLevel)return;this.prefetchSeeded=!0;const{yaw:e,pitch:i}=this.getViewAngles(t),s=this.highestLevel,r=Math.PI*2/s.cols,o=Math.PI/s.rows,a=performance.now();for(let n=0;n<s.rows;n++){const f=Math.PI/2-(n+.5)*o,h=Math.abs(f-i);for(let u=0;u<s.cols;u++){const y=(u+.5)*r,F=this.normAngle(Math.PI/2-y),d=this.angularDistance(F,e),T=(d<=Math.PI/2?0:1)*1e6+Math.round(d*1e3)+Math.round(h*10),_=`${s.z}_${u}_${n}`;if(this.tilesMap.has(_))continue;const m={z:s.z,col:u,row:n,url:this.buildTileUrl(s.z,u,n,this.useKtx2&&!this.ktx2Disabled),state:"loading",priority:"high",priorityRank:T,lastUsed:a,failCount:0};this.tilesMap.set(_,m),this.pendingHigh.push(m)}}}recordKtx2Failure(t){const e=t instanceof Error?t.message:String(t);this.lastError=e;const i=e.match(/HTTP\s+(\d+)/i);if(i){const s=Number(i[1]);if(s===404||s===403||s===410)return}this.ktx2FailCount+=1,this.ktx2Disabled||(this.ktx2Disabled=!0,this.useKtx2=!1,this.lastError=`ktx2 disabled: ${e}`)}yawToCols(t,e,i){const s=h=>(h%A.TWO_PI+A.TWO_PI)%A.TWO_PI,r=s(t+Math.PI);let a=s(e+Math.PI)-r;a<0&&(a+=A.TWO_PI);const n=Math.max(i*4,16),f=new Set;for(let h=0;h<=n;h+=1){const u=s(r+a*h/n)-Math.PI,y=s(Math.PI/2-u),F=Math.floor(y/A.TWO_PI*i)%i;f.add((F+i)%i)}return Array.from(f)}normAngle(t){return(t+Math.PI)%(2*Math.PI)-Math.PI}angularDistance(t,e){return Math.abs(this.normAngle(t-e))}getViewAngles(t){const e=new bt;return t.getWorldDirection(e),{yaw:-Math.atan2(e.x,e.z),pitch:Math.asin(e.y)}}runLru(t){var s,r;if(!this.highestLevel)return;const e=Array.from(this.tilesMap.values()).filter(o=>o.z===this.highestLevel.z&&o.state==="ready");if(e.length<=this.lruLimit)return;e.sort((o,a)=>o.lastUsed-a.lastUsed);const i=e.slice(0,e.length-this.lruLimit);for(const o of i)(s=o.texture)==null||s.dispose(),o.mesh&&(o.mesh.geometry.dispose(),o.mesh.material.dispose(),(r=this.group)==null||r.remove(o.mesh)),this.tilesMap.delete(`${o.z}_${o.col}_${o.row}`)}};c(A,"TWO_PI",Math.PI*2);let lt=A;const j=new WeakMap;let Y=0,J;class M extends Ut{constructor(t){super(t),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new ee,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(t){return this.transcoderPath=t,this}setWorkerLimit(t){return this.workerPool.setWorkerLimit(t),this}detectSupport(t){return t.isWebGPURenderer===!0?this.workerConfig={astcSupported:t.hasFeature("texture-compression-astc"),etc1Supported:!1,etc2Supported:t.hasFeature("texture-compression-etc2"),dxtSupported:t.hasFeature("texture-compression-bc"),bptcSupported:!1,pvrtcSupported:!1}:(this.workerConfig={astcSupported:t.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:t.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:t.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:t.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:t.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:t.extensions.has("WEBGL_compressed_texture_pvrtc")||t.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},t.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1)),this}init(){if(!this.transcoderPending){const t=new Q(this.manager);t.setPath(this.transcoderPath),t.setWithCredentials(this.withCredentials);const e=t.loadAsync("basis_transcoder.js"),i=new Q(this.manager);i.setPath(this.transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);const s=i.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([e,s]).then(([r,o])=>{const a=M.BasisWorker.toString(),n=["/* constants */","let _EngineFormat = "+JSON.stringify(M.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(M.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(M.BasisFormat),"/* basis_transcoder.js */",r,"/* worker */",a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([n])),this.transcoderBinary=o,this.workerPool.setWorkerCreator(()=>{const f=new Worker(this.workerSourceURL),h=this.transcoderBinary.slice(0);return f.postMessage({type:"init",config:this.workerConfig,transcoderBinary:h},[h]),f})}),Y>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Y++}return this.transcoderPending}load(t,e,i,s){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const r=new Q(this.manager);r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials),r.load(t,o=>{if(j.has(o))return j.get(o).promise.then(e).catch(s);this._createTexture(o).then(a=>e?e(a):null).catch(s)},i,s)}_createTextureFrom(t,e){const{faces:i,width:s,height:r,format:o,type:a,error:n,dfdFlags:f}=t;if(a==="error")return Promise.reject(n);let h;if(e.faceCount===6)h=new Ht(i,o,R);else{const u=i[0].mipmaps;h=e.layerCount>1?new It(u,s,r,e.layerCount,o,R):new ct(u,s,r,o,R)}return h.minFilter=i[0].mipmaps.length===1?V:Gt,h.magFilter=V,h.generateMipmaps=!1,h.needsUpdate=!0,h.colorSpace=Ft(e),h.premultiplyAlpha=!!(f&se),h}async _createTexture(t,e={}){const i=ie(new Uint8Array(t));if(i.vkFormat!==re)return de(i);const s=e,r=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:t,taskConfig:s},[t])).then(o=>this._createTextureFrom(o.data,i));return j.set(t,{promise:r}),r}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),Y--,this}}M.BasisFormat={ETC1S:0,UASTC_4x4:1};M.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16};M.EngineFormat={RGBAFormat:b,RGBA_ASTC_4x4_Format:qt,RGBA_BPTC_Format:Jt,RGBA_ETC2_EAC_Format:Yt,RGBA_PVRTC_4BPPV1_Format:jt,RGBA_S3TC_DXT5_Format:Qt,RGB_ETC1_Format:Xt,RGB_ETC2_Format:Nt,RGB_PVRTC_4BPPV1_Format:Kt,RGB_S3TC_DXT1_Format:Vt};M.BasisWorker=function(){let p,t,e;const i=_EngineFormat,s=_TranscoderFormat,r=_BasisFormat;self.addEventListener("message",function(d){const l=d.data;switch(l.type){case"init":p=l.config,o(l.transcoderBinary);break;case"transcode":t.then(()=>{try{const{faces:T,buffers:_,width:m,height:g,hasAlpha:L,format:C,dfdFlags:x}=a(l.buffer);self.postMessage({type:"transcode",id:l.id,faces:T,width:m,height:g,hasAlpha:L,format:C,dfdFlags:x},_)}catch(T){console.error(T),self.postMessage({type:"error",id:l.id,error:T.message})}});break}});function o(d){t=new Promise(l=>{e={wasmBinary:d,onRuntimeInitialized:l},BASIS(e)}).then(()=>{e.initializeBasis(),e.KTX2File===void 0&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function a(d){const l=new e.KTX2File(new Uint8Array(d));function T(){l.close(),l.delete()}if(!l.isValid())throw T(),new Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");const _=l.isUASTC()?r.UASTC_4x4:r.ETC1S,m=l.getWidth(),g=l.getHeight(),L=l.getLayers()||1,C=l.getLevels(),x=l.getFaces(),E=l.getHasAlpha(),K=l.getDFDFlags(),{transcoderFormat:w,engineFormat:S}=u(_,m,g,E);if(!m||!g||!C)throw T(),new Error("THREE.KTX2Loader:	Invalid texture");if(!l.startTranscoding())throw T(),new Error("THREE.KTX2Loader: .startTranscoding failed");const U=[],H=[];for(let v=0;v<x;v++){const I=[];for(let P=0;P<C;P++){const G=[];let N,X;for(let B=0;B<L;B++){const k=l.getImageLevelInfo(P,B,v);v===0&&P===0&&B===0&&(k.origWidth%4!==0||k.origHeight%4!==0)&&console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),C>1?(N=k.origWidth,X=k.origHeight):(N=k.width,X=k.height);const st=new Uint8Array(l.getImageTranscodedSizeInBytes(P,B,0,w));if(!l.transcodeImage(st,P,B,v,w,0,-1,-1))throw T(),new Error("THREE.KTX2Loader: .transcodeImage failed.");G.push(st)}const et=F(G);I.push({data:et,width:N,height:X}),H.push(et.buffer)}U.push({mipmaps:I,width:m,height:g,format:S})}return T(),{faces:U,buffers:H,width:m,height:g,hasAlpha:E,format:S,dfdFlags:K}}const n=[{if:"astcSupported",basisFormat:[r.UASTC_4x4],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.BC1,s.BC3],engineFormat:[i.RGB_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.ETC1],engineFormat:[i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],f=n.sort(function(d,l){return d.priorityETC1S-l.priorityETC1S}),h=n.sort(function(d,l){return d.priorityUASTC-l.priorityUASTC});function u(d,l,T,_){let m,g;const L=d===r.ETC1S?f:h;for(let C=0;C<L.length;C++){const x=L[C];if(p[x.if]&&x.basisFormat.includes(d)&&!(_&&x.transcoderFormat.length<2)&&!(x.needsPowerOfTwo&&!(y(l)&&y(T))))return m=x.transcoderFormat[_?1:0],g=x.engineFormat[_?1:0],{transcoderFormat:m,engineFormat:g}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),m=s.RGBA32,g=i.RGBAFormat,{transcoderFormat:m,engineFormat:g}}function y(d){return d<=2?!0:(d&d-1)===0&&d!==0}function F(d){if(d.length===1)return d[0];let l=0;for(let m=0;m<d.length;m++){const g=d[m];l+=g.byteLength}const T=new Uint8Array(l);let _=0;for(let m=0;m<d.length;m++){const g=d[m];T.set(g,_),_+=g.byteLength}return T}};const ce=new Set([b,D,z]),q={[St]:b,[xt]:b,[Lt]:b,[_t]:b,[yt]:D,[Ct]:D,[Tt]:D,[wt]:D,[ft]:z,[mt]:z,[gt]:z,[pt]:z,[ut]:at,[dt]:at},Z={[St]:O,[xt]:W,[Lt]:R,[_t]:R,[yt]:O,[Ct]:W,[Tt]:R,[wt]:R,[ft]:O,[mt]:W,[gt]:R,[pt]:R,[ut]:R,[dt]:R};async function de(p){const{vkFormat:t}=p;if(q[t]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let e;p.supercompressionScheme===ht&&(J||(J=new Promise(async r=>{const o=new he;await o.init(),r(o)})),e=await J);const i=[];for(let r=0;r<p.levels.length;r++){const o=Math.max(1,p.pixelWidth>>r),a=Math.max(1,p.pixelHeight>>r),n=p.pixelDepth?Math.max(1,p.pixelDepth>>r):0,f=p.levels[r];let h;if(p.supercompressionScheme===le)h=f.levelData;else if(p.supercompressionScheme===ht)h=e.decode(f.levelData,f.uncompressedByteLength);else throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");let u;Z[t]===O?u=new Float32Array(h.buffer,h.byteOffset,h.byteLength/Float32Array.BYTES_PER_ELEMENT):Z[t]===W?u=new Uint16Array(h.buffer,h.byteOffset,h.byteLength/Uint16Array.BYTES_PER_ELEMENT):u=h,i.push({data:u,width:o,height:a,depth:n})}let s;if(ce.has(q[t]))s=p.pixelDepth===0?new Wt(i[0].data,p.pixelWidth,p.pixelHeight):new Ot(i[0].data,p.pixelWidth,p.pixelHeight,p.pixelDepth);else{if(p.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");s=new ct(i,p.pixelWidth,p.pixelHeight)}return s.mipmaps=i,s.type=Z[t],s.format=q[t],s.colorSpace=Ft(p),s.needsUpdate=!0,Promise.resolve(s)}function Ft(p){const t=p.dataFormatDescriptor[0];return t.colorPrimaries===oe?t.transferFunction===nt?tt:zt:t.colorPrimaries===ae?t.transferFunction===nt?Dt:$t:t.colorPrimaries===ne?ot:(console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${t.colorPrimaries}"`),ot)}const ue=Object.freeze(Object.defineProperty({__proto__:null,KTX2Loader:M},Symbol.toStringTag,{value:"Module"}));export{lt as TileMeshPano};
