const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BottomDock-ePK9Yx7i.js","./Modal-Cmv3TBkb.js","./index-DnDnySW2.js","./Hotspots-D1eUDWHC.js","./three-math-Bijy4yCX.js","./three-renderer-toiwjbvW.js","./GuideTray-DA1_STCM.js","./externalImage-Cn8sVw7v.js","./SceneGuideDrawer-BtUJ0P7N.js","./chat-community-C6ZbaM52.js","./store-B83L8bDT.js","./PanoViewer-CPb5FQ96.js","./qualityPreference-BRkZdVpy.js","./BrandMark-DZDAGEAL.js","./copyText-CwU0x1sN.js","./StructureView2D--Q7Gxr9k.js","./autoLayout-ZgSeGcPI.js","./vrMode-BaCDoHyb.js","./appModals-BWEJDeQU.js","./editor-debug-Dz10SSgE.js","./draftStorage-Be1LM_rK.js","./dock-panels-CO9QQMe_.js","./sceneGraph-CaQzl5R8.js"])))=>i.map(i=>d[i]);
var Se=Object.defineProperty;var Te=(t,e,i)=>e in t?Se(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var r=(t,e,i)=>Te(t,typeof e!="symbol"?e+"":e,i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function i(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=i(o);fetch(o.href,a)}})();const ye="modulepreload",Pe=function(t,e){return new URL(t,e).href},X={},I=function(e,i,n){let o=Promise.resolve();if(i&&i.length>0){const s=document.getElementsByTagName("link"),u=document.querySelector("meta[property=csp-nonce]"),d=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));o=Promise.allSettled(i.map(h=>{if(h=Pe(h,n),h in X)return;X[h]=!0;const m=h.endsWith(".css"),p=m?'[rel="stylesheet"]':"";if(!!n)for(let v=s.length-1;v>=0;v--){const M=s[v];if(M.href===h&&(!m||M.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${h}"]${p}`))return;const E=document.createElement("link");if(E.rel=m?"stylesheet":ye,m||(E.as="script"),E.crossOrigin="",E.href=h,d&&E.setAttribute("nonce",d),document.head.appendChild(E),m)return new Promise((v,M)=>{E.addEventListener("load",v),E.addEventListener("error",()=>M(new Error(`Unable to preload CSS for ${h}`)))})}))}function a(s){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=s,window.dispatchEvent(u),!u.defaultPrevented)throw s}return o.then(s=>{for(const u of s||[])u.status==="rejected"&&a(u.reason);return e().catch(a)})};var l=(t=>(t.INVALID_ROOT="INVALID_ROOT",t.MISSING_APP_NAME="MISSING_APP_NAME",t.MUSEUMS_NOT_ARRAY="MUSEUMS_NOT_ARRAY",t.MUSEUMS_EMPTY="MUSEUMS_EMPTY",t.MISSING_MUSEUM_ID="MISSING_MUSEUM_ID",t.DUPLICATE_MUSEUM_ID="DUPLICATE_MUSEUM_ID",t.MISSING_MUSEUM_NAME="MISSING_MUSEUM_NAME",t.MISSING_MUSEUM_COVER="MISSING_MUSEUM_COVER",t.MISSING_MUSEUM_MAP="MISSING_MUSEUM_MAP",t.MISSING_MAP_IMAGE="MISSING_MAP_IMAGE",t.INVALID_MAP_WIDTH="INVALID_MAP_WIDTH",t.INVALID_MAP_HEIGHT="INVALID_MAP_HEIGHT",t.SCENES_NOT_ARRAY="SCENES_NOT_ARRAY",t.SCENES_EMPTY="SCENES_EMPTY",t.MISSING_SCENE_ID="MISSING_SCENE_ID",t.DUPLICATE_SCENE_ID="DUPLICATE_SCENE_ID",t.MISSING_SCENE_NAME="MISSING_SCENE_NAME",t.MISSING_PANO="MISSING_PANO",t.INVALID_PANO_URL="INVALID_PANO_URL",t.INVALID_PANOLOW_URL="INVALID_PANOLOW_URL",t.MISSING_THUMB="MISSING_THUMB",t.MISSING_INITIAL_VIEW="MISSING_INITIAL_VIEW",t.INVALID_YAW="INVALID_YAW",t.INVALID_PITCH="INVALID_PITCH",t.INVALID_FOV="INVALID_FOV",t.MISSING_MAP_POINT="MISSING_MAP_POINT",t.INVALID_MAP_POINT_X="INVALID_MAP_POINT_X",t.INVALID_MAP_POINT_Y="INVALID_MAP_POINT_Y",t.HOTSPOTS_NOT_ARRAY="HOTSPOTS_NOT_ARRAY",t.MISSING_HOTSPOT_ID="MISSING_HOTSPOT_ID",t.DUPLICATE_HOTSPOT_ID="DUPLICATE_HOTSPOT_ID",t.INVALID_HOTSPOT_TYPE="INVALID_HOTSPOT_TYPE",t.MISSING_HOTSPOT_LABEL="MISSING_HOTSPOT_LABEL",t.INVALID_HOTSPOT_YAW="INVALID_HOTSPOT_YAW",t.INVALID_HOTSPOT_PITCH="INVALID_HOTSPOT_PITCH",t.MISSING_HOTSPOT_TARGET="MISSING_HOTSPOT_TARGET",t.MISSING_TARGET_MUSEUM_ID="MISSING_TARGET_MUSEUM_ID",t.MISSING_TARGET_SCENE_ID="MISSING_TARGET_SCENE_ID",t.INVALID_TARGET_YAW="INVALID_TARGET_YAW",t.INVALID_TARGET_PITCH="INVALID_TARGET_PITCH",t.INVALID_TARGET_FOV="INVALID_TARGET_FOV",t.MISSING_TARGET_URL="MISSING_TARGET_URL",t))(l||{});function Ne(t){const e=[];if(!t||typeof t!="object")return e.push({code:"INVALID_ROOT",path:"root",message:"é…ç½®å¿…é¡»æ˜¯å¯¹è±¡",fieldName:"é…ç½®æ ¹å¯¹è±¡"}),e;if((!t.appName||typeof t.appName!="string"||t.appName.trim()==="")&&e.push({code:"MISSING_APP_NAME",path:"appName",message:"appName å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",fieldName:"åº”ç”¨åç§°"}),!Array.isArray(t.museums))return e.push({code:"MUSEUMS_NOT_ARRAY",path:"museums",message:"museums å¿…é¡»æ˜¯æ•°ç»„",fieldName:"åšç‰©é¦†åˆ—è¡¨"}),e;t.museums.length===0&&e.push({code:"MUSEUMS_EMPTY",path:"museums",message:"museums æ•°ç»„ä¸èƒ½ä¸ºç©º",fieldName:"åšç‰©é¦†åˆ—è¡¨"});const i=new Set;return t.museums.forEach((n,o)=>{const a=`museums[${o}]`,s=n.name&&typeof n.name=="string"?n.name:void 0;if(!n.id||typeof n.id!="string"||n.id.trim()===""?e.push({code:"MISSING_MUSEUM_ID",path:`${a}.id`,message:"id å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,fieldName:"åšç‰©é¦† ID"}):(i.has(n.id)&&e.push({code:"DUPLICATE_MUSEUM_ID",path:`${a}.id`,message:`åšç‰©é¦† ID "${n.id}" é‡å¤`,museumName:s,fieldName:"åšç‰©é¦† ID"}),i.add(n.id)),(!n.name||typeof n.name!="string"||n.name.trim()==="")&&e.push({code:"MISSING_MUSEUM_NAME",path:`${a}.name`,message:"name å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:void 0,fieldName:"åšç‰©é¦†åç§°"}),(!n.cover||typeof n.cover!="string"||n.cover.trim()==="")&&e.push({code:"MISSING_MUSEUM_COVER",path:`${a}.cover`,message:"cover å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,fieldName:"å°é¢å›¾"}),!n.map||typeof n.map!="object"?e.push({code:"MISSING_MUSEUM_MAP",path:`${a}.map`,message:"map å¿…é¡»æ˜¯å¯¹è±¡",museumName:s,fieldName:"åœ°å›¾é…ç½®"}):((!n.map.image||typeof n.map.image!="string"||n.map.image.trim()==="")&&e.push({code:"MISSING_MAP_IMAGE",path:`${a}.map.image`,message:"map.image å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,fieldName:"åœ°å›¾å›¾ç‰‡"}),(typeof n.map.width!="number"||n.map.width<=0)&&e.push({code:"INVALID_MAP_WIDTH",path:`${a}.map.width`,message:"map.width å¿…é¡»æ˜¯å¤§äº 0 çš„æ•°å­—",museumName:s,fieldName:"åœ°å›¾å®½åº¦"}),(typeof n.map.height!="number"||n.map.height<=0)&&e.push({code:"INVALID_MAP_HEIGHT",path:`${a}.map.height`,message:"map.height å¿…é¡»æ˜¯å¤§äº 0 çš„æ•°å­—",museumName:s,fieldName:"åœ°å›¾é«˜åº¦"})),!Array.isArray(n.scenes))e.push({code:"SCENES_NOT_ARRAY",path:`${a}.scenes`,message:"scenes å¿…é¡»æ˜¯æ•°ç»„",museumName:s,fieldName:"åœºæ™¯åˆ—è¡¨"});else{n.scenes.length===0&&e.push({code:"SCENES_EMPTY",path:`${a}.scenes`,message:"scenes æ•°ç»„ä¸èƒ½ä¸ºç©º",museumName:s,fieldName:"åœºæ™¯åˆ—è¡¨"});const u=new Set;n.scenes.forEach((d,h)=>{var M;const m=`${a}.scenes[${h}]`,p=d.name&&typeof d.name=="string"?d.name:void 0;!d.id||typeof d.id!="string"||d.id.trim()===""?e.push({code:"MISSING_SCENE_ID",path:`${m}.id`,message:"id å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"åœºæ™¯ ID"}):(u.has(d.id)&&e.push({code:"DUPLICATE_SCENE_ID",path:`${m}.id`,message:`åœºæ™¯ ID "${d.id}" åœ¨åšç‰©é¦†å†…é‡å¤`,museumName:s,sceneName:p,fieldName:"åœºæ™¯ ID"}),u.add(d.id)),(!d.name||typeof d.name!="string"||d.name.trim()==="")&&e.push({code:"MISSING_SCENE_NAME",path:`${m}.name`,message:"name å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:void 0,fieldName:"åœºæ™¯åç§°"});const G=!!d.pano,E=!!d.panoLow,v=!!((M=d.panoTiles)!=null&&M.manifest);if(!G&&!E&&!v?e.push({code:"MISSING_PANO",path:`${m}.pano`,message:"pano / panoLow / panoTiles è‡³å°‘éœ€è¦æä¾›ä¸€ä¸ª",museumName:s,sceneName:p,fieldName:"å…¨æ™¯å›¾"}):(d.pano&&(typeof d.pano!="string"||d.pano.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${m}.pano`,message:"pano å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"é«˜æ¸…å…¨æ™¯å›¾"}),d.panoLow&&(typeof d.panoLow!="string"||d.panoLow.trim()==="")&&e.push({code:"INVALID_PANOLOW_URL",path:`${m}.panoLow`,message:"panoLow å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"ä½æ¸…å…¨æ™¯å›¾"}),d.panoTiles&&(typeof d.panoTiles!="object"?e.push({code:"INVALID_PANO_URL",path:`${m}.panoTiles`,message:"panoTiles å¿…é¡»æ˜¯å¯¹è±¡ï¼ŒåŒ…å« manifest",museumName:s,sceneName:p,fieldName:"ç“¦ç‰‡å…ƒæ•°æ®"}):(!d.panoTiles.manifest||typeof d.panoTiles.manifest!="string"||d.panoTiles.manifest.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${m}.panoTiles.manifest`,message:"panoTiles.manifest å¿…é¡»æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"ç“¦ç‰‡ manifest"}))),(!d.thumb||typeof d.thumb!="string"||d.thumb.trim()==="")&&e.push({code:"MISSING_THUMB",path:`${m}.thumb`,message:"thumb å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"ç¼©ç•¥å›¾"}),!d.initialView||typeof d.initialView!="object"?e.push({code:"MISSING_INITIAL_VIEW",path:`${m}.initialView`,message:"initialView å¿…é¡»æ˜¯å¯¹è±¡",museumName:s,sceneName:p,fieldName:"åˆå§‹è§†è§’"}):(typeof d.initialView.yaw!="number"&&e.push({code:"INVALID_YAW",path:`${m}.initialView.yaw`,message:"initialView.yaw å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"æ°´å¹³è§’åº¦"}),typeof d.initialView.pitch!="number"&&e.push({code:"INVALID_PITCH",path:`${m}.initialView.pitch`,message:"initialView.pitch å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"å‚ç›´è§’åº¦"}),d.initialView.fov!==void 0&&typeof d.initialView.fov!="number"&&e.push({code:"INVALID_FOV",path:`${m}.initialView.fov`,message:"initialView.fov å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"è§†é‡è§’åº¦"})),!d.mapPoint||typeof d.mapPoint!="object"?e.push({code:"MISSING_MAP_POINT",path:`${m}.mapPoint`,message:"mapPoint å¿…é¡»æ˜¯å¯¹è±¡",museumName:s,sceneName:p,fieldName:"åœ°å›¾ç‚¹ä½"}):(typeof d.mapPoint.x!="number"&&e.push({code:"INVALID_MAP_POINT_X",path:`${m}.mapPoint.x`,message:"mapPoint.x å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"åœ°å›¾ç‚¹ä½ X åæ ‡"}),typeof d.mapPoint.y!="number"&&e.push({code:"INVALID_MAP_POINT_Y",path:`${m}.mapPoint.y`,message:"mapPoint.y å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"åœ°å›¾ç‚¹ä½ Y åæ ‡"})),!Array.isArray(d.hotspots))e.push({code:"HOTSPOTS_NOT_ARRAY",path:`${m}.hotspots`,message:"hotspots å¿…é¡»æ˜¯æ•°ç»„",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹åˆ—è¡¨"});else{const U=new Set;d.hotspots.forEach((c,g)=>{const f=`${m}.hotspots[${g}]`;!c.id||typeof c.id!="string"||c.id.trim()===""?e.push({code:"MISSING_HOTSPOT_ID",path:`${f}.id`,message:"id å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ ID"}):(U.has(c.id)&&e.push({code:"DUPLICATE_HOTSPOT_ID",path:`${f}.id`,message:`çƒ­ç‚¹ ID "${c.id}" åœ¨åœºæ™¯å†…é‡å¤`,museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ ID"}),U.add(c.id)),c.type!=="scene"&&c.type!=="video"&&c.type!=="image"&&c.type!=="info"&&e.push({code:"INVALID_HOTSPOT_TYPE",path:`${f}.type`,message:'type å¿…é¡»æ˜¯ "scene"ã€"video"ã€"image" æˆ– "info"',museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ç±»å‹"}),(!c.label||typeof c.label!="string"||c.label.trim()==="")&&e.push({code:"MISSING_HOTSPOT_LABEL",path:`${f}.label`,message:"label å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹æ ‡ç­¾"}),typeof c.yaw!="number"&&e.push({code:"INVALID_HOTSPOT_YAW",path:`${f}.yaw`,message:"yaw å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹æ°´å¹³è§’åº¦"}),typeof c.pitch!="number"&&e.push({code:"INVALID_HOTSPOT_PITCH",path:`${f}.pitch`,message:"pitch å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹å‚ç›´è§’åº¦"}),c.type==="scene"?!c.target||typeof c.target!="object"?e.push({code:"MISSING_HOTSPOT_TARGET",path:`${f}.target`,message:"scene ç±»å‹çƒ­ç‚¹å¿…é¡»æä¾› target å¯¹è±¡",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ç›®æ ‡é…ç½®"}):((!c.target.museumId||typeof c.target.museumId!="string")&&e.push({code:"MISSING_TARGET_MUSEUM_ID",path:`${f}.target.museumId`,message:"scene ç±»å‹çƒ­ç‚¹çš„ target.museumId å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"ç›®æ ‡åšç‰©é¦† ID"}),typeof c.target.sceneId!="string"&&e.push({code:"MISSING_TARGET_SCENE_ID",path:`${f}.target.sceneId`,message:"scene ç±»å‹çƒ­ç‚¹çš„ target.sceneId å¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼ˆå…è®¸ç©ºå­—ç¬¦ä¸²ï¼Œç”¨æˆ·åç»­è¡¥å…¨ï¼‰",museumName:s,sceneName:p,fieldName:"ç›®æ ‡åœºæ™¯ ID"}),c.target.yaw!==void 0&&typeof c.target.yaw!="number"&&e.push({code:"INVALID_TARGET_YAW",path:`${f}.target.yaw`,message:"target.yaw å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"ç›®æ ‡æ°´å¹³è§’åº¦"}),c.target.pitch!==void 0&&typeof c.target.pitch!="number"&&e.push({code:"INVALID_TARGET_PITCH",path:`${f}.target.pitch`,message:"target.pitch å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"ç›®æ ‡å‚ç›´è§’åº¦"}),c.target.fov!==void 0&&typeof c.target.fov!="number"&&e.push({code:"INVALID_TARGET_FOV",path:`${f}.target.fov`,message:"target.fov å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"ç›®æ ‡è§†é‡è§’åº¦"})):c.type==="video"&&c.target&&typeof c.target!="object"&&e.push({code:"MISSING_HOTSPOT_TARGET",path:`${f}.target`,message:"video ç±»å‹çƒ­ç‚¹çš„ target å¿…é¡»æ˜¯å¯¹è±¡ï¼ˆå¦‚æœæä¾›ï¼‰",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ç›®æ ‡é…ç½®"})})}})}}),e}let D=null;async function K(){if(D)return D;try{const t=await fetch("./config.json",{cache:"no-store"});if(!t.ok)throw new Error(`åŠ è½½é…ç½®å¤±è´¥: ${t.status}`);const e=await t.json(),i=Ne(e);if(i.length>0){const n=new Error("é…ç½®æ ¡éªŒå¤±è´¥");throw n.validationErrors=i,n}return D=e,D}catch(t){throw console.error("åŠ è½½é…ç½®å¤±è´¥:",t),t}}function Q(){D=null}function F(t){if(D)return D.museums.find(e=>e.id===t)}function be(t,e){const i=F(t);if(i)return i.scenes.find(n=>n.id===e)}function de(t){const e=new URL(window.location.href);return e.search="",Object.entries(t).forEach(([i,n])=>{n!=null&&n!==""&&e.searchParams.set(i,String(n))}),e.pathname+e.search+e.hash}function Ae(){return window.location.pathname}function De(){if(window.location.pathname.includes("//")){const t=window.location.pathname.replace(/\/{2,}/g,"/");history.replaceState({},"",t+window.location.search+window.location.hash)}}let J=null,Z=0;const Le=200;function Ve(t){if(t.type==="focus"){const e=`${t.museumId}:${t.sceneId}`,i=Date.now();if(e===J&&i-Z<Le)return;J=e,Z=i}window.dispatchEvent(new CustomEvent("vr:scene-focus",{detail:t}))}function Dt(t){const e=i=>{t(i.detail)};return window.addEventListener("vr:scene-focus",e),()=>{window.removeEventListener("vr:scene-focus",e)}}function ee(){const t=new URLSearchParams(window.location.search),e=t.get("yaw"),i=t.get("pitch"),n=t.get("fov");return{museumId:t.get("museum")||void 0,sceneId:t.get("scene")||void 0,yaw:e?parseFloat(e):void 0,pitch:i?parseFloat(i):void 0,fov:n?parseFloat(n):void 0}}function Oe(){return new URLSearchParams(window.location.search).get("debug")==="1"}function Ce(){const t=new URLSearchParams(window.location.search);return t.get("editor")==="1"||t.get("debug")==="1"}function te(){const t=Ae();window.history.pushState({},"",t),window.dispatchEvent(new Event("popstate"))}function ie(t){const e=de({museum:t});window.history.pushState({},"",e),window.dispatchEvent(new Event("popstate"))}function k(t,e,i){const n=de({museum:t,scene:e,yaw:i==null?void 0:i.yaw,pitch:i==null?void 0:i.pitch,fov:i==null?void 0:i.fov});window.history.pushState({},"",n),Ve({type:"focus",museumId:t,sceneId:e,source:"dock",ts:Date.now()}),window.dispatchEvent(new Event("popstate"))}function q(){const t=document;return!!(document.fullscreenElement||t.webkitFullscreenElement)}function Re(){const t=()=>{};document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t)}class Ue{constructor(){r(this,"element");this.element=document.createElement("div"),this.element.className="loading-overlay",this.render(),this.applyStyles();const e=()=>{q()&&this.hide()};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}render(){this.element.innerHTML=`
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">åŠ è½½ä¸­...</p>
      </div>
    `}applyStyles(){const e=document.createElement("style");e.textContent=`
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .loading-overlay.show {
        opacity: 1;
        pointer-events: all;
      }
      .loading-spinner {
        text-align: center;
        color: #fff;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }
      .loading-text {
        font-size: 14px;
        margin: 0;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    `,document.head.appendChild(e)}show(){q()||this.element.classList.add("show")}hide(){this.element.classList.remove("show")}getElement(){return this.element}remove(){this.element.remove()}}const xe={[l.INVALID_ROOT]:"é…ç½®æ ¼å¼é”™è¯¯",[l.MISSING_APP_NAME]:"ç¼ºå°‘åº”ç”¨åç§°",[l.MUSEUMS_NOT_ARRAY]:"åšç‰©é¦†åˆ—è¡¨æ ¼å¼é”™è¯¯",[l.MUSEUMS_EMPTY]:"åšç‰©é¦†åˆ—è¡¨ä¸ºç©º",[l.MISSING_MUSEUM_ID]:"ç¼ºå°‘åšç‰©é¦† ID",[l.DUPLICATE_MUSEUM_ID]:"åšç‰©é¦† ID é‡å¤",[l.MISSING_MUSEUM_NAME]:"ç¼ºå°‘åšç‰©é¦†åç§°",[l.MISSING_MUSEUM_COVER]:"ç¼ºå°‘å°é¢å›¾",[l.MISSING_MUSEUM_MAP]:"ç¼ºå°‘åœ°å›¾é…ç½®",[l.MISSING_MAP_IMAGE]:"ç¼ºå°‘åœ°å›¾å›¾ç‰‡",[l.INVALID_MAP_WIDTH]:"åœ°å›¾å®½åº¦æ— æ•ˆ",[l.INVALID_MAP_HEIGHT]:"åœ°å›¾é«˜åº¦æ— æ•ˆ",[l.SCENES_NOT_ARRAY]:"åœºæ™¯åˆ—è¡¨æ ¼å¼é”™è¯¯",[l.SCENES_EMPTY]:"åœºæ™¯åˆ—è¡¨ä¸ºç©º",[l.MISSING_SCENE_ID]:"ç¼ºå°‘åœºæ™¯ ID",[l.DUPLICATE_SCENE_ID]:"åœºæ™¯ ID é‡å¤",[l.MISSING_SCENE_NAME]:"ç¼ºå°‘åœºæ™¯åç§°",[l.MISSING_PANO]:"ç¼ºå°‘å…¨æ™¯å›¾",[l.INVALID_PANO_URL]:"é«˜æ¸…å…¨æ™¯å›¾ URL æ— æ•ˆ",[l.INVALID_PANOLOW_URL]:"ä½æ¸…å…¨æ™¯å›¾ URL æ— æ•ˆ",[l.MISSING_THUMB]:"ç¼ºå°‘ç¼©ç•¥å›¾",[l.MISSING_INITIAL_VIEW]:"ç¼ºå°‘åˆå§‹è§†è§’é…ç½®",[l.INVALID_YAW]:"æ°´å¹³è§’åº¦æ— æ•ˆ",[l.INVALID_PITCH]:"å‚ç›´è§’åº¦æ— æ•ˆ",[l.INVALID_FOV]:"è§†é‡è§’åº¦æ— æ•ˆ",[l.MISSING_MAP_POINT]:"ç¼ºå°‘åœ°å›¾ç‚¹ä½",[l.INVALID_MAP_POINT_X]:"åœ°å›¾ç‚¹ä½ X åæ ‡æ— æ•ˆ",[l.INVALID_MAP_POINT_Y]:"åœ°å›¾ç‚¹ä½ Y åæ ‡æ— æ•ˆ",[l.HOTSPOTS_NOT_ARRAY]:"çƒ­ç‚¹åˆ—è¡¨æ ¼å¼é”™è¯¯",[l.MISSING_HOTSPOT_ID]:"ç¼ºå°‘çƒ­ç‚¹ ID",[l.DUPLICATE_HOTSPOT_ID]:"çƒ­ç‚¹ ID é‡å¤",[l.INVALID_HOTSPOT_TYPE]:"çƒ­ç‚¹ç±»å‹æ— æ•ˆ",[l.MISSING_HOTSPOT_LABEL]:"ç¼ºå°‘çƒ­ç‚¹æ ‡ç­¾",[l.INVALID_HOTSPOT_YAW]:"çƒ­ç‚¹æ°´å¹³è§’åº¦æ— æ•ˆ",[l.INVALID_HOTSPOT_PITCH]:"çƒ­ç‚¹å‚ç›´è§’åº¦æ— æ•ˆ",[l.MISSING_HOTSPOT_TARGET]:"ç¼ºå°‘çƒ­ç‚¹ç›®æ ‡é…ç½®",[l.MISSING_TARGET_MUSEUM_ID]:"ç¼ºå°‘ç›®æ ‡åšç‰©é¦† ID",[l.MISSING_TARGET_SCENE_ID]:"ç¼ºå°‘ç›®æ ‡åœºæ™¯ ID",[l.INVALID_TARGET_YAW]:"ç›®æ ‡æ°´å¹³è§’åº¦æ— æ•ˆ",[l.INVALID_TARGET_PITCH]:"ç›®æ ‡å‚ç›´è§’åº¦æ— æ•ˆ",[l.INVALID_TARGET_FOV]:"ç›®æ ‡è§†é‡è§’åº¦æ— æ•ˆ",[l.MISSING_TARGET_URL]:"ç¼ºå°‘è§†é¢‘é“¾æ¥"},Ge={[l.INVALID_ROOT]:"è¯·ç¡®ä¿ config.json æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSON å¯¹è±¡",[l.MISSING_APP_NAME]:'è¯·åœ¨é…ç½®ä¸­æ·»åŠ  "appName" å­—æ®µï¼Œä¾‹å¦‚ï¼š"appName": "æˆ‘çš„ VR å±•é¦†"',[l.MUSEUMS_NOT_ARRAY]:'è¯·ç¡®ä¿ "museums" æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¾‹å¦‚ï¼š"museums": []',[l.MUSEUMS_EMPTY]:'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåšç‰©é¦†åˆ° "museums" æ•°ç»„ä¸­',[l.MISSING_MUSEUM_ID]:'è¯·ä¸ºè¯¥åšç‰©é¦†æ·»åŠ  "id" å­—æ®µï¼Œä¾‹å¦‚ï¼š"id": "museum1"',[l.DUPLICATE_MUSEUM_ID]:'è¯·ç¡®ä¿æ¯ä¸ªåšç‰©é¦†çš„ "id" éƒ½æ˜¯å”¯ä¸€çš„ï¼Œä¸èƒ½é‡å¤',[l.MISSING_MUSEUM_NAME]:'è¯·ä¸ºè¯¥åšç‰©é¦†æ·»åŠ  "name" å­—æ®µï¼Œä¾‹å¦‚ï¼š"name": "ç¬¬ä¸€å±•é¦†"',[l.MISSING_MUSEUM_COVER]:'è¯·ä¸ºè¯¥åšç‰©é¦†æ·»åŠ  "cover" å­—æ®µï¼Œå¡«å…¥å°é¢å›¾çš„ URL',[l.MISSING_MUSEUM_MAP]:'è¯·ä¸ºè¯¥åšç‰©é¦†æ·»åŠ  "map" å¯¹è±¡é…ç½®',[l.MISSING_MAP_IMAGE]:'è¯·åœ¨åœ°å›¾é…ç½®ä¸­æ·»åŠ  "image" å­—æ®µï¼Œå¡«å…¥åœ°å›¾å›¾ç‰‡çš„ URL',[l.INVALID_MAP_WIDTH]:'è¯·ç¡®ä¿ "map.width" æ˜¯ä¸€ä¸ªå¤§äº 0 çš„æ•°å­—',[l.INVALID_MAP_HEIGHT]:'è¯·ç¡®ä¿ "map.height" æ˜¯ä¸€ä¸ªå¤§äº 0 çš„æ•°å­—',[l.SCENES_NOT_ARRAY]:'è¯·ç¡®ä¿ "scenes" æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¾‹å¦‚ï¼š"scenes": []',[l.SCENES_EMPTY]:"è¯·è‡³å°‘ä¸ºè¯¥åšç‰©é¦†æ·»åŠ ä¸€ä¸ªåœºæ™¯",[l.MISSING_SCENE_ID]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "id" å­—æ®µï¼Œä¾‹å¦‚ï¼š"id": "scene1"',[l.DUPLICATE_SCENE_ID]:'è¯·ç¡®ä¿åŒä¸€åšç‰©é¦†å†…æ¯ä¸ªåœºæ™¯çš„ "id" éƒ½æ˜¯å”¯ä¸€çš„',[l.MISSING_SCENE_NAME]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "name" å­—æ®µï¼Œä¾‹å¦‚ï¼š"name": "æ­£é—¨"',[l.MISSING_PANO]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "pano"ã€"panoLow" æˆ– "panoTiles" å­—æ®µï¼Œè‡³å°‘æä¾›ä¸€ç§å…¨æ™¯æ¥æº',[l.INVALID_PANO_URL]:'è¯·ç¡®ä¿ "pano" å­—æ®µæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡ URL å­—ç¬¦ä¸²',[l.INVALID_PANOLOW_URL]:'è¯·ç¡®ä¿ "panoLow" å­—æ®µæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡ URL å­—ç¬¦ä¸²',[l.MISSING_THUMB]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "thumb" å­—æ®µï¼Œå¡«å…¥ç¼©ç•¥å›¾çš„ URL',[l.MISSING_INITIAL_VIEW]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "initialView" å¯¹è±¡é…ç½®',[l.INVALID_YAW]:'è¯·ç¡®ä¿ "initialView.yaw" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆæ°´å¹³è§’åº¦ï¼ŒèŒƒå›´ -180 åˆ° 180ï¼‰',[l.INVALID_PITCH]:'è¯·ç¡®ä¿ "initialView.pitch" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆå‚ç›´è§’åº¦ï¼ŒèŒƒå›´ -90 åˆ° 90ï¼‰',[l.INVALID_FOV]:'è¯·ç¡®ä¿ "initialView.fov" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆè§†é‡è§’åº¦ï¼ŒèŒƒå›´ 30 åˆ° 120ï¼‰',[l.MISSING_MAP_POINT]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "mapPoint" å¯¹è±¡é…ç½®',[l.INVALID_MAP_POINT_X]:'è¯·ç¡®ä¿ "mapPoint.x" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆåœ°å›¾ä¸Šçš„ X åæ ‡ï¼‰',[l.INVALID_MAP_POINT_Y]:'è¯·ç¡®ä¿ "mapPoint.y" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆåœ°å›¾ä¸Šçš„ Y åæ ‡ï¼‰',[l.HOTSPOTS_NOT_ARRAY]:'è¯·ç¡®ä¿ "hotspots" æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¾‹å¦‚ï¼š"hotspots": []',[l.MISSING_HOTSPOT_ID]:'è¯·ä¸ºè¯¥çƒ­ç‚¹æ·»åŠ  "id" å­—æ®µï¼Œä¾‹å¦‚ï¼š"id": "hotspot1"',[l.DUPLICATE_HOTSPOT_ID]:'è¯·ç¡®ä¿åŒä¸€åœºæ™¯å†…æ¯ä¸ªçƒ­ç‚¹çš„ "id" éƒ½æ˜¯å”¯ä¸€çš„',[l.INVALID_HOTSPOT_TYPE]:'è¯·ç¡®ä¿ "type" å­—æ®µæ˜¯ "scene" æˆ– "video" ä¹‹ä¸€',[l.MISSING_HOTSPOT_LABEL]:'è¯·ä¸ºè¯¥çƒ­ç‚¹æ·»åŠ  "label" å­—æ®µï¼Œä¾‹å¦‚ï¼š"label": "è¿›å…¥å±•å…"',[l.INVALID_HOTSPOT_YAW]:'è¯·ç¡®ä¿ "yaw" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆçƒ­ç‚¹åœ¨å…¨æ™¯å›¾ä¸­çš„æ°´å¹³ä½ç½®ï¼‰',[l.INVALID_HOTSPOT_PITCH]:'è¯·ç¡®ä¿ "pitch" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆçƒ­ç‚¹åœ¨å…¨æ™¯å›¾ä¸­çš„å‚ç›´ä½ç½®ï¼‰',[l.MISSING_HOTSPOT_TARGET]:'è¯·ä¸ºè¯¥çƒ­ç‚¹æ·»åŠ  "target" å¯¹è±¡é…ç½®',[l.MISSING_TARGET_MUSEUM_ID]:'åœºæ™¯è·³è½¬ç±»å‹çš„çƒ­ç‚¹å¿…é¡»åŒ…å« "target.museumId" å­—æ®µ',[l.MISSING_TARGET_SCENE_ID]:'åœºæ™¯è·³è½¬ç±»å‹çš„çƒ­ç‚¹å¿…é¡»åŒ…å« "target.sceneId" å­—æ®µ',[l.INVALID_TARGET_YAW]:'è¯·ç¡®ä¿ "target.yaw" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆè·³è½¬åçš„æ°´å¹³è§’åº¦ï¼‰',[l.INVALID_TARGET_PITCH]:'è¯·ç¡®ä¿ "target.pitch" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆè·³è½¬åçš„å‚ç›´è§’åº¦ï¼‰',[l.INVALID_TARGET_FOV]:'è¯·ç¡®ä¿ "target.fov" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆè·³è½¬åçš„è§†é‡è§’åº¦ï¼‰',[l.MISSING_TARGET_URL]:'è§†é¢‘ç±»å‹çš„çƒ­ç‚¹å¿…é¡»åŒ…å« "target.url" å­—æ®µï¼Œå¡«å…¥è§†é¢‘çš„ URL'};class ke{constructor(e,i,n){r(this,"element");this.element=document.createElement("div"),this.element.className="config-error-panel",this.render(e,i,n),this.applyStyles()}render(e,i,n){this.element.innerHTML=`
      <div class="error-panel-content">
        <div class="error-panel-header">
          <h2>âš ï¸ é…ç½®é”™è¯¯</h2>
          <p class="error-summary">å‘ç° ${e.length} ä¸ªé…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥ config.json</p>
        </div>
        <div class="error-list">
          ${e.map((s,u)=>this.renderErrorCard(s,u)).join("")}
        </div>
        <div class="error-actions">
          <button class="btn btn-primary" id="retry-btn">ğŸ”„ åˆ·æ–°é‡è¯•</button>
          <button class="btn btn-secondary" id="example-btn">ğŸ“– æŸ¥çœ‹ç¤ºä¾‹é…ç½®</button>
        </div>
      </div>
    `;const o=this.element.querySelector("#retry-btn"),a=this.element.querySelector("#example-btn");o&&o.addEventListener("click",i),a&&a.addEventListener("click",n)}renderErrorCard(e,i){const n=xe[e.code]||"é…ç½®é”™è¯¯",o=Ge[e.code]||"è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶çš„æ ¼å¼å’Œå†…å®¹",a=[];e.museumName&&a.push(`é¦†ï¼š${e.museumName}`),e.sceneName&&a.push(`åœºæ™¯ï¼š${e.sceneName}`);const s=a.length>0?a.join(" / "):"å…¨å±€é…ç½®";return`
      <div class="error-card">
        <div class="error-card-header">
          <span class="error-icon">âŒ</span>
          <span class="error-title">${this.escapeHtml(n)}</span>
        </div>
        <div class="error-card-body">
          <div class="error-location">
            <span class="location-icon">ğŸ“</span>
            <span class="location-text">${this.escapeHtml(s)}</span>
          </div>
          ${e.fieldName?`
            <div class="error-field">
              <span class="field-label">å­—æ®µï¼š</span>
              <span class="field-name">${this.escapeHtml(e.fieldName)}</span>
            </div>
          `:""}
          <div class="error-path">
            <span class="path-label">æŠ€æœ¯è·¯å¾„ï¼š</span>
            <code class="path-code">${this.escapeHtml(e.path)}</code>
          </div>
          <div class="error-hint">
            <span class="hint-icon">ğŸ’¡</span>
            <span class="hint-text">${this.escapeHtml(o)}</span>
          </div>
        </div>
      </div>
    `}escapeHtml(e){const i=document.createElement("div");return i.textContent=e,i.innerHTML}applyStyles(){const e=document.createElement("style");e.textContent=`
      .config-error-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      }
      .error-panel-content {
        max-width: 800px;
        width: 100%;
        background: #1a1a1a;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      .error-panel-header {
        margin-bottom: 24px;
        text-align: center;
      }
      .error-panel-header h2 {
        font-size: 24px;
        color: #ff6b6b;
        margin-bottom: 8px;
      }
      .error-summary {
        color: #ccc;
        font-size: 14px;
      }
      .error-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 24px;
        background: #0f0f0f;
        border-radius: 8px;
        padding: 16px;
      }
      .error-card {
        padding: 16px;
        margin-bottom: 12px;
        background: #252525;
        border-left: 4px solid #ff6b6b;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .error-card:hover {
        background: #2a2a2a;
      }
      .error-card:last-child {
        margin-bottom: 0;
      }
      .error-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .error-icon {
        font-size: 20px;
      }
      .error-title {
        font-size: 16px;
        font-weight: 600;
        color: #ff6b6b;
      }
      .error-card-body {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .error-location {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #4a90e2;
      }
      .location-icon {
        font-size: 14px;
      }
      .location-text {
        font-weight: 500;
      }
      .error-field {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #ccc;
      }
      .field-label {
        color: #999;
      }
      .field-name {
        color: #ffd93d;
        font-weight: 500;
      }
      .error-path {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        font-size: 12px;
        color: #999;
        margin-top: 4px;
      }
      .path-label {
        color: #666;
        white-space: nowrap;
      }
      .path-code {
        font-family: 'Courier New', monospace;
        color: #888;
        word-break: break-all;
        background: #1a1a1a;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
      }
      .error-hint {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 8px;
        padding: 10px;
        background: #1a1a1a;
        border-radius: 6px;
        border-left: 3px solid #4a90e2;
      }
      .hint-icon {
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 2px;
      }
      .hint-text {
        font-size: 13px;
        color: #ccc;
        line-height: 1.5;
      }
      .error-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }
      .btn-primary {
        background: #4a90e2;
        color: #fff;
      }
      .btn-primary:hover {
        background: #357abd;
      }
      .btn-primary:active {
        transform: scale(0.98);
      }
      .btn-secondary {
        background: #555;
        color: #fff;
      }
      .btn-secondary:hover {
        background: #666;
      }
      .btn-secondary:active {
        transform: scale(0.98);
      }
      @media (max-width: 600px) {
        .error-panel-content {
          padding: 16px;
        }
        .error-actions {
          flex-direction: column;
        }
        .btn {
          width: 100%;
        }
      }
    `,document.head.appendChild(e)}getElement(){return this.element}remove(){this.element.remove()}}var _=(t=>(t.LOADING_LOW="loadingLow",t.LOW_READY="lowReady",t.LOADING_HIGH="loadingHigh",t.HIGH_READY="highReady",t.DEGRADED="degraded",t.ERROR="error",t))(_||{}),ce=(t=>(t.THUMB="thumb",t.PANO_LOW="panoLow",t.PANO="pano",t.VIDEO="video",t.COVER="cover",t.MAP="map",t.DOLLHOUSE="dollhouse",t))(ce||{});const He=["/assets/panos/"],Be=[],$e="/config.json",Ye=1e3,x="vrplayer.assetCdn.lastSuccess",Fe=12*60*60*1e3;let R=null,L=null,y="idle",b=0;function qe(t){const e=t.trim();return e?e.startsWith("/")?e:`/${e}`:""}function ne(t,e){const i=Array.isArray(t)&&t.length>0?t:e,n=new Set;for(const o of i){if(typeof o!="string")continue;const a=qe(o);a&&n.add(a)}return Array.from(n)}function ue(t){return t.replace(/\/+$/,"")}function We(t){const e=[];Array.isArray(t.baseUrls)&&e.push(...t.baseUrls),typeof t.baseUrl=="string"&&e.push(t.baseUrl);const i=new Set;for(const n of e){if(typeof n!="string")continue;const o=ue(n.trim());o&&i.add(o)}return Array.from(i)}function ze(){var t;return typeof window<"u"&&((t=window.location)!=null&&t.origin)?window.location.origin:typeof location<"u"&&location.origin?location.origin:null}function z(){if(typeof window>"u")return null;try{return window.localStorage}catch{return null}}function je(t){const e=z();if(!e)return null;try{const i=e.getItem(x);if(!i)return null;const n=JSON.parse(i),o=typeof n.baseUrl=="string"?ue(n.baseUrl.trim()):"",a=typeof n.expiresAt=="number"&&Number.isFinite(n.expiresAt)?n.expiresAt:0;return!o||a<=Date.now()||!t.baseUrls.includes(o)?(e.removeItem(x),null):o}catch{return e.removeItem(x),null}}function Xe(t,e){const i=z();if(!i||!e.baseUrls.includes(t))return;const n=Date.now(),o={baseUrl:t,updatedAt:n,expiresAt:n+Fe};try{i.setItem(x,JSON.stringify(o))}catch{}}function se(){const t=z();if(t)try{t.removeItem(x)}catch{}}function he(t){const e=t.match(/^([^?#]*)([?#].*)?$/);return e?{path:e[1]||"",suffix:e[2]||""}:{path:t,suffix:""}}function oe(t,e){return e.some(i=>t.startsWith(i))}function me(t,e){return!(!oe(t,e.includePrefixes)||oe(t,e.excludePrefixes))}function pe(t,e){const{path:i,suffix:n}=he(t);return`${e}${i}${n}`}function Ke(t,e,i){if(!/^https?:\/\//i.test(t))return null;try{const n=new URL(t),o=ze();return!o||n.origin!==o||!me(n.pathname,e)?null:pe(`${n.pathname}${n.search}${n.hash}`,i)}catch{return null}}function Qe(t){if(typeof t!="string"||t.trim()==="")return $e;const e=t.trim();return e.startsWith("/")?e:`/${e}`}function Je(t,e){const i=e.includes("?")?"&":"?";return`${t}${e}${i}__cdn_probe=${Date.now()}`}async function Ze(t,e,i){if(i!==b||typeof window>"u"||typeof fetch!="function")return!1;const n=typeof AbortController<"u"?new AbortController:null,o=window.setTimeout(()=>n==null?void 0:n.abort(),e.probeTimeoutMs);try{return(await fetch(Je(t,e.probePath),{method:"GET",mode:"cors",cache:"no-store",referrerPolicy:"no-referrer",signal:n==null?void 0:n.signal})).ok}catch{return!1}finally{window.clearTimeout(o)}}async function et(t,e){if(t.baseUrls.length===0)return null;const i=t.baseUrls.map(async s=>{if(!await Ze(s,t,e))throw new Error(`probe failed: ${s}`);return s}),n=Promise.any;if(typeof n=="function")try{return await n.call(Promise,i)}catch{return null}const a=(await Promise.all(i.map(s=>s.then(u=>({ok:!0,baseUrl:u})).catch(()=>({ok:!1,baseUrl:null}))))).find(s=>s.ok&&typeof s.baseUrl=="string");return(a==null?void 0:a.baseUrl)??null}function W(t=!1){const e=R;if(!e||!e.enabled||!t&&L||y==="probing")return;if(typeof window>"u"||typeof fetch!="function"){y="failed";return}y="probing";const i=++b;(async()=>{const n=await et(e,i);if(i===b){if(n){L=n,Xe(n,e),y="ok";return}i===b&&(L=null,se(),y="failed")}})().catch(()=>{i===b&&(L=null,se(),y="failed")}).finally(()=>{})}function H(t){if(b+=1,L=null,y="idle",!t||t.enabled===!1){R=null;return}const e=We(t);if(e.length===0){R=null;return}R={enabled:!0,baseUrls:e,includePrefixes:ne(t.includePrefixes,He),excludePrefixes:ne(t.excludePrefixes,Be),probePath:Qe(t.probePath),probeTimeoutMs:typeof t.probeTimeoutMs=="number"&&Number.isFinite(t.probeTimeoutMs)?Math.max(200,Math.floor(t.probeTimeoutMs)):Ye};const i=je(R);if(i){L=i,y="ok",W(!0);return}W(!1)}function tt(t,e){if(!t||typeof t!="string"||t.trim()==="")return"";const i=t.trim(),n=R;if(!n||!n.enabled)return i;const o=L;if(!o)return W(),i;const a=Ke(i,n,o);if(a)return a;if(i.startsWith("//"))return i;const{path:s}=he(i);return!s.startsWith("/")||!me(s,n)?i:pe(i,o)}let T=null;function fe(){return T!==null?T:typeof navigator<"u"&&navigator.maxTouchPoints>0||typeof window<"u"&&("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)?(T="touch",T):(T="mouse",T)}function Lt(){return fe()==="touch"}function it(){return fe()==="mouse"}let V=null;function Ie(t,e=1500){if(q())return;const i=document.querySelector(".vr-toast"),n=i??document.createElement("div");n.className="vr-toast",n.textContent=t,i||document.body.appendChild(n),window.requestAnimationFrame(()=>n.classList.add("show")),V&&window.clearTimeout(V),V=window.setTimeout(()=>{n.classList.remove("show"),window.setTimeout(()=>n.remove(),220),V=null},e)}function nt(){const t=document.querySelector(".vr-toast");t&&(t.classList.remove("show"),window.setTimeout(()=>t.remove(),220)),V&&(window.clearTimeout(V),V=null)}function st(){const t=document;return document.fullscreenElement||t.webkitFullscreenElement||null}function ge(){return!!st()}async function ot(t){const e=t;if(e.requestFullscreen){await e.requestFullscreen();return}if(e.webkitRequestFullscreen){await e.webkitRequestFullscreen();return}throw new Error("Fullscreen API not supported")}async function rt(){const t=document;if(document.exitFullscreen){await document.exitFullscreen();return}if(t.webkitExitFullscreen){await t.webkitExitFullscreen();return}}async function at(t){const e=t||document.body;!ge()&&it()&&Ie("é¼ æ ‡æ»‘è‡³æœ€ä¸Šæ–¹å¯é€€å‡ºå…¨å±",700),await ot(e)}async function re(){try{await rt(),Ee()}catch(t){console.debug("[fullscreen] exitFullscreenBestEffort failed:",t)}}function Ee(){var t,e;try{(e=(t=screen.orientation)==null?void 0:t.unlock)==null||e.call(t)}catch{}}class lt{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"options");this.options=e;const i=document.createElement("div");i.className="vr-modal vr-modal--media vr-modal--image";const n=document.createElement("div");n.className="vr-modal-mask",n.addEventListener("click",()=>this.handleClose());const o=document.createElement("div");o.className="vr-modal-card vr-modal-card--media vr-modal-card--image",o.addEventListener("click",m=>m.stopPropagation());const a=document.createElement("div");a.className="vr-modal-header";const s=document.createElement("div");s.className="vr-modal-title",s.textContent=e.title||"å›¾ç‰‡é¢„è§ˆ";const u=document.createElement("button");u.className="vr-btn vr-modal-close-icon",u.setAttribute("aria-label","å…³é—­"),u.textContent="Ã—",u.addEventListener("click",()=>this.handleClose()),a.appendChild(s),a.appendChild(u);const d=document.createElement("div");d.className="vr-modal-body vr-modal-body--image";const h=document.createElement("img");h.className="vr-modal-image",e.src&&(h.src=e.src),h.alt=e.title||"çƒ­ç‚¹å›¾ç‰‡",h.loading="lazy",d.appendChild(h),o.appendChild(a),o.appendChild(d),i.appendChild(n),i.appendChild(o),this.element=i}handleClose(){var e,i;this.close(),(i=(e=this.options).onClose)==null||i.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class dt{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"options");this.options=e;const i=document.createElement("div");i.className="vr-modal vr-modal--info";const n=document.createElement("div");n.className="vr-modal-mask",n.addEventListener("click",()=>this.handleClose());const o=document.createElement("div");o.className="vr-modal-card vr-modal-card--info",o.addEventListener("click",h=>h.stopPropagation());const a=document.createElement("div");a.className="vr-modal-header";const s=document.createElement("div");s.className="vr-modal-title",s.textContent=e.title||"è¯¦æƒ…";const u=document.createElement("button");u.className="vr-btn vr-modal-close-icon",u.setAttribute("aria-label","å…³é—­"),u.textContent="Ã—",u.addEventListener("click",()=>this.handleClose()),a.appendChild(s),a.appendChild(u);const d=document.createElement("div");d.className="vr-modal-body vr-modal-body--info",d.textContent=e.text||"æœªé…ç½®å†…å®¹",o.appendChild(a),o.appendChild(d),i.appendChild(n),i.appendChild(o),this.element=i}handleClose(){var e,i;this.close(),(i=(e=this.options).onClose)==null||i.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class ct{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"videoEl");r(this,"options");this.options=e;const i=document.createElement("div");i.className="vr-modal vr-modal--media vr-modal--video";const n=document.createElement("div");n.className="vr-modal-mask",n.addEventListener("click",()=>this.handleClose());const o=document.createElement("div");o.className="vr-modal-card vr-modal-card--media vr-modal-card--video",o.addEventListener("click",m=>m.stopPropagation());const a=document.createElement("div");a.className="vr-modal-header";const s=document.createElement("div");s.className="vr-modal-title",s.textContent=e.title||"è§†é¢‘";const u=document.createElement("button");u.className="vr-btn vr-modal-close-icon",u.setAttribute("aria-label","å…³é—­"),u.textContent="Ã—",u.addEventListener("click",()=>this.handleClose()),a.appendChild(s),a.appendChild(u);const d=document.createElement("div");d.className="vr-modal-body vr-modal-body--video";const h=document.createElement("video");h.className="vr-modal-video",e.src&&(h.src=e.src),e.poster&&(h.poster=e.poster),h.controls=!0,h.playsInline=!0,h.preload="metadata",this.videoEl=h,d.appendChild(h),o.appendChild(a),o.appendChild(d),i.appendChild(n),i.appendChild(o),this.element=i}handleClose(){var e,i;this.close(),(i=(e=this.options).onClose)==null||i.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){if(this.isOpen){this.isOpen=!1,this.element.classList.remove("open");try{this.videoEl.pause(),this.videoEl.currentTime=0,this.videoEl.removeAttribute("src"),this.videoEl.load()}catch{}}}getElement(){return this.element}destroy(){this.close(),this.element.remove()}}const _e="vr:open-modal",we="vr:close-modal";function Vt(t){window.dispatchEvent(new CustomEvent(_e,{detail:t}))}function B(){window.dispatchEvent(new CustomEvent(we))}class ut{constructor(e){r(this,"rootEl");r(this,"current",null);r(this,"handleKeyDownBound");this.rootEl=e,this.handleKeyDownBound=i=>this.handleKeyDown(i),window.addEventListener(_e,i=>{const n=i;this.handleOpen(n.detail)}),window.addEventListener(we,()=>this.close()),window.addEventListener("keydown",this.handleKeyDownBound)}handleKeyDown(e){e.key==="Escape"&&this.close()}handleOpen(e){this.close();let i=null;e.type==="image"?i=new lt({src:e.payload.src,title:e.payload.title,onClose:()=>B()}):e.type==="info"?i=new dt({title:e.payload.title,text:e.payload.text,onClose:()=>B()}):e.type==="video"&&(i=new ct({src:e.payload.src,poster:e.payload.poster,title:e.payload.title,onClose:()=>B()})),i&&(this.current=i,this.rootEl.innerHTML="",this.rootEl.appendChild(i.getElement()),i.open())}close(){this.current&&(this.current.close(),this.current.destroy(),this.current=null,this.rootEl.innerHTML="")}}let ae=null;function ht(){if(ae)return;let t=document.getElementById("vr-modal-root");t||(t=document.createElement("div"),t.id="vr-modal-root",document.body.appendChild(t)),ae=new ut(t)}function mt(t,e,i){const n=t.getBoundingClientRect(),o=e-n.left,a=i-n.top,s=document.createElement("div");s.className="vr-pick-marker",s.style.position="absolute",s.style.left="0",s.style.top="0",s.style.transform=`translate3d(${o}px, ${a}px, 0)`,s.style.pointerEvents="none",s.style.zIndex="1000",t.style.position="relative",t.appendChild(s),window.requestAnimationFrame(()=>{s.classList.add("show")}),window.setTimeout(()=>{s.classList.remove("show"),window.setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},200)},1500)}const Me="vr_last_pick_v1";let j=null;function pt(){try{const t=localStorage.getItem(Me);if(t){const e=JSON.parse(t);typeof e.yaw=="number"&&typeof e.pitch=="number"&&typeof e.ts=="number"&&(j=e)}}catch{}}pt();function ft(t){j=t;try{localStorage.setItem(Me,JSON.stringify(t))}catch{}}function Ot(){return j}class It{constructor(){r(this,"listeners",new Map);r(this,"lastInteractionTs",0);r(this,"idleDelay",800);r(this,"idleTimer",null);r(this,"rafId",null);r(this,"isScheduled",!1);this.listeners.set("user-interacting",new Set),this.listeners.set("user-idle",new Set),this.listeners.set("ui-engaged",new Set)}on(e,i){const n=this.listeners.get(e);return n?(n.add(i),()=>{n.delete(i)}):(console.warn(`[InteractionBus] æœªçŸ¥äº‹ä»¶ç±»å‹: ${e}`),()=>{})}off(e,i){const n=this.listeners.get(e);n&&n.delete(i)}emit(e){this.isScheduled||(this.isScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.isScheduled=!1;const i=this.listeners.get(e);i&&i.forEach(n=>{try{n()}catch(o){console.error("[InteractionBus] äº‹ä»¶ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥:",o)}})}))}emitInteracting(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("user-interacting")}scheduleIdle(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.idleTimer=window.setTimeout(()=>{Date.now()-this.lastInteractionTs>=this.idleDelay&&(this.idleTimer=null,this.emit("user-idle"))},this.idleDelay)}emitUIEngaged(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("ui-engaged")}dispose(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.listeners.forEach(e=>e.clear()),this.listeners.clear()}}const O=new It,gt=150,Et=150,_t=400;function wt(){return{fadeMs:gt,restoreMs:Et,restoreDelayMs:_t}}function Mt(){O.on("user-interacting",()=>{}),O.on("user-idle",()=>{}),O.on("ui-engaged",()=>{})}let w=null;function vt(){const t=wt();O.on("user-interacting",()=>{w!==null&&(clearTimeout(w),w=null),document.documentElement.classList.add("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")}),O.on("user-idle",()=>{w!==null&&(clearTimeout(w),w=null),document.documentElement.classList.remove("vr-ui-interacting"),w=window.setTimeout(()=>{document.documentElement.classList.remove("vr-ui-restoring"),w=null},t.restoreDelayMs)}),O.on("ui-engaged",()=>{w!==null&&(clearTimeout(w),w=null),document.documentElement.classList.remove("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")})}const A=typeof window<"u"?new URLSearchParams(window.location.search).get("debug")==="1":!1;function Ct(...t){A&&console.debug("[VR Debug]",...t)}function St(){const t={};try{const e=new URLSearchParams(window.location.search),i=e.get("museum"),n=e.get("scene");i&&(t.museumId=i),n&&(t.currentSceneId=n)}catch{}try{const e=document.querySelector(".vr-groundnav");if(e){t.groundNavDots={};const i=e.querySelector(".vr-groundnav__dot.is-aimed");i&&(t.groundNavDots.aimedSceneId=i.getAttribute("data-scene-id")||void 0);const n=e.querySelector(".vr-groundnav__dot.is-autonav");if(n){t.groundNavDots.isAutoNavActive=!0,t.groundNavDots.autoNavTargetSceneId=n.getAttribute("data-scene-id")||void 0;const o=n.querySelector(".vr-groundnav__progress");t.groundNavDots.hasProgressElement=!!o}}}catch{}try{const e=document.querySelector(".vr-previewcard");if(e){t.scenePreviewCard={},t.scenePreviewCard.isVisible=e.classList.contains("is-visible");const i=e.querySelector(".vr-previewcard__hint");i&&(t.scenePreviewCard.hintVisible=i.classList.contains("is-visible"),t.scenePreviewCard.hintEmphasizing=i.classList.contains("is-emphasizing"))}}catch{}try{const e=document.querySelector(".vr-scenestrip");e&&(t.sceneStrip={},t.sceneStrip.userScrolling=e.classList.contains("is-user-scrolling"))}catch{}try{const e=document.documentElement,i=Array.from(e.classList).filter(n=>n==="vr-ui-interacting"||n==="vr-ui-restoring");i.length>0&&(t.yieldClassManager={classes:i})}catch{}return t}function Tt(t){try{window.dispatchEvent(new CustomEvent("vr:close-panels"))}catch{}try{t?(t.emitInteracting(),setTimeout(()=>{try{document.documentElement.classList.remove("vr-ui-interacting","vr-ui-restoring")}catch{}},100)):document.documentElement.classList.remove("vr-ui-interacting","vr-ui-restoring")}catch{}}const $=typeof window<"u"&&"requestIdleCallback"in window?window.requestIdleCallback:null,Y=typeof window<"u"&&"cancelIdleCallback"in window?window.cancelIdleCallback:null;class yt{constructor(e){r(this,"options");r(this,"disposed",!1);r(this,"coreMounted",!1);r(this,"coreMounting",!1);r(this,"deferredMounted",!1);r(this,"deferredMounting",!1);r(this,"observerMounted",!1);r(this,"observerMounting",!1);r(this,"observerIdleHandle",null);r(this,"bottomDock",null);r(this,"topModeTabs",null);r(this,"hotspots",null);r(this,"videoPlayer",null);r(this,"guideTray",null);r(this,"sceneGuideDrawer",null);r(this,"qualityIndicator",null);r(this,"handleMetricsEvent",null);r(this,"videoPlayerModulePromise",null);r(this,"guideTrayModulePromise",null);r(this,"sceneGuideDrawerModulePromise",null);r(this,"qualityIndicatorModulePromise",null);this.options=e}getBottomDock(){return this.bottomDock}getTopModeTabs(){return this.topModeTabs}getHotspots(){return this.hotspots}getVideoPlayer(){return this.videoPlayer}getGuideTray(){return this.guideTray}getSceneGuideDrawer(){return this.sceneGuideDrawer}getQualityIndicator(){return this.qualityIndicator}async mountCore(){if(!(this.coreMounted||this.coreMounting||this.disposed||!this.isAlive())){this.coreMounting=!0;try{const[{BottomDock:e},{TopModeTabs:i},{Hotspots:n}]=await Promise.all([I(()=>import("./BottomDock-ePK9Yx7i.js"),__vite__mapDeps([0,1,2]),import.meta.url),I(()=>import("./TopModeTabs-psisWFio.js"),[],import.meta.url),I(()=>import("./Hotspots-D1eUDWHC.js"),__vite__mapDeps([3,4,5]),import.meta.url)]);if(this.coreMounted||this.disposed||!this.isAlive())return;const o=this.options.getPanoViewer();if(!o)return;const a=new Map(this.options.museum.scenes.map(s=>[s.id,s.name]));this.bottomDock=new e({onGuideClick:()=>{this.openGuideTray()},onOpenCommunity:()=>{this.options.onOpenCommunity()},onOpenInfo:this.options.onOpenInfo,onOpenSettings:this.options.onOpenSettings,sceneId:this.options.scene.id,sceneName:this.options.scene.name,museum:this.options.museum,scenes:this.options.museum.scenes,currentSceneId:this.options.scene.id}),this.options.appElement.appendChild(this.bottomDock.getElement()),this.topModeTabs=new i({initialMode:this.options.initialMode,onModeChange:this.options.onModeChange}),this.options.appElement.appendChild(this.topModeTabs.getElement()),this.hotspots=new n(o,this.options.scene.hotspots,{resolveSceneName:s=>a.get(s),onEnterScene:this.options.onEnterScene,museumId:this.options.museum.id}),this.options.viewerContainer.appendChild(this.hotspots.getElement()),this.coreMounted=!0}finally{this.coreMounting=!1}}}async mountDeferred(){if(!(this.deferredMounted||this.deferredMounting||this.disposed||!this.isAlive())){this.deferredMounting=!0;try{const[{VideoPlayer:e},{GuideTray:i}]=await Promise.all([this.loadVideoPlayerModule(),this.loadGuideTrayModule()]);if(this.deferredMounted||this.disposed||!this.isAlive())return;this.videoPlayer||(this.videoPlayer=new e,this.options.appElement.appendChild(this.videoPlayer.getElement())),this.guideTray||(this.guideTray=new i({museumId:this.options.museum.id,currentSceneId:this.options.scene.id,scenes:this.options.museum.scenes,onSceneClick:n=>{this.options.onEnterScene(n)},onMoreClick:()=>{this.openSceneGuideDrawer()},onClose:()=>{var n;(n=this.guideTray)==null||n.setVisible(!1),window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"guide"}}))}}),this.guideTray.setVisible(!1),this.options.appElement.appendChild(this.guideTray.getElement())),this.deferredMounted=!0}finally{this.deferredMounting=!1}}}scheduleObserverMount(){if(!(this.observerMounted||this.observerMounting||this.disposed||this.observerIdleHandle!==null)){if($&&Y){this.observerIdleHandle=$(()=>{this.observerIdleHandle=null,this.mountObserver()},{timeout:1200});return}this.observerIdleHandle=window.setTimeout(()=>{this.observerIdleHandle=null,this.mountObserver()},500)}}handleStatusChange(e){var i;(i=this.qualityIndicator)==null||i.updateStatus(e),(e===_.HIGH_READY||e===_.DEGRADED)&&this.scheduleObserverMount()}dispose(){var e,i,n,o,a,s;this.disposed=!0,this.observerIdleHandle!==null&&($&&Y?Y(this.observerIdleHandle):clearTimeout(this.observerIdleHandle),this.observerIdleHandle=null),this.handleMetricsEvent&&(window.removeEventListener("vr:metrics",this.handleMetricsEvent),this.handleMetricsEvent=null),(e=this.qualityIndicator)==null||e.remove(),this.qualityIndicator=null,(i=this.sceneGuideDrawer)==null||i.remove(),this.sceneGuideDrawer=null,(n=this.guideTray)==null||n.remove(),this.guideTray=null,(o=this.videoPlayer)==null||o.remove(),this.videoPlayer=null,(a=this.hotspots)==null||a.remove(),this.hotspots=null,this.topModeTabs&&(this.topModeTabs.getElement().remove(),this.topModeTabs=null),(s=this.bottomDock)==null||s.remove(),this.bottomDock=null}async openGuideTray(){var e;await this.mountDeferred(),!(this.disposed||!this.isAlive())&&((e=this.guideTray)==null||e.setVisible(!0))}async openSceneGuideDrawer(){var e;if(await this.mountDeferred(),!(this.disposed||!this.isAlive())){if(!this.sceneGuideDrawer){const{SceneGuideDrawer:i}=await this.loadSceneGuideDrawerModule();if(this.disposed||!this.isAlive())return;this.sceneGuideDrawer=new i({museumId:this.options.museum.id,currentSceneId:this.options.scene.id,scenes:this.options.museum.scenes,onClose:()=>{}}),this.options.appElement.appendChild(this.sceneGuideDrawer.getElement())}(e=this.guideTray)==null||e.setVisible(!1),this.sceneGuideDrawer.open()}}async mountObserver(){if(!(this.observerMounted||this.observerMounting||this.disposed||!this.isAlive())){this.observerMounting=!0;try{const{QualityIndicator:e}=await this.loadQualityIndicatorModule();if(this.observerMounted||this.disposed||!this.isAlive())return;this.qualityIndicator||(this.qualityIndicator=new e,this.options.appElement.appendChild(this.qualityIndicator.getElement()));const i=this.options.getPanoViewer();i&&this.qualityIndicator.updateStatus(i.getLoadStatus()),this.handleMetricsEvent||(this.handleMetricsEvent=n=>{if(!this.qualityIndicator)return;const o=n.detail||{};this.qualityIndicator.updateMetrics(o)},window.addEventListener("vr:metrics",this.handleMetricsEvent)),this.observerMounted=!0}finally{this.observerMounting=!1}}}loadVideoPlayerModule(){return this.videoPlayerModulePromise||(this.videoPlayerModulePromise=I(()=>import("./VideoPlayer-CyQLSIuS.js"),[],import.meta.url)),this.videoPlayerModulePromise}loadGuideTrayModule(){return this.guideTrayModulePromise||(this.guideTrayModulePromise=I(()=>import("./GuideTray-DA1_STCM.js"),__vite__mapDeps([6,7]),import.meta.url)),this.guideTrayModulePromise}loadSceneGuideDrawerModule(){return this.sceneGuideDrawerModulePromise||(this.sceneGuideDrawerModulePromise=I(()=>import("./SceneGuideDrawer-BtUJ0P7N.js"),__vite__mapDeps([8,7,2]),import.meta.url)),this.sceneGuideDrawerModulePromise}loadQualityIndicatorModule(){return this.qualityIndicatorModulePromise||(this.qualityIndicatorModulePromise=I(()=>import("./QualityIndicator-BJyj5HLC.js"),[],import.meta.url)),this.qualityIndicatorModulePromise}isAlive(){if(this.disposed)return!1;const e=this.options.getCurrentSceneId();return!!(e&&e===this.options.scene.id)}}function le(t){return!!(t!=null&&t.endpoint&&t.endpoint.trim())}class Pt{constructor(){r(this,"context",null);r(this,"contextToken",0);r(this,"initPromise",null);r(this,"panel",null)}updateContext(e){this.context=e,this.contextToken+=1}async ensureInit(){const e=this.context;if(!e||!le(e.fcChatConfig)||this.panel)return;if(this.initPromise){await this.initPromise;return}const i=this.contextToken,n=(async()=>{var d;const[{FcChatPanel:o},{FcChatClient:a}]=await Promise.all([I(()=>import("./chat-community-C6ZbaM52.js").then(h=>h.F),__vite__mapDeps([9,10]),import.meta.url),I(()=>import("./chat-community-C6ZbaM52.js").then(h=>h.f),__vite__mapDeps([9,10]),import.meta.url)]);if(i!==this.contextToken)return;const s=this.context;if(!s||!le(s.fcChatConfig))return;const u=new a({endpoint:s.fcChatConfig.endpoint,authToken:s.fcChatConfig.authToken,timeoutMs:15e3});(d=this.panel)==null||d.remove(),this.panel=new o(u,{museumId:s.museum.id,sceneId:s.scene.id,sceneTitle:s.scene.name,museumName:s.museum.name,url:window.location.href})})();this.initPromise=n.finally(()=>{this.initPromise===n&&(this.initPromise=null)}),await this.initPromise}dispose(){var e;this.contextToken+=1,this.context=null,this.initPromise=null,(e=this.panel)==null||e.remove(),this.panel=null}}A&&(window.__vrDump=()=>{const t=St();return console.debug("[VR State Snapshot]",t),t},window.__vrResetUI=()=>{console.debug("[VR Reset UI] å§ï½…æ¹ªå¨“å‘¯æ‚Šéµâ‚¬éˆ?UI é˜èˆµâ‚¬?.."),Tt(O),console.debug("[VR Reset UI] å¨“å‘¯æ‚Šç€¹å±¾åš")},console.debug("[VR Debug] ç’‹å†­ç˜¯å¦¯â€³ç´¡å®¸æ’æƒé¢ã„£â‚¬å‚™å¨‡é¢?__vrDump() éŒãƒ§æ¹…é˜èˆµâ‚¬ä¾Šç´æµ£è·¨æ•¤ __vrResetUI() æ¾¶å¶„ç¶… UI"));De();Mt();vt();Re();const ve=()=>{const t=document;!!(document.fullscreenElement||t.webkitFullscreenElement)&&nt()};document.addEventListener("fullscreenchange",ve);document.addEventListener("webkitfullscreenchange",ve);function Nt(){const t=new URLSearchParams(location.search);return t.has("development")||t.get("dev")==="1"||location.hash.includes("development")}class bt{constructor(){r(this,"appElement");r(this,"config",null);r(this,"panoViewer",null);r(this,"titleBar",null);r(this,"topRightControls",null);r(this,"topModeTabs",null);r(this,"sceneTitleEl",null);r(this,"brandMark",null);r(this,"bottomDock",null);r(this,"sceneGuideDrawer",null);r(this,"guideTray",null);r(this,"museumList",null);r(this,"sceneListPage",null);r(this,"hotspots",null);r(this,"videoPlayer",null);r(this,"loading");r(this,"debugPanel",null);r(this,"configStudio",null);r(this,"qualityIndicator",null);r(this,"northCalibrationPanel",null);r(this,"currentMuseum",null);r(this,"currentScene",null);r(this,"sceneUiRuntime",null);r(this,"chatRuntime",null);r(this,"hasBoundFullscreenEvents",!1);r(this,"mode","tour");r(this,"isStructureOverlayOpen",!1);r(this,"structureView2D",null);r(this,"structureView3D",null);r(this,"infoModalMounted",null);r(this,"settingsModalMounted",null);r(this,"handlePopState",null);r(this,"handlePickEvent",null);r(this,"handlePickModeEvent",null);r(this,"debugPanelRafId",null);r(this,"structure3DLoadToken",0);r(this,"panoViewerModulePromise",null);r(this,"topRightControlsModulePromise",null);r(this,"brandMarkModulePromise",null);r(this,"structureView2DModulePromise",null);r(this,"titleBarModulePromise",null);r(this,"museumListModulePromise",null);r(this,"sceneListPageModulePromise",null);r(this,"sceneGraphModulePromise",null);r(this,"vrModeModulePromise",null);r(this,"vrModeInitialized",!1);r(this,"externalImageModulePromise",null);r(this,"appModalsModulePromise",null);r(this,"uiErrorElement",null);const e=document.getElementById("app");if(!e)throw new Error("éµå¥ç¬‰é’?#app éå†ªç¤Œ");this.appElement=e,ht(),this.loading=new Ue,this.appElement.appendChild(this.loading.getElement()),this.bindFullscreenEventsOnce(),this.init()}bindFullscreenEventsOnce(){if(this.hasBoundFullscreenEvents)return;this.hasBoundFullscreenEvents=!0;const e=()=>{var i;(i=this.topRightControls)==null||i.syncFullscreenState(),ge()||(this.topRightControls&&this.topRightControls.updateVrModeState(!1),this.panoViewer&&this.panoViewer.isVrModeEnabled()&&this.panoViewer.setVrModeEnabled(!1),Ee())};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}loadPanoViewerModule(){return this.panoViewerModulePromise||(this.panoViewerModulePromise=I(()=>import("./PanoViewer-CPb5FQ96.js").then(e=>e.P),__vite__mapDeps([11,5,12,4,7]),import.meta.url)),this.panoViewerModulePromise}loadTopRightControlsModule(){return this.topRightControlsModulePromise||(this.topRightControlsModulePromise=I(()=>import("./TopRightControls-oBpTwg6L.js"),[],import.meta.url)),this.topRightControlsModulePromise}loadBrandMarkModule(){return this.brandMarkModulePromise||(this.brandMarkModulePromise=I(()=>import("./BrandMark-DZDAGEAL.js"),__vite__mapDeps([13,14]),import.meta.url)),this.brandMarkModulePromise}loadStructureView2DModule(){return this.structureView2DModulePromise||(this.structureView2DModulePromise=I(()=>import("./StructureView2D--Q7Gxr9k.js"),__vite__mapDeps([15,16]),import.meta.url)),this.structureView2DModulePromise}loadTitleBarModule(){return this.titleBarModulePromise||(this.titleBarModulePromise=I(()=>import("./TitleBar-DAY6bVbi.js"),[],import.meta.url)),this.titleBarModulePromise}loadMuseumListModule(){return this.museumListModulePromise||(this.museumListModulePromise=I(()=>import("./MuseumList-DXjZearH.js"),[],import.meta.url)),this.museumListModulePromise}loadSceneListPageModule(){return this.sceneListPageModulePromise||(this.sceneListPageModulePromise=I(()=>import("./SceneListPage-BgXpVSZB.js"),[],import.meta.url)),this.sceneListPageModulePromise}loadSceneGraphModule(){return this.sceneGraphModulePromise||(this.sceneGraphModulePromise=I(()=>import("./sceneGraph-CaQzl5R8.js"),[],import.meta.url)),this.sceneGraphModulePromise}loadVrModeModule(){return this.vrModeModulePromise||(this.vrModeModulePromise=I(()=>import("./vrMode-BaCDoHyb.js"),__vite__mapDeps([17,5]),import.meta.url)),this.vrModeModulePromise}loadAppModalsModule(){return this.appModalsModulePromise||(this.appModalsModulePromise=I(()=>import("./appModals-BWEJDeQU.js"),__vite__mapDeps([18,1,12]),import.meta.url)),this.appModalsModulePromise}async ensureVrModeInitialized(){const e=await this.loadVrModeModule();return this.vrModeInitialized||(e.initVrMode(),this.vrModeInitialized=!0),e}async resolveProxiedImageUrl(e){this.externalImageModulePromise||(this.externalImageModulePromise=I(()=>import("./externalImage-Cn8sVw7v.js"),[],import.meta.url));try{const{toProxiedImageUrl:i}=await this.externalImageModulePromise;return i(e)}catch{return e}}async init(){try{if(this.loading.show(),Ce()){await this.initEditorMode(),this.loading.hide();return}this.config=await K(),H(this.config.assetCdn),this.titleBar&&this.titleBar.setTitle(this.config.appName),this.handlePopState||(this.handlePopState=()=>{this.handleRoute()},window.addEventListener("popstate",this.handlePopState)),await this.handleRoute(),this.loading.hide()}catch(e){console.error("é…ç½®åŠ è½½å¤±è´¥:",e),this.loading.hide(),e.validationErrors&&Array.isArray(e.validationErrors)?this.showConfigErrorPanel(e.validationErrors):this.showError("åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•")}}async initEditorMode(){try{this.config=await K(),H(this.config.assetCdn),this.appElement.innerHTML="";const{ConfigStudio:e}=await I(async()=>{const{ConfigStudio:i}=await import("./editor-debug-Dz10SSgE.js").then(n=>n.C);return{ConfigStudio:i}},__vite__mapDeps([19,20,14]),import.meta.url);this.configStudio=new e(this.config,i=>{this.config=i,H(i.assetCdn),Q()}),this.appElement.appendChild(this.configStudio.getElement())}catch(e){console.error("åˆå§‹åŒ–ç¼–è¾‘å™¨æ¨¡å¼å¤±è´¥:",e),e.validationErrors&&Array.isArray(e.validationErrors)?this.showConfigErrorPanel(e.validationErrors):this.showError("åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•")}}showConfigErrorPanel(e){this.appElement.innerHTML="";const i=new ke(e,()=>{Q(),window.location.reload()},()=>{this.showConfigExample()});this.appElement.appendChild(i.getElement())}showConfigExample(){const e=window.open("","_blank");e&&e.document.write(`
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>config.json ç¤ºä¾‹</title>
          <style>
            body {
              font-family: 'Courier New', monospace;
              padding: 20px;
              background: #1a1a1a;
              color: #fff;
            }
            pre {
              background: #0f0f0f;
              padding: 20px;
              border-radius: 8px;
              overflow-x: auto;
            }
            code {
              color: #4a90e2;
            }
          </style>
        </head>
        <body>
          <h1>config.json ç¤ºä¾‹é…ç½®</h1>
          <pre><code>{
  "appName": "åº”ç”¨åç§°",
  "museums": [
    {
      "id": "museum_id",
      "name": "å±•é¦†åç§°",
      "cover": "https://example.com/cover.jpg",
      "map": {
        "image": "https://example.com/map.jpg",
        "width": 1000,
        "height": 600
      },
      "scenes": [
        {
          "id": "scene_id",
          "name": "åœºæ™¯åç§°",
          "panoLow": "https://example.com/pano-low.jpg",
          "pano": "https://example.com/pano.jpg",
          "thumb": "https://example.com/thumb.jpg",
          "initialView": {
            "yaw": 0,
            "pitch": 0,
            "fov": 75
          },
          "mapPoint": {
            "x": 420,
            "y": 310
          },
          "hotspots": [
            {
              "id": "hotspot_id",
              "type": "scene",
              "label": "çƒ­ç‚¹æ ‡ç­¾",
              "yaw": 35,
              "pitch": -5,
              "target": {
                "museumId": "museum_id",
                "sceneId": "target_scene_id",
                "yaw": 120,
                "pitch": 0
              }
            }
          ]
        }
      ]
    }
  ]
}</code></pre>
          <p>è¯¦ç»†é…ç½®è¯´æ˜è¯·æŸ¥çœ‹ README.md</p>
        </body>
        </html>
      `)}async handleRoute(){if(!this.config)return;const e=ee();if(e.sceneId&&(this.loadPanoViewerModule(),this.loadTopRightControlsModule(),this.loadBrandMarkModule()),this.clearView(),!e.museumId){const i=this.config.museums.find(n=>n.id==="wangding")||this.config.museums[0];if(i){if(i.scenes&&i.scenes.length>0){k(i.id,i.scenes[0].id);return}ie(i.id);return}}if(!e.museumId)await this.showMuseumList();else if(e.sceneId){const i=F(e.museumId),n=be(e.museumId,e.sceneId);i&&n?await this.showScene(i,n):(this.showError("æœªæ‰¾åˆ°æŒ‡å®šåœºæ™¯"),i?ie(i.id):te())}else{const i=F(e.museumId);i?await this.showSceneList(i):(this.showError("æœªæ‰¾åˆ°æŒ‡å®šå±•é¦†"),te())}}async showMuseumList(){if(!this.config)return;const[{TitleBar:e},{MuseumList:i}]=await Promise.all([this.loadTitleBarModule(),this.loadMuseumListModule()]);this.titleBar=new e(this.config.appName),this.appElement.appendChild(this.titleBar.getElement()),this.museumList=new i(this.config.museums),this.appElement.appendChild(this.museumList.getElement())}async showSceneList(e){const{TitleBar:i}=await this.loadTitleBarModule();this.titleBar=new i(e.name),this.appElement.appendChild(this.titleBar.getElement());const{SceneListPage:n}=await this.loadSceneListPageModule();this.sceneListPage=new n(e),this.appElement.appendChild(this.sceneListPage.getElement())}async showScene(e,i){var M,U;this.currentMuseum=e,this.currentScene=i,this.loading.show();const n=document.createElement("div");n.className="viewer-container",n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    `,this.appElement.appendChild(n);const o=Oe(),{PanoViewer:a}=await this.loadPanoViewerModule();this.panoViewer=new a(n,o);const s=Nt();if(this.mountTopRightControls(n,i,s),this.sceneTitleEl=document.createElement("div"),this.sceneTitleEl.className="vr-scenetitle",this.sceneTitleEl.textContent=i.name||((M=this.config)==null?void 0:M.appName)||"VR Player",this.appElement.appendChild(this.sceneTitleEl),this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickEvent=c=>{const g=c,{x:f,y:S,yaw:P,pitch:N}=g.detail;if(ft({yaw:P,pitch:N,ts:Date.now()}),Ie(`å®¸æ’î˜²é’?yaw: ${P.toFixed(2)}, pitch: ${N.toFixed(2)}`),this.panoViewer){const C=this.panoViewer.getDomElement();mt(C,f,S)}},window.addEventListener("vr:pick",this.handlePickEvent),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.handlePickModeEvent=c=>{const g=c;this.panoViewer&&!g.detail.enabled&&this.panoViewer.isPickModeEnabled()&&this.panoViewer.disablePickMode()},window.addEventListener("vr:pickmode",this.handlePickModeEvent),this.mountBrandMark(),o){const{DebugPanel:c}=await I(async()=>{const{DebugPanel:f}=await import("./editor-debug-Dz10SSgE.js").then(S=>S.D);return{DebugPanel:f}},__vite__mapDeps([19,20,14]),import.meta.url);this.debugPanel=new c,this.appElement.appendChild(this.debugPanel.getElement()),this.panoViewer.setOnDebugClick((f,S,P,N,C)=>{this.debugPanel&&this.debugPanel.show(f,S,P,N,C)}),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null);const g=()=>{if(this.debugPanel&&this.panoViewer){const f=this.panoViewer.getCurrentView();this.debugPanel.updateView(f.yaw,f.pitch,f.fov)}this.debugPanelRafId=requestAnimationFrame(g)};g()}this.chatRuntime=new Pt,this.chatRuntime.updateContext({museum:e,scene:i,fcChatConfig:(U=this.config)==null?void 0:U.fcChat}),this.sceneUiRuntime=new yt({appElement:this.appElement,viewerContainer:n,museum:e,scene:i,initialMode:this.mode,getPanoViewer:()=>this.panoViewer,getCurrentSceneId:()=>{var c;return((c=this.currentScene)==null?void 0:c.id)??null},onModeChange:c=>{this.setMode(c)},onEnterScene:c=>{k(e.id,c)},onOpenInfo:()=>{this.openInfoModal()},onOpenSettings:()=>{this.openSettingsModal()},onOpenCommunity:()=>{var c;(c=this.chatRuntime)==null||c.ensureInit()}});const u=()=>{var c,g,f,S,P,N,C;this.bottomDock=((c=this.sceneUiRuntime)==null?void 0:c.getBottomDock())??null,this.topModeTabs=((g=this.sceneUiRuntime)==null?void 0:g.getTopModeTabs())??null,this.hotspots=((f=this.sceneUiRuntime)==null?void 0:f.getHotspots())??null,this.videoPlayer=((S=this.sceneUiRuntime)==null?void 0:S.getVideoPlayer())??null,this.guideTray=((P=this.sceneUiRuntime)==null?void 0:P.getGuideTray())??null,this.sceneGuideDrawer=((N=this.sceneUiRuntime)==null?void 0:N.getSceneGuideDrawer())??null,this.qualityIndicator=((C=this.sceneUiRuntime)==null?void 0:C.getQualityIndicator())??null};let d=!1;const h=()=>{var c;d||(d=!0,(c=this.sceneUiRuntime)==null||c.mountCore().then(()=>{u()}).catch(g=>{A&&console.debug("[showScene] æ ¸å¿ƒåœºæ™¯ UI åˆ›å»ºå¤±è´¥ï¼Œå·²è·³è¿‡",g)}))};this.panoViewer.setOnStatusChange(c=>{var g,f;(g=this.sceneUiRuntime)==null||g.handleStatusChange(c),u(),!d&&(c===_.LOW_READY||c===_.HIGH_READY||c===_.DEGRADED)&&window.setTimeout(()=>{h()},0),(c===_.HIGH_READY||c===_.DEGRADED)&&((f=this.sceneUiRuntime)==null||f.scheduleObserverMount()),(c===_.LOW_READY||c===_.HIGH_READY||c===_.DEGRADED)&&this.loading.hide()}),this.panoViewer.setOnLoad(()=>{h(),this.loading.hide(),this.hideUIError(),this.preloadNextScene(e,i)}),this.panoViewer.setOnError(c=>{console.error("åŠ è½½åœºæ™¯å¤±è´¥:",c),this.loading.hide(),this.showError("åŠ è½½å…¨æ™¯å›¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"),this.qualityIndicator&&this.qualityIndicator.updateStatus(_.ERROR)});const m=ee(),p=m.yaw!==void 0?m.yaw:i.initialView.yaw||0,G=m.pitch!==void 0?m.pitch:i.initialView.pitch||0,E=m.fov!==void 0?m.fov:i.initialView.fov||75,v=-p;this.panoViewer.setView(v,G,E),this.panoViewer.loadScene(i),this.panoViewer.setSceneData(e.id,i.id,i.hotspots)}async mountTopRightControls(e,i,n){var o;try{const{TopRightControls:a}=await this.loadTopRightControlsModule();if(!this.panoViewer||!this.currentScene||this.currentScene.id!==i.id)return;(o=this.topRightControls)==null||o.remove(),this.topRightControls=new a({viewerRootEl:e,onTogglePickMode:n?()=>this.panoViewer?(this.panoViewer.isPickModeEnabled()?this.panoViewer.disablePickMode():this.panoViewer.enablePickMode(),this.panoViewer.isPickModeEnabled()):!1:void 0,onOpenNorthCalibration:n?()=>{this.openNorthCalibration(i.id)}:void 0,showNorthCalibration:n,onToggleVrMode:async()=>this.toggleVrModeFromUI(e)}),this.appElement.appendChild(this.topRightControls.getElement())}catch(a){A&&console.debug("[showScene] TopRightControls åˆ›å»ºå¤±è´¥ï¼Œå·²è·³è¿‡",a),this.topRightControls=null}}async mountBrandMark(){var e;try{const{BrandMark:i}=await this.loadBrandMarkModule();if(this.appElement.querySelector(".vr-brandmark"))return;this.brandMark=new i({appName:(e=this.config)==null?void 0:e.appName,brandText:"é¼è™æ¸…æº"});const o=this.brandMark.getElement();o.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.openDingHuQingYuan()}),this.appElement.appendChild(o)}catch(i){A&&console.debug("[showScene] BrandMark åˆ›å»ºå¤±è´¥ï¼Œå·²è·³è¿‡",i),this.brandMark=null}}preloadNextScene(e,i){const o=(e.scenes.findIndex(s=>s.id===i.id)+1)%e.scenes.length,a=e.scenes[o];if(a&&a.thumb){const s=tt(a.thumb,ce.THUMB);if(s){const u=new Image;u.referrerPolicy="no-referrer",u.crossOrigin="anonymous",u.loading="lazy",u.decoding="async",this.resolveProxiedImageUrl(s).then(d=>{u.src=d}).catch(()=>{u.src=s})}}}clearView(){if(this.structure3DLoadToken+=1,this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null),this.chatRuntime&&(this.chatRuntime.dispose(),this.chatRuntime=null),this.sceneUiRuntime&&(this.sceneUiRuntime.dispose(),this.sceneUiRuntime=null),this.bottomDock=null,this.topModeTabs=null,this.hotspots=null,this.videoPlayer=null,this.guideTray=null,this.sceneGuideDrawer=null,this.qualityIndicator=null,this.panoViewer&&(this.panoViewer.dispose(),this.panoViewer=null),this.titleBar&&(this.titleBar.remove(),this.titleBar=null),this.topRightControls&&(this.topRightControls.remove(),this.topRightControls=null),this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),this.sceneTitleEl&&(this.sceneTitleEl.remove(),this.sceneTitleEl=null),this.brandMark&&(this.brandMark.remove(),this.brandMark=null),this.museumList&&(this.museumList.remove(),this.museumList=null),this.sceneListPage&&(this.sceneListPage.remove(),this.sceneListPage=null),this.debugPanel&&(this.debugPanel.remove(),this.debugPanel=null),this.configStudio&&(this.configStudio.remove(),this.configStudio=null),this.structureView2D){const e=this.structureView2D.getElement();e&&e.parentNode&&e.parentNode.removeChild(e),this.structureView2D=null}if(this.structureView3D){const e=this.structureView3D.getElement();e&&e.parentNode&&e.parentNode.removeChild(e),this.structureView3D=null}this.isStructureOverlayOpen=!1,this.mode="tour",this.appElement.innerHTML="",this.appElement.appendChild(this.loading.getElement())}hideUIError(){this.uiErrorElement&&this.uiErrorElement.parentNode&&(this.uiErrorElement.parentNode.removeChild(this.uiErrorElement),this.uiErrorElement=null)}setMode(e){this.mode!==e&&(this.mode,this.mode=e,this.topModeTabs&&this.topModeTabs.setMode(e),e==="tour"&&this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),e==="structure2d"?this.openStructure2D():e==="structure3d"&&this.openStructure3D())}async openStructure2D(){if(!this.currentMuseum||!this.currentScene)return;this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),this.structure3DLoadToken+=1;const e=this.structure3DLoadToken,[{buildSceneGraph:i},{StructureView2D:n}]=await Promise.all([this.loadSceneGraphModule(),this.loadStructureView2DModule()]);if(e!==this.structure3DLoadToken||this.mode!=="structure2d"||!this.currentMuseum||!this.currentScene)return;const o=i(this.currentMuseum,this.currentScene.id);this.structureView2D?this.structureView2D.updateContext({museum:this.currentMuseum,graph:o,currentSceneId:this.currentScene.id}):(this.structureView2D=new n({museum:this.currentMuseum,graph:o,currentSceneId:this.currentScene.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(a,s)=>{this.closeStructureOverlay({toTour:!1}),k(a,s)}}),this.appElement.appendChild(this.structureView2D.getElement())),this.isStructureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView2D.open()}async openStructure3D(){if(!this.currentMuseum||!this.currentScene)return;this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),this.structure3DLoadToken+=1;const e=this.structure3DLoadToken,[{buildSceneGraph:i},{StructureView3D:n}]=await Promise.all([this.loadSceneGraphModule(),I(()=>import("./dock-panels-CO9QQMe_.js").then(a=>a.S),__vite__mapDeps([21,5,22,16]),import.meta.url)]);if(e!==this.structure3DLoadToken||this.mode!=="structure3d"||!this.currentMuseum||!this.currentScene)return;const o=i(this.currentMuseum,this.currentScene.id);this.structureView3D?this.structureView3D.updateContext({museum:this.currentMuseum,graph:o,currentSceneId:this.currentScene.id}):(this.structureView3D=new n({museum:this.currentMuseum,graph:o,currentSceneId:this.currentScene.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(a,s)=>{this.closeStructureOverlay({toTour:!1}),k(a,s)}}),this.appElement.appendChild(this.structureView3D.getElement())),this.isStructureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView3D.open()}closeStructureOverlay(e){if(this.isStructureOverlayOpen){if(this.structure3DLoadToken+=1,this.isStructureOverlayOpen=!1,this.structureView2D){const i=this.structureView2D.getElement();i&&i.parentNode&&i.parentNode.removeChild(i),this.structureView2D=null}if(this.structureView3D){const i=this.structureView3D.getElement();i&&i.parentNode&&i.parentNode.removeChild(i),this.structureView3D=null}document.body.style.overflow="",document.body.style.touchAction="",document.body.style.overscrollBehavior="",e.toTour&&(this.mode="tour",this.topModeTabs&&this.topModeTabs.setMode("tour"))}}async openNorthCalibration(e){if(this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),!this.panoViewer){console.warn("[openNorthCalibration] PanoViewer æœªåˆå§‹åŒ–");return}try{const{NorthCalibrationPanel:i}=await I(async()=>{const{NorthCalibrationPanel:n}=await import("./editor-debug-Dz10SSgE.js").then(o=>o.N);return{NorthCalibrationPanel:n}},__vite__mapDeps([19,20,14]),import.meta.url);this.northCalibrationPanel=new i({getCurrentYaw:()=>{var o;const n=(o=this.panoViewer)==null?void 0:o.getCurrentView();return(n==null?void 0:n.yaw)??0},sceneId:e,onClose:()=>{this.northCalibrationPanel=null}})}catch(i){console.error("[openNorthCalibration] åˆ›å»ºæ ¡å‡†é¢æ¿å¤±è´¥:",i),this.northCalibrationPanel=null}}showError(e){this.hideUIError(),this.uiErrorElement=document.createElement("div"),this.uiErrorElement.className="error-message",this.uiErrorElement.textContent=e,this.uiErrorElement.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 16px;
      text-align: center;
      max-width: 80vw;
    `,this.appElement.appendChild(this.uiErrorElement),setTimeout(()=>{this.hideUIError()},3e3)}openDingHuQingYuan(){if(this.brandMark)try{this.brandMark.getAboutModal().open()}catch(e){A&&console.debug("[openDingHuQingYuan] æ‰“å¼€å›¢é˜Ÿä»‹ç»å¤±è´¥:",e)}}async openInfoModal(){var i,n,o;(i=this.infoModalMounted)==null||i.close(),this.infoModalMounted=null;const{openInfoModal:e}=await this.loadAppModalsModule();this.infoModalMounted=e({museumName:((n=this.currentMuseum)==null?void 0:n.name)||"-",sceneName:((o=this.currentScene)==null?void 0:o.name)||"-",onOpenBrand:()=>{this.openDingHuQingYuan()},onDockTabClose:()=>{this.infoModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"info"}}))}})}async toggleVrModeFromUI(e){if(!this.panoViewer)return!1;const i=await this.ensureVrModeInitialized();if(i.isVrModeEnabled())return i.disableVrMode(),this.panoViewer.setVrModeEnabled(!1),this.topRightControls&&this.topRightControls.updateVrModeState(!1),await re(),!1;{try{await at(e)}catch(s){return A&&console.debug("[VRMode] fullscreen request failed",s),!1}const o=this.panoViewer.getCurrentView();return i.setInteractingCallback(()=>{var s;return((s=this.panoViewer)==null?void 0:s.isInteracting())??!1}),await i.enableVrMode((s,u)=>{if(this.panoViewer){const d=o.yaw+s,h=Math.max(-90,Math.min(90,o.pitch+u));this.panoViewer.setView(d,h)}})?(this.panoViewer.setVrModeEnabled(!0),this.topRightControls&&this.topRightControls.updateVrModeState(!0),!0):(await re(),!1)}}async openSettingsModal(){var i;(i=this.settingsModalMounted)==null||i.close(),this.settingsModalMounted=null;const{openSettingsModal:e}=await this.loadAppModalsModule();this.settingsModalMounted=e({currentScene:this.currentScene,panoViewer:this.panoViewer,bottomDock:this.bottomDock,onToggleVrMode:async n=>this.toggleVrModeFromUI(n),onDockTabClose:()=>{this.settingsModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"settings"}}))}})}}new bt;"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").catch(()=>{})});export{ce as A,xe as E,_ as L,I as _,Ge as a,A as b,ge as c,Ct as d,Ve as e,re as f,Ot as g,at as h,O as i,Lt as j,ht as k,ie as l,q as m,k as n,Dt as o,it as p,Vt as q,tt as r,Ie as s,Ne as v};
