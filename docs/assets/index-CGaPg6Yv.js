const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./PanoViewer-Cbb_h-Mp.js","./three-core-0fX1SOzE.js","./externalImage-DivuH3Vy.js","./BrandMark-Nq8Jicrt.js","./copyText-CwU0x1sN.js","./StructureView2D-BwVOD4qj.js","./autoLayout-ZgSeGcPI.js","./vrMode-Cc2vz0Ot.js","./editor-debug-D38_KtBl.js","./draftStorage-Be1LM_rK.js","./GuideTray-BRkfOiRV.js","./SceneGuideDrawer-mi82QjLI.js","./index-DnDnySW2.js","./BottomDock-D4sOtWv_.js","./Hotspots-BZpbd_r9.js","./chat-community-5yqWR-iz.js","./store-B83L8bDT.js","./dock-panels-BrANmfay.js","./sceneGraph-CaQzl5R8.js"])))=>i.map(i=>d[i]);
var Ce=Object.defineProperty;var Oe=(t,e,i)=>e in t?Ce(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var c=(t,e,i)=>Oe(t,typeof e!="symbol"?e+"":e,i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function i(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=i(o);fetch(o.href,r)}})();const Re="modulepreload",xe=function(t,e){return new URL(t,e).href},Z={},E=function(e,i,n){let o=Promise.resolve();if(i&&i.length>0){const s=document.getElementsByTagName("link"),d=document.querySelector("meta[property=csp-nonce]"),l=(d==null?void 0:d.nonce)||(d==null?void 0:d.getAttribute("nonce"));o=Promise.allSettled(i.map(m=>{if(m=xe(m,n),m in Z)return;Z[m]=!0;const h=m.endsWith(".css"),p=h?'[rel="stylesheet"]':"";if(!!n)for(let M=s.length-1;M>=0;M--){const _=s[M];if(_.href===m&&(!h||_.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${m}"]${p}`))return;const v=document.createElement("link");if(v.rel=h?"stylesheet":Re,h||(v.as="script"),v.crossOrigin="",v.href=m,l&&v.setAttribute("nonce",l),document.head.appendChild(v),h)return new Promise((M,_)=>{v.addEventListener("load",M),v.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${m}`)))})}))}function r(s){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=s,window.dispatchEvent(d),!d.defaultPrevented)throw s}return o.then(s=>{for(const d of s||[])d.status==="rejected"&&r(d.reason);return e().catch(r)})};var a=(t=>(t.INVALID_ROOT="INVALID_ROOT",t.MISSING_APP_NAME="MISSING_APP_NAME",t.MUSEUMS_NOT_ARRAY="MUSEUMS_NOT_ARRAY",t.MUSEUMS_EMPTY="MUSEUMS_EMPTY",t.MISSING_MUSEUM_ID="MISSING_MUSEUM_ID",t.DUPLICATE_MUSEUM_ID="DUPLICATE_MUSEUM_ID",t.MISSING_MUSEUM_NAME="MISSING_MUSEUM_NAME",t.MISSING_MUSEUM_COVER="MISSING_MUSEUM_COVER",t.MISSING_MUSEUM_MAP="MISSING_MUSEUM_MAP",t.MISSING_MAP_IMAGE="MISSING_MAP_IMAGE",t.INVALID_MAP_WIDTH="INVALID_MAP_WIDTH",t.INVALID_MAP_HEIGHT="INVALID_MAP_HEIGHT",t.SCENES_NOT_ARRAY="SCENES_NOT_ARRAY",t.SCENES_EMPTY="SCENES_EMPTY",t.MISSING_SCENE_ID="MISSING_SCENE_ID",t.DUPLICATE_SCENE_ID="DUPLICATE_SCENE_ID",t.MISSING_SCENE_NAME="MISSING_SCENE_NAME",t.MISSING_PANO="MISSING_PANO",t.INVALID_PANO_URL="INVALID_PANO_URL",t.INVALID_PANOLOW_URL="INVALID_PANOLOW_URL",t.MISSING_THUMB="MISSING_THUMB",t.MISSING_INITIAL_VIEW="MISSING_INITIAL_VIEW",t.INVALID_YAW="INVALID_YAW",t.INVALID_PITCH="INVALID_PITCH",t.INVALID_FOV="INVALID_FOV",t.MISSING_MAP_POINT="MISSING_MAP_POINT",t.INVALID_MAP_POINT_X="INVALID_MAP_POINT_X",t.INVALID_MAP_POINT_Y="INVALID_MAP_POINT_Y",t.HOTSPOTS_NOT_ARRAY="HOTSPOTS_NOT_ARRAY",t.MISSING_HOTSPOT_ID="MISSING_HOTSPOT_ID",t.DUPLICATE_HOTSPOT_ID="DUPLICATE_HOTSPOT_ID",t.INVALID_HOTSPOT_TYPE="INVALID_HOTSPOT_TYPE",t.MISSING_HOTSPOT_LABEL="MISSING_HOTSPOT_LABEL",t.INVALID_HOTSPOT_YAW="INVALID_HOTSPOT_YAW",t.INVALID_HOTSPOT_PITCH="INVALID_HOTSPOT_PITCH",t.MISSING_HOTSPOT_TARGET="MISSING_HOTSPOT_TARGET",t.MISSING_TARGET_MUSEUM_ID="MISSING_TARGET_MUSEUM_ID",t.MISSING_TARGET_SCENE_ID="MISSING_TARGET_SCENE_ID",t.INVALID_TARGET_YAW="INVALID_TARGET_YAW",t.INVALID_TARGET_PITCH="INVALID_TARGET_PITCH",t.INVALID_TARGET_FOV="INVALID_TARGET_FOV",t.MISSING_TARGET_URL="MISSING_TARGET_URL",t))(a||{});function Ue(t){const e=[];if(!t||typeof t!="object")return e.push({code:"INVALID_ROOT",path:"root",message:"é…ç½®å¿…é¡»æ˜¯å¯¹è±¡",fieldName:"é…ç½®æ ¹å¯¹è±¡"}),e;if((!t.appName||typeof t.appName!="string"||t.appName.trim()==="")&&e.push({code:"MISSING_APP_NAME",path:"appName",message:"appName å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",fieldName:"åº”ç”¨åç§°"}),!Array.isArray(t.museums))return e.push({code:"MUSEUMS_NOT_ARRAY",path:"museums",message:"museums å¿…é¡»æ˜¯æ•°ç»„",fieldName:"åšç‰©é¦†åˆ—è¡¨"}),e;t.museums.length===0&&e.push({code:"MUSEUMS_EMPTY",path:"museums",message:"museums æ•°ç»„ä¸èƒ½ä¸ºç©º",fieldName:"åšç‰©é¦†åˆ—è¡¨"});const i=new Set;return t.museums.forEach((n,o)=>{const r=`museums[${o}]`,s=n.name&&typeof n.name=="string"?n.name:void 0;if(!n.id||typeof n.id!="string"||n.id.trim()===""?e.push({code:"MISSING_MUSEUM_ID",path:`${r}.id`,message:"id å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,fieldName:"åšç‰©é¦† ID"}):(i.has(n.id)&&e.push({code:"DUPLICATE_MUSEUM_ID",path:`${r}.id`,message:`åšç‰©é¦† ID "${n.id}" é‡å¤`,museumName:s,fieldName:"åšç‰©é¦† ID"}),i.add(n.id)),(!n.name||typeof n.name!="string"||n.name.trim()==="")&&e.push({code:"MISSING_MUSEUM_NAME",path:`${r}.name`,message:"name å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:void 0,fieldName:"åšç‰©é¦†åç§°"}),(!n.cover||typeof n.cover!="string"||n.cover.trim()==="")&&e.push({code:"MISSING_MUSEUM_COVER",path:`${r}.cover`,message:"cover å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,fieldName:"å°é¢å›¾"}),!n.map||typeof n.map!="object"?e.push({code:"MISSING_MUSEUM_MAP",path:`${r}.map`,message:"map å¿…é¡»æ˜¯å¯¹è±¡",museumName:s,fieldName:"åœ°å›¾é…ç½®"}):((!n.map.image||typeof n.map.image!="string"||n.map.image.trim()==="")&&e.push({code:"MISSING_MAP_IMAGE",path:`${r}.map.image`,message:"map.image å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,fieldName:"åœ°å›¾å›¾ç‰‡"}),(typeof n.map.width!="number"||n.map.width<=0)&&e.push({code:"INVALID_MAP_WIDTH",path:`${r}.map.width`,message:"map.width å¿…é¡»æ˜¯å¤§äº 0 çš„æ•°å­—",museumName:s,fieldName:"åœ°å›¾å®½åº¦"}),(typeof n.map.height!="number"||n.map.height<=0)&&e.push({code:"INVALID_MAP_HEIGHT",path:`${r}.map.height`,message:"map.height å¿…é¡»æ˜¯å¤§äº 0 çš„æ•°å­—",museumName:s,fieldName:"åœ°å›¾é«˜åº¦"})),!Array.isArray(n.scenes))e.push({code:"SCENES_NOT_ARRAY",path:`${r}.scenes`,message:"scenes å¿…é¡»æ˜¯æ•°ç»„",museumName:s,fieldName:"åœºæ™¯åˆ—è¡¨"});else{n.scenes.length===0&&e.push({code:"SCENES_EMPTY",path:`${r}.scenes`,message:"scenes æ•°ç»„ä¸èƒ½ä¸ºç©º",museumName:s,fieldName:"åœºæ™¯åˆ—è¡¨"});const d=new Set;n.scenes.forEach((l,m)=>{var _;const h=`${r}.scenes[${m}]`,p=l.name&&typeof l.name=="string"?l.name:void 0;!l.id||typeof l.id!="string"||l.id.trim()===""?e.push({code:"MISSING_SCENE_ID",path:`${h}.id`,message:"id å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"åœºæ™¯ ID"}):(d.has(l.id)&&e.push({code:"DUPLICATE_SCENE_ID",path:`${h}.id`,message:`åœºæ™¯ ID "${l.id}" åœ¨åšç‰©é¦†å†…é‡å¤`,museumName:s,sceneName:p,fieldName:"åœºæ™¯ ID"}),d.add(l.id)),(!l.name||typeof l.name!="string"||l.name.trim()==="")&&e.push({code:"MISSING_SCENE_NAME",path:`${h}.name`,message:"name å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:void 0,fieldName:"åœºæ™¯åç§°"});const P=!!l.pano,v=!!l.panoLow,M=!!((_=l.panoTiles)!=null&&_.manifest);if(!P&&!v&&!M?e.push({code:"MISSING_PANO",path:`${h}.pano`,message:"pano / panoLow / panoTiles è‡³å°‘éœ€è¦æä¾›ä¸€ä¸ª",museumName:s,sceneName:p,fieldName:"å…¨æ™¯å›¾"}):(l.pano&&(typeof l.pano!="string"||l.pano.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${h}.pano`,message:"pano å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"é«˜æ¸…å…¨æ™¯å›¾"}),l.panoLow&&(typeof l.panoLow!="string"||l.panoLow.trim()==="")&&e.push({code:"INVALID_PANOLOW_URL",path:`${h}.panoLow`,message:"panoLow å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"ä½æ¸…å…¨æ™¯å›¾"}),l.panoTiles&&(typeof l.panoTiles!="object"?e.push({code:"INVALID_PANO_URL",path:`${h}.panoTiles`,message:"panoTiles å¿…é¡»æ˜¯å¯¹è±¡ï¼ŒåŒ…å« manifest",museumName:s,sceneName:p,fieldName:"ç“¦ç‰‡å…ƒæ•°æ®"}):(!l.panoTiles.manifest||typeof l.panoTiles.manifest!="string"||l.panoTiles.manifest.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${h}.panoTiles.manifest`,message:"panoTiles.manifest å¿…é¡»æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"ç“¦ç‰‡ manifest"}))),(!l.thumb||typeof l.thumb!="string"||l.thumb.trim()==="")&&e.push({code:"MISSING_THUMB",path:`${h}.thumb`,message:"thumb å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL å­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"ç¼©ç•¥å›¾"}),!l.initialView||typeof l.initialView!="object"?e.push({code:"MISSING_INITIAL_VIEW",path:`${h}.initialView`,message:"initialView å¿…é¡»æ˜¯å¯¹è±¡",museumName:s,sceneName:p,fieldName:"åˆå§‹è§†è§’"}):(typeof l.initialView.yaw!="number"&&e.push({code:"INVALID_YAW",path:`${h}.initialView.yaw`,message:"initialView.yaw å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"æ°´å¹³è§’åº¦"}),typeof l.initialView.pitch!="number"&&e.push({code:"INVALID_PITCH",path:`${h}.initialView.pitch`,message:"initialView.pitch å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"å‚ç›´è§’åº¦"}),l.initialView.fov!==void 0&&typeof l.initialView.fov!="number"&&e.push({code:"INVALID_FOV",path:`${h}.initialView.fov`,message:"initialView.fov å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"è§†é‡è§’åº¦"})),!l.mapPoint||typeof l.mapPoint!="object"?e.push({code:"MISSING_MAP_POINT",path:`${h}.mapPoint`,message:"mapPoint å¿…é¡»æ˜¯å¯¹è±¡",museumName:s,sceneName:p,fieldName:"åœ°å›¾ç‚¹ä½"}):(typeof l.mapPoint.x!="number"&&e.push({code:"INVALID_MAP_POINT_X",path:`${h}.mapPoint.x`,message:"mapPoint.x å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"åœ°å›¾ç‚¹ä½ X åæ ‡"}),typeof l.mapPoint.y!="number"&&e.push({code:"INVALID_MAP_POINT_Y",path:`${h}.mapPoint.y`,message:"mapPoint.y å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"åœ°å›¾ç‚¹ä½ Y åæ ‡"})),!Array.isArray(l.hotspots))e.push({code:"HOTSPOTS_NOT_ARRAY",path:`${h}.hotspots`,message:"hotspots å¿…é¡»æ˜¯æ•°ç»„",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹åˆ—è¡¨"});else{const f=new Set;l.hotspots.forEach((u,S)=>{const I=`${h}.hotspots[${S}]`;!u.id||typeof u.id!="string"||u.id.trim()===""?e.push({code:"MISSING_HOTSPOT_ID",path:`${I}.id`,message:"id å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ ID"}):(f.has(u.id)&&e.push({code:"DUPLICATE_HOTSPOT_ID",path:`${I}.id`,message:`çƒ­ç‚¹ ID "${u.id}" åœ¨åœºæ™¯å†…é‡å¤`,museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ ID"}),f.add(u.id)),u.type!=="scene"&&u.type!=="video"&&u.type!=="image"&&u.type!=="info"&&e.push({code:"INVALID_HOTSPOT_TYPE",path:`${I}.type`,message:'type å¿…é¡»æ˜¯ "scene"ã€"video"ã€"image" æˆ– "info"',museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ç±»å‹"}),(!u.label||typeof u.label!="string"||u.label.trim()==="")&&e.push({code:"MISSING_HOTSPOT_LABEL",path:`${I}.label`,message:"label å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹æ ‡ç­¾"}),typeof u.yaw!="number"&&e.push({code:"INVALID_HOTSPOT_YAW",path:`${I}.yaw`,message:"yaw å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹æ°´å¹³è§’åº¦"}),typeof u.pitch!="number"&&e.push({code:"INVALID_HOTSPOT_PITCH",path:`${I}.pitch`,message:"pitch å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹å‚ç›´è§’åº¦"}),u.type==="scene"?!u.target||typeof u.target!="object"?e.push({code:"MISSING_HOTSPOT_TARGET",path:`${I}.target`,message:"scene ç±»å‹çƒ­ç‚¹å¿…é¡»æä¾› target å¯¹è±¡",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ç›®æ ‡é…ç½®"}):((!u.target.museumId||typeof u.target.museumId!="string")&&e.push({code:"MISSING_TARGET_MUSEUM_ID",path:`${I}.target.museumId`,message:"scene ç±»å‹çƒ­ç‚¹çš„ target.museumId å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²",museumName:s,sceneName:p,fieldName:"ç›®æ ‡åšç‰©é¦† ID"}),typeof u.target.sceneId!="string"&&e.push({code:"MISSING_TARGET_SCENE_ID",path:`${I}.target.sceneId`,message:"scene ç±»å‹çƒ­ç‚¹çš„ target.sceneId å¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼ˆå…è®¸ç©ºå­—ç¬¦ä¸²ï¼Œç”¨æˆ·åç»­è¡¥å…¨ï¼‰",museumName:s,sceneName:p,fieldName:"ç›®æ ‡åœºæ™¯ ID"}),u.target.yaw!==void 0&&typeof u.target.yaw!="number"&&e.push({code:"INVALID_TARGET_YAW",path:`${I}.target.yaw`,message:"target.yaw å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"ç›®æ ‡æ°´å¹³è§’åº¦"}),u.target.pitch!==void 0&&typeof u.target.pitch!="number"&&e.push({code:"INVALID_TARGET_PITCH",path:`${I}.target.pitch`,message:"target.pitch å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"ç›®æ ‡å‚ç›´è§’åº¦"}),u.target.fov!==void 0&&typeof u.target.fov!="number"&&e.push({code:"INVALID_TARGET_FOV",path:`${I}.target.fov`,message:"target.fov å¿…é¡»æ˜¯æ•°å­—",museumName:s,sceneName:p,fieldName:"ç›®æ ‡è§†é‡è§’åº¦"})):u.type==="video"&&u.target&&typeof u.target!="object"&&e.push({code:"MISSING_HOTSPOT_TARGET",path:`${I}.target`,message:"video ç±»å‹çƒ­ç‚¹çš„ target å¿…é¡»æ˜¯å¯¹è±¡ï¼ˆå¦‚æœæä¾›ï¼‰",museumName:s,sceneName:p,fieldName:"çƒ­ç‚¹ç›®æ ‡é…ç½®"})})}})}}),e}let x=null;async function ee(){if(x)return x;try{const t=await fetch("./config.json",{cache:"no-store"});if(!t.ok)throw new Error(`åŠ è½½é…ç½®å¤±è´¥: ${t.status}`);const e=await t.json(),i=Ue(e);if(i.length>0){const n=new Error("é…ç½®æ ¡éªŒå¤±è´¥");throw n.validationErrors=i,n}return x=e,x}catch(t){throw console.error("åŠ è½½é…ç½®å¤±è´¥:",t),t}}function te(){x=null}function W(t){if(x)return x.museums.find(e=>e.id===t)}function ke(t,e){const i=W(t);if(i)return i.scenes.find(n=>n.id===e)}function fe(t){const e=new URL(window.location.href);return e.search="",Object.entries(t).forEach(([i,n])=>{n!=null&&n!==""&&e.searchParams.set(i,String(n))}),e.pathname+e.search+e.hash}function Ge(){return window.location.pathname}function He(){if(window.location.pathname.includes("//")){const t=window.location.pathname.replace(/\/{2,}/g,"/");history.replaceState({},"",t+window.location.search+window.location.hash)}}let ie=null,ne=0;const Fe=200;function Be(t){if(t.type==="focus"){const e=`${t.museumId}:${t.sceneId}`,i=Date.now();if(e===ie&&i-ne<Fe)return;ie=e,ne=i}window.dispatchEvent(new CustomEvent("vr:scene-focus",{detail:t}))}function Gt(t){const e=i=>{t(i.detail)};return window.addEventListener("vr:scene-focus",e),()=>{window.removeEventListener("vr:scene-focus",e)}}function se(){const t=new URLSearchParams(window.location.search),e=t.get("yaw"),i=t.get("pitch"),n=t.get("fov");return{museumId:t.get("museum")||void 0,sceneId:t.get("scene")||void 0,yaw:e?parseFloat(e):void 0,pitch:i?parseFloat(i):void 0,fov:n?parseFloat(n):void 0}}function $e(){return new URLSearchParams(window.location.search).get("debug")==="1"}function Ye(){const t=new URLSearchParams(window.location.search);return t.get("editor")==="1"||t.get("debug")==="1"}function oe(){const t=Ge();window.history.pushState({},"",t),window.dispatchEvent(new Event("popstate"))}function re(t){const e=fe({museum:t});window.history.pushState({},"",e),window.dispatchEvent(new Event("popstate"))}function F(t,e,i){const n=fe({museum:t,scene:e,yaw:i==null?void 0:i.yaw,pitch:i==null?void 0:i.pitch,fov:i==null?void 0:i.fov});window.history.pushState({},"",n),Be({type:"focus",museumId:t,sceneId:e,source:"dock",ts:Date.now()}),window.dispatchEvent(new Event("popstate"))}function z(){const t=document;return!!(document.fullscreenElement||t.webkitFullscreenElement)}function qe(){const t=()=>{};document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t)}class We{constructor(){c(this,"element");this.element=document.createElement("div"),this.element.className="loading-overlay",this.render(),this.applyStyles();const e=()=>{z()&&this.hide()};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}render(){this.element.innerHTML=`
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">åŠ è½½ä¸­...</p>
      </div>
    `}applyStyles(){const e=document.createElement("style");e.textContent=`
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .loading-overlay.show {
        opacity: 1;
        pointer-events: all;
      }
      .loading-spinner {
        text-align: center;
        color: #fff;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }
      .loading-text {
        font-size: 14px;
        margin: 0;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    `,document.head.appendChild(e)}show(){z()||this.element.classList.add("show")}hide(){this.element.classList.remove("show")}getElement(){return this.element}remove(){this.element.remove()}}const ze={[a.INVALID_ROOT]:"é…ç½®æ ¼å¼é”™è¯¯",[a.MISSING_APP_NAME]:"ç¼ºå°‘åº”ç”¨åç§°",[a.MUSEUMS_NOT_ARRAY]:"åšç‰©é¦†åˆ—è¡¨æ ¼å¼é”™è¯¯",[a.MUSEUMS_EMPTY]:"åšç‰©é¦†åˆ—è¡¨ä¸ºç©º",[a.MISSING_MUSEUM_ID]:"ç¼ºå°‘åšç‰©é¦† ID",[a.DUPLICATE_MUSEUM_ID]:"åšç‰©é¦† ID é‡å¤",[a.MISSING_MUSEUM_NAME]:"ç¼ºå°‘åšç‰©é¦†åç§°",[a.MISSING_MUSEUM_COVER]:"ç¼ºå°‘å°é¢å›¾",[a.MISSING_MUSEUM_MAP]:"ç¼ºå°‘åœ°å›¾é…ç½®",[a.MISSING_MAP_IMAGE]:"ç¼ºå°‘åœ°å›¾å›¾ç‰‡",[a.INVALID_MAP_WIDTH]:"åœ°å›¾å®½åº¦æ— æ•ˆ",[a.INVALID_MAP_HEIGHT]:"åœ°å›¾é«˜åº¦æ— æ•ˆ",[a.SCENES_NOT_ARRAY]:"åœºæ™¯åˆ—è¡¨æ ¼å¼é”™è¯¯",[a.SCENES_EMPTY]:"åœºæ™¯åˆ—è¡¨ä¸ºç©º",[a.MISSING_SCENE_ID]:"ç¼ºå°‘åœºæ™¯ ID",[a.DUPLICATE_SCENE_ID]:"åœºæ™¯ ID é‡å¤",[a.MISSING_SCENE_NAME]:"ç¼ºå°‘åœºæ™¯åç§°",[a.MISSING_PANO]:"ç¼ºå°‘å…¨æ™¯å›¾",[a.INVALID_PANO_URL]:"é«˜æ¸…å…¨æ™¯å›¾ URL æ— æ•ˆ",[a.INVALID_PANOLOW_URL]:"ä½æ¸…å…¨æ™¯å›¾ URL æ— æ•ˆ",[a.MISSING_THUMB]:"ç¼ºå°‘ç¼©ç•¥å›¾",[a.MISSING_INITIAL_VIEW]:"ç¼ºå°‘åˆå§‹è§†è§’é…ç½®",[a.INVALID_YAW]:"æ°´å¹³è§’åº¦æ— æ•ˆ",[a.INVALID_PITCH]:"å‚ç›´è§’åº¦æ— æ•ˆ",[a.INVALID_FOV]:"è§†é‡è§’åº¦æ— æ•ˆ",[a.MISSING_MAP_POINT]:"ç¼ºå°‘åœ°å›¾ç‚¹ä½",[a.INVALID_MAP_POINT_X]:"åœ°å›¾ç‚¹ä½ X åæ ‡æ— æ•ˆ",[a.INVALID_MAP_POINT_Y]:"åœ°å›¾ç‚¹ä½ Y åæ ‡æ— æ•ˆ",[a.HOTSPOTS_NOT_ARRAY]:"çƒ­ç‚¹åˆ—è¡¨æ ¼å¼é”™è¯¯",[a.MISSING_HOTSPOT_ID]:"ç¼ºå°‘çƒ­ç‚¹ ID",[a.DUPLICATE_HOTSPOT_ID]:"çƒ­ç‚¹ ID é‡å¤",[a.INVALID_HOTSPOT_TYPE]:"çƒ­ç‚¹ç±»å‹æ— æ•ˆ",[a.MISSING_HOTSPOT_LABEL]:"ç¼ºå°‘çƒ­ç‚¹æ ‡ç­¾",[a.INVALID_HOTSPOT_YAW]:"çƒ­ç‚¹æ°´å¹³è§’åº¦æ— æ•ˆ",[a.INVALID_HOTSPOT_PITCH]:"çƒ­ç‚¹å‚ç›´è§’åº¦æ— æ•ˆ",[a.MISSING_HOTSPOT_TARGET]:"ç¼ºå°‘çƒ­ç‚¹ç›®æ ‡é…ç½®",[a.MISSING_TARGET_MUSEUM_ID]:"ç¼ºå°‘ç›®æ ‡åšç‰©é¦† ID",[a.MISSING_TARGET_SCENE_ID]:"ç¼ºå°‘ç›®æ ‡åœºæ™¯ ID",[a.INVALID_TARGET_YAW]:"ç›®æ ‡æ°´å¹³è§’åº¦æ— æ•ˆ",[a.INVALID_TARGET_PITCH]:"ç›®æ ‡å‚ç›´è§’åº¦æ— æ•ˆ",[a.INVALID_TARGET_FOV]:"ç›®æ ‡è§†é‡è§’åº¦æ— æ•ˆ",[a.MISSING_TARGET_URL]:"ç¼ºå°‘è§†é¢‘é“¾æ¥"},je={[a.INVALID_ROOT]:"è¯·ç¡®ä¿ config.json æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSON å¯¹è±¡",[a.MISSING_APP_NAME]:'è¯·åœ¨é…ç½®ä¸­æ·»åŠ  "appName" å­—æ®µï¼Œä¾‹å¦‚ï¼š"appName": "æˆ‘çš„ VR å±•é¦†"',[a.MUSEUMS_NOT_ARRAY]:'è¯·ç¡®ä¿ "museums" æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¾‹å¦‚ï¼š"museums": []',[a.MUSEUMS_EMPTY]:'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåšç‰©é¦†åˆ° "museums" æ•°ç»„ä¸­',[a.MISSING_MUSEUM_ID]:'è¯·ä¸ºè¯¥åšç‰©é¦†æ·»åŠ  "id" å­—æ®µï¼Œä¾‹å¦‚ï¼š"id": "museum1"',[a.DUPLICATE_MUSEUM_ID]:'è¯·ç¡®ä¿æ¯ä¸ªåšç‰©é¦†çš„ "id" éƒ½æ˜¯å”¯ä¸€çš„ï¼Œä¸èƒ½é‡å¤',[a.MISSING_MUSEUM_NAME]:'è¯·ä¸ºè¯¥åšç‰©é¦†æ·»åŠ  "name" å­—æ®µï¼Œä¾‹å¦‚ï¼š"name": "ç¬¬ä¸€å±•é¦†"',[a.MISSING_MUSEUM_COVER]:'è¯·ä¸ºè¯¥åšç‰©é¦†æ·»åŠ  "cover" å­—æ®µï¼Œå¡«å…¥å°é¢å›¾çš„ URL',[a.MISSING_MUSEUM_MAP]:'è¯·ä¸ºè¯¥åšç‰©é¦†æ·»åŠ  "map" å¯¹è±¡é…ç½®',[a.MISSING_MAP_IMAGE]:'è¯·åœ¨åœ°å›¾é…ç½®ä¸­æ·»åŠ  "image" å­—æ®µï¼Œå¡«å…¥åœ°å›¾å›¾ç‰‡çš„ URL',[a.INVALID_MAP_WIDTH]:'è¯·ç¡®ä¿ "map.width" æ˜¯ä¸€ä¸ªå¤§äº 0 çš„æ•°å­—',[a.INVALID_MAP_HEIGHT]:'è¯·ç¡®ä¿ "map.height" æ˜¯ä¸€ä¸ªå¤§äº 0 çš„æ•°å­—',[a.SCENES_NOT_ARRAY]:'è¯·ç¡®ä¿ "scenes" æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¾‹å¦‚ï¼š"scenes": []',[a.SCENES_EMPTY]:"è¯·è‡³å°‘ä¸ºè¯¥åšç‰©é¦†æ·»åŠ ä¸€ä¸ªåœºæ™¯",[a.MISSING_SCENE_ID]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "id" å­—æ®µï¼Œä¾‹å¦‚ï¼š"id": "scene1"',[a.DUPLICATE_SCENE_ID]:'è¯·ç¡®ä¿åŒä¸€åšç‰©é¦†å†…æ¯ä¸ªåœºæ™¯çš„ "id" éƒ½æ˜¯å”¯ä¸€çš„',[a.MISSING_SCENE_NAME]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "name" å­—æ®µï¼Œä¾‹å¦‚ï¼š"name": "æ­£é—¨"',[a.MISSING_PANO]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "pano"ã€"panoLow" æˆ– "panoTiles" å­—æ®µï¼Œè‡³å°‘æä¾›ä¸€ç§å…¨æ™¯æ¥æº',[a.INVALID_PANO_URL]:'è¯·ç¡®ä¿ "pano" å­—æ®µæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡ URL å­—ç¬¦ä¸²',[a.INVALID_PANOLOW_URL]:'è¯·ç¡®ä¿ "panoLow" å­—æ®µæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡ URL å­—ç¬¦ä¸²',[a.MISSING_THUMB]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "thumb" å­—æ®µï¼Œå¡«å…¥ç¼©ç•¥å›¾çš„ URL',[a.MISSING_INITIAL_VIEW]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "initialView" å¯¹è±¡é…ç½®',[a.INVALID_YAW]:'è¯·ç¡®ä¿ "initialView.yaw" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆæ°´å¹³è§’åº¦ï¼ŒèŒƒå›´ -180 åˆ° 180ï¼‰',[a.INVALID_PITCH]:'è¯·ç¡®ä¿ "initialView.pitch" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆå‚ç›´è§’åº¦ï¼ŒèŒƒå›´ -90 åˆ° 90ï¼‰',[a.INVALID_FOV]:'è¯·ç¡®ä¿ "initialView.fov" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆè§†é‡è§’åº¦ï¼ŒèŒƒå›´ 30 åˆ° 120ï¼‰',[a.MISSING_MAP_POINT]:'è¯·ä¸ºè¯¥åœºæ™¯æ·»åŠ  "mapPoint" å¯¹è±¡é…ç½®',[a.INVALID_MAP_POINT_X]:'è¯·ç¡®ä¿ "mapPoint.x" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆåœ°å›¾ä¸Šçš„ X åæ ‡ï¼‰',[a.INVALID_MAP_POINT_Y]:'è¯·ç¡®ä¿ "mapPoint.y" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆåœ°å›¾ä¸Šçš„ Y åæ ‡ï¼‰',[a.HOTSPOTS_NOT_ARRAY]:'è¯·ç¡®ä¿ "hotspots" æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¾‹å¦‚ï¼š"hotspots": []',[a.MISSING_HOTSPOT_ID]:'è¯·ä¸ºè¯¥çƒ­ç‚¹æ·»åŠ  "id" å­—æ®µï¼Œä¾‹å¦‚ï¼š"id": "hotspot1"',[a.DUPLICATE_HOTSPOT_ID]:'è¯·ç¡®ä¿åŒä¸€åœºæ™¯å†…æ¯ä¸ªçƒ­ç‚¹çš„ "id" éƒ½æ˜¯å”¯ä¸€çš„',[a.INVALID_HOTSPOT_TYPE]:'è¯·ç¡®ä¿ "type" å­—æ®µæ˜¯ "scene" æˆ– "video" ä¹‹ä¸€',[a.MISSING_HOTSPOT_LABEL]:'è¯·ä¸ºè¯¥çƒ­ç‚¹æ·»åŠ  "label" å­—æ®µï¼Œä¾‹å¦‚ï¼š"label": "è¿›å…¥å±•å…"',[a.INVALID_HOTSPOT_YAW]:'è¯·ç¡®ä¿ "yaw" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆçƒ­ç‚¹åœ¨å…¨æ™¯å›¾ä¸­çš„æ°´å¹³ä½ç½®ï¼‰',[a.INVALID_HOTSPOT_PITCH]:'è¯·ç¡®ä¿ "pitch" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆçƒ­ç‚¹åœ¨å…¨æ™¯å›¾ä¸­çš„å‚ç›´ä½ç½®ï¼‰',[a.MISSING_HOTSPOT_TARGET]:'è¯·ä¸ºè¯¥çƒ­ç‚¹æ·»åŠ  "target" å¯¹è±¡é…ç½®',[a.MISSING_TARGET_MUSEUM_ID]:'åœºæ™¯è·³è½¬ç±»å‹çš„çƒ­ç‚¹å¿…é¡»åŒ…å« "target.museumId" å­—æ®µ',[a.MISSING_TARGET_SCENE_ID]:'åœºæ™¯è·³è½¬ç±»å‹çš„çƒ­ç‚¹å¿…é¡»åŒ…å« "target.sceneId" å­—æ®µ',[a.INVALID_TARGET_YAW]:'è¯·ç¡®ä¿ "target.yaw" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆè·³è½¬åçš„æ°´å¹³è§’åº¦ï¼‰',[a.INVALID_TARGET_PITCH]:'è¯·ç¡®ä¿ "target.pitch" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆè·³è½¬åçš„å‚ç›´è§’åº¦ï¼‰',[a.INVALID_TARGET_FOV]:'è¯·ç¡®ä¿ "target.fov" æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆè·³è½¬åçš„è§†é‡è§’åº¦ï¼‰',[a.MISSING_TARGET_URL]:'è§†é¢‘ç±»å‹çš„çƒ­ç‚¹å¿…é¡»åŒ…å« "target.url" å­—æ®µï¼Œå¡«å…¥è§†é¢‘çš„ URL'};class Xe{constructor(e,i,n){c(this,"element");this.element=document.createElement("div"),this.element.className="config-error-panel",this.render(e,i,n),this.applyStyles()}render(e,i,n){this.element.innerHTML=`
      <div class="error-panel-content">
        <div class="error-panel-header">
          <h2>âš ï¸ é…ç½®é”™è¯¯</h2>
          <p class="error-summary">å‘ç° ${e.length} ä¸ªé…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥ config.json</p>
        </div>
        <div class="error-list">
          ${e.map((s,d)=>this.renderErrorCard(s,d)).join("")}
        </div>
        <div class="error-actions">
          <button class="btn btn-primary" id="retry-btn">ğŸ”„ åˆ·æ–°é‡è¯•</button>
          <button class="btn btn-secondary" id="example-btn">ğŸ“– æŸ¥çœ‹ç¤ºä¾‹é…ç½®</button>
        </div>
      </div>
    `;const o=this.element.querySelector("#retry-btn"),r=this.element.querySelector("#example-btn");o&&o.addEventListener("click",i),r&&r.addEventListener("click",n)}renderErrorCard(e,i){const n=ze[e.code]||"é…ç½®é”™è¯¯",o=je[e.code]||"è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶çš„æ ¼å¼å’Œå†…å®¹",r=[];e.museumName&&r.push(`é¦†ï¼š${e.museumName}`),e.sceneName&&r.push(`åœºæ™¯ï¼š${e.sceneName}`);const s=r.length>0?r.join(" / "):"å…¨å±€é…ç½®";return`
      <div class="error-card">
        <div class="error-card-header">
          <span class="error-icon">âŒ</span>
          <span class="error-title">${this.escapeHtml(n)}</span>
        </div>
        <div class="error-card-body">
          <div class="error-location">
            <span class="location-icon">ğŸ“</span>
            <span class="location-text">${this.escapeHtml(s)}</span>
          </div>
          ${e.fieldName?`
            <div class="error-field">
              <span class="field-label">å­—æ®µï¼š</span>
              <span class="field-name">${this.escapeHtml(e.fieldName)}</span>
            </div>
          `:""}
          <div class="error-path">
            <span class="path-label">æŠ€æœ¯è·¯å¾„ï¼š</span>
            <code class="path-code">${this.escapeHtml(e.path)}</code>
          </div>
          <div class="error-hint">
            <span class="hint-icon">ğŸ’¡</span>
            <span class="hint-text">${this.escapeHtml(o)}</span>
          </div>
        </div>
      </div>
    `}escapeHtml(e){const i=document.createElement("div");return i.textContent=e,i.innerHTML}applyStyles(){const e=document.createElement("style");e.textContent=`
      .config-error-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      }
      .error-panel-content {
        max-width: 800px;
        width: 100%;
        background: #1a1a1a;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      .error-panel-header {
        margin-bottom: 24px;
        text-align: center;
      }
      .error-panel-header h2 {
        font-size: 24px;
        color: #ff6b6b;
        margin-bottom: 8px;
      }
      .error-summary {
        color: #ccc;
        font-size: 14px;
      }
      .error-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 24px;
        background: #0f0f0f;
        border-radius: 8px;
        padding: 16px;
      }
      .error-card {
        padding: 16px;
        margin-bottom: 12px;
        background: #252525;
        border-left: 4px solid #ff6b6b;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .error-card:hover {
        background: #2a2a2a;
      }
      .error-card:last-child {
        margin-bottom: 0;
      }
      .error-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .error-icon {
        font-size: 20px;
      }
      .error-title {
        font-size: 16px;
        font-weight: 600;
        color: #ff6b6b;
      }
      .error-card-body {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .error-location {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #4a90e2;
      }
      .location-icon {
        font-size: 14px;
      }
      .location-text {
        font-weight: 500;
      }
      .error-field {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #ccc;
      }
      .field-label {
        color: #999;
      }
      .field-name {
        color: #ffd93d;
        font-weight: 500;
      }
      .error-path {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        font-size: 12px;
        color: #999;
        margin-top: 4px;
      }
      .path-label {
        color: #666;
        white-space: nowrap;
      }
      .path-code {
        font-family: 'Courier New', monospace;
        color: #888;
        word-break: break-all;
        background: #1a1a1a;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
      }
      .error-hint {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 8px;
        padding: 10px;
        background: #1a1a1a;
        border-radius: 6px;
        border-left: 3px solid #4a90e2;
      }
      .hint-icon {
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 2px;
      }
      .hint-text {
        font-size: 13px;
        color: #ccc;
        line-height: 1.5;
      }
      .error-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }
      .btn-primary {
        background: #4a90e2;
        color: #fff;
      }
      .btn-primary:hover {
        background: #357abd;
      }
      .btn-primary:active {
        transform: scale(0.98);
      }
      .btn-secondary {
        background: #555;
        color: #fff;
      }
      .btn-secondary:hover {
        background: #666;
      }
      .btn-secondary:active {
        transform: scale(0.98);
      }
      @media (max-width: 600px) {
        .error-panel-content {
          padding: 16px;
        }
        .error-actions {
          flex-direction: column;
        }
        .btn {
          width: 100%;
        }
      }
    `,document.head.appendChild(e)}getElement(){return this.element}remove(){this.element.remove()}}var C=(t=>(t.LOADING_LOW="loadingLow",t.LOW_READY="lowReady",t.LOADING_HIGH="loadingHigh",t.HIGH_READY="highReady",t.DEGRADED="degraded",t.ERROR="error",t))(C||{}),Ie=(t=>(t.THUMB="thumb",t.PANO_LOW="panoLow",t.PANO="pano",t.VIDEO="video",t.COVER="cover",t.MAP="map",t.DOLLHOUSE="dollhouse",t))(Ie||{});const Ke=["/assets/panos/"],Qe=[],Je="/config.json",Ze=1800,B="vrplayer.assetCdn.lastSuccess",et=12*60*60*1e3;let H=null,U=null,O="idle",R=0;function tt(t){const e=t.trim();return e?e.startsWith("/")?e:`/${e}`:""}function ae(t,e){const i=Array.isArray(t)&&t.length>0?t:e,n=new Set;for(const o of i){if(typeof o!="string")continue;const r=tt(o);r&&n.add(r)}return Array.from(n)}function ge(t){return t.replace(/\/+$/,"")}function it(t){const e=[];Array.isArray(t.baseUrls)&&e.push(...t.baseUrls),typeof t.baseUrl=="string"&&e.push(t.baseUrl);const i=new Set;for(const n of e){if(typeof n!="string")continue;const o=ge(n.trim());o&&i.add(o)}return Array.from(i)}function nt(){var t;return typeof window<"u"&&((t=window.location)!=null&&t.origin)?window.location.origin:typeof location<"u"&&location.origin?location.origin:null}function K(){if(typeof window>"u")return null;try{return window.localStorage}catch{return null}}function st(t){const e=K();if(!e)return null;try{const i=e.getItem(B);if(!i)return null;const n=JSON.parse(i),o=typeof n.baseUrl=="string"?ge(n.baseUrl.trim()):"",r=typeof n.expiresAt=="number"&&Number.isFinite(n.expiresAt)?n.expiresAt:0;return!o||r<=Date.now()||!t.baseUrls.includes(o)?(e.removeItem(B),null):o}catch{return e.removeItem(B),null}}function ot(t,e){const i=K();if(!i||!e.baseUrls.includes(t))return;const n=Date.now(),o={baseUrl:t,updatedAt:n,expiresAt:n+et};try{i.setItem(B,JSON.stringify(o))}catch{}}function le(){const t=K();if(t)try{t.removeItem(B)}catch{}}function Ee(t){const e=t.match(/^([^?#]*)([?#].*)?$/);return e?{path:e[1]||"",suffix:e[2]||""}:{path:t,suffix:""}}function ce(t,e){return e.some(i=>t.startsWith(i))}function ve(t,e){return!(!ce(t,e.includePrefixes)||ce(t,e.excludePrefixes))}function we(t,e){const{path:i,suffix:n}=Ee(t);return`${e}${i}${n}`}function rt(t,e,i){if(!/^https?:\/\//i.test(t))return null;try{const n=new URL(t),o=nt();return!o||n.origin!==o||!ve(n.pathname,e)?null:we(`${n.pathname}${n.search}${n.hash}`,i)}catch{return null}}function at(t){if(typeof t!="string"||t.trim()==="")return Je;const e=t.trim();return e.startsWith("/")?e:`/${e}`}function lt(t,e){const i=e.includes("?")?"&":"?";return`${t}${e}${i}__cdn_probe=${Date.now()}`}async function ct(t,e,i){if(i!==R||typeof window>"u"||typeof fetch!="function")return!1;const n=typeof AbortController<"u"?new AbortController:null,o=window.setTimeout(()=>n==null?void 0:n.abort(),e.probeTimeoutMs);try{return(await fetch(lt(t,e.probePath),{method:"GET",mode:"cors",cache:"no-store",referrerPolicy:"no-referrer",signal:n==null?void 0:n.signal})).ok}catch{return!1}finally{window.clearTimeout(o)}}function j(t=!1){const e=H;if(!e||!e.enabled||!t&&U||O==="probing")return;if(typeof window>"u"||typeof fetch!="function"){O="failed";return}O="probing";const i=++R;(async()=>{for(const n of e.baseUrls){const o=await ct(n,e,i);if(i!==R)return;if(o){U=n,ot(n,e),O="ok";return}}i===R&&(U=null,le(),O="failed")})().catch(()=>{i===R&&(U=null,le(),O="failed")}).finally(()=>{})}function Y(t){if(R+=1,U=null,O="idle",!t||t.enabled===!1){H=null;return}const e=it(t);if(e.length===0){H=null;return}H={enabled:!0,baseUrls:e,includePrefixes:ae(t.includePrefixes,Ke),excludePrefixes:ae(t.excludePrefixes,Qe),probePath:at(t.probePath),probeTimeoutMs:typeof t.probeTimeoutMs=="number"&&Number.isFinite(t.probeTimeoutMs)?Math.max(200,Math.floor(t.probeTimeoutMs)):Ze};const i=st(H);if(i){U=i,O="ok",j(!0);return}j(!1)}function dt(t,e){if(!t||typeof t!="string"||t.trim()==="")return"";const i=t.trim(),n=H;if(!n||!n.enabled)return i;const o=U;if(!o)return j(),i;const r=rt(i,n,o);if(r)return r;if(i.startsWith("//"))return i;const{path:s}=Ee(i);return!s.startsWith("/")||!ve(s,n)?i:we(i,o)}let V=null;function _e(){return V!==null?V:typeof navigator<"u"&&navigator.maxTouchPoints>0||typeof window<"u"&&("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)?(V="touch",V):(V="mouse",V)}function ut(){return _e()==="touch"}function Se(){return _e()==="mouse"}let k=null;function X(t,e=1500){if(z())return;const i=document.querySelector(".vr-toast"),n=i??document.createElement("div");n.className="vr-toast",n.textContent=t,i||document.body.appendChild(n),window.requestAnimationFrame(()=>n.classList.add("show")),k&&window.clearTimeout(k),k=window.setTimeout(()=>{n.classList.remove("show"),window.setTimeout(()=>n.remove(),220),k=null},e)}function ht(){const t=document.querySelector(".vr-toast");t&&(t.classList.remove("show"),window.setTimeout(()=>t.remove(),220)),k&&(window.clearTimeout(k),k=null)}function mt(){const t=document;return document.fullscreenElement||t.webkitFullscreenElement||null}function Me(){return!!mt()}async function pt(t){const e=t;if(e.requestFullscreen){await e.requestFullscreen();return}if(e.webkitRequestFullscreen){await e.webkitRequestFullscreen();return}throw new Error("Fullscreen API not supported")}async function ft(){const t=document;if(document.exitFullscreen){await document.exitFullscreen();return}if(t.webkitExitFullscreen){await t.webkitExitFullscreen();return}}async function It(t){const e=t||document.body;!Me()&&Se()&&X("é¼ æ ‡æ»‘è‡³æœ€ä¸Šæ–¹å¯é€€å‡ºå…¨å±",700),await pt(e)}async function de(){try{await ft(),ye()}catch(t){console.debug("[fullscreen] exitFullscreenBestEffort failed:",t)}}function ye(){var t,e;try{(e=(t=screen.orientation)==null?void 0:t.unlock)==null||e.call(t)}catch{}}class gt{constructor(e){c(this,"element");c(this,"isOpen",!1);c(this,"options");this.options=e;const i=document.createElement("div");i.className="vr-modal vr-modal--media vr-modal--image";const n=document.createElement("div");n.className="vr-modal-mask",n.addEventListener("click",()=>this.handleClose());const o=document.createElement("div");o.className="vr-modal-card vr-modal-card--media vr-modal-card--image",o.addEventListener("click",h=>h.stopPropagation());const r=document.createElement("div");r.className="vr-modal-header";const s=document.createElement("div");s.className="vr-modal-title",s.textContent=e.title||"å›¾ç‰‡é¢„è§ˆ";const d=document.createElement("button");d.className="vr-btn vr-modal-close-icon",d.setAttribute("aria-label","å…³é—­"),d.textContent="Ã—",d.addEventListener("click",()=>this.handleClose()),r.appendChild(s),r.appendChild(d);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--image";const m=document.createElement("img");m.className="vr-modal-image",e.src&&(m.src=e.src),m.alt=e.title||"çƒ­ç‚¹å›¾ç‰‡",m.loading="lazy",l.appendChild(m),o.appendChild(r),o.appendChild(l),i.appendChild(n),i.appendChild(o),this.element=i}handleClose(){var e,i;this.close(),(i=(e=this.options).onClose)==null||i.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class Et{constructor(e){c(this,"element");c(this,"isOpen",!1);c(this,"options");this.options=e;const i=document.createElement("div");i.className="vr-modal vr-modal--info";const n=document.createElement("div");n.className="vr-modal-mask",n.addEventListener("click",()=>this.handleClose());const o=document.createElement("div");o.className="vr-modal-card vr-modal-card--info",o.addEventListener("click",m=>m.stopPropagation());const r=document.createElement("div");r.className="vr-modal-header";const s=document.createElement("div");s.className="vr-modal-title",s.textContent=e.title||"è¯¦æƒ…";const d=document.createElement("button");d.className="vr-btn vr-modal-close-icon",d.setAttribute("aria-label","å…³é—­"),d.textContent="Ã—",d.addEventListener("click",()=>this.handleClose()),r.appendChild(s),r.appendChild(d);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--info",l.textContent=e.text||"æœªé…ç½®å†…å®¹",o.appendChild(r),o.appendChild(l),i.appendChild(n),i.appendChild(o),this.element=i}handleClose(){var e,i;this.close(),(i=(e=this.options).onClose)==null||i.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class vt{constructor(e){c(this,"element");c(this,"isOpen",!1);c(this,"videoEl");c(this,"options");this.options=e;const i=document.createElement("div");i.className="vr-modal vr-modal--media vr-modal--video";const n=document.createElement("div");n.className="vr-modal-mask",n.addEventListener("click",()=>this.handleClose());const o=document.createElement("div");o.className="vr-modal-card vr-modal-card--media vr-modal-card--video",o.addEventListener("click",h=>h.stopPropagation());const r=document.createElement("div");r.className="vr-modal-header";const s=document.createElement("div");s.className="vr-modal-title",s.textContent=e.title||"è§†é¢‘";const d=document.createElement("button");d.className="vr-btn vr-modal-close-icon",d.setAttribute("aria-label","å…³é—­"),d.textContent="Ã—",d.addEventListener("click",()=>this.handleClose()),r.appendChild(s),r.appendChild(d);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--video";const m=document.createElement("video");m.className="vr-modal-video",e.src&&(m.src=e.src),e.poster&&(m.poster=e.poster),m.controls=!0,m.playsInline=!0,m.preload="metadata",this.videoEl=m,l.appendChild(m),o.appendChild(r),o.appendChild(l),i.appendChild(n),i.appendChild(o),this.element=i}handleClose(){var e,i;this.close(),(i=(e=this.options).onClose)==null||i.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){if(this.isOpen){this.isOpen=!1,this.element.classList.remove("open");try{this.videoEl.pause(),this.videoEl.currentTime=0,this.videoEl.removeAttribute("src"),this.videoEl.load()}catch{}}}getElement(){return this.element}destroy(){this.close(),this.element.remove()}}const Te="vr:open-modal",Ne="vr:close-modal";function Ht(t){window.dispatchEvent(new CustomEvent(Te,{detail:t}))}function q(){window.dispatchEvent(new CustomEvent(Ne))}class wt{constructor(e){c(this,"rootEl");c(this,"current",null);c(this,"handleKeyDownBound");this.rootEl=e,this.handleKeyDownBound=i=>this.handleKeyDown(i),window.addEventListener(Te,i=>{const n=i;this.handleOpen(n.detail)}),window.addEventListener(Ne,()=>this.close()),window.addEventListener("keydown",this.handleKeyDownBound)}handleKeyDown(e){e.key==="Escape"&&this.close()}handleOpen(e){this.close();let i=null;e.type==="image"?i=new gt({src:e.payload.src,title:e.payload.title,onClose:()=>q()}):e.type==="info"?i=new Et({title:e.payload.title,text:e.payload.text,onClose:()=>q()}):e.type==="video"&&(i=new vt({src:e.payload.src,poster:e.payload.poster,title:e.payload.title,onClose:()=>q()})),i&&(this.current=i,this.rootEl.innerHTML="",this.rootEl.appendChild(i.getElement()),i.open())}close(){this.current&&(this.current.close(),this.current.destroy(),this.current=null,this.rootEl.innerHTML="")}}let ue=null;function _t(){if(ue)return;let t=document.getElementById("vr-modal-root");t||(t=document.createElement("div"),t.id="vr-modal-root",document.body.appendChild(t)),ue=new wt(t)}function St(t,e,i){const n=t.getBoundingClientRect(),o=e-n.left,r=i-n.top,s=document.createElement("div");s.className="vr-pick-marker",s.style.position="absolute",s.style.left="0",s.style.top="0",s.style.transform=`translate3d(${o}px, ${r}px, 0)`,s.style.pointerEvents="none",s.style.zIndex="1000",t.style.position="relative",t.appendChild(s),window.requestAnimationFrame(()=>{s.classList.add("show")}),window.setTimeout(()=>{s.classList.remove("show"),window.setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},200)},1500)}const Pe="vr_last_pick_v1";let Q=null;function Mt(){try{const t=localStorage.getItem(Pe);if(t){const e=JSON.parse(t);typeof e.yaw=="number"&&typeof e.pitch=="number"&&typeof e.ts=="number"&&(Q=e)}}catch{}}Mt();function yt(t){Q=t;try{localStorage.setItem(Pe,JSON.stringify(t))}catch{}}function Ft(){return Q}class Tt{constructor(){c(this,"listeners",new Map);c(this,"lastInteractionTs",0);c(this,"idleDelay",800);c(this,"idleTimer",null);c(this,"rafId",null);c(this,"isScheduled",!1);this.listeners.set("user-interacting",new Set),this.listeners.set("user-idle",new Set),this.listeners.set("ui-engaged",new Set)}on(e,i){const n=this.listeners.get(e);return n?(n.add(i),()=>{n.delete(i)}):(console.warn(`[InteractionBus] æœªçŸ¥äº‹ä»¶ç±»å‹: ${e}`),()=>{})}off(e,i){const n=this.listeners.get(e);n&&n.delete(i)}emit(e){this.isScheduled||(this.isScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.isScheduled=!1;const i=this.listeners.get(e);i&&i.forEach(n=>{try{n()}catch(o){console.error("[InteractionBus] äº‹ä»¶ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥:",o)}})}))}emitInteracting(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("user-interacting")}scheduleIdle(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.idleTimer=window.setTimeout(()=>{Date.now()-this.lastInteractionTs>=this.idleDelay&&(this.idleTimer=null,this.emit("user-idle"))},this.idleDelay)}emitUIEngaged(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("ui-engaged")}dispose(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.listeners.forEach(e=>e.clear()),this.listeners.clear()}}const G=new Tt,Nt=150,Pt=150,bt=400;function Lt(){return{fadeMs:Nt,restoreMs:Pt,restoreDelayMs:bt}}function At(){G.on("user-interacting",()=>{}),G.on("user-idle",()=>{}),G.on("ui-engaged",()=>{})}let L=null;function Dt(){const t=Lt();G.on("user-interacting",()=>{L!==null&&(clearTimeout(L),L=null),document.documentElement.classList.add("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")}),G.on("user-idle",()=>{L!==null&&(clearTimeout(L),L=null),document.documentElement.classList.remove("vr-ui-interacting"),L=window.setTimeout(()=>{document.documentElement.classList.remove("vr-ui-restoring"),L=null},t.restoreDelayMs)}),G.on("ui-engaged",()=>{L!==null&&(clearTimeout(L),L=null),document.documentElement.classList.remove("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")})}const y=typeof window<"u"?new URLSearchParams(window.location.search).get("debug")==="1":!1;function Bt(...t){y&&console.debug("[VR Debug]",...t)}function Vt(){const t={};try{const e=new URLSearchParams(window.location.search),i=e.get("museum"),n=e.get("scene");i&&(t.museumId=i),n&&(t.currentSceneId=n)}catch{}try{const e=document.querySelector(".vr-groundnav");if(e){t.groundNavDots={};const i=e.querySelector(".vr-groundnav__dot.is-aimed");i&&(t.groundNavDots.aimedSceneId=i.getAttribute("data-scene-id")||void 0);const n=e.querySelector(".vr-groundnav__dot.is-autonav");if(n){t.groundNavDots.isAutoNavActive=!0,t.groundNavDots.autoNavTargetSceneId=n.getAttribute("data-scene-id")||void 0;const o=n.querySelector(".vr-groundnav__progress");t.groundNavDots.hasProgressElement=!!o}}}catch{}try{const e=document.querySelector(".vr-previewcard");if(e){t.scenePreviewCard={},t.scenePreviewCard.isVisible=e.classList.contains("is-visible");const i=e.querySelector(".vr-previewcard__hint");i&&(t.scenePreviewCard.hintVisible=i.classList.contains("is-visible"),t.scenePreviewCard.hintEmphasizing=i.classList.contains("is-emphasizing"))}}catch{}try{const e=document.querySelector(".vr-scenestrip");e&&(t.sceneStrip={},t.sceneStrip.userScrolling=e.classList.contains("is-user-scrolling"))}catch{}try{const e=document.documentElement,i=Array.from(e.classList).filter(n=>n==="vr-ui-interacting"||n==="vr-ui-restoring");i.length>0&&(t.yieldClassManager={classes:i})}catch{}return t}function Ct(t){try{window.dispatchEvent(new CustomEvent("vr:close-panels"))}catch{}try{t?(t.emitInteracting(),setTimeout(()=>{try{document.documentElement.classList.remove("vr-ui-interacting","vr-ui-restoring")}catch{}},100)):document.documentElement.classList.remove("vr-ui-interacting","vr-ui-restoring")}catch{}}function Ot(){var t;return!!(document.querySelector(".vr-modal-overlay")||document.querySelector(".vr-guide-drawer.open")||document.querySelector(".fcchat-root")&&((t=document.querySelector(".fcchat-root"))==null?void 0:t.style.display)==="flex")}function he(){Ot()?document.documentElement.classList.add("vr-overlay-open"):document.documentElement.classList.remove("vr-overlay-open")}function me(t){const{title:e,contentEl:i,contentHtml:n,onClose:o,panelClassName:r}=t,s=document.createElement("div");s.className="vr-modal-overlay";const d=document.createElement("div");d.className="vr-modal-panel",r&&d.classList.add(r);const l=document.createElement("div");l.className="vr-modal-header";const m=document.createElement("div");m.className="vr-modal-header-title",m.textContent=e;const h=document.createElement("button");h.className="vr-modal-header-close vr-icon-btn",h.type="button",h.setAttribute("aria-label","å…³é—­å¼¹çª—"),h.innerHTML="Ã—",l.appendChild(m),l.appendChild(h);const p=document.createElement("div");p.className="vr-modal-body",i?p.appendChild(i):n&&(p.innerHTML=n),d.appendChild(l),d.appendChild(p),s.appendChild(d),document.body.appendChild(s),he(),r==="vr-modal-settings"&&(document.documentElement.classList.add("vr-more-open"),requestAnimationFrame(()=>{d.classList.add("is-in")}));let P=!1;const v=u=>{u.key==="Escape"&&(u.stopPropagation(),f.close())},M=u=>{u.target===s&&f.close()},_=u=>{u.preventDefault(),u.stopPropagation(),f.close()};window.addEventListener("keydown",v),s.addEventListener("click",M),h.addEventListener("click",_);const f={close:()=>{if(!P&&(P=!0,window.removeEventListener("keydown",v),s.removeEventListener("click",M),h.removeEventListener("click",_),s.parentNode&&s.parentNode.removeChild(s),r==="vr-modal-settings"&&document.documentElement.classList.remove("vr-more-open"),he(),o))try{o()}catch{}}};return f}const be="vr_quality";function pe(){if(typeof window>"u")return"high";try{const t=window.localStorage.getItem(be);if(t==="low"||t==="high")return t}catch{}return"high"}function Rt(t){if(!(typeof window>"u"))try{window.localStorage.setItem(be,t)}catch{}}y&&(window.__vrDump=()=>{const t=Vt();return console.debug("[VR State Snapshot]",t),t},window.__vrResetUI=()=>{console.debug("[VR Reset UI] å§ï½…æ¹ªå¨“å‘¯æ‚Šéµâ‚¬éˆ?UI é˜èˆµâ‚¬?.."),Ct(G),console.debug("[VR Reset UI] å¨“å‘¯æ‚Šç€¹å±¾åš")},console.debug("[VR Debug] ç’‹å†­ç˜¯å¦¯â€³ç´¡å®¸æ’æƒé¢ã„£â‚¬å‚™å¨‡é¢?__vrDump() éŒãƒ§æ¹…é˜èˆµâ‚¬ä¾Šç´æµ£è·¨æ•¤ __vrResetUI() æ¾¶å¶„ç¶… UI"));He();At();Dt();qe();const Le=()=>{const t=document;!!(document.fullscreenElement||t.webkitFullscreenElement)&&ht()};document.addEventListener("fullscreenchange",Le);document.addEventListener("webkitfullscreenchange",Le);function xt(){const t=new URLSearchParams(location.search);return t.has("development")||t.get("dev")==="1"||location.hash.includes("development")}class Ut{constructor(){c(this,"appElement");c(this,"config",null);c(this,"panoViewer",null);c(this,"titleBar",null);c(this,"topRightControls",null);c(this,"topModeTabs",null);c(this,"sceneTitleEl",null);c(this,"brandMark",null);c(this,"bottomDock",null);c(this,"sceneGuideDrawer",null);c(this,"guideTray",null);c(this,"museumList",null);c(this,"sceneListPage",null);c(this,"hotspots",null);c(this,"videoPlayer",null);c(this,"loading");c(this,"debugPanel",null);c(this,"configStudio",null);c(this,"qualityIndicator",null);c(this,"northCalibrationPanel",null);c(this,"currentMuseum",null);c(this,"currentScene",null);c(this,"hasBoundFullscreenEvents",!1);c(this,"mode","tour");c(this,"isStructureOverlayOpen",!1);c(this,"structureView2D",null);c(this,"structureView3D",null);c(this,"fcChatPanel",null);c(this,"infoModalMounted",null);c(this,"settingsModalMounted",null);c(this,"handlePopState",null);c(this,"handlePickEvent",null);c(this,"handlePickModeEvent",null);c(this,"handleMetricsEvent",null);c(this,"debugPanelRafId",null);c(this,"structure3DLoadToken",0);c(this,"chatInitToken",0);c(this,"chatFirstInteractionHandler",null);c(this,"panoViewerModulePromise",null);c(this,"topRightControlsModulePromise",null);c(this,"brandMarkModulePromise",null);c(this,"structureView2DModulePromise",null);c(this,"titleBarModulePromise",null);c(this,"museumListModulePromise",null);c(this,"sceneListPageModulePromise",null);c(this,"sceneGraphModulePromise",null);c(this,"vrModeModulePromise",null);c(this,"vrModeInitialized",!1);c(this,"externalImageModulePromise",null);c(this,"uiErrorElement",null);const e=document.getElementById("app");if(!e)throw new Error("éµå¥ç¬‰é’?#app éå†ªç¤Œ");this.appElement=e,_t(),this.loading=new We,this.appElement.appendChild(this.loading.getElement()),this.bindFullscreenEventsOnce(),this.init()}bindFullscreenEventsOnce(){if(this.hasBoundFullscreenEvents)return;this.hasBoundFullscreenEvents=!0;const e=()=>{var i;(i=this.topRightControls)==null||i.syncFullscreenState(),Me()||(this.topRightControls&&this.topRightControls.updateVrModeState(!1),this.panoViewer&&this.panoViewer.isVrModeEnabled()&&this.panoViewer.setVrModeEnabled(!1),ye())};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}loadPanoViewerModule(){return this.panoViewerModulePromise||(this.panoViewerModulePromise=E(()=>import("./PanoViewer-Cbb_h-Mp.js").then(e=>e.P),__vite__mapDeps([0,1,2]),import.meta.url)),this.panoViewerModulePromise}loadTopRightControlsModule(){return this.topRightControlsModulePromise||(this.topRightControlsModulePromise=E(()=>import("./TopRightControls-6XAuokCh.js"),[],import.meta.url)),this.topRightControlsModulePromise}loadBrandMarkModule(){return this.brandMarkModulePromise||(this.brandMarkModulePromise=E(()=>import("./BrandMark-Nq8Jicrt.js"),__vite__mapDeps([3,4]),import.meta.url)),this.brandMarkModulePromise}loadStructureView2DModule(){return this.structureView2DModulePromise||(this.structureView2DModulePromise=E(()=>import("./StructureView2D-BwVOD4qj.js"),__vite__mapDeps([5,6]),import.meta.url)),this.structureView2DModulePromise}loadTitleBarModule(){return this.titleBarModulePromise||(this.titleBarModulePromise=E(()=>import("./TitleBar-DAY6bVbi.js"),[],import.meta.url)),this.titleBarModulePromise}loadMuseumListModule(){return this.museumListModulePromise||(this.museumListModulePromise=E(()=>import("./MuseumList-CZ7n8425.js"),[],import.meta.url)),this.museumListModulePromise}loadSceneListPageModule(){return this.sceneListPageModulePromise||(this.sceneListPageModulePromise=E(()=>import("./SceneListPage-CzdTutU9.js"),[],import.meta.url)),this.sceneListPageModulePromise}loadSceneGraphModule(){return this.sceneGraphModulePromise||(this.sceneGraphModulePromise=E(()=>import("./sceneGraph-CaQzl5R8.js"),[],import.meta.url)),this.sceneGraphModulePromise}loadVrModeModule(){return this.vrModeModulePromise||(this.vrModeModulePromise=E(()=>import("./vrMode-Cc2vz0Ot.js"),__vite__mapDeps([7,1]),import.meta.url)),this.vrModeModulePromise}async ensureVrModeInitialized(){const e=await this.loadVrModeModule();return this.vrModeInitialized||(e.initVrMode(),this.vrModeInitialized=!0),e}async resolveProxiedImageUrl(e){this.externalImageModulePromise||(this.externalImageModulePromise=E(()=>import("./externalImage-DivuH3Vy.js"),[],import.meta.url));try{const{toProxiedImageUrl:i}=await this.externalImageModulePromise;return i(e)}catch{return e}}async init(){try{if(this.loading.show(),Ye()){await this.initEditorMode(),this.loading.hide();return}this.config=await ee(),Y(this.config.assetCdn),this.titleBar&&this.titleBar.setTitle(this.config.appName),this.handlePopState||(this.handlePopState=()=>{this.handleRoute()},window.addEventListener("popstate",this.handlePopState)),await this.handleRoute(),this.loading.hide()}catch(e){console.error("é–°å¶‡ç–†é”çŠºæµ‡æ¾¶è¾«è§¦:",e),this.loading.hide(),e.validationErrors&&Array.isArray(e.validationErrors)?this.showConfigErrorPanel(e.validationErrors):this.showError("é”çŠºæµ‡é–°å¶‡ç–†æ¾¶è¾«è§¦é”›å²ƒî‡¬é’é”‹æŸŠæ¤¤ç”¸æ½°é–²å¶ˆç˜¯")}}async initEditorMode(){try{this.config=await ee(),Y(this.config.assetCdn),this.appElement.innerHTML="";const{ConfigStudio:e}=await E(async()=>{const{ConfigStudio:i}=await import("./editor-debug-D38_KtBl.js").then(n=>n.C);return{ConfigStudio:i}},__vite__mapDeps([8,9,4]),import.meta.url);this.configStudio=new e(this.config,i=>{this.config=i,Y(i.assetCdn),te()}),this.appElement.appendChild(this.configStudio.getElement())}catch(e){console.error("é’æ¿†îé–æ «ç´ªæˆæˆæ«’å¦¯â€³ç´¡æ¾¶è¾«è§¦:",e),e.validationErrors&&Array.isArray(e.validationErrors)?this.showConfigErrorPanel(e.validationErrors):this.showError("é”çŠºæµ‡é–°å¶‡ç–†æ¾¶è¾«è§¦é”›å²ƒî‡¬é’é”‹æŸŠæ¤¤ç”¸æ½°é–²å¶ˆç˜¯")}}showConfigErrorPanel(e){this.appElement.innerHTML="";const i=new Xe(e,()=>{te(),window.location.reload()},()=>{this.showConfigExample()});this.appElement.appendChild(i.getElement())}showConfigExample(){const e=window.open("","_blank");e&&e.document.write(`
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>config.json ç»€è½°ç·¥</title>
          <style>
            body {
              font-family: 'Courier New', monospace;
              padding: 20px;
              background: #1a1a1a;
              color: #fff;
            }
            pre {
              background: #0f0f0f;
              padding: 20px;
              border-radius: 8px;
              overflow-x: auto;
            }
            code {
              color: #4a90e2;
            }
          </style>
        </head>
        <body>
          <h1>config.json ç»€è½°ç·¥é–°å¶‡ç–†</h1>
          <pre><code>{
  "appName": "æ´æ—‚æ•¤éšå¶‡Ğ",
  "museums": [
    {
      "id": "museum_id",
      "name": "çæ›¢î›«éšå¶‡Ğ",
      "cover": "https://example.com/cover.jpg",
      "map": {
        "image": "https://example.com/map.jpg",
        "width": 1000,
        "height": 600
      },
      "scenes": [
        {
          "id": "scene_id",
          "name": "é¦çƒ˜æ«™éšå¶‡Ğ",
          "panoLow": "https://example.com/pano-low.jpg",
          "pano": "https://example.com/pano.jpg",
          "thumb": "https://example.com/thumb.jpg",
          "initialView": {
            "yaw": 0,
            "pitch": 0,
            "fov": 75
          },
          "mapPoint": {
            "x": 420,
            "y": 310
          },
          "hotspots": [
            {
              "id": "hotspot_id",
              "type": "scene",
              "label": "é‘î… å£éå›©î„·",
              "yaw": 35,
              "pitch": -5,
              "target": {
                "museumId": "museum_id",
                "sceneId": "target_scene_id",
                "yaw": 120,
                "pitch": 0
              }
            }
          ]
        }
      ]
    }
  ]
}</code></pre>
          <p>ç’‡ï¸¾ç²é–°å¶‡ç–†ç’‡å­˜æ§‘ç’‡é”‹ç…¡éª?README.md</p>
        </body>
        </html>
      `)}async handleRoute(){if(!this.config)return;const e=se();if(e.sceneId&&(this.loadPanoViewerModule(),this.loadTopRightControlsModule(),this.loadBrandMarkModule()),this.clearView(),!e.museumId){const i=this.config.museums.find(n=>n.id==="wangding")||this.config.museums[0];if(i){if(i.scenes&&i.scenes.length>0){F(i.id,i.scenes[0].id);return}re(i.id);return}}if(!e.museumId)await this.showMuseumList();else if(e.sceneId){const i=W(e.museumId),n=ke(e.museumId,e.sceneId);i&&n?await this.showScene(i,n):(this.showError("éˆî…å£˜é’ç‰ˆå¯šç€¹æ°±æ®‘é¦çƒ˜æ«™"),i?re(i.id):oe())}else{const i=W(e.museumId);i?await this.showSceneList(i):(this.showError("éˆî…å£˜é’ç‰ˆå¯šç€¹æ°±æ®‘çæ›¢î›«"),oe())}}async showMuseumList(){if(!this.config)return;const[{TitleBar:e},{MuseumList:i}]=await Promise.all([this.loadTitleBarModule(),this.loadMuseumListModule()]);this.titleBar=new e(this.config.appName),this.appElement.appendChild(this.titleBar.getElement()),this.museumList=new i(this.config.museums),this.appElement.appendChild(this.museumList.getElement())}async showSceneList(e){const{TitleBar:i}=await this.loadTitleBarModule();this.titleBar=new i(e.name),this.appElement.appendChild(this.titleBar.getElement());const{SceneListPage:n}=await this.loadSceneListPageModule();this.sceneListPage=new n(e),this.appElement.appendChild(this.sceneListPage.getElement())}async showScene(e,i){var _;this.currentMuseum=e,this.currentScene=i,this.loading.show();const n=document.createElement("div");n.className="viewer-container",n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    `,this.appElement.appendChild(n);const o=$e(),{PanoViewer:r}=await this.loadPanoViewerModule();this.panoViewer=new r(n,o);const s=xt();if(this.mountTopRightControls(n,i,s),this.sceneTitleEl=document.createElement("div"),this.sceneTitleEl.className="vr-scenetitle",this.sceneTitleEl.textContent=i.name||((_=this.config)==null?void 0:_.appName)||"VR Player",this.appElement.appendChild(this.sceneTitleEl),this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickEvent=f=>{const u=f,{x:S,y:I,yaw:T,pitch:N}=u.detail;if(yt({yaw:T,pitch:N,ts:Date.now()}),X(`å®¸æ’î˜²é’?yaw: ${T.toFixed(2)}, pitch: ${N.toFixed(2)}`),this.panoViewer){const b=this.panoViewer.getDomElement();St(b,S,I)}},window.addEventListener("vr:pick",this.handlePickEvent),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.handlePickModeEvent=f=>{const u=f;this.panoViewer&&!u.detail.enabled&&this.panoViewer.isPickModeEnabled()&&this.panoViewer.disablePickMode()},window.addEventListener("vr:pickmode",this.handlePickModeEvent),this.mountBrandMark(),o){const{DebugPanel:f}=await E(async()=>{const{DebugPanel:S}=await import("./editor-debug-D38_KtBl.js").then(I=>I.D);return{DebugPanel:S}},__vite__mapDeps([8,9,4]),import.meta.url);this.debugPanel=new f,this.appElement.appendChild(this.debugPanel.getElement()),this.panoViewer.setOnDebugClick((S,I,T,N,b)=>{this.debugPanel&&this.debugPanel.show(S,I,T,N,b)}),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null);const u=()=>{if(this.debugPanel&&this.panoViewer){const S=this.panoViewer.getCurrentView();this.debugPanel.updateView(S.yaw,S.pitch,S.fov)}this.debugPanelRafId=requestAnimationFrame(u)};u()}let d=!1,l=!1;const m=async()=>{if(!(d||l)&&this.panoViewer&&!(!this.currentScene||this.currentScene.id!==i.id)){l=!0;try{const[{VideoPlayer:f},{GuideTray:u},{SceneGuideDrawer:S},{BottomDock:I},{TopModeTabs:T},{Hotspots:N},{QualityIndicator:b}]=await Promise.all([E(()=>import("./VideoPlayer-o9eYCYTr.js"),[],import.meta.url),E(()=>import("./GuideTray-BRkfOiRV.js"),__vite__mapDeps([10,2]),import.meta.url),E(()=>import("./SceneGuideDrawer-mi82QjLI.js"),__vite__mapDeps([11,2,12]),import.meta.url),E(()=>import("./BottomDock-D4sOtWv_.js"),__vite__mapDeps([13,12]),import.meta.url),E(()=>import("./TopModeTabs-psisWFio.js"),[],import.meta.url),E(()=>import("./Hotspots-BZpbd_r9.js"),__vite__mapDeps([14,1]),import.meta.url),E(()=>import("./QualityIndicator-DDawM8tU.js"),[],import.meta.url)]);if(d||!this.panoViewer||!this.currentScene||this.currentScene.id!==i.id)return;d=!0;try{this.videoPlayer=new f,this.appElement.appendChild(this.videoPlayer.getElement())}catch(g){y&&console.debug("[showScene] VideoPlayer é’æ¶˜ç¼“æ¾¶è¾«è§¦é”›å²ƒçƒ¦æ©?",g),this.videoPlayer=null}try{this.guideTray=new u({museumId:e.id,currentSceneId:i.id,scenes:e.scenes,onSceneClick:g=>{F(e.id,g)},onMoreClick:()=>{if(!this.sceneGuideDrawer)try{this.sceneGuideDrawer=new S({museumId:e.id,currentSceneId:i.id,scenes:e.scenes,onClose:()=>{}}),this.appElement.appendChild(this.sceneGuideDrawer.getElement())}catch(g){y&&console.debug("[GuideTray] SceneGuideDrawer é’æ¶˜ç¼“æ¾¶è¾«è§¦:",g)}this.guideTray&&this.guideTray.setVisible(!1),this.sceneGuideDrawer&&this.sceneGuideDrawer.open()},onClose:()=>{this.guideTray&&this.guideTray.setVisible(!1),window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"guide"}}))}}),this.guideTray.setVisible(!1),this.appElement.appendChild(this.guideTray.getElement())}catch(g){y&&console.debug("[showScene] GuideTray é’æ¶˜ç¼“æ¾¶è¾«è§¦é”›å²ƒçƒ¦æ©?",g),this.guideTray=null}try{this.bottomDock=new I({onGuideClick:()=>{this.guideTray&&this.guideTray.setVisible(!0)},onOpenInfo:()=>this.openInfoModal(),onOpenSettings:()=>this.openSettingsModal(),sceneId:i.id,sceneName:i.name,museum:e,scenes:e.scenes,currentSceneId:i.id}),this.appElement.appendChild(this.bottomDock.getElement())}catch(g){y&&console.debug("[showScene] BottomDock é’æ¶˜ç¼“æ¾¶è¾«è§¦é”›å²ƒçƒ¦æ©?",g),this.bottomDock=null}try{this.topModeTabs=new T({initialMode:this.mode,onModeChange:g=>{this.setMode(g)}}),this.appElement.appendChild(this.topModeTabs.getElement())}catch(g){y&&console.debug("[showScene] TopModeTabs é’æ¶˜ç¼“æ¾¶è¾«è§¦é”›å²ƒçƒ¦æ©?",g),this.topModeTabs=null}try{const g=new Map(e.scenes.map(A=>[A.id,A.name]));this.hotspots=new N(this.panoViewer,i.hotspots,{resolveSceneName:A=>g.get(A),onEnterScene:A=>{F(e.id,A)},museumId:e.id}),n.appendChild(this.hotspots.getElement())}catch(g){y&&console.debug("[showScene] Hotspots é’æ¶˜ç¼“æ¾¶è¾«è§¦é”›å²ƒçƒ¦æ©?",g),this.hotspots=null}try{this.qualityIndicator=new b,this.appElement.appendChild(this.qualityIndicator.getElement()),this.panoViewer&&this.qualityIndicator.updateStatus(this.panoViewer.getLoadStatus())}catch(g){y&&console.debug("[showScene] QualityIndicator é’æ¶˜ç¼“æ¾¶è¾«è§¦é”›å²ƒçƒ¦æ©?",g),this.qualityIndicator=null}this.handleMetricsEvent&&(window.removeEventListener("vr:metrics",this.handleMetricsEvent),this.handleMetricsEvent=null),this.handleMetricsEvent=g=>{if(!this.qualityIndicator)return;const A=g.detail||{};this.qualityIndicator.updateMetrics(A)},window.addEventListener("vr:metrics",this.handleMetricsEvent)}finally{l=!1}}};this.panoViewer.setOnStatusChange(f=>{this.qualityIndicator&&this.qualityIndicator.updateStatus(f),!d&&(f===C.LOW_READY||f===C.HIGH_READY||f===C.DEGRADED)&&window.setTimeout(()=>{m()},0),(f===C.LOW_READY||f===C.HIGH_READY||f===C.DEGRADED)&&this.loading.hide()}),this.panoViewer.setOnLoad(()=>{m(),this.loading.hide(),this.hideUIError(),this.preloadNextScene(e,i)}),this.panoViewer.setOnError(f=>{console.error("é”çŠºæµ‡é¦çƒ˜æ«™æ¾¶è¾«è§¦:",f),this.loading.hide(),this.showError("åŠ è½½å…¨æ™¯å›¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"),this.qualityIndicator&&this.qualityIndicator.updateStatus(C.ERROR)});const h=se(),p=h.yaw!==void 0?h.yaw:i.initialView.yaw||0,P=h.pitch!==void 0?h.pitch:i.initialView.pitch||0,v=h.fov!==void 0?h.fov:i.initialView.fov||75,M=-p;this.panoViewer.setView(M,P,v),this.panoViewer.loadScene(i),this.panoViewer.setSceneData(e.id,i.id,i.hotspots),this.setupChatOnFirstInteraction(e,i)}async mountTopRightControls(e,i,n){var o;try{const{TopRightControls:r}=await this.loadTopRightControlsModule();if(!this.panoViewer||!this.currentScene||this.currentScene.id!==i.id)return;(o=this.topRightControls)==null||o.remove(),this.topRightControls=new r({viewerRootEl:e,onTogglePickMode:n?()=>this.panoViewer?(this.panoViewer.isPickModeEnabled()?this.panoViewer.disablePickMode():this.panoViewer.enablePickMode(),this.panoViewer.isPickModeEnabled()):!1:void 0,onOpenNorthCalibration:n?()=>{this.openNorthCalibration(i.id)}:void 0,showNorthCalibration:n,onToggleVrMode:async()=>this.toggleVrModeFromUI(e)}),this.appElement.appendChild(this.topRightControls.getElement())}catch(r){y&&console.debug("[showScene] TopRightControls é’æ¶˜ç¼“æ¾¶è¾«è§¦é”›å²ƒçƒ¦æ©?",r),this.topRightControls=null}}async mountBrandMark(){var e;try{const{BrandMark:i}=await this.loadBrandMarkModule();if(this.appElement.querySelector(".vr-brandmark"))return;this.brandMark=new i({appName:(e=this.config)==null?void 0:e.appName,brandText:"æ¦§åº¤æª¸å¨“å‘®ç°®"});const o=this.brandMark.getElement();o.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),this.openDingHuQingYuan()}),this.appElement.appendChild(o)}catch(i){y&&console.debug("[showScene] BrandMark é’æ¶˜ç¼“æ¾¶è¾«è§¦é”›å²ƒçƒ¦æ©?",i),this.brandMark=null}}setupChatOnFirstInteraction(e,i){var s;this.chatInitToken+=1,this.clearChatFirstInteractionListeners();const n=(s=this.config)==null?void 0:s.fcChat;if(!(n!=null&&n.endpoint)||!n.endpoint.trim())return;const o=this.chatInitToken,r=()=>{this.clearChatFirstInteractionListeners(),this.initChatPanel(o,n,e,i)};this.chatFirstInteractionHandler=r,window.addEventListener("pointerdown",r,{passive:!0}),window.addEventListener("touchstart",r,{passive:!0}),window.addEventListener("keydown",r)}async initChatPanel(e,i,n,o){if(e===this.chatInitToken&&!(!this.currentScene||this.currentScene.id!==o.id))try{const[{FcChatPanel:r},{FcChatClient:s}]=await Promise.all([E(()=>import("./chat-community-5yqWR-iz.js").then(m=>m.F),__vite__mapDeps([15,16]),import.meta.url),E(()=>import("./chat-community-5yqWR-iz.js").then(m=>m.f),__vite__mapDeps([15,16]),import.meta.url)]);if(e!==this.chatInitToken||!this.currentScene||this.currentScene.id!==o.id)return;const d={endpoint:i.endpoint,authToken:i.authToken,timeoutMs:15e3},l=new s(d);this.fcChatPanel&&(this.fcChatPanel.remove(),this.fcChatPanel=null),this.fcChatPanel=new r(l,{museumId:n.id,sceneId:o.id,sceneTitle:o.name,museumName:n.name,url:window.location.href})}catch(r){y&&console.debug("[showScene] FcChatPanel é’æ¶˜ç¼“æ¾¶è¾«è§¦é”›å²ƒçƒ¦æ©?",r),this.fcChatPanel=null}}clearChatFirstInteractionListeners(){this.chatFirstInteractionHandler&&(window.removeEventListener("pointerdown",this.chatFirstInteractionHandler),window.removeEventListener("touchstart",this.chatFirstInteractionHandler),window.removeEventListener("keydown",this.chatFirstInteractionHandler),this.chatFirstInteractionHandler=null)}preloadNextScene(e,i){const o=(e.scenes.findIndex(s=>s.id===i.id)+1)%e.scenes.length,r=e.scenes[o];if(r&&r.thumb){const s=dt(r.thumb,Ie.THUMB);if(s){const d=new Image;d.referrerPolicy="no-referrer",d.crossOrigin="anonymous",d.loading="lazy",d.decoding="async",this.resolveProxiedImageUrl(s).then(l=>{d.src=l}).catch(()=>{d.src=s})}}}clearView(){if(this.chatInitToken+=1,this.clearChatFirstInteractionListeners(),this.structure3DLoadToken+=1,this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.handleMetricsEvent&&(window.removeEventListener("vr:metrics",this.handleMetricsEvent),this.handleMetricsEvent=null),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null),this.panoViewer&&(this.panoViewer.dispose(),this.panoViewer=null),this.titleBar&&(this.titleBar.remove(),this.titleBar=null),this.topRightControls&&(this.topRightControls.remove(),this.topRightControls=null),this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),this.topModeTabs&&(this.topModeTabs.getElement().remove(),this.topModeTabs=null),this.sceneTitleEl&&(this.sceneTitleEl.remove(),this.sceneTitleEl=null),this.brandMark&&(this.brandMark.remove(),this.brandMark=null),this.bottomDock&&(this.bottomDock.remove(),this.bottomDock=null),this.guideTray&&(this.guideTray.remove(),this.guideTray=null),this.sceneGuideDrawer&&(this.sceneGuideDrawer.remove(),this.sceneGuideDrawer=null),this.museumList&&(this.museumList.remove(),this.museumList=null),this.sceneListPage&&(this.sceneListPage.remove(),this.sceneListPage=null),this.hotspots&&(this.hotspots.remove(),this.hotspots=null),this.videoPlayer&&(this.videoPlayer.remove(),this.videoPlayer=null),this.debugPanel&&(this.debugPanel.remove(),this.debugPanel=null),this.configStudio&&(this.configStudio.remove(),this.configStudio=null),this.qualityIndicator&&(this.qualityIndicator.remove(),this.qualityIndicator=null),this.structureView2D){const e=this.structureView2D.getElement();e&&e.parentNode&&e.parentNode.removeChild(e),this.structureView2D=null}if(this.structureView3D){const e=this.structureView3D.getElement();e&&e.parentNode&&e.parentNode.removeChild(e),this.structureView3D=null}this.isStructureOverlayOpen=!1,this.fcChatPanel&&(this.fcChatPanel.remove(),this.fcChatPanel=null),this.mode="tour",this.appElement.innerHTML="",this.appElement.appendChild(this.loading.getElement())}hideUIError(){this.uiErrorElement&&this.uiErrorElement.parentNode&&(this.uiErrorElement.parentNode.removeChild(this.uiErrorElement),this.uiErrorElement=null)}setMode(e){this.mode!==e&&(this.mode,this.mode=e,this.topModeTabs&&this.topModeTabs.setMode(e),e==="tour"&&this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),e==="structure2d"?this.openStructure2D():e==="structure3d"&&this.openStructure3D())}async openStructure2D(){if(!this.currentMuseum||!this.currentScene)return;this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),this.structure3DLoadToken+=1;const e=this.structure3DLoadToken,[{buildSceneGraph:i},{StructureView2D:n}]=await Promise.all([this.loadSceneGraphModule(),this.loadStructureView2DModule()]);if(e!==this.structure3DLoadToken||this.mode!=="structure2d"||!this.currentMuseum||!this.currentScene)return;const o=i(this.currentMuseum,this.currentScene.id);this.structureView2D?this.structureView2D.updateContext({museum:this.currentMuseum,graph:o,currentSceneId:this.currentScene.id}):(this.structureView2D=new n({museum:this.currentMuseum,graph:o,currentSceneId:this.currentScene.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(r,s)=>{this.closeStructureOverlay({toTour:!1}),F(r,s)}}),this.appElement.appendChild(this.structureView2D.getElement())),this.isStructureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView2D.open()}async openStructure3D(){if(!this.currentMuseum||!this.currentScene)return;this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),this.structure3DLoadToken+=1;const e=this.structure3DLoadToken,[{buildSceneGraph:i},{StructureView3D:n}]=await Promise.all([this.loadSceneGraphModule(),E(()=>import("./dock-panels-BrANmfay.js").then(r=>r.S),__vite__mapDeps([17,1,18,6]),import.meta.url)]);if(e!==this.structure3DLoadToken||this.mode!=="structure3d"||!this.currentMuseum||!this.currentScene)return;const o=i(this.currentMuseum,this.currentScene.id);this.structureView3D?this.structureView3D.updateContext({museum:this.currentMuseum,graph:o,currentSceneId:this.currentScene.id}):(this.structureView3D=new n({museum:this.currentMuseum,graph:o,currentSceneId:this.currentScene.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(r,s)=>{this.closeStructureOverlay({toTour:!1}),F(r,s)}}),this.appElement.appendChild(this.structureView3D.getElement())),this.isStructureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView3D.open()}closeStructureOverlay(e){if(this.isStructureOverlayOpen){if(this.structure3DLoadToken+=1,this.isStructureOverlayOpen=!1,this.structureView2D){const i=this.structureView2D.getElement();i&&i.parentNode&&i.parentNode.removeChild(i),this.structureView2D=null}if(this.structureView3D){const i=this.structureView3D.getElement();i&&i.parentNode&&i.parentNode.removeChild(i),this.structureView3D=null}document.body.style.overflow="",document.body.style.touchAction="",document.body.style.overscrollBehavior="",e.toTour&&(this.mode="tour",this.topModeTabs&&this.topModeTabs.setMode("tour"))}}async openNorthCalibration(e){if(this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),!this.panoViewer){console.warn("[openNorthCalibration] PanoViewer éˆî„åµæ¿®å¬ªå¯²");return}try{const{NorthCalibrationPanel:i}=await E(async()=>{const{NorthCalibrationPanel:n}=await import("./editor-debug-D38_KtBl.js").then(o=>o.N);return{NorthCalibrationPanel:n}},__vite__mapDeps([8,9,4]),import.meta.url);this.northCalibrationPanel=new i({getCurrentYaw:()=>{var o;const n=(o=this.panoViewer)==null?void 0:o.getCurrentView();return(n==null?void 0:n.yaw)??0},sceneId:e,onClose:()=>{this.northCalibrationPanel=null}})}catch(i){console.error("[openNorthCalibration] é’æ¶˜ç¼“éâ€³å™¯é—ˆãˆ¡æ¾˜æ¾¶è¾«è§¦:",i),this.northCalibrationPanel=null}}showError(e){this.hideUIError(),this.uiErrorElement=document.createElement("div"),this.uiErrorElement.className="error-message",this.uiErrorElement.textContent=e,this.uiErrorElement.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 16px;
      text-align: center;
      max-width: 80vw;
    `,this.appElement.appendChild(this.uiErrorElement),setTimeout(()=>{this.hideUIError()},3e3)}openDingHuQingYuan(){if(this.brandMark)try{this.brandMark.getAboutModal().open()}catch(e){y&&console.debug("[openDingHuQingYuan] éµæ’³ç´‘é¥ãˆ¤æ§¦æµ å¬¬ç²›æ¾¶è¾«è§¦:",e)}}openInfoModal(){var r,s,d;(r=this.infoModalMounted)==null||r.close(),this.infoModalMounted=null;const e=((s=this.currentMuseum)==null?void 0:s.name)||"-",i=((d=this.currentScene)==null?void 0:d.name)||"-",n=document.createElement("div");n.className="vr-modal-info-list",n.innerHTML=`
      <div><span class="vr-modal-info-row-label">çæ›¢î›«</span><span>${e}</span></div>
      <div><span class="vr-modal-info-row-label">é¦çƒ˜æ«™</span><span>${i}</span></div>
      <div><span class="vr-modal-info-row-label">é–²å›¬æ³¦éƒå •æ£¿</span><span> 2025-12-27</span></div>
      <div class="vr-modal-info-copyright">
        <button type="button" role="button" class="vr-modal-info-copyright-btn">æ¼ 2025 æ¦§åº¤æª¸å¨“å‘®ç°®</button>
      </div>
    `;const o=n.querySelector(".vr-modal-info-copyright-btn");o&&o.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.infoModalMounted&&this.infoModalMounted.close(),setTimeout(()=>{this.openDingHuQingYuan()},0)}),this.infoModalMounted=me({title:"æ·‡â„ƒä¼…",contentEl:n,onClose:()=>{this.infoModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"info"}}))}})}async toggleVrModeFromUI(e){if(!this.panoViewer)return!1;const i=await this.ensureVrModeInitialized();if(i.isVrModeEnabled())return i.disableVrMode(),this.panoViewer.setVrModeEnabled(!1),this.topRightControls&&this.topRightControls.updateVrModeState(!1),await de(),!1;{try{await It(e)}catch(s){return y&&console.debug("[VRMode] fullscreen request failed",s),!1}const o=this.panoViewer.getCurrentView();return i.setInteractingCallback(()=>{var s;return((s=this.panoViewer)==null?void 0:s.isInteracting())??!1}),await i.enableVrMode((s,d)=>{if(this.panoViewer){const l=o.yaw+s,m=Math.max(-90,Math.min(90,o.pitch+d));this.panoViewer.setView(l,m)}})?(this.panoViewer.setVrModeEnabled(!0),this.topRightControls&&this.topRightControls.updateVrModeState(!0),!0):(await de(),!1)}}openSettingsModal(){var J;(J=this.settingsModalMounted)==null||J.close(),this.settingsModalMounted=null;const e=ut(),i=Se(),n=pe(),o=document.createElement("div");o.className="vr-modal-settings-list";const r=document.createElement("div");r.className="vr-modal-settings-item-label",r.textContent="é¢æ˜å·";const s=document.createElement("div");s.className="vr-modal-settings-quality";const d=document.createElement("button");d.className="vr-modal-settings-quality-btn",d.textContent="æ¥‚æ¨»ç«»",d.dataset.level="high";const l=document.createElement("button");l.className="vr-modal-settings-quality-btn",l.textContent="éªä½¹ç¥¦",l.dataset.level="low";const m=w=>{d.classList.toggle("is-active",w==="high"),l.classList.toggle("is-active",w==="low")};m(n);const h=w=>{!this.currentScene||!this.panoViewer||pe()===w||(Rt(w),m(w),this.panoViewer.loadScene(this.currentScene,{preserveView:!0}))};d.addEventListener("click",()=>h("high")),l.addEventListener("click",()=>h("low")),s.appendChild(d),s.appendChild(l);const p=document.createElement("div");p.appendChild(r),p.appendChild(s);const P=document.createElement("div");P.className="vr-modal-settings-item-label",P.textContent="ç‘™å—šî—";const v=document.createElement("button");v.className="vr-modal-settings-row-btn",v.type="button",v.textContent="é­ãˆ î˜²é’æ¿†îç‘™å—šî—",v.addEventListener("click",()=>{if(!this.currentScene||!this.panoViewer)return;const w=this.currentScene.initialView||{yaw:0,pitch:0,fov:75},Ae=-(w.yaw||0),De=w.pitch||0,Ve=w.fov??75;this.panoViewer.setView(Ae,De,Ve)});const M=document.createElement("div");M.appendChild(P),M.appendChild(v);const _=document.createElement("div");_.className="vr-modal-settings-item-label",_.textContent="VR éªå¥¸æš…";const f=document.createElement("button");f.className="vr-modal-settings-row-btn",f.type="button",f.textContent="VR éªå¥¸æš…";const u=()=>{var D;const w=((D=this.panoViewer)==null?void 0:D.isVrModeEnabled())??!1;f.classList.toggle("is-on",w)};if(e)u(),f.addEventListener("click",async()=>{if(!this.panoViewer)return;const w=this.panoViewer.getDomElement();await this.toggleVrModeFromUI(w),u()});else if(i){f.classList.add("is-disabled");const w=()=>{X("ç§»åŠ¨ç«¯å¯ä½“éªŒæ­¤åŠŸèƒ½",1500)};f.addEventListener("mouseenter",w),f.addEventListener("click",w)}const S=document.createElement("div");S.appendChild(_),S.appendChild(f);const I=document.createElement("div");I.className="vr-modal-settings-item-label",I.textContent="ç¼‚â•‚æ–";const T=document.createElement("div");T.className="vr-modal-settings-quality",T.style.gap="8px";const N=document.createElement("button");N.className="vr-modal-settings-quality-btn",N.textContent="ç¼‚â•çš¬",N.style.minWidth="70px";const b=document.createElement("button");b.className="vr-modal-settings-quality-btn",b.textContent="é€æƒ§ã‡",b.style.minWidth="70px";const g=()=>{if(!this.panoViewer)return;const w=this.panoViewer.getCurrentView(),D=Math.min(120,w.fov*1.12);this.panoViewer.setFov(D)},A=()=>{if(!this.panoViewer)return;const w=this.panoViewer.getCurrentView(),D=Math.max(30,w.fov/1.12);this.panoViewer.setFov(D)};N.addEventListener("click",g),b.addEventListener("click",A),T.appendChild(N),T.appendChild(b);const $=document.createElement("div");$.appendChild(I),$.appendChild(T),o.appendChild(p),o.appendChild(M),o.appendChild($),o.appendChild(S),this.bottomDock&&this.bottomDock.setMoreOpen(!0),this.settingsModalMounted=me({title:"é‡æ‘î˜¿",contentEl:o,panelClassName:"vr-modal-settings",onClose:()=>{this.bottomDock&&this.bottomDock.setMoreOpen(!1),this.settingsModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"settings"}}))}})}}new Ut;"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").catch(()=>{})});export{Ie as A,ze as E,C as L,E as _,je as a,y as b,pe as c,Bt as d,Be as e,Me as f,Ft as g,de as h,G as i,It as j,ut as k,_t as l,re as m,F as n,Gt as o,z as p,me as q,dt as r,X as s,Ht as t,Ue as v};
