const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BottomDock-DSTu0aTV.js","./index-eWkhSg8A.js","./Modal-Cmv3TBkb.js","./index-DnDnySW2.js","./index-BfJu72vJ.css","./Hotspots-DMmqx2Du.js","./three-math-BTl9b1HC.js","./three-renderer-toiwjbvW.js","./VideoPlayer-BmiR07lJ.js","./GuideTray-CqnrcFNJ.js","./externalImage-Cn8sVw7v.js","./SceneGuideDrawer-D0IDfyzq.js","./QualityIndicator-FJSjNgaB.js","./dock-panels-DSIdrbB3.js","./sceneGraph-CaQzl5R8.js","./autoLayout-ZgSeGcPI.js","./chat-community-Dwo08PGa.js","./store-B83L8bDT.js"])))=>i.map(i=>d[i]);
var f=Object.defineProperty;var M=(n,e,i)=>e in n?f(n,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[e]=i;var t=(n,e,i)=>M(n,typeof e!="symbol"?e+"":e,i);import{_ as r,L as c}from"./index-eWkhSg8A.js";const a=typeof window<"u"&&"requestIdleCallback"in window?window.requestIdleCallback:null,d=typeof window<"u"&&"cancelIdleCallback"in window?window.cancelIdleCallback:null;class v{constructor(e){t(this,"options");t(this,"disposed",!1);t(this,"coreMounted",!1);t(this,"coreMounting",!1);t(this,"deferredMounted",!1);t(this,"deferredMounting",!1);t(this,"observerMounted",!1);t(this,"observerMounting",!1);t(this,"observerIdleHandle",null);t(this,"featureWarmupStarted",!1);t(this,"featureWarmupIdleHandle",null);t(this,"bottomDock",null);t(this,"topModeTabs",null);t(this,"hotspots",null);t(this,"videoPlayer",null);t(this,"guideTray",null);t(this,"sceneGuideDrawer",null);t(this,"qualityIndicator",null);t(this,"handleMetricsEvent",null);t(this,"videoPlayerModulePromise",null);t(this,"guideTrayModulePromise",null);t(this,"sceneGuideDrawerModulePromise",null);t(this,"qualityIndicatorModulePromise",null);t(this,"dockPanelsModulePromise",null);t(this,"communityPanelModulePromise",null);this.options=e}getBottomDock(){return this.bottomDock}getTopModeTabs(){return this.topModeTabs}getHotspots(){return this.hotspots}getVideoPlayer(){return this.videoPlayer}getGuideTray(){return this.guideTray}getSceneGuideDrawer(){return this.sceneGuideDrawer}getQualityIndicator(){return this.qualityIndicator}async ensureQualityIndicatorMounted(){await this.mountObserver()}async mountCore(){if(!(this.coreMounted||this.coreMounting||this.disposed||!this.isAlive())){this.coreMounting=!0;try{const[{BottomDock:e},{TopModeTabs:i},{Hotspots:o}]=await Promise.all([r(()=>import("./BottomDock-DSTu0aTV.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url),r(()=>import("./TopModeTabs-psisWFio.js"),[],import.meta.url),r(()=>import("./Hotspots-DMmqx2Du.js"),__vite__mapDeps([5,6,7,1,4]),import.meta.url)]);if(this.coreMounted||this.disposed||!this.isAlive())return;const l=this.options.getPanoViewer();if(!l)return;const u=new Map(this.options.museum.scenes.map(s=>[s.id,s.name]));this.bottomDock=new e({onGuideClick:()=>{this.openGuideTray()},onOpenCommunity:()=>{this.options.onOpenCommunity()},onOpenInfo:this.options.onOpenInfo,onOpenSettings:this.options.onOpenSettings,sceneId:this.options.scene.id,sceneName:this.options.scene.name,museum:this.options.museum,scenes:this.options.museum.scenes,currentSceneId:this.options.scene.id}),this.options.appElement.appendChild(this.bottomDock.getElement()),this.topModeTabs=new i({initialMode:this.options.initialMode,onModeChange:this.options.onModeChange}),this.options.appElement.appendChild(this.topModeTabs.getElement()),this.hotspots=new o(l,this.options.scene.hotspots,{resolveSceneName:s=>u.get(s),onEnterScene:this.options.onEnterScene,museumId:this.options.museum.id}),this.options.viewerContainer.appendChild(this.hotspots.getElement()),this.coreMounted=!0}finally{this.coreMounting=!1}}}async mountDeferred(){if(!(this.deferredMounted||this.deferredMounting||this.disposed||!this.isAlive())){this.deferredMounting=!0;try{const[{VideoPlayer:e},{GuideTray:i}]=await Promise.all([this.loadVideoPlayerModule(),this.loadGuideTrayModule()]);if(this.deferredMounted||this.disposed||!this.isAlive())return;this.videoPlayer||(this.videoPlayer=new e,this.options.appElement.appendChild(this.videoPlayer.getElement())),this.guideTray||(this.guideTray=new i({museumId:this.options.museum.id,currentSceneId:this.options.scene.id,scenes:this.options.museum.scenes,onSceneClick:o=>{this.options.onEnterScene(o)},onMoreClick:()=>{this.openSceneGuideDrawer()},onClose:()=>{var o;(o=this.guideTray)==null||o.setVisible(!1),window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"guide"}}))}}),this.guideTray.setVisible(!1),this.options.appElement.appendChild(this.guideTray.getElement())),this.deferredMounted=!0}finally{this.deferredMounting=!1}}}scheduleObserverMount(){if(!(this.observerMounted||this.observerMounting||this.disposed||this.observerIdleHandle!==null)){if(a&&d){this.observerIdleHandle=a(()=>{this.observerIdleHandle=null,this.mountObserver()},{timeout:1200});return}this.observerIdleHandle=window.setTimeout(()=>{this.observerIdleHandle=null,this.mountObserver()},500)}}scheduleFeatureWarmup(){if(!(this.featureWarmupStarted||this.disposed||this.featureWarmupIdleHandle!==null||!this.isAlive())){if(this.featureWarmupStarted=!0,a&&d){this.featureWarmupIdleHandle=a(()=>{this.featureWarmupIdleHandle=null,this.warmupFeatureModules()},{timeout:1600});return}this.featureWarmupIdleHandle=window.setTimeout(()=>{this.featureWarmupIdleHandle=null,this.warmupFeatureModules()},600)}}handleStatusChange(e){var i;(i=this.qualityIndicator)==null||i.updateStatus(e),!this.observerMounted&&!this.observerMounting&&!this.disposed&&this.mountObserver(),(e===c.HIGH_READY||e===c.DEGRADED)&&this.scheduleFeatureWarmup()}dispose(){var e,i,o,l,u,s;this.disposed=!0,this.observerIdleHandle!==null&&(a&&d?d(this.observerIdleHandle):clearTimeout(this.observerIdleHandle),this.observerIdleHandle=null),this.featureWarmupIdleHandle!==null&&(a&&d?d(this.featureWarmupIdleHandle):clearTimeout(this.featureWarmupIdleHandle),this.featureWarmupIdleHandle=null),this.handleMetricsEvent&&(window.removeEventListener("vr:metrics",this.handleMetricsEvent),this.handleMetricsEvent=null),(e=this.qualityIndicator)==null||e.remove(),this.qualityIndicator=null,(i=this.sceneGuideDrawer)==null||i.remove(),this.sceneGuideDrawer=null,(o=this.guideTray)==null||o.remove(),this.guideTray=null,(l=this.videoPlayer)==null||l.remove(),this.videoPlayer=null,(u=this.hotspots)==null||u.remove(),this.hotspots=null,this.topModeTabs&&(this.topModeTabs.getElement().remove(),this.topModeTabs=null),(s=this.bottomDock)==null||s.remove(),this.bottomDock=null}async openGuideTray(){var e;await this.mountDeferred(),!(this.disposed||!this.isAlive())&&((e=this.guideTray)==null||e.setVisible(!0))}async openSceneGuideDrawer(){var e;if(await this.mountDeferred(),!(this.disposed||!this.isAlive())){if(!this.sceneGuideDrawer){const{SceneGuideDrawer:i}=await this.loadSceneGuideDrawerModule();if(this.disposed||!this.isAlive())return;this.sceneGuideDrawer=new i({museumId:this.options.museum.id,currentSceneId:this.options.scene.id,scenes:this.options.museum.scenes,onClose:()=>{}}),this.options.appElement.appendChild(this.sceneGuideDrawer.getElement())}(e=this.guideTray)==null||e.setVisible(!1),this.sceneGuideDrawer.open()}}async mountObserver(){if(!(this.observerMounted||this.observerMounting||this.disposed||!this.isAlive())){this.observerMounting=!0;try{const{QualityIndicator:e}=await this.loadQualityIndicatorModule();if(this.observerMounted||this.disposed||!this.isAlive())return;this.qualityIndicator||(this.qualityIndicator=new e,this.options.appElement.appendChild(this.qualityIndicator.getElement()));const i=this.options.getPanoViewer();i&&this.qualityIndicator.updateStatus(i.getLoadStatus()),this.handleMetricsEvent||(this.handleMetricsEvent=o=>{if(!this.qualityIndicator)return;const l=o.detail||{};this.qualityIndicator.updateMetrics(l)},window.addEventListener("vr:metrics",this.handleMetricsEvent)),this.observerMounted=!0}finally{this.observerMounting=!1}}}loadVideoPlayerModule(){return this.videoPlayerModulePromise||(this.videoPlayerModulePromise=r(()=>import("./VideoPlayer-BmiR07lJ.js"),__vite__mapDeps([8,1,4]),import.meta.url)),this.videoPlayerModulePromise}loadGuideTrayModule(){return this.guideTrayModulePromise||(this.guideTrayModulePromise=r(()=>import("./GuideTray-CqnrcFNJ.js"),__vite__mapDeps([9,1,10,4]),import.meta.url)),this.guideTrayModulePromise}loadSceneGuideDrawerModule(){return this.sceneGuideDrawerModulePromise||(this.sceneGuideDrawerModulePromise=r(()=>import("./SceneGuideDrawer-D0IDfyzq.js"),__vite__mapDeps([11,1,10,3,4]),import.meta.url)),this.sceneGuideDrawerModulePromise}loadQualityIndicatorModule(){return this.qualityIndicatorModulePromise||(this.qualityIndicatorModulePromise=r(()=>import("./QualityIndicator-FJSjNgaB.js"),__vite__mapDeps([12,1,4]),import.meta.url)),this.qualityIndicatorModulePromise}loadDockPanelsModule(){return this.dockPanelsModulePromise||(this.dockPanelsModulePromise=r(()=>import("./dock-panels-DSIdrbB3.js").then(e=>e.D),__vite__mapDeps([13,1,7,14,15,4]),import.meta.url)),this.dockPanelsModulePromise}loadCommunityPanelModule(){return this.communityPanelModulePromise||(this.communityPanelModulePromise=r(()=>import("./chat-community-Dwo08PGa.js").then(e=>e.C),__vite__mapDeps([16,17,1,4]),import.meta.url)),this.communityPanelModulePromise}async warmupFeatureModules(){if(this.disposed||!this.isAlive())return;const e=[this.loadVideoPlayerModule(),this.loadGuideTrayModule(),this.loadSceneGuideDrawerModule(),this.loadDockPanelsModule(),this.loadCommunityPanelModule()];this.options.onWarmupFeatures&&e.push(Promise.resolve(this.options.onWarmupFeatures())),await Promise.allSettled(e)}isAlive(){if(this.disposed)return!1;const e=this.options.getCurrentSceneId();return!!(e&&e===this.options.scene.id)}}const I=Object.freeze(Object.defineProperty({__proto__:null,SceneUiRuntime:v},Symbol.toStringTag,{value:"Module"}));function h(n){return!!(n!=null&&n.endpoint&&n.endpoint.trim())}class y{constructor(){t(this,"context",null);t(this,"contextToken",0);t(this,"initPromise",null);t(this,"panel",null);t(this,"chatModulesPromise",null)}updateContext(e){this.context=e,this.contextToken+=1}async warmup(){const e=this.context;if(!(!e||!h(e.fcChatConfig)))try{await this.loadChatModules()}catch{}}async ensureInit(){const e=this.context;if(!e||!h(e.fcChatConfig)||this.panel)return;if(this.initPromise){await this.initPromise;return}const i=this.contextToken,o=(async()=>{var m;const{FcChatPanel:l,FcChatClient:u}=await this.loadChatModules();if(i!==this.contextToken)return;const s=this.context;if(!s||!h(s.fcChatConfig))return;const p=new u({endpoint:s.fcChatConfig.endpoint,authToken:s.fcChatConfig.authToken,timeoutMs:15e3});(m=this.panel)==null||m.remove(),this.panel=new l(p,{museumId:s.museum.id,sceneId:s.scene.id,sceneTitle:s.scene.name,museumName:s.museum.name,url:window.location.href})})();this.initPromise=o.finally(()=>{this.initPromise===o&&(this.initPromise=null)}),await this.initPromise}dispose(){var e;this.contextToken+=1,this.context=null,this.initPromise=null,(e=this.panel)==null||e.remove(),this.panel=null}loadChatModules(){return this.chatModulesPromise||(this.chatModulesPromise=Promise.all([r(()=>import("./chat-community-Dwo08PGa.js").then(e=>e.F),__vite__mapDeps([16,17,1,4]),import.meta.url),r(()=>import("./chat-community-Dwo08PGa.js").then(e=>e.f),__vite__mapDeps([16,17,1,4]),import.meta.url)]).then(([e,i])=>({FcChatPanel:e.FcChatPanel,FcChatClient:i.FcChatClient}))),this.chatModulesPromise}}const _=Object.freeze(Object.defineProperty({__proto__:null,ChatRuntime:y},Symbol.toStringTag,{value:"Module"}));export{_ as c,I as s};
