const x=["tile","pano","ui","preload"],L={global:10,channels:{tile:6,pano:3,preload:2,ui:4}},A={global:6,channels:{tile:4,pano:2,preload:1,ui:2}},v={tile:{active:0,queue:[]},pano:{active:0,queue:[]},preload:{active:0,queue:[]},ui:{active:0,queue:[]}};let p=0,I=!1;function O(){var i;if(typeof navigator>"u")return!1;if(((i=navigator.userAgentData)==null?void 0:i.mobile)===!0)return!0;const n=(navigator.maxTouchPoints||0)>1,t=navigator.userAgent||"",o=/Android|iPhone|iPad|iPod|Mobile|HarmonyOS/i.test(t);if(typeof window<"u"){const c=Math.min(window.innerWidth,window.innerHeight)<=900;return n&&(o||c)}return n||o}function B(){return O()?A:L}function R(e){const n=B(),t=v[e],o=n.channels[e];if(t.active>=o||p>=n.global)return!1;const i=t.queue.shift();return i?(t.active+=1,p+=1,i.task().then(c=>i.resolve(c)).catch(c=>i.reject(c)).finally(()=>{t.active=Math.max(0,t.active-1),p=Math.max(0,p-1),$()}),!0):!1}function $(){if(!I){I=!0;try{let e=!0;for(;e;){e=!1;for(const n of x)R(n)&&(e=!0)}}finally{I=!1}}}function b(e,n){return new Promise((t,o)=>{v[e].queue.push({task:n,resolve:t,reject:o}),$()})}function M(e){try{const t=new URL(e).hostname;if(t==="i.ibb.co"||t==="s41.ax1x.com")return`/_img?u=${encodeURIComponent(e)}`}catch{}return e}class d extends Error{constructor(n,t,o){super(t),this.url=n,this.originalError=o,this.name="ExternalImageLoadError"}}function P(e,n={}){const{timeoutMs:t=15e3,retries:o=2,retryBaseDelayMs:i=300,referrerPolicy:c="no-referrer",crossOrigin:s="anonymous",priority:f}=n,r=M(e);return new Promise((g,m)=>{let a=null,u=0,w=null,h=null;const y=()=>{u++;const l=new Image;h=l,l.decoding="async",l.referrerPolicy=c,l.crossOrigin=s,f&&(l.fetchPriority=f),a!==null&&(clearTimeout(a),a=null),a=window.setTimeout(()=>{if(a=null,w=new Error("加载超时"),h&&(h.onload=null,h.onerror=null,h=null),u<=o){const E=i*Math.pow(2,u-1);console.warn(`外链图片加载超时重试 ${u}/${o+1}: ${r}`),setTimeout(y,E)}else m(new d(e,`加载超时（${o+1} 次尝试）`,w))},t),l.onload=()=>{a!==null&&(clearTimeout(a),a=null),l.complete&&l.naturalWidth>0?g(l):setTimeout(()=>g(l),0)},l.onerror=E=>{if(a!==null&&(clearTimeout(a),a=null),w=new Error("图片加载失败"),h===l&&(h.onload=null,h.onerror=null,h=null),u<=o){const T=i*Math.pow(2,u-1);console.warn(`外链图片加载失败重试 ${u}/${o+1}: ${r}`,E),setTimeout(y,T)}else m(new d(e,`图片加载失败（${o+1} 次尝试）`,w))},l.src=r};y()})}async function D(e,n={}){const t=n.channel??"ui";return b(t,()=>P(e,n))}async function q(e,n,t,o,i,c="from-image"){let s=null;for(let f=0;f<=t;f++){const r=new AbortController,g=setTimeout(()=>r.abort(),n);try{const m={mode:"cors",referrerPolicy:"no-referrer",signal:r.signal};i&&(m.priority=i);const a=await fetch(e,m);if(clearTimeout(g),!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const u=await a.blob();return await createImageBitmap(u,{imageOrientation:c,premultiplyAlpha:"none"})}catch(m){if(clearTimeout(g),s=m instanceof Error?m:new Error(String(m)),f<t){const a=o*Math.pow(2,f);console.warn(`外链图片 fetch 重试 ${f+1}/${t+1}: ${e}`,s.message),await new Promise(u=>setTimeout(u,a))}}}throw new d(e,`fetch 加载失败（${t+1} 次尝试）: ${(s==null?void 0:s.message)||"未知错误"}`,s||void 0)}async function S(e,n={}){const{timeoutMs:t=15e3,retries:o=2,retryBaseDelayMs:i=300,allowFetchFallback:c=!1,imageOrientation:s="from-image"}=n,f=n.channel??"ui";return b(f,async()=>{try{const r=await P(e,n);return await createImageBitmap(r,{imageOrientation:s,premultiplyAlpha:"none"})}catch(r){if(!c)throw r instanceof d?r:new d(e,`Image() 加载失败: ${r instanceof Error?r.message:String(r)}`,r instanceof Error?r:void 0);const g=M(e);console.warn(`Image() 加载失败，尝试 fetch 兜底: ${g}`,r);try{return await q(g,t,o,i,n.priority,s)}catch{throw r instanceof d?r:new d(e,`Image() 和 fetch 均失败: ${r instanceof Error?r.message:String(r)}`,r instanceof Error?r:void 0)}}})}export{d as ExternalImageLoadError,S as loadExternalImageBitmap,D as loadExternalImageElement,M as toProxiedImageUrl};
