var p=Object.defineProperty;var g=(c,t,e)=>t in c?p(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var r=(c,t,e)=>g(c,typeof t!="symbol"?t+"":t,e);import{s as v,f as y}from"./autoLayout-ZgSeGcPI.js";import{r as f,A as w}from"./index-eWkhSg8A.js";class E{constructor(t){r(this,"element");r(this,"canvasContainer");r(this,"svg");r(this,"floorplanImg",null);r(this,"statusEl",null);r(this,"toggleBtn",null);r(this,"museum");r(this,"graph");r(this,"currentSceneId");r(this,"onClose");r(this,"onNodeClick");r(this,"layout",{});r(this,"mode","graph");r(this,"hasFloorplan",!1);var e;this.museum=t.museum,this.graph=t.graph,this.currentSceneId=t.currentSceneId,this.onClose=t.onClose,this.onNodeClick=t.onNodeClick,this.hasFloorplan=!!((e=this.museum.map)!=null&&e.image),this.mode=this.hasFloorplan?"floorplan":"graph",this.element=document.createElement("div"),this.element.className="vr-structure2d-overlay",this.render(),this.bindEvents()}render(){var u;const t=document.createElement("div");t.className="vr-structure2d-header";const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="column",e.style.gap="4px";const d=document.createElement("div");d.className="vr-structure2d-title",d.textContent="结构图",this.statusEl=document.createElement("div"),this.statusEl.className="vr-structure2d-status",this.updateStatusText(),e.appendChild(d),e.appendChild(this.statusEl),this.hasFloorplan&&(this.toggleBtn=document.createElement("button"),this.toggleBtn.className="vr-btn vr-structure2d-toggle",this.toggleBtn.textContent=this.mode==="floorplan"?"结构图":"平面图",this.toggleBtn.addEventListener("click",()=>{this.mode=this.mode==="floorplan"?"graph":"floorplan",this.toggleBtn.textContent=this.mode==="floorplan"?"结构图":"平面图",this.updateStatusText(),this.renderContent()}),t.appendChild(this.toggleBtn));const n=document.createElement("button");if(n.className="vr-btn vr-structure2d-close",n.innerHTML="✕",n.setAttribute("aria-label","关闭"),n.addEventListener("click",()=>{this.close()}),t.appendChild(e),t.appendChild(n),this.canvasContainer=document.createElement("div"),this.canvasContainer.className="vr-structure2d-canvas",this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%"),this.svg.setAttribute("class","vr-structure2d-svg"),this.canvasContainer.appendChild(this.svg),this.hasFloorplan&&((u=this.museum.map)!=null&&u.image)){const i=f(this.museum.map.image,w.MAP);i&&(this.floorplanImg=document.createElement("img"),this.floorplanImg.className="vr-structure2d-floorplan",this.floorplanImg.src=i,this.floorplanImg.style.display="none",this.canvasContainer.appendChild(this.floorplanImg),this.floorplanImg.onload=()=>{this.mode==="floorplan"&&this.renderContent()})}this.element.appendChild(t),this.element.appendChild(this.canvasContainer),this.computeLayout(),this.renderContent()}updateStatusText(){if(!this.statusEl)return;const t=this.graph.nodes.length;this.statusEl.textContent=`mode: ${this.mode}, nodes: ${t}`}renderContent(){this.mode==="floorplan"?this.renderFloorplan():this.renderGraph()}computeLayout(){var n,u;const t=((n=this.museum.map)==null?void 0:n.width)||1e3,e=((u=this.museum.map)==null?void 0:u.height)||600;if(v(this.graph.nodes))this.layout=y(this.graph.nodes,this.graph.edges,{width:t,height:e,iterations:300,padding:40});else{this.layout={};for(const i of this.graph.nodes)i.mapPoint&&(this.layout[i.id]={x:i.mapPoint.x,y:i.mapPoint.y})}}renderFloorplan(){var n,u;this.svg&&(this.svg.style.display="none"),this.floorplanImg&&(this.floorplanImg.style.display="block"),this.svg.innerHTML="",this.svg.style.display="block",this.svg.style.position="absolute",this.svg.style.top="0",this.svg.style.left="0",this.svg.style.pointerEvents="none";const t=((n=this.museum.map)==null?void 0:n.width)||1e3,e=((u=this.museum.map)==null?void 0:u.height)||600;this.svg.setAttribute("viewBox",`0 0 ${t} ${e}`),this.svg.style.pointerEvents="auto";const d=document.createElementNS("http://www.w3.org/2000/svg","g");d.setAttribute("class","vr-structure2d-nodes");for(const i of this.graph.nodes){const l=this.layout[i.id];if(!l)continue;const a=i.id===this.currentSceneId,o=document.createElementNS("http://www.w3.org/2000/svg","g");o.setAttribute("class",`vr-structure2d-node ${a?"is-current":""}`),o.setAttribute("data-scene-id",i.id),o.style.cursor="pointer";const s=document.createElementNS("http://www.w3.org/2000/svg","circle");s.setAttribute("cx",l.x.toString()),s.setAttribute("cy",l.y.toString()),s.setAttribute("r",a?"12":"8"),s.setAttribute("class","vr-structure2d-node-circle");const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",l.x.toString()),h.setAttribute("y",(l.y+(a?25:20)).toString()),h.setAttribute("class","vr-structure2d-node-label"),h.setAttribute("text-anchor","middle"),h.textContent=i.name,o.appendChild(s),o.appendChild(h),d.appendChild(o),o.addEventListener("click",()=>{this.onNodeClick&&this.onNodeClick(this.museum.id,i.id)})}this.svg.appendChild(d)}renderGraph(){var u,i;this.floorplanImg&&(this.floorplanImg.style.display="none"),this.svg&&(this.svg.style.display="block",this.svg.style.position="",this.svg.style.pointerEvents="auto"),this.svg.innerHTML="";const t=((u=this.museum.map)==null?void 0:u.width)||1e3,e=((i=this.museum.map)==null?void 0:i.height)||600;this.svg.setAttribute("viewBox",`0 0 ${t} ${e}`);const d=document.createElementNS("http://www.w3.org/2000/svg","g");d.setAttribute("class","vr-structure2d-edges");for(const l of this.graph.edges){const a=this.layout[l.from],o=this.layout[l.to];if(!a||!o)continue;const s=document.createElementNS("http://www.w3.org/2000/svg","line");s.setAttribute("x1",a.x.toString()),s.setAttribute("y1",a.y.toString()),s.setAttribute("x2",o.x.toString()),s.setAttribute("y2",o.y.toString()),s.setAttribute("class","vr-structure2d-edge"),d.appendChild(s)}this.svg.appendChild(d);const n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("class","vr-structure2d-nodes");for(const l of this.graph.nodes){const a=this.layout[l.id];if(!a)continue;const o=l.id===this.currentSceneId,s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("class",`vr-structure2d-node ${o?"is-current":""}`),s.setAttribute("data-scene-id",l.id),s.style.cursor="pointer";const h=document.createElementNS("http://www.w3.org/2000/svg","circle");h.setAttribute("cx",a.x.toString()),h.setAttribute("cy",a.y.toString()),h.setAttribute("r",o?"12":"8"),h.setAttribute("class","vr-structure2d-node-circle");const m=document.createElementNS("http://www.w3.org/2000/svg","text");m.setAttribute("x",a.x.toString()),m.setAttribute("y",(a.y+(o?25:20)).toString()),m.setAttribute("class","vr-structure2d-node-label"),m.setAttribute("text-anchor","middle"),m.textContent=l.name,s.appendChild(h),s.appendChild(m),n.appendChild(s),s.addEventListener("click",()=>{this.onNodeClick&&this.onNodeClick(this.museum.id,l.id)})}this.svg.appendChild(n)}bindEvents(){const t=e=>{e.key==="Escape"&&this.close()};document.addEventListener("keydown",t),this.element.addEventListener("vr:cleanup",()=>{document.removeEventListener("keydown",t)})}updateContext(t){var e;this.museum=t.museum,this.graph=t.graph,this.currentSceneId=t.currentSceneId,this.hasFloorplan=!!((e=this.museum.map)!=null&&e.image),this.computeLayout(),this.updateStatusText(),this.renderContent()}open(){this.element.classList.add("is-visible")}close(){this.element.classList.remove("is-visible"),this.onClose&&this.onClose()}getElement(){return this.element}remove(){this.element.remove()}}export{E as StructureView2D};
