const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./tile-ktx2-DPKiKnrw.js","./index-DInc35Wk.js","./three-renderer-toiwjbvW.js","./externalImage-Cn8sVw7v.js","./three-extras-3VrNSzCK.js","./qualityPreference-BRkZdVpy.js","./three-math-Bijy4yCX.js","./index-BfJu72vJ.css"])))=>i.map(i=>d[i]);
var me=Object.defineProperty;var pe=(g,e,t)=>e in g?me(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var i=(g,e,t)=>pe(g,typeof e!="symbol"?e+"":e,t);import{b as ae,i as S,n as ge,o as fe,d as f,e as $,r as A,A as R,L as v,_ as we,s as re}from"./index-DInc35Wk.js";import{aN as ve,a2 as _,a1 as be,M as H,aO as ye,aP as Le,j as E,an as Y,r as z,aQ as Me,aR as Se,V as ce,_ as P,U,ao as B,c as de,S as Te,P as Ie,H as ne,aS as Pe,aT as ke,W as Ee}from"./three-renderer-toiwjbvW.js";import{g as Ce}from"./qualityPreference-BRkZdVpy.js";import{c as De,s as xe,g as Ae}from"./three-math-Bijy4yCX.js";import{loadExternalImageBitmap as F,ExternalImageLoadError as Re}from"./externalImage-Cn8sVw7v.js";function Ye(g){return Math.max(0,Math.min(1,g))}function Ne(g){const e=Ye(g);return e*e*(3-2*e)}class _e{constructor(e,t){i(this,"mesh");i(this,"needleMesh",null);i(this,"texture");i(this,"radius");i(this,"opacity",0);i(this,"northYaw",0);i(this,"debugHelper",null);i(this,"labelSprites",new Map);i(this,"patchRadius",0);i(this,"showPitchDeg",-45);i(this,"fadeRangeDeg",18);i(this,"fadeTauMs",140);i(this,"lastRotationY",0);i(this,"debugFrameCount",0);i(this,"isDebugVisible",!0);this.radius=t;const s=t*.18;this.patchRadius=s;const a=new ve(s,96);a.rotateX(Math.PI/2),this.texture=De(512);const r=new _({map:this.texture,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1,side:be});this.mesh=new H(a,r),this.mesh.name="NadirPatch-compass-disk",this.mesh.position.set(0,-t+.5,0),this.mesh.renderOrder=9999,this.mesh.visible=!1,this.mesh.rotation.y=0,e.add(this.mesh);const n=s*.008,h=s*.35,o=new ye(n,n,h,8);o.rotateX(Math.PI/2),o.translate(0,0,h/2);const c=new _({color:16777215,transparent:!0,opacity:.9,depthTest:!1,depthWrite:!1});if(this.needleMesh=new H(o,c),this.needleMesh.name="NadirPatch-compass-needle",this.needleMesh.position.set(0,-t+.51,0),this.needleMesh.rotation.order="YXZ",this.needleMesh.renderOrder=1e4,this.needleMesh.visible=!1,e.add(this.needleMesh),this.createLabelSprites(e,s,t),ae&&(r.color.setHex(65535),this.debugHelper=new Le(s*.5),this.debugHelper.position.copy(this.mesh.position),this.debugHelper.renderOrder=10001,e.add(this.debugHelper),console.debug("[NadirPatch] 对象已创建:",{uuid:this.mesh.uuid,name:this.mesh.name,type:this.mesh.type,position:this.mesh.position,rotation:this.mesh.rotation})),typeof window<"u"){const u=l=>{(l.key==="N"||l.key==="n")&&!(l.target instanceof HTMLInputElement||l.target instanceof HTMLTextAreaElement)&&(l.preventDefault(),this.isDebugVisible=!this.isDebugVisible,this.mesh.visible=this.isDebugVisible&&this.opacity>.01,this.needleMesh&&(this.needleMesh.visible=this.isDebugVisible&&this.opacity>.01),this.debugHelper&&(this.debugHelper.visible=this.isDebugVisible&&this.opacity>.01),console.debug(`[NadirPatch] 显示状态切换为: ${this.isDebugVisible?"显示":"隐藏"}`))};window.addEventListener("keydown",u)}}setNorthYaw(e){this.northYaw=e}update(e,t,s){var p;const a=t.yaw,r=this.northYaw??0,n=E.degToRad(-r);this.mesh.rotation.y=n,this.texture.rotation=0,this.texture.center.set(.5,.5);const h=-r;this.updateLabelSprites(h),this.needleMesh&&(this.needleMesh.rotation.y=E.degToRad(a)),ae&&(this.debugFrameCount++,this.debugFrameCount%30===0&&(Math.abs(this.mesh.rotation.y-this.lastRotationY)>.001&&console.debug("[NadirPatch] 旋转变化:",{frame:this.debugFrameCount,cameraYaw:a.toFixed(2),northYaw:r.toFixed(2),needleYaw:a.toFixed(2),diskRotationY:this.mesh.rotation.y,needleRotationY:(p=this.needleMesh)==null?void 0:p.rotation.y,diskPosition:this.mesh.position}),this.lastRotationY=this.mesh.rotation.y));const c=Ne((this.showPitchDeg-t.pitch)/this.fadeRangeDeg),u=1-Math.exp(-(s||16.7)/this.fadeTauMs);this.opacity=this.opacity+(c-this.opacity)*u;const l=this.mesh.material;l.opacity=this.opacity;const d=this.isDebugVisible&&this.opacity>.01;if(this.mesh.visible=d,this.needleMesh){this.needleMesh.visible=d;const m=this.needleMesh.material;m.opacity=this.opacity*.9}this.labelSprites.forEach(m=>{m.visible=d;const b=m.material;b.opacity=this.opacity*.85}),this.debugHelper&&(this.debugHelper.visible=d)}createLabelSprites(e,t,s){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:r})=>{const n=document.createElement("canvas"),h=128;n.width=h,n.height=h;const o=n.getContext("2d");if(!o)return;o.clearRect(0,0,h,h),o.save(),o.shadowColor="rgba(255, 255, 255, 0.8)",o.shadowBlur=8,o.shadowOffsetX=0,o.shadowOffsetY=0,o.fillStyle="rgba(255, 255, 255, 0.85)",o.font=`600 ${Math.round(h*.5)}px system-ui, -apple-system, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif`,o.textAlign="center",o.textBaseline="middle",o.fillText(r,h/2,h/2),o.restore();const c=new Y(n);c.colorSpace=z,c.needsUpdate=!0;const u=new Me({map:c,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1}),l=new Se(u);l.name=`NadirPatch-label-${r}`,l.position.set(0,-s+.52,0),l.renderOrder=10001,l.visible=!1;const d=t*.15;l.scale.set(d,d,1),e.add(l),this.labelSprites.set(r,l)})}updateLabelSprites(e){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:s,baseAngle:a})=>{const r=this.labelSprites.get(s);if(!r)return;const n=a+e,h=this.patchRadius*.56,o=E.degToRad(n),c=-this.radius+.5,u=Math.sin(o)*h,l=Math.cos(o)*h;r.position.set(u,c+.02,l);const d=new ce(0,0,0);r.lookAt(d)})}dispose(e){e.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose(),this.needleMesh&&(e.remove(this.needleMesh),this.needleMesh.geometry.dispose(),this.needleMesh.material.dispose()),this.labelSprites.forEach(t=>{e.remove(t),t.material.dispose(),t.material.map&&t.material.map.dispose()}),this.labelSprites.clear(),this.debugHelper&&(e.remove(this.debugHelper),this.debugHelper.dispose())}}const Q=-55,He=-90;function q(g){const e=Math.max(0,Math.min(1,(g-Q)/(He-Q))),t=e,s=-e*8,a=1-e*.7,r=e*2;return{opacity:t,translateY:s,scaleY:a,blur:r,clarity:e}}function Z(g){return g<=Q}class Fe{constructor(e={}){i(this,"root");i(this,"disk");i(this,"mask");i(this,"polemask");i(this,"northLabel");i(this,"eastLabel");i(this,"southLabel");i(this,"westLabel");i(this,"needle");i(this,"currentYaw",0);i(this,"currentPitch",0);i(this,"northYaw",0);i(this,"sceneId","");i(this,"northYawLabel",null);i(this,"isVisible",!1);i(this,"unsubscribeInteracting",null);i(this,"unsubscribeIdle",null);i(this,"unsubscribeUIEngaged",null);i(this,"baseOpacity",0);this.root=document.createElement("div"),this.root.className="vr-compass",this.root.setAttribute("data-ui","CompassDisk"),this.root.style.outline="2px solid #ff00ff",this.disk=document.createElement("div"),this.disk.className="vr-compass__disk",this.disk.setAttribute("data-ui","CompassDisk-disk"),this.mask=document.createElement("div"),this.mask.className="vr-compass__mask",this.polemask=document.createElement("div"),this.polemask.className="vr-compass__polemask",this.polemask.setAttribute("aria-hidden","true"),this.northLabel=document.createElement("div"),this.northLabel.className="vr-compass__label vr-compass__label--north",this.northLabel.textContent="北",this.eastLabel=document.createElement("div"),this.eastLabel.className="vr-compass__label vr-compass__label--east",this.eastLabel.textContent="东",this.southLabel=document.createElement("div"),this.southLabel.className="vr-compass__label vr-compass__label--south",this.southLabel.textContent="南",this.westLabel=document.createElement("div"),this.westLabel.className="vr-compass__label vr-compass__label--west",this.westLabel.textContent="西",this.needle=document.createElement("div"),this.needle.className="vr-compass__needle",this.needle.setAttribute("data-ui","CompassDisk-needle"),this.northYawLabel=document.createElement("div"),this.northYawLabel.className="vr-compass__north-yaw-label",this.northYawLabel.style.cssText=`
      position: absolute;
      bottom: -20px;
      right: 10px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
      font-family: monospace;
      pointer-events: none;
      display: none;
    `,this.disk.appendChild(this.mask),this.disk.appendChild(this.polemask),this.disk.appendChild(this.northLabel),this.disk.appendChild(this.eastLabel),this.disk.appendChild(this.southLabel),this.disk.appendChild(this.westLabel),this.disk.appendChild(this.needle),this.root.appendChild(this.disk),this.root.appendChild(this.northYawLabel),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--compass-disk-rot","0deg"),this.root.style.setProperty("--compass-needle-rot","0deg"),this.root.style.setProperty("--compass-label-counter-rot","0deg"),this.setupInteractionListeners()}setupInteractionListeners(){this.unsubscribeInteracting=S.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=S.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=S.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}mount(e){e.appendChild(this.root)}setSceneId(e){this.sceneId=e,this.updateNorthYawLabel()}setNorthYaw(e){this.northYaw=e,this.updateNorthYawLabel()}updateNorthYawLabel(){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}updateYawLabel(e){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)} Yaw=${e.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,Z(t)){const a=q(t);this.baseOpacity=a.opacity,this.root.style.setProperty("--vr-ground-clarity",String(a.clarity)),this.root.style.opacity=a.opacity.toString();const r=`translateX(-50%) translateY(${a.translateY}px) scaleY(${a.scaleY})`;this.root.classList.contains("vr-ui-interacting")?this.root.style.transform=r:this.root.style.transform=r,this.root.style.setProperty("--vr-ground-base-blur",`${a.blur}px`);const n=e,o=-(this.northYaw??0),c=n;this.root.style.setProperty("--compass-disk-rot",`${o}deg`),this.root.style.setProperty("--compass-needle-rot",`${c}deg`);const u=42,l=(d,p)=>{const m=p+o,b=m+180;d.style.transform=`rotate(${m}deg) translateY(-${u}%) rotate(${b}deg)`};l(this.northLabel,0),l(this.eastLabel,270),l(this.southLabel,180),l(this.westLabel,90),this.updateYawLabel(e),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.northLabel.style.transform="",this.eastLabel.style.transform="",this.southLabel.style.transform="",this.westLabel.style.transform="",this.isVisible=!1,this.baseOpacity=0)}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=null),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=null),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=null),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}const oe=60,G=14,$e=4,he=650,Ve=120,le=900,V=-62,ze=150;class Ue{constructor(e){i(this,"root");i(this,"container");i(this,"dots",new Map);i(this,"dotYawDeg",new Map);i(this,"currentYaw",0);i(this,"currentPitch",0);i(this,"isVisible",!1);i(this,"museumId");i(this,"currentSceneId");i(this,"sceneHotspots");i(this,"hoverSceneId",null);i(this,"onNavigateToScene");i(this,"unsubscribeFocus");i(this,"lastYawDeg",0);i(this,"lastPitchDeg",0);i(this,"aimedSceneId",null);i(this,"isInteracting",!1);i(this,"unsubscribeInteracting");i(this,"unsubscribeIdle");i(this,"unsubscribeUIEngaged");i(this,"idleRecoveryTimer",null);i(this,"lastAimChangeTs",0);i(this,"autoNavTimer",null);i(this,"autoNavTargetSceneId",null);i(this,"lastAutoNavTs",0);i(this,"aimDebounceTimer",null);this.museumId=e.museumId,this.currentSceneId=e.currentSceneId,this.sceneHotspots=e.sceneHotspots,this.onNavigateToScene=e.onNavigateToScene||ge,this.root=document.createElement("div"),this.root.className="vr-groundnav",this.root.setAttribute("data-ui","GroundNavDots"),this.root.style.outline="2px solid #00ffff",this.container=document.createElement("div"),this.container.className="vr-groundnav__container",this.root.appendChild(this.container),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.unsubscribeFocus=fe(t=>{this.handleSceneFocus(t)}),this.setupInteractionListeners(),this.renderDots()}setupInteractionListeners(){this.unsubscribeInteracting=S.on("user-interacting",()=>{f("统一终止触发点: 用户交互"),this.isInteracting=!0,this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav()}),this.unsubscribeIdle=S.on("user-idle",()=>{this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.idleRecoveryTimer=window.setTimeout(()=>{if(this.idleRecoveryTimer=null,!this.root.parentNode){f("idleRecoveryTimer: component disposed, skipping");return}this.isInteracting=!1},400)}),this.unsubscribeUIEngaged=S.on("ui-engaged",()=>{f("统一终止触发点: UI 点击"),this.clearAllTimers(),this.isInteracting=!1,this.clearAimed(),this.cancelAutoNav()})}clearAimDebounce(){this.aimDebounceTimer!==null&&(window.clearTimeout(this.aimDebounceTimer),this.aimDebounceTimer=null)}clearAllTimers(){this.clearAimDebounce(),this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.autoNavTimer!==null&&(clearTimeout(this.autoNavTimer),this.autoNavTimer=null)}normalizeDeg(e){return(e%360+360)%360}shortestDeltaDeg(e,t){return(this.normalizeDeg(e)-this.normalizeDeg(t)+180)%360-180}clearAimed(){if(this.aimedSceneId!==null){const e=this.dots.get(this.aimedSceneId);e&&(e.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId)),this.aimedSceneId=null,this.clearAimDebounce(),this.emitSceneAim("clear",null)}this.cancelAutoNav()}cancelAutoNav(){if(this.autoNavTimer!=null&&(window.clearTimeout(this.autoNavTimer),this.autoNavTimer=null),this.autoNavTargetSceneId!==null){const e=this.autoNavTargetSceneId;if(e){this.removeProgress(e);const t=this.dots.get(e);t&&t.classList.remove("is-autonav","is-autonav-progress"),this.emitSceneAutoNav("cancel",e)}this.autoNavTargetSceneId=null}}removeProgress(e){const t=this.dots.get(e);if(!t)return;const s=t.querySelector(".vr-groundnav__progress");s&&t.removeChild(s)}addProgress(e){const t=this.dots.get(e);if(!t)return;this.removeProgress(e);const s=document.createElement("div");s.className="vr-groundnav__progress",s.style.setProperty("--progress-duration",`${he}ms`),t.appendChild(s),t.classList.add("is-autonav-progress")}scheduleAutoNavIfAllowed(e){if(!e){f("scheduleAutoNavIfAllowed: sceneId is missing, skipping");return}const t=Date.now();if(this.isInteracting){f("scheduleAutoNavIfAllowed: isInteracting, skipping");return}if(this.lastPitchDeg>V){f("scheduleAutoNavIfAllowed: pitch too high, skipping",this.lastPitchDeg);return}if(t-this.lastAutoNavTs<le){f("scheduleAutoNavIfAllowed: cooldown, skipping");return}if(t-this.lastAimChangeTs<Ve){f("scheduleAutoNavIfAllowed: min dwell, skipping");return}if(this.currentSceneId&&e===this.currentSceneId){f("scheduleAutoNavIfAllowed: same as current scene, skipping");return}this.autoNavTargetSceneId!==null&&this.autoNavTargetSceneId!==e&&this.cancelAutoNav(),f("scene-autonav: start",{sceneId:e}),this.autoNavTargetSceneId=e;const s=this.dots.get(e);s&&(s.classList.add("is-autonav"),this.addProgress(e)),this.emitSceneAutoNav("start",e),this.autoNavTimer=window.setTimeout(()=>{if(this.autoNavTimer=null,!this.root.parentNode){f("autoNavTimer: component disposed, skipping");return}if(!e){f("autoNavTimer: sceneId is missing, skipping");return}this.tryAutoNavigate(e)},he)}tryAutoNavigate(e){if(!e){f("tryAutoNavigate: sceneId is missing, skipping"),this.cancelAutoNav();return}if(this.isInteracting){f("tryAutoNavigate: isInteracting, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.aimedSceneId||this.aimedSceneId!==e){f("tryAutoNavigate: aimedSceneId mismatch, canceling",{aimedSceneId:this.aimedSceneId,sceneId:e}),this.cancelAutoNav(),this.clearAimed();return}if(this.lastPitchDeg>V){f("tryAutoNavigate: pitch too high, canceling",this.lastPitchDeg),this.cancelAutoNav(),this.clearAimed();return}const t=Date.now();if(t-this.lastAutoNavTs<le){f("tryAutoNavigate: cooldown, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.museumId){f("tryAutoNavigate: museumId is missing, canceling"),this.cancelAutoNav(),this.clearAimed();return}f("scene-autonav: trigger",{museumId:this.museumId,sceneId:e});const s=e;this.cancelAutoNav(),this.clearAimed(),this.lastAutoNavTs=t,window.dispatchEvent(new CustomEvent("vr:close-panels")),$({type:"focus",museumId:this.museumId,sceneId:s,source:"pano-auto",ts:t}),this.onNavigateToScene(this.museumId,s)}maybeRescheduleOrCancelByPitch(e){e>V?(this.autoNavTargetSceneId&&this.cancelAutoNav(),this.aimedSceneId&&this.clearAimed()):this.aimedSceneId&&e<=V&&!this.isInteracting&&!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(this.aimedSceneId)}emitSceneAim(e,t){if(!this.museumId){f("emitSceneAim: museumId is missing, skipping");return}f("scene-aim",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-aim",{detail:{type:e,museumId:this.museumId,sceneId:t||void 0,source:"groundnav",ts:Date.now()}}))}emitSceneAutoNav(e,t){if(!this.museumId){f("emitSceneAutoNav: museumId is missing, skipping");return}f("scene-autonav",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-autonav",{detail:{type:e,museumId:this.museumId,sceneId:t??void 0,ts:Date.now()}}))}updateAimed(e){if(this.isInteracting||!this.isVisible){this.clearAimed();return}const t=this.sceneHotspots.filter(n=>{var h;return(h=n.target)==null?void 0:h.sceneId});if(t.length===0){this.clearAimed();return}let s=null,a=1/0;t.forEach(n=>{const h=n.target.sceneId;if(h===this.currentSceneId)return;const o=n.yaw,c=Math.abs(this.shortestDeltaDeg(e,o));c<a&&(a=c,s=h)});let r=!1;if(s!==null&&(this.aimedSceneId===null?r=a<=G:s===this.aimedSceneId?r=a<=G+$e:r=a<=G),this.isInteracting){this.clearAimed();return}if(r&&s!==null)if(this.aimedSceneId!==s){if(this.lastAimChangeTs=Date.now(),this.cancelAutoNav(),this.aimedSceneId!==null){const h=this.dots.get(this.aimedSceneId);h&&(h.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId))}this.aimedSceneId=s;const n=this.dots.get(s);n&&n.classList.add("is-aimed"),this.clearAimDebounce(),this.aimDebounceTimer=window.setTimeout(()=>{if(this.aimDebounceTimer=null,!this.root.parentNode){f("aimDebounceTimer: component disposed, skipping");return}this.aimedSceneId===s&&!this.isInteracting&&this.isVisible?(this.emitSceneAim("aim",s),this.scheduleAutoNavIfAllowed(s)):this.aimedSceneId===s&&this.clearAimed()},ze)}else!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(s);else this.clearAimed()}handleSceneFocus(e){e.type==="hover"?this.hoverSceneId=e.sceneId:e.type==="focus"&&(f("统一终止触发点: 场景切换",{sceneId:e.sceneId}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),e.sceneId&&(this.currentSceneId=e.sceneId),this.hoverSceneId=null),this.updateDotStates()}updateDotStates(){this.dots.forEach((e,t)=>{e.classList.remove("is-current","is-hover"),t===this.currentSceneId?e.classList.add("is-current"):t===this.hoverSceneId&&e.classList.add("is-hover")})}renderDots(){this.container.innerHTML="",this.dots.clear(),this.dotYawDeg.clear(),this.aimedSceneId=null,this.sceneHotspots.filter(t=>{var s;return(s=t.target)==null?void 0:s.sceneId}).forEach(t=>{const s=t.target.sceneId,a=document.createElement("div");a.className="vr-groundnav__dot",a.setAttribute("data-scene-id",s),a.setAttribute("title",t.label),this.dotYawDeg.set(s,t.yaw),a.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),S.emitUIEngaged(),$({type:"focus",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()}),window.dispatchEvent(new CustomEvent("vr:close-panels")),t.target.museumId&&t.target.sceneId?this.onNavigateToScene(t.target.museumId,t.target.sceneId):f("dot click: museumId or sceneId is missing, skipping navigation")}),a.addEventListener("mouseenter",()=>{$({type:"hover",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()})}),a.addEventListener("mouseleave",()=>{$({type:"hover",museumId:t.target.museumId,sceneId:null,source:"pano",ts:Date.now()})}),this.container.appendChild(a),this.dots.set(t.target.sceneId,a)}),this.updateDotStates(),this.updateDotPositions()}updateDotPositions(){this.sceneHotspots.filter(t=>{var s;return(s=t.target)==null?void 0:s.sceneId}).forEach(t=>{const s=this.dots.get(t.target.sceneId);if(!s)return;const a=t.yaw*Math.PI/180,r=Math.sin(a)*oe,n=-Math.cos(a)*oe;s.style.transform=`translate(${r}px, ${n}px)`})}setYawPitch(e,t){this.currentYaw=e,this.currentPitch=t;const s=Math.abs(this.lastYawDeg-e)>.1;if(this.lastYawDeg=e,this.lastPitchDeg=t,Z(t)){const r=q(t),n=String(r.clarity);this.root.style.getPropertyValue("--vr-ground-clarity")!==n&&this.root.style.setProperty("--vr-ground-clarity",n);const h=r.opacity.toString();this.root.style.opacity!==h&&(this.root.style.opacity=h);const o=`translateX(-50%) translateY(${r.translateY}px) scaleY(${r.scaleY})`;this.root.style.transform!==o&&(this.root.style.transform=o);const c=`${r.blur}px`;this.root.style.getPropertyValue("--vr-ground-base-blur")!==c&&this.root.style.setProperty("--vr-ground-base-blur",c),this.isVisible||(this.isVisible=!0),!this.isInteracting&&s&&(this.updateAimed(e),this.maybeRescheduleOrCancelByPitch(t))}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1,this.clearAimed());s&&this.updateDotPositions()}updateScene(e,t,s){if(f("统一终止触发点: 博物馆/场景切换",{museumId:e,currentSceneId:t}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),!e){f("updateScene: museumId is missing");return}this.museumId=e,this.currentSceneId=t,this.sceneHotspots=s,this.hoverSceneId=null,this.renderDots()}mount(e){e.appendChild(this.root)}dispose(){this.clearAllTimers(),this.cancelAutoNav(),this.clearAimed(),this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=void 0),this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}class Oe{constructor(e,t={}){i(this,"root");i(this,"inner");i(this,"wedge");i(this,"northTick");i(this,"needle");i(this,"currentYaw",0);i(this,"currentPitch",0);i(this,"northYaw",0);i(this,"isVisible",!1);i(this,"unsubscribeInteracting");i(this,"unsubscribeIdle");i(this,"unsubscribeUIEngaged");this.root=document.createElement("div"),this.root.className="vr-groundheading",this.root.setAttribute("data-ui","GroundHeadingMarker"),this.root.style.outline="2px solid #00ffff",this.inner=document.createElement("div"),this.inner.className="vr-groundheading__inner",this.wedge=document.createElement("div"),this.wedge.className="vr-groundheading__wedge",this.northTick=document.createElement("div"),this.northTick.className="vr-groundheading__northTick",this.needle=document.createElement("div"),this.needle.className="vr-groundheading__needle",this.inner.appendChild(this.wedge),this.inner.appendChild(this.northTick),this.inner.appendChild(this.needle),this.root.appendChild(this.inner),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--groundheading-disk-rot","0deg"),this.root.style.setProperty("--groundheading-needle-rot","0deg"),e.appendChild(this.root),this.setupInteractionListeners()}setNorthYaw(e){this.northYaw=e}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,Z(t)){const a=q(t);this.root.style.setProperty("--vr-ground-clarity",String(a.clarity)),this.root.style.opacity=a.opacity.toString(),this.root.style.transform=`translateX(-50%) translateY(${a.translateY}px) scaleY(${a.scaleY})`,this.root.style.setProperty("--vr-ground-base-blur",`${a.blur}px`);const r=e,h=-(this.northYaw??0),o=r;this.root.style.setProperty("--groundheading-disk-rot",`${h}deg`),this.root.style.setProperty("--groundheading-needle-rot",`${o}deg`),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1)}setInteracting(e){e?this.root.classList.add("vr-ui-interacting"):this.root.classList.remove("vr-ui-interacting")}setupInteractionListeners(){this.unsubscribeInteracting=S.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=S.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=S.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}const k=class k{constructor(){i(this,"element",null);i(this,"textEl",null);i(this,"hideTimer",null)}ensure(){this.element||(this.element=document.createElement("div"),this.element.className="vr-zoom-hud",this.textEl=document.createElement("div"),this.textEl.className="vr-zoom-hud__text",this.textEl.textContent="缩放 100%",this.element.appendChild(this.textEl),document.body.appendChild(this.element))}show(e){this.ensure(),!(!this.element||!this.textEl)&&(this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.textEl.textContent=`缩放 ${e}%`,this.element.classList.add("is-on"),this.hideTimer=window.setTimeout(()=>{this.hide()},600))}hide(){this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.element&&this.element.classList.remove("is-on")}static ensure(){return k.instance||(k.instance=new k),k.instance}static show(e){k.ensure().show(e)}static hide(){k.instance&&k.instance.hide()}};i(k,"instance",null);let j=k,D=null,We=0;const N=new Map;function Xe(){return typeof Worker>"u"?null:D||(D=new Worker(new URL(""+new URL("bitmapDecode.worker-FGbDVlpY.js",import.meta.url).href,import.meta.url),{type:"module"}),D.onmessage=g=>{const{id:e,bitmap:t,error:s}=g.data||{},a=N.get(e);a&&(N.delete(e),a.timer&&window.clearTimeout(a.timer),s?a.reject(new Error(s)):t?a.resolve(t):a.reject(new Error("worker 返回空结果")))},D.onerror=()=>{N.forEach(g=>g.reject(new Error("worker error"))),N.clear()},D)}async function Ge(g,e={}){const t=Xe();if(!t||typeof createImageBitmap>"u")return null;const s=++We,a=Math.max(1e3,e.timeoutMs??12e3),r=e.priority??"high",n=e.imageOrientation??"from-image";return new Promise((h,o)=>{const c={resolve:h,reject:o};c.timer=window.setTimeout(()=>{N.delete(s),o(new Error("worker decode timeout"))},a+500),N.set(s,c),t.postMessage({id:s,url:g,timeoutMs:a,priority:r,imageOrientation:n})})}class Be{constructor(e,t,s,a=0){i(this,"maxTextureSize");i(this,"manifest",null);i(this,"canvas",null);i(this,"ctx",null);i(this,"texture",null);i(this,"mesh",null);i(this,"pendingLow",[]);i(this,"pendingHigh",[]);i(this,"activeLoads",0);i(this,"activeLowLoads",0);i(this,"activeHighLoads",0);i(this,"maxConcurrent",6);i(this,"maxHighWhileLow",2);i(this,"defaultMaxConcurrent",6);i(this,"defaultMaxHighWhileLow",2);i(this,"lastUpdate",0);i(this,"tilesMap",new Map);i(this,"highestLevel",null);i(this,"lowLevel",null);i(this,"lowReadyCount",0);i(this,"lowTotalCount",0);i(this,"lowFullyReady",!1);i(this,"highSeeded",!1);i(this,"tilesVisible",!1);i(this,"tilesLoadedCount",0);i(this,"tilesLoadingCount",0);i(this,"tilesQueuedCount",0);i(this,"tilesFailedCount",0);i(this,"tilesRetryCount",0);i(this,"lastTileUrl","");i(this,"lastError","");i(this,"lruLimit",64);i(this,"highReady",!1);i(this,"canvasScale",1);i(this,"fallbackVisible",!1);i(this,"prefetchSeeded",!1);this.scene=e,this.onFirstDraw=t,this.onHighReady=s,this.maxTextureSize=Math.max(0,a)}async load(e,t){var p;if(this.manifest=e,this.fallbackVisible=!!(t!=null&&t.fallbackVisible),this.highestLevel=e.levels.reduce((m,b)=>b.z>m.z?b:m),!this.highestLevel)throw new Error("manifest 缺少 level");this.lruLimit=Math.max(64,Math.min(this.highestLevel.cols*this.highestLevel.rows,256));const s=e.levels.filter(m=>m.z<this.highestLevel.z);this.lowLevel=s.length?s.reduce((m,b)=>b.z>m.z?b:m):null,this.lowReadyCount=0,this.lowTotalCount=this.lowLevel?this.lowLevel.cols*this.lowLevel.rows:0,this.lowFullyReady=this.lowTotalCount===0,this.highSeeded=!1,this.prefetchSeeded=!1,this.tilesVisible=!1,this.tilesLoadedCount=0,this.tilesLoadingCount=0,this.tilesQueuedCount=0,this.tilesFailedCount=0,this.tilesRetryCount=0,this.activeLoads=0,this.activeLowLoads=0,this.activeHighLoads=0;const a=this.highestLevel.cols,r=this.highestLevel.rows,n=e.tileSize,h=n*a,o=n*r;let c=h,u=o;if(this.canvasScale=1,this.maxTextureSize>0&&(c>this.maxTextureSize||u>this.maxTextureSize)){const m=Math.min(this.maxTextureSize/c,this.maxTextureSize/u);c=Math.max(1,Math.floor(c*m)),u=Math.max(1,Math.floor(u*m)),this.canvasScale=m}this.canvas=document.createElement("canvas"),this.canvas.width=c,this.canvas.height=u,this.ctx=this.canvas.getContext("2d",{alpha:!0}),this.fallbackVisible&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.texture=new Y(this.canvas),this.texture.flipY=!1,this.texture.wrapS=P,this.texture.wrapT=P,this.texture.minFilter=U,this.texture.magFilter=U,this.texture.generateMipmaps=!1,"colorSpace"in this.texture?this.texture.colorSpace=z:this.texture.encoding=B,this.texture.needsUpdate=!0;const l=new de(500,64,64);l.scale(-1,1,1);const d=new _({map:this.texture,transparent:!0,opacity:0,depthWrite:!1,depthTest:!1});if(d.toneMapped=!1,this.mesh=new H(l,d),this.mesh.renderOrder=1,this.mesh.frustumCulled=!1,this.scene.add(this.mesh),!this.fallbackVisible){if(!e.levels.find(w=>w.z===0))throw new Error("manifest 缺少 z0");const b=`${e.baseUrl}/z0/0_0.jpg`,M=await this.fetchTileBitmap(b,"high"),T={z:0,col:0,row:0,url:b,state:"ready",priority:"low",bitmap:M,lastUsed:performance.now(),failCount:0};await this.drawTile(T),(p=M.close)==null||p.call(M)}this.lowLevel&&this.enqueueLevel(this.lowLevel,"low")}setPerformanceMode(e){e==="throttle"?(this.maxConcurrent=2,this.maxHighWhileLow=0):(this.maxConcurrent=this.defaultMaxConcurrent,this.maxHighWhileLow=this.defaultMaxHighWhileLow)}dispose(){if(this.tilesMap.forEach(e=>{var t,s;return(s=(t=e.bitmap)==null?void 0:t.close)==null?void 0:s.call(t)}),this.tilesMap.clear(),this.mesh){this.mesh.geometry&&this.mesh.geometry.dispose();const e=this.mesh.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.mesh)}}update(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;const t=performance.now();if(t-this.lastUpdate<150)return;if(this.lastUpdate=t,(!this.lowLevel||this.lowFullyReady||this.highSeeded)&&this.highestLevel){const n=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});for(const{col:h,row:o,rank:c}of n){const u=`${this.highestLevel.z}_${h}_${o}`;let l=this.tilesMap.get(u);l||(l={z:this.highestLevel.z,col:h,row:o,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${h}_${o}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(u,l)),l.priority="high",l.priorityRank=c,l.lastUsed=t,l.state==="empty"&&!l.retryTimer&&(l.state="loading",this.pendingHigh.push(l))}}const a=Array.from(this.tilesMap.values()).filter(n=>n.state==="loading").length,r=Array.from(this.tilesMap.values()).filter(n=>n.state==="ready").length;if(this.lowLevel&&!this.lowFullyReady){const n=Array.from(this.tilesMap.values()).filter(h=>h.z===this.lowLevel.z&&h.state==="loading").length;this.pendingLow.length===0&&n===0&&(this.lowFullyReady=!0)}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=a,this.tilesLoadedCount=r,this.processQueue(),this.runLru(t)}prime(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;e.updateMatrixWorld(!0);const t=performance.now();if(this.highestLevel&&!this.highSeeded){const s=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});if(s.length>0){for(const{col:a,row:r,rank:n}of s){const h=`${this.highestLevel.z}_${a}_${r}`;let o=this.tilesMap.get(h);o||(o={z:this.highestLevel.z,col:a,row:r,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${a}_${r}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(h,o)),o.priority="high",o.priorityRank=n,o.lastUsed=t,o.state==="empty"&&!o.retryTimer&&(o.state="loading",this.pendingHigh.push(o))}this.highSeeded=!0}}this.reprioritizeLowQueue(e),this.seedHighPreload(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(s=>s.state==="loading").length,this.processQueue()}getStatus(){var e,t;return{tilesVisible:this.tilesVisible,fallbackVisible:this.fallbackVisible,tilesLoadedCount:this.tilesLoadedCount,tilesLoadingCount:this.tilesLoadingCount,tilesQueuedCount:this.tilesQueuedCount,tilesFailedCount:this.tilesFailedCount,tilesRetryCount:this.tilesRetryCount,lastTileUrl:this.lastTileUrl,lastError:this.lastError,canvasSize:this.canvas?`${this.canvas.width}x${this.canvas.height}`:"0x0",canvasScale:this.canvasScale,maxLevel:this.highestLevel?`${this.highestLevel.cols}x${this.highestLevel.rows}`:"",highReady:this.highReady,zMax:((e=this.highestLevel)==null?void 0:e.z)??0,levels:this.manifest?this.manifest.levels.map(s=>s.z).join(","):"",lowReady:this.lowFullyReady,lowLevel:((t=this.lowLevel)==null?void 0:t.z)??""}}enqueueLevel(e,t){const s=performance.now();for(let a=0;a<e.rows;a++)for(let r=0;r<e.cols;r++){const n=`${e.z}_${r}_${a}`;let h=this.tilesMap.get(n);h||(h={z:e.z,col:r,row:a,url:`${this.manifest.baseUrl}/z${e.z}/${r}_${a}.jpg`,state:"empty",priority:t,lastUsed:s,failCount:0},this.tilesMap.set(n,h)),h.priority=t,h.lastUsed=s,h.state==="empty"&&!h.retryTimer&&(h.state="loading",t==="low"?this.pendingLow.push(h):this.pendingHigh.push(h))}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(a=>a.state==="loading").length,this.processQueue()}processQueue(){for(this.sortPendingHighQueue();this.activeLoads<this.maxConcurrent&&(this.pendingLow.length>0||this.pendingHigh.length>0);){const e=this.pendingLow.length>0,s=this.pendingHigh.length>0&&(!e||this.activeHighLoads<this.maxHighWhileLow)?this.pendingHigh.shift():this.pendingLow.shift();this.loadTile(s)}}async loadTile(e){(e.failCount===void 0||e.failCount===null)&&(e.failCount=0),e.priority||(e.priority="high"),this.activeLoads+=1,e.priority==="high"?this.activeHighLoads+=1:this.activeLowLoads+=1,this.lastTileUrl=e.url;try{const t=await this.fetchTileBitmap(e.url,e.priority);e.bitmap=t,e.state="ready",e.failCount=0,e.retryTimer&&(clearTimeout(e.retryTimer),e.retryTimer=void 0),this.drawTile(e),this.tilesLoadedCount+=1,this.lowLevel&&e.z===this.lowLevel.z&&(this.lowReadyCount+=1,this.lowReadyCount>=this.lowTotalCount&&(this.lowFullyReady=!0))}catch(t){this.lastError=t instanceof Error?t.message:String(t),e.state="empty",e.failCount+=1,this.tilesFailedCount+=1;const s=Math.min(1e3*Math.pow(2,Math.max(0,e.failCount-1)),15e3);this.scheduleRetry(e,s)}finally{this.activeLoads-=1,e.priority==="high"?this.activeHighLoads=Math.max(0,this.activeHighLoads-1):this.activeLowLoads=Math.max(0,this.activeLowLoads-1),this.processQueue()}}scheduleRetry(e,t){e.retryTimer||(this.tilesRetryCount+=1,e.retryTimer=window.setTimeout(()=>{e.retryTimer=void 0,e.state==="empty"&&(e.priority==="low"?this.pendingLow.push(e):this.pendingHigh.push(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.processQueue())},t))}async fetchTileBitmap(e,t,s=12e3){try{const n=await Ge(e,{timeoutMs:s,priority:t});if(n)return n}catch{}const a=new AbortController,r=window.setTimeout(()=>a.abort(),s);try{const n={mode:"cors",cache:"default",referrerPolicy:"no-referrer",signal:a.signal};n.priority=t==="high"?"high":"low";const h=await fetch(e,n);if(!h.ok)throw new Error(`tile HTTP ${h.status}: ${e}`);const o=await h.blob();return await createImageBitmap(o)}finally{clearTimeout(r)}}hasHigherReadyTile(e,t,s){if(!this.highestLevel)return!1;const a=this.highestLevel.z;if(e>=a)return!1;const r=1<<a-e;for(let n=0;n<r;n++)for(let h=0;h<r;h++){const o=`${a}_${t*r+h}_${s*r+n}`,c=this.tilesMap.get(o);if(c&&c.state==="ready")return!0}return!1}async drawTile(e){var c,u;if(!this.manifest||!this.highestLevel||!this.ctx||!this.canvas)return;const t=this.manifest.levels.find(l=>l.z===e.z);if(!t||this.hasHigherReadyTile(e.z,e.col,e.row))return;const s=this.canvas.width/t.cols,a=this.canvas.height/t.rows,r=e.col*s,n=e.row*a;if(r<0||n<0||r+s>this.canvas.width||n+a>this.canvas.height){this.lastError=`tile out of canvas: z${e.z} ${e.col}_${e.row}`;return}const h=e.bitmap;if(h)this.ctx.drawImage(h,r,n,s,a);else{const l=e.url||`${this.manifest.baseUrl}/z${e.z}/${e.col}_${e.row}.jpg`,d=await F(l,{timeoutMs:12e3,retries:1,priority:e.priority,channel:"tile"});this.ctx.drawImage(d,r,n,s,a),(c=d.close)==null||c.call(d)}this.texture&&(this.texture.needsUpdate=!0),this.tilesVisible||(this.tilesVisible=!0,this.onFirstDraw());const o=(u=this.mesh)==null?void 0:u.material;o&&(o.opacity=1,o.needsUpdate=!0),this.highestLevel&&e.z===this.highestLevel.z&&!this.highReady&&(this.highReady=!0,this.onHighReady())}computeNeededTiles(e,t,s={}){const{yaw:a,pitch:r}=this.getViewAngles(e),n=E.degToRad(e.fov),h=E.degToRad(s.marginDeg??20),o=n/2+h,c=n*e.aspect/2+h,u=this.normAngle(a-c),l=this.normAngle(a+c),d=E.clamp(r-o,-Math.PI/2,Math.PI/2),p=E.clamp(r+o,-Math.PI/2,Math.PI/2),m=this.yawToCols(u,l,t.cols),b=this.yawToCols(a-1e-6,a+1e-6,t.cols)[0]??0;m.includes(b)||m.push(b);const M=Math.max(0,Math.floor((p*-1+Math.PI/2)/Math.PI*t.rows)),T=Math.min(t.rows-1,Math.floor((d*-1+Math.PI/2)/Math.PI*t.rows)),w=[];for(let y=M;y<=T;y++)w.push(y);const C=Math.min(t.rows-1,Math.max(0,Math.floor((-r+Math.PI/2)/Math.PI*t.rows)));w.includes(C)||w.push(C);const L=s.expandNeighbors!==!1,O=[...m];if(L)for(const y of m)O.push(((y+1)%t.cols+t.cols)%t.cols),O.push(((y-1)%t.cols+t.cols)%t.cols);const W=[...w];if(L)for(const y of w)y+1<t.rows&&W.push(y+1),y-1>=0&&W.push(y-1);const X=new Map,ue=(y,I)=>{const K=`${y}_${I}`,J=Math.abs(y-b),ee=Math.min(J,t.cols-J),te=Math.abs(I-C),se=ee*ee+te*te,ie=X.get(K);(!ie||se<ie.rank)&&X.set(K,{col:y,row:I,rank:se})};for(const y of O)for(const I of W)ue(y,I);return Array.from(X.values()).sort((y,I)=>y.rank!==I.rank?y.rank-I.rank:y.row!==I.row?y.row-I.row:y.col-I.col)}sortPendingHighQueue(){this.pendingHigh.length<2||this.pendingHigh.sort((e,t)=>{const s=e.priorityRank??Number.POSITIVE_INFINITY,a=t.priorityRank??Number.POSITIVE_INFINITY;return s!==a?s-a:t.lastUsed-e.lastUsed})}reprioritizeLowQueue(e){if(!this.lowLevel||this.pendingLow.length<2)return;const t=this.computeNeededTiles(e,this.lowLevel);if(t.length===0)return;const s=new Map;for(const r of t)s.set(`${r.col}_${r.row}`,r.rank);const a=new Map;this.pendingLow.forEach((r,n)=>a.set(r,n)),this.pendingLow.sort((r,n)=>{const h=s.get(`${r.col}_${r.row}`),o=s.get(`${n.col}_${n.row}`),c=h!==void 0,u=o!==void 0;return c&&u&&h!==o?h-o:c&&!u?-1:!c&&u?1:(a.get(r)??0)-(a.get(n)??0)})}seedHighPreload(e){if(this.prefetchSeeded||!this.manifest||!this.highestLevel)return;this.prefetchSeeded=!0;const{yaw:t,pitch:s}=this.getViewAngles(e),a=this.highestLevel,r=Math.PI*2/a.cols,n=Math.PI/a.rows,h=performance.now();for(let o=0;o<a.rows;o++){const c=Math.PI/2-(o+.5)*n,u=Math.abs(c-s);for(let l=0;l<a.cols;l++){const d=-Math.PI+(l+.5)*r,p=this.angularDistance(d,t),b=(p<=Math.PI/2?0:1)*1e6+Math.round(p*1e3)+Math.round(u*10),M=`${a.z}_${l}_${o}`;if(this.tilesMap.has(M))continue;const T={z:a.z,col:l,row:o,url:`${this.manifest.baseUrl}/z${a.z}/${l}_${o}.jpg`,state:"loading",priority:"high",priorityRank:b,lastUsed:h,failCount:0};this.tilesMap.set(M,T),this.pendingHigh.push(T)}}}yawToCols(e,t,s){const a=d=>(d%(Math.PI*2)+Math.PI*2)%(Math.PI*2),r=Math.PI,n=a(e+r),h=a(t+r),o=[],c=d=>{const p=(d%s+s)%s;o.includes(p)||o.push(p)},u=Math.floor(n/(Math.PI*2)*s),l=Math.floor(h/(Math.PI*2)*s);if(n<=h)for(let d=u;d<=l;d++)c(d);else{for(let d=u;d<s;d++)c(d);for(let d=0;d<=l;d++)c(d)}return o}normAngle(e){return(e+Math.PI)%(2*Math.PI)-Math.PI}angularDistance(e,t){return Math.abs(this.normAngle(e-t))}getViewAngles(e){const t=new ce;return e.getWorldDirection(t),{yaw:-Math.atan2(t.x,t.z),pitch:Math.asin(t.y)}}runLru(e){var a,r;if(!this.highestLevel)return;const t=Array.from(this.tilesMap.values()).filter(n=>n.z===this.highestLevel.z&&n.state==="ready");if(t.length<=this.lruLimit)return;t.sort((n,h)=>n.lastUsed-h.lastUsed);const s=t.slice(0,t.length-this.lruLimit);for(const n of s)(r=(a=n.bitmap)==null?void 0:a.close)==null||r.call(a),n.bitmap=void 0,n.state="empty",this.tilesMap.delete(`${n.z}_${n.col}_${n.row}`)}}function Qe(g,e){var s;const t=g.trim();if(!t||t.startsWith("/")||t.startsWith("//")||/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(t))return t;try{const a=new URL(t,e),r=typeof window<"u"&&((s=window.location)!=null&&s.origin)?window.location.origin:typeof location<"u"?location.origin:"";return r&&a.origin===r?`${a.pathname}${a.search}${a.hash}`:a.toString()}catch{return t}}async function je(g){const e={cache:"default"};e.priority="high";const t=await fetch(g,e);if(!t.ok)throw new Error(`manifest 加载失败: ${g}`);const s=await t.json();return s.tileFormat||(s.tileFormat="jpg"),s.baseUrl=A(Qe(s.baseUrl,g),R.PANO),s}const x={original:{renderer:{pixelRatio:Math.min(window.devicePixelRatio||1,2),toneMapping:ke,toneMappingExposure:1,output:"srgb",clearColor:void 0},camera:{defaultFov:75},texture:{anisotropyLimit:8,minFilter:ne,magFilter:U,generateMipmaps:!0,colorSpace:"srgb"}},enhanced:{renderer:{pixelRatio:Math.min(window.devicePixelRatio,2),toneMapping:Pe,toneMappingExposure:.95,output:"srgb",clearColor:{color:0,alpha:1}},camera:{defaultFov:70},texture:{anisotropyLimit:12,minFilter:ne,magFilter:U,generateMipmaps:!0,colorSpace:"srgb"}}};class qe{constructor(e,t=!1){i(this,"scene");i(this,"camera");i(this,"renderer");i(this,"sphere",null);i(this,"tilePano",null);i(this,"fallbackSphere",null);i(this,"container");i(this,"handleWindowResize",()=>this.handleResize());i(this,"domEventRemovers",[]);i(this,"animationFrameId",null);i(this,"disposed",!1);i(this,"frameListeners",[]);i(this,"nadirPatch",null);i(this,"compassDisk",null);i(this,"groundNavDots",null);i(this,"groundHeading",null);i(this,"renderProfile","enhanced");i(this,"isDragging",!1);i(this,"lastMouseX",0);i(this,"lastMouseY",0);i(this,"yaw",0);i(this,"pitch",0);i(this,"fov",75);i(this,"onLoadCallback");i(this,"onErrorCallback");i(this,"onStatusChangeCallback");i(this,"debugMode",!1);i(this,"onDebugClick");i(this,"longPressTimer",null);i(this,"tilesDebugEl",null);i(this,"tilesVisibleStableFrames",0);i(this,"tilesLastError","");i(this,"tilesLowReady",!1);i(this,"tilesLastLoadedCount",0);i(this,"tilesLastProgressAt",0);i(this,"tilesHighStartAt",0);i(this,"tilesDegradedNotified",!1);i(this,"longPressThreshold",500);i(this,"renderSource","none");i(this,"perfSamples",[]);i(this,"perfMode","normal");i(this,"allowTilePerfThrottle",!1);i(this,"perfLastChangeAt",0);i(this,"renderSwitchReason","");i(this,"clearedCount",0);i(this,"aspectWarnedUrls",new Set);i(this,"metrics",{sceneId:"",startAt:0,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:"normal",renderSource:"none",lastError:""});i(this,"lastMetricsEmitAt",0);i(this,"loadStatus",v.LOADING_LOW);i(this,"isDegradedMode",!1);i(this,"pickMode",!1);i(this,"pickModeListeners",[]);i(this,"pickStartX",0);i(this,"pickStartY",0);i(this,"pickStartTime",0);i(this,"pickHasMoved",!1);i(this,"pickDragThreshold",8);i(this,"pickTimeThreshold",250);i(this,"lastYaw",0);i(this,"lastPitch",0);i(this,"lastFov",75);i(this,"isViewChanging",!1);i(this,"viewChangeThreshold",.5);i(this,"pendingYawDelta",0);i(this,"pendingPitchDelta",0);i(this,"hasPendingViewDelta",!1);i(this,"vrModeEnabled",!1);i(this,"touchStartX",0);i(this,"touchStartY",0);i(this,"lastTouchDistance",0);i(this,"isPinching",!1);i(this,"lastFrameTimeMs",null);this.container=e,this.debugMode=t,this.renderProfile=this.detectRenderProfile(),this.allowTilePerfThrottle=this.detectTileThrottleEnabled(),this.scene=new Te,this.camera=new Ie(x[this.renderProfile].camera.defaultFov,e.clientWidth/e.clientHeight,.1,1e3),this.camera.position.set(0,0,0),this.fov=x[this.renderProfile].camera.defaultFov,this.renderer=new Ee({antialias:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.applyRendererProfile(),e.appendChild(this.renderer.domElement),this.nadirPatch=new _e(this.scene,500),this.compassDisk=new Fe,this.compassDisk.mount(e),this.compassDisk.getElement().style.display="none",this.groundNavDots=new Ue({museumId:"",currentSceneId:"",sceneHotspots:[]}),this.groundNavDots.mount(e),this.groundNavDots.getElement().style.display="none",this.groundHeading=new Oe(e),this.groundHeading.getElement().style.display="none",this.setupEvents(),this.animate(),window.addEventListener("resize",this.handleWindowResize)}setupEvents(){const e=this.renderer.domElement,t=(l,d,p)=>{e.addEventListener(l,d,p),this.domEventRemovers.push(()=>{e.removeEventListener(l,d,(p==null?void 0:p.capture)??!1)})},s=l=>this.onPointerDown(l),a=l=>this.onPointerMove(l),r=()=>this.onPointerUp(),n=()=>this.onPointerUp();t("mousedown",s),t("mousemove",a),t("mouseup",r),t("mouseleave",n);const h=l=>this.onTouchStart(l),o=l=>this.onTouchMove(l),c=()=>this.onTouchEnd();if(t("touchstart",h,{passive:!1}),t("touchmove",o,{passive:!1}),t("touchend",c),t("wheel",l=>this.onWheel(l),{passive:!1}),this.debugMode){t("dblclick",T=>{const w=T;this.handleDebugClick(w.clientX,w.clientY)});let d=0,p=0;const m=T=>{const w=T;w.touches.length===1&&(d=w.touches[0].clientX,p=w.touches[0].clientY,this.longPressTimer=window.setTimeout(()=>{this.handleDebugClick(d,p)},this.longPressThreshold))},b=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},M=()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)};t("touchstart",m,{passive:!0}),t("touchmove",b,{passive:!0}),t("touchend",M,{passive:!0})}}clearDomEvents(){for(const e of this.domEventRemovers)e();this.domEventRemovers.length=0,this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)}handleDebugClick(e,t){if(this.onDebugClick&&this.debugMode){const s=this.getCurrentView();this.onDebugClick(e,t,s.yaw,s.pitch,s.fov)}}setOnDebugClick(e){this.onDebugClick=e}onPointerDown(e){this.isDragging=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,S.emitInteracting()}onPointerMove(e){if(!this.isDragging)return;const t=e.clientX-this.lastMouseX,s=e.clientY-this.lastMouseY;this.queueViewDelta(t*.5,s*.5),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY}onPointerUp(){this.isDragging=!1}onTouchStart(e){if(e.touches.length===1)this.isDragging=!0,this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY,this.lastMouseX=this.touchStartX,this.lastMouseY=this.touchStartY,S.emitInteracting();else if(e.touches.length===2){this.isPinching=!0,this.isDragging=!1;const t=e.touches[0].clientX-e.touches[1].clientX,s=e.touches[0].clientY-e.touches[1].clientY;this.lastTouchDistance=Math.sqrt(t*t+s*s),S.emitInteracting()}}onTouchMove(e){if(e.preventDefault(),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),e.touches.length===1&&this.isDragging){const t=e.touches[0].clientX-this.lastMouseX,s=e.touches[0].clientY-this.lastMouseY;this.queueViewDelta(t*.5,s*.5),this.lastMouseX=e.touches[0].clientX,this.lastMouseY=e.touches[0].clientY}else if(e.touches.length===2&&this.isPinching){const t=e.touches[0].clientX-e.touches[1].clientX,s=e.touches[0].clientY-e.touches[1].clientY,a=Math.sqrt(t*t+s*s),r=this.lastTouchDistance-a,n=this.fov+r*.5;this.setFovInternal(n),this.lastTouchDistance=a}}onTouchEnd(){this.isDragging=!1,this.isPinching=!1}onWheel(e){e.preventDefault();const t=this.fov+e.deltaY*.1;if(this.setFovInternal(t),S.emitInteracting(),this.debugMode&&this.onDebugClick){const s=this.getCurrentView();this.onDebugClick(this.lastMouseX,this.lastMouseY,s.yaw,s.pitch,s.fov)}}updateCamera(){const e=E.degToRad(this.yaw),t=E.degToRad(this.pitch),s=Math.cos(t)*Math.sin(e),a=Math.sin(t),r=Math.cos(t)*Math.cos(e);this.camera.lookAt(s,a,r)}queueViewDelta(e,t){this.pendingYawDelta+=e,this.pendingPitchDelta+=t,this.hasPendingViewDelta=!0}applyPendingViewDelta(){this.hasPendingViewDelta&&(this.yaw+=this.pendingYawDelta,this.pitch=Math.max(-90,Math.min(90,this.pitch+this.pendingPitchDelta)),this.pendingYawDelta=0,this.pendingPitchDelta=0,this.hasPendingViewDelta=!1)}loadScene(e,t){var l;if(this.isDegradedMode=!1,this.resetMetrics(e.id),this.updateLoadStatus(v.LOADING_LOW),this.renderSource="none",this.clearedCount=0,this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const d=this.sphere.material;d.map&&d.map.dispose(),d.dispose()}if(!((t==null?void 0:t.preserveView)===!0)){const d=e.initialView,p=d.yaw||0;this.yaw===0&&p!==0&&(this.yaw=-p),this.pitch=d.pitch||0;const m=x[this.renderProfile];this.fov=d.fov!==void 0?d.fov:m.camera.defaultFov,this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),this.updateCamera()}this.lastYaw=this.yaw,this.lastPitch=this.pitch,this.lastFov=this.fov,this.isViewChanging=!1;const r=-(typeof e.northYaw=="number"?e.northYaw:((l=e.initialView)==null?void 0:l.yaw)??0);this.nadirPatch&&this.nadirPatch.setNorthYaw(r),this.compassDisk&&(this.compassDisk.setSceneId(e.id),this.compassDisk.setNorthYaw(r)),this.groundHeading&&this.groundHeading.setNorthYaw(r);const n=new de(500,64,64);n.scale(-1,1,1);const h=e.panoTiles;if(h!=null&&h.manifest){const d=A(h.manifest,R.PANO),p=h.fallbackPanoLow||e.panoLow,m=h.fallbackPano||e.pano,b=!!(p||m);this.tilesVisibleStableFrames=0,this.tilesLastError="",this.tilesLowReady=!1,this.tilesLastLoadedCount=0,this.tilesLastProgressAt=performance.now(),this.tilesHighStartAt=0,this.tilesDegradedNotified=!1,p?this.showFallbackTexture(A(p,R.PANO_LOW),n,!0):m&&this.showFallbackTexture(A(m,R.PANO),n,!1);const M=()=>{this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(v.LOW_READY),this.setRenderSource("low","tiles 首屏可见"),this.onLoadCallback&&this.onLoadCallback()),this.loadStatus!==v.HIGH_READY&&this.updateLoadStatus(v.LOADING_HIGH)},T=()=>{this.updateLoadStatus(v.HIGH_READY),this.setRenderSource("tiles","tiles 高清可见"),this.isDegradedMode=!1};je(d).then(async w=>{if(w.tileFormat==="ktx2"){const{TileMeshPano:C}=await we(async()=>{const{TileMeshPano:L}=await import("./tile-ktx2-DPKiKnrw.js");return{TileMeshPano:L}},__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url);this.tilePano=new C(this.scene,this.renderer,M,T)}else this.tilePano=new Be(this.scene,M,T,this.renderer.capabilities.maxTextureSize||0);return this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode(this.perfMode),this.tilePano.load(w,{fallbackVisible:b})}).then(()=>{var w;this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(v.LOW_READY),this.onLoadCallback&&this.onLoadCallback()),(w=this.tilePano)==null||w.prime(this.camera)}).catch(w=>{console.error("瓦片加载失败，回退传统全景",w),this.tilesLastError=w instanceof Error?w.message:String(w),re("瓦片加载失败，已回退到全景图",2e3),this.fallbackToLegacy(e,h)});return}const o=A(e.panoLow,R.PANO_LOW),c=A(e.pano,R.PANO);if(Ce()==="low"){if(o){this.loadSingleTexture(n,o,!0);return}if(c){this.loadSingleTexture(n,c,!1);return}}else{if(!o&&c){this.loadSingleTexture(n,c,!1);return}if(o&&!c){this.loadSingleTexture(n,o,!0);return}if(o&&c){this.loadProgressiveTextures(n,o,c);return}}this.updateLoadStatus(v.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("场景未提供全景图 URL"))}async loadSingleTexture(e,t,s){s?this.updateLoadStatus(v.LOADING_LOW):this.updateLoadStatus(v.LOADING_HIGH);try{const a=await F(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY",channel:"pano"}),r=new Y(a);this.applyTextureSettings(r),this.warnIfNotPanoAspect(r,t),r.flipY=!1,r.wrapS=P,r.wrapT=P,r.needsUpdate=!0;const n=new _({map:r});this.sphere=new H(e,n),this.scene.add(this.sphere),this.setRenderSource(s?"low":"tiles",s?"panoLow 可见":"pano 可见"),s?this.updateLoadStatus(v.LOW_READY):this.updateLoadStatus(v.HIGH_READY),this.onLoadCallback&&this.onLoadCallback()}catch(a){if(console.error("加载全景图失败",t,a),this.updateLoadStatus(v.ERROR),this.onErrorCallback){const r=a instanceof Re?`加载全景图失败：${t} - ${a.message}`:`加载全景图失败：${t}`;this.onErrorCallback(new Error(r))}}}async loadProgressiveTextures(e,t,s){this.updateLoadStatus(v.LOADING_LOW);try{const a=await F(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY",channel:"pano"}),r=new Y(a);this.applyTextureSettings(r),this.warnIfNotPanoAspect(r,t),r.flipY=!1,r.wrapS=P,r.wrapT=P,r.needsUpdate=!0;const n=new _({map:r});this.sphere=new H(e,n),this.scene.add(this.sphere),this.setRenderSource("low","panoLow 可见"),this.updateLoadStatus(v.LOW_READY),this.onLoadCallback&&this.onLoadCallback(),this.updateLoadStatus(v.LOADING_HIGH);try{const h=await F(s,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"low",imageOrientation:"flipY",channel:"pano"}),o=new Y(h);this.applyTextureSettings(o),this.warnIfNotPanoAspect(o,s),o.flipY=!1,o.wrapS=P,o.wrapT=P,o.needsUpdate=!0;const c=this.getCurrentView();if(this.sphere&&this.sphere.material&&"map"in this.sphere.material){const u=this.sphere.material;u.map&&u.map.dispose(),u.map=o,u.needsUpdate=!0,this.setRenderSource("tiles","pano 高清可见")}this.setView(c.yaw,c.pitch,c.fov),this.updateLoadStatus(v.HIGH_READY),this.isDegradedMode=!1}catch(h){console.error("高清全景图加载失败，继续使用低清",s,h),this.isDegradedMode=!0,this.updateLoadStatus(v.DEGRADED)}}catch(a){console.error("低清全景图加载失败，尝试加载高清兜底",t,a),await this.loadSingleTexture(e,s,!1)}}setOnLoad(e){this.onLoadCallback=e}setOnError(e){this.onErrorCallback=e}setOnStatusChange(e){this.onStatusChangeCallback=e}getLoadStatus(){return this.loadStatus}resetMetrics(e){const t=performance.now();this.metrics={sceneId:e,startAt:t,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:this.perfMode,renderSource:this.renderSource,lastError:""},this.emitMetrics("reset",!0)}emitMetrics(e,t=!1){var p;const s=performance.now();if(!t&&s-this.lastMetricsEmitAt<800)return;const a=(p=this.tilePano)==null?void 0:p.getStatus(),r=(a==null?void 0:a.tilesLoadedCount)??0,n=(a==null?void 0:a.tilesFailedCount)??0,h=(a==null?void 0:a.tilesRetryCount)??0,o=r+n,c=o>0?Number((r/o*100).toFixed(2)):0;this.metrics.tilesLoaded=r,this.metrics.tilesFailed=n,this.metrics.tilesRetries=h,this.metrics.tileHitRate=c,this.metrics.perfMode=this.perfMode,this.metrics.renderSource=this.renderSource,this.metrics.lastError=this.tilesLastError||((a==null?void 0:a.lastError)??"");const u=this.metrics.lowReadyAt?Math.round(this.metrics.lowReadyAt-this.metrics.startAt):-1,l=this.metrics.highReadyAt?Math.round(this.metrics.highReadyAt-this.metrics.startAt):-1,d={...this.metrics,lowReadyMs:u,highReadyMs:l,reason:e,at:Math.round(s)};window.__VR_METRICS__=d,window.dispatchEvent(new CustomEvent("vr:metrics",{detail:d})),this.lastMetricsEmitAt=s}isInDegradedMode(){return this.isDegradedMode}updateLoadStatus(e){if(this.loadStatus===e)return;this.loadStatus=e;const t=performance.now();e===v.LOW_READY&&this.metrics.lowReadyAt===0&&(this.metrics.lowReadyAt=t),e===v.HIGH_READY&&this.metrics.highReadyAt===0&&(this.metrics.highReadyAt=t),this.onStatusChangeCallback&&this.onStatusChangeCallback(e),this.emitMetrics(`status:${e}`)}getCurrentView(){return{yaw:this.yaw,pitch:this.pitch,fov:this.fov}}setView(e,t,s){this.yaw=e,this.pitch=Math.max(-90,Math.min(90,t)),s!==void 0&&this.setFovInternal(s,!1),this.updateCamera()}setFovInternal(e,t=!0){if(this.fov=Math.max(30,Math.min(120,e)),this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),t){const s=x[this.renderProfile].camera.defaultFov,a=Math.round(s/this.fov*100),r=Math.max(50,Math.min(250,a));j.show(r)}}setFov(e){this.setFovInternal(e,!0)}setVrModeEnabled(e){this.vrModeEnabled=e,e||(this.isDragging=!1)}isVrModeEnabled(){return this.vrModeEnabled}isInteracting(){return this.isDragging||this.isPinching}handleResize(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}updatePerformanceGuard(e){const t=1e3/Math.max(1,e);if(this.perfSamples.push(t),this.perfSamples.length>30&&this.perfSamples.shift(),!this.allowTilePerfThrottle)return;const s=this.perfSamples.reduce((r,n)=>r+n,0)/this.perfSamples.length,a=performance.now();s<28&&this.perfMode==="normal"&&a-this.perfLastChangeAt>2e3&&(this.perfMode="throttle",this.perfLastChangeAt=a,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("throttle"),this.emitMetrics("perf:throttle",!0)),s>45&&this.perfMode==="throttle"&&a-this.perfLastChangeAt>3e3&&(this.perfMode="normal",this.perfLastChangeAt=a,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("normal"),this.emitMetrics("perf:normal",!0))}updateTilesDebug(){var C;const e=new URLSearchParams(window.location.search);if(!(e.get("tilesDebug")==="1"||e.get("tilesDebug")==="true"||e.get("tilesDebug")==="on")){this.tilesDebugEl&&(this.tilesDebugEl.remove(),this.tilesDebugEl=null);return}if(!this.tilesDebugEl){const L=document.createElement("div");L.style.position="absolute",L.style.left="8px",L.style.top="8px",L.style.padding="6px 8px",L.style.background="rgba(0,0,0,0.55)",L.style.color="#fff",L.style.fontSize="12px",L.style.lineHeight="1.4",L.style.borderRadius="6px",L.style.zIndex="9999",L.style.pointerEvents="none",this.tilesDebugEl=L,this.container.appendChild(L)}const s=(C=this.tilePano)==null?void 0:C.getStatus(),a=this.tilePano?"tiles":"fallback",r=s!=null&&s.tilesVisible?"true":"false",n=(s==null?void 0:s.tilesLoadedCount)??0,h=(s==null?void 0:s.tilesLoadingCount)??0,o=(s==null?void 0:s.tilesQueuedCount)??0,c=(s==null?void 0:s.lastTileUrl)??"",u=this.tilesLastError||(s==null?void 0:s.lastError)||"",l=this.fallbackSphere?"true":"false",d=(s==null?void 0:s.canvasSize)??"",p=(s==null?void 0:s.maxLevel)??"",m=s!=null&&s.highReady?"true":"false",b=(s==null?void 0:s.levels)??"",M=this.renderSource,T=this.renderSwitchReason,w=this.clearedCount;this.tilesDebugEl.textContent=`mode=${a}
renderSource=${M}
switchReason=${T}
cleared=${w}
fallbackVisible=${l}
tilesVisible=${r}
tilesLoaded=${n}
tilesLoading=${h}
tilesQueued=${o}
lastTileUrl=${c}
lastError=${u}
canvas=${d} zMax=${p} levels=${b} highReady=${m}
lowReady=${this.tilesLowReady}`}animate(){if(this.disposed)return;this.animationFrameId=requestAnimationFrame(()=>this.animate());const e=performance.now(),t=this.lastFrameTimeMs?e-this.lastFrameTimeMs:16.7;this.updatePerformanceGuard(t),this.lastFrameTimeMs=e,this.applyPendingViewDelta();const s=this.getCurrentView(),a=Math.abs(s.yaw-this.lastYaw),r=Math.abs(s.pitch-this.lastPitch),n=Math.abs(s.fov-this.lastFov);if(a>this.viewChangeThreshold||r>this.viewChangeThreshold||n>this.viewChangeThreshold?this.isViewChanging||(this.isViewChanging=!0,S.emitInteracting()):this.isViewChanging&&(this.isViewChanging=!1,S.scheduleIdle()),this.lastYaw=s.yaw,this.lastPitch=s.pitch,this.lastFov=s.fov,this.updateCamera(),this.tilePano){this.tilePano.update(this.camera);const o=this.tilePano.getStatus(),c=!!this.fallbackSphere,u=o.tilesVisible,l=o.lowReady;c&&u&&l?(this.tilesVisibleStableFrames+=1,this.tilesVisibleStableFrames>=2&&this.clearFallback()):this.tilesVisibleStableFrames=0,!c&&!u&&this.noteCleared("无可见源"),u&&this.renderSource==="fallback"&&this.tilesLowReady&&this.setRenderSource("low","tiles 低清覆盖可见"),u&&o.highReady&&this.setRenderSource("tiles","tiles 高清可见"),o.lastError&&(this.tilesLastError=o.lastError),!this.tilesLowReady&&o.tilesLoadedCount>0&&(this.tilesLowReady=!0,this.updateLoadStatus(v.LOW_READY)),o.highReady&&(this.updateLoadStatus(v.HIGH_READY),this.isDegradedMode=!1,this.tilesDegradedNotified=!1),o.tilesLoadedCount>this.tilesLastLoadedCount&&(this.tilesLastLoadedCount=o.tilesLoadedCount,this.tilesLastProgressAt=e,this.tilesDegradedNotified&&!o.highReady&&(this.tilesDegradedNotified=!1)),this.tilesHighStartAt===0&&(o.tilesQueuedCount>0||o.tilesLoadingCount>0)&&(this.tilesHighStartAt=e,this.tilesLastProgressAt===0&&(this.tilesLastProgressAt=e)),this.tilesHighStartAt>0&&e-this.tilesLastProgressAt>12e3&&!o.highReady&&!this.tilesDegradedNotified&&this.tilesLowReady&&(this.isDegradedMode=!0,this.updateLoadStatus(v.DEGRADED),this.tilesDegradedNotified=!0)}this.updateTilesDebug(),this.emitMetrics("frame"),this.nadirPatch&&this.nadirPatch.update(this.camera,{yaw:s.yaw,pitch:s.pitch},t),this.compassDisk&&this.compassDisk.setYawPitch(s.yaw,s.pitch),this.groundNavDots&&this.groundNavDots.setYawPitch(s.yaw,s.pitch),this.groundHeading&&this.groundHeading.setYawPitch(s.yaw,s.pitch);for(const o of this.frameListeners)o(t);this.disposed||this.renderer.render(this.scene,this.camera)}onFrame(e){return this.frameListeners.push(e),()=>{const t=this.frameListeners.indexOf(e);t>=0&&this.frameListeners.splice(t,1)}}getCamera(){return this.camera}getDomElement(){return this.renderer.domElement}setSceneData(e,t,s){if(this.groundNavDots){const a=s.filter(r=>{var n;return r.type==="scene"&&((n=r.target)==null?void 0:n.sceneId)}).map(r=>({id:r.id,label:r.label,yaw:r.yaw,pitch:r.pitch,target:{museumId:r.target.museumId,sceneId:r.target.sceneId}}));this.groundNavDots.updateScene(e,t,a)}}getSphereRadius(){return 500}getViewportSize(){return{width:this.container.clientWidth,height:this.container.clientHeight}}enablePickMode(){this.pickMode||(this.pickMode=!0,this.setupPickModeListeners())}disablePickMode(){this.pickMode&&(this.pickMode=!1,this.removePickModeListeners())}togglePickMode(){return this.pickMode?this.disablePickMode():this.enablePickMode(),this.pickMode}isPickModeEnabled(){return this.pickMode}setupPickModeListeners(){const e=this.renderer.domElement,t=r=>{if(!this.pickMode)return;let n,h;if(r instanceof TouchEvent){if(r.touches.length!==1)return;n=r.touches[0].clientX,h=r.touches[0].clientY}else n=r.clientX,h=r.clientY;this.pickStartX=n,this.pickStartY=h,this.pickStartTime=Date.now(),this.pickHasMoved=!1},s=r=>{if(!this.pickMode)return;let n,h;if(r instanceof TouchEvent){if(r.touches.length!==1)return;n=r.touches[0].clientX,h=r.touches[0].clientY}else n=r.clientX,h=r.clientY;const o=Math.abs(n-this.pickStartX),c=Math.abs(h-this.pickStartY);Math.sqrt(o*o+c*c)>this.pickDragThreshold&&(this.pickHasMoved=!0)},a=r=>{if(!this.pickMode)return;let n,h;if(r instanceof TouchEvent){if(r.changedTouches.length!==1)return;n=r.changedTouches[0].clientX,h=r.changedTouches[0].clientY}else n=r.clientX,h=r.clientY;const o=Date.now()-this.pickStartTime,c=Math.abs(n-this.pickStartX),u=Math.abs(h-this.pickStartY);Math.sqrt(c*c+u*u)>this.pickDragThreshold||o>this.pickTimeThreshold&&this.pickHasMoved||this.handlePick(n,h),this.pickHasMoved=!1};e.addEventListener("pointerdown",t),e.addEventListener("mousedown",t),e.addEventListener("touchstart",t,{passive:!0}),e.addEventListener("pointermove",s),e.addEventListener("mousemove",s),e.addEventListener("touchmove",s,{passive:!0}),e.addEventListener("pointerup",a),e.addEventListener("mouseup",a),e.addEventListener("touchend",a,{passive:!0}),this.pickModeListeners.push(()=>{e.removeEventListener("pointerdown",t),e.removeEventListener("mousedown",t),e.removeEventListener("touchstart",t),e.removeEventListener("pointermove",s),e.removeEventListener("mousemove",s),e.removeEventListener("touchmove",s),e.removeEventListener("pointerup",a),e.removeEventListener("mouseup",a),e.removeEventListener("touchend",a)})}removePickModeListeners(){this.pickModeListeners.forEach(e=>e()),this.pickModeListeners=[]}handlePick(e,t){const s=this.renderer.domElement.getBoundingClientRect(),a=xe(e,t,s),r=Ae(a.x,a.y,this.camera,this.getSphereRadius());if(!r){typeof __VR_DEBUG__<"u"&&__VR_DEBUG__&&console.debug("[pick] 无法计算 yaw/pitch（ray.direction 为空）");return}const{yaw:n,pitch:h}=r,o=`yaw: ${n.toFixed(2)}, pitch: ${h.toFixed(2)}`;console.log(`[pick] yaw=${n.toFixed(2)}, pitch=${h.toFixed(2)}`),navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(o).catch(()=>{}),window.dispatchEvent(new CustomEvent("vr:pick",{detail:{x:e,y:t,yaw:n,pitch:h}}))}warnIfNotPanoAspect(e,t){if(!e.image)return;const s=e.image,a=s.width,r=s.height;if(!a||!r)return;const n=a/r;Math.abs(n-2)>.02&&!this.aspectWarnedUrls.has(t)&&(console.warn(`[PanoViewer] 全景图比例不是 2:1，可能出现轻微变形（实际 ${n.toFixed(2)}），来源: ${t}`),this.aspectWarnedUrls.add(t))}dispose(){if(!this.disposed){if(this.disposed=!0,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.removePickModeListeners(),this.clearDomEvents(),this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const e=this.sphere.material;e.map&&e.map.dispose(),e.dispose()}this.nadirPatch&&(this.nadirPatch.dispose(this.scene),this.nadirPatch=null),this.compassDisk&&(this.compassDisk.dispose(),this.compassDisk=null),this.groundNavDots&&(this.groundNavDots.dispose(),this.groundNavDots=null),this.groundHeading&&(this.groundHeading.dispose(),this.groundHeading=null),this.frameListeners=[],this.renderer.dispose(),window.removeEventListener("resize",this.handleWindowResize)}}applyRendererProfile(){const e=x[this.renderProfile];this.renderer.setPixelRatio(e.renderer.pixelRatio),"outputColorSpace"in this.renderer?this.renderer.outputColorSpace=z:this.renderer.outputEncoding=B,this.renderer.toneMapping=e.renderer.toneMapping,this.renderer.toneMappingExposure=e.renderer.toneMappingExposure,e.renderer.clearColor&&this.renderer.setClearColor(e.renderer.clearColor.color,e.renderer.clearColor.alpha)}detectRenderProfile(){try{const t=new URLSearchParams(window.location.search).get("render");if(t&&t.toLowerCase()==="original")return"original"}catch{}return"enhanced"}detectTileThrottleEnabled(){try{return new URLSearchParams(window.location.search).get("tileThrottle")==="1"}catch{return!1}}fallbackToLegacy(e,t){const s={...e,pano:(t==null?void 0:t.fallbackPano)??e.pano,panoLow:(t==null?void 0:t.fallbackPanoLow)??e.panoLow,panoTiles:void 0};s.pano||s.panoLow?(re("瓦片加载失败，已回退到全景图",2e3),this.setRenderSource("fallback","tiles 失败自动回退"),this.loadScene(s,{preserveView:!0})):(this.updateLoadStatus(v.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("瓦片与全景资源均不可用")))}setRenderSource(e,t){(this.renderSource!==e||t)&&(this.renderSource=e,this.renderSwitchReason=t)}noteCleared(e){this.clearedCount+=1,this.renderSwitchReason=e}async showFallbackTexture(e,t,s){try{const a=await F(e,{timeoutMs:15e3,retries:1,allowFetchFallback:!0,priority:"high",imageOrientation:"flipY",channel:"pano"}),r=new Y(a);this.applyTextureSettings(r),r.flipY=!1,r.wrapS=P,r.wrapT=P,r.needsUpdate=!0;const n=new _({map:r,depthWrite:!1,depthTest:!1}),h=new H(t.clone(),n);h.renderOrder=0,this.fallbackSphere=h,this.scene.add(h),this.updateLoadStatus(s?v.LOW_READY:v.HIGH_READY),this.setRenderSource("fallback",s?"fallback 低清可见":"fallback 高清可见"),s&&(this.tilesLowReady=!0),this.onLoadCallback&&this.onLoadCallback()}catch(a){console.error("fallback 贴图加载失败",a)}}clearFallback(){if(this.fallbackSphere){this.fallbackSphere.geometry&&this.fallbackSphere.geometry.dispose();const e=this.fallbackSphere.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.fallbackSphere),this.fallbackSphere=null}}applyTextureSettings(e){const t=x[this.renderProfile],s=this.renderer.capabilities.getMaxAnisotropy?this.renderer.capabilities.getMaxAnisotropy():1;if(e.anisotropy=Math.min(t.texture.anisotropyLimit,Math.max(1,s||1)),e.minFilter=t.texture.minFilter,e.magFilter=t.texture.magFilter,e.generateMipmaps=t.texture.generateMipmaps,"colorSpace"in e?e.colorSpace=z:e.encoding=B,e.needsUpdate=!0,this.debugMode){const a=e.image||{};console.log("pano texture",{w:a.width,h:a.height,colorSpace:e.colorSpace,encoding:e.encoding,anisotropy:e.anisotropy,minFilter:e.minFilter,magFilter:e.magFilter})}}}const it=Object.freeze(Object.defineProperty({__proto__:null,PanoViewer:qe},Symbol.toStringTag,{value:"Module"}));export{it as P,Ge as d};
