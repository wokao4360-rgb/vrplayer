const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./PanoViewer-tVEm8XCm.js","./three-renderer-DqCmgmK_.js","./qualityPreference-BRkZdVpy.js","./externalImage-Cn8sVw7v.js","./BrandMark-CkNRyst5.js","./copyText-CwU0x1sN.js","./StructureView2D-BqbbJVBm.js","./autoLayout-ZgSeGcPI.js","./vrMode-Ck-2Ny7U.js","./three.module-Brkpord5.js","./appModals-D07anOPT.js","./Modal-Cmv3TBkb.js","./scene-runtime-B080iYiH.js","./warmupScheduler-BuA74CIq.js","./ConfigErrorPanel-B2eR8rYX.js","./errorMessages-DZWcJuiB.js","./editor-debug-Dy3AxbKg.js","./draftStorage-Be1LM_rK.js"])))=>i.map(i=>d[i]);
var ve=Object.defineProperty;var _e=(t,e,i)=>e in t?ve(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var a=(t,e,i)=>_e(t,typeof e!="symbol"?e+"":e,i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function i(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=i(s);fetch(s.href,r)}})();const Se="modulepreload",Pe=function(t,e){return new URL(t,e).href},j={},f=function(e,i,n){let s=Promise.resolve();if(i&&i.length>0){const o=document.getElementsByTagName("link"),u=document.querySelector("meta[property=csp-nonce]"),l=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));s=Promise.allSettled(i.map(c=>{if(c=Pe(c,n),c in j)return;j[c]=!0;const h=c.endsWith(".css"),m=h?'[rel="stylesheet"]':"";if(!!n)for(let _=o.length-1;_>=0;_--){const S=o[_];if(S.href===c&&(!h||S.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${m}`))return;const E=document.createElement("link");if(E.rel=h?"stylesheet":Se,h||(E.as="script"),E.crossOrigin="",E.href=c,l&&E.setAttribute("nonce",l),document.head.appendChild(E),h)return new Promise((_,S)=>{E.addEventListener("load",_),E.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(o){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=o,window.dispatchEvent(u),!u.defaultPrevented)throw o}return s.then(o=>{for(const u of o||[])u.status==="rejected"&&r(u.reason);return e().catch(r)})};var ye=(t=>(t.INVALID_ROOT="INVALID_ROOT",t.MISSING_APP_NAME="MISSING_APP_NAME",t.MUSEUMS_NOT_ARRAY="MUSEUMS_NOT_ARRAY",t.MUSEUMS_EMPTY="MUSEUMS_EMPTY",t.MISSING_MUSEUM_ID="MISSING_MUSEUM_ID",t.DUPLICATE_MUSEUM_ID="DUPLICATE_MUSEUM_ID",t.MISSING_MUSEUM_NAME="MISSING_MUSEUM_NAME",t.MISSING_MUSEUM_COVER="MISSING_MUSEUM_COVER",t.MISSING_MUSEUM_MAP="MISSING_MUSEUM_MAP",t.MISSING_MAP_IMAGE="MISSING_MAP_IMAGE",t.INVALID_MAP_WIDTH="INVALID_MAP_WIDTH",t.INVALID_MAP_HEIGHT="INVALID_MAP_HEIGHT",t.SCENES_NOT_ARRAY="SCENES_NOT_ARRAY",t.SCENES_EMPTY="SCENES_EMPTY",t.MISSING_SCENE_ID="MISSING_SCENE_ID",t.DUPLICATE_SCENE_ID="DUPLICATE_SCENE_ID",t.MISSING_SCENE_NAME="MISSING_SCENE_NAME",t.MISSING_PANO="MISSING_PANO",t.INVALID_PANO_URL="INVALID_PANO_URL",t.INVALID_PANOLOW_URL="INVALID_PANOLOW_URL",t.MISSING_THUMB="MISSING_THUMB",t.MISSING_INITIAL_VIEW="MISSING_INITIAL_VIEW",t.INVALID_YAW="INVALID_YAW",t.INVALID_PITCH="INVALID_PITCH",t.INVALID_FOV="INVALID_FOV",t.MISSING_MAP_POINT="MISSING_MAP_POINT",t.INVALID_MAP_POINT_X="INVALID_MAP_POINT_X",t.INVALID_MAP_POINT_Y="INVALID_MAP_POINT_Y",t.HOTSPOTS_NOT_ARRAY="HOTSPOTS_NOT_ARRAY",t.MISSING_HOTSPOT_ID="MISSING_HOTSPOT_ID",t.DUPLICATE_HOTSPOT_ID="DUPLICATE_HOTSPOT_ID",t.INVALID_HOTSPOT_TYPE="INVALID_HOTSPOT_TYPE",t.MISSING_HOTSPOT_LABEL="MISSING_HOTSPOT_LABEL",t.INVALID_HOTSPOT_YAW="INVALID_HOTSPOT_YAW",t.INVALID_HOTSPOT_PITCH="INVALID_HOTSPOT_PITCH",t.MISSING_HOTSPOT_TARGET="MISSING_HOTSPOT_TARGET",t.MISSING_TARGET_MUSEUM_ID="MISSING_TARGET_MUSEUM_ID",t.MISSING_TARGET_SCENE_ID="MISSING_TARGET_SCENE_ID",t.INVALID_TARGET_YAW="INVALID_TARGET_YAW",t.INVALID_TARGET_PITCH="INVALID_TARGET_PITCH",t.INVALID_TARGET_FOV="INVALID_TARGET_FOV",t.MISSING_TARGET_URL="MISSING_TARGET_URL",t))(ye||{});function Te(t){const e=[];if(!t||typeof t!="object")return e.push({code:"INVALID_ROOT",path:"root",message:"配置必须是对象",fieldName:"配置根对象"}),e;if((!t.appName||typeof t.appName!="string"||t.appName.trim()==="")&&e.push({code:"MISSING_APP_NAME",path:"appName",message:"appName 必须是非空字符串",fieldName:"应用名称"}),!Array.isArray(t.museums))return e.push({code:"MUSEUMS_NOT_ARRAY",path:"museums",message:"museums 必须是数组",fieldName:"博物馆列表"}),e;t.museums.length===0&&e.push({code:"MUSEUMS_EMPTY",path:"museums",message:"museums 数组不能为空",fieldName:"博物馆列表"});const i=new Set;return t.museums.forEach((n,s)=>{const r=`museums[${s}]`,o=n.name&&typeof n.name=="string"?n.name:void 0;if(!n.id||typeof n.id!="string"||n.id.trim()===""?e.push({code:"MISSING_MUSEUM_ID",path:`${r}.id`,message:"id 必须是非空字符串",museumName:o,fieldName:"博物馆 ID"}):(i.has(n.id)&&e.push({code:"DUPLICATE_MUSEUM_ID",path:`${r}.id`,message:`博物馆 ID "${n.id}" 重复`,museumName:o,fieldName:"博物馆 ID"}),i.add(n.id)),(!n.name||typeof n.name!="string"||n.name.trim()==="")&&e.push({code:"MISSING_MUSEUM_NAME",path:`${r}.name`,message:"name 必须是非空字符串",museumName:void 0,fieldName:"博物馆名称"}),(!n.cover||typeof n.cover!="string"||n.cover.trim()==="")&&e.push({code:"MISSING_MUSEUM_COVER",path:`${r}.cover`,message:"cover 必须是有效的 URL 字符串",museumName:o,fieldName:"封面图"}),!n.map||typeof n.map!="object"?e.push({code:"MISSING_MUSEUM_MAP",path:`${r}.map`,message:"map 必须是对象",museumName:o,fieldName:"地图配置"}):((!n.map.image||typeof n.map.image!="string"||n.map.image.trim()==="")&&e.push({code:"MISSING_MAP_IMAGE",path:`${r}.map.image`,message:"map.image 必须是有效的 URL 字符串",museumName:o,fieldName:"地图图片"}),(typeof n.map.width!="number"||n.map.width<=0)&&e.push({code:"INVALID_MAP_WIDTH",path:`${r}.map.width`,message:"map.width 必须是大于 0 的数字",museumName:o,fieldName:"地图宽度"}),(typeof n.map.height!="number"||n.map.height<=0)&&e.push({code:"INVALID_MAP_HEIGHT",path:`${r}.map.height`,message:"map.height 必须是大于 0 的数字",museumName:o,fieldName:"地图高度"})),!Array.isArray(n.scenes))e.push({code:"SCENES_NOT_ARRAY",path:`${r}.scenes`,message:"scenes 必须是数组",museumName:o,fieldName:"场景列表"});else{n.scenes.length===0&&e.push({code:"SCENES_EMPTY",path:`${r}.scenes`,message:"scenes 数组不能为空",museumName:o,fieldName:"场景列表"});const u=new Set;n.scenes.forEach((l,c)=>{var S;const h=`${r}.scenes[${c}]`,m=l.name&&typeof l.name=="string"?l.name:void 0;!l.id||typeof l.id!="string"||l.id.trim()===""?e.push({code:"MISSING_SCENE_ID",path:`${h}.id`,message:"id 必须是非空字符串",museumName:o,sceneName:m,fieldName:"场景 ID"}):(u.has(l.id)&&e.push({code:"DUPLICATE_SCENE_ID",path:`${h}.id`,message:`场景 ID "${l.id}" 在博物馆内重复`,museumName:o,sceneName:m,fieldName:"场景 ID"}),u.add(l.id)),(!l.name||typeof l.name!="string"||l.name.trim()==="")&&e.push({code:"MISSING_SCENE_NAME",path:`${h}.name`,message:"name 必须是非空字符串",museumName:o,sceneName:void 0,fieldName:"场景名称"});const v=!!l.pano,E=!!l.panoLow,_=!!((S=l.panoTiles)!=null&&S.manifest);if(!v&&!E&&!_?e.push({code:"MISSING_PANO",path:`${h}.pano`,message:"pano / panoLow / panoTiles 至少需要提供一个",museumName:o,sceneName:m,fieldName:"全景图"}):(l.pano&&(typeof l.pano!="string"||l.pano.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${h}.pano`,message:"pano 必须是有效的 URL 字符串",museumName:o,sceneName:m,fieldName:"高清全景图"}),l.panoLow&&(typeof l.panoLow!="string"||l.panoLow.trim()==="")&&e.push({code:"INVALID_PANOLOW_URL",path:`${h}.panoLow`,message:"panoLow 必须是有效的 URL 字符串",museumName:o,sceneName:m,fieldName:"低清全景图"}),l.panoTiles&&(typeof l.panoTiles!="object"?e.push({code:"INVALID_PANO_URL",path:`${h}.panoTiles`,message:"panoTiles 必须是对象，包含 manifest",museumName:o,sceneName:m,fieldName:"瓦片元数据"}):(!l.panoTiles.manifest||typeof l.panoTiles.manifest!="string"||l.panoTiles.manifest.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${h}.panoTiles.manifest`,message:"panoTiles.manifest 必须是有效的字符串",museumName:o,sceneName:m,fieldName:"瓦片 manifest"}))),(!l.thumb||typeof l.thumb!="string"||l.thumb.trim()==="")&&e.push({code:"MISSING_THUMB",path:`${h}.thumb`,message:"thumb 必须是有效的 URL 字符串",museumName:o,sceneName:m,fieldName:"缩略图"}),!l.initialView||typeof l.initialView!="object"?e.push({code:"MISSING_INITIAL_VIEW",path:`${h}.initialView`,message:"initialView 必须是对象",museumName:o,sceneName:m,fieldName:"初始视角"}):(typeof l.initialView.yaw!="number"&&e.push({code:"INVALID_YAW",path:`${h}.initialView.yaw`,message:"initialView.yaw 必须是数字",museumName:o,sceneName:m,fieldName:"水平角度"}),typeof l.initialView.pitch!="number"&&e.push({code:"INVALID_PITCH",path:`${h}.initialView.pitch`,message:"initialView.pitch 必须是数字",museumName:o,sceneName:m,fieldName:"垂直角度"}),l.initialView.fov!==void 0&&typeof l.initialView.fov!="number"&&e.push({code:"INVALID_FOV",path:`${h}.initialView.fov`,message:"initialView.fov 必须是数字",museumName:o,sceneName:m,fieldName:"视野角度"})),!l.mapPoint||typeof l.mapPoint!="object"?e.push({code:"MISSING_MAP_POINT",path:`${h}.mapPoint`,message:"mapPoint 必须是对象",museumName:o,sceneName:m,fieldName:"地图点位"}):(typeof l.mapPoint.x!="number"&&e.push({code:"INVALID_MAP_POINT_X",path:`${h}.mapPoint.x`,message:"mapPoint.x 必须是数字",museumName:o,sceneName:m,fieldName:"地图点位 X 坐标"}),typeof l.mapPoint.y!="number"&&e.push({code:"INVALID_MAP_POINT_Y",path:`${h}.mapPoint.y`,message:"mapPoint.y 必须是数字",museumName:o,sceneName:m,fieldName:"地图点位 Y 坐标"})),!Array.isArray(l.hotspots))e.push({code:"HOTSPOTS_NOT_ARRAY",path:`${h}.hotspots`,message:"hotspots 必须是数组",museumName:o,sceneName:m,fieldName:"热点列表"});else{const x=new Set;l.hotspots.forEach((p,G)=>{const d=`${h}.hotspots[${G}]`;!p.id||typeof p.id!="string"||p.id.trim()===""?e.push({code:"MISSING_HOTSPOT_ID",path:`${d}.id`,message:"id 必须是非空字符串",museumName:o,sceneName:m,fieldName:"热点 ID"}):(x.has(p.id)&&e.push({code:"DUPLICATE_HOTSPOT_ID",path:`${d}.id`,message:`热点 ID "${p.id}" 在场景内重复`,museumName:o,sceneName:m,fieldName:"热点 ID"}),x.add(p.id)),p.type!=="scene"&&p.type!=="video"&&p.type!=="image"&&p.type!=="info"&&e.push({code:"INVALID_HOTSPOT_TYPE",path:`${d}.type`,message:'type 必须是 "scene"、"video"、"image" 或 "info"',museumName:o,sceneName:m,fieldName:"热点类型"}),(!p.label||typeof p.label!="string"||p.label.trim()==="")&&e.push({code:"MISSING_HOTSPOT_LABEL",path:`${d}.label`,message:"label 必须是非空字符串",museumName:o,sceneName:m,fieldName:"热点标签"}),typeof p.yaw!="number"&&e.push({code:"INVALID_HOTSPOT_YAW",path:`${d}.yaw`,message:"yaw 必须是数字",museumName:o,sceneName:m,fieldName:"热点水平角度"}),typeof p.pitch!="number"&&e.push({code:"INVALID_HOTSPOT_PITCH",path:`${d}.pitch`,message:"pitch 必须是数字",museumName:o,sceneName:m,fieldName:"热点垂直角度"}),p.type==="scene"?!p.target||typeof p.target!="object"?e.push({code:"MISSING_HOTSPOT_TARGET",path:`${d}.target`,message:"scene 类型热点必须提供 target 对象",museumName:o,sceneName:m,fieldName:"热点目标配置"}):((!p.target.museumId||typeof p.target.museumId!="string")&&e.push({code:"MISSING_TARGET_MUSEUM_ID",path:`${d}.target.museumId`,message:"scene 类型热点的 target.museumId 必须是非空字符串",museumName:o,sceneName:m,fieldName:"目标博物馆 ID"}),typeof p.target.sceneId!="string"&&e.push({code:"MISSING_TARGET_SCENE_ID",path:`${d}.target.sceneId`,message:"scene 类型热点的 target.sceneId 必须是字符串（允许空字符串，用户后续补全）",museumName:o,sceneName:m,fieldName:"目标场景 ID"}),p.target.yaw!==void 0&&typeof p.target.yaw!="number"&&e.push({code:"INVALID_TARGET_YAW",path:`${d}.target.yaw`,message:"target.yaw 必须是数字",museumName:o,sceneName:m,fieldName:"目标水平角度"}),p.target.pitch!==void 0&&typeof p.target.pitch!="number"&&e.push({code:"INVALID_TARGET_PITCH",path:`${d}.target.pitch`,message:"target.pitch 必须是数字",museumName:o,sceneName:m,fieldName:"目标垂直角度"}),p.target.fov!==void 0&&typeof p.target.fov!="number"&&e.push({code:"INVALID_TARGET_FOV",path:`${d}.target.fov`,message:"target.fov 必须是数字",museumName:o,sceneName:m,fieldName:"目标视野角度"})):p.type==="video"&&p.target&&typeof p.target!="object"&&e.push({code:"MISSING_HOTSPOT_TARGET",path:`${d}.target`,message:"video 类型热点的 target 必须是对象（如果提供）",museumName:o,sceneName:m,fieldName:"热点目标配置"})})}})}}),e}let A=null;async function K(){if(A)return A;try{const t=await fetch("./config.json",{cache:"no-store"});if(!t.ok)throw new Error(`加载配置失败: ${t.status}`);const e=await t.json(),i=Te(e);if(i.length>0){const n=new Error("配置校验失败");throw n.validationErrors=i,n}return A=e,A}catch(t){throw console.error("加载配置失败:",t),t}}function X(){A=null}function F(t){if(A)return A.museums.find(e=>e.id===t)}function Ne(t,e){const i=F(t);if(i)return i.scenes.find(n=>n.id===e)}function ae(t){const e=new URL(window.location.href);return e.search="",Object.entries(t).forEach(([i,n])=>{n!=null&&n!==""&&e.searchParams.set(i,String(n))}),e.pathname+e.search+e.hash}function be(){return window.location.pathname}function De(){if(window.location.pathname.includes("//")){const t=window.location.pathname.replace(/\/{2,}/g,"/");history.replaceState({},"",t+window.location.search+window.location.hash)}}let Q=null,J=0;const Le=200;function Ae(t){if(t.type==="focus"){const e=`${t.museumId}:${t.sceneId}`,i=Date.now();if(e===Q&&i-J<Le)return;Q=e,J=i}window.dispatchEvent(new CustomEvent("vr:scene-focus",{detail:t}))}function yt(t){const e=i=>{t(i.detail)};return window.addEventListener("vr:scene-focus",e),()=>{window.removeEventListener("vr:scene-focus",e)}}function Z(){const t=new URLSearchParams(window.location.search),e=t.get("yaw"),i=t.get("pitch"),n=t.get("fov");return{museumId:t.get("museum")||void 0,sceneId:t.get("scene")||void 0,yaw:e?parseFloat(e):void 0,pitch:i?parseFloat(i):void 0,fov:n?parseFloat(n):void 0}}function Ve(){return new URLSearchParams(window.location.search).get("debug")==="1"}function Re(){const t=new URLSearchParams(window.location.search);return t.get("editor")==="1"||t.get("debug")==="1"}function ee(){const t=be();window.history.pushState({},"",t),window.dispatchEvent(new Event("popstate"))}function te(t){const e=ae({museum:t});window.history.pushState({},"",e),window.dispatchEvent(new Event("popstate"))}function H(t,e,i){const n=ae({museum:t,scene:e,yaw:i==null?void 0:i.yaw,pitch:i==null?void 0:i.pitch,fov:i==null?void 0:i.fov});window.history.pushState({},"",n),Ae({type:"focus",museumId:t,sceneId:e,source:"dock",ts:Date.now()}),window.dispatchEvent(new Event("popstate"))}function Y(){const t=document;return!!(document.fullscreenElement||t.webkitFullscreenElement)}function Oe(){const t=()=>{};document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t)}class Ce{constructor(){a(this,"element");this.element=document.createElement("div"),this.element.className="loading-overlay",this.render(),this.applyStyles();const e=()=>{Y()&&this.hide()};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}render(){this.element.innerHTML=`
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">加载中...</p>
      </div>
    `}applyStyles(){const e=document.createElement("style");e.textContent=`
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .loading-overlay.show {
        opacity: 1;
        pointer-events: all;
      }
      .loading-spinner {
        text-align: center;
        color: #fff;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }
      .loading-text {
        font-size: 14px;
        margin: 0;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    `,document.head.appendChild(e)}show(){Y()||this.element.classList.add("show")}hide(){this.element.classList.remove("show")}getElement(){return this.element}remove(){this.element.remove()}}var M=(t=>(t.LOADING_LOW="loadingLow",t.LOW_READY="lowReady",t.LOADING_HIGH="loadingHigh",t.HIGH_READY="highReady",t.DEGRADED="degraded",t.ERROR="error",t))(M||{}),le=(t=>(t.THUMB="thumb",t.PANO_LOW="panoLow",t.PANO="pano",t.VIDEO="video",t.COVER="cover",t.MAP="map",t.DOLLHOUSE="dollhouse",t))(le||{});const Ue=["/assets/panos/"],ke=[],xe="/config.json",Ge=1e3,k="vrplayer.assetCdn.lastSuccess",He=12*60*60*1e3;let U=null,V=null,T="idle",D=0;function Be(t){const e=t.trim();return e?e.startsWith("/")?e:`/${e}`:""}function ie(t,e){const i=Array.isArray(t)&&t.length>0?t:e,n=new Set;for(const s of i){if(typeof s!="string")continue;const r=Be(s);r&&n.add(r)}return Array.from(n)}function ue(t){return t.replace(/\/+$/,"")}function $e(t){const e=[];Array.isArray(t.baseUrls)&&e.push(...t.baseUrls),typeof t.baseUrl=="string"&&e.push(t.baseUrl);const i=new Set;for(const n of e){if(typeof n!="string")continue;const s=ue(n.trim());s&&i.add(s)}return Array.from(i)}function Fe(){var t;return typeof window<"u"&&((t=window.location)!=null&&t.origin)?window.location.origin:typeof location<"u"&&location.origin?location.origin:null}function q(){if(typeof window>"u")return null;try{return window.localStorage}catch{return null}}function Ye(t){const e=q();if(!e)return null;try{const i=e.getItem(k);if(!i)return null;const n=JSON.parse(i),s=typeof n.baseUrl=="string"?ue(n.baseUrl.trim()):"",r=typeof n.expiresAt=="number"&&Number.isFinite(n.expiresAt)?n.expiresAt:0;return!s||r<=Date.now()||!t.baseUrls.includes(s)?(e.removeItem(k),null):s}catch{return e.removeItem(k),null}}function We(t,e){const i=q();if(!i||!e.baseUrls.includes(t))return;const n=Date.now(),s={baseUrl:t,updatedAt:n,expiresAt:n+He};try{i.setItem(k,JSON.stringify(s))}catch{}}function ne(){const t=q();if(t)try{t.removeItem(k)}catch{}}function de(t){const e=t.match(/^([^?#]*)([?#].*)?$/);return e?{path:e[1]||"",suffix:e[2]||""}:{path:t,suffix:""}}function oe(t,e){return e.some(i=>t.startsWith(i))}function ce(t,e){return!(!oe(t,e.includePrefixes)||oe(t,e.excludePrefixes))}function he(t,e){const{path:i,suffix:n}=de(t);return`${e}${i}${n}`}function qe(t,e,i){if(!/^https?:\/\//i.test(t))return null;try{const n=new URL(t),s=Fe();return!s||n.origin!==s||!ce(n.pathname,e)?null:he(`${n.pathname}${n.search}${n.hash}`,i)}catch{return null}}function ze(t){if(typeof t!="string"||t.trim()==="")return xe;const e=t.trim();return e.startsWith("/")?e:`/${e}`}function je(t,e){const i=e.includes("?")?"&":"?";return`${t}${e}${i}__cdn_probe=${Date.now()}`}async function Ke(t,e,i){if(i!==D||typeof window>"u"||typeof fetch!="function")return!1;const n=typeof AbortController<"u"?new AbortController:null,s=window.setTimeout(()=>n==null?void 0:n.abort(),e.probeTimeoutMs);try{return(await fetch(je(t,e.probePath),{method:"GET",mode:"cors",cache:"no-store",referrerPolicy:"no-referrer",signal:n==null?void 0:n.signal})).ok}catch{return!1}finally{window.clearTimeout(s)}}async function Xe(t,e){if(t.baseUrls.length===0)return null;const i=t.baseUrls.map(async o=>{if(!await Ke(o,t,e))throw new Error(`probe failed: ${o}`);return o}),n=Promise.any;if(typeof n=="function")try{return await n.call(Promise,i)}catch{return null}const r=(await Promise.all(i.map(o=>o.then(u=>({ok:!0,baseUrl:u})).catch(()=>({ok:!1,baseUrl:null}))))).find(o=>o.ok&&typeof o.baseUrl=="string");return(r==null?void 0:r.baseUrl)??null}function W(t=!1){const e=U;if(!e||!e.enabled||!t&&V||T==="probing")return;if(typeof window>"u"||typeof fetch!="function"){T="failed";return}T="probing";const i=++D;(async()=>{const n=await Xe(e,i);if(i===D){if(n){V=n,We(n,e),T="ok";return}i===D&&(V=null,ne(),T="failed")}})().catch(()=>{i===D&&(V=null,ne(),T="failed")}).finally(()=>{})}function B(t){if(D+=1,V=null,T="idle",!t||t.enabled===!1){U=null;return}const e=$e(t);if(e.length===0){U=null;return}U={enabled:!0,baseUrls:e,includePrefixes:ie(t.includePrefixes,Ue),excludePrefixes:ie(t.excludePrefixes,ke),probePath:ze(t.probePath),probeTimeoutMs:typeof t.probeTimeoutMs=="number"&&Number.isFinite(t.probeTimeoutMs)?Math.max(200,Math.floor(t.probeTimeoutMs)):Ge};const i=Ye(U);if(i){V=i,T="ok",W(!0);return}W(!1)}function Qe(t,e){if(!t||typeof t!="string"||t.trim()==="")return"";const i=t.trim(),n=U;if(!n||!n.enabled)return i;const s=V;if(!s)return W(),i;const r=qe(i,n,s);if(r)return r;if(i.startsWith("//"))return i;const{path:o}=de(i);return!o.startsWith("/")||!ce(o,n)?i:he(i,s)}let y=null;function me(){return y!==null?y:typeof navigator<"u"&&navigator.maxTouchPoints>0||typeof window<"u"&&("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)?(y="touch",y):(y="mouse",y)}function Tt(){return me()==="touch"}function Je(){return me()==="mouse"}let R=null;function pe(t,e=1500){if(Y())return;const i=document.querySelector(".vr-toast"),n=i??document.createElement("div");n.className="vr-toast",n.textContent=t,i||document.body.appendChild(n),window.requestAnimationFrame(()=>n.classList.add("show")),R&&window.clearTimeout(R),R=window.setTimeout(()=>{n.classList.remove("show"),window.setTimeout(()=>n.remove(),220),R=null},e)}function Ze(){const t=document.querySelector(".vr-toast");t&&(t.classList.remove("show"),window.setTimeout(()=>t.remove(),220)),R&&(window.clearTimeout(R),R=null)}function et(){const t=document;return document.fullscreenElement||t.webkitFullscreenElement||null}function fe(){return!!et()}async function tt(t){const e=t;if(e.requestFullscreen){await e.requestFullscreen();return}if(e.webkitRequestFullscreen){await e.webkitRequestFullscreen();return}throw new Error("Fullscreen API not supported")}async function it(){const t=document;if(document.exitFullscreen){await document.exitFullscreen();return}if(t.webkitExitFullscreen){await t.webkitExitFullscreen();return}}async function nt(t){const e=t||document.body;!fe()&&Je()&&pe("鼠标滑至最上方可退出全屏",700),await tt(e)}async function se(){try{await it(),ge()}catch(t){console.debug("[fullscreen] exitFullscreenBestEffort failed:",t)}}function ge(){var t,e;try{(e=(t=screen.orientation)==null?void 0:t.unlock)==null||e.call(t)}catch{}}class ot{constructor(e){a(this,"element");a(this,"isOpen",!1);a(this,"options");this.options=e;const i=document.createElement("div");i.className="vr-modal vr-modal--media vr-modal--image";const n=document.createElement("div");n.className="vr-modal-mask",n.addEventListener("click",()=>this.handleClose());const s=document.createElement("div");s.className="vr-modal-card vr-modal-card--media vr-modal-card--image",s.addEventListener("click",h=>h.stopPropagation());const r=document.createElement("div");r.className="vr-modal-header";const o=document.createElement("div");o.className="vr-modal-title",o.textContent=e.title||"图片预览";const u=document.createElement("button");u.className="vr-btn vr-modal-close-icon",u.setAttribute("aria-label","关闭"),u.textContent="×",u.addEventListener("click",()=>this.handleClose()),r.appendChild(o),r.appendChild(u);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--image";const c=document.createElement("img");c.className="vr-modal-image",e.src&&(c.src=e.src),c.alt=e.title||"热点图片",c.loading="lazy",l.appendChild(c),s.appendChild(r),s.appendChild(l),i.appendChild(n),i.appendChild(s),this.element=i}handleClose(){var e,i;this.close(),(i=(e=this.options).onClose)==null||i.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class st{constructor(e){a(this,"element");a(this,"isOpen",!1);a(this,"options");this.options=e;const i=document.createElement("div");i.className="vr-modal vr-modal--info";const n=document.createElement("div");n.className="vr-modal-mask",n.addEventListener("click",()=>this.handleClose());const s=document.createElement("div");s.className="vr-modal-card vr-modal-card--info",s.addEventListener("click",c=>c.stopPropagation());const r=document.createElement("div");r.className="vr-modal-header";const o=document.createElement("div");o.className="vr-modal-title",o.textContent=e.title||"详情";const u=document.createElement("button");u.className="vr-btn vr-modal-close-icon",u.setAttribute("aria-label","关闭"),u.textContent="×",u.addEventListener("click",()=>this.handleClose()),r.appendChild(o),r.appendChild(u);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--info",l.textContent=e.text||"未配置内容",s.appendChild(r),s.appendChild(l),i.appendChild(n),i.appendChild(s),this.element=i}handleClose(){var e,i;this.close(),(i=(e=this.options).onClose)==null||i.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class rt{constructor(e){a(this,"element");a(this,"isOpen",!1);a(this,"videoEl");a(this,"options");this.options=e;const i=document.createElement("div");i.className="vr-modal vr-modal--media vr-modal--video";const n=document.createElement("div");n.className="vr-modal-mask",n.addEventListener("click",()=>this.handleClose());const s=document.createElement("div");s.className="vr-modal-card vr-modal-card--media vr-modal-card--video",s.addEventListener("click",h=>h.stopPropagation());const r=document.createElement("div");r.className="vr-modal-header";const o=document.createElement("div");o.className="vr-modal-title",o.textContent=e.title||"视频";const u=document.createElement("button");u.className="vr-btn vr-modal-close-icon",u.setAttribute("aria-label","关闭"),u.textContent="×",u.addEventListener("click",()=>this.handleClose()),r.appendChild(o),r.appendChild(u);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--video";const c=document.createElement("video");c.className="vr-modal-video",e.src&&(c.src=e.src),e.poster&&(c.poster=e.poster),c.controls=!0,c.playsInline=!0,c.preload="metadata",this.videoEl=c,l.appendChild(c),s.appendChild(r),s.appendChild(l),i.appendChild(n),i.appendChild(s),this.element=i}handleClose(){var e,i;this.close(),(i=(e=this.options).onClose)==null||i.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){if(this.isOpen){this.isOpen=!1,this.element.classList.remove("open");try{this.videoEl.pause(),this.videoEl.currentTime=0,this.videoEl.removeAttribute("src"),this.videoEl.load()}catch{}}}getElement(){return this.element}destroy(){this.close(),this.element.remove()}}const we="vr:open-modal",Ee="vr:close-modal";function Nt(t){window.dispatchEvent(new CustomEvent(we,{detail:t}))}function $(){window.dispatchEvent(new CustomEvent(Ee))}class at{constructor(e){a(this,"rootEl");a(this,"current",null);a(this,"handleKeyDownBound");this.rootEl=e,this.handleKeyDownBound=i=>this.handleKeyDown(i),window.addEventListener(we,i=>{const n=i;this.handleOpen(n.detail)}),window.addEventListener(Ee,()=>this.close()),window.addEventListener("keydown",this.handleKeyDownBound)}handleKeyDown(e){e.key==="Escape"&&this.close()}handleOpen(e){this.close();let i=null;e.type==="image"?i=new ot({src:e.payload.src,title:e.payload.title,onClose:()=>$()}):e.type==="info"?i=new st({title:e.payload.title,text:e.payload.text,onClose:()=>$()}):e.type==="video"&&(i=new rt({src:e.payload.src,poster:e.payload.poster,title:e.payload.title,onClose:()=>$()})),i&&(this.current=i,this.rootEl.innerHTML="",this.rootEl.appendChild(i.getElement()),i.open())}close(){this.current&&(this.current.close(),this.current.destroy(),this.current=null,this.rootEl.innerHTML="")}}let re=null;function lt(){if(re)return;let t=document.getElementById("vr-modal-root");t||(t=document.createElement("div"),t.id="vr-modal-root",document.body.appendChild(t)),re=new at(t)}function ut(t,e,i){const n=t.getBoundingClientRect(),s=e-n.left,r=i-n.top,o=document.createElement("div");o.className="vr-pick-marker",o.style.position="absolute",o.style.left="0",o.style.top="0",o.style.transform=`translate3d(${s}px, ${r}px, 0)`,o.style.pointerEvents="none",o.style.zIndex="1000",t.style.position="relative",t.appendChild(o),window.requestAnimationFrame(()=>{o.classList.add("show")}),window.setTimeout(()=>{o.classList.remove("show"),window.setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},200)},1500)}const Ie="vr_last_pick_v1";let z=null;function dt(){try{const t=localStorage.getItem(Ie);if(t){const e=JSON.parse(t);typeof e.yaw=="number"&&typeof e.pitch=="number"&&typeof e.ts=="number"&&(z=e)}}catch{}}dt();function ct(t){z=t;try{localStorage.setItem(Ie,JSON.stringify(t))}catch{}}function bt(){return z}class ht{constructor(){a(this,"listeners",new Map);a(this,"lastInteractionTs",0);a(this,"idleDelay",800);a(this,"idleTimer",null);a(this,"rafId",null);a(this,"isScheduled",!1);this.listeners.set("user-interacting",new Set),this.listeners.set("user-idle",new Set),this.listeners.set("ui-engaged",new Set)}on(e,i){const n=this.listeners.get(e);return n?(n.add(i),()=>{n.delete(i)}):(console.warn(`[InteractionBus] 未知事件类型: ${e}`),()=>{})}off(e,i){const n=this.listeners.get(e);n&&n.delete(i)}emit(e){this.isScheduled||(this.isScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.isScheduled=!1;const i=this.listeners.get(e);i&&i.forEach(n=>{try{n()}catch(s){console.error("[InteractionBus] 事件监听器执行失败:",s)}})}))}emitInteracting(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("user-interacting")}scheduleIdle(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.idleTimer=window.setTimeout(()=>{Date.now()-this.lastInteractionTs>=this.idleDelay&&(this.idleTimer=null,this.emit("user-idle"))},this.idleDelay)}emitUIEngaged(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("ui-engaged")}dispose(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.listeners.forEach(e=>e.clear()),this.listeners.clear()}}const O=new ht,mt=Object.freeze(Object.defineProperty({__proto__:null,interactionBus:O},Symbol.toStringTag,{value:"Module"})),pt=150,ft=150,gt=400;function wt(){return{fadeMs:pt,restoreMs:ft,restoreDelayMs:gt}}function Et(){O.on("user-interacting",()=>{}),O.on("user-idle",()=>{}),O.on("ui-engaged",()=>{})}let I=null;function It(){const t=wt();O.on("user-interacting",()=>{I!==null&&(clearTimeout(I),I=null),document.documentElement.classList.add("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")}),O.on("user-idle",()=>{I!==null&&(clearTimeout(I),I=null),document.documentElement.classList.remove("vr-ui-interacting"),I=window.setTimeout(()=>{document.documentElement.classList.remove("vr-ui-restoring"),I=null},t.restoreDelayMs)}),O.on("ui-engaged",()=>{I!==null&&(clearTimeout(I),I=null),document.documentElement.classList.remove("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")})}const L=typeof window<"u"?new URLSearchParams(window.location.search).get("debug")==="1":!1;function Dt(...t){L&&console.debug("[VR Debug]",...t)}class Mt{constructor(e){a(this,"options");a(this,"structure3DLoadToken",0);a(this,"structureView2D",null);a(this,"structureView3D",null);a(this,"structureOverlayOpen",!1);this.options=e}isStructureOverlayOpen(){return this.structureOverlayOpen}clearOverlayState(){this.structure3DLoadToken+=1,this.structureOverlayOpen=!1,this.structureView2D&&(this.structureView2D.remove(),this.structureView2D=null),this.structureView3D&&(this.structureView3D.remove(),this.structureView3D=null),document.body.style.overflow="",document.body.style.touchAction="",document.body.style.overscrollBehavior=""}async openStructure2D(){const e=this.options.getCurrentMuseum(),i=this.options.getCurrentScene();if(!e||!i)return;this.structureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),this.structure3DLoadToken+=1;const n=this.structure3DLoadToken,[{buildSceneGraph:s},{StructureView2D:r}]=await Promise.all([this.options.loadSceneGraphModule(),this.options.loadStructureView2DModule()]);if(n!==this.structure3DLoadToken||this.options.getMode()!=="structure2d")return;const o=this.options.getCurrentMuseum(),u=this.options.getCurrentScene();if(!o||!u)return;const l=s(o,u.id);this.structureView2D?this.structureView2D.updateContext({museum:o,graph:l,currentSceneId:u.id}):(this.structureView2D=new r({museum:o,graph:l,currentSceneId:u.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(c,h)=>{this.closeStructureOverlay({toTour:!1}),this.options.navigateToScene(c,h)}}),this.options.appElement.appendChild(this.structureView2D.getElement())),this.structureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView2D.open()}async openStructure3D(){const e=this.options.getCurrentMuseum(),i=this.options.getCurrentScene();if(!e||!i)return;this.structureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),this.structure3DLoadToken+=1;const n=this.structure3DLoadToken,[{buildSceneGraph:s},{StructureView3D:r}]=await Promise.all([this.options.loadSceneGraphModule(),this.options.loadStructureView3DModule()]);if(n!==this.structure3DLoadToken||this.options.getMode()!=="structure3d")return;const o=this.options.getCurrentMuseum(),u=this.options.getCurrentScene();if(!o||!u)return;const l=s(o,u.id);this.structureView3D?this.structureView3D.updateContext({museum:o,graph:l,currentSceneId:u.id}):(this.structureView3D=new r({museum:o,graph:l,currentSceneId:u.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(c,h)=>{this.closeStructureOverlay({toTour:!1}),this.options.navigateToScene(c,h)}}),this.options.appElement.appendChild(this.structureView3D.getElement())),this.structureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView3D.open()}closeStructureOverlay(e){this.structureOverlayOpen&&(this.clearOverlayState(),e.toTour&&this.options.onSwitchToTour())}dispose(){this.clearOverlayState()}}const vt={brand:{name:"鼎虎清源",copyright:"© 2025 鼎虎清源"},dock:{guide:"导览",community:"社区",info:"信息",settings:"更多"},modal:{infoTitle:"信息",settingsTitle:"更多",museumLabel:"展馆",sceneLabel:"场景",collectDateLabel:"采集日期",qualityLabel:"画质",qualityHigh:"高清",qualityLow:"省流",viewLabel:"视角",resetView:"恢复初始视角",vrLabel:"VR 眼镜",zoomLabel:"缩放",zoomIn:"放大",zoomOut:"缩小"}};L&&Promise.all([f(()=>import("./debugHelper-CkxFqbpw.js"),[],import.meta.url),f(()=>Promise.resolve().then(()=>mt),void 0,import.meta.url)]).then(([t,e])=>{const{dumpVRState:i,resetVRUI:n}=t,{interactionBus:s}=e;window.__vrDump=()=>{const r=i();return console.debug("[VR State Snapshot]",r),r},window.__vrResetUI=()=>{console.debug("[VR Reset UI] 正在清理所有 UI 状态..."),n(s),console.debug("[VR Reset UI] 清理完成")},console.debug("[VR Debug] 调试模式已启用。使用 __vrDump() 查看状态，使用 __vrResetUI() 复位 UI")}).catch(()=>{});De();Et();It();Oe();const Me=()=>{const t=document;!!(document.fullscreenElement||t.webkitFullscreenElement)&&Ze()};document.addEventListener("fullscreenchange",Me);document.addEventListener("webkitfullscreenchange",Me);function _t(){const t=new URLSearchParams(location.search);return t.has("development")||t.get("dev")==="1"||location.hash.includes("development")}class St{constructor(){a(this,"appElement");a(this,"config",null);a(this,"panoViewer",null);a(this,"titleBar",null);a(this,"topRightControls",null);a(this,"topModeTabs",null);a(this,"sceneTitleEl",null);a(this,"brandMark",null);a(this,"bottomDock",null);a(this,"sceneGuideDrawer",null);a(this,"guideTray",null);a(this,"museumList",null);a(this,"sceneListPage",null);a(this,"hotspots",null);a(this,"videoPlayer",null);a(this,"loading");a(this,"debugPanel",null);a(this,"configStudio",null);a(this,"qualityIndicator",null);a(this,"northCalibrationPanel",null);a(this,"currentMuseum",null);a(this,"currentScene",null);a(this,"sceneUiRuntime",null);a(this,"chatRuntime",null);a(this,"viewSessionRuntime");a(this,"hasBoundFullscreenEvents",!1);a(this,"mode","tour");a(this,"infoModalMounted",null);a(this,"settingsModalMounted",null);a(this,"handlePopState",null);a(this,"handlePickEvent",null);a(this,"handlePickModeEvent",null);a(this,"debugPanelRafId",null);a(this,"panoViewerModulePromise",null);a(this,"topRightControlsModulePromise",null);a(this,"brandMarkModulePromise",null);a(this,"structureView2DModulePromise",null);a(this,"structureView3DModulePromise",null);a(this,"titleBarModulePromise",null);a(this,"museumListModulePromise",null);a(this,"sceneListPageModulePromise",null);a(this,"sceneGraphModulePromise",null);a(this,"vrModeModulePromise",null);a(this,"vrModeInitialized",!1);a(this,"externalImageModulePromise",null);a(this,"appModalsModulePromise",null);a(this,"sceneUiRuntimeModulePromise",null);a(this,"chatRuntimeModulePromise",null);a(this,"configErrorPanelModulePromise",null);a(this,"uiErrorElement",null);const e=document.getElementById("app");if(!e)throw new Error("找不到 #app 元素");this.appElement=e,lt(),this.loading=new Ce,this.appElement.appendChild(this.loading.getElement()),this.viewSessionRuntime=new Mt({appElement:this.appElement,getCurrentMuseum:()=>this.currentMuseum,getCurrentScene:()=>this.currentScene,getMode:()=>this.mode,onSwitchToTour:()=>{var i;this.mode="tour",(i=this.topModeTabs)==null||i.setMode("tour")},navigateToScene:(i,n)=>{H(i,n)},loadSceneGraphModule:()=>this.loadSceneGraphModule(),loadStructureView2DModule:()=>this.loadStructureView2DModule(),loadStructureView3DModule:()=>this.loadStructureView3DModule()}),this.bindFullscreenEventsOnce(),this.init()}bindFullscreenEventsOnce(){if(this.hasBoundFullscreenEvents)return;this.hasBoundFullscreenEvents=!0;const e=()=>{var i;(i=this.topRightControls)==null||i.syncFullscreenState(),fe()||(this.topRightControls&&this.topRightControls.updateVrModeState(!1),this.panoViewer&&this.panoViewer.isVrModeEnabled()&&this.panoViewer.setVrModeEnabled(!1),ge())};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}loadPanoViewerModule(){return this.panoViewerModulePromise||(this.panoViewerModulePromise=f(()=>import("./PanoViewer-tVEm8XCm.js").then(e=>e.P),__vite__mapDeps([0,1,2,3]),import.meta.url)),this.panoViewerModulePromise}loadTopRightControlsModule(){return this.topRightControlsModulePromise||(this.topRightControlsModulePromise=f(()=>import("./TopRightControls-C8ZlZ4Gh.js"),[],import.meta.url)),this.topRightControlsModulePromise}loadBrandMarkModule(){return this.brandMarkModulePromise||(this.brandMarkModulePromise=f(()=>import("./BrandMark-CkNRyst5.js"),__vite__mapDeps([4,5]),import.meta.url)),this.brandMarkModulePromise}loadStructureView2DModule(){return this.structureView2DModulePromise||(this.structureView2DModulePromise=f(()=>import("./StructureView2D-BqbbJVBm.js"),__vite__mapDeps([6,7]),import.meta.url)),this.structureView2DModulePromise}loadStructureView3DModule(){return this.structureView3DModulePromise||(this.structureView3DModulePromise=f(()=>import("./dock-panels-BDqLbesR.js").then(e=>e.S),[],import.meta.url)),this.structureView3DModulePromise}loadTitleBarModule(){return this.titleBarModulePromise||(this.titleBarModulePromise=f(()=>import("./TitleBar-DAY6bVbi.js"),[],import.meta.url)),this.titleBarModulePromise}loadMuseumListModule(){return this.museumListModulePromise||(this.museumListModulePromise=f(()=>import("./MuseumList-B3R4GFs-.js"),[],import.meta.url)),this.museumListModulePromise}loadSceneListPageModule(){return this.sceneListPageModulePromise||(this.sceneListPageModulePromise=f(()=>import("./SceneListPage-DXZcDVvV.js"),[],import.meta.url)),this.sceneListPageModulePromise}loadSceneGraphModule(){return this.sceneGraphModulePromise||(this.sceneGraphModulePromise=f(()=>import("./sceneGraph-CaQzl5R8.js"),[],import.meta.url)),this.sceneGraphModulePromise}loadVrModeModule(){return this.vrModeModulePromise||(this.vrModeModulePromise=f(()=>import("./vrMode-Ck-2Ny7U.js"),__vite__mapDeps([8,9]),import.meta.url)),this.vrModeModulePromise}loadAppModalsModule(){return this.appModalsModulePromise||(this.appModalsModulePromise=f(()=>import("./appModals-D07anOPT.js"),__vite__mapDeps([10,11,2]),import.meta.url)),this.appModalsModulePromise}loadSceneUiRuntimeModule(){return this.sceneUiRuntimeModulePromise||(this.sceneUiRuntimeModulePromise=f(()=>import("./scene-runtime-B080iYiH.js").then(e=>e.s),__vite__mapDeps([12,13]),import.meta.url)),this.sceneUiRuntimeModulePromise}loadChatRuntimeModule(){return this.chatRuntimeModulePromise||(this.chatRuntimeModulePromise=f(()=>import("./scene-runtime-B080iYiH.js").then(e=>e.c),__vite__mapDeps([12,13]),import.meta.url)),this.chatRuntimeModulePromise}loadConfigErrorPanelModule(){return this.configErrorPanelModulePromise||(this.configErrorPanelModulePromise=f(()=>import("./ConfigErrorPanel-B2eR8rYX.js"),__vite__mapDeps([14,15]),import.meta.url)),this.configErrorPanelModulePromise}async ensureVrModeInitialized(){const e=await this.loadVrModeModule();return this.vrModeInitialized||(e.initVrMode(),this.vrModeInitialized=!0),e}async resolveProxiedImageUrl(e){this.externalImageModulePromise||(this.externalImageModulePromise=f(()=>import("./externalImage-Cn8sVw7v.js"),[],import.meta.url));try{const{toProxiedImageUrl:i}=await this.externalImageModulePromise;return i(e)}catch{return e}}async init(){try{if(this.loading.show(),Re()){await this.initEditorMode(),this.loading.hide();return}this.config=await K(),B(this.config.assetCdn),this.titleBar&&this.titleBar.setTitle(this.config.appName),this.handlePopState||(this.handlePopState=()=>{this.handleRoute()},window.addEventListener("popstate",this.handlePopState)),await this.handleRoute(),this.loading.hide()}catch(e){console.error("配置加载失败:",e),this.loading.hide(),e.validationErrors&&Array.isArray(e.validationErrors)?await this.showConfigErrorPanel(e.validationErrors):this.showError("加载配置失败，请刷新页面重试")}}async initEditorMode(){try{this.config=await K(),B(this.config.assetCdn),this.appElement.innerHTML="";const{ConfigStudio:e}=await f(async()=>{const{ConfigStudio:i}=await import("./editor-debug-Dy3AxbKg.js").then(n=>n.C);return{ConfigStudio:i}},__vite__mapDeps([16,15,17,5]),import.meta.url);this.configStudio=new e(this.config,i=>{this.config=i,B(i.assetCdn),X()}),this.appElement.appendChild(this.configStudio.getElement())}catch(e){console.error("初始化编辑器模式失败:",e),e.validationErrors&&Array.isArray(e.validationErrors)?await this.showConfigErrorPanel(e.validationErrors):this.showError("加载配置失败，请刷新页面重试")}}async showConfigErrorPanel(e){this.appElement.innerHTML="";const{ConfigErrorPanel:i}=await this.loadConfigErrorPanelModule(),n=new i(e,()=>{X(),window.location.reload()},()=>{this.showConfigExample()});this.appElement.appendChild(n.getElement())}showConfigExample(){const e=window.open("","_blank");e&&e.document.write(`
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>config.json 示例</title>
          <style>
            body {
              font-family: 'Courier New', monospace;
              padding: 20px;
              background: #1a1a1a;
              color: #fff;
            }
            pre {
              background: #0f0f0f;
              padding: 20px;
              border-radius: 8px;
              overflow-x: auto;
            }
            code {
              color: #4a90e2;
            }
          </style>
        </head>
        <body>
          <h1>config.json 示例配置</h1>
          <pre><code>{
  "appName": "应用名称",
  "museums": [
    {
      "id": "museum_id",
      "name": "展馆名称",
      "cover": "https://example.com/cover.jpg",
      "map": {
        "image": "https://example.com/map.jpg",
        "width": 1000,
        "height": 600
      },
      "scenes": [
        {
          "id": "scene_id",
          "name": "场景名称",
          "panoLow": "https://example.com/pano-low.jpg",
          "pano": "https://example.com/pano.jpg",
          "thumb": "https://example.com/thumb.jpg",
          "initialView": {
            "yaw": 0,
            "pitch": 0,
            "fov": 75
          },
          "mapPoint": {
            "x": 420,
            "y": 310
          },
          "hotspots": [
            {
              "id": "hotspot_id",
              "type": "scene",
              "label": "热点标签",
              "yaw": 35,
              "pitch": -5,
              "target": {
                "museumId": "museum_id",
                "sceneId": "target_scene_id",
                "yaw": 120,
                "pitch": 0
              }
            }
          ]
        }
      ]
    }
  ]
}</code></pre>
          <p>详细配置说明请查看 README.md</p>
        </body>
        </html>
      `)}async handleRoute(){if(!this.config)return;const e=Z();if(e.sceneId&&(this.loadPanoViewerModule(),this.loadTopRightControlsModule(),this.loadBrandMarkModule()),this.clearView(),!e.museumId){const i=this.config.museums.find(n=>n.id==="wangding")||this.config.museums[0];if(i){if(i.scenes&&i.scenes.length>0){H(i.id,i.scenes[0].id);return}te(i.id);return}}if(!e.museumId)await this.showMuseumList();else if(e.sceneId){const i=F(e.museumId),n=Ne(e.museumId,e.sceneId);i&&n?await this.showScene(i,n):(this.showError("未找到指定场景"),i?te(i.id):ee())}else{const i=F(e.museumId);i?await this.showSceneList(i):(this.showError("未找到指定展馆"),ee())}}async showMuseumList(){if(!this.config)return;const[{TitleBar:e},{MuseumList:i}]=await Promise.all([this.loadTitleBarModule(),this.loadMuseumListModule()]);this.titleBar=new e(this.config.appName),this.appElement.appendChild(this.titleBar.getElement()),this.museumList=new i(this.config.museums),this.appElement.appendChild(this.museumList.getElement())}async showSceneList(e){const{TitleBar:i}=await this.loadTitleBarModule();this.titleBar=new i(e.name),this.appElement.appendChild(this.titleBar.getElement());const{SceneListPage:n}=await this.loadSceneListPageModule();this.sceneListPage=new n(e),this.appElement.appendChild(this.sceneListPage.getElement())}async showScene(e,i){var p,G;this.currentMuseum=e,this.currentScene=i,this.loading.show();const n=document.createElement("div");n.className="viewer-container",n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    `,this.appElement.appendChild(n);const s=Ve(),{PanoViewer:r}=await this.loadPanoViewerModule();this.panoViewer=new r(n,s);const o=_t();if(this.mountTopRightControls(n,i,o),this.sceneTitleEl=document.createElement("div"),this.sceneTitleEl.className="vr-scenetitle",this.sceneTitleEl.textContent=i.name||((p=this.config)==null?void 0:p.appName)||"VR Player",this.appElement.appendChild(this.sceneTitleEl),this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickEvent=d=>{const w=d,{x:g,y:P,yaw:N,pitch:b}=w.detail;if(ct({yaw:N,pitch:b,ts:Date.now()}),pe(`宸插鍒?yaw: ${N.toFixed(2)}, pitch: ${b.toFixed(2)}`),this.panoViewer){const C=this.panoViewer.getDomElement();ut(C,g,P)}},window.addEventListener("vr:pick",this.handlePickEvent),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.handlePickModeEvent=d=>{const w=d;this.panoViewer&&!w.detail.enabled&&this.panoViewer.isPickModeEnabled()&&this.panoViewer.disablePickMode()},window.addEventListener("vr:pickmode",this.handlePickModeEvent),this.mountBrandMark(),s){const{DebugPanel:d}=await f(async()=>{const{DebugPanel:g}=await import("./editor-debug-Dy3AxbKg.js").then(P=>P.D);return{DebugPanel:g}},__vite__mapDeps([16,15,17,5]),import.meta.url);this.debugPanel=new d,this.appElement.appendChild(this.debugPanel.getElement()),this.panoViewer.setOnDebugClick((g,P,N,b,C)=>{this.debugPanel&&this.debugPanel.show(g,P,N,b,C)}),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null);const w=()=>{if(this.debugPanel&&this.panoViewer){const g=this.panoViewer.getCurrentView();this.debugPanel.updateView(g.yaw,g.pitch,g.fov)}this.debugPanelRafId=requestAnimationFrame(w)};w()}const[{ChatRuntime:u},{SceneUiRuntime:l}]=await Promise.all([this.loadChatRuntimeModule(),this.loadSceneUiRuntimeModule()]);this.chatRuntime=new u,this.chatRuntime.updateContext({museum:e,scene:i,fcChatConfig:(G=this.config)==null?void 0:G.fcChat}),this.sceneUiRuntime=new l({appElement:this.appElement,viewerContainer:n,museum:e,scene:i,initialMode:this.mode,getPanoViewer:()=>this.panoViewer,getCurrentSceneId:()=>{var d;return((d=this.currentScene)==null?void 0:d.id)??null},onModeChange:d=>{this.setMode(d)},onEnterScene:d=>{H(e.id,d)},onOpenInfo:()=>{this.openInfoModal()},onOpenSettings:()=>{this.openSettingsModal()},onOpenCommunity:()=>{var d;(d=this.chatRuntime)==null||d.ensureInit()},onWarmupFeatures:async()=>{var d;await Promise.allSettled([this.loadAppModalsModule(),((d=this.chatRuntime)==null?void 0:d.warmup())??Promise.resolve()])}}),await this.sceneUiRuntime.ensureQualityIndicatorMounted();const c=()=>{var d,w,g,P,N,b,C;this.bottomDock=((d=this.sceneUiRuntime)==null?void 0:d.getBottomDock())??null,this.topModeTabs=((w=this.sceneUiRuntime)==null?void 0:w.getTopModeTabs())??null,this.hotspots=((g=this.sceneUiRuntime)==null?void 0:g.getHotspots())??null,this.videoPlayer=((P=this.sceneUiRuntime)==null?void 0:P.getVideoPlayer())??null,this.guideTray=((N=this.sceneUiRuntime)==null?void 0:N.getGuideTray())??null,this.sceneGuideDrawer=((b=this.sceneUiRuntime)==null?void 0:b.getSceneGuideDrawer())??null,this.qualityIndicator=((C=this.sceneUiRuntime)==null?void 0:C.getQualityIndicator())??null};let h=!1;const m=()=>{var d;h||(h=!0,(d=this.sceneUiRuntime)==null||d.mountCore().then(()=>{c()}).catch(w=>{L&&console.debug("[showScene] 核心场景 UI 创建失败，已跳过",w)}))};this.panoViewer.setOnStatusChange(d=>{var w,g;(w=this.sceneUiRuntime)==null||w.handleStatusChange(d),c(),!h&&(d===M.LOW_READY||d===M.HIGH_READY||d===M.DEGRADED)&&window.setTimeout(()=>{m()},0),(d===M.HIGH_READY||d===M.DEGRADED)&&((g=this.sceneUiRuntime)==null||g.scheduleFeatureWarmup(d===M.HIGH_READY?"immediate":"idle")),(d===M.LOW_READY||d===M.HIGH_READY||d===M.DEGRADED)&&this.loading.hide()}),this.panoViewer.setOnLoad(()=>{m(),this.loading.hide(),this.hideUIError(),this.preloadNextScene(e,i)}),this.panoViewer.setOnError(d=>{console.error("加载场景失败:",d),this.loading.hide(),this.showError("加载全景图失败，请检查网络连接"),this.qualityIndicator&&this.qualityIndicator.updateStatus(M.ERROR)});const v=Z(),E=v.yaw!==void 0?v.yaw:i.initialView.yaw||0,_=v.pitch!==void 0?v.pitch:i.initialView.pitch||0,S=v.fov!==void 0?v.fov:i.initialView.fov||75,x=-E;this.panoViewer.setView(x,_,S),this.panoViewer.loadScene(i),this.panoViewer.setSceneData(e.id,i.id,i.hotspots)}async mountTopRightControls(e,i,n){var s;try{const{TopRightControls:r}=await this.loadTopRightControlsModule();if(!this.panoViewer||!this.currentScene||this.currentScene.id!==i.id)return;(s=this.topRightControls)==null||s.remove(),this.topRightControls=new r({viewerRootEl:e,onTogglePickMode:n?()=>this.panoViewer?(this.panoViewer.isPickModeEnabled()?this.panoViewer.disablePickMode():this.panoViewer.enablePickMode(),this.panoViewer.isPickModeEnabled()):!1:void 0,onOpenNorthCalibration:n?()=>{this.openNorthCalibration(i.id)}:void 0,showNorthCalibration:n,onToggleVrMode:async()=>this.toggleVrModeFromUI(e)}),this.appElement.appendChild(this.topRightControls.getElement())}catch(r){L&&console.debug("[showScene] TopRightControls 创建失败，已跳过",r),this.topRightControls=null}}async mountBrandMark(){var e;try{const{BrandMark:i}=await this.loadBrandMarkModule();if(this.appElement.querySelector(".vr-brandmark"))return;this.brandMark=new i({appName:(e=this.config)==null?void 0:e.appName,brandText:vt.brand.name});const s=this.brandMark.getElement();s.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),this.openDingHuQingYuan()}),this.appElement.appendChild(s)}catch(i){L&&console.debug("[showScene] BrandMark 创建失败，已跳过",i),this.brandMark=null}}preloadNextScene(e,i){const s=(e.scenes.findIndex(o=>o.id===i.id)+1)%e.scenes.length,r=e.scenes[s];if(r&&r.thumb){const o=Qe(r.thumb,le.THUMB);if(o){const u=new Image;u.referrerPolicy="no-referrer",u.crossOrigin="anonymous",u.loading="lazy",u.decoding="async",this.resolveProxiedImageUrl(o).then(l=>{u.src=l}).catch(()=>{u.src=o})}}}clearView(){this.viewSessionRuntime.clearOverlayState(),this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null),this.chatRuntime&&(this.chatRuntime.dispose(),this.chatRuntime=null),this.sceneUiRuntime&&(this.sceneUiRuntime.dispose(),this.sceneUiRuntime=null),this.bottomDock=null,this.topModeTabs=null,this.hotspots=null,this.videoPlayer=null,this.guideTray=null,this.sceneGuideDrawer=null,this.qualityIndicator=null,this.panoViewer&&(this.panoViewer.dispose(),this.panoViewer=null),this.titleBar&&(this.titleBar.remove(),this.titleBar=null),this.topRightControls&&(this.topRightControls.remove(),this.topRightControls=null),this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),this.sceneTitleEl&&(this.sceneTitleEl.remove(),this.sceneTitleEl=null),this.brandMark&&(this.brandMark.remove(),this.brandMark=null),this.museumList&&(this.museumList.remove(),this.museumList=null),this.sceneListPage&&(this.sceneListPage.remove(),this.sceneListPage=null),this.debugPanel&&(this.debugPanel.remove(),this.debugPanel=null),this.configStudio&&(this.configStudio.remove(),this.configStudio=null),this.mode="tour",this.appElement.innerHTML="",this.appElement.appendChild(this.loading.getElement())}hideUIError(){this.uiErrorElement&&this.uiErrorElement.parentNode&&(this.uiErrorElement.parentNode.removeChild(this.uiErrorElement),this.uiErrorElement=null)}setMode(e){this.mode!==e&&(this.mode=e,this.topModeTabs&&this.topModeTabs.setMode(e),e==="tour"&&this.viewSessionRuntime.isStructureOverlayOpen()&&this.viewSessionRuntime.closeStructureOverlay({toTour:!1}),e==="structure2d"?this.viewSessionRuntime.openStructure2D():e==="structure3d"&&this.viewSessionRuntime.openStructure3D())}async openNorthCalibration(e){if(this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),!this.panoViewer){console.warn("[openNorthCalibration] PanoViewer 未初始化");return}try{const{NorthCalibrationPanel:i}=await f(async()=>{const{NorthCalibrationPanel:n}=await import("./editor-debug-Dy3AxbKg.js").then(s=>s.N);return{NorthCalibrationPanel:n}},__vite__mapDeps([16,15,17,5]),import.meta.url);this.northCalibrationPanel=new i({getCurrentYaw:()=>{var s;const n=(s=this.panoViewer)==null?void 0:s.getCurrentView();return(n==null?void 0:n.yaw)??0},sceneId:e,onClose:()=>{this.northCalibrationPanel=null}})}catch(i){console.error("[openNorthCalibration] 创建校准面板失败:",i),this.northCalibrationPanel=null}}showError(e){this.hideUIError(),this.uiErrorElement=document.createElement("div"),this.uiErrorElement.className="error-message",this.uiErrorElement.textContent=e,this.uiErrorElement.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 16px;
      text-align: center;
      max-width: 80vw;
    `,this.appElement.appendChild(this.uiErrorElement),setTimeout(()=>{this.hideUIError()},3e3)}openDingHuQingYuan(){if(this.brandMark)try{this.brandMark.getAboutModal().open()}catch(e){L&&console.debug("[openDingHuQingYuan] 打开团队介绍失败:",e)}}async openInfoModal(){var i,n,s;(i=this.infoModalMounted)==null||i.close(),this.infoModalMounted=null;const{openInfoModal:e}=await this.loadAppModalsModule();this.infoModalMounted=e({museumName:((n=this.currentMuseum)==null?void 0:n.name)||"-",sceneName:((s=this.currentScene)==null?void 0:s.name)||"-",onOpenBrand:()=>{this.openDingHuQingYuan()},onDockTabClose:()=>{this.infoModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"info"}}))}})}async toggleVrModeFromUI(e){if(!this.panoViewer)return!1;const i=await this.ensureVrModeInitialized();if(i.isVrModeEnabled())return i.disableVrMode(),this.panoViewer.setVrModeEnabled(!1),this.topRightControls&&this.topRightControls.updateVrModeState(!1),await se(),!1;{try{await nt(e)}catch(o){return L&&console.debug("[VRMode] fullscreen request failed",o),!1}const s=this.panoViewer.getCurrentView();return i.setInteractingCallback(()=>{var o;return((o=this.panoViewer)==null?void 0:o.isInteracting())??!1}),await i.enableVrMode((o,u)=>{if(this.panoViewer){const l=s.yaw+o,c=Math.max(-90,Math.min(90,s.pitch+u));this.panoViewer.setView(l,c)}})?(this.panoViewer.setVrModeEnabled(!0),this.topRightControls&&this.topRightControls.updateVrModeState(!0),!0):(await se(),!1)}}async openSettingsModal(){var i;(i=this.settingsModalMounted)==null||i.close(),this.settingsModalMounted=null;const{openSettingsModal:e}=await this.loadAppModalsModule();this.settingsModalMounted=e({currentScene:this.currentScene,panoViewer:this.panoViewer,bottomDock:this.bottomDock,onToggleVrMode:async n=>this.toggleVrModeFromUI(n),onDockTabClose:()=>{this.settingsModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"settings"}}))}})}}new St;"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").catch(()=>{})});export{le as A,ye as E,M as L,vt as Z,f as _,fe as a,se as b,nt as c,Dt as d,Ae as e,L as f,bt as g,Tt as h,O as i,lt as j,te as k,Y as l,Je as m,H as n,yt as o,Nt as p,Qe as r,pe as s,Te as v};
