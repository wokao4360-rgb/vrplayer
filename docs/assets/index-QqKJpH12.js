const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./dock-panels-ByTJbHA4.js","./three-core-Y4hoEZik.js","./editor-debug-BvJzBnAe.js","./draftStorage-Be1LM_rK.js","./chat-community-JW1G0t1K.js","./store-B83L8bDT.js"])))=>i.map(i=>d[i]);
var Gt=Object.defineProperty;var zt=(a,e,t)=>e in a?Gt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>zt(a,typeof e!="symbol"?e+"":e,t);import{aL as W,k as ae,aM as Bt,aq as se,ap as Wt,M as ne,aN as qt,aO as jt,$ as N,aP as Xt,aQ as Qt,V as H,R as Kt,e as Zt,am as D,i as me,aR as be,c as Qe,G as Jt,aD as ei,S as ti,P as ii,j as st,aS as si,aT as ni,W as oi,aU as ai,Y as Ke}from"./three-core-Y4hoEZik.js";import{K as ri}from"./three-extras-Cu7io2It.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const li="modulepreload",ci=function(a,e){return new URL(a,e).href},nt={},K=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){const n=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));s=Promise.allSettled(t.map(d=>{if(d=ci(d,i),d in nt)return;nt[d]=!0;const u=d.endsWith(".css"),h=u?'[rel="stylesheet"]':"";if(!!i)for(let v=n.length-1;v>=0;v--){const w=n[v];if(w.href===d&&(!u||w.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${h}`))return;const f=document.createElement("link");if(f.rel=u?"stylesheet":li,u||(f.as="script"),f.crossOrigin="",f.href=d,l&&f.setAttribute("nonce",l),document.head.appendChild(f),u)return new Promise((v,w)=>{f.addEventListener("load",v),f.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(n){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=n,window.dispatchEvent(c),!c.defaultPrevented)throw n}return s.then(n=>{for(const c of n||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})};var y=(a=>(a.INVALID_ROOT="INVALID_ROOT",a.MISSING_APP_NAME="MISSING_APP_NAME",a.MUSEUMS_NOT_ARRAY="MUSEUMS_NOT_ARRAY",a.MUSEUMS_EMPTY="MUSEUMS_EMPTY",a.MISSING_MUSEUM_ID="MISSING_MUSEUM_ID",a.DUPLICATE_MUSEUM_ID="DUPLICATE_MUSEUM_ID",a.MISSING_MUSEUM_NAME="MISSING_MUSEUM_NAME",a.MISSING_MUSEUM_COVER="MISSING_MUSEUM_COVER",a.MISSING_MUSEUM_MAP="MISSING_MUSEUM_MAP",a.MISSING_MAP_IMAGE="MISSING_MAP_IMAGE",a.INVALID_MAP_WIDTH="INVALID_MAP_WIDTH",a.INVALID_MAP_HEIGHT="INVALID_MAP_HEIGHT",a.SCENES_NOT_ARRAY="SCENES_NOT_ARRAY",a.SCENES_EMPTY="SCENES_EMPTY",a.MISSING_SCENE_ID="MISSING_SCENE_ID",a.DUPLICATE_SCENE_ID="DUPLICATE_SCENE_ID",a.MISSING_SCENE_NAME="MISSING_SCENE_NAME",a.MISSING_PANO="MISSING_PANO",a.INVALID_PANO_URL="INVALID_PANO_URL",a.INVALID_PANOLOW_URL="INVALID_PANOLOW_URL",a.MISSING_THUMB="MISSING_THUMB",a.MISSING_INITIAL_VIEW="MISSING_INITIAL_VIEW",a.INVALID_YAW="INVALID_YAW",a.INVALID_PITCH="INVALID_PITCH",a.INVALID_FOV="INVALID_FOV",a.MISSING_MAP_POINT="MISSING_MAP_POINT",a.INVALID_MAP_POINT_X="INVALID_MAP_POINT_X",a.INVALID_MAP_POINT_Y="INVALID_MAP_POINT_Y",a.HOTSPOTS_NOT_ARRAY="HOTSPOTS_NOT_ARRAY",a.MISSING_HOTSPOT_ID="MISSING_HOTSPOT_ID",a.DUPLICATE_HOTSPOT_ID="DUPLICATE_HOTSPOT_ID",a.INVALID_HOTSPOT_TYPE="INVALID_HOTSPOT_TYPE",a.MISSING_HOTSPOT_LABEL="MISSING_HOTSPOT_LABEL",a.INVALID_HOTSPOT_YAW="INVALID_HOTSPOT_YAW",a.INVALID_HOTSPOT_PITCH="INVALID_HOTSPOT_PITCH",a.MISSING_HOTSPOT_TARGET="MISSING_HOTSPOT_TARGET",a.MISSING_TARGET_MUSEUM_ID="MISSING_TARGET_MUSEUM_ID",a.MISSING_TARGET_SCENE_ID="MISSING_TARGET_SCENE_ID",a.INVALID_TARGET_YAW="INVALID_TARGET_YAW",a.INVALID_TARGET_PITCH="INVALID_TARGET_PITCH",a.INVALID_TARGET_FOV="INVALID_TARGET_FOV",a.MISSING_TARGET_URL="MISSING_TARGET_URL",a))(y||{});function hi(a){const e=[];if(!a||typeof a!="object")return e.push({code:"INVALID_ROOT",path:"root",message:"配置必须是对象",fieldName:"配置根对象"}),e;if((!a.appName||typeof a.appName!="string"||a.appName.trim()==="")&&e.push({code:"MISSING_APP_NAME",path:"appName",message:"appName 必须是非空字符串",fieldName:"应用名称"}),!Array.isArray(a.museums))return e.push({code:"MUSEUMS_NOT_ARRAY",path:"museums",message:"museums 必须是数组",fieldName:"博物馆列表"}),e;a.museums.length===0&&e.push({code:"MUSEUMS_EMPTY",path:"museums",message:"museums 数组不能为空",fieldName:"博物馆列表"});const t=new Set;return a.museums.forEach((i,s)=>{const o=`museums[${s}]`,n=i.name&&typeof i.name=="string"?i.name:void 0;if(!i.id||typeof i.id!="string"||i.id.trim()===""?e.push({code:"MISSING_MUSEUM_ID",path:`${o}.id`,message:"id 必须是非空字符串",museumName:n,fieldName:"博物馆 ID"}):(t.has(i.id)&&e.push({code:"DUPLICATE_MUSEUM_ID",path:`${o}.id`,message:`博物馆 ID "${i.id}" 重复`,museumName:n,fieldName:"博物馆 ID"}),t.add(i.id)),(!i.name||typeof i.name!="string"||i.name.trim()==="")&&e.push({code:"MISSING_MUSEUM_NAME",path:`${o}.name`,message:"name 必须是非空字符串",museumName:void 0,fieldName:"博物馆名称"}),(!i.cover||typeof i.cover!="string"||i.cover.trim()==="")&&e.push({code:"MISSING_MUSEUM_COVER",path:`${o}.cover`,message:"cover 必须是有效的 URL 字符串",museumName:n,fieldName:"封面图"}),!i.map||typeof i.map!="object"?e.push({code:"MISSING_MUSEUM_MAP",path:`${o}.map`,message:"map 必须是对象",museumName:n,fieldName:"地图配置"}):((!i.map.image||typeof i.map.image!="string"||i.map.image.trim()==="")&&e.push({code:"MISSING_MAP_IMAGE",path:`${o}.map.image`,message:"map.image 必须是有效的 URL 字符串",museumName:n,fieldName:"地图图片"}),(typeof i.map.width!="number"||i.map.width<=0)&&e.push({code:"INVALID_MAP_WIDTH",path:`${o}.map.width`,message:"map.width 必须是大于 0 的数字",museumName:n,fieldName:"地图宽度"}),(typeof i.map.height!="number"||i.map.height<=0)&&e.push({code:"INVALID_MAP_HEIGHT",path:`${o}.map.height`,message:"map.height 必须是大于 0 的数字",museumName:n,fieldName:"地图高度"})),!Array.isArray(i.scenes))e.push({code:"SCENES_NOT_ARRAY",path:`${o}.scenes`,message:"scenes 必须是数组",museumName:n,fieldName:"场景列表"});else{i.scenes.length===0&&e.push({code:"SCENES_EMPTY",path:`${o}.scenes`,message:"scenes 数组不能为空",museumName:n,fieldName:"场景列表"});const c=new Set;i.scenes.forEach((l,d)=>{var w;const u=`${o}.scenes[${d}]`,h=l.name&&typeof l.name=="string"?l.name:void 0;!l.id||typeof l.id!="string"||l.id.trim()===""?e.push({code:"MISSING_SCENE_ID",path:`${u}.id`,message:"id 必须是非空字符串",museumName:n,sceneName:h,fieldName:"场景 ID"}):(c.has(l.id)&&e.push({code:"DUPLICATE_SCENE_ID",path:`${u}.id`,message:`场景 ID "${l.id}" 在博物馆内重复`,museumName:n,sceneName:h,fieldName:"场景 ID"}),c.add(l.id)),(!l.name||typeof l.name!="string"||l.name.trim()==="")&&e.push({code:"MISSING_SCENE_NAME",path:`${u}.name`,message:"name 必须是非空字符串",museumName:n,sceneName:void 0,fieldName:"场景名称"});const m=!!l.pano,f=!!l.panoLow,v=!!((w=l.panoTiles)!=null&&w.manifest);if(!m&&!f&&!v?e.push({code:"MISSING_PANO",path:`${u}.pano`,message:"pano / panoLow / panoTiles 至少需要提供一个",museumName:n,sceneName:h,fieldName:"全景图"}):(l.pano&&(typeof l.pano!="string"||l.pano.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${u}.pano`,message:"pano 必须是有效的 URL 字符串",museumName:n,sceneName:h,fieldName:"高清全景图"}),l.panoLow&&(typeof l.panoLow!="string"||l.panoLow.trim()==="")&&e.push({code:"INVALID_PANOLOW_URL",path:`${u}.panoLow`,message:"panoLow 必须是有效的 URL 字符串",museumName:n,sceneName:h,fieldName:"低清全景图"}),l.panoTiles&&(typeof l.panoTiles!="object"?e.push({code:"INVALID_PANO_URL",path:`${u}.panoTiles`,message:"panoTiles 必须是对象，包含 manifest",museumName:n,sceneName:h,fieldName:"瓦片元数据"}):(!l.panoTiles.manifest||typeof l.panoTiles.manifest!="string"||l.panoTiles.manifest.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${u}.panoTiles.manifest`,message:"panoTiles.manifest 必须是有效的字符串",museumName:n,sceneName:h,fieldName:"瓦片 manifest"}))),(!l.thumb||typeof l.thumb!="string"||l.thumb.trim()==="")&&e.push({code:"MISSING_THUMB",path:`${u}.thumb`,message:"thumb 必须是有效的 URL 字符串",museumName:n,sceneName:h,fieldName:"缩略图"}),!l.initialView||typeof l.initialView!="object"?e.push({code:"MISSING_INITIAL_VIEW",path:`${u}.initialView`,message:"initialView 必须是对象",museumName:n,sceneName:h,fieldName:"初始视角"}):(typeof l.initialView.yaw!="number"&&e.push({code:"INVALID_YAW",path:`${u}.initialView.yaw`,message:"initialView.yaw 必须是数字",museumName:n,sceneName:h,fieldName:"水平角度"}),typeof l.initialView.pitch!="number"&&e.push({code:"INVALID_PITCH",path:`${u}.initialView.pitch`,message:"initialView.pitch 必须是数字",museumName:n,sceneName:h,fieldName:"垂直角度"}),l.initialView.fov!==void 0&&typeof l.initialView.fov!="number"&&e.push({code:"INVALID_FOV",path:`${u}.initialView.fov`,message:"initialView.fov 必须是数字",museumName:n,sceneName:h,fieldName:"视野角度"})),!l.mapPoint||typeof l.mapPoint!="object"?e.push({code:"MISSING_MAP_POINT",path:`${u}.mapPoint`,message:"mapPoint 必须是对象",museumName:n,sceneName:h,fieldName:"地图点位"}):(typeof l.mapPoint.x!="number"&&e.push({code:"INVALID_MAP_POINT_X",path:`${u}.mapPoint.x`,message:"mapPoint.x 必须是数字",museumName:n,sceneName:h,fieldName:"地图点位 X 坐标"}),typeof l.mapPoint.y!="number"&&e.push({code:"INVALID_MAP_POINT_Y",path:`${u}.mapPoint.y`,message:"mapPoint.y 必须是数字",museumName:n,sceneName:h,fieldName:"地图点位 Y 坐标"})),!Array.isArray(l.hotspots))e.push({code:"HOTSPOTS_NOT_ARRAY",path:`${u}.hotspots`,message:"hotspots 必须是数组",museumName:n,sceneName:h,fieldName:"热点列表"});else{const p=new Set;l.hotspots.forEach((g,b)=>{const E=`${u}.hotspots[${b}]`;!g.id||typeof g.id!="string"||g.id.trim()===""?e.push({code:"MISSING_HOTSPOT_ID",path:`${E}.id`,message:"id 必须是非空字符串",museumName:n,sceneName:h,fieldName:"热点 ID"}):(p.has(g.id)&&e.push({code:"DUPLICATE_HOTSPOT_ID",path:`${E}.id`,message:`热点 ID "${g.id}" 在场景内重复`,museumName:n,sceneName:h,fieldName:"热点 ID"}),p.add(g.id)),g.type!=="scene"&&g.type!=="video"&&g.type!=="image"&&g.type!=="info"&&e.push({code:"INVALID_HOTSPOT_TYPE",path:`${E}.type`,message:'type 必须是 "scene"、"video"、"image" 或 "info"',museumName:n,sceneName:h,fieldName:"热点类型"}),(!g.label||typeof g.label!="string"||g.label.trim()==="")&&e.push({code:"MISSING_HOTSPOT_LABEL",path:`${E}.label`,message:"label 必须是非空字符串",museumName:n,sceneName:h,fieldName:"热点标签"}),typeof g.yaw!="number"&&e.push({code:"INVALID_HOTSPOT_YAW",path:`${E}.yaw`,message:"yaw 必须是数字",museumName:n,sceneName:h,fieldName:"热点水平角度"}),typeof g.pitch!="number"&&e.push({code:"INVALID_HOTSPOT_PITCH",path:`${E}.pitch`,message:"pitch 必须是数字",museumName:n,sceneName:h,fieldName:"热点垂直角度"}),g.type==="scene"?!g.target||typeof g.target!="object"?e.push({code:"MISSING_HOTSPOT_TARGET",path:`${E}.target`,message:"scene 类型热点必须提供 target 对象",museumName:n,sceneName:h,fieldName:"热点目标配置"}):((!g.target.museumId||typeof g.target.museumId!="string")&&e.push({code:"MISSING_TARGET_MUSEUM_ID",path:`${E}.target.museumId`,message:"scene 类型热点的 target.museumId 必须是非空字符串",museumName:n,sceneName:h,fieldName:"目标博物馆 ID"}),typeof g.target.sceneId!="string"&&e.push({code:"MISSING_TARGET_SCENE_ID",path:`${E}.target.sceneId`,message:"scene 类型热点的 target.sceneId 必须是字符串（允许空字符串，用户后续补全）",museumName:n,sceneName:h,fieldName:"目标场景 ID"}),g.target.yaw!==void 0&&typeof g.target.yaw!="number"&&e.push({code:"INVALID_TARGET_YAW",path:`${E}.target.yaw`,message:"target.yaw 必须是数字",museumName:n,sceneName:h,fieldName:"目标水平角度"}),g.target.pitch!==void 0&&typeof g.target.pitch!="number"&&e.push({code:"INVALID_TARGET_PITCH",path:`${E}.target.pitch`,message:"target.pitch 必须是数字",museumName:n,sceneName:h,fieldName:"目标垂直角度"}),g.target.fov!==void 0&&typeof g.target.fov!="number"&&e.push({code:"INVALID_TARGET_FOV",path:`${E}.target.fov`,message:"target.fov 必须是数字",museumName:n,sceneName:h,fieldName:"目标视野角度"})):g.type==="video"&&g.target&&typeof g.target!="object"&&e.push({code:"MISSING_HOTSPOT_TARGET",path:`${E}.target`,message:"video 类型热点的 target 必须是对象（如果提供）",museumName:n,sceneName:h,fieldName:"热点目标配置"})})}})}}),e}let ee=null;async function ot(){if(ee)return ee;try{const a=await fetch("./config.json",{cache:"no-store"});if(!a.ok)throw new Error(`加载配置失败: ${a.status}`);const e=await a.json(),t=hi(e);if(t.length>0){const i=new Error("配置校验失败");throw i.validationErrors=t,i}return ee=e,ee}catch(a){throw console.error("加载配置失败:",a),a}}function at(){ee=null}function Ye(a){if(ee)return ee.museums.find(e=>e.id===a)}function di(a,e){const t=Ye(a);if(t)return t.scenes.find(i=>i.id===e)}function Mt(a){const e=new URL(window.location.href);return e.search="",Object.entries(a).forEach(([t,i])=>{i!=null&&i!==""&&e.searchParams.set(t,String(i))}),e.pathname+e.search+e.hash}function ui(){return window.location.pathname}function mi(){if(window.location.pathname.includes("//")){const a=window.location.pathname.replace(/\/{2,}/g,"/");history.replaceState({},"",a+window.location.search+window.location.hash)}}let rt=null,lt=0;const pi=200;function ve(a){if(a.type==="focus"){const e=`${a.museumId}:${a.sceneId}`,t=Date.now();if(e===rt&&t-lt<pi)return;rt=e,lt=t}window.dispatchEvent(new CustomEvent("vr:scene-focus",{detail:a}))}function St(a){const e=t=>{a(t.detail)};return window.addEventListener("vr:scene-focus",e),()=>{window.removeEventListener("vr:scene-focus",e)}}function ct(){const a=new URLSearchParams(window.location.search),e=a.get("yaw"),t=a.get("pitch"),i=a.get("fov");return{museumId:a.get("museum")||void 0,sceneId:a.get("scene")||void 0,yaw:e?parseFloat(e):void 0,pitch:t?parseFloat(t):void 0,fov:i?parseFloat(i):void 0}}function gi(){return new URLSearchParams(window.location.search).get("debug")==="1"}function fi(){const a=new URLSearchParams(window.location.search);return a.get("editor")==="1"||a.get("debug")==="1"}function ht(){const a=ui();window.history.pushState({},"",a),window.dispatchEvent(new Event("popstate"))}function Fe(a){const e=Mt({museum:a});window.history.pushState({},"",e),window.dispatchEvent(new Event("popstate"))}function G(a,e,t){const i=Mt({museum:a,scene:e,yaw:t==null?void 0:t.yaw,pitch:t==null?void 0:t.pitch,fov:t==null?void 0:t.fov});window.history.pushState({},"",i),ve({type:"focus",museumId:a,sceneId:e,source:"dock",ts:Date.now()}),window.dispatchEvent(new Event("popstate"))}var O=(a=>(a.THUMB="thumb",a.PANO_LOW="panoLow",a.PANO="pano",a.VIDEO="video",a.COVER="cover",a.MAP="map",a.DOLLHOUSE="dollhouse",a))(O||{});const vi=["/assets/panos/"],wi=[],yi="/config.json",bi=1800,we="vrplayer.assetCdn.lastSuccess",Ei=12*60*60*1e3;let he=null,te=null,z="idle",J=0;function Ii(a){const e=a.trim();return e?e.startsWith("/")?e:`/${e}`:""}function dt(a,e){const t=Array.isArray(a)&&a.length>0?a:e,i=new Set;for(const s of t){if(typeof s!="string")continue;const o=Ii(s);o&&i.add(o)}return Array.from(i)}function Lt(a){return a.replace(/\/+$/,"")}function Mi(a){const e=[];Array.isArray(a.baseUrls)&&e.push(...a.baseUrls),typeof a.baseUrl=="string"&&e.push(a.baseUrl);const t=new Set;for(const i of e){if(typeof i!="string")continue;const s=Lt(i.trim());s&&t.add(s)}return Array.from(t)}function Si(){var a;return typeof window<"u"&&((a=window.location)!=null&&a.origin)?window.location.origin:typeof location<"u"&&location.origin?location.origin:null}function Ze(){if(typeof window>"u")return null;try{return window.localStorage}catch{return null}}function Li(a){const e=Ze();if(!e)return null;try{const t=e.getItem(we);if(!t)return null;const i=JSON.parse(t),s=typeof i.baseUrl=="string"?Lt(i.baseUrl.trim()):"",o=typeof i.expiresAt=="number"&&Number.isFinite(i.expiresAt)?i.expiresAt:0;return!s||o<=Date.now()||!a.baseUrls.includes(s)?(e.removeItem(we),null):s}catch{return e.removeItem(we),null}}function Ti(a,e){const t=Ze();if(!t||!e.baseUrls.includes(a))return;const i=Date.now(),s={baseUrl:a,updatedAt:i,expiresAt:i+Ei};try{t.setItem(we,JSON.stringify(s))}catch{}}function ut(){const a=Ze();if(a)try{a.removeItem(we)}catch{}}function Tt(a){const e=a.match(/^([^?#]*)([?#].*)?$/);return e?{path:e[1]||"",suffix:e[2]||""}:{path:a,suffix:""}}function mt(a,e){return e.some(t=>a.startsWith(t))}function Ct(a,e){return!(!mt(a,e.includePrefixes)||mt(a,e.excludePrefixes))}function xt(a,e){const{path:t,suffix:i}=Tt(a);return`${e}${t}${i}`}function Ci(a,e,t){if(!/^https?:\/\//i.test(a))return null;try{const i=new URL(a),s=Si();return!s||i.origin!==s||!Ct(i.pathname,e)?null:xt(`${i.pathname}${i.search}${i.hash}`,t)}catch{return null}}function xi(a){if(typeof a!="string"||a.trim()==="")return yi;const e=a.trim();return e.startsWith("/")?e:`/${e}`}function ki(a,e){const t=e.includes("?")?"&":"?";return`${a}${e}${t}__cdn_probe=${Date.now()}`}async function Ni(a,e,t){if(t!==J||typeof window>"u"||typeof fetch!="function")return!1;const i=typeof AbortController<"u"?new AbortController:null,s=window.setTimeout(()=>i==null?void 0:i.abort(),e.probeTimeoutMs);try{return(await fetch(ki(a,e.probePath),{method:"GET",mode:"cors",cache:"no-store",referrerPolicy:"no-referrer",signal:i==null?void 0:i.signal})).ok}catch{return!1}finally{window.clearTimeout(s)}}function Ge(a=!1){const e=he;if(!e||!e.enabled||!a&&te||z==="probing")return;if(typeof window>"u"||typeof fetch!="function"){z="failed";return}z="probing";const t=++J;(async()=>{for(const i of e.baseUrls){const s=await Ni(i,e,t);if(t!==J)return;if(s){te=i,Ti(i,e),z="ok";return}}t===J&&(te=null,ut(),z="failed")})().catch(()=>{t===J&&(te=null,ut(),z="failed")}).finally(()=>{})}function De(a){if(J+=1,te=null,z="idle",!a||a.enabled===!1){he=null;return}const e=Mi(a);if(e.length===0){he=null;return}he={enabled:!0,baseUrls:e,includePrefixes:dt(a.includePrefixes,vi),excludePrefixes:dt(a.excludePrefixes,wi),probePath:xi(a.probePath),probeTimeoutMs:typeof a.probeTimeoutMs=="number"&&Number.isFinite(a.probeTimeoutMs)?Math.max(200,Math.floor(a.probeTimeoutMs)):bi};const t=Li(he);if(t){te=t,z="ok",Ge(!0);return}Ge(!1)}function Y(a,e){if(!a||typeof a!="string"||a.trim()==="")return"";const t=a.trim(),i=he;if(!i||!i.enabled)return t;const s=te;if(!s)return Ge(),t;const o=Ci(t,i,s);if(o)return o;if(t.startsWith("//"))return t;const{path:n}=Tt(t);return!n.startsWith("/")||!Ct(n,i)?t:xt(t,s)}function Ee(){const a=document;return!!(document.fullscreenElement||a.webkitFullscreenElement)}function Pi(){const a=()=>{};document.addEventListener("fullscreenchange",a),document.addEventListener("webkitfullscreenchange",a)}var S=(a=>(a.LOADING_LOW="loadingLow",a.LOW_READY="lowReady",a.LOADING_HIGH="loadingHigh",a.HIGH_READY="highReady",a.DEGRADED="degraded",a.ERROR="error",a))(S||{});class Ai{constructor(){r(this,"element");r(this,"currentStatus","loadingLow");r(this,"autoHideTimer",null);r(this,"maxVisibleTimer",null);r(this,"maxVisibleMs",1e4);r(this,"readyHideMs",2500);r(this,"metricsText","");this.element=document.createElement("div"),this.element.className="quality-indicator",this.render(),this.applyStyles()}updateStatus(e){if(Ee()){this.hide();return}if(this.currentStatus=e,this.render(),this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),this.maxVisibleTimer&&(clearTimeout(this.maxVisibleTimer),this.maxVisibleTimer=null),e==="loadingLow"||e==="loadingHigh"||e==="error"||e==="degraded"){this.show(),this.maxVisibleTimer=window.setTimeout(()=>{this.hide()},this.maxVisibleMs);return}(e==="highReady"||e==="lowReady")&&(this.show(),this.autoHideTimer=window.setTimeout(()=>{this.hide()},this.readyHideMs))}updateMetrics(e){const t=new URLSearchParams(window.location.search);if(!(t.get("metrics")==="1"||t.get("metrics")==="true"||t.get("tilesDebug")==="1"))return;const s=e.lowReadyMs??-1,o=e.highReadyMs??-1,n=e.tileHitRate??0,c=e.tilesFailed??0,l=e.tilesRetries??0,d=e.perfMode??"",u=e.renderSource??"";this.metricsText=`low:${s}ms high:${o}ms hit:${n}% fail:${c} retry:${l} `+`${d?`perf:${d} `:""}${u?`src:${u}`:""}`.trim(),this.render()}render(){const{text:e,icon:t,className:i}=this.getStatusInfo();this.element.innerHTML=`
      <div class="quality-indicator-content ${i}">
        <span class="quality-icon">${t}</span>
        <span class="quality-text">${e}</span>
        ${this.metricsText?`<span class="quality-metrics">${this.metricsText}</span>`:""}
      </div>
    `}getStatusInfo(){switch(this.currentStatus){case"loadingLow":return{text:"正在加载低清图...",icon:"⏳",className:"status-loading"};case"lowReady":return{text:"低清图已加载",icon:"✨",className:"status-ready"};case"loadingHigh":return{text:"正在加载高清图...",icon:"⏳",className:"status-loading"};case"highReady":return{text:"已切换至高清",icon:"✨",className:"status-ready"};case"degraded":return{text:"网络较慢，已先使用低清",icon:"⚠️",className:"status-degraded"};case"error":return{text:"加载失败",icon:"❌",className:"status-error"};default:return{text:"",icon:"",className:""}}}show(){this.element.classList.add("show")}hide(){this.element.classList.remove("show")}getElement(){return this.element}remove(){this.autoHideTimer&&clearTimeout(this.autoHideTimer),this.maxVisibleTimer&&clearTimeout(this.maxVisibleTimer),this.element.remove()}applyStyles(){const e=document.createElement("style");e.textContent=`
      .quality-indicator {
        position: fixed;
        left: 50%;
        top: calc(16px + env(safe-area-inset-top, 0px));
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
        transition: opacity 0.3s, transform 0.3s;
      }
      .quality-indicator.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      .quality-indicator-content {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.75);
        border-radius: 20px;
        backdrop-filter: blur(10px);
        font-size: 13px;
        color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .quality-icon {
        font-size: 14px;
      }
      .quality-text {
        white-space: nowrap;
      }
      .quality-metrics {
        margin-left: 6px;
        font-size: 11px;
        opacity: 0.7;
        white-space: nowrap;
      }
      .status-loading {
        border-left: 3px solid #4a90e2;
      }
      .status-ready {
        border-left: 3px solid #27ae60;
      }
      .status-degraded {
        border-left: 3px solid #f39c12;
      }
      .status-error {
        border-left: 3px solid #e74c3c;
      }
      @media (max-width: 480px), ((max-width: 520px) and (pointer: coarse)) {
        .quality-indicator-content {
          padding: 6px 12px;
          font-size: 12px;
        }
      }
    `,document.head.appendChild(e)}}const kt="vr_quality";function ze(){if(typeof window>"u")return"high";try{const a=window.localStorage.getItem(kt);if(a==="low"||a==="high")return a}catch{}return"high"}function _i(a){if(!(typeof window>"u"))try{window.localStorage.setItem(kt,a)}catch{}}function Di(a=512){const e=document.createElement("canvas");e.width=a,e.height=a;const t=e.getContext("2d");if(!t){const d=new W(e);return d.needsUpdate=!0,d}const i=a/2,s=a/2,o=a/2*.92;t.clearRect(0,0,a,a);const n=t.createRadialGradient(i,s,o*.25,i,s,o);n.addColorStop(0,"rgba(0,0,0,0.00)"),n.addColorStop(.55,"rgba(0,0,0,0.18)"),n.addColorStop(1,"rgba(0,0,0,0.55)"),t.fillStyle=n,t.beginPath(),t.arc(i,s,o,0,Math.PI*2),t.closePath(),t.fill(),t.fillStyle="rgba(0,0,0,0.55)",t.beginPath(),t.arc(i,s,o*.28,0,Math.PI*2),t.closePath(),t.fill();const c=t.createRadialGradient(i,s,0,i,s,o*.42);c.addColorStop(0,"rgba(0,0,0,0.22)"),c.addColorStop(1,"rgba(0,0,0,0.00)"),t.fillStyle=c,t.beginPath(),t.arc(i,s,o*.42,0,Math.PI*2),t.closePath(),t.fill(),t.save(),t.translate(i,s);for(let d=0;d<360;d+=30){const u=d*Math.PI/180,h=d%90===0,m=h?o*.12:o*.07,f=h?2:1;t.strokeStyle=h?"rgba(255,255,255,0.25)":"rgba(255,255,255,0.14)",t.lineWidth=f,t.beginPath(),t.moveTo(Math.sin(u)*(o-m),-Math.cos(u)*(o-m)),t.lineTo(Math.sin(u)*o,-Math.cos(u)*o),t.stroke()}t.restore(),t.strokeStyle="rgba(255,255,255,0.08)",t.lineWidth=2,t.beginPath(),t.arc(i,s,o,0,Math.PI*2),t.closePath(),t.stroke();const l=new W(e);return l.colorSpace=ae,l.center.set(.5,.5),l.rotation=0,l.flipY=!1,l.needsUpdate=!0,l}const P=typeof window<"u"?new URLSearchParams(window.location.search).get("debug")==="1":!1;function T(...a){P&&console.debug("[VR Debug]",...a)}function Ri(a){return Math.max(0,Math.min(1,a))}function Vi(a){const e=Ri(a);return e*e*(3-2*e)}class Oi{constructor(e,t){r(this,"mesh");r(this,"needleMesh",null);r(this,"texture");r(this,"radius");r(this,"opacity",0);r(this,"northYaw",0);r(this,"debugHelper",null);r(this,"labelSprites",new Map);r(this,"patchRadius",0);r(this,"showPitchDeg",-45);r(this,"fadeRangeDeg",18);r(this,"fadeTauMs",140);r(this,"lastRotationY",0);r(this,"debugFrameCount",0);r(this,"isDebugVisible",!0);this.radius=t;const i=t*.18;this.patchRadius=i;const s=new Bt(i,96);s.rotateX(Math.PI/2),this.texture=Di(512);const o=new se({map:this.texture,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1,side:Wt});this.mesh=new ne(s,o),this.mesh.name="NadirPatch-compass-disk",this.mesh.position.set(0,-t+.5,0),this.mesh.renderOrder=9999,this.mesh.visible=!1,this.mesh.rotation.y=0,e.add(this.mesh);const n=i*.008,c=i*.35,l=new qt(n,n,c,8);l.rotateX(Math.PI/2),l.translate(0,0,c/2);const d=new se({color:16777215,transparent:!0,opacity:.9,depthTest:!1,depthWrite:!1});if(this.needleMesh=new ne(l,d),this.needleMesh.name="NadirPatch-compass-needle",this.needleMesh.position.set(0,-t+.51,0),this.needleMesh.rotation.order="YXZ",this.needleMesh.renderOrder=1e4,this.needleMesh.visible=!1,e.add(this.needleMesh),this.createLabelSprites(e,i,t),P&&(o.color.setHex(65535),this.debugHelper=new jt(i*.5),this.debugHelper.position.copy(this.mesh.position),this.debugHelper.renderOrder=10001,e.add(this.debugHelper),console.debug("[NadirPatch] 对象已创建:",{uuid:this.mesh.uuid,name:this.mesh.name,type:this.mesh.type,position:this.mesh.position,rotation:this.mesh.rotation})),typeof window<"u"){const u=h=>{(h.key==="N"||h.key==="n")&&!(h.target instanceof HTMLInputElement||h.target instanceof HTMLTextAreaElement)&&(h.preventDefault(),this.isDebugVisible=!this.isDebugVisible,this.mesh.visible=this.isDebugVisible&&this.opacity>.01,this.needleMesh&&(this.needleMesh.visible=this.isDebugVisible&&this.opacity>.01),this.debugHelper&&(this.debugHelper.visible=this.isDebugVisible&&this.opacity>.01),console.debug(`[NadirPatch] 显示状态切换为: ${this.isDebugVisible?"显示":"隐藏"}`))};window.addEventListener("keydown",u)}}setNorthYaw(e){this.northYaw=e}update(e,t,i){var f;const s=t.yaw,o=this.northYaw??0,n=N.degToRad(-o);this.mesh.rotation.y=n,this.texture.rotation=0,this.texture.center.set(.5,.5);const c=-o;this.updateLabelSprites(c),this.needleMesh&&(this.needleMesh.rotation.y=N.degToRad(s)),P&&(this.debugFrameCount++,this.debugFrameCount%30===0&&(Math.abs(this.mesh.rotation.y-this.lastRotationY)>.001&&console.debug("[NadirPatch] 旋转变化:",{frame:this.debugFrameCount,cameraYaw:s.toFixed(2),northYaw:o.toFixed(2),needleYaw:s.toFixed(2),diskRotationY:this.mesh.rotation.y,needleRotationY:(f=this.needleMesh)==null?void 0:f.rotation.y,diskPosition:this.mesh.position}),this.lastRotationY=this.mesh.rotation.y));const d=Vi((this.showPitchDeg-t.pitch)/this.fadeRangeDeg),u=1-Math.exp(-(i||16.7)/this.fadeTauMs);this.opacity=this.opacity+(d-this.opacity)*u;const h=this.mesh.material;h.opacity=this.opacity;const m=this.isDebugVisible&&this.opacity>.01;if(this.mesh.visible=m,this.needleMesh){this.needleMesh.visible=m;const v=this.needleMesh.material;v.opacity=this.opacity*.9}this.labelSprites.forEach(v=>{v.visible=m;const w=v.material;w.opacity=this.opacity*.85}),this.debugHelper&&(this.debugHelper.visible=m)}createLabelSprites(e,t,i){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:o})=>{const n=document.createElement("canvas"),c=128;n.width=c,n.height=c;const l=n.getContext("2d");if(!l)return;l.clearRect(0,0,c,c),l.save(),l.shadowColor="rgba(255, 255, 255, 0.8)",l.shadowBlur=8,l.shadowOffsetX=0,l.shadowOffsetY=0,l.fillStyle="rgba(255, 255, 255, 0.85)",l.font=`600 ${Math.round(c*.5)}px system-ui, -apple-system, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif`,l.textAlign="center",l.textBaseline="middle",l.fillText(o,c/2,c/2),l.restore();const d=new W(n);d.colorSpace=ae,d.needsUpdate=!0;const u=new Xt({map:d,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1}),h=new Qt(u);h.name=`NadirPatch-label-${o}`,h.position.set(0,-i+.52,0),h.renderOrder=10001,h.visible=!1;const m=t*.15;h.scale.set(m,m,1),e.add(h),this.labelSprites.set(o,h)})}updateLabelSprites(e){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:i,baseAngle:s})=>{const o=this.labelSprites.get(i);if(!o)return;const n=s+e,c=this.patchRadius*.56,l=N.degToRad(n),d=-this.radius+.5,u=Math.sin(l)*c,h=Math.cos(l)*c;o.position.set(u,d+.02,h);const m=new H(0,0,0);o.lookAt(m)})}dispose(e){e.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose(),this.needleMesh&&(e.remove(this.needleMesh),this.needleMesh.geometry.dispose(),this.needleMesh.material.dispose()),this.labelSprites.forEach(t=>{e.remove(t),t.material.dispose(),t.material.map&&t.material.map.dispose()}),this.labelSprites.clear(),this.debugHelper&&(e.remove(this.debugHelper),this.debugHelper.dispose())}}function Hi(a,e,t){const i=(a-t.left)/t.width*2-1,s=-((e-t.top)/t.height*2-1);return{x:i,y:s}}function Ui(a,e,t,i=500){const s=new Kt;s.setFromCamera(new Zt(a,e),t);const o=s.ray.direction;if(!o||o.length()===0)return null;const n=o.normalize(),c=Math.asin(Math.max(-1,Math.min(1,n.y))),l=N.radToDeg(c),d=Math.atan2(n.x,n.z);return{yaw:N.radToDeg(d),pitch:l}}const Be=-55,$i=-90;function Je(a){const e=Math.max(0,Math.min(1,(a-Be)/($i-Be))),t=e,i=-e*8,s=1-e*.7,o=e*2;return{opacity:t,translateY:i,scaleY:s,blur:o,clarity:e}}function et(a){return a<=Be}class Yi{constructor(){r(this,"listeners",new Map);r(this,"lastInteractionTs",0);r(this,"idleDelay",800);r(this,"idleTimer",null);r(this,"rafId",null);r(this,"isScheduled",!1);this.listeners.set("user-interacting",new Set),this.listeners.set("user-idle",new Set),this.listeners.set("ui-engaged",new Set)}on(e,t){const i=this.listeners.get(e);return i?(i.add(t),()=>{i.delete(t)}):(console.warn(`[InteractionBus] 未知事件类型: ${e}`),()=>{})}off(e,t){const i=this.listeners.get(e);i&&i.delete(t)}emit(e){this.isScheduled||(this.isScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.isScheduled=!1;const t=this.listeners.get(e);t&&t.forEach(i=>{try{i()}catch(s){console.error("[InteractionBus] 事件监听器执行失败:",s)}})}))}emitInteracting(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("user-interacting")}scheduleIdle(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.idleTimer=window.setTimeout(()=>{Date.now()-this.lastInteractionTs>=this.idleDelay&&(this.idleTimer=null,this.emit("user-idle"))},this.idleDelay)}emitUIEngaged(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("ui-engaged")}dispose(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.listeners.forEach(e=>e.clear()),this.listeners.clear()}}const k=new Yi;class Fi{constructor(e={}){r(this,"root");r(this,"disk");r(this,"mask");r(this,"polemask");r(this,"northLabel");r(this,"eastLabel");r(this,"southLabel");r(this,"westLabel");r(this,"needle");r(this,"currentYaw",0);r(this,"currentPitch",0);r(this,"northYaw",0);r(this,"sceneId","");r(this,"northYawLabel",null);r(this,"isVisible",!1);r(this,"unsubscribeInteracting",null);r(this,"unsubscribeIdle",null);r(this,"unsubscribeUIEngaged",null);r(this,"baseOpacity",0);this.root=document.createElement("div"),this.root.className="vr-compass",this.root.setAttribute("data-ui","CompassDisk"),this.root.style.outline="2px solid #ff00ff",this.disk=document.createElement("div"),this.disk.className="vr-compass__disk",this.disk.setAttribute("data-ui","CompassDisk-disk"),this.mask=document.createElement("div"),this.mask.className="vr-compass__mask",this.polemask=document.createElement("div"),this.polemask.className="vr-compass__polemask",this.polemask.setAttribute("aria-hidden","true"),this.northLabel=document.createElement("div"),this.northLabel.className="vr-compass__label vr-compass__label--north",this.northLabel.textContent="北",this.eastLabel=document.createElement("div"),this.eastLabel.className="vr-compass__label vr-compass__label--east",this.eastLabel.textContent="东",this.southLabel=document.createElement("div"),this.southLabel.className="vr-compass__label vr-compass__label--south",this.southLabel.textContent="南",this.westLabel=document.createElement("div"),this.westLabel.className="vr-compass__label vr-compass__label--west",this.westLabel.textContent="西",this.needle=document.createElement("div"),this.needle.className="vr-compass__needle",this.needle.setAttribute("data-ui","CompassDisk-needle"),this.northYawLabel=document.createElement("div"),this.northYawLabel.className="vr-compass__north-yaw-label",this.northYawLabel.style.cssText=`
      position: absolute;
      bottom: -20px;
      right: 10px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
      font-family: monospace;
      pointer-events: none;
      display: none;
    `,this.disk.appendChild(this.mask),this.disk.appendChild(this.polemask),this.disk.appendChild(this.northLabel),this.disk.appendChild(this.eastLabel),this.disk.appendChild(this.southLabel),this.disk.appendChild(this.westLabel),this.disk.appendChild(this.needle),this.root.appendChild(this.disk),this.root.appendChild(this.northYawLabel),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--compass-disk-rot","0deg"),this.root.style.setProperty("--compass-needle-rot","0deg"),this.root.style.setProperty("--compass-label-counter-rot","0deg"),this.setupInteractionListeners()}setupInteractionListeners(){this.unsubscribeInteracting=k.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=k.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=k.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}mount(e){e.appendChild(this.root)}setSceneId(e){this.sceneId=e,this.updateNorthYawLabel()}setNorthYaw(e){this.northYaw=e,this.updateNorthYawLabel()}updateNorthYawLabel(){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}updateYawLabel(e){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)} Yaw=${e.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,et(t)){const s=Je(t);this.baseOpacity=s.opacity,this.root.style.setProperty("--vr-ground-clarity",String(s.clarity)),this.root.style.opacity=s.opacity.toString();const o=`translateX(-50%) translateY(${s.translateY}px) scaleY(${s.scaleY})`;this.root.classList.contains("vr-ui-interacting")?this.root.style.transform=o:this.root.style.transform=o,this.root.style.setProperty("--vr-ground-base-blur",`${s.blur}px`);const n=e,l=-(this.northYaw??0),d=n;this.root.style.setProperty("--compass-disk-rot",`${l}deg`),this.root.style.setProperty("--compass-needle-rot",`${d}deg`);const u=42,h=(m,f)=>{const v=f+l,w=v+180;m.style.transform=`rotate(${v}deg) translateY(-${u}%) rotate(${w}deg)`};h(this.northLabel,0),h(this.eastLabel,270),h(this.southLabel,180),h(this.westLabel,90),this.updateYawLabel(e),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.northLabel.style.transform="",this.eastLabel.style.transform="",this.southLabel.style.transform="",this.westLabel.style.transform="",this.isVisible=!1,this.baseOpacity=0)}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=null),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=null),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=null),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}const pt=60,Re=14,Gi=4,gt=650,zi=120,ft=900,Ie=-62,Bi=150;class Wi{constructor(e){r(this,"root");r(this,"container");r(this,"dots",new Map);r(this,"dotYawDeg",new Map);r(this,"currentYaw",0);r(this,"currentPitch",0);r(this,"isVisible",!1);r(this,"museumId");r(this,"currentSceneId");r(this,"sceneHotspots");r(this,"hoverSceneId",null);r(this,"onNavigateToScene");r(this,"unsubscribeFocus");r(this,"lastYawDeg",0);r(this,"lastPitchDeg",0);r(this,"aimedSceneId",null);r(this,"isInteracting",!1);r(this,"unsubscribeInteracting");r(this,"unsubscribeIdle");r(this,"unsubscribeUIEngaged");r(this,"idleRecoveryTimer",null);r(this,"lastAimChangeTs",0);r(this,"autoNavTimer",null);r(this,"autoNavTargetSceneId",null);r(this,"lastAutoNavTs",0);r(this,"aimDebounceTimer",null);this.museumId=e.museumId,this.currentSceneId=e.currentSceneId,this.sceneHotspots=e.sceneHotspots,this.onNavigateToScene=e.onNavigateToScene||G,this.root=document.createElement("div"),this.root.className="vr-groundnav",this.root.setAttribute("data-ui","GroundNavDots"),this.root.style.outline="2px solid #00ffff",this.container=document.createElement("div"),this.container.className="vr-groundnav__container",this.root.appendChild(this.container),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.unsubscribeFocus=St(t=>{this.handleSceneFocus(t)}),this.setupInteractionListeners(),this.renderDots()}setupInteractionListeners(){this.unsubscribeInteracting=k.on("user-interacting",()=>{T("统一终止触发点: 用户交互"),this.isInteracting=!0,this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav()}),this.unsubscribeIdle=k.on("user-idle",()=>{this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.idleRecoveryTimer=window.setTimeout(()=>{if(this.idleRecoveryTimer=null,!this.root.parentNode){T("idleRecoveryTimer: component disposed, skipping");return}this.isInteracting=!1},400)}),this.unsubscribeUIEngaged=k.on("ui-engaged",()=>{T("统一终止触发点: UI 点击"),this.clearAllTimers(),this.isInteracting=!1,this.clearAimed(),this.cancelAutoNav()})}clearAimDebounce(){this.aimDebounceTimer!==null&&(window.clearTimeout(this.aimDebounceTimer),this.aimDebounceTimer=null)}clearAllTimers(){this.clearAimDebounce(),this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.autoNavTimer!==null&&(clearTimeout(this.autoNavTimer),this.autoNavTimer=null)}normalizeDeg(e){return(e%360+360)%360}shortestDeltaDeg(e,t){return(this.normalizeDeg(e)-this.normalizeDeg(t)+180)%360-180}clearAimed(){if(this.aimedSceneId!==null){const e=this.dots.get(this.aimedSceneId);e&&(e.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId)),this.aimedSceneId=null,this.clearAimDebounce(),this.emitSceneAim("clear",null)}this.cancelAutoNav()}cancelAutoNav(){if(this.autoNavTimer!=null&&(window.clearTimeout(this.autoNavTimer),this.autoNavTimer=null),this.autoNavTargetSceneId!==null){const e=this.autoNavTargetSceneId;if(e){this.removeProgress(e);const t=this.dots.get(e);t&&t.classList.remove("is-autonav","is-autonav-progress"),this.emitSceneAutoNav("cancel",e)}this.autoNavTargetSceneId=null}}removeProgress(e){const t=this.dots.get(e);if(!t)return;const i=t.querySelector(".vr-groundnav__progress");i&&t.removeChild(i)}addProgress(e){const t=this.dots.get(e);if(!t)return;this.removeProgress(e);const i=document.createElement("div");i.className="vr-groundnav__progress",i.style.setProperty("--progress-duration",`${gt}ms`),t.appendChild(i),t.classList.add("is-autonav-progress")}scheduleAutoNavIfAllowed(e){if(!e){T("scheduleAutoNavIfAllowed: sceneId is missing, skipping");return}const t=Date.now();if(this.isInteracting){T("scheduleAutoNavIfAllowed: isInteracting, skipping");return}if(this.lastPitchDeg>Ie){T("scheduleAutoNavIfAllowed: pitch too high, skipping",this.lastPitchDeg);return}if(t-this.lastAutoNavTs<ft){T("scheduleAutoNavIfAllowed: cooldown, skipping");return}if(t-this.lastAimChangeTs<zi){T("scheduleAutoNavIfAllowed: min dwell, skipping");return}if(this.currentSceneId&&e===this.currentSceneId){T("scheduleAutoNavIfAllowed: same as current scene, skipping");return}this.autoNavTargetSceneId!==null&&this.autoNavTargetSceneId!==e&&this.cancelAutoNav(),T("scene-autonav: start",{sceneId:e}),this.autoNavTargetSceneId=e;const i=this.dots.get(e);i&&(i.classList.add("is-autonav"),this.addProgress(e)),this.emitSceneAutoNav("start",e),this.autoNavTimer=window.setTimeout(()=>{if(this.autoNavTimer=null,!this.root.parentNode){T("autoNavTimer: component disposed, skipping");return}if(!e){T("autoNavTimer: sceneId is missing, skipping");return}this.tryAutoNavigate(e)},gt)}tryAutoNavigate(e){if(!e){T("tryAutoNavigate: sceneId is missing, skipping"),this.cancelAutoNav();return}if(this.isInteracting){T("tryAutoNavigate: isInteracting, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.aimedSceneId||this.aimedSceneId!==e){T("tryAutoNavigate: aimedSceneId mismatch, canceling",{aimedSceneId:this.aimedSceneId,sceneId:e}),this.cancelAutoNav(),this.clearAimed();return}if(this.lastPitchDeg>Ie){T("tryAutoNavigate: pitch too high, canceling",this.lastPitchDeg),this.cancelAutoNav(),this.clearAimed();return}const t=Date.now();if(t-this.lastAutoNavTs<ft){T("tryAutoNavigate: cooldown, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.museumId){T("tryAutoNavigate: museumId is missing, canceling"),this.cancelAutoNav(),this.clearAimed();return}T("scene-autonav: trigger",{museumId:this.museumId,sceneId:e});const i=e;this.cancelAutoNav(),this.clearAimed(),this.lastAutoNavTs=t,window.dispatchEvent(new CustomEvent("vr:close-panels")),ve({type:"focus",museumId:this.museumId,sceneId:i,source:"pano-auto",ts:t}),this.onNavigateToScene(this.museumId,i)}maybeRescheduleOrCancelByPitch(e){e>Ie?(this.autoNavTargetSceneId&&this.cancelAutoNav(),this.aimedSceneId&&this.clearAimed()):this.aimedSceneId&&e<=Ie&&!this.isInteracting&&!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(this.aimedSceneId)}emitSceneAim(e,t){if(!this.museumId){T("emitSceneAim: museumId is missing, skipping");return}T("scene-aim",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-aim",{detail:{type:e,museumId:this.museumId,sceneId:t||void 0,source:"groundnav",ts:Date.now()}}))}emitSceneAutoNav(e,t){if(!this.museumId){T("emitSceneAutoNav: museumId is missing, skipping");return}T("scene-autonav",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-autonav",{detail:{type:e,museumId:this.museumId,sceneId:t??void 0,ts:Date.now()}}))}updateAimed(e){if(this.isInteracting||!this.isVisible){this.clearAimed();return}const t=this.sceneHotspots.filter(n=>{var c;return(c=n.target)==null?void 0:c.sceneId});if(t.length===0){this.clearAimed();return}let i=null,s=1/0;t.forEach(n=>{const c=n.target.sceneId;if(c===this.currentSceneId)return;const l=n.yaw,d=Math.abs(this.shortestDeltaDeg(e,l));d<s&&(s=d,i=c)});let o=!1;if(i!==null&&(this.aimedSceneId===null?o=s<=Re:i===this.aimedSceneId?o=s<=Re+Gi:o=s<=Re),this.isInteracting){this.clearAimed();return}if(o&&i!==null)if(this.aimedSceneId!==i){if(this.lastAimChangeTs=Date.now(),this.cancelAutoNav(),this.aimedSceneId!==null){const c=this.dots.get(this.aimedSceneId);c&&(c.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId))}this.aimedSceneId=i;const n=this.dots.get(i);n&&n.classList.add("is-aimed"),this.clearAimDebounce(),this.aimDebounceTimer=window.setTimeout(()=>{if(this.aimDebounceTimer=null,!this.root.parentNode){T("aimDebounceTimer: component disposed, skipping");return}this.aimedSceneId===i&&!this.isInteracting&&this.isVisible?(this.emitSceneAim("aim",i),this.scheduleAutoNavIfAllowed(i)):this.aimedSceneId===i&&this.clearAimed()},Bi)}else!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(i);else this.clearAimed()}handleSceneFocus(e){e.type==="hover"?this.hoverSceneId=e.sceneId:e.type==="focus"&&(T("统一终止触发点: 场景切换",{sceneId:e.sceneId}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),e.sceneId&&(this.currentSceneId=e.sceneId),this.hoverSceneId=null),this.updateDotStates()}updateDotStates(){this.dots.forEach((e,t)=>{e.classList.remove("is-current","is-hover"),t===this.currentSceneId?e.classList.add("is-current"):t===this.hoverSceneId&&e.classList.add("is-hover")})}renderDots(){this.container.innerHTML="",this.dots.clear(),this.dotYawDeg.clear(),this.aimedSceneId=null,this.sceneHotspots.filter(t=>{var i;return(i=t.target)==null?void 0:i.sceneId}).forEach(t=>{const i=t.target.sceneId,s=document.createElement("div");s.className="vr-groundnav__dot",s.setAttribute("data-scene-id",i),s.setAttribute("title",t.label),this.dotYawDeg.set(i,t.yaw),s.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),k.emitUIEngaged(),ve({type:"focus",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()}),window.dispatchEvent(new CustomEvent("vr:close-panels")),t.target.museumId&&t.target.sceneId?this.onNavigateToScene(t.target.museumId,t.target.sceneId):T("dot click: museumId or sceneId is missing, skipping navigation")}),s.addEventListener("mouseenter",()=>{ve({type:"hover",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()})}),s.addEventListener("mouseleave",()=>{ve({type:"hover",museumId:t.target.museumId,sceneId:null,source:"pano",ts:Date.now()})}),this.container.appendChild(s),this.dots.set(t.target.sceneId,s)}),this.updateDotStates(),this.updateDotPositions()}updateDotPositions(){this.sceneHotspots.filter(t=>{var i;return(i=t.target)==null?void 0:i.sceneId}).forEach(t=>{const i=this.dots.get(t.target.sceneId);if(!i)return;const s=t.yaw*Math.PI/180,o=Math.sin(s)*pt,n=-Math.cos(s)*pt;i.style.transform=`translate(${o}px, ${n}px)`})}setYawPitch(e,t){this.currentYaw=e,this.currentPitch=t;const i=Math.abs(this.lastYawDeg-e)>.1;if(this.lastYawDeg=e,this.lastPitchDeg=t,et(t)){const o=Je(t),n=String(o.clarity);this.root.style.getPropertyValue("--vr-ground-clarity")!==n&&this.root.style.setProperty("--vr-ground-clarity",n);const c=o.opacity.toString();this.root.style.opacity!==c&&(this.root.style.opacity=c);const l=`translateX(-50%) translateY(${o.translateY}px) scaleY(${o.scaleY})`;this.root.style.transform!==l&&(this.root.style.transform=l);const d=`${o.blur}px`;this.root.style.getPropertyValue("--vr-ground-base-blur")!==d&&this.root.style.setProperty("--vr-ground-base-blur",d),this.isVisible||(this.isVisible=!0),!this.isInteracting&&i&&(this.updateAimed(e),this.maybeRescheduleOrCancelByPitch(t))}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1,this.clearAimed());i&&this.updateDotPositions()}updateScene(e,t,i){if(T("统一终止触发点: 博物馆/场景切换",{museumId:e,currentSceneId:t}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),!e){T("updateScene: museumId is missing");return}this.museumId=e,this.currentSceneId=t,this.sceneHotspots=i,this.hoverSceneId=null,this.renderDots()}mount(e){e.appendChild(this.root)}dispose(){this.clearAllTimers(),this.cancelAutoNav(),this.clearAimed(),this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=void 0),this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}class qi{constructor(e,t={}){r(this,"root");r(this,"inner");r(this,"wedge");r(this,"northTick");r(this,"needle");r(this,"currentYaw",0);r(this,"currentPitch",0);r(this,"northYaw",0);r(this,"isVisible",!1);r(this,"unsubscribeInteracting");r(this,"unsubscribeIdle");r(this,"unsubscribeUIEngaged");this.root=document.createElement("div"),this.root.className="vr-groundheading",this.root.setAttribute("data-ui","GroundHeadingMarker"),this.root.style.outline="2px solid #00ffff",this.inner=document.createElement("div"),this.inner.className="vr-groundheading__inner",this.wedge=document.createElement("div"),this.wedge.className="vr-groundheading__wedge",this.northTick=document.createElement("div"),this.northTick.className="vr-groundheading__northTick",this.needle=document.createElement("div"),this.needle.className="vr-groundheading__needle",this.inner.appendChild(this.wedge),this.inner.appendChild(this.northTick),this.inner.appendChild(this.needle),this.root.appendChild(this.inner),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--groundheading-disk-rot","0deg"),this.root.style.setProperty("--groundheading-needle-rot","0deg"),e.appendChild(this.root),this.setupInteractionListeners()}setNorthYaw(e){this.northYaw=e}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,et(t)){const s=Je(t);this.root.style.setProperty("--vr-ground-clarity",String(s.clarity)),this.root.style.opacity=s.opacity.toString(),this.root.style.transform=`translateX(-50%) translateY(${s.translateY}px) scaleY(${s.scaleY})`,this.root.style.setProperty("--vr-ground-base-blur",`${s.blur}px`);const o=e,c=-(this.northYaw??0),l=o;this.root.style.setProperty("--groundheading-disk-rot",`${c}deg`),this.root.style.setProperty("--groundheading-needle-rot",`${l}deg`),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1)}setInteracting(e){e?this.root.classList.add("vr-ui-interacting"):this.root.classList.remove("vr-ui-interacting")}setupInteractionListeners(){this.unsubscribeInteracting=k.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=k.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=k.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}function pe(a){try{const t=new URL(a).hostname;if(t==="i.ibb.co"||t==="s41.ax1x.com")return`/_img?u=${encodeURIComponent(a)}`}catch{}return a}class q extends Error{constructor(e,t,i){super(t),this.url=e,this.originalError=i,this.name="ExternalImageLoadError"}}let Ve=0;const Oe=[];function Nt(a){return new Promise((e,t)=>{const i=async()=>{Ve++;try{const s=await a();e(s)}catch(s){t(s)}finally{Ve--,Oe.length>0&&Oe.shift()()}};Ve<2?i():Oe.push(i)})}async function ji(a,e,t,i,s,o="from-image"){let n=null;for(let c=0;c<=t;c++){const l=new AbortController,d=setTimeout(()=>l.abort(),e);try{const u={mode:"cors",referrerPolicy:"no-referrer",signal:l.signal};s&&(u.priority=s);const h=await fetch(a,u);if(clearTimeout(d),!h.ok)throw new Error(`HTTP ${h.status}: ${h.statusText}`);const m=await h.blob();return await createImageBitmap(m,{imageOrientation:o,premultiplyAlpha:"none"})}catch(u){if(clearTimeout(d),n=u instanceof Error?u:new Error(String(u)),c<t){const h=i*Math.pow(2,c);console.warn(`外链图片 fetch 重试 ${c+1}/${t+1}: ${a}`,n.message),await new Promise(m=>setTimeout(m,h))}}}throw new q(a,`fetch 加载失败（${t+1} 次尝试）: ${(n==null?void 0:n.message)||"未知错误"}`,n||void 0)}async function Xi(a,e={}){const{timeoutMs:t=15e3,retries:i=2,retryBaseDelayMs:s=300,referrerPolicy:o="no-referrer",crossOrigin:n="anonymous",priority:c}=e,l=pe(a);return Nt(async()=>new Promise((d,u)=>{let h=null,m=0,f=null,v=null;const w=()=>{m++;const p=new Image;v=p,p.decoding="async",p.referrerPolicy=o,p.crossOrigin=n,c&&(p.fetchPriority=c),h!==null&&(clearTimeout(h),h=null),h=window.setTimeout(()=>{if(h=null,f=new Error("加载超时"),v&&(v.onload=null,v.onerror=null,v=null),m<=i){const g=s*Math.pow(2,m-1);console.warn(`外链图片加载超时重试 ${m}/${i+1}: ${l}`),setTimeout(w,g)}else u(new q(a,`加载超时（${i+1} 次尝试）`,f))},t),p.onload=()=>{h!==null&&(clearTimeout(h),h=null),p.complete&&p.naturalWidth>0?d(p):setTimeout(()=>d(p),0)},p.onerror=g=>{if(h!==null&&(clearTimeout(h),h=null),f=new Error("图片加载失败"),v===p&&(v.onload=null,v.onerror=null,v=null),m<=i){const b=s*Math.pow(2,m-1);console.warn(`外链图片加载失败重试 ${m}/${i+1}: ${l}`,g),setTimeout(w,b)}else u(new q(a,`图片加载失败（${i+1} 次尝试）`,f))},p.src=l};w()}))}async function de(a,e={}){const{timeoutMs:t=15e3,retries:i=2,retryBaseDelayMs:s=300,allowFetchFallback:o=!1,imageOrientation:n="from-image"}=e,c=pe(a);return Nt(async()=>{try{const l=await Xi(c,e);return await createImageBitmap(l,{imageOrientation:n,premultiplyAlpha:"none"})}catch(l){if(o){console.warn(`Image() 加载失败，尝试 fetch 兜底: ${c}`,l);try{return await ji(c,t,i,s,e.priority,n)}catch{throw l instanceof q?l:new q(a,`Image() 和 fetch 均失败: ${l instanceof Error?l.message:String(l)}`,l instanceof Error?l:void 0)}}else throw l instanceof q?l:new q(a,`Image() 加载失败: ${l instanceof Error?l.message:String(l)}`,l instanceof Error?l:void 0)}})}const $=class ${constructor(){r(this,"element",null);r(this,"textEl",null);r(this,"hideTimer",null)}ensure(){this.element||(this.element=document.createElement("div"),this.element.className="vr-zoom-hud",this.textEl=document.createElement("div"),this.textEl.className="vr-zoom-hud__text",this.textEl.textContent="缩放 100%",this.element.appendChild(this.textEl),document.body.appendChild(this.element))}show(e){this.ensure(),!(!this.element||!this.textEl)&&(this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.textEl.textContent=`缩放 ${e}%`,this.element.classList.add("is-on"),this.hideTimer=window.setTimeout(()=>{this.hide()},600))}hide(){this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.element&&this.element.classList.remove("is-on")}static ensure(){return $.instance||($.instance=new $),$.instance}static show(e){$.ensure().show(e)}static hide(){$.instance&&$.instance.hide()}};r($,"instance",null);let We=$,ie=null;function U(a,e=1500){if(Ee())return;const t=document.querySelector(".vr-toast"),i=t??document.createElement("div");i.className="vr-toast",i.textContent=a,t||document.body.appendChild(i),window.requestAnimationFrame(()=>i.classList.add("show")),ie&&window.clearTimeout(ie),ie=window.setTimeout(()=>{i.classList.remove("show"),window.setTimeout(()=>i.remove(),220),ie=null},e)}function Qi(){const a=document.querySelector(".vr-toast");a&&(a.classList.remove("show"),window.setTimeout(()=>a.remove(),220)),ie&&(window.clearTimeout(ie),ie=null)}let re=null,Ki=0;const ue=new Map;function Zi(){return typeof Worker>"u"?null:re||(re=new Worker(new URL(""+new URL("bitmapDecode.worker-FGbDVlpY.js",import.meta.url).href,import.meta.url),{type:"module"}),re.onmessage=a=>{const{id:e,bitmap:t,error:i}=a.data||{},s=ue.get(e);s&&(ue.delete(e),s.timer&&window.clearTimeout(s.timer),i?s.reject(new Error(i)):t?s.resolve(t):s.reject(new Error("worker 返回空结果")))},re.onerror=()=>{ue.forEach(a=>a.reject(new Error("worker error"))),ue.clear()},re)}async function Pt(a,e={}){const t=Zi();if(!t||typeof createImageBitmap>"u")return null;const i=++Ki,s=Math.max(1e3,e.timeoutMs??12e3),o=e.priority??"high",n=e.imageOrientation??"from-image";return new Promise((c,l)=>{const d={resolve:c,reject:l};d.timer=window.setTimeout(()=>{ue.delete(i),l(new Error("worker decode timeout"))},s+500),ue.set(i,d),t.postMessage({id:i,url:a,timeoutMs:s,priority:o,imageOrientation:n})})}class Ji{constructor(e,t,i,s=0){r(this,"maxTextureSize");r(this,"manifest",null);r(this,"canvas",null);r(this,"ctx",null);r(this,"texture",null);r(this,"mesh",null);r(this,"pendingLow",[]);r(this,"pendingHigh",[]);r(this,"activeLoads",0);r(this,"activeLowLoads",0);r(this,"activeHighLoads",0);r(this,"maxConcurrent",6);r(this,"maxHighWhileLow",2);r(this,"defaultMaxConcurrent",6);r(this,"defaultMaxHighWhileLow",2);r(this,"lastUpdate",0);r(this,"tilesMap",new Map);r(this,"highestLevel",null);r(this,"lowLevel",null);r(this,"lowReadyCount",0);r(this,"lowTotalCount",0);r(this,"lowFullyReady",!1);r(this,"highSeeded",!1);r(this,"tilesVisible",!1);r(this,"tilesLoadedCount",0);r(this,"tilesLoadingCount",0);r(this,"tilesQueuedCount",0);r(this,"tilesFailedCount",0);r(this,"tilesRetryCount",0);r(this,"lastTileUrl","");r(this,"lastError","");r(this,"lruLimit",64);r(this,"highReady",!1);r(this,"canvasScale",1);r(this,"fallbackVisible",!1);r(this,"prefetchSeeded",!1);this.scene=e,this.onFirstDraw=t,this.onHighReady=i,this.maxTextureSize=Math.max(0,s)}async load(e,t){var f;if(this.manifest=e,this.fallbackVisible=!!(t!=null&&t.fallbackVisible),this.highestLevel=e.levels.reduce((v,w)=>w.z>v.z?w:v),!this.highestLevel)throw new Error("manifest 缺少 level");this.lruLimit=Math.max(64,Math.min(this.highestLevel.cols*this.highestLevel.rows,256));const i=e.levels.filter(v=>v.z<this.highestLevel.z);this.lowLevel=i.length?i.reduce((v,w)=>w.z>v.z?w:v):null,this.lowReadyCount=0,this.lowTotalCount=this.lowLevel?this.lowLevel.cols*this.lowLevel.rows:0,this.lowFullyReady=this.lowTotalCount===0,this.highSeeded=!1,this.prefetchSeeded=!1,this.tilesVisible=!1,this.tilesLoadedCount=0,this.tilesLoadingCount=0,this.tilesQueuedCount=0,this.tilesFailedCount=0,this.tilesRetryCount=0,this.activeLoads=0,this.activeLowLoads=0,this.activeHighLoads=0;const s=this.highestLevel.cols,o=this.highestLevel.rows,n=e.tileSize,c=n*s,l=n*o;let d=c,u=l;if(this.canvasScale=1,this.maxTextureSize>0&&(d>this.maxTextureSize||u>this.maxTextureSize)){const v=Math.min(this.maxTextureSize/d,this.maxTextureSize/u);d=Math.max(1,Math.floor(d*v)),u=Math.max(1,Math.floor(u*v)),this.canvasScale=v}this.canvas=document.createElement("canvas"),this.canvas.width=d,this.canvas.height=u,this.ctx=this.canvas.getContext("2d",{alpha:!0}),this.fallbackVisible&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.texture=new W(this.canvas),this.texture.flipY=!1,this.texture.wrapS=D,this.texture.wrapT=D,this.texture.minFilter=me,this.texture.magFilter=me,this.texture.generateMipmaps=!1,"colorSpace"in this.texture?this.texture.colorSpace=ae:this.texture.encoding=be,this.texture.needsUpdate=!0;const h=new Qe(500,64,64);h.scale(-1,1,1);const m=new se({map:this.texture,transparent:!0,opacity:0,depthWrite:!1,depthTest:!1});if(m.toneMapped=!1,this.mesh=new ne(h,m),this.mesh.renderOrder=1,this.mesh.frustumCulled=!1,this.scene.add(this.mesh),!this.fallbackVisible){if(!e.levels.find(b=>b.z===0))throw new Error("manifest 缺少 z0");const w=`${e.baseUrl}/z0/0_0.jpg`,p=await this.fetchTileBitmap(w,"high"),g={z:0,col:0,row:0,url:w,state:"ready",priority:"low",bitmap:p,lastUsed:performance.now(),failCount:0};await this.drawTile(g),(f=p.close)==null||f.call(p)}this.lowLevel&&this.enqueueLevel(this.lowLevel,"low")}setPerformanceMode(e){e==="throttle"?(this.maxConcurrent=2,this.maxHighWhileLow=0):(this.maxConcurrent=this.defaultMaxConcurrent,this.maxHighWhileLow=this.defaultMaxHighWhileLow)}dispose(){if(this.tilesMap.forEach(e=>{var t,i;return(i=(t=e.bitmap)==null?void 0:t.close)==null?void 0:i.call(t)}),this.tilesMap.clear(),this.mesh){this.mesh.geometry&&this.mesh.geometry.dispose();const e=this.mesh.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.mesh)}}update(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;const t=performance.now();if(t-this.lastUpdate<150)return;if(this.lastUpdate=t,(!this.lowLevel||this.lowFullyReady||this.highSeeded)&&this.highestLevel){const n=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});for(const{col:c,row:l,rank:d}of n){const u=`${this.highestLevel.z}_${c}_${l}`;let h=this.tilesMap.get(u);h||(h={z:this.highestLevel.z,col:c,row:l,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${c}_${l}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(u,h)),h.priority="high",h.priorityRank=d,h.lastUsed=t,h.state==="empty"&&!h.retryTimer&&(h.state="loading",this.pendingHigh.push(h))}}const s=Array.from(this.tilesMap.values()).filter(n=>n.state==="loading").length,o=Array.from(this.tilesMap.values()).filter(n=>n.state==="ready").length;if(this.lowLevel&&!this.lowFullyReady){const n=Array.from(this.tilesMap.values()).filter(c=>c.z===this.lowLevel.z&&c.state==="loading").length;this.pendingLow.length===0&&n===0&&(this.lowFullyReady=!0)}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=s,this.tilesLoadedCount=o,this.processQueue(),this.runLru(t)}prime(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;e.updateMatrixWorld(!0);const t=performance.now();if(this.highestLevel&&!this.highSeeded){const i=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});if(i.length>0){for(const{col:s,row:o,rank:n}of i){const c=`${this.highestLevel.z}_${s}_${o}`;let l=this.tilesMap.get(c);l||(l={z:this.highestLevel.z,col:s,row:o,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${s}_${o}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(c,l)),l.priority="high",l.priorityRank=n,l.lastUsed=t,l.state==="empty"&&!l.retryTimer&&(l.state="loading",this.pendingHigh.push(l))}this.highSeeded=!0}}this.reprioritizeLowQueue(e),this.seedHighPreload(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(i=>i.state==="loading").length,this.processQueue()}getStatus(){var e,t;return{tilesVisible:this.tilesVisible,fallbackVisible:this.fallbackVisible,tilesLoadedCount:this.tilesLoadedCount,tilesLoadingCount:this.tilesLoadingCount,tilesQueuedCount:this.tilesQueuedCount,tilesFailedCount:this.tilesFailedCount,tilesRetryCount:this.tilesRetryCount,lastTileUrl:this.lastTileUrl,lastError:this.lastError,canvasSize:this.canvas?`${this.canvas.width}x${this.canvas.height}`:"0x0",canvasScale:this.canvasScale,maxLevel:this.highestLevel?`${this.highestLevel.cols}x${this.highestLevel.rows}`:"",highReady:this.highReady,zMax:((e=this.highestLevel)==null?void 0:e.z)??0,levels:this.manifest?this.manifest.levels.map(i=>i.z).join(","):"",lowReady:this.lowFullyReady,lowLevel:((t=this.lowLevel)==null?void 0:t.z)??""}}enqueueLevel(e,t){const i=performance.now();for(let s=0;s<e.rows;s++)for(let o=0;o<e.cols;o++){const n=`${e.z}_${o}_${s}`;let c=this.tilesMap.get(n);c||(c={z:e.z,col:o,row:s,url:`${this.manifest.baseUrl}/z${e.z}/${o}_${s}.jpg`,state:"empty",priority:t,lastUsed:i,failCount:0},this.tilesMap.set(n,c)),c.priority=t,c.lastUsed=i,c.state==="empty"&&!c.retryTimer&&(c.state="loading",t==="low"?this.pendingLow.push(c):this.pendingHigh.push(c))}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(s=>s.state==="loading").length,this.processQueue()}processQueue(){for(this.sortPendingHighQueue();this.activeLoads<this.maxConcurrent&&(this.pendingLow.length>0||this.pendingHigh.length>0);){const e=this.pendingLow.length>0,i=this.pendingHigh.length>0&&(!e||this.activeHighLoads<this.maxHighWhileLow)?this.pendingHigh.shift():this.pendingLow.shift();this.loadTile(i)}}async loadTile(e){(e.failCount===void 0||e.failCount===null)&&(e.failCount=0),e.priority||(e.priority="high"),this.activeLoads+=1,e.priority==="high"?this.activeHighLoads+=1:this.activeLowLoads+=1,this.lastTileUrl=e.url;try{const t=await this.fetchTileBitmap(e.url,e.priority);e.bitmap=t,e.state="ready",e.failCount=0,e.retryTimer&&(clearTimeout(e.retryTimer),e.retryTimer=void 0),this.drawTile(e),this.tilesLoadedCount+=1,this.lowLevel&&e.z===this.lowLevel.z&&(this.lowReadyCount+=1,this.lowReadyCount>=this.lowTotalCount&&(this.lowFullyReady=!0))}catch(t){this.lastError=t instanceof Error?t.message:String(t),e.state="empty",e.failCount+=1,this.tilesFailedCount+=1;const i=Math.min(1e3*Math.pow(2,Math.max(0,e.failCount-1)),15e3);this.scheduleRetry(e,i)}finally{this.activeLoads-=1,e.priority==="high"?this.activeHighLoads=Math.max(0,this.activeHighLoads-1):this.activeLowLoads=Math.max(0,this.activeLowLoads-1),this.processQueue()}}scheduleRetry(e,t){e.retryTimer||(this.tilesRetryCount+=1,e.retryTimer=window.setTimeout(()=>{e.retryTimer=void 0,e.state==="empty"&&(e.priority==="low"?this.pendingLow.push(e):this.pendingHigh.push(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.processQueue())},t))}async fetchTileBitmap(e,t,i=12e3){try{const n=await Pt(e,{timeoutMs:i,priority:t});if(n)return n}catch{}const s=new AbortController,o=window.setTimeout(()=>s.abort(),i);try{const n={mode:"cors",cache:"default",referrerPolicy:"no-referrer",signal:s.signal};n.priority=t==="high"?"high":"low";const c=await fetch(e,n);if(!c.ok)throw new Error(`tile HTTP ${c.status}: ${e}`);const l=await c.blob();return await createImageBitmap(l)}finally{clearTimeout(o)}}hasHigherReadyTile(e,t,i){if(!this.highestLevel)return!1;const s=this.highestLevel.z;if(e>=s)return!1;const o=1<<s-e;for(let n=0;n<o;n++)for(let c=0;c<o;c++){const l=`${s}_${t*o+c}_${i*o+n}`,d=this.tilesMap.get(l);if(d&&d.state==="ready")return!0}return!1}async drawTile(e){var d,u;if(!this.manifest||!this.highestLevel||!this.ctx||!this.canvas)return;const t=this.manifest.levels.find(h=>h.z===e.z);if(!t||this.hasHigherReadyTile(e.z,e.col,e.row))return;const i=this.canvas.width/t.cols,s=this.canvas.height/t.rows,o=e.col*i,n=e.row*s;if(o<0||n<0||o+i>this.canvas.width||n+s>this.canvas.height){this.lastError=`tile out of canvas: z${e.z} ${e.col}_${e.row}`;return}const c=e.bitmap;if(c)this.ctx.drawImage(c,o,n,i,s);else{const h=e.url||`${this.manifest.baseUrl}/z${e.z}/${e.col}_${e.row}.jpg`,m=await de(h,{timeoutMs:12e3,retries:1,priority:e.priority});this.ctx.drawImage(m,o,n,i,s),(d=m.close)==null||d.call(m)}this.texture&&(this.texture.needsUpdate=!0),this.tilesVisible||(this.tilesVisible=!0,this.onFirstDraw());const l=(u=this.mesh)==null?void 0:u.material;l&&(l.opacity=1,l.needsUpdate=!0),this.highestLevel&&e.z===this.highestLevel.z&&!this.highReady&&(this.highReady=!0,this.onHighReady())}computeNeededTiles(e,t,i={}){const{yaw:s,pitch:o}=this.getViewAngles(e),n=N.degToRad(e.fov),c=N.degToRad(i.marginDeg??20),l=n/2+c,d=n*e.aspect/2+c,u=this.normAngle(s-d),h=this.normAngle(s+d),m=N.clamp(o-l,-Math.PI/2,Math.PI/2),f=N.clamp(o+l,-Math.PI/2,Math.PI/2),v=this.yawToCols(u,h,t.cols),w=this.yawToCols(s-1e-6,s+1e-6,t.cols)[0]??0;v.includes(w)||v.push(w);const p=Math.max(0,Math.floor((f*-1+Math.PI/2)/Math.PI*t.rows)),g=Math.min(t.rows-1,Math.floor((m*-1+Math.PI/2)/Math.PI*t.rows)),b=[];for(let I=p;I<=g;I++)b.push(I);const E=Math.min(t.rows-1,Math.max(0,Math.floor((-o+Math.PI/2)/Math.PI*t.rows)));b.includes(E)||b.push(E);const M=i.expandNeighbors!==!1,L=[...v];if(M)for(const I of v)L.push(((I+1)%t.cols+t.cols)%t.cols),L.push(((I-1)%t.cols+t.cols)%t.cols);const A=[...b];if(M)for(const I of b)I+1<t.rows&&A.push(I+1),I-1>=0&&A.push(I-1);const R=new Map,ge=(I,x)=>{const C=`${I}_${x}`,_=Math.abs(I-w),j=Math.min(_,t.cols-_),X=Math.abs(x-E),Q=j*j+X*X,fe=R.get(C);(!fe||Q<fe.rank)&&R.set(C,{col:I,row:x,rank:Q})};for(const I of L)for(const x of A)ge(I,x);return Array.from(R.values()).sort((I,x)=>I.rank!==x.rank?I.rank-x.rank:I.row!==x.row?I.row-x.row:I.col-x.col)}sortPendingHighQueue(){this.pendingHigh.length<2||this.pendingHigh.sort((e,t)=>{const i=e.priorityRank??Number.POSITIVE_INFINITY,s=t.priorityRank??Number.POSITIVE_INFINITY;return i!==s?i-s:t.lastUsed-e.lastUsed})}reprioritizeLowQueue(e){if(!this.lowLevel||this.pendingLow.length<2)return;const t=this.computeNeededTiles(e,this.lowLevel);if(t.length===0)return;const i=new Map;for(const o of t)i.set(`${o.col}_${o.row}`,o.rank);const s=new Map;this.pendingLow.forEach((o,n)=>s.set(o,n)),this.pendingLow.sort((o,n)=>{const c=i.get(`${o.col}_${o.row}`),l=i.get(`${n.col}_${n.row}`),d=c!==void 0,u=l!==void 0;return d&&u&&c!==l?c-l:d&&!u?-1:!d&&u?1:(s.get(o)??0)-(s.get(n)??0)})}seedHighPreload(e){if(this.prefetchSeeded||!this.manifest||!this.highestLevel)return;this.prefetchSeeded=!0;const{yaw:t,pitch:i}=this.getViewAngles(e),s=this.highestLevel,o=Math.PI*2/s.cols,n=Math.PI/s.rows,c=performance.now();for(let l=0;l<s.rows;l++){const d=Math.PI/2-(l+.5)*n,u=Math.abs(d-i);for(let h=0;h<s.cols;h++){const m=-Math.PI+(h+.5)*o,f=this.angularDistance(m,t),w=(f<=Math.PI/2?0:1)*1e6+Math.round(f*1e3)+Math.round(u*10),p=`${s.z}_${h}_${l}`;if(this.tilesMap.has(p))continue;const g={z:s.z,col:h,row:l,url:`${this.manifest.baseUrl}/z${s.z}/${h}_${l}.jpg`,state:"loading",priority:"high",priorityRank:w,lastUsed:c,failCount:0};this.tilesMap.set(p,g),this.pendingHigh.push(g)}}}yawToCols(e,t,i){const s=m=>(m%(Math.PI*2)+Math.PI*2)%(Math.PI*2),o=Math.PI,n=s(e+o),c=s(t+o),l=[],d=m=>{const f=(m%i+i)%i;l.includes(f)||l.push(f)},u=Math.floor(n/(Math.PI*2)*i),h=Math.floor(c/(Math.PI*2)*i);if(n<=c)for(let m=u;m<=h;m++)d(m);else{for(let m=u;m<i;m++)d(m);for(let m=0;m<=h;m++)d(m)}return l}normAngle(e){return(e+Math.PI)%(2*Math.PI)-Math.PI}angularDistance(e,t){return Math.abs(this.normAngle(e-t))}getViewAngles(e){const t=new H;return e.getWorldDirection(t),{yaw:-Math.atan2(t.x,t.z),pitch:Math.asin(t.y)}}runLru(e){var s,o;if(!this.highestLevel)return;const t=Array.from(this.tilesMap.values()).filter(n=>n.z===this.highestLevel.z&&n.state==="ready");if(t.length<=this.lruLimit)return;t.sort((n,c)=>n.lastUsed-c.lastUsed);const i=t.slice(0,t.length-this.lruLimit);for(const n of i)(o=(s=n.bitmap)==null?void 0:s.close)==null||o.call(s),n.bitmap=void 0,n.state="empty",this.tilesMap.delete(`${n.z}_${n.col}_${n.row}`)}}const B=class B{constructor(e,t,i,s){r(this,"manifest",null);r(this,"group",null);r(this,"pendingLow",[]);r(this,"pendingHigh",[]);r(this,"activeLoads",0);r(this,"activeLowLoads",0);r(this,"activeHighLoads",0);r(this,"maxConcurrent",6);r(this,"maxHighWhileLow",2);r(this,"defaultMaxConcurrent",6);r(this,"defaultMaxHighWhileLow",2);r(this,"lastUpdate",0);r(this,"tilesMap",new Map);r(this,"highestLevel",null);r(this,"lowLevel",null);r(this,"lowReadyCount",0);r(this,"lowTotalCount",0);r(this,"lowFullyReady",!1);r(this,"highSeeded",!1);r(this,"tilesVisible",!1);r(this,"tilesLoadedCount",0);r(this,"tilesLoadingCount",0);r(this,"tilesQueuedCount",0);r(this,"tilesFailedCount",0);r(this,"tilesRetryCount",0);r(this,"lastTileUrl","");r(this,"lastError","");r(this,"lruLimit",64);r(this,"highReady",!1);r(this,"fallbackVisible",!1);r(this,"useKtx2",!1);r(this,"ktx2Disabled",!1);r(this,"ktx2FailCount",0);r(this,"prefetchSeeded",!1);r(this,"ktx2Loader");this.scene=e,this.renderer=t,this.onFirstDraw=i,this.onHighReady=s,this.ktx2Loader=new ri,this.ktx2Loader.setTranscoderPath("/assets/basis/"),this.ktx2Loader.detectSupport(t),this.ktx2Loader.setWorkerLimit(2)}async load(e,t){if(this.manifest=e,this.useKtx2=e.tileFormat==="ktx2",this.ktx2Disabled=!1,this.ktx2FailCount=0,this.prefetchSeeded=!1,this.fallbackVisible=!!(t!=null&&t.fallbackVisible),this.highestLevel=e.levels.reduce((s,o)=>o.z>s.z?o:s),!this.highestLevel)throw new Error("manifest 缺少 level");this.lruLimit=Math.max(64,Math.min(this.highestLevel.cols*this.highestLevel.rows,256));const i=e.levels.filter(s=>s.z<this.highestLevel.z);if(this.lowLevel=i.length?i.reduce((s,o)=>o.z>s.z?o:s):null,this.lowReadyCount=0,this.lowTotalCount=this.lowLevel?this.lowLevel.cols*this.lowLevel.rows:0,this.lowFullyReady=this.lowTotalCount===0,this.highSeeded=!1,this.tilesVisible=!1,this.tilesLoadedCount=0,this.tilesLoadingCount=0,this.tilesQueuedCount=0,this.tilesFailedCount=0,this.tilesRetryCount=0,this.activeLoads=0,this.activeLowLoads=0,this.activeHighLoads=0,this.group&&this.scene.remove(this.group),this.group=new Jt,this.group.renderOrder=1,this.scene.add(this.group),!this.fallbackVisible){const s=e.levels.find(o=>o.z===0);if(!s)throw new Error("manifest 缺少 z0");await this.loadSingleTile(s.z,0,0,"low")}this.lowLevel&&this.enqueueLevel(this.lowLevel,"low")}setPerformanceMode(e){e==="throttle"?(this.maxConcurrent=2,this.maxHighWhileLow=0):(this.maxConcurrent=this.defaultMaxConcurrent,this.maxHighWhileLow=this.defaultMaxHighWhileLow)}dispose(){this.tilesMap.forEach(e=>{var t;(t=e.texture)==null||t.dispose(),e.mesh&&(e.mesh.geometry.dispose(),e.mesh.material.dispose())}),this.tilesMap.clear(),this.group&&(this.scene.remove(this.group),this.group=null),this.ktx2Loader.dispose()}update(e){if(!this.manifest||!this.highestLevel)return;const t=performance.now();if(t-this.lastUpdate<150)return;if(this.lastUpdate=t,(!this.lowLevel||this.lowFullyReady||this.highSeeded)&&this.highestLevel){const n=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});for(const{col:c,row:l,rank:d}of n){const u=`${this.highestLevel.z}_${c}_${l}`;let h=this.tilesMap.get(u);h||(h={z:this.highestLevel.z,col:c,row:l,url:this.buildTileUrl(this.highestLevel.z,c,l,this.useKtx2),state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(u,h)),h.priority="high",h.priorityRank=d,h.lastUsed=t,h.state==="empty"&&!h.retryTimer&&(h.state="loading",this.pendingHigh.push(h))}}const s=Array.from(this.tilesMap.values()).filter(n=>n.state==="loading").length,o=Array.from(this.tilesMap.values()).filter(n=>n.state==="ready").length;if(this.lowLevel&&!this.lowFullyReady){const n=Array.from(this.tilesMap.values()).filter(c=>c.z===this.lowLevel.z&&c.state==="loading").length;this.pendingLow.length===0&&n===0&&(this.lowFullyReady=!0)}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=s,this.tilesLoadedCount=o,this.processQueue(),this.runLru(t)}prime(e){if(!this.manifest||!this.highestLevel)return;e.updateMatrixWorld(!0);const t=performance.now();if(this.highestLevel&&!this.highSeeded){const i=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});if(i.length>0){for(const{col:s,row:o,rank:n}of i){const c=`${this.highestLevel.z}_${s}_${o}`;let l=this.tilesMap.get(c);l||(l={z:this.highestLevel.z,col:s,row:o,url:this.buildTileUrl(this.highestLevel.z,s,o,this.useKtx2),state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(c,l)),l.priority="high",l.priorityRank=n,l.lastUsed=t,l.state==="empty"&&!l.retryTimer&&(l.state="loading",this.pendingHigh.push(l))}this.highSeeded=!0}}this.reprioritizeLowQueue(e),this.seedHighPreload(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(i=>i.state==="loading").length,this.processQueue()}getStatus(){var e,t;return{tilesVisible:this.tilesVisible,fallbackVisible:this.fallbackVisible,tilesLoadedCount:this.tilesLoadedCount,tilesLoadingCount:this.tilesLoadingCount,tilesQueuedCount:this.tilesQueuedCount,tilesFailedCount:this.tilesFailedCount,tilesRetryCount:this.tilesRetryCount,lastTileUrl:this.lastTileUrl,lastError:this.lastError,canvasSize:"",canvasScale:1,maxLevel:this.highestLevel?`${this.highestLevel.cols}x${this.highestLevel.rows}`:"",highReady:this.highReady,zMax:((e=this.highestLevel)==null?void 0:e.z)??0,levels:this.manifest?this.manifest.levels.map(i=>i.z).join(","):"",lowReady:this.lowFullyReady,lowLevel:((t=this.lowLevel)==null?void 0:t.z)??""}}enqueueLevel(e,t){const i=performance.now();for(let s=0;s<e.rows;s++)for(let o=0;o<e.cols;o++){const n=`${e.z}_${o}_${s}`;let c=this.tilesMap.get(n);c||(c={z:e.z,col:o,row:s,url:this.buildTileUrl(e.z,o,s,this.useKtx2),state:"empty",priority:t,lastUsed:i,failCount:0},this.tilesMap.set(n,c)),c.priority=t,c.lastUsed=i,c.state==="empty"&&!c.retryTimer&&(c.state="loading",t==="low"?this.pendingLow.push(c):this.pendingHigh.push(c))}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(s=>s.state==="loading").length,this.processQueue()}processQueue(){for(this.sortPendingHighQueue();this.activeLoads<this.maxConcurrent&&(this.pendingLow.length>0||this.pendingHigh.length>0);){const e=this.pendingLow.length>0,i=this.pendingHigh.length>0&&(!e||this.activeHighLoads<this.maxHighWhileLow)?this.pendingHigh.shift():this.pendingLow.shift();this.loadTile(i)}}async loadTile(e){(e.failCount===void 0||e.failCount===null)&&(e.failCount=0),e.priority||(e.priority="high"),this.activeLoads+=1,e.priority==="high"?this.activeHighLoads+=1:this.activeLowLoads+=1,this.lastTileUrl=e.url;try{const t=await this.fetchTileTexture(e);e.texture=t,e.state="ready",e.failCount=0,e.retryTimer&&(clearTimeout(e.retryTimer),e.retryTimer=void 0),this.drawTile(e),this.tilesLoadedCount+=1,this.lowLevel&&e.z===this.lowLevel.z&&(this.lowReadyCount+=1,this.lowReadyCount>=this.lowTotalCount&&(this.lowFullyReady=!0))}catch(t){this.lastError=t instanceof Error?t.message:String(t),e.state="empty",e.failCount+=1,this.tilesFailedCount+=1;const i=Math.min(1e3*Math.pow(2,Math.max(0,e.failCount-1)),15e3);this.scheduleRetry(e,i)}finally{this.activeLoads-=1,e.priority==="high"?this.activeHighLoads=Math.max(0,this.activeHighLoads-1):this.activeLowLoads=Math.max(0,this.activeLowLoads-1),this.processQueue()}}scheduleRetry(e,t){e.retryTimer||(this.tilesRetryCount+=1,e.retryTimer=window.setTimeout(()=>{e.retryTimer=void 0,e.state==="empty"&&(e.priority==="low"?this.pendingLow.push(e):this.pendingHigh.push(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.processQueue())},t))}async fetchTileTexture(e){const t=`${this.manifest.baseUrl}/z${e.z}/${e.col}_${e.row}`,i=`${t}.ktx2`,s=`${t}.jpg`;if(this.useKtx2&&!this.ktx2Disabled)try{const n=await this.loadKtx2Texture(i,e.priority);return n.name=i,this.ktx2FailCount=0,n}catch(n){this.recordKtx2Failure(n)}const o=await this.loadJpgTexture(s,e.priority);return o.name=s,o}async loadKtx2Texture(e,t){const i={mode:"cors",cache:"default",referrerPolicy:"no-referrer"};i.priority=t==="high"?"high":"low";const s=await fetch(e,i);if(!s.ok)throw new Error(`tile HTTP ${s.status}: ${e}`);const o=await s.arrayBuffer(),n=await this.ktx2Loader._createTexture(o);return n.flipY=!1,"colorSpace"in n?n.colorSpace=ae:n.encoding=be,n.needsUpdate=!0,n}async loadJpgTexture(e,t){let i=null;try{i=await Pt(e,{timeoutMs:12e3,priority:t})}catch{i=null}i||(i=await de(e,{timeoutMs:12e3,retries:1,allowFetchFallback:!0,priority:t}));const s=new ei(i);return s.flipY=!1,s.wrapS=D,s.wrapT=D,s.minFilter=me,s.magFilter=me,s.generateMipmaps=!1,"colorSpace"in s?s.colorSpace=ae:s.encoding=be,s.needsUpdate=!0,s}async loadSingleTile(e,t,i,s){const o={z:e,col:t,row:i,url:this.buildTileUrl(e,t,i,this.useKtx2),state:"loading",priority:s,lastUsed:performance.now(),failCount:0};this.tilesMap.set(`${e}_${t}_${i}`,o),await this.loadTile(o)}drawTile(e){if(!this.manifest||!this.group||!e.texture)return;const t=this.manifest.levels.find(n=>n.z===e.z);if(!t)return;const i=this.buildTileGeometry(t,e.col,e.row),s=new se({map:e.texture,depthWrite:!0,depthTest:!0});s.toneMapped=!1;const o=new ne(i,s);o.renderOrder=e.priority==="high"?3:2,o.frustumCulled=!1,e.mesh=o,this.group.add(o),this.tilesVisible||(this.tilesVisible=!0,this.onFirstDraw()),this.highestLevel&&e.z===this.highestLevel.z&&!this.highReady&&(this.highReady=!0,this.onHighReady()),this.pruneCoveredAncestors(e.z,e.col,e.row)}pruneCoveredAncestors(e,t,i){if(e<=0)return;const s=e-1,o=Math.floor(t/2),n=Math.floor(i/2);if(!this.areDirectChildrenReady(s,o,n))return;const c=`${s}_${o}_${n}`,l=this.tilesMap.get(c);l!=null&&l.mesh&&(this.disposeTileMesh(l),l.mesh=void 0,l.texture=void 0,this.pruneCoveredAncestors(s,o,n))}areDirectChildrenReady(e,t,i){const s=e+1;for(let o=0;o<2;o+=1)for(let n=0;n<2;n+=1){const c=`${s}_${t*2+n}_${i*2+o}`,l=this.tilesMap.get(c);if(!l||l.state!=="ready"||!l.mesh)return!1}return!0}disposeTileMesh(e){var i;if(!e.mesh)return;(i=e.mesh.parent)==null||i.remove(e.mesh),e.mesh.geometry.dispose();const t=e.mesh.material;t.map&&t.map===e.texture&&t.map.dispose(),t.dispose()}buildTileGeometry(e,t,i){const o=Math.PI*2/e.cols,n=Math.PI/e.rows,c=t*o,l=i*n,d=Math.max(4,Math.round(64/e.cols)),u=Math.max(4,Math.round(32/e.rows)),h=new Qe(500,d,u,c,o,l,n);h.scale(-1,1,1);const m=h.attributes.uv;let f=1/0,v=-1/0,w=1/0,p=-1/0;for(let E=0;E<m.count;E+=1){const M=m.getX(E),L=m.getY(E);M<f&&(f=M),M>v&&(v=M),L<w&&(w=L),L>p&&(p=L)}const g=v-f||1,b=p-w||1;for(let E=0;E<m.count;E+=1){const M=m.getX(E),L=m.getY(E),A=(M-f)/g,R=(L-w)/b;m.setXY(E,A,1-R)}return m.needsUpdate=!0,h}buildTileUrl(e,t,i,s){const o=s?"ktx2":"jpg";return`${this.manifest.baseUrl}/z${e}/${t}_${i}.${o}`}computeNeededTiles(e,t,i={}){const{yaw:s,pitch:o}=this.getViewAngles(e),n=N.degToRad(e.fov),c=N.degToRad(i.marginDeg??20),l=n/2+c,d=n*e.aspect/2+c,u=this.normAngle(s-d),h=this.normAngle(s+d),m=N.clamp(o-l,-Math.PI/2,Math.PI/2),f=N.clamp(o+l,-Math.PI/2,Math.PI/2),v=this.yawToCols(u,h,t.cols),w=this.yawToCols(s-1e-6,s+1e-6,t.cols)[0]??0;v.includes(w)||v.push(w);const p=Math.max(0,Math.floor((f*-1+Math.PI/2)/Math.PI*t.rows)),g=Math.min(t.rows-1,Math.floor((m*-1+Math.PI/2)/Math.PI*t.rows)),b=[];for(let I=p;I<=g;I++)b.push(I);const E=Math.min(t.rows-1,Math.max(0,Math.floor((-o+Math.PI/2)/Math.PI*t.rows)));b.includes(E)||b.push(E);const M=i.expandNeighbors!==!1,L=[...v];if(M)for(const I of v)L.push(((I+1)%t.cols+t.cols)%t.cols),L.push(((I-1)%t.cols+t.cols)%t.cols);const A=[...b];if(M)for(const I of b)I+1<t.rows&&A.push(I+1),I-1>=0&&A.push(I-1);const R=new Map,ge=(I,x)=>{const C=`${I}_${x}`,_=Math.abs(I-w),j=Math.min(_,t.cols-_),X=Math.abs(x-E),Q=j*j+X*X,fe=R.get(C);(!fe||Q<fe.rank)&&R.set(C,{col:I,row:x,rank:Q})};for(const I of L)for(const x of A)ge(I,x);return Array.from(R.values()).sort((I,x)=>I.rank!==x.rank?I.rank-x.rank:I.row!==x.row?I.row-x.row:I.col-x.col)}sortPendingHighQueue(){this.pendingHigh.length<2||this.pendingHigh.sort((e,t)=>{const i=e.priorityRank??Number.POSITIVE_INFINITY,s=t.priorityRank??Number.POSITIVE_INFINITY;return i!==s?i-s:t.lastUsed-e.lastUsed})}reprioritizeLowQueue(e){if(!this.lowLevel||this.pendingLow.length<2)return;const t=this.computeNeededTiles(e,this.lowLevel);if(t.length===0)return;const i=new Map;for(const o of t)i.set(`${o.col}_${o.row}`,o.rank);const s=new Map;this.pendingLow.forEach((o,n)=>s.set(o,n)),this.pendingLow.sort((o,n)=>{const c=i.get(`${o.col}_${o.row}`),l=i.get(`${n.col}_${n.row}`),d=c!==void 0,u=l!==void 0;return d&&u&&c!==l?c-l:d&&!u?-1:!d&&u?1:(s.get(o)??0)-(s.get(n)??0)})}seedHighPreload(e){if(this.prefetchSeeded||!this.manifest||!this.highestLevel)return;this.prefetchSeeded=!0;const{yaw:t,pitch:i}=this.getViewAngles(e),s=this.highestLevel,o=Math.PI*2/s.cols,n=Math.PI/s.rows,c=performance.now();for(let l=0;l<s.rows;l++){const d=Math.PI/2-(l+.5)*n,u=Math.abs(d-i);for(let h=0;h<s.cols;h++){const m=(h+.5)*o,f=this.normAngle(Math.PI/2-m),v=this.angularDistance(f,t),p=(v<=Math.PI/2?0:1)*1e6+Math.round(v*1e3)+Math.round(u*10),g=`${s.z}_${h}_${l}`;if(this.tilesMap.has(g))continue;const b={z:s.z,col:h,row:l,url:this.buildTileUrl(s.z,h,l,this.useKtx2&&!this.ktx2Disabled),state:"loading",priority:"high",priorityRank:p,lastUsed:c,failCount:0};this.tilesMap.set(g,b),this.pendingHigh.push(b)}}}recordKtx2Failure(e){const t=e instanceof Error?e.message:String(e);this.lastError=t;const i=t.match(/HTTP\s+(\d+)/i);if(i){const s=Number(i[1]);if(s===404||s===403||s===410)return}this.ktx2FailCount+=1,this.ktx2Disabled||(this.ktx2Disabled=!0,this.useKtx2=!1,this.lastError=`ktx2 disabled: ${t}`)}yawToCols(e,t,i){const s=u=>(u%B.TWO_PI+B.TWO_PI)%B.TWO_PI,o=s(e+Math.PI);let c=s(t+Math.PI)-o;c<0&&(c+=B.TWO_PI);const l=Math.max(i*4,16),d=new Set;for(let u=0;u<=l;u+=1){const h=s(o+c*u/l)-Math.PI,m=s(Math.PI/2-h),f=Math.floor(m/B.TWO_PI*i)%i;d.add((f+i)%i)}return Array.from(d)}normAngle(e){return(e+Math.PI)%(2*Math.PI)-Math.PI}angularDistance(e,t){return Math.abs(this.normAngle(e-t))}getViewAngles(e){const t=new H;return e.getWorldDirection(t),{yaw:-Math.atan2(t.x,t.z),pitch:Math.asin(t.y)}}runLru(e){var s,o;if(!this.highestLevel)return;const t=Array.from(this.tilesMap.values()).filter(n=>n.z===this.highestLevel.z&&n.state==="ready");if(t.length<=this.lruLimit)return;t.sort((n,c)=>n.lastUsed-c.lastUsed);const i=t.slice(0,t.length-this.lruLimit);for(const n of i)(s=n.texture)==null||s.dispose(),n.mesh&&(n.mesh.geometry.dispose(),n.mesh.material.dispose(),(o=this.group)==null||o.remove(n.mesh)),this.tilesMap.delete(`${n.z}_${n.col}_${n.row}`)}};r(B,"TWO_PI",Math.PI*2);let qe=B;function es(a,e){var i;const t=a.trim();if(!t||t.startsWith("/")||t.startsWith("//")||/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(t))return t;try{const s=new URL(t,e),o=typeof window<"u"&&((i=window.location)!=null&&i.origin)?window.location.origin:typeof location<"u"?location.origin:"";return o&&s.origin===o?`${s.pathname}${s.search}${s.hash}`:s.toString()}catch{return t}}async function ts(a){const e={cache:"default"};e.priority="high";const t=await fetch(a,e);if(!t.ok)throw new Error(`manifest 加载失败: ${a}`);const i=await t.json();return i.tileFormat||(i.tileFormat="jpg"),i.baseUrl=Y(es(i.baseUrl,a),O.PANO),i}const le={original:{renderer:{pixelRatio:Math.min(window.devicePixelRatio||1,2),toneMapping:ni,toneMappingExposure:1,output:"srgb",clearColor:void 0},camera:{defaultFov:75},texture:{anisotropyLimit:8,minFilter:st,magFilter:me,generateMipmaps:!0,colorSpace:"srgb"}},enhanced:{renderer:{pixelRatio:Math.min(window.devicePixelRatio,2),toneMapping:si,toneMappingExposure:.95,output:"srgb",clearColor:{color:0,alpha:1}},camera:{defaultFov:70},texture:{anisotropyLimit:12,minFilter:st,magFilter:me,generateMipmaps:!0,colorSpace:"srgb"}}};class is{constructor(e,t=!1){r(this,"scene");r(this,"camera");r(this,"renderer");r(this,"sphere",null);r(this,"tilePano",null);r(this,"fallbackSphere",null);r(this,"container");r(this,"frameListeners",[]);r(this,"nadirPatch",null);r(this,"compassDisk",null);r(this,"groundNavDots",null);r(this,"groundHeading",null);r(this,"renderProfile","enhanced");r(this,"isDragging",!1);r(this,"lastMouseX",0);r(this,"lastMouseY",0);r(this,"yaw",0);r(this,"pitch",0);r(this,"fov",75);r(this,"onLoadCallback");r(this,"onErrorCallback");r(this,"onStatusChangeCallback");r(this,"debugMode",!1);r(this,"onDebugClick");r(this,"longPressTimer",null);r(this,"tilesDebugEl",null);r(this,"tilesVisibleStableFrames",0);r(this,"tilesLastError","");r(this,"tilesLowReady",!1);r(this,"tilesLastLoadedCount",0);r(this,"tilesLastProgressAt",0);r(this,"tilesHighStartAt",0);r(this,"tilesDegradedNotified",!1);r(this,"longPressThreshold",500);r(this,"renderSource","none");r(this,"perfSamples",[]);r(this,"perfMode","normal");r(this,"perfLastChangeAt",0);r(this,"renderSwitchReason","");r(this,"clearedCount",0);r(this,"aspectWarnedUrls",new Set);r(this,"metrics",{sceneId:"",startAt:0,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:"normal",renderSource:"none",lastError:""});r(this,"lastMetricsEmitAt",0);r(this,"loadStatus",S.LOADING_LOW);r(this,"isDegradedMode",!1);r(this,"pickMode",!1);r(this,"pickModeListeners",[]);r(this,"pickStartX",0);r(this,"pickStartY",0);r(this,"pickStartTime",0);r(this,"pickHasMoved",!1);r(this,"pickDragThreshold",8);r(this,"pickTimeThreshold",250);r(this,"lastYaw",0);r(this,"lastPitch",0);r(this,"lastFov",75);r(this,"isViewChanging",!1);r(this,"viewChangeThreshold",.5);r(this,"vrModeEnabled",!1);r(this,"touchStartX",0);r(this,"touchStartY",0);r(this,"lastTouchDistance",0);r(this,"isPinching",!1);r(this,"lastFrameTimeMs",null);this.container=e,this.debugMode=t,this.renderProfile=this.detectRenderProfile(),this.scene=new ti,this.camera=new ii(le[this.renderProfile].camera.defaultFov,e.clientWidth/e.clientHeight,.1,1e3),this.camera.position.set(0,0,0),this.fov=le[this.renderProfile].camera.defaultFov,this.renderer=new oi({antialias:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.applyRendererProfile(),e.appendChild(this.renderer.domElement),this.nadirPatch=new Oi(this.scene,500),this.compassDisk=new Fi,this.compassDisk.mount(e),this.compassDisk.getElement().style.display="none",this.groundNavDots=new Wi({museumId:"",currentSceneId:"",sceneHotspots:[]}),this.groundNavDots.mount(e),this.groundNavDots.getElement().style.display="none",this.groundHeading=new qi(e),this.groundHeading.getElement().style.display="none",this.setupEvents(),this.animate(),window.addEventListener("resize",()=>this.handleResize())}setupEvents(){const e=this.renderer.domElement;if(e.addEventListener("mousedown",t=>this.onPointerDown(t)),e.addEventListener("mousemove",t=>this.onPointerMove(t)),e.addEventListener("mouseup",()=>this.onPointerUp()),e.addEventListener("mouseleave",()=>this.onPointerUp()),e.addEventListener("touchstart",t=>this.onTouchStart(t),{passive:!1}),e.addEventListener("touchmove",t=>this.onTouchMove(t),{passive:!1}),e.addEventListener("touchend",()=>this.onTouchEnd()),e.addEventListener("wheel",t=>this.onWheel(t),{passive:!1}),this.debugMode){e.addEventListener("dblclick",s=>this.handleDebugClick(s.clientX,s.clientY));let t=0,i=0;e.addEventListener("touchstart",s=>{s.touches.length===1&&(t=s.touches[0].clientX,i=s.touches[0].clientY,this.longPressTimer=window.setTimeout(()=>{this.handleDebugClick(t,i)},this.longPressThreshold))},{passive:!0}),e.addEventListener("touchmove",()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},{passive:!0}),e.addEventListener("touchend",()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},{passive:!0})}}handleDebugClick(e,t){if(this.onDebugClick&&this.debugMode){const i=this.getCurrentView();this.onDebugClick(e,t,i.yaw,i.pitch,i.fov)}}setOnDebugClick(e){this.onDebugClick=e}onPointerDown(e){this.isDragging=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,k.emitInteracting()}onPointerMove(e){if(!this.isDragging)return;const t=e.clientX-this.lastMouseX,i=e.clientY-this.lastMouseY;if(this.yaw+=t*.5,this.pitch+=i*.5,this.pitch=Math.max(-90,Math.min(90,this.pitch)),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,this.updateCamera(),this.debugMode&&this.onDebugClick){const s=this.getCurrentView();this.onDebugClick(this.lastMouseX,this.lastMouseY,s.yaw,s.pitch,s.fov)}}onPointerUp(){this.isDragging=!1}onTouchStart(e){if(e.touches.length===1)this.isDragging=!0,this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY,this.lastMouseX=this.touchStartX,this.lastMouseY=this.touchStartY,k.emitInteracting();else if(e.touches.length===2){this.isPinching=!0,this.isDragging=!1;const t=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY;this.lastTouchDistance=Math.sqrt(t*t+i*i),k.emitInteracting()}}onTouchMove(e){if(e.preventDefault(),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),e.touches.length===1&&this.isDragging){const t=e.touches[0].clientX-this.lastMouseX,i=e.touches[0].clientY-this.lastMouseY;this.yaw+=t*.5,this.pitch+=i*.5,this.pitch=Math.max(-90,Math.min(90,this.pitch)),this.lastMouseX=e.touches[0].clientX,this.lastMouseY=e.touches[0].clientY,this.updateCamera()}else if(e.touches.length===2&&this.isPinching){const t=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY,s=Math.sqrt(t*t+i*i),o=this.lastTouchDistance-s,n=this.fov+o*.5;this.setFovInternal(n),this.lastTouchDistance=s}}onTouchEnd(){this.isDragging=!1,this.isPinching=!1}onWheel(e){e.preventDefault();const t=this.fov+e.deltaY*.1;if(this.setFovInternal(t),k.emitInteracting(),this.debugMode&&this.onDebugClick){const i=this.getCurrentView();this.onDebugClick(this.lastMouseX,this.lastMouseY,i.yaw,i.pitch,i.fov)}}updateCamera(){const e=N.degToRad(this.yaw),t=N.degToRad(this.pitch),i=Math.cos(t)*Math.sin(e),s=Math.sin(t),o=Math.cos(t)*Math.cos(e);this.camera.lookAt(i,s,o)}loadScene(e,t){var h;if(this.isDegradedMode=!1,this.resetMetrics(e.id),this.updateLoadStatus(S.LOADING_LOW),this.renderSource="none",this.clearedCount=0,this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const m=this.sphere.material;m.map&&m.map.dispose(),m.dispose()}if(!((t==null?void 0:t.preserveView)===!0)){const m=e.initialView,f=m.yaw||0;this.yaw===0&&f!==0&&(this.yaw=-f),this.pitch=m.pitch||0;const v=le[this.renderProfile];this.fov=m.fov!==void 0?m.fov:v.camera.defaultFov,this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),this.updateCamera()}this.lastYaw=this.yaw,this.lastPitch=this.pitch,this.lastFov=this.fov,this.isViewChanging=!1;const o=-(typeof e.northYaw=="number"?e.northYaw:((h=e.initialView)==null?void 0:h.yaw)??0);this.nadirPatch&&this.nadirPatch.setNorthYaw(o),this.compassDisk&&(this.compassDisk.setSceneId(e.id),this.compassDisk.setNorthYaw(o)),this.groundHeading&&this.groundHeading.setNorthYaw(o);const n=new Qe(500,64,64);n.scale(-1,1,1);const c=e.panoTiles;if(c!=null&&c.manifest){const m=Y(c.manifest,O.PANO),f=c.fallbackPanoLow||e.panoLow,v=c.fallbackPano||e.pano,w=!!(f||v);this.tilesVisibleStableFrames=0,this.tilesLastError="",this.tilesLowReady=!1,this.tilesLastLoadedCount=0,this.tilesLastProgressAt=performance.now(),this.tilesHighStartAt=0,this.tilesDegradedNotified=!1,f?this.showFallbackTexture(Y(f,O.PANO_LOW),n,!0):v&&this.showFallbackTexture(Y(v,O.PANO),n,!1);const p=()=>{this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(S.LOW_READY),this.setRenderSource("low","tiles 首屏可见"),this.onLoadCallback&&this.onLoadCallback()),this.loadStatus!==S.HIGH_READY&&this.updateLoadStatus(S.LOADING_HIGH)},g=()=>{this.updateLoadStatus(S.HIGH_READY),this.setRenderSource("tiles","tiles 高清可见"),this.isDegradedMode=!1};ts(m).then(b=>(this.tilePano=b.tileFormat==="ktx2"?new qe(this.scene,this.renderer,p,g):new Ji(this.scene,p,g,this.renderer.capabilities.maxTextureSize||0),this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode(this.perfMode),this.tilePano.load(b,{fallbackVisible:w}))).then(()=>{var b;this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(S.LOW_READY),this.onLoadCallback&&this.onLoadCallback()),(b=this.tilePano)==null||b.prime(this.camera)}).catch(b=>{console.error("瓦片加载失败，回退传统全景",b),this.tilesLastError=b instanceof Error?b.message:String(b),U("瓦片加载失败，已回退到全景图",2e3),this.fallbackToLegacy(e,c)});return}const l=Y(e.panoLow,O.PANO_LOW),d=Y(e.pano,O.PANO);if(ze()==="low"){if(l){this.loadSingleTexture(n,l,!0);return}if(d){this.loadSingleTexture(n,d,!1);return}}else{if(!l&&d){this.loadSingleTexture(n,d,!1);return}if(l&&!d){this.loadSingleTexture(n,l,!0);return}if(l&&d){this.loadProgressiveTextures(n,l,d);return}}this.updateLoadStatus(S.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("场景未提供全景图 URL"))}async loadSingleTexture(e,t,i){i?this.updateLoadStatus(S.LOADING_LOW):this.updateLoadStatus(S.LOADING_HIGH);try{const s=await de(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY"}),o=new W(s);this.applyTextureSettings(o),this.warnIfNotPanoAspect(o,t),o.flipY=!1,o.wrapS=D,o.wrapT=D,o.needsUpdate=!0;const n=new se({map:o});this.sphere=new ne(e,n),this.scene.add(this.sphere),this.setRenderSource(i?"low":"tiles",i?"panoLow 可见":"pano 可见"),i?this.updateLoadStatus(S.LOW_READY):this.updateLoadStatus(S.HIGH_READY),this.onLoadCallback&&this.onLoadCallback()}catch(s){if(console.error("加载全景图失败",t,s),this.updateLoadStatus(S.ERROR),this.onErrorCallback){const o=s instanceof q?`加载全景图失败：${t} - ${s.message}`:`加载全景图失败：${t}`;this.onErrorCallback(new Error(o))}}}async loadProgressiveTextures(e,t,i){this.updateLoadStatus(S.LOADING_LOW);try{const s=await de(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY"}),o=new W(s);this.applyTextureSettings(o),this.warnIfNotPanoAspect(o,t),o.flipY=!1,o.wrapS=D,o.wrapT=D,o.needsUpdate=!0;const n=new se({map:o});this.sphere=new ne(e,n),this.scene.add(this.sphere),this.setRenderSource("low","panoLow 可见"),this.updateLoadStatus(S.LOW_READY),this.onLoadCallback&&this.onLoadCallback(),this.updateLoadStatus(S.LOADING_HIGH);try{const c=await de(i,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"low",imageOrientation:"flipY"}),l=new W(c);this.applyTextureSettings(l),this.warnIfNotPanoAspect(l,i),l.flipY=!1,l.wrapS=D,l.wrapT=D,l.needsUpdate=!0;const d=this.getCurrentView();if(this.sphere&&this.sphere.material&&"map"in this.sphere.material){const u=this.sphere.material;u.map&&u.map.dispose(),u.map=l,u.needsUpdate=!0,this.setRenderSource("tiles","pano 高清可见")}this.setView(d.yaw,d.pitch,d.fov),this.updateLoadStatus(S.HIGH_READY),this.isDegradedMode=!1}catch(c){console.error("高清全景图加载失败，继续使用低清",i,c),this.isDegradedMode=!0,this.updateLoadStatus(S.DEGRADED)}}catch(s){console.error("低清全景图加载失败，尝试加载高清兜底",t,s),await this.loadSingleTexture(e,i,!1)}}setOnLoad(e){this.onLoadCallback=e}setOnError(e){this.onErrorCallback=e}setOnStatusChange(e){this.onStatusChangeCallback=e}getLoadStatus(){return this.loadStatus}resetMetrics(e){const t=performance.now();this.metrics={sceneId:e,startAt:t,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:this.perfMode,renderSource:this.renderSource,lastError:""},this.emitMetrics("reset",!0)}emitMetrics(e,t=!1){var f;const i=performance.now();if(!t&&i-this.lastMetricsEmitAt<800)return;const s=(f=this.tilePano)==null?void 0:f.getStatus(),o=(s==null?void 0:s.tilesLoadedCount)??0,n=(s==null?void 0:s.tilesFailedCount)??0,c=(s==null?void 0:s.tilesRetryCount)??0,l=o+n,d=l>0?Number((o/l*100).toFixed(2)):0;this.metrics.tilesLoaded=o,this.metrics.tilesFailed=n,this.metrics.tilesRetries=c,this.metrics.tileHitRate=d,this.metrics.perfMode=this.perfMode,this.metrics.renderSource=this.renderSource,this.metrics.lastError=this.tilesLastError||((s==null?void 0:s.lastError)??"");const u=this.metrics.lowReadyAt?Math.round(this.metrics.lowReadyAt-this.metrics.startAt):-1,h=this.metrics.highReadyAt?Math.round(this.metrics.highReadyAt-this.metrics.startAt):-1,m={...this.metrics,lowReadyMs:u,highReadyMs:h,reason:e,at:Math.round(i)};window.__VR_METRICS__=m,window.dispatchEvent(new CustomEvent("vr:metrics",{detail:m})),this.lastMetricsEmitAt=i}isInDegradedMode(){return this.isDegradedMode}updateLoadStatus(e){if(this.loadStatus===e)return;this.loadStatus=e;const t=performance.now();e===S.LOW_READY&&this.metrics.lowReadyAt===0&&(this.metrics.lowReadyAt=t),e===S.HIGH_READY&&this.metrics.highReadyAt===0&&(this.metrics.highReadyAt=t),this.onStatusChangeCallback&&this.onStatusChangeCallback(e),this.emitMetrics(`status:${e}`)}getCurrentView(){return{yaw:this.yaw,pitch:this.pitch,fov:this.fov}}setView(e,t,i){this.yaw=e,this.pitch=Math.max(-90,Math.min(90,t)),i!==void 0&&this.setFovInternal(i,!1),this.updateCamera()}setFovInternal(e,t=!0){if(this.fov=Math.max(30,Math.min(120,e)),this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),t){const i=le[this.renderProfile].camera.defaultFov,s=Math.round(i/this.fov*100),o=Math.max(50,Math.min(250,s));We.show(o)}}setFov(e){this.setFovInternal(e,!0)}setVrModeEnabled(e){this.vrModeEnabled=e,e||(this.isDragging=!1)}isVrModeEnabled(){return this.vrModeEnabled}isInteracting(){return this.isDragging||this.isPinching}handleResize(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}updatePerformanceGuard(e){const t=1e3/Math.max(1,e);this.perfSamples.push(t),this.perfSamples.length>30&&this.perfSamples.shift();const i=this.perfSamples.reduce((o,n)=>o+n,0)/this.perfSamples.length,s=performance.now();i<28&&this.perfMode==="normal"&&s-this.perfLastChangeAt>2e3&&(this.perfMode="throttle",this.perfLastChangeAt=s,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("throttle"),this.emitMetrics("perf:throttle",!0)),i>45&&this.perfMode==="throttle"&&s-this.perfLastChangeAt>3e3&&(this.perfMode="normal",this.perfLastChangeAt=s,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("normal"),this.emitMetrics("perf:normal",!0))}updateTilesDebug(){var E;const e=new URLSearchParams(window.location.search);if(!(e.get("tilesDebug")==="1"||e.get("tilesDebug")==="true"||e.get("tilesDebug")==="on")){this.tilesDebugEl&&(this.tilesDebugEl.remove(),this.tilesDebugEl=null);return}if(!this.tilesDebugEl){const M=document.createElement("div");M.style.position="absolute",M.style.left="8px",M.style.top="8px",M.style.padding="6px 8px",M.style.background="rgba(0,0,0,0.55)",M.style.color="#fff",M.style.fontSize="12px",M.style.lineHeight="1.4",M.style.borderRadius="6px",M.style.zIndex="9999",M.style.pointerEvents="none",this.tilesDebugEl=M,this.container.appendChild(M)}const i=(E=this.tilePano)==null?void 0:E.getStatus(),s=this.tilePano?"tiles":"fallback",o=i!=null&&i.tilesVisible?"true":"false",n=(i==null?void 0:i.tilesLoadedCount)??0,c=(i==null?void 0:i.tilesLoadingCount)??0,l=(i==null?void 0:i.tilesQueuedCount)??0,d=(i==null?void 0:i.lastTileUrl)??"",u=this.tilesLastError||(i==null?void 0:i.lastError)||"",h=this.fallbackSphere?"true":"false",m=(i==null?void 0:i.canvasSize)??"",f=(i==null?void 0:i.maxLevel)??"",v=i!=null&&i.highReady?"true":"false",w=(i==null?void 0:i.levels)??"",p=this.renderSource,g=this.renderSwitchReason,b=this.clearedCount;this.tilesDebugEl.textContent=`mode=${s}
renderSource=${p}
switchReason=${g}
cleared=${b}
fallbackVisible=${h}
tilesVisible=${o}
tilesLoaded=${n}
tilesLoading=${c}
tilesQueued=${l}
lastTileUrl=${d}
lastError=${u}
canvas=${m} zMax=${f} levels=${w} highReady=${v}
lowReady=${this.tilesLowReady}`}animate(){requestAnimationFrame(()=>this.animate());const e=performance.now(),t=this.lastFrameTimeMs?e-this.lastFrameTimeMs:16.7;this.updatePerformanceGuard(t),this.lastFrameTimeMs=e;const i=this.getCurrentView(),s=Math.abs(i.yaw-this.lastYaw),o=Math.abs(i.pitch-this.lastPitch),n=Math.abs(i.fov-this.lastFov);if(s>this.viewChangeThreshold||o>this.viewChangeThreshold||n>this.viewChangeThreshold?this.isViewChanging||(this.isViewChanging=!0,k.emitInteracting()):this.isViewChanging&&(this.isViewChanging=!1,k.scheduleIdle()),this.lastYaw=i.yaw,this.lastPitch=i.pitch,this.lastFov=i.fov,this.updateCamera(),this.tilePano){this.tilePano.update(this.camera);const l=this.tilePano.getStatus(),d=!!this.fallbackSphere,u=l.tilesVisible,h=l.lowReady;d&&u&&h?(this.tilesVisibleStableFrames+=1,this.tilesVisibleStableFrames>=2&&this.clearFallback()):this.tilesVisibleStableFrames=0,!d&&!u&&this.noteCleared("无可见源"),u&&this.renderSource==="fallback"&&this.tilesLowReady&&this.setRenderSource("low","tiles 低清覆盖可见"),u&&l.highReady&&this.setRenderSource("tiles","tiles 高清可见"),l.lastError&&(this.tilesLastError=l.lastError),!this.tilesLowReady&&l.tilesLoadedCount>0&&(this.tilesLowReady=!0,this.updateLoadStatus(S.LOW_READY)),l.highReady&&(this.updateLoadStatus(S.HIGH_READY),this.isDegradedMode=!1,this.tilesDegradedNotified=!1),l.tilesLoadedCount>this.tilesLastLoadedCount&&(this.tilesLastLoadedCount=l.tilesLoadedCount,this.tilesLastProgressAt=e,this.tilesDegradedNotified&&!l.highReady&&(this.tilesDegradedNotified=!1)),this.tilesHighStartAt===0&&(l.tilesQueuedCount>0||l.tilesLoadingCount>0)&&(this.tilesHighStartAt=e,this.tilesLastProgressAt===0&&(this.tilesLastProgressAt=e)),this.tilesHighStartAt>0&&e-this.tilesLastProgressAt>12e3&&!l.highReady&&!this.tilesDegradedNotified&&this.tilesLowReady&&(this.isDegradedMode=!0,this.updateLoadStatus(S.DEGRADED),this.tilesDegradedNotified=!0)}this.updateTilesDebug(),this.emitMetrics("frame"),this.nadirPatch&&this.nadirPatch.update(this.camera,{yaw:i.yaw,pitch:i.pitch},t),this.compassDisk&&this.compassDisk.setYawPitch(i.yaw,i.pitch),this.groundNavDots&&this.groundNavDots.setYawPitch(i.yaw,i.pitch),this.groundHeading&&this.groundHeading.setYawPitch(i.yaw,i.pitch);for(const l of this.frameListeners)l(t);this.renderer.render(this.scene,this.camera)}onFrame(e){return this.frameListeners.push(e),()=>{const t=this.frameListeners.indexOf(e);t>=0&&this.frameListeners.splice(t,1)}}getCamera(){return this.camera}getDomElement(){return this.renderer.domElement}setSceneData(e,t,i){if(this.groundNavDots){const s=i.filter(o=>{var n;return o.type==="scene"&&((n=o.target)==null?void 0:n.sceneId)}).map(o=>({id:o.id,label:o.label,yaw:o.yaw,pitch:o.pitch,target:{museumId:o.target.museumId,sceneId:o.target.sceneId}}));this.groundNavDots.updateScene(e,t,s)}}getSphereRadius(){return 500}getViewportSize(){return{width:this.container.clientWidth,height:this.container.clientHeight}}enablePickMode(){this.pickMode||(this.pickMode=!0,this.setupPickModeListeners())}disablePickMode(){this.pickMode&&(this.pickMode=!1,this.removePickModeListeners())}togglePickMode(){return this.pickMode?this.disablePickMode():this.enablePickMode(),this.pickMode}isPickModeEnabled(){return this.pickMode}setupPickModeListeners(){const e=this.renderer.domElement,t=o=>{if(!this.pickMode)return;let n,c;if(o instanceof TouchEvent){if(o.touches.length!==1)return;n=o.touches[0].clientX,c=o.touches[0].clientY}else n=o.clientX,c=o.clientY;this.pickStartX=n,this.pickStartY=c,this.pickStartTime=Date.now(),this.pickHasMoved=!1},i=o=>{if(!this.pickMode)return;let n,c;if(o instanceof TouchEvent){if(o.touches.length!==1)return;n=o.touches[0].clientX,c=o.touches[0].clientY}else n=o.clientX,c=o.clientY;const l=Math.abs(n-this.pickStartX),d=Math.abs(c-this.pickStartY);Math.sqrt(l*l+d*d)>this.pickDragThreshold&&(this.pickHasMoved=!0)},s=o=>{if(!this.pickMode)return;let n,c;if(o instanceof TouchEvent){if(o.changedTouches.length!==1)return;n=o.changedTouches[0].clientX,c=o.changedTouches[0].clientY}else n=o.clientX,c=o.clientY;const l=Date.now()-this.pickStartTime,d=Math.abs(n-this.pickStartX),u=Math.abs(c-this.pickStartY);Math.sqrt(d*d+u*u)>this.pickDragThreshold||l>this.pickTimeThreshold&&this.pickHasMoved||this.handlePick(n,c),this.pickHasMoved=!1};e.addEventListener("pointerdown",t),e.addEventListener("mousedown",t),e.addEventListener("touchstart",t,{passive:!0}),e.addEventListener("pointermove",i),e.addEventListener("mousemove",i),e.addEventListener("touchmove",i,{passive:!0}),e.addEventListener("pointerup",s),e.addEventListener("mouseup",s),e.addEventListener("touchend",s,{passive:!0}),this.pickModeListeners.push(()=>{e.removeEventListener("pointerdown",t),e.removeEventListener("mousedown",t),e.removeEventListener("touchstart",t),e.removeEventListener("pointermove",i),e.removeEventListener("mousemove",i),e.removeEventListener("touchmove",i),e.removeEventListener("pointerup",s),e.removeEventListener("mouseup",s),e.removeEventListener("touchend",s)})}removePickModeListeners(){this.pickModeListeners.forEach(e=>e()),this.pickModeListeners=[]}handlePick(e,t){const i=this.renderer.domElement.getBoundingClientRect(),s=Hi(e,t,i),o=Ui(s.x,s.y,this.camera,this.getSphereRadius());if(!o){typeof __VR_DEBUG__<"u"&&__VR_DEBUG__&&console.debug("[pick] 无法计算 yaw/pitch（ray.direction 为空）");return}const{yaw:n,pitch:c}=o,l=`yaw: ${n.toFixed(2)}, pitch: ${c.toFixed(2)}`;console.log(`[pick] yaw=${n.toFixed(2)}, pitch=${c.toFixed(2)}`),navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(l).catch(()=>{}),window.dispatchEvent(new CustomEvent("vr:pick",{detail:{x:e,y:t,yaw:n,pitch:c}}))}warnIfNotPanoAspect(e,t){if(!e.image)return;const i=e.image,s=i.width,o=i.height;if(!s||!o)return;const n=s/o;Math.abs(n-2)>.02&&!this.aspectWarnedUrls.has(t)&&(console.warn(`[PanoViewer] 全景图比例不是 2:1，可能出现轻微变形（实际 ${n.toFixed(2)}），来源: ${t}`),this.aspectWarnedUrls.add(t))}dispose(){if(this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const e=this.sphere.material;e.map&&e.map.dispose(),e.dispose()}this.nadirPatch&&(this.nadirPatch.dispose(this.scene),this.nadirPatch=null),this.compassDisk&&(this.compassDisk.dispose(),this.compassDisk=null),this.groundNavDots&&(this.groundNavDots.dispose(),this.groundNavDots=null),this.groundHeading&&(this.groundHeading.dispose(),this.groundHeading=null),this.renderer.dispose(),window.removeEventListener("resize",()=>this.handleResize())}applyRendererProfile(){const e=le[this.renderProfile];this.renderer.setPixelRatio(e.renderer.pixelRatio),"outputColorSpace"in this.renderer?this.renderer.outputColorSpace=ae:this.renderer.outputEncoding=be,this.renderer.toneMapping=e.renderer.toneMapping,this.renderer.toneMappingExposure=e.renderer.toneMappingExposure,e.renderer.clearColor&&this.renderer.setClearColor(e.renderer.clearColor.color,e.renderer.clearColor.alpha)}detectRenderProfile(){try{const t=new URLSearchParams(window.location.search).get("render");if(t&&t.toLowerCase()==="original")return"original"}catch{}return"enhanced"}fallbackToLegacy(e,t){const i={...e,pano:(t==null?void 0:t.fallbackPano)??e.pano,panoLow:(t==null?void 0:t.fallbackPanoLow)??e.panoLow,panoTiles:void 0};i.pano||i.panoLow?(U("瓦片加载失败，已回退到全景图",2e3),this.setRenderSource("fallback","tiles 失败自动回退"),this.loadScene(i,{preserveView:!0})):(this.updateLoadStatus(S.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("瓦片与全景资源均不可用")))}setRenderSource(e,t){(this.renderSource!==e||t)&&(this.renderSource=e,this.renderSwitchReason=t)}noteCleared(e){this.clearedCount+=1,this.renderSwitchReason=e}async showFallbackTexture(e,t,i){try{const s=await de(e,{timeoutMs:15e3,retries:1,allowFetchFallback:!0,priority:"high",imageOrientation:"flipY"}),o=new W(s);this.applyTextureSettings(o),o.flipY=!1,o.wrapS=D,o.wrapT=D,o.needsUpdate=!0;const n=new se({map:o,depthWrite:!1,depthTest:!1}),c=new ne(t.clone(),n);c.renderOrder=0,this.fallbackSphere=c,this.scene.add(c),this.updateLoadStatus(i?S.LOW_READY:S.HIGH_READY),this.setRenderSource("fallback",i?"fallback 低清可见":"fallback 高清可见"),i&&(this.tilesLowReady=!0),this.onLoadCallback&&this.onLoadCallback()}catch(s){console.error("fallback 贴图加载失败",s)}}clearFallback(){if(this.fallbackSphere){this.fallbackSphere.geometry&&this.fallbackSphere.geometry.dispose();const e=this.fallbackSphere.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.fallbackSphere),this.fallbackSphere=null}}applyTextureSettings(e){const t=le[this.renderProfile],i=this.renderer.capabilities.getMaxAnisotropy?this.renderer.capabilities.getMaxAnisotropy():1;if(e.anisotropy=Math.min(t.texture.anisotropyLimit,Math.max(1,i||1)),e.minFilter=t.texture.minFilter,e.magFilter=t.texture.magFilter,e.generateMipmaps=t.texture.generateMipmaps,"colorSpace"in e?e.colorSpace=ae:e.encoding=be,e.needsUpdate=!0,this.debugMode){const s=e.image||{};console.log("pano texture",{w:s.width,h:s.height,colorSpace:e.colorSpace,encoding:e.encoding,anisotropy:e.anisotropy,minFilter:e.minFilter,magFilter:e.magFilter})}}}class vt{constructor(e){r(this,"element");this.element=document.createElement("div"),this.element.className="title-bar",this.element.innerHTML=`
      <div class="title-bar-content">
        <span class="title-text">${e}</span>
      </div>
    `,this.applyStyles()}applyStyles(){const e=document.createElement("style");e.textContent=`
      .title-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        padding-top: env(safe-area-inset-top, 0px);
        height: calc(44px + env(safe-area-inset-top, 0px));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .title-bar-content {
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 60px;
      }
      .title-text {
        font-size: 16px;
        font-weight: 500;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    `,document.head.appendChild(e)}setTitle(e){const t=this.element.querySelector(".title-text");t&&(t.textContent=e)}getElement(){return this.element}remove(){this.element.remove()}}class ss{constructor(e){r(this,"element");r(this,"museums");this.museums=e,this.element=document.createElement("div"),this.element.className="museum-list",this.render(),this.applyStyles()}render(){const e=this.museums.filter(i=>i.id==="wangding"),t=this.museums.filter(i=>i.id!=="wangding");this.element.innerHTML=`
      <div class="museum-list-container">
        <h1 class="museum-list-title">王鼎纪念馆</h1>
        <p class="museum-list-subtitle">以王鼎生平为主线的红色研学展馆</p>
        <div class="museum-grid">
          ${e.map(i=>`
            <div class="museum-card museum-card-active" data-museum-id="${i.id}">
              <div class="museum-cover">
                <img src="${i.cover}" alt="${i.name}" loading="lazy">
                <div class="museum-overlay">
                  <h2 class="museum-name">${i.name}</h2>
                  ${i.description?`<p class="museum-desc">${i.description}</p>`:""}
                  <p class="museum-scene-count">${i.scenes.length} 个场景</p>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
        ${t.length>0?`
        <div class="museum-grid muted">
          ${t.map(i=>`
            <div class="museum-card museum-card-disabled">
              <div class="museum-cover">
                <img src="${i.cover}" alt="${i.name}" loading="lazy">
                <div class="museum-overlay">
                  <h2 class="museum-name">${i.name}</h2>
                  <p class="museum-desc">建设中，敬请期待</p>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
        `:""}
      </div>
    `,this.element.querySelectorAll(".museum-card-active").forEach(i=>{i.addEventListener("click",()=>{const s=i.getAttribute("data-museum-id");s&&Fe(s)})})}applyStyles(){const e=document.createElement("style");e.textContent=`
      .museum-list {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding-top: calc(44px + env(safe-area-inset-top, 0px));
      }
      .museum-list-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .museum-list-title {
        font-size: 28px;
        font-weight: 600;
        color: #fff;
        text-align: center;
        margin-bottom: 30px;
      }
      .museum-list-subtitle {
        font-size: 16px;
        color: rgba(255,255,255,0.9);
        text-align: center;
        margin-top: -12px;
        margin-bottom: 24px;
      }
      .museum-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }
      .museum-grid.muted {
        opacity: 0.7;
      }
      .museum-card {
        cursor: pointer;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .museum-card-disabled {
        cursor: not-allowed;
        filter: grayscale(0.3);
      }
      .museum-card:active {
        transform: scale(0.98);
      }
      .museum-card-disabled:active {
        transform: none;
      }
      .museum-cover {
        position: relative;
        width: 100%;
        padding-top: 60%;
        overflow: hidden;
      }
      .museum-cover img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .museum-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        padding: 20px;
        color: #fff;
      }
      .museum-name {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 5px;
      }
      .museum-desc {
        font-size: 14px;
        margin: 6px 0;
        line-height: 1.5;
      }
      .museum-scene-count {
        font-size: 14px;
        opacity: 0.9;
      }
    `,document.head.appendChild(e)}getElement(){return this.element}remove(){this.element.remove()}}function ns(a,e){const t=N.degToRad(a),i=N.degToRad(e),s=Math.cos(i)*Math.sin(t),o=Math.sin(i),n=Math.cos(i)*Math.cos(t);return new H(s,o,n)}function os(a,e,t){const i=new H,s=new H;if(e.getWorldPosition(i),e.getWorldDirection(s),new H().copy(a).sub(i).dot(s)<=0)return{x:0,y:0,visible:!1};const n=new H().copy(a).project(e);if(!(n.x>=-1&&n.x<=1&&n.y>=-1&&n.y<=1&&n.z>=-1&&n.z<=1))return{x:0,y:0,visible:!1};const l=t.clientWidth,d=t.clientHeight,u=(n.x+1)*.5*l,h=(1-(n.y+1)*.5)*d;return{x:u,y:h,visible:!0}}function as(a,e,t,i,s=500){const n=ns(a,e).clone().multiplyScalar(s);return os(n,t,i)}function rs(){return`
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" />
  <path d="M16.2 16.2 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
</svg>`}function ls(){return`
<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M9 7.5v9l8-4.5-8-4.5Z"/>
</svg>`}function cs(a){const e=document.createElement("div");return e.className="hotspot-tooltip",e.textContent=a||"",e.setAttribute("role","tooltip"),e}function Me(a,e){const t=document.createElement("div");return t.className=`hotspot-icon-circle${e?` ${e}`:""}`,t.innerHTML=a,t}function hs(){return`
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 4v16M12 4l6 6M12 4l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`}function ds(a){const e=cs(a.tooltip),t=a.isGround??!1;let i="hotspot hotspot--unknown",s=document.createElement("div");s.className="hotspot-dot";const o=a.type;if(t){i="hotspot hotspot--ground";const n=document.createElement("div");n.className="hotspot-ground-ring",s=n}else o==="scene"?(i="hotspot hotspot--scene",s=Me(hs(),"hotspot-icon hotspot-icon-arrow")):o==="image"?(i="hotspot hotspot--image",s=Me(rs(),"hotspot-icon")):o==="info"?(i="hotspot hotspot--info",s=Me('<span class="hotspot-info-text">i</span>',"hotspot-icon")):o==="video"&&(i="hotspot hotspot--video",s=Me(ls(),"hotspot-icon hotspot-icon-play"));return{rootClassName:i,contentEl:s,tooltipEl:e}}class us{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"options");this.options=e;const t=document.createElement("div");t.className="vr-modal vr-modal--media vr-modal--image";const i=document.createElement("div");i.className="vr-modal-mask",i.addEventListener("click",()=>this.handleClose());const s=document.createElement("div");s.className="vr-modal-card vr-modal-card--media vr-modal-card--image",s.addEventListener("click",u=>u.stopPropagation());const o=document.createElement("div");o.className="vr-modal-header";const n=document.createElement("div");n.className="vr-modal-title",n.textContent=e.title||"图片预览";const c=document.createElement("button");c.className="vr-btn vr-modal-close-icon",c.setAttribute("aria-label","关闭"),c.textContent="×",c.addEventListener("click",()=>this.handleClose()),o.appendChild(n),o.appendChild(c);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--image";const d=document.createElement("img");d.className="vr-modal-image",e.src&&(d.src=e.src),d.alt=e.title||"热点图片",d.loading="lazy",l.appendChild(d),s.appendChild(o),s.appendChild(l),t.appendChild(i),t.appendChild(s),this.element=t}handleClose(){var e,t;this.close(),(t=(e=this.options).onClose)==null||t.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class ms{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"options");this.options=e;const t=document.createElement("div");t.className="vr-modal vr-modal--info";const i=document.createElement("div");i.className="vr-modal-mask",i.addEventListener("click",()=>this.handleClose());const s=document.createElement("div");s.className="vr-modal-card vr-modal-card--info",s.addEventListener("click",d=>d.stopPropagation());const o=document.createElement("div");o.className="vr-modal-header";const n=document.createElement("div");n.className="vr-modal-title",n.textContent=e.title||"详情";const c=document.createElement("button");c.className="vr-btn vr-modal-close-icon",c.setAttribute("aria-label","关闭"),c.textContent="×",c.addEventListener("click",()=>this.handleClose()),o.appendChild(n),o.appendChild(c);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--info",l.textContent=e.text||"未配置内容",s.appendChild(o),s.appendChild(l),t.appendChild(i),t.appendChild(s),this.element=t}handleClose(){var e,t;this.close(),(t=(e=this.options).onClose)==null||t.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class ps{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"videoEl");r(this,"options");this.options=e;const t=document.createElement("div");t.className="vr-modal vr-modal--media vr-modal--video";const i=document.createElement("div");i.className="vr-modal-mask",i.addEventListener("click",()=>this.handleClose());const s=document.createElement("div");s.className="vr-modal-card vr-modal-card--media vr-modal-card--video",s.addEventListener("click",u=>u.stopPropagation());const o=document.createElement("div");o.className="vr-modal-header";const n=document.createElement("div");n.className="vr-modal-title",n.textContent=e.title||"视频";const c=document.createElement("button");c.className="vr-btn vr-modal-close-icon",c.setAttribute("aria-label","关闭"),c.textContent="×",c.addEventListener("click",()=>this.handleClose()),o.appendChild(n),o.appendChild(c);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--video";const d=document.createElement("video");d.className="vr-modal-video",e.src&&(d.src=e.src),e.poster&&(d.poster=e.poster),d.controls=!0,d.playsInline=!0,d.preload="metadata",this.videoEl=d,l.appendChild(d),s.appendChild(o),s.appendChild(l),t.appendChild(i),t.appendChild(s),this.element=t}handleClose(){var e,t;this.close(),(t=(e=this.options).onClose)==null||t.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){if(this.isOpen){this.isOpen=!1,this.element.classList.remove("open");try{this.videoEl.pause(),this.videoEl.currentTime=0,this.videoEl.removeAttribute("src"),this.videoEl.load()}catch{}}}getElement(){return this.element}destroy(){this.close(),this.element.remove()}}const At="vr:open-modal",_t="vr:close-modal";function tt(a){window.dispatchEvent(new CustomEvent(At,{detail:a}))}function He(){window.dispatchEvent(new CustomEvent(_t))}class gs{constructor(e){r(this,"rootEl");r(this,"current",null);r(this,"handleKeyDownBound");this.rootEl=e,this.handleKeyDownBound=t=>this.handleKeyDown(t),window.addEventListener(At,t=>{const i=t;this.handleOpen(i.detail)}),window.addEventListener(_t,()=>this.close()),window.addEventListener("keydown",this.handleKeyDownBound)}handleKeyDown(e){e.key==="Escape"&&this.close()}handleOpen(e){this.close();let t=null;e.type==="image"?t=new us({src:e.payload.src,title:e.payload.title,onClose:()=>He()}):e.type==="info"?t=new ms({title:e.payload.title,text:e.payload.text,onClose:()=>He()}):e.type==="video"&&(t=new ps({src:e.payload.src,poster:e.payload.poster,title:e.payload.title,onClose:()=>He()})),t&&(this.current=t,this.rootEl.innerHTML="",this.rootEl.appendChild(t.getElement()),t.open())}close(){this.current&&(this.current.close(),this.current.destroy(),this.current=null,this.rootEl.innerHTML="")}}let wt=null;function Dt(){if(wt)return;let a=document.getElementById("vr-modal-root");a||(a=document.createElement("div"),a.id="vr-modal-root",document.body.appendChild(a)),wt=new gs(a)}class _e{constructor(e){r(this,"data");r(this,"el");r(this,"contentEl");r(this,"tooltipEl");r(this,"labelEl",null);r(this,"worldPos");r(this,"radius",500);r(this,"tooltipTimer",null);var n,c;this.data=e,this.el=document.createElement("div");const t=e.pitch<-20,i=ds({id:e.id,type:e.type,tooltip:e.tooltip,isGround:t});if(this.el.className=i.rootClassName,t&&this.el.classList.add("hotspot--ground"),this.el.setAttribute("data-hotspot-id",e.id),this.el.setAttribute("data-hotspot-type",e.type),this.el.style.pointerEvents="auto",this.el.style.position="absolute",this.el.style.left="0",this.el.style.top="0",this.contentEl=i.contentEl,this.tooltipEl=i.tooltipEl,e.label){const l=document.createElement("div");l.className="hotspot-label",l.textContent=e.label,l.setAttribute("aria-hidden","true"),this.labelEl=l}this.el.appendChild(this.contentEl),this.el.appendChild(this.tooltipEl),this.labelEl&&this.el.appendChild(this.labelEl),(((c=(n=window.matchMedia)==null?void 0:n.call(window,"(hover: hover) and (pointer: fine)"))==null?void 0:c.matches)??!1)&&(this.el.addEventListener("mouseenter",()=>this.showTooltip()),this.el.addEventListener("mouseleave",()=>this.hideTooltip())),this.el.addEventListener("pointerdown",l=>{l.stopPropagation(),this.el.classList.add("is-pressed")});const o=()=>this.el.classList.remove("is-pressed");this.el.addEventListener("pointerup",o),this.el.addEventListener("pointercancel",o),this.el.addEventListener("pointerleave",o)}getElement(){return this.el}getData(){return this.data}updateScreenPosition(e,t){const i=as(this.data.yaw,this.data.pitch,e,t,this.radius);if(!i.visible){this.el.style.display="none",this.el.style.opacity="0";return}this.el.style.display="",this.el.style.opacity="1",this.el.style.setProperty("--hs-x",`${i.x}px`),this.el.style.setProperty("--hs-y",`${i.y}px`),this.el.style.transform=`translate3d(${i.x}px, ${i.y}px, 0) translate(-50%, -50%)`}showTooltip(e){this.data.tooltip&&(this.tooltipEl.classList.add("show"),this.tooltipTimer&&(window.clearTimeout(this.tooltipTimer),this.tooltipTimer=null),e&&e>0&&(this.tooltipTimer=window.setTimeout(()=>this.hideTooltip(),e)))}hideTooltip(){this.tooltipEl.classList.remove("show"),this.tooltipTimer&&(window.clearTimeout(this.tooltipTimer),this.tooltipTimer=null)}}class fs extends _e{onClick(){console.log("[hotspot] scene click",{id:this.data.id,targetSceneId:this.data.targetSceneId})}}class vs extends _e{onClick(){if(!this.data.imageUrl){console.warn("[hotspot] image click but no src configured",this.data),U("未配置内容",1500);return}tt({type:"image",payload:{src:this.data.imageUrl,title:this.data.title||this.data.tooltip}})}}class ws extends _e{onClick(){if(!!!(this.data.text||this.data.title||this.data.tooltip)){console.warn("[hotspot] info click but no text/title configured",this.data),U("未配置内容",1500);return}tt({type:"info",payload:{title:this.data.title||this.data.tooltip,text:this.data.text}})}}class ys extends _e{onClick(){if(!this.data.url){console.warn("[hotspot] video click but no src/url configured",this.data),U("未配置内容",1500);return}tt({type:"video",payload:{src:this.data.url,poster:this.data.poster,title:this.data.title||this.data.tooltip}})}}class bs{constructor(e,t,i={}){r(this,"element");r(this,"viewer");r(this,"disposeFrameListener",null);r(this,"hotspotInstances",[]);r(this,"options");r(this,"unsubscribeFocus",null);r(this,"hoveredSceneId",null);this.viewer=e,this.options=i,this.element=document.createElement("div"),this.element.className="hotspots-container",this.element.style.pointerEvents="none",this.updateHotspots(t);const s=this.viewer.getDomElement();this.disposeFrameListener=this.viewer.onFrame(()=>{const o=this.viewer.getCamera();for(const n of this.hotspotInstances)n.updateScreenPosition(o,s)}),this.unsubscribeFocus=St(o=>{this.handleSceneFocus(o)})}handleSceneFocus(e){if(e.type==="hover"&&e.source!=="pano"){if(this.options.museumId&&e.museumId!==this.options.museumId)return;const t=e.sceneId;this.hoveredSceneId!==t&&(this.hoveredSceneId&&this.setHotspotHighlight(this.hoveredSceneId,!1),this.hoveredSceneId=t,t&&this.setHotspotHighlight(t,!0))}}setHotspotHighlight(e,t){this.hotspotInstances.forEach(i=>{const s=i.getData();if(s.type==="scene"&&s.targetSceneId===e){const n=i.getElement();t?n.classList.add("hotspot--external-hover"):n.classList.remove("hotspot--external-hover")}})}updateHotspots(e){var s,o;this.hotspotInstances=[],this.element.innerHTML="";const t=((o=(s=window.matchMedia)==null?void 0:s.call(window,"(hover: none) and (pointer: coarse)"))==null?void 0:o.matches)??!1,i=n=>{var c,l,d,u,h,m,f,v;if(n.type==="scene"){const w=(c=n.target)==null?void 0:c.sceneId,p=w?(d=(l=this.options).resolveSceneName)==null?void 0:d.call(l,w):void 0,g=`进入：${p||n.label||w||"未知场景"}`;return new fs({id:n.id,type:"scene",yaw:n.yaw,pitch:n.pitch,label:n.label||p||w,tooltip:g,targetSceneId:w})}if(n.type==="video"){const w=((u=n.target)==null?void 0:u.url)||n.src,p=((h=n.target)==null?void 0:h.poster)||n.poster,g=n.title||n.label;return new ys({id:n.id,type:"video",yaw:n.yaw,pitch:n.pitch,label:n.label,tooltip:g,url:w,poster:p,title:g})}if(n.type==="image"){const w=((m=n.target)==null?void 0:m.imageUrl)||((f=n.target)==null?void 0:f.url)||n.src,p=n.title||n.label;return new vs({id:n.id,type:"image",yaw:n.yaw,pitch:n.pitch,label:n.label,tooltip:p,imageUrl:w,title:p})}if(n.type==="info"){const w=n.title||n.label,p=((v=n.target)==null?void 0:v.text)||n.text;return new ws({id:n.id,type:"info",yaw:n.yaw,pitch:n.pitch,label:n.label,tooltip:w,text:p,title:w})}return null};for(const n of e){const c=i(n);c&&(c.getElement().addEventListener("click",l=>{var h,m;l.preventDefault(),l.stopPropagation();const d=c.getData(),u=d.type==="scene";if(t&&c.showTooltip(1200),u){const f=d.targetSceneId;if(f&&this.options.onEnterScene){U(`进入 ${((m=(h=this.options).resolveSceneName)==null?void 0:m.call(h,f))||f}`,1e3),this.options.onEnterScene(f);return}}c.onClick()}),this.hotspotInstances.push(c),this.element.appendChild(c.getElement()))}}getElement(){return this.element}remove(){this.disposeFrameListener&&(this.disposeFrameListener(),this.disposeFrameListener=null),this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=null),this.element.remove()}}class Es{constructor(){r(this,"element");r(this,"videoElement");r(this,"isOpen",!1);this.element=document.createElement("div"),this.element.className="video-player-overlay",this.videoElement=document.createElement("video"),this.videoElement.controls=!0,this.videoElement.playsInline=!0,this.render(),this.applyStyles()}render(){this.element.innerHTML=`
      <div class="video-player-backdrop"></div>
      <div class="video-player-content">
        <button class="video-player-close">×</button>
        <div class="video-container"></div>
      </div>
    `;const e=this.element.querySelector(".video-container");e&&e.appendChild(this.videoElement);const t=this.element.querySelector(".video-player-backdrop"),i=this.element.querySelector(".video-player-close");t==null||t.addEventListener("click",()=>this.close()),i==null||i.addEventListener("click",()=>this.close())}play(e){const t=Y(e,O.VIDEO);if(!t){console.error("视频 URL 为空");return}this.videoElement.src=t,this.videoElement.load(),this.open(),this.videoElement.play().catch(i=>{console.warn("自动播放失败，需要用户交互:",i)})}open(){this.isOpen=!0,this.element.classList.add("open"),document.body.style.overflow="hidden"}close(){this.isOpen=!1,this.element.classList.remove("open"),this.videoElement.pause(),this.videoElement.src="",document.body.style.overflow=""}applyStyles(){const e=document.createElement("style");e.textContent=`
      .video-player-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 3000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .video-player-overlay.open {
        pointer-events: all;
        opacity: 1;
      }
      .video-player-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
      }
      .video-player-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90vw;
        max-width: 800px;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
      }
      .video-player-close {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        font-size: 24px;
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        z-index: 10;
        backdrop-filter: blur(10px);
      }
      .video-container {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
      }
      .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
    `,document.head.appendChild(e)}getElement(){return this.element}remove(){this.element.remove()}}class Is{constructor(){r(this,"element");this.element=document.createElement("div"),this.element.className="loading-overlay",this.render(),this.applyStyles();const e=()=>{Ee()&&this.hide()};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}render(){this.element.innerHTML=`
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">加载中...</p>
      </div>
    `}applyStyles(){const e=document.createElement("style");e.textContent=`
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .loading-overlay.show {
        opacity: 1;
        pointer-events: all;
      }
      .loading-spinner {
        text-align: center;
        color: #fff;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }
      .loading-text {
        font-size: 14px;
        margin: 0;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    `,document.head.appendChild(e)}show(){Ee()||this.element.classList.add("show")}hide(){this.element.classList.remove("show")}getElement(){return this.element}remove(){this.element.remove()}}const Ms={[y.INVALID_ROOT]:"配置格式错误",[y.MISSING_APP_NAME]:"缺少应用名称",[y.MUSEUMS_NOT_ARRAY]:"博物馆列表格式错误",[y.MUSEUMS_EMPTY]:"博物馆列表为空",[y.MISSING_MUSEUM_ID]:"缺少博物馆 ID",[y.DUPLICATE_MUSEUM_ID]:"博物馆 ID 重复",[y.MISSING_MUSEUM_NAME]:"缺少博物馆名称",[y.MISSING_MUSEUM_COVER]:"缺少封面图",[y.MISSING_MUSEUM_MAP]:"缺少地图配置",[y.MISSING_MAP_IMAGE]:"缺少地图图片",[y.INVALID_MAP_WIDTH]:"地图宽度无效",[y.INVALID_MAP_HEIGHT]:"地图高度无效",[y.SCENES_NOT_ARRAY]:"场景列表格式错误",[y.SCENES_EMPTY]:"场景列表为空",[y.MISSING_SCENE_ID]:"缺少场景 ID",[y.DUPLICATE_SCENE_ID]:"场景 ID 重复",[y.MISSING_SCENE_NAME]:"缺少场景名称",[y.MISSING_PANO]:"缺少全景图",[y.INVALID_PANO_URL]:"高清全景图 URL 无效",[y.INVALID_PANOLOW_URL]:"低清全景图 URL 无效",[y.MISSING_THUMB]:"缺少缩略图",[y.MISSING_INITIAL_VIEW]:"缺少初始视角配置",[y.INVALID_YAW]:"水平角度无效",[y.INVALID_PITCH]:"垂直角度无效",[y.INVALID_FOV]:"视野角度无效",[y.MISSING_MAP_POINT]:"缺少地图点位",[y.INVALID_MAP_POINT_X]:"地图点位 X 坐标无效",[y.INVALID_MAP_POINT_Y]:"地图点位 Y 坐标无效",[y.HOTSPOTS_NOT_ARRAY]:"热点列表格式错误",[y.MISSING_HOTSPOT_ID]:"缺少热点 ID",[y.DUPLICATE_HOTSPOT_ID]:"热点 ID 重复",[y.INVALID_HOTSPOT_TYPE]:"热点类型无效",[y.MISSING_HOTSPOT_LABEL]:"缺少热点标签",[y.INVALID_HOTSPOT_YAW]:"热点水平角度无效",[y.INVALID_HOTSPOT_PITCH]:"热点垂直角度无效",[y.MISSING_HOTSPOT_TARGET]:"缺少热点目标配置",[y.MISSING_TARGET_MUSEUM_ID]:"缺少目标博物馆 ID",[y.MISSING_TARGET_SCENE_ID]:"缺少目标场景 ID",[y.INVALID_TARGET_YAW]:"目标水平角度无效",[y.INVALID_TARGET_PITCH]:"目标垂直角度无效",[y.INVALID_TARGET_FOV]:"目标视野角度无效",[y.MISSING_TARGET_URL]:"缺少视频链接"},Ss={[y.INVALID_ROOT]:"请确保 config.json 是一个有效的 JSON 对象",[y.MISSING_APP_NAME]:'请在配置中添加 "appName" 字段，例如："appName": "我的 VR 展馆"',[y.MUSEUMS_NOT_ARRAY]:'请确保 "museums" 是一个数组，例如："museums": []',[y.MUSEUMS_EMPTY]:'请至少添加一个博物馆到 "museums" 数组中',[y.MISSING_MUSEUM_ID]:'请为该博物馆添加 "id" 字段，例如："id": "museum1"',[y.DUPLICATE_MUSEUM_ID]:'请确保每个博物馆的 "id" 都是唯一的，不能重复',[y.MISSING_MUSEUM_NAME]:'请为该博物馆添加 "name" 字段，例如："name": "第一展馆"',[y.MISSING_MUSEUM_COVER]:'请为该博物馆添加 "cover" 字段，填入封面图的 URL',[y.MISSING_MUSEUM_MAP]:'请为该博物馆添加 "map" 对象配置',[y.MISSING_MAP_IMAGE]:'请在地图配置中添加 "image" 字段，填入地图图片的 URL',[y.INVALID_MAP_WIDTH]:'请确保 "map.width" 是一个大于 0 的数字',[y.INVALID_MAP_HEIGHT]:'请确保 "map.height" 是一个大于 0 的数字',[y.SCENES_NOT_ARRAY]:'请确保 "scenes" 是一个数组，例如："scenes": []',[y.SCENES_EMPTY]:"请至少为该博物馆添加一个场景",[y.MISSING_SCENE_ID]:'请为该场景添加 "id" 字段，例如："id": "scene1"',[y.DUPLICATE_SCENE_ID]:'请确保同一博物馆内每个场景的 "id" 都是唯一的',[y.MISSING_SCENE_NAME]:'请为该场景添加 "name" 字段，例如："name": "正门"',[y.MISSING_PANO]:'请为该场景添加 "pano"、"panoLow" 或 "panoTiles" 字段，至少提供一种全景来源',[y.INVALID_PANO_URL]:'请确保 "pano" 字段是一个有效的图片 URL 字符串',[y.INVALID_PANOLOW_URL]:'请确保 "panoLow" 字段是一个有效的图片 URL 字符串',[y.MISSING_THUMB]:'请为该场景添加 "thumb" 字段，填入缩略图的 URL',[y.MISSING_INITIAL_VIEW]:'请为该场景添加 "initialView" 对象配置',[y.INVALID_YAW]:'请确保 "initialView.yaw" 是一个数字（水平角度，范围 -180 到 180）',[y.INVALID_PITCH]:'请确保 "initialView.pitch" 是一个数字（垂直角度，范围 -90 到 90）',[y.INVALID_FOV]:'请确保 "initialView.fov" 是一个数字（视野角度，范围 30 到 120）',[y.MISSING_MAP_POINT]:'请为该场景添加 "mapPoint" 对象配置',[y.INVALID_MAP_POINT_X]:'请确保 "mapPoint.x" 是一个数字（地图上的 X 坐标）',[y.INVALID_MAP_POINT_Y]:'请确保 "mapPoint.y" 是一个数字（地图上的 Y 坐标）',[y.HOTSPOTS_NOT_ARRAY]:'请确保 "hotspots" 是一个数组，例如："hotspots": []',[y.MISSING_HOTSPOT_ID]:'请为该热点添加 "id" 字段，例如："id": "hotspot1"',[y.DUPLICATE_HOTSPOT_ID]:'请确保同一场景内每个热点的 "id" 都是唯一的',[y.INVALID_HOTSPOT_TYPE]:'请确保 "type" 字段是 "scene" 或 "video" 之一',[y.MISSING_HOTSPOT_LABEL]:'请为该热点添加 "label" 字段，例如："label": "进入展厅"',[y.INVALID_HOTSPOT_YAW]:'请确保 "yaw" 是一个数字（热点在全景图中的水平位置）',[y.INVALID_HOTSPOT_PITCH]:'请确保 "pitch" 是一个数字（热点在全景图中的垂直位置）',[y.MISSING_HOTSPOT_TARGET]:'请为该热点添加 "target" 对象配置',[y.MISSING_TARGET_MUSEUM_ID]:'场景跳转类型的热点必须包含 "target.museumId" 字段',[y.MISSING_TARGET_SCENE_ID]:'场景跳转类型的热点必须包含 "target.sceneId" 字段',[y.INVALID_TARGET_YAW]:'请确保 "target.yaw" 是一个数字（跳转后的水平角度）',[y.INVALID_TARGET_PITCH]:'请确保 "target.pitch" 是一个数字（跳转后的垂直角度）',[y.INVALID_TARGET_FOV]:'请确保 "target.fov" 是一个数字（跳转后的视野角度）',[y.MISSING_TARGET_URL]:'视频类型的热点必须包含 "target.url" 字段，填入视频的 URL'};class Ls{constructor(e,t,i){r(this,"element");this.element=document.createElement("div"),this.element.className="config-error-panel",this.render(e,t,i),this.applyStyles()}render(e,t,i){this.element.innerHTML=`
      <div class="error-panel-content">
        <div class="error-panel-header">
          <h2>⚠️ 配置错误</h2>
          <p class="error-summary">发现 ${e.length} 个配置错误，请检查 config.json</p>
        </div>
        <div class="error-list">
          ${e.map((n,c)=>this.renderErrorCard(n,c)).join("")}
        </div>
        <div class="error-actions">
          <button class="btn btn-primary" id="retry-btn">🔄 刷新重试</button>
          <button class="btn btn-secondary" id="example-btn">📖 查看示例配置</button>
        </div>
      </div>
    `;const s=this.element.querySelector("#retry-btn"),o=this.element.querySelector("#example-btn");s&&s.addEventListener("click",t),o&&o.addEventListener("click",i)}renderErrorCard(e,t){const i=Ms[e.code]||"配置错误",s=Ss[e.code]||"请检查配置文件的格式和内容",o=[];e.museumName&&o.push(`馆：${e.museumName}`),e.sceneName&&o.push(`场景：${e.sceneName}`);const n=o.length>0?o.join(" / "):"全局配置";return`
      <div class="error-card">
        <div class="error-card-header">
          <span class="error-icon">❌</span>
          <span class="error-title">${this.escapeHtml(i)}</span>
        </div>
        <div class="error-card-body">
          <div class="error-location">
            <span class="location-icon">📍</span>
            <span class="location-text">${this.escapeHtml(n)}</span>
          </div>
          ${e.fieldName?`
            <div class="error-field">
              <span class="field-label">字段：</span>
              <span class="field-name">${this.escapeHtml(e.fieldName)}</span>
            </div>
          `:""}
          <div class="error-path">
            <span class="path-label">技术路径：</span>
            <code class="path-code">${this.escapeHtml(e.path)}</code>
          </div>
          <div class="error-hint">
            <span class="hint-icon">💡</span>
            <span class="hint-text">${this.escapeHtml(s)}</span>
          </div>
        </div>
      </div>
    `}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}applyStyles(){const e=document.createElement("style");e.textContent=`
      .config-error-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      }
      .error-panel-content {
        max-width: 800px;
        width: 100%;
        background: #1a1a1a;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      .error-panel-header {
        margin-bottom: 24px;
        text-align: center;
      }
      .error-panel-header h2 {
        font-size: 24px;
        color: #ff6b6b;
        margin-bottom: 8px;
      }
      .error-summary {
        color: #ccc;
        font-size: 14px;
      }
      .error-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 24px;
        background: #0f0f0f;
        border-radius: 8px;
        padding: 16px;
      }
      .error-card {
        padding: 16px;
        margin-bottom: 12px;
        background: #252525;
        border-left: 4px solid #ff6b6b;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .error-card:hover {
        background: #2a2a2a;
      }
      .error-card:last-child {
        margin-bottom: 0;
      }
      .error-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .error-icon {
        font-size: 20px;
      }
      .error-title {
        font-size: 16px;
        font-weight: 600;
        color: #ff6b6b;
      }
      .error-card-body {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .error-location {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #4a90e2;
      }
      .location-icon {
        font-size: 14px;
      }
      .location-text {
        font-weight: 500;
      }
      .error-field {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #ccc;
      }
      .field-label {
        color: #999;
      }
      .field-name {
        color: #ffd93d;
        font-weight: 500;
      }
      .error-path {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        font-size: 12px;
        color: #999;
        margin-top: 4px;
      }
      .path-label {
        color: #666;
        white-space: nowrap;
      }
      .path-code {
        font-family: 'Courier New', monospace;
        color: #888;
        word-break: break-all;
        background: #1a1a1a;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
      }
      .error-hint {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 8px;
        padding: 10px;
        background: #1a1a1a;
        border-radius: 6px;
        border-left: 3px solid #4a90e2;
      }
      .hint-icon {
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 2px;
      }
      .hint-text {
        font-size: 13px;
        color: #ccc;
        line-height: 1.5;
      }
      .error-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }
      .btn-primary {
        background: #4a90e2;
        color: #fff;
      }
      .btn-primary:hover {
        background: #357abd;
      }
      .btn-primary:active {
        transform: scale(0.98);
      }
      .btn-secondary {
        background: #555;
        color: #fff;
      }
      .btn-secondary:hover {
        background: #666;
      }
      .btn-secondary:active {
        transform: scale(0.98);
      }
      @media (max-width: 600px) {
        .error-panel-content {
          padding: 16px;
        }
        .error-actions {
          flex-direction: column;
        }
        .btn {
          width: 100%;
        }
      }
    `,document.head.appendChild(e)}getElement(){return this.element}remove(){this.element.remove()}}let F=null;function Rt(){return F!==null?F:typeof navigator<"u"&&navigator.maxTouchPoints>0||typeof window<"u"&&("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)?(F="touch",F):(F="mouse",F)}function Vt(){return Rt()==="touch"}function Ot(){return Rt()==="mouse"}function Ts(){const a=document;return document.fullscreenElement||a.webkitFullscreenElement||null}function Ne(){return!!Ts()}async function Cs(a){const e=a;if(e.requestFullscreen){await e.requestFullscreen();return}if(e.webkitRequestFullscreen){await e.webkitRequestFullscreen();return}throw new Error("Fullscreen API not supported")}async function xs(){const a=document;if(document.exitFullscreen){await document.exitFullscreen();return}if(a.webkitExitFullscreen){await a.webkitExitFullscreen();return}}async function Ht(a){const e=a||document.body;!Ne()&&Ot()&&U("鼠标滑至最上方可退出全屏",700),await Cs(e)}async function je(){try{await xs(),Ut()}catch(a){console.debug("[fullscreen] exitFullscreenBestEffort failed:",a)}}function Ut(){var a,e;try{(e=(a=screen.orientation)==null?void 0:a.unlock)==null||e.call(a)}catch{}}function ks(){return`
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M9 4H4V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M15 4H20V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M9 20H4V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M15 20H20V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`}function Ns(){return`
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M4 9V4h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M20 9V4h-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M4 15v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M20 15v5h-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M9 9l-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M15 9l3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M9 15l-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M15 15l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`}class Ps{constructor(e={}){r(this,"element");r(this,"fullscreenBtn");r(this,"pickModeBtn",null);r(this,"northCalibrationBtn",null);r(this,"vrModeBtn",null);r(this,"handlePickModeChange",null);r(this,"handleFullscreenChange",null);r(this,"viewerRootEl");r(this,"onTogglePickMode");r(this,"onOpenNorthCalibration");r(this,"onToggleVrMode");r(this,"isPickModeActive",!1);r(this,"isVrModeActive",!1);this.viewerRootEl=e.viewerRootEl,this.onTogglePickMode=e.onTogglePickMode,this.onOpenNorthCalibration=e.onOpenNorthCalibration,this.onToggleVrMode=e.onToggleVrMode,this.element=document.createElement("div"),this.element.className="vr-topright-controls",this.handlePickModeChange=i=>{const s=i;this.updatePickModeState(s.detail.enabled)},window.addEventListener("vr:pickmode",this.handlePickModeChange),this.handleFullscreenChange=()=>{this.syncFullscreenState()},document.addEventListener("fullscreenchange",this.handleFullscreenChange),document.addEventListener("webkitfullscreenchange",this.handleFullscreenChange),this.fullscreenBtn=document.createElement("button"),this.fullscreenBtn.className="vr-topright-btn vr-top-icon-only vr-icon-btn",this.fullscreenBtn.setAttribute("aria-label","进入全屏"),this.fullscreenBtn.addEventListener("click",async i=>{i.preventDefault(),i.stopPropagation();const s=Ne();try{if(s)await je();else{const o=this.viewerRootEl;if(!o){console.warn("[TopRightControls] fullscreen target not set");return}await Ht(o)}}catch(o){P&&console.debug("[TopRightControls] fullscreen toggle failed",o)}finally{window.setTimeout(()=>{this.syncFullscreenState()},100)}}),this.syncFullscreenState(),this.onTogglePickMode&&(this.pickModeBtn=document.createElement("button"),this.pickModeBtn.className="vr-topright-btn",this.pickModeBtn.setAttribute("aria-label","拾取模式"),this.pickModeBtn.title="拾取模式：点击画面获取 yaw/pitch",this.pickModeBtn.textContent="🎯",this.pickModeBtn.style.fontSize="18px",this.pickModeBtn.addEventListener("click",i=>{if(i.preventDefault(),i.stopPropagation(),this.onTogglePickMode){const s=this.onTogglePickMode();this.updatePickModeState(s)}}),this.element.appendChild(this.pickModeBtn)),e.showNorthCalibration!==!1&&(e.onOpenNorthCalibration||P)&&this.onOpenNorthCalibration&&(this.northCalibrationBtn=document.createElement("button"),this.northCalibrationBtn.className="vr-topright-btn",this.northCalibrationBtn.setAttribute("aria-label","校准北向"),this.northCalibrationBtn.title="校准北向：设置当前场景的北方向",this.northCalibrationBtn.textContent="🧭",this.northCalibrationBtn.style.fontSize="18px",this.northCalibrationBtn.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.onOpenNorthCalibration&&this.onOpenNorthCalibration()}),this.element.appendChild(this.northCalibrationBtn)),Vt()&&this.onToggleVrMode&&(this.vrModeBtn=document.createElement("button"),this.vrModeBtn.className="vr-topright-btn vr-top-icon-only vr-icon-btn",this.vrModeBtn.setAttribute("aria-label","VR眼镜"),this.vrModeBtn.title="VR眼镜：转动设备控制视角",this.vrModeBtn.textContent="🥽",this.vrModeBtn.style.fontSize="18px",this.vrModeBtn.addEventListener("click",async i=>{if(i.preventDefault(),i.stopPropagation(),this.onToggleVrMode)try{const s=await this.onToggleVrMode();this.updateVrModeState(s)}catch(s){P&&console.debug("[TopRightControls] VR mode toggle failed",s)}}),this.element.appendChild(this.vrModeBtn)),this.element.appendChild(this.fullscreenBtn)}updatePickModeState(e){this.isPickModeActive=e,this.pickModeBtn&&(this.pickModeBtn.setAttribute("aria-label",e?"关闭拾取模式":"开启拾取模式"),this.pickModeBtn.title=e?"关闭拾取模式":"开启拾取模式：点击画面获取 yaw/pitch",this.pickModeBtn.style.background=e?"rgba(255,255,255,0.18)":"")}updateVrModeState(e){this.isVrModeActive=e,this.vrModeBtn&&(this.vrModeBtn.setAttribute("aria-label",e?"退出VR模式":"进入VR模式"),this.vrModeBtn.title=e?"退出VR模式":"VR眼镜：转动设备控制视角",this.vrModeBtn.style.background=e?"rgba(255,255,255,0.18)":"")}setViewerRootEl(e){this.viewerRootEl=e}syncFullscreenState(){const e=Ne();this.fullscreenBtn.setAttribute("aria-label",e?"退出全屏":"进入全屏"),this.fullscreenBtn.title=e?"退出全屏":"进入全屏",this.fullscreenBtn.innerHTML=e?Ns():ks()}getElement(){return this.element}remove(){this.handlePickModeChange&&(window.removeEventListener("vr:pickmode",this.handlePickModeChange),this.handlePickModeChange=null),this.handleFullscreenChange&&(document.removeEventListener("fullscreenchange",this.handleFullscreenChange),document.removeEventListener("webkitfullscreenchange",this.handleFullscreenChange),this.handleFullscreenChange=null),this.element.remove()}}async function As(a){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(a),!0}catch(e){console.debug("[copyText] Clipboard API failed, using fallback:",e)}try{const e=document.createElement("textarea");e.value=a,e.style.position="fixed",e.style.top="-9999px",e.style.left="-9999px",e.style.opacity="0",e.setAttribute("readonly","readonly"),document.body.appendChild(e),e.select(),e.setSelectionRange(0,a.length);const t=document.execCommand("copy");return document.body.removeChild(e),t}catch(e){return console.debug("[copyText] execCommand fallback failed:",e),!1}}class _s{constructor(e={}){r(this,"root");r(this,"backdrop");r(this,"card");r(this,"closeBtn");r(this,"isOpen",!1);r(this,"onCloseCallback");r(this,"escapeHandler");this.onCloseCallback=e.onClose,this.root=document.createElement("div"),this.root.className="vr-teammodal",this.backdrop=document.createElement("div"),this.backdrop.className="vr-teammodal-backdrop",this.backdrop.addEventListener("click",()=>this.close()),this.root.appendChild(this.backdrop),this.card=document.createElement("div"),this.card.className="vr-teammodal-card",this.closeBtn=document.createElement("button"),this.closeBtn.className="vr-teammodal-close",this.closeBtn.innerHTML="×",this.closeBtn.setAttribute("aria-label","关闭"),this.closeBtn.addEventListener("click",()=>this.close()),this.closeBtn.addEventListener("touchstart",f=>{f.stopPropagation(),this.close()});const t=document.createElement("div");t.className="vr-teammodal-title",t.textContent="鼎虎清源";const i=document.createElement("div");i.className="vr-teammodal-subtitle",i.textContent="VR 研学项目";const s=document.createElement("div");s.className="vr-teammodal-content";const o=document.createElement("p");o.className="vr-teammodal-text",o.textContent="致力于打造沉浸式虚拟现实研学体验，让学习更生动、更直观。";const n=document.createElement("p");n.className="vr-teammodal-text",n.textContent="通过 360° 全景技术，为师生提供身临其境的探索之旅。";const c=document.createElement("p");c.className="vr-teammodal-text",c.textContent="融合创新科技与教育理念，开启数字化学习新篇章。";const l=document.createElement("div");l.className="vr-teammodal-support";const d=document.createElement("div");d.textContent="技术支持：kyu",l.appendChild(d);const u=document.createElement("div");u.className="copyable",u.setAttribute("data-copy","onekyu"),u.textContent="微信：onekyu(点此复制)",u.style.cursor="pointer",u.addEventListener("click",async()=>{const f=u.getAttribute("data-copy");f&&await As(f)&&(U("微信号已复制"),P&&console.debug("[TeamIntroModal] 微信号已复制:",f))}),l.appendChild(u);const h=document.createElement("div");h.className="vr-teammodal-footer",h.textContent="© 2025 鼎虎清源",s.appendChild(o),s.appendChild(n),s.appendChild(c),s.appendChild(l);const m=document.createElement("div");m.className="vr-teammodal-header",m.appendChild(t),m.appendChild(this.closeBtn),this.card.appendChild(m),this.card.appendChild(i),this.card.appendChild(s),this.card.appendChild(h),this.root.appendChild(this.card),this.escapeHandler=f=>{f.key==="Escape"&&this.isOpen&&this.close()},window.addEventListener("keydown",this.escapeHandler)}getModalRoot(){let e=document.getElementById("vr-modal-root");if(!e&&(Dt(),e=document.getElementById("vr-modal-root"),!e))throw new Error("vr-modal-root missing, please call ensureModalHost() first");return e}mount(e){this.root.parentNode!==e&&(this.root.parentNode&&this.root.parentNode.removeChild(this.root),e.appendChild(this.root))}open(){if(P&&console.debug("[TeamIntroModal] open called",new Error().stack),this.isOpen)return;const e=this.getModalRoot();this.root.parentNode!==e&&(this.root.parentNode&&this.root.parentNode.removeChild(this.root),e.appendChild(this.root)),this.isOpen=!0,requestAnimationFrame(()=>{this.root.classList.add("open")})}close(){this.isOpen&&(this.isOpen=!1,this.root.classList.remove("open"),this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.onCloseCallback&&this.onCloseCallback())}dispose(){this.escapeHandler&&window.removeEventListener("keydown",this.escapeHandler),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}class Ds{constructor(e={}){r(this,"element");r(this,"teamIntroModal");this.teamIntroModal=new _s({}),this.element=document.createElement("div"),this.element.className="vr-brandmark",this.element.textContent=e.brandText||"鼎虎清源"}getElement(){return this.element}getAboutModal(){return this.teamIntroModal}remove(){this.element.remove(),this.teamIntroModal.dispose()}}function Rs(){var a;return!!(document.querySelector(".vr-modal-overlay")||document.querySelector(".vr-guide-drawer.open")||document.querySelector(".fcchat-root")&&((a=document.querySelector(".fcchat-root"))==null?void 0:a.style.display)==="flex")}function yt(){Rs()?document.documentElement.classList.add("vr-overlay-open"):document.documentElement.classList.remove("vr-overlay-open")}function Pe(a){const{title:e,contentEl:t,contentHtml:i,onClose:s,panelClassName:o}=a,n=document.createElement("div");n.className="vr-modal-overlay";const c=document.createElement("div");c.className="vr-modal-panel",o&&c.classList.add(o);const l=document.createElement("div");l.className="vr-modal-header";const d=document.createElement("div");d.className="vr-modal-header-title",d.textContent=e;const u=document.createElement("button");u.className="vr-modal-header-close vr-icon-btn",u.type="button",u.setAttribute("aria-label","关闭弹窗"),u.innerHTML="×",l.appendChild(d),l.appendChild(u);const h=document.createElement("div");h.className="vr-modal-body",t?h.appendChild(t):i&&(h.innerHTML=i),c.appendChild(l),c.appendChild(h),n.appendChild(c),document.body.appendChild(n),yt(),o==="vr-modal-settings"&&(document.documentElement.classList.add("vr-more-open"),requestAnimationFrame(()=>{c.classList.add("is-in")}));let m=!1;const f=g=>{g.key==="Escape"&&(g.stopPropagation(),p.close())},v=g=>{g.target===n&&p.close()},w=g=>{g.preventDefault(),g.stopPropagation(),p.close()};window.addEventListener("keydown",f),n.addEventListener("click",v),u.addEventListener("click",w);const p={close:()=>{if(!m&&(m=!0,window.removeEventListener("keydown",f),n.removeEventListener("click",v),u.removeEventListener("click",w),n.parentNode&&n.parentNode.removeChild(n),o==="vr-modal-settings"&&document.documentElement.classList.remove("vr-more-open"),yt(),s))try{s()}catch{}}};return p}function Xe(a){return{guide:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 12L5 10M5 10L12 3L19 10M5 10V20C5 20.5523 5.44772 21 6 21H9M19 10L21 12M19 10V20C19 20.5523 18.5523 21 18 21H15M9 21C9.55228 21 10 20.5523 10 20V16C10 15.4477 10.4477 15 11 15H13C13.5523 15 14 15.4477 14 16V20C14 20.5523 14.4477 21 15 21M9 21H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',community:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',info:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',more:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="1" fill="currentColor"/><circle cx="19" cy="12" r="1" fill="currentColor"/><circle cx="5" cy="12" r="1" fill="currentColor"/></svg>',search:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',"arrow-right":'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 5L19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'}[a]||""}const Vs=[{key:"guide",label:"导览"},{key:"community",label:"社区"},{key:"info",label:"信息"},{key:"settings",label:"更多"}];function Ue(a){return a==="community"||a==="map"||a==="dollhouse"}class Os{constructor(e={}){r(this,"element");r(this,"dockEl");r(this,"panelsHost");r(this,"panels",null);r(this,"panelsLoadPromise",null);r(this,"destroyed",!1);r(this,"activeTabs");r(this,"onGuideClick");r(this,"onOpenInfo");r(this,"onOpenSettings");r(this,"initialTab");r(this,"sceneId");r(this,"sceneName");r(this,"museum");r(this,"scenes");r(this,"currentSceneId");r(this,"unsubscribeInteracting",null);r(this,"unsubscribeIdle",null);r(this,"unsubscribeUIEngaged",null);r(this,"handleDockTabOpen");r(this,"handleDockTabClose");r(this,"handleClosePanels");this.activeTabs=new Set,this.onGuideClick=e.onGuideClick,this.onOpenInfo=e.onOpenInfo,this.onOpenSettings=e.onOpenSettings,this.initialTab=e.initialTab||"guide",this.sceneId=e.sceneId,this.sceneName=e.sceneName,this.museum=e.museum,this.scenes=e.scenes,this.currentSceneId=e.currentSceneId||e.sceneId,this.element=document.createElement("div"),this.element.className="vr-dock-wrap",this.panelsHost=document.createElement("div"),this.panelsHost.className="vr-dock-panels-host",this.element.appendChild(this.panelsHost),this.dockEl=document.createElement("div"),this.dockEl.className="vr-dock vr-glass",this.element.appendChild(this.dockEl);for(const t of Vs){const i=document.createElement("button");i.className="vr-btn vr-dock-tab",i.setAttribute("data-tab",t.key);const s=t.key==="guide"?"guide":t.key==="community"?"community":t.key==="info"?"info":"more";i.innerHTML=`<span class="vr-dock-tab-icon">${Xe(s)}</span><div class="vr-dock-tab-label">${t.label}</div>`,i.addEventListener("click",o=>{if(o.preventDefault(),o.stopPropagation(),k.emitUIEngaged(),t.key==="guide"){this.setTabActive("guide",!0),this.onGuideClick&&this.onGuideClick();return}if(t.key==="community"){this.setTabActive("community",!0);return}if(t.key==="info"){this.setTabActive("info",!0),this.onOpenInfo?this.onOpenInfo():this.openFallbackInfoModal();return}this.setTabActive("settings",!0),this.onOpenSettings?this.onOpenSettings():this.openFallbackSettingsModal()}),this.dockEl.appendChild(i)}this.syncActiveClass(),this.setupInteractionListeners(),this.setupDockEventListeners(),Ue(this.initialTab)&&this.setTabActive(this.initialTab,!0)}async ensurePanels(){return this.panels?this.panels:this.panelsLoadPromise?(await this.panelsLoadPromise,this.panels):(this.panelsLoadPromise=(async()=>{const{DockPanels:e}=await K(async()=>{const{DockPanels:i}=await import("./dock-panels-ByTJbHA4.js").then(s=>s.D);return{DockPanels:i}},__vite__mapDeps([0,1]),import.meta.url);if(this.destroyed)return;const t=new e({initialTab:this.initialTab,sceneId:this.sceneId,sceneName:this.sceneName,museum:this.museum,scenes:this.scenes,currentSceneId:this.currentSceneId||this.sceneId});if(t.setVisible(!0),this.destroyed){t.remove();return}this.panels=t,this.panelsHost.appendChild(t.getElement())})().finally(()=>{this.panelsLoadPromise=null}),await this.panelsLoadPromise,this.panels)}async openPanelTab(e){const t=await this.ensurePanels();!t||this.destroyed||t.setTab(e)}setupInteractionListeners(){}syncActiveClass(){this.dockEl.querySelectorAll(".vr-dock-tab").forEach(t=>{const i=t.getAttribute("data-tab");i&&this.activeTabs.has(i)?t.classList.add("active"):t.classList.remove("active")})}setTabActive(e,t){if(t?this.activeTabs.add(e):this.activeTabs.delete(e),this.syncActiveClass(),t&&Ue(e)){this.openPanelTab(e);return}!t&&Ue(e)&&this.panels&&!(this.activeTabs.has("community")||this.activeTabs.has("map")||this.activeTabs.has("dollhouse"))&&this.panels.closeAllPanels&&this.panels.closeAllPanels()}isTabActive(e){return this.activeTabs.has(e)}setupDockEventListeners(){this.handleDockTabOpen=e=>{var i;const t=e;(i=t.detail)!=null&&i.tab&&this.setTabActive(t.detail.tab,!0)},this.handleDockTabClose=e=>{var i;const t=e;(i=t.detail)!=null&&i.tab&&this.setTabActive(t.detail.tab,!1)},this.handleClosePanels=()=>{var e;this.setTabActive("community",!1),this.setTabActive("map",!1),this.setTabActive("dollhouse",!1),(e=this.panels)!=null&&e.closeAllPanels&&this.panels.closeAllPanels()},window.addEventListener("vr:dock-tab-open",this.handleDockTabOpen),window.addEventListener("vr:dock-tab-close",this.handleDockTabClose),window.addEventListener("vr:close-panels",this.handleClosePanels)}setSceneContext(e,t){this.sceneId=e,this.sceneName=t,this.currentSceneId=e,this.panels&&this.panels.setSceneContext(e,t)}setMuseumContext(e,t,i){this.museum=e,this.scenes=t,this.currentSceneId=i,this.panels&&this.panels.setMuseumContext(e,t,i)}getElement(){return this.element}setMoreOpen(e){e?this.element.classList.add("dock--more-open"):this.element.classList.remove("dock--more-open")}openFallbackInfoModal(){Pe({title:"信息",contentHtml:`
        <div class="vr-modal-info-list">
          <div><span class="vr-modal-info-row-label">馆：</span><span>-</span></div>
          <div><span class="vr-modal-info-row-label">场景：</span><span>-</span></div>
          <div><span class="vr-modal-info-row-label">采集日：</span><span>2025-12-27</span></div>
        </div>
      `})}openFallbackSettingsModal(){Pe({title:"设置",contentHtml:`
        <div class="vr-modal-settings-list">
          <div>此版本暂未接入设置功能。</div>
        </div>
      `})}remove(){this.destroyed=!0,this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=null),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=null),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=null),this.handleDockTabOpen&&(window.removeEventListener("vr:dock-tab-open",this.handleDockTabOpen),this.handleDockTabOpen=void 0),this.handleDockTabClose&&(window.removeEventListener("vr:dock-tab-close",this.handleDockTabClose),this.handleDockTabClose=void 0),this.handleClosePanels&&(window.removeEventListener("vr:close-panels",this.handleClosePanels),this.handleClosePanels=void 0),this.panels&&(this.panels.remove(),this.panels=null),this.element.remove()}}const bt="data:image/svg+xml;utf8,"+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#1F2933"/>
          <stop offset="1" stop-color="#111827"/>
        </linearGradient>
      </defs>
      <rect width="100%" height="100%" fill="url(#g)"/>
      <text x="50%" y="50%" fill="rgba(255,255,255,0.72)" font-size="20" text-anchor="middle" font-family="STKaiti,Kaiti SC,KaiTi,Songti SC,SimSun,Source Han Serif SC,Noto Serif SC,serif">
        暂无封面
      </text>
    </svg>`);class Hs{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"museumId");r(this,"currentSceneId");r(this,"scenes");r(this,"filteredScenes");r(this,"listEl",null);r(this,"previewImgEl",null);r(this,"previewTitleEl",null);r(this,"previewIdEl",null);r(this,"searchInputEl",null);r(this,"hoveredSceneId",null);r(this,"selectedSceneId",null);r(this,"onClose");this.museumId=e.museumId,this.currentSceneId=e.currentSceneId,this.scenes=e.scenes,this.filteredScenes=e.scenes,this.onClose=e.onClose,this.element=document.createElement("div"),this.element.className="vr-guide-drawer";const t=document.createElement("div");t.className="vr-guide-mask";const i=document.createElement("div");i.className="vr-guide-panel";const s=document.createElement("div");s.className="vr-guide-header";const o=document.createElement("div");o.className="vr-guide-header-left";const n=document.createElement("div");n.className="vr-guide-title",n.textContent="导览";const c=document.createElement("button");c.className="vr-btn vr-guide-close",c.setAttribute("aria-label","关闭"),c.textContent="×",c.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),this.close()}),s.appendChild(o),s.appendChild(n),s.appendChild(c);const l=document.createElement("div");l.className="vr-guide-search";const d=document.createElement("span");d.className="vr-guide-search-icon",d.innerHTML=Xe("search");const u=document.createElement("input");u.className="vr-guide-search-input",u.type="search",u.placeholder="查找场景",l.appendChild(d),l.appendChild(u),this.searchInputEl=u;const h=document.createElement("div");h.className="vr-guide-body";const m=document.createElement("div");m.className="vr-guide-list",this.listEl=m;const f=document.createElement("div");f.className="vr-guide-preview";const v=document.createElement("img");v.className="vr-guide-preview-image",v.referrerPolicy="no-referrer",v.crossOrigin="anonymous",v.decoding="async",v.loading="lazy",this.previewImgEl=v;const w=document.createElement("div");w.className="vr-guide-preview-title",this.previewTitleEl=w;const p=document.createElement("div");p.className="vr-guide-preview-id",this.previewIdEl=p;const g=document.createElement("button");g.className="vr-btn vr-guide-preview-enter",g.innerHTML=`<span class="vr-guide-enter-icon">${Xe("arrow-right")}</span><span>前往</span>`,g.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation();const E=this.selectedSceneId||this.currentSceneId;E&&E!==this.currentSceneId?(G(this.museumId,E),this.close()):E===this.currentSceneId&&this.close()}),f.appendChild(v),f.appendChild(w),f.appendChild(p),f.appendChild(g),h.appendChild(m),h.appendChild(f),t.addEventListener("click",()=>this.close()),i.addEventListener("click",b=>b.stopPropagation()),i.appendChild(s),i.appendChild(l),i.appendChild(h),this.element.appendChild(t),this.element.appendChild(i),this.bindSearch(),this.renderList(),this.updatePreview()}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"),this.updateOverlayState(),this.selectedSceneId||(this.selectedSceneId=this.currentSceneId),this.updateActiveState(),this.updatePreview())}close(){var e;this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"),this.updateOverlayState(),(e=this.onClose)==null||e.call(this))}updateOverlayState(){var t;!!(document.querySelector(".vr-modal-overlay")||document.querySelector(".vr-guide-drawer.open")&&this.isOpen||document.querySelector(".fcchat-root")&&((t=document.querySelector(".fcchat-root"))==null?void 0:t.style.display)==="flex")?document.documentElement.classList.add("vr-overlay-open"):document.documentElement.classList.remove("vr-overlay-open")}toggle(){this.isOpen?this.close():this.open()}getElement(){return this.element}remove(){this.element.remove()}setCurrentScene(e){this.currentSceneId=e,this.updateActiveState(),this.updatePreview()}bindSearch(){this.searchInputEl&&this.searchInputEl.addEventListener("input",()=>{var t;const e=(((t=this.searchInputEl)==null?void 0:t.value)||"").trim().toLowerCase();e?this.filteredScenes=this.scenes.filter(i=>(i.name||"").toLowerCase().includes(e)||i.id.toLowerCase().includes(e)):this.filteredScenes=this.scenes,this.renderList(),this.updatePreview()})}renderList(){if(this.listEl){this.listEl.innerHTML="";for(const e of this.filteredScenes){const t=document.createElement("div");t.className="vr-guide-item",t.setAttribute("data-scene-id",e.id),e.id===this.currentSceneId&&t.classList.add("active");const i=document.createElement("img");i.className="vr-guide-thumb",i.referrerPolicy="no-referrer",i.crossOrigin="anonymous",i.decoding="async",i.loading="lazy";const s=e.thumb?pe(e.thumb):bt;i.src=s,i.alt=e.name||e.id;const o=document.createElement("div");o.className="vr-guide-meta";const n=document.createElement("div");n.className="vr-guide-name",n.textContent=e.name||e.id;const c=document.createElement("div");c.className="vr-guide-id",c.textContent=e.id,o.appendChild(n),o.appendChild(c),t.appendChild(i),t.appendChild(o),t.addEventListener("mouseenter",()=>{this.hoveredSceneId=e.id,this.updatePreview()}),t.addEventListener("mouseleave",()=>{this.hoveredSceneId=null,this.updatePreview()}),t.addEventListener("click",l=>{var d;l.preventDefault(),l.stopPropagation(),this.selectedSceneId=e.id,(d=this.listEl)==null||d.querySelectorAll(".vr-guide-item").forEach(u=>{u.classList.remove("selected")}),t.classList.add("selected"),this.updatePreview()}),this.listEl.appendChild(t)}}}updateActiveState(){this.listEl&&this.listEl.querySelectorAll(".vr-guide-item").forEach(e=>{const i=e.getAttribute("data-scene-id")===this.currentSceneId;e.classList.toggle("active",i),i&&!this.selectedSceneId&&(this.selectedSceneId=this.currentSceneId,e.classList.add("selected"))})}updatePreview(){if(!this.previewImgEl||!this.previewTitleEl||!this.previewIdEl)return;const e=this.selectedSceneId||this.hoveredSceneId||this.currentSceneId,t=this.scenes.find(s=>s.id===e)||this.scenes[0];if(!t)return;const i=t.thumb?pe(t.thumb):bt;this.previewImgEl.src=i,this.previewImgEl.alt=t.name||t.id,this.previewTitleEl.textContent=t.name||t.id,this.previewIdEl.textContent=t.id}}class Us{constructor(e){r(this,"element");r(this,"scrollEl");r(this,"museumId");r(this,"currentSceneId");r(this,"scenes");r(this,"onSceneClick");r(this,"onMoreClick");r(this,"onClose");this.museumId=e.museumId,this.currentSceneId=e.currentSceneId,this.scenes=e.scenes,this.onSceneClick=e.onSceneClick,this.onMoreClick=e.onMoreClick,this.onClose=e.onClose,this.element=document.createElement("div"),this.element.className="vr-guidetray";const t=document.createElement("div");t.className="vr-guidetray-header";const i=document.createElement("button");i.className="vr-btn vr-guidetray-more",i.textContent="更多",i.addEventListener("click",o=>{var n;o.preventDefault(),o.stopPropagation(),(n=this.onMoreClick)==null||n.call(this)});const s=document.createElement("button");s.className="vr-btn vr-guidetray-close",s.textContent="×",s.setAttribute("aria-label","关闭"),s.addEventListener("click",o=>{var n;o.preventDefault(),o.stopPropagation(),(n=this.onClose)==null||n.call(this)}),t.appendChild(i),t.appendChild(s),this.scrollEl=document.createElement("div"),this.scrollEl.className="vr-guidetray-scroll",this.element.appendChild(t),this.element.appendChild(this.scrollEl),this.render()}render(){this.scrollEl.innerHTML="",this.scenes.forEach(t=>{const i=document.createElement("div");i.className="vr-guidetray-item",i.setAttribute("data-scene-id",t.id),t.id===this.currentSceneId&&i.classList.add("is-current");const s=document.createElement("img");s.className="vr-guidetray-item-thumb",s.referrerPolicy="no-referrer",s.crossOrigin="anonymous",s.decoding="async",s.loading="lazy";const o=t.thumb?Y(t.thumb,O.THUMB):void 0;o&&(s.src=pe(o)),s.alt=t.name;const n=document.createElement("div");n.className="vr-guidetray-item-title",n.textContent=t.name,i.appendChild(s),i.appendChild(n),i.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),this.onSceneClick&&this.onSceneClick(t.id)}),this.scrollEl.appendChild(i)});const e=document.createElement("div");e.className="vr-guidetray-item vr-guidetray-item-more",e.innerHTML=`
      <div class="vr-guidetray-item-thumb vr-guidetray-more-icon">+</div>
      <div class="vr-guidetray-item-title">更多</div>
    `,e.addEventListener("click",t=>{var i;t.preventDefault(),t.stopPropagation(),(i=this.onMoreClick)==null||i.call(this)}),this.scrollEl.appendChild(e)}updateCurrentScene(e){this.currentSceneId=e,this.scrollEl.querySelectorAll(".vr-guidetray-item").forEach(t=>{const i=t;i.getAttribute("data-scene-id")===e?i.classList.add("is-current"):i.classList.remove("is-current")})}setVisible(e){this.element.classList.toggle("visible",e)}getElement(){return this.element}remove(){this.element.remove()}}class $s{constructor(e={}){r(this,"element");r(this,"currentMode");r(this,"onModeChange");this.currentMode=e.initialMode||"tour",this.onModeChange=e.onModeChange,this.element=document.createElement("div"),this.element.className="vr-topmodes",[{key:"tour",label:"漫游"},{key:"structure2d",label:"结构图"},{key:"structure3d",label:"三维模型"}].forEach(i=>{const s=document.createElement("button");s.className="vr-topmodes__btn",s.textContent=i.label,s.setAttribute("data-mode",i.key),i.key===this.currentMode&&s.classList.add("is-active"),s.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),this.setMode(i.key)}),this.element.appendChild(s)}),this.syncActiveState()}syncActiveState(){this.element.querySelectorAll(".vr-topmodes__btn").forEach(e=>{const t=e.getAttribute("data-mode");e.classList.toggle("is-active",t===this.currentMode)})}setMode(e){this.currentMode!==e&&(this.currentMode=e,this.syncActiveState(),this.onModeChange&&this.onModeChange(e))}getMode(){return this.currentMode}getElement(){return this.element}}const Ys={iterations:300,width:1e3,height:1e3,padding:40,repulsion:.15,spring:.12,damping:.88};function Fs(a,e,t){const i={...Ys,...t},s=a.length;if(s===0)return{};const o={},n=Math.max(1,Math.sqrt(s)*.5);a.forEach((d,u)=>{const h=2*Math.PI*u/s,m=(Math.random()-.5)*.2;o[d.id]={x:n*Math.cos(h)+m,y:n*Math.sin(h)+m,vx:0,vy:0}});const c=e.length>0?e:a.length>1?a.slice(0,-1).map((d,u)=>({from:d.id,to:a[u+1].id})):[];for(let d=0;d<i.iterations;d++){for(let u=0;u<s;u++){const h=a[u],m=o[h.id];for(let f=u+1;f<s;f++){const v=a[f],w=o[v.id];let p=m.x-w.x,g=m.y-w.y;const b=p*p+g*g||1e-4,E=i.repulsion/b;p*=E,g*=E,m.vx+=p,m.vy+=g,w.vx-=p,w.vy-=g}}for(const u of c){const h=o[u.from],m=o[u.to];if(!h||!m)continue;const f=m.x-h.x,v=m.y-h.y,w=Math.sqrt(f*f+v*v)||1e-4,g=i.spring*(w-1),b=f/w*g,E=v/w*g;h.vx+=b,h.vy+=E,m.vx-=b,m.vy-=E}for(const u in o){const h=o[u];h.vx*=i.damping,h.vy*=i.damping,h.x+=h.vx*.1,h.y+=h.vy*.1}}const l={};for(const d in o)l[d]={x:o[d].x,y:o[d].y};return Gs(l,i.width,i.height,i.padding)}function Gs(a,e,t,i){const s=Object.entries(a);if(s.length===0)return{};let o=1/0,n=-1/0,c=1/0,l=-1/0;for(const[,g]of s)o=Math.min(o,g.x),n=Math.max(n,g.x),c=Math.min(c,g.y),l=Math.max(l,g.y);const d=n-o||1,u=l-c||1,h=e-2*i,m=t-2*i,f=h/d,v=m/u,w=Math.min(f,v),p={};for(const[g,b]of s)p[g]={x:i+(b.x-o)*w+(h-d*w)/2,y:i+(b.y-c)*w+(m-u*w)/2};return p}function zs(a){const e=a.filter(h=>h.mapPoint);if(e.length<a.length)return!0;if(e.length<2)return!1;const t=e.map(h=>h.mapPoint.x),i=e.map(h=>h.mapPoint.y),s=Math.min(...t),o=Math.max(...t),n=Math.min(...i),c=Math.max(...i),l=o-s,d=c-n,u=100;return l<u||d<u}class Bs{constructor(e){r(this,"element");r(this,"canvasContainer");r(this,"svg");r(this,"floorplanImg",null);r(this,"statusEl",null);r(this,"toggleBtn",null);r(this,"museum");r(this,"graph");r(this,"currentSceneId");r(this,"onClose");r(this,"onNodeClick");r(this,"layout",{});r(this,"mode","graph");r(this,"hasFloorplan",!1);var t;this.museum=e.museum,this.graph=e.graph,this.currentSceneId=e.currentSceneId,this.onClose=e.onClose,this.onNodeClick=e.onNodeClick,this.hasFloorplan=!!((t=this.museum.map)!=null&&t.image),this.mode=this.hasFloorplan?"floorplan":"graph",this.element=document.createElement("div"),this.element.className="vr-structure2d-overlay",this.render(),this.bindEvents()}render(){var o;const e=document.createElement("div");e.className="vr-structure2d-header";const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="4px";const i=document.createElement("div");i.className="vr-structure2d-title",i.textContent="结构图",this.statusEl=document.createElement("div"),this.statusEl.className="vr-structure2d-status",this.updateStatusText(),t.appendChild(i),t.appendChild(this.statusEl),this.hasFloorplan&&(this.toggleBtn=document.createElement("button"),this.toggleBtn.className="vr-btn vr-structure2d-toggle",this.toggleBtn.textContent=this.mode==="floorplan"?"结构图":"平面图",this.toggleBtn.addEventListener("click",()=>{this.mode=this.mode==="floorplan"?"graph":"floorplan",this.toggleBtn.textContent=this.mode==="floorplan"?"结构图":"平面图",this.updateStatusText(),this.renderContent()}),e.appendChild(this.toggleBtn));const s=document.createElement("button");if(s.className="vr-btn vr-structure2d-close",s.innerHTML="✕",s.setAttribute("aria-label","关闭"),s.addEventListener("click",()=>{this.close()}),e.appendChild(t),e.appendChild(s),this.canvasContainer=document.createElement("div"),this.canvasContainer.className="vr-structure2d-canvas",this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%"),this.svg.setAttribute("class","vr-structure2d-svg"),this.canvasContainer.appendChild(this.svg),this.hasFloorplan&&((o=this.museum.map)!=null&&o.image)){const n=Y(this.museum.map.image,O.MAP);n&&(this.floorplanImg=document.createElement("img"),this.floorplanImg.className="vr-structure2d-floorplan",this.floorplanImg.src=n,this.floorplanImg.style.display="none",this.canvasContainer.appendChild(this.floorplanImg),this.floorplanImg.onload=()=>{this.mode==="floorplan"&&this.renderContent()})}this.element.appendChild(e),this.element.appendChild(this.canvasContainer),this.computeLayout(),this.renderContent()}updateStatusText(){if(!this.statusEl)return;const e=this.graph.nodes.length;this.statusEl.textContent=`mode: ${this.mode}, nodes: ${e}`}renderContent(){this.mode==="floorplan"?this.renderFloorplan():this.renderGraph()}computeLayout(){var s,o;const e=((s=this.museum.map)==null?void 0:s.width)||1e3,t=((o=this.museum.map)==null?void 0:o.height)||600;if(zs(this.graph.nodes))this.layout=Fs(this.graph.nodes,this.graph.edges,{width:e,height:t,iterations:300,padding:40});else{this.layout={};for(const n of this.graph.nodes)n.mapPoint&&(this.layout[n.id]={x:n.mapPoint.x,y:n.mapPoint.y})}}renderFloorplan(){var s,o;this.svg&&(this.svg.style.display="none"),this.floorplanImg&&(this.floorplanImg.style.display="block"),this.svg.innerHTML="",this.svg.style.display="block",this.svg.style.position="absolute",this.svg.style.top="0",this.svg.style.left="0",this.svg.style.pointerEvents="none";const e=((s=this.museum.map)==null?void 0:s.width)||1e3,t=((o=this.museum.map)==null?void 0:o.height)||600;this.svg.setAttribute("viewBox",`0 0 ${e} ${t}`),this.svg.style.pointerEvents="auto";const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttribute("class","vr-structure2d-nodes");for(const n of this.graph.nodes){const c=this.layout[n.id];if(!c)continue;const l=n.id===this.currentSceneId,d=document.createElementNS("http://www.w3.org/2000/svg","g");d.setAttribute("class",`vr-structure2d-node ${l?"is-current":""}`),d.setAttribute("data-scene-id",n.id),d.style.cursor="pointer";const u=document.createElementNS("http://www.w3.org/2000/svg","circle");u.setAttribute("cx",c.x.toString()),u.setAttribute("cy",c.y.toString()),u.setAttribute("r",l?"12":"8"),u.setAttribute("class","vr-structure2d-node-circle");const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",c.x.toString()),h.setAttribute("y",(c.y+(l?25:20)).toString()),h.setAttribute("class","vr-structure2d-node-label"),h.setAttribute("text-anchor","middle"),h.textContent=n.name,d.appendChild(u),d.appendChild(h),i.appendChild(d),d.addEventListener("click",()=>{this.onNodeClick&&this.onNodeClick(this.museum.id,n.id)})}this.svg.appendChild(i)}renderGraph(){var o,n;this.floorplanImg&&(this.floorplanImg.style.display="none"),this.svg&&(this.svg.style.display="block",this.svg.style.position="",this.svg.style.pointerEvents="auto"),this.svg.innerHTML="";const e=((o=this.museum.map)==null?void 0:o.width)||1e3,t=((n=this.museum.map)==null?void 0:n.height)||600;this.svg.setAttribute("viewBox",`0 0 ${e} ${t}`);const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttribute("class","vr-structure2d-edges");for(const c of this.graph.edges){const l=this.layout[c.from],d=this.layout[c.to];if(!l||!d)continue;const u=document.createElementNS("http://www.w3.org/2000/svg","line");u.setAttribute("x1",l.x.toString()),u.setAttribute("y1",l.y.toString()),u.setAttribute("x2",d.x.toString()),u.setAttribute("y2",d.y.toString()),u.setAttribute("class","vr-structure2d-edge"),i.appendChild(u)}this.svg.appendChild(i);const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("class","vr-structure2d-nodes");for(const c of this.graph.nodes){const l=this.layout[c.id];if(!l)continue;const d=c.id===this.currentSceneId,u=document.createElementNS("http://www.w3.org/2000/svg","g");u.setAttribute("class",`vr-structure2d-node ${d?"is-current":""}`),u.setAttribute("data-scene-id",c.id),u.style.cursor="pointer";const h=document.createElementNS("http://www.w3.org/2000/svg","circle");h.setAttribute("cx",l.x.toString()),h.setAttribute("cy",l.y.toString()),h.setAttribute("r",d?"12":"8"),h.setAttribute("class","vr-structure2d-node-circle");const m=document.createElementNS("http://www.w3.org/2000/svg","text");m.setAttribute("x",l.x.toString()),m.setAttribute("y",(l.y+(d?25:20)).toString()),m.setAttribute("class","vr-structure2d-node-label"),m.setAttribute("text-anchor","middle"),m.textContent=c.name,u.appendChild(h),u.appendChild(m),s.appendChild(u),u.addEventListener("click",()=>{this.onNodeClick&&this.onNodeClick(this.museum.id,c.id)})}this.svg.appendChild(s)}bindEvents(){const e=t=>{t.key==="Escape"&&this.close()};document.addEventListener("keydown",e),this.element.addEventListener("vr:cleanup",()=>{document.removeEventListener("keydown",e)})}updateContext(e){var t;this.museum=e.museum,this.graph=e.graph,this.currentSceneId=e.currentSceneId,this.hasFloorplan=!!((t=this.museum.map)!=null&&t.image),this.computeLayout(),this.updateStatusText(),this.renderContent()}open(){this.element.classList.add("is-visible")}close(){this.element.classList.remove("is-visible"),this.onClose&&this.onClose()}getElement(){return this.element}remove(){this.element.remove()}}function Et(a,e){var o;const t=a.scenes.map(n=>({id:n.id,name:n.name,scene:n,mapPoint:n.mapPoint,initialView:n.initialView})),i=new Set(t.map(n=>n.id)),s=[];for(const n of a.scenes)for(const c of n.hotspots){if(c.type!=="scene"||!((o=c.target)!=null&&o.sceneId))continue;const l=c.target.museumId??a.id,d=c.target.sceneId;l!==a.id||!i.has(d)||s.some(h=>h.from===n.id&&h.to===d)||s.push({from:n.id,to:d})}return{nodes:t,edges:s,currentNodeId:e&&i.has(e)?e:void 0}}function In(a,e){let t=0;for(const i of a.edges)(i.from===e||i.to===e)&&t++;return t}function Ws(a,e,t){const i=a.getBoundingClientRect(),s=e-i.left,o=t-i.top,n=document.createElement("div");n.className="vr-pick-marker",n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.transform=`translate3d(${s}px, ${o}px, 0)`,n.style.pointerEvents="none",n.style.zIndex="1000",a.style.position="relative",a.appendChild(n),window.requestAnimationFrame(()=>{n.classList.add("show")}),window.setTimeout(()=>{n.classList.remove("show"),window.setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},200)},1500)}const $t="vr_last_pick_v1";let it=null;function qs(){try{const a=localStorage.getItem($t);if(a){const e=JSON.parse(a);typeof e.yaw=="number"&&typeof e.pitch=="number"&&typeof e.ts=="number"&&(it=e)}}catch{}}qs();function js(a){it=a;try{localStorage.setItem($t,JSON.stringify(a))}catch{}}function Mn(){return it}const Xs=150,Qs=150,Ks=400;function Zs(){return{fadeMs:Xs,restoreMs:Qs,restoreDelayMs:Ks}}function Js(){k.on("user-interacting",()=>{}),k.on("user-idle",()=>{}),k.on("ui-engaged",()=>{})}let V=null;function en(){const a=Zs();k.on("user-interacting",()=>{V!==null&&(clearTimeout(V),V=null),document.documentElement.classList.add("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")}),k.on("user-idle",()=>{V!==null&&(clearTimeout(V),V=null),document.documentElement.classList.remove("vr-ui-interacting"),V=window.setTimeout(()=>{document.documentElement.classList.remove("vr-ui-restoring"),V=null},a.restoreDelayMs)}),k.on("ui-engaged",()=>{V!==null&&(clearTimeout(V),V=null),document.documentElement.classList.remove("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")})}function tn(){const a={};try{const e=new URLSearchParams(window.location.search),t=e.get("museum"),i=e.get("scene");t&&(a.museumId=t),i&&(a.currentSceneId=i)}catch{}try{const e=document.querySelector(".vr-groundnav");if(e){a.groundNavDots={};const t=e.querySelector(".vr-groundnav__dot.is-aimed");t&&(a.groundNavDots.aimedSceneId=t.getAttribute("data-scene-id")||void 0);const i=e.querySelector(".vr-groundnav__dot.is-autonav");if(i){a.groundNavDots.isAutoNavActive=!0,a.groundNavDots.autoNavTargetSceneId=i.getAttribute("data-scene-id")||void 0;const s=i.querySelector(".vr-groundnav__progress");a.groundNavDots.hasProgressElement=!!s}}}catch{}try{const e=document.querySelector(".vr-previewcard");if(e){a.scenePreviewCard={},a.scenePreviewCard.isVisible=e.classList.contains("is-visible");const t=e.querySelector(".vr-previewcard__hint");t&&(a.scenePreviewCard.hintVisible=t.classList.contains("is-visible"),a.scenePreviewCard.hintEmphasizing=t.classList.contains("is-emphasizing"))}}catch{}try{const e=document.querySelector(".vr-scenestrip");e&&(a.sceneStrip={},a.sceneStrip.userScrolling=e.classList.contains("is-user-scrolling"))}catch{}try{const e=document.documentElement,t=Array.from(e.classList).filter(i=>i==="vr-ui-interacting"||i==="vr-ui-restoring");t.length>0&&(a.yieldClassManager={classes:t})}catch{}return a}function sn(a){try{window.dispatchEvent(new CustomEvent("vr:close-panels"))}catch{}try{a?(a.emitInteracting(),setTimeout(()=>{try{document.documentElement.classList.remove("vr-ui-interacting","vr-ui-restoring")}catch{}},100)):document.documentElement.classList.remove("vr-ui-interacting","vr-ui-restoring")}catch{}}let oe=!1,ye=null,Te=null,Ce=null,xe=!1,ce=0,Z=0,ke=!0;const nn=new H(0,0,1),It=new ai,on=new Ke,an=new Ke(-Math.sqrt(.5),0,0,Math.sqrt(.5)),Se=new Ke,rn=new H(0,0,-1),ln=new H(0,1,0);let Ae=null;function cn(){const a=screen.orientation,e=a&&typeof a.angle=="number"?a.angle:typeof window.orientation=="number"?window.orientation:0;return N.degToRad(e||0)}function hn(a,e,t){const i=N.degToRad(a||0),s=N.degToRad(e||0),o=N.degToRad(t||0),n=cn();return It.set(s,i,-o,"YXZ"),Se.setFromEuler(It),Se.multiply(an),Se.multiply(on.setFromAxisAngle(nn,-n)),Se.clone()}function $e(a){for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;return a}function dn(a,e,t){a=$e(a),e=$e(e);let i=e-a;return i>Math.PI&&(i-=2*Math.PI),i<-Math.PI&&(i+=2*Math.PI),$e(a+i*t)}function un(){return/iPhone|iPad|iPod/i.test(navigator.userAgent)}async function mn(){if(!un())return!0;if(typeof DeviceOrientationEvent.requestPermission=="function")try{return await DeviceOrientationEvent.requestPermission()==="granted"}catch(a){return console.warn("[VRMode] iOS permission request failed:",a),!1}return!0}function pn(a){Ae=a}async function gn(a){var t;if(oe)return!0;if(!await mn())return U("未获得陀螺仪权限，无法进入VR模式"),!1;xe=!1,Ce=null,ce=0,Z=0,ke=!0,Te=a;try{(t=screen.orientation)!=null&&t.lock&&await screen.orientation.lock("landscape")}catch{}return ye=i=>{if(!oe||!Te||i.alpha===null||i.beta===null||i.gamma===null)return;const s=hn(i.alpha,i.beta,i.gamma);if(!xe){Ce=s.clone(),xe=!0;return}if(Ae&&Ae())return;const o=Ce.clone().invert(),n=s.clone().multiply(o),c=rn.clone().applyQuaternion(n),l=ln.clone().applyQuaternion(n);let d=Math.atan2(c.x,-c.z);d=-d;let u=Math.atan2(l.z,l.y);u=-u;const h=N.degToRad(85);u=Math.max(-h,Math.min(h,u)),ke?(ce=d,Z=u,ke=!1):(ce=dn(ce,d,.15),Z=Z+(u-Z)*.2);const m=N.radToDeg(ce),f=N.radToDeg(Z);Te(m,f)},window.addEventListener("deviceorientation",ye),oe=!0,!0}function Yt(){var a;if(oe){ye&&(window.removeEventListener("deviceorientation",ye),ye=null),Te=null,oe=!1,xe=!1,Ce=null,ce=0,Z=0,ke=!0,Ae=null;try{(a=screen.orientation)!=null&&a.unlock&&screen.orientation.unlock()}catch{}}}function Le(){return oe}function fn(){const a=()=>{!Ee()&&oe&&Yt()};document.addEventListener("fullscreenchange",a),document.addEventListener("webkitfullscreenchange",a)}P&&(window.__vrDump=()=>{const a=tn();return console.debug("[VR State Snapshot]",a),a},window.__vrResetUI=()=>{console.debug("[VR Reset UI] 姝ｅ湪娓呯悊鎵€鏈?UI 鐘舵€?.."),sn(k),console.debug("[VR Reset UI] 娓呯悊瀹屾垚")},console.debug("[VR Debug] 璋冭瘯妯″紡宸插惎鐢ㄣ€備娇鐢?__vrDump() 鏌ョ湅鐘舵€侊紝浣跨敤 __vrResetUI() 澶嶄綅 UI"));mi();Js();en();Pi();fn();const Ft=()=>{const a=document;!!(document.fullscreenElement||a.webkitFullscreenElement)&&Qi()};document.addEventListener("fullscreenchange",Ft);document.addEventListener("webkitfullscreenchange",Ft);function vn(){const a=new URLSearchParams(location.search);return a.has("development")||a.get("dev")==="1"||location.hash.includes("development")}class wn{constructor(){r(this,"appElement");r(this,"config",null);r(this,"panoViewer",null);r(this,"titleBar",null);r(this,"topRightControls",null);r(this,"topModeTabs",null);r(this,"sceneTitleEl",null);r(this,"brandMark",null);r(this,"bottomDock",null);r(this,"sceneGuideDrawer",null);r(this,"guideTray",null);r(this,"museumList",null);r(this,"sceneList",null);r(this,"mapOverlay",null);r(this,"hotspots",null);r(this,"videoPlayer",null);r(this,"controlBar",null);r(this,"loading");r(this,"debugPanel",null);r(this,"configStudio",null);r(this,"qualityIndicator",null);r(this,"northCalibrationPanel",null);r(this,"currentMuseum",null);r(this,"currentScene",null);r(this,"hasBoundFullscreenEvents",!1);r(this,"mode","tour");r(this,"isStructureOverlayOpen",!1);r(this,"structureView2D",null);r(this,"structureView3D",null);r(this,"fcChatPanel",null);r(this,"infoModalMounted",null);r(this,"settingsModalMounted",null);r(this,"handlePopState",null);r(this,"handlePickEvent",null);r(this,"handlePickModeEvent",null);r(this,"handleMetricsEvent",null);r(this,"debugPanelRafId",null);r(this,"structure3DLoadToken",0);r(this,"chatInitToken",0);r(this,"uiErrorElement",null);const e=document.getElementById("app");if(!e)throw new Error("鎵句笉鍒?#app 鍏冪礌");this.appElement=e,Dt(),this.loading=new Is,this.appElement.appendChild(this.loading.getElement()),this.bindFullscreenEventsOnce(),this.init()}bindFullscreenEventsOnce(){if(this.hasBoundFullscreenEvents)return;this.hasBoundFullscreenEvents=!0;const e=()=>{var t;(t=this.topRightControls)==null||t.syncFullscreenState(),Ne()||(this.topRightControls&&!Le()&&this.topRightControls.updateVrModeState(!1),this.panoViewer&&this.panoViewer.isVrModeEnabled()&&this.panoViewer.setVrModeEnabled(!1),Ut())};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}async init(){try{if(this.loading.show(),fi()){await this.initEditorMode(),this.loading.hide();return}this.config=await ot(),De(this.config.assetCdn),this.titleBar&&this.titleBar.setTitle(this.config.appName),this.handlePopState||(this.handlePopState=()=>{this.handleRoute()},window.addEventListener("popstate",this.handlePopState)),await this.handleRoute(),this.loading.hide()}catch(e){console.error("閰嶇疆鍔犺浇澶辫触:",e),this.loading.hide(),e.validationErrors&&Array.isArray(e.validationErrors)?this.showConfigErrorPanel(e.validationErrors):this.showError("鍔犺浇閰嶇疆澶辫触锛岃鍒锋柊椤甸潰閲嶈瘯")}}async initEditorMode(){try{this.config=await ot(),De(this.config.assetCdn),this.appElement.innerHTML="";const{ConfigStudio:e}=await K(async()=>{const{ConfigStudio:t}=await import("./editor-debug-BvJzBnAe.js").then(i=>i.C);return{ConfigStudio:t}},__vite__mapDeps([2,3]),import.meta.url);this.configStudio=new e(this.config,t=>{this.config=t,De(t.assetCdn),at()}),this.appElement.appendChild(this.configStudio.getElement())}catch(e){console.error("鍒濆鍖栫紪杈戝櫒妯″紡澶辫触:",e),e.validationErrors&&Array.isArray(e.validationErrors)?this.showConfigErrorPanel(e.validationErrors):this.showError("鍔犺浇閰嶇疆澶辫触锛岃鍒锋柊椤甸潰閲嶈瘯")}}showConfigErrorPanel(e){this.appElement.innerHTML="";const t=new Ls(e,()=>{at(),window.location.reload()},()=>{this.showConfigExample()});this.appElement.appendChild(t.getElement())}showConfigExample(){const e=window.open("","_blank");e&&e.document.write(`
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>config.json 绀轰緥</title>
          <style>
            body {
              font-family: 'Courier New', monospace;
              padding: 20px;
              background: #1a1a1a;
              color: #fff;
            }
            pre {
              background: #0f0f0f;
              padding: 20px;
              border-radius: 8px;
              overflow-x: auto;
            }
            code {
              color: #4a90e2;
            }
          </style>
        </head>
        <body>
          <h1>config.json 绀轰緥閰嶇疆</h1>
          <pre><code>{
  "appName": "搴旂敤鍚嶇О",
  "museums": [
    {
      "id": "museum_id",
      "name": "灞曢鍚嶇О",
      "cover": "https://example.com/cover.jpg",
      "map": {
        "image": "https://example.com/map.jpg",
        "width": 1000,
        "height": 600
      },
      "scenes": [
        {
          "id": "scene_id",
          "name": "鍦烘櫙鍚嶇О",
          "panoLow": "https://example.com/pano-low.jpg",
          "pano": "https://example.com/pano.jpg",
          "thumb": "https://example.com/thumb.jpg",
          "initialView": {
            "yaw": 0,
            "pitch": 0,
            "fov": 75
          },
          "mapPoint": {
            "x": 420,
            "y": 310
          },
          "hotspots": [
            {
              "id": "hotspot_id",
              "type": "scene",
              "label": "鐑偣鏍囩",
              "yaw": 35,
              "pitch": -5,
              "target": {
                "museumId": "museum_id",
                "sceneId": "target_scene_id",
                "yaw": 120,
                "pitch": 0
              }
            }
          ]
        }
      ]
    }
  ]
}</code></pre>
          <p>璇︾粏閰嶇疆璇存槑璇锋煡鐪?README.md</p>
        </body>
        </html>
      `)}async handleRoute(){if(!this.config)return;const e=ct();if(this.clearView(),!e.museumId){const t=this.config.museums.find(i=>i.id==="wangding")||this.config.museums[0];if(t){if(t.scenes&&t.scenes.length>0){G(t.id,t.scenes[0].id);return}Fe(t.id);return}}if(!e.museumId)this.showMuseumList();else if(e.sceneId){const t=Ye(e.museumId),i=di(e.museumId,e.sceneId);t&&i?await this.showScene(t,i):(this.showError("鏈壘鍒版寚瀹氱殑鍦烘櫙"),t?Fe(t.id):ht())}else{const t=Ye(e.museumId);t?this.showSceneList(t):(this.showError("鏈壘鍒版寚瀹氱殑灞曢"),ht())}}showMuseumList(){this.config&&(this.titleBar=new vt(this.config.appName),this.appElement.appendChild(this.titleBar.getElement()),this.museumList=new ss(this.config.museums),this.appElement.appendChild(this.museumList.getElement()))}showSceneList(e){this.titleBar=new vt(e.name),this.appElement.appendChild(this.titleBar.getElement());const t=document.createElement("div");t.className="scene-list-page",t.innerHTML=`
      <div class="scene-list-container">
        <h1 class="scene-list-title">${e.name} - 鍦烘櫙鍒楄〃</h1>
        ${e.description?`<p class="scene-list-desc">${e.description}</p>`:""}
        <div class="scene-grid">
          ${e.scenes.map(s=>`
            <div class="scene-card" data-scene-id="${s.id}">
              <div class="scene-cover">
                <img src="${s.thumb}" alt="${s.name}" loading="lazy">
                <div class="scene-overlay">
                  <h2 class="scene-name">${s.name}</h2>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `;const i=document.createElement("style");i.textContent=`
      .scene-list-page {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding-top: calc(44px + env(safe-area-inset-top, 0px));
      }
      .scene-list-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .scene-list-title {
        font-size: 24px;
        font-weight: 600;
        color: #fff;
        text-align: center;
        margin-bottom: 30px;
      }
      .scene-list-desc {
        max-width: 820px;
        margin: -12px auto 26px;
        color: rgba(255,255,255,0.92);
        font-size: 15px;
        line-height: 1.6;
        text-align: center;
      }
      .scene-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }
      .scene-card {
        cursor: pointer;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
      }
      .scene-card:active {
        transform: scale(0.98);
      }
      .scene-cover {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
        overflow: hidden;
      }
      .scene-cover img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .scene-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        padding: 15px;
        color: #fff;
      }
      .scene-name {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }
    `,document.head.appendChild(i),t.querySelectorAll(".scene-card").forEach(s=>{s.addEventListener("click",()=>{const o=s.getAttribute("data-scene-id");o&&G(e.id,o)})}),this.appElement.appendChild(t)}async showScene(e,t){var f,v,w;this.currentMuseum=e,this.currentScene=t,this.loading.show();const i=document.createElement("div");i.className="viewer-container",i.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    `,this.appElement.appendChild(i);const s=gi();this.panoViewer=new is(i,s);const o=vn();try{this.topRightControls=new Ps({viewerRootEl:i,onTogglePickMode:o?()=>this.panoViewer?(this.panoViewer.isPickModeEnabled()?this.panoViewer.disablePickMode():this.panoViewer.enablePickMode(),this.panoViewer.isPickModeEnabled()):!1:void 0,onOpenNorthCalibration:o?()=>{this.openNorthCalibration(t.id)}:void 0,showNorthCalibration:o,onToggleVrMode:async()=>this.toggleVrModeFromUI(i)}),this.appElement.appendChild(this.topRightControls.getElement())}catch(p){P&&console.debug("[showScene] TopRightControls 鍒涘缓澶辫触锛岃烦杩?",p),this.topRightControls=null}this.sceneTitleEl=document.createElement("div"),this.sceneTitleEl.className="vr-scenetitle",this.sceneTitleEl.textContent=t.name||((f=this.config)==null?void 0:f.appName)||"VR Player",this.appElement.appendChild(this.sceneTitleEl),this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickEvent=p=>{const g=p,{x:b,y:E,yaw:M,pitch:L}=g.detail;if(js({yaw:M,pitch:L,ts:Date.now()}),U(`宸插鍒?yaw: ${M.toFixed(2)}, pitch: ${L.toFixed(2)}`),this.panoViewer){const A=this.panoViewer.getDomElement();Ws(A,b,E)}},window.addEventListener("vr:pick",this.handlePickEvent),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.handlePickModeEvent=p=>{const g=p;this.panoViewer&&!g.detail.enabled&&this.panoViewer.isPickModeEnabled()&&this.panoViewer.disablePickMode()},window.addEventListener("vr:pickmode",this.handlePickModeEvent);try{if(this.appElement.querySelector(".vr-brandmark"))P&&console.debug("[showScene] BrandMark 宸插瓨鍦紝璺宠繃閲嶅鍒涘缓");else{this.brandMark=new Ds({appName:(v=this.config)==null?void 0:v.appName,brandText:"榧庤檸娓呮簮"});const g=this.brandMark.getElement();g.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),this.openDingHuQingYuan()}),this.appElement.appendChild(g)}}catch(p){P&&console.debug("[showScene] BrandMark 鍒涘缓澶辫触锛岃烦杩?",p),this.brandMark=null}if(s){const{DebugPanel:p}=await K(async()=>{const{DebugPanel:b}=await import("./editor-debug-BvJzBnAe.js").then(E=>E.D);return{DebugPanel:b}},__vite__mapDeps([2,3]),import.meta.url);this.debugPanel=new p,this.appElement.appendChild(this.debugPanel.getElement()),this.panoViewer.setOnDebugClick((b,E,M,L,A)=>{this.debugPanel&&this.debugPanel.show(b,E,M,L,A)}),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null);const g=()=>{if(this.debugPanel&&this.panoViewer){const b=this.panoViewer.getCurrentView();this.debugPanel.updateView(b.yaw,b.pitch,b.fov)}this.debugPanelRafId=requestAnimationFrame(g)};g()}try{this.videoPlayer=new Es,this.appElement.appendChild(this.videoPlayer.getElement())}catch(p){P&&console.debug("[showScene] VideoPlayer 鍒涘缓澶辫触锛岃烦杩?",p),this.videoPlayer=null}try{this.guideTray=new Us({museumId:e.id,currentSceneId:t.id,scenes:e.scenes,onSceneClick:p=>{G(e.id,p)},onMoreClick:()=>{if(!this.sceneGuideDrawer)try{this.sceneGuideDrawer=new Hs({museumId:e.id,currentSceneId:t.id,scenes:e.scenes,onClose:()=>{}}),this.appElement.appendChild(this.sceneGuideDrawer.getElement())}catch(p){P&&console.debug("[GuideTray] SceneGuideDrawer 鍒涘缓澶辫触:",p)}this.guideTray&&this.guideTray.setVisible(!1),this.sceneGuideDrawer&&this.sceneGuideDrawer.open()},onClose:()=>{this.guideTray&&this.guideTray.setVisible(!1),window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"guide"}}))}}),this.guideTray.setVisible(!1),this.appElement.appendChild(this.guideTray.getElement())}catch(p){P&&console.debug("[showScene] GuideTray 鍒涘缓澶辫触锛岃烦杩?",p),this.guideTray=null}try{this.bottomDock=new Os({onGuideClick:()=>{this.guideTray&&this.guideTray.setVisible(!0)},onOpenInfo:()=>this.openInfoModal(),onOpenSettings:()=>this.openSettingsModal(),sceneId:t.id,sceneName:t.name,museum:e,scenes:e.scenes,currentSceneId:t.id}),this.appElement.appendChild(this.bottomDock.getElement())}catch(p){P&&console.debug("[showScene] BottomDock 鍒涘缓澶辫触锛岃烦杩?",p),this.bottomDock=null}try{this.topModeTabs=new $s({initialMode:this.mode,onModeChange:p=>{this.setMode(p)}}),this.appElement.appendChild(this.topModeTabs.getElement())}catch(p){P&&console.debug("[showScene] TopModeTabs 鍒涘缓澶辫触锛岃烦杩?",p),this.topModeTabs=null}try{const p=new Map(e.scenes.map(g=>[g.id,g.name]));this.hotspots=new bs(this.panoViewer,t.hotspots,{resolveSceneName:g=>p.get(g),onEnterScene:g=>{G(e.id,g)},museumId:e.id}),i.appendChild(this.hotspots.getElement())}catch(p){P&&console.debug("[showScene] Hotspots 鍒涘缓澶辫触锛岃烦杩?",p),this.hotspots=null}try{this.qualityIndicator=new Ai,this.appElement.appendChild(this.qualityIndicator.getElement())}catch(p){P&&console.debug("[showScene] QualityIndicator 鍒涘缓澶辫触锛岃烦杩?",p),this.qualityIndicator=null}this.handleMetricsEvent&&(window.removeEventListener("vr:metrics",this.handleMetricsEvent),this.handleMetricsEvent=null),this.handleMetricsEvent=p=>{if(!this.qualityIndicator)return;const g=p.detail||{};this.qualityIndicator.updateMetrics(g)},window.addEventListener("vr:metrics",this.handleMetricsEvent),this.panoViewer.setOnStatusChange(p=>{this.qualityIndicator&&this.qualityIndicator.updateStatus(p),(p===S.LOW_READY||p===S.HIGH_READY||p===S.DEGRADED)&&this.loading.hide()}),this.panoViewer.setOnLoad(()=>{this.loading.hide(),this.hideUIError(),this.preloadNextScene(e,t)}),this.panoViewer.setOnError(p=>{console.error("鍔犺浇鍦烘櫙澶辫触:",p),this.loading.hide(),this.showError("加载全景图失败，请检查网络连接"),this.qualityIndicator&&this.qualityIndicator.updateStatus(S.ERROR)});const n=ct(),c=n.yaw!==void 0?n.yaw:t.initialView.yaw||0,l=n.pitch!==void 0?n.pitch:t.initialView.pitch||0,d=n.fov!==void 0?n.fov:t.initialView.fov||75,u=-c;this.panoViewer.setView(u,l,d),this.panoViewer.loadScene(t),this.panoViewer.setSceneData(e.id,t.id,t.hotspots),this.chatInitToken+=1;const h=this.chatInitToken,m=(w=this.config)==null?void 0:w.fcChat;m!=null&&m.endpoint&&m.endpoint.trim()&&(g=>{typeof window.requestIdleCallback=="function"?window.requestIdleCallback(()=>g(),{timeout:800}):window.setTimeout(g,0)})(async()=>{if(h===this.chatInitToken&&!(!this.currentScene||this.currentScene.id!==t.id))try{const[{FcChatPanel:g},{FcChatClient:b}]=await Promise.all([K(()=>import("./chat-community-JW1G0t1K.js").then(L=>L.F),__vite__mapDeps([4,5]),import.meta.url),K(()=>import("./chat-community-JW1G0t1K.js").then(L=>L.f),__vite__mapDeps([4,5]),import.meta.url)]);if(h!==this.chatInitToken)return;const E={endpoint:m.endpoint,authToken:m.authToken,timeoutMs:15e3},M=new b(E);this.fcChatPanel=new g(M,{museumId:e.id,sceneId:t.id,sceneTitle:t.name,museumName:e.name,url:window.location.href})}catch(g){P&&console.debug("[showScene] FcChatPanel 鍒涘缓澶辫触锛岃烦杩?",g),this.fcChatPanel=null}})}preloadNextScene(e,t){const s=(e.scenes.findIndex(n=>n.id===t.id)+1)%e.scenes.length,o=e.scenes[s];if(o&&o.thumb){const n=Y(o.thumb,O.THUMB);if(n){const c=new Image;c.referrerPolicy="no-referrer",c.crossOrigin="anonymous",c.loading="lazy",c.decoding="async",c.src=pe(n)}}}clearView(){if(this.chatInitToken+=1,this.structure3DLoadToken+=1,this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.handleMetricsEvent&&(window.removeEventListener("vr:metrics",this.handleMetricsEvent),this.handleMetricsEvent=null),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null),this.panoViewer&&(this.panoViewer.dispose(),this.panoViewer=null),this.titleBar&&(this.titleBar.remove(),this.titleBar=null),this.topRightControls&&(this.topRightControls.remove(),this.topRightControls=null),this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),this.topModeTabs&&(this.topModeTabs.getElement().remove(),this.topModeTabs=null),this.sceneTitleEl&&(this.sceneTitleEl.remove(),this.sceneTitleEl=null),this.brandMark&&(this.brandMark.remove(),this.brandMark=null),this.bottomDock&&(this.bottomDock.remove(),this.bottomDock=null),this.guideTray&&(this.guideTray.remove(),this.guideTray=null),this.sceneGuideDrawer&&(this.sceneGuideDrawer.remove(),this.sceneGuideDrawer=null),this.museumList&&(this.museumList.remove(),this.museumList=null),this.sceneList&&(this.sceneList.remove(),this.sceneList=null),this.mapOverlay&&(this.mapOverlay.remove(),this.mapOverlay=null),this.hotspots&&(this.hotspots.remove(),this.hotspots=null),this.videoPlayer&&(this.videoPlayer.remove(),this.videoPlayer=null),this.controlBar&&(this.controlBar.remove(),this.controlBar=null),this.debugPanel&&(this.debugPanel.remove(),this.debugPanel=null),this.configStudio&&(this.configStudio.remove(),this.configStudio=null),this.qualityIndicator&&(this.qualityIndicator.remove(),this.qualityIndicator=null),this.structureView2D){const e=this.structureView2D.getElement();e&&e.parentNode&&e.parentNode.removeChild(e),this.structureView2D=null}if(this.structureView3D){const e=this.structureView3D.getElement();e&&e.parentNode&&e.parentNode.removeChild(e),this.structureView3D=null}this.isStructureOverlayOpen=!1,this.fcChatPanel&&(this.fcChatPanel.remove(),this.fcChatPanel=null),this.mode="tour",this.appElement.innerHTML="",this.appElement.appendChild(this.loading.getElement())}hideUIError(){this.uiErrorElement&&this.uiErrorElement.parentNode&&(this.uiErrorElement.parentNode.removeChild(this.uiErrorElement),this.uiErrorElement=null)}setMode(e){this.mode!==e&&(this.mode,this.mode=e,this.topModeTabs&&this.topModeTabs.setMode(e),e==="tour"&&this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),e==="structure2d"?this.openStructure2D():e==="structure3d"&&this.openStructure3D())}openStructure2D(){if(!this.currentMuseum||!this.currentScene)return;this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1});const e=Et(this.currentMuseum,this.currentScene.id);this.structureView2D?this.structureView2D.updateContext({museum:this.currentMuseum,graph:e,currentSceneId:this.currentScene.id}):(this.structureView2D=new Bs({museum:this.currentMuseum,graph:e,currentSceneId:this.currentScene.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(t,i)=>{this.closeStructureOverlay({toTour:!1}),G(t,i)}}),this.appElement.appendChild(this.structureView2D.getElement())),this.isStructureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView2D.open()}async openStructure3D(){if(!this.currentMuseum||!this.currentScene)return;this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),this.structure3DLoadToken+=1;const e=this.structure3DLoadToken,t=Et(this.currentMuseum,this.currentScene.id);if(this.structureView3D){if(e!==this.structure3DLoadToken||this.mode!=="structure3d")return;this.structureView3D.updateContext({museum:this.currentMuseum,graph:t,currentSceneId:this.currentScene.id})}else{const{StructureView3D:i}=await K(async()=>{const{StructureView3D:s}=await import("./dock-panels-ByTJbHA4.js").then(o=>o.S);return{StructureView3D:s}},__vite__mapDeps([0,1]),import.meta.url);if(e!==this.structure3DLoadToken||this.mode!=="structure3d")return;this.structureView3D=new i({museum:this.currentMuseum,graph:t,currentSceneId:this.currentScene.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(s,o)=>{this.closeStructureOverlay({toTour:!1}),G(s,o)}}),this.appElement.appendChild(this.structureView3D.getElement())}this.isStructureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView3D.open()}closeStructureOverlay(e){if(this.isStructureOverlayOpen){if(this.structure3DLoadToken+=1,this.isStructureOverlayOpen=!1,this.structureView2D){const t=this.structureView2D.getElement();t&&t.parentNode&&t.parentNode.removeChild(t),this.structureView2D=null}if(this.structureView3D){const t=this.structureView3D.getElement();t&&t.parentNode&&t.parentNode.removeChild(t),this.structureView3D=null}document.body.style.overflow="",document.body.style.touchAction="",document.body.style.overscrollBehavior="",e.toTour&&(this.mode="tour",this.topModeTabs&&this.topModeTabs.setMode("tour"))}}async openNorthCalibration(e){if(this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),!this.panoViewer){console.warn("[openNorthCalibration] PanoViewer 鏈垵濮嬪寲");return}try{const{NorthCalibrationPanel:t}=await K(async()=>{const{NorthCalibrationPanel:i}=await import("./editor-debug-BvJzBnAe.js").then(s=>s.N);return{NorthCalibrationPanel:i}},__vite__mapDeps([2,3]),import.meta.url);this.northCalibrationPanel=new t({getCurrentYaw:()=>{var s;const i=(s=this.panoViewer)==null?void 0:s.getCurrentView();return(i==null?void 0:i.yaw)??0},sceneId:e,onClose:()=>{this.northCalibrationPanel=null}})}catch(t){console.error("[openNorthCalibration] 鍒涘缓鏍″噯闈㈡澘澶辫触:",t),this.northCalibrationPanel=null}}showError(e){this.hideUIError(),this.uiErrorElement=document.createElement("div"),this.uiErrorElement.className="error-message",this.uiErrorElement.textContent=e,this.uiErrorElement.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 16px;
      text-align: center;
      max-width: 80vw;
    `,this.appElement.appendChild(this.uiErrorElement),setTimeout(()=>{this.hideUIError()},3e3)}openDingHuQingYuan(){if(this.brandMark)try{this.brandMark.getAboutModal().open()}catch(e){P&&console.debug("[openDingHuQingYuan] 鎵撳紑鍥㈤槦浠嬬粛澶辫触:",e)}}openInfoModal(){var o,n,c;(o=this.infoModalMounted)==null||o.close(),this.infoModalMounted=null;const e=((n=this.currentMuseum)==null?void 0:n.name)||"-",t=((c=this.currentScene)==null?void 0:c.name)||"-",i=document.createElement("div");i.className="vr-modal-info-list",i.innerHTML=`
      <div><span class="vr-modal-info-row-label">灞曢</span><span>${e}</span></div>
      <div><span class="vr-modal-info-row-label">鍦烘櫙</span><span>${t}</span></div>
      <div><span class="vr-modal-info-row-label">閲囬泦鏃堕棿</span><span> 2025-12-27</span></div>
      <div class="vr-modal-info-copyright">
        <button type="button" role="button" class="vr-modal-info-copyright-btn">漏 2025 榧庤檸娓呮簮</button>
      </div>
    `;const s=i.querySelector(".vr-modal-info-copyright-btn");s&&s.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.infoModalMounted&&this.infoModalMounted.close(),setTimeout(()=>{this.openDingHuQingYuan()},0)}),this.infoModalMounted=Pe({title:"淇℃伅",contentEl:i,onClose:()=>{this.infoModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"info"}}))}})}async toggleVrModeFromUI(e){if(!this.panoViewer)return!1;if(Le())return Yt(),this.panoViewer.setVrModeEnabled(!1),this.topRightControls&&this.topRightControls.updateVrModeState(!1),await je(),!1;{try{await Ht(e)}catch(o){return P&&console.debug("[VRMode] fullscreen request failed",o),!1}const i=this.panoViewer.getCurrentView();return pn(()=>{var o;return((o=this.panoViewer)==null?void 0:o.isInteracting())??!1}),await gn((o,n)=>{if(this.panoViewer){const c=i.yaw+o,l=Math.max(-90,Math.min(90,i.pitch+n));this.panoViewer.setView(c,l)}})?(this.panoViewer.setVrModeEnabled(!0),this.topRightControls&&this.topRightControls.updateVrModeState(!0),!0):(await je(),!1)}}openSettingsModal(){var x;(x=this.settingsModalMounted)==null||x.close(),this.settingsModalMounted=null;const e=Vt(),t=Ot(),i=ze(),s=document.createElement("div");s.className="vr-modal-settings-list";const o=document.createElement("div");o.className="vr-modal-settings-item-label",o.textContent="鐢昏川";const n=document.createElement("div");n.className="vr-modal-settings-quality";const c=document.createElement("button");c.className="vr-modal-settings-quality-btn",c.textContent="楂樻竻",c.dataset.level="high";const l=document.createElement("button");l.className="vr-modal-settings-quality-btn",l.textContent="鐪佹祦",l.dataset.level="low";const d=C=>{c.classList.toggle("is-active",C==="high"),l.classList.toggle("is-active",C==="low")};d(i);const u=C=>{!this.currentScene||!this.panoViewer||ze()===C||(_i(C),d(C),this.panoViewer.loadScene(this.currentScene,{preserveView:!0}))};c.addEventListener("click",()=>u("high")),l.addEventListener("click",()=>u("low")),n.appendChild(c),n.appendChild(l);const h=document.createElement("div");h.appendChild(o),h.appendChild(n);const m=document.createElement("div");m.className="vr-modal-settings-item-label",m.textContent="瑙嗚";const f=document.createElement("button");f.className="vr-modal-settings-row-btn",f.type="button",f.textContent="鎭㈠鍒濆瑙嗚",f.addEventListener("click",()=>{if(!this.currentScene||!this.panoViewer)return;const C=this.currentScene.initialView||{yaw:0,pitch:0,fov:75},j=-(C.yaw||0),X=C.pitch||0,Q=C.fov??75;this.panoViewer.setView(j,X,Q)});const v=document.createElement("div");v.appendChild(m),v.appendChild(f);const w=document.createElement("div");w.className="vr-modal-settings-item-label",w.textContent="VR 鐪奸暅";const p=document.createElement("button");p.className="vr-modal-settings-row-btn",p.type="button",p.textContent="VR 鐪奸暅";const g=()=>{const C=Le();p.classList.toggle("is-on",C)};if(e)g(),p.addEventListener("click",async()=>{if(!this.panoViewer)return;const C=this.panoViewer.getDomElement(),_=await this.toggleVrModeFromUI(C);Le(),g()});else if(t){p.classList.add("is-disabled");const C=()=>{U("移动端可体验此功能",1500)};p.addEventListener("mouseenter",C),p.addEventListener("click",C)}const b=document.createElement("div");b.appendChild(w),b.appendChild(p);const E=document.createElement("div");E.className="vr-modal-settings-item-label",E.textContent="缂╂斁";const M=document.createElement("div");M.className="vr-modal-settings-quality",M.style.gap="8px";const L=document.createElement("button");L.className="vr-modal-settings-quality-btn",L.textContent="缂╁皬",L.style.minWidth="70px";const A=document.createElement("button");A.className="vr-modal-settings-quality-btn",A.textContent="鏀惧ぇ",A.style.minWidth="70px";const R=()=>{if(!this.panoViewer)return;const C=this.panoViewer.getCurrentView(),_=Math.min(120,C.fov*1.12);this.panoViewer.setFov(_)},ge=()=>{if(!this.panoViewer)return;const C=this.panoViewer.getCurrentView(),_=Math.max(30,C.fov/1.12);this.panoViewer.setFov(_)};L.addEventListener("click",R),A.addEventListener("click",ge),M.appendChild(L),M.appendChild(A);const I=document.createElement("div");I.appendChild(E),I.appendChild(M),s.appendChild(h),s.appendChild(v),s.appendChild(I),s.appendChild(b),this.bottomDock&&this.bottomDock.setMoreOpen(!0),this.settingsModalMounted=Pe({title:"鏇村",contentEl:s,panelClassName:"vr-modal-settings",onClose:()=>{this.bottomDock&&this.bottomDock.setMoreOpen(!1),this.settingsModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"settings"}}))}})}}new wn;"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").catch(()=>{})});export{O as A,Ms as E,K as _,zs as a,Ss as b,Mn as c,As as d,ve as e,Fs as f,In as g,k as i,G as n,St as o,Y as r,U as s,hi as v};
