const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./three-extras-9r4FsFIk.js","./three-core-0fX1SOzE.js"])))=>i.map(i=>d[i]);
var x=Object.defineProperty;var N=(d,e,t)=>e in d?x(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var n=(d,e,t)=>N(d,typeof e!="symbol"?e+"":e,t);import{o as z,_ as v,e as y}from"./index-WSGeQALx.js";import{S as R,P as F,W as k,V as W,A as L,D as _,aV as O,d as X,M as V,R as S,e as A}from"./three-core-0fX1SOzE.js";class q{constructor(e,t,s,o,a,c){n(this,"scene");n(this,"camera");n(this,"renderer");n(this,"container");n(this,"controls");n(this,"sceneNodes",new Map);n(this,"currentSceneId",null);n(this,"animationId",null);n(this,"museumId");n(this,"museum",null);n(this,"scenes");n(this,"onSceneClick");n(this,"unsubscribeFocus",null);n(this,"hoveredSceneId",null);n(this,"focusAnimation",null);n(this,"handleWindowResize",null);n(this,"animate",()=>{this.animationId=requestAnimationFrame(this.animate),this.controls&&this.controls.update(),this.focusAnimation&&(this.focusAnimation.progress+=.05,this.focusAnimation.progress>=1?(this.camera.position.copy(this.focusAnimation.target),this.camera.lookAt(0,0,0),this.controls&&this.controls.update(),this.focusAnimation=null):(this.camera.position.lerpVectors(this.focusAnimation.start,this.focusAnimation.target,this.focusAnimation.progress),this.camera.lookAt(0,0,0)));const e=Date.now()*.001;this.sceneNodes.forEach(t=>{if(t.userData.isCurrent){const s=Math.sin(e*2)*.1+1;t.scale.set(s*1.2,s*1.2,s*1.2);const o=t.material;o.opacity=.6+Math.sin(e*2)*.2}}),this.renderer.render(this.scene,this.camera)});this.container=e,this.museumId=t,this.museum=c||null,this.scenes=s,this.currentSceneId=o,this.onSceneClick=a,this.scene=new R,this.scene.background=null,this.camera=new F(50,e.clientWidth/e.clientHeight,.1,1e3),this.camera.position.set(0,5,10),this.camera.lookAt(0,0,0),this.renderer=new k({antialias:!0,alpha:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),e.appendChild(this.renderer.domElement),this.initControls(),this.generateNodes(),this.setupLighting(),this.animate(),this.handleWindowResize=()=>this.handleResize(),window.addEventListener("resize",this.handleWindowResize),this.unsubscribeFocus=z(i=>{this.handleSceneFocus(i)})}handleSceneFocus(e){if(e.type==="focus"&&e.source!=="dollhouse"){const t=this.sceneNodes.get(e.sceneId);if(t){const s=t.position.clone(),o=new W(s.x*.3,s.y+3,s.z+8);this.focusAnimation={target:o,start:this.camera.position.clone(),progress:0}}}}async initControls(){try{const{OrbitControls:e}=await v(async()=>{const{OrbitControls:t}=await import("./three-extras-9r4FsFIk.js").then(s=>s.i);return{OrbitControls:t}},__vite__mapDeps([0,1]),import.meta.url);this.controls=new e(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=3,this.controls.maxDistance=30,this.controls.maxPolarAngle=Math.PI/2.2,this.controls.minPolarAngle=Math.PI/6}catch(e){console.warn("Failed to load OrbitControls:",e)}}setupLighting(){const e=new L(16777215,.6);this.scene.add(e);const t=new _(16777215,.4);t.position.set(5,10,5),this.scene.add(t)}generateNodes(){this.sceneNodes.forEach(t=>{this.scene.remove(t),t.geometry.dispose(),Array.isArray(t.material)?t.material.forEach(s=>s.dispose()):t.material.dispose()}),this.sceneNodes.clear();const e=this.calculateLayout();this.scenes.forEach((t,s)=>{const o=e[s],a=this.createSceneNode(t,o,t.id===this.currentSceneId);this.sceneNodes.set(t.id,a),this.scene.add(a)})}calculateLayout(){var o,a,c,i;const e=[],t=this.scenes.filter(r=>r.mapPoint);if(t.length>0){const r=((a=(o=this.museum)==null?void 0:o.map)==null?void 0:a.width)||1e3,h=((i=(c=this.museum)==null?void 0:c.map)==null?void 0:i.height)||600;let m=1/0,u=-1/0,p=1/0,f=-1/0;t.forEach(l=>{l.mapPoint&&(m=Math.min(m,l.mapPoint.x),u=Math.max(u,l.mapPoint.x),p=Math.min(p,l.mapPoint.y),f=Math.max(f,l.mapPoint.y))});const w=u-m||r,I=f-p||h,C=w>0?10/w:.01,M=I>0?10/I:.01,P=(m+u)/2,b=(p+f)/2;for(const l of this.scenes)if(l.mapPoint)e.push({x:(l.mapPoint.x-P)*C,y:0,z:(l.mapPoint.y-b)*M});else{const g=Math.ceil(Math.sqrt(this.scenes.length)),E=Math.floor(e.length/g),D=e.length%g;e.push({x:(D-g/2)*2,y:0,z:(E-g/2)*2})}}else{const r=Math.ceil(Math.sqrt(this.scenes.length));for(let h=0;h<this.scenes.length;h++){const m=Math.floor(h/r),u=h%r;e.push({x:(u-r/2)*2,y:0,z:(m-r/2)*2})}}return e}createSceneNode(e,t,s){const o=new O(1,1,1),a=s?4886754:8947848,c=new X({color:a,opacity:s?.8:.5,transparent:!0,metalness:.1,roughness:.7}),i=new V(o,c);return i.position.set(t.x,t.y,t.z),i.userData={sceneId:e.id,sceneName:e.name},i.userData.onClick=()=>{this.onSceneClick&&this.onSceneClick(this.museumId,e.id)},s&&(i.userData.isCurrent=!0,i.scale.set(1.2,1.2,1.2)),i}handleResize(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}updateCurrentScene(e){this.currentSceneId=e,this.generateNodes()}updateScenes(e,t){this.scenes=e,this.currentSceneId=t,this.generateNodes()}setOnSceneClick(e){this.onSceneClick=e}handleClick(e){const t=this.renderer.domElement.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*2-1,o=-((e.clientY-t.top)/t.height)*2+1,a=new S;a.setFromCamera(new A(s,o),this.camera);const c=a.intersectObjects(Array.from(this.sceneNodes.values()));if(c.length>0){const i=c[0].object,r=i.userData.sceneId;y({type:"focus",museumId:this.museumId,sceneId:r,source:"dollhouse",ts:Date.now()}),i.userData.onClick&&i.userData.onClick()}}handleMouseMove(e){const t=this.renderer.domElement.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*2-1,o=-((e.clientY-t.top)/t.height)*2+1,a=new S;a.setFromCamera(new A(s,o),this.camera);const c=a.intersectObjects(Array.from(this.sceneNodes.values()));if(this.sceneNodes.forEach(i=>{const r=i.material;i.userData.isCurrent||(r.opacity=.5)}),c.length>0){const i=c[0].object,r=i.material,h=i.userData.sceneId;i.userData.isCurrent||(r.opacity=.7),this.hoveredSceneId!==h&&(this.hoveredSceneId=h,y({type:"hover",museumId:this.museumId,sceneId:h,source:"dollhouse",ts:Date.now()})),this.renderer.domElement.style.cursor="pointer"}else this.hoveredSceneId!==null&&(this.hoveredSceneId=null,y({type:"hover",museumId:this.museumId,sceneId:null,source:"dollhouse",ts:Date.now()})),this.renderer.domElement.style.cursor="default"}getDomElement(){return this.renderer.domElement}dispose(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.handleWindowResize&&(window.removeEventListener("resize",this.handleWindowResize),this.handleWindowResize=null),this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=null),this.sceneNodes.forEach(e=>{this.scene.remove(e),e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()}),this.sceneNodes.clear(),this.renderer.dispose(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.controls&&this.controls.dispose()}}export{q as DollhouseScene};
