var S=Object.defineProperty;var P=(h,t,e)=>t in h?S(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var c=(h,t,e)=>P(h,typeof t!="symbol"?t+"":t,e);import{aN as v,a2 as f,a1 as C,e as M,aO as R,aP as Y,j as g,aQ as D,r as H,aR as T,aS as k,V as A}from"./three.module-Brkpord5.js";import{C as y,S as V}from"./three-renderer-DqCmgmK_.js";import{f as w}from"./index-B-fNAr7w.js";function E(h=512){const t=document.createElement("canvas");t.width=h,t.height=h;const e=t.getContext("2d");if(!e){const l=new y(t);return l.needsUpdate=!0,l}const i=h/2,n=h/2,s=h/2*.92;e.clearRect(0,0,h,h);const d=e.createRadialGradient(i,n,s*.25,i,n,s);d.addColorStop(0,"rgba(0,0,0,0.00)"),d.addColorStop(.55,"rgba(0,0,0,0.18)"),d.addColorStop(1,"rgba(0,0,0,0.55)"),e.fillStyle=d,e.beginPath(),e.arc(i,n,s,0,Math.PI*2),e.closePath(),e.fill(),e.fillStyle="rgba(0,0,0,0.55)",e.beginPath(),e.arc(i,n,s*.28,0,Math.PI*2),e.closePath(),e.fill();const r=e.createRadialGradient(i,n,0,i,n,s*.42);r.addColorStop(0,"rgba(0,0,0,0.22)"),r.addColorStop(1,"rgba(0,0,0,0.00)"),e.fillStyle=r,e.beginPath(),e.arc(i,n,s*.42,0,Math.PI*2),e.closePath(),e.fill(),e.translate(i,n);for(let l=0;l<360;l+=30){const p=l*Math.PI/180,o=l%90===0,b=o?s*.12:s*.07,u=o?2:1;e.strokeStyle=o?"rgba(255,255,255,0.25)":"rgba(255,255,255,0.14)",e.lineWidth=u,e.beginPath(),e.moveTo(Math.sin(p)*(s-b),-Math.cos(p)*(s-b)),e.lineTo(Math.sin(p)*s,-Math.cos(p)*s),e.stroke()}e.restore(),e.strokeStyle="rgba(255,255,255,0.08)",e.lineWidth=2,e.beginPath(),e.arc(i,n,s,0,Math.PI*2),e.closePath(),e.stroke();const a=new y(t);return a.colorSpace=V,a.rotation=0,a.flipY=!1,a.needsUpdate=!0,a}function N(h){return Math.max(0,Math.min(1,h))}function I(h){const t=N(h);return t*t*(3-2*t)}class B{constructor(t,e){c(this,"mesh");c(this,"needleMesh",null);c(this,"texture");c(this,"radius");c(this,"opacity",0);c(this,"northYaw",0);c(this,"debugHelper",null);c(this,"labelSprites",new Map);c(this,"patchRadius",0);c(this,"showPitchDeg",-45);c(this,"fadeRangeDeg",18);c(this,"fadeTauMs",140);c(this,"lastRotationY",0);c(this,"debugFrameCount",0);c(this,"isDebugVisible",!0);this.radius=e;const i=e*.18;this.patchRadius=i;const n=new v(i,96);n.rotateX(Math.PI/2),this.texture=E(512);const s=new f({map:this.texture,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1,side:C});this.mesh=new M(n,s),this.mesh.name="NadirPatch-compass-disk",this.mesh.position.set(0,-e+.5,0),this.mesh.renderOrder=9999,this.mesh.visible=!1,this.mesh.rotation.y=0,t.add(this.mesh);const d=i*.008,r=i*.35,a=new R(d,d,r,8);a.rotateX(Math.PI/2),a.translate(0,0,r/2);const l=new f({color:16777215,transparent:!0,opacity:.9,depthTest:!1,depthWrite:!1});if(this.needleMesh=new M(a,l),this.needleMesh.name="NadirPatch-compass-needle",this.needleMesh.position.set(0,-e+.51,0),this.needleMesh.rotation.order="YXZ",this.needleMesh.renderOrder=1e4,this.needleMesh.visible=!1,t.add(this.needleMesh),this.createLabelSprites(t,i,e),w&&(s.color.setHex(65535),this.debugHelper=new Y(i*.5),this.debugHelper.position.copy(this.mesh.position),this.debugHelper.renderOrder=10001,t.add(this.debugHelper),console.debug("[NadirPatch] 对象已创建:",{uuid:this.mesh.uuid,name:this.mesh.name,type:this.mesh.type,position:this.mesh.position,rotation:this.mesh.rotation})),typeof window<"u"){const p=o=>{(o.key==="N"||o.key==="n")&&!(o.target instanceof HTMLInputElement||o.target instanceof HTMLTextAreaElement)&&(o.preventDefault(),this.isDebugVisible=!this.isDebugVisible,this.mesh.visible=this.isDebugVisible&&this.opacity>.01,this.needleMesh&&(this.needleMesh.visible=this.isDebugVisible&&this.opacity>.01),this.debugHelper&&(this.debugHelper.visible=this.isDebugVisible&&this.opacity>.01),console.debug(`[NadirPatch] 显示状态切换为: ${this.isDebugVisible?"显示":"隐藏"}`))};window.addEventListener("keydown",p)}}setNorthYaw(t){this.northYaw=t}update(t,e,i){var u;const n=e.yaw,s=this.northYaw??0,d=g.degToRad(-s);this.mesh.rotation.y=d,this.texture.rotation=0,this.texture.center.set(.5,.5);const r=-s;this.updateLabelSprites(r),this.needleMesh&&(this.needleMesh.rotation.y=g.degToRad(n)),w&&(this.debugFrameCount++,this.debugFrameCount%30===0&&(Math.abs(this.mesh.rotation.y-this.lastRotationY)>.001&&console.debug("[NadirPatch] 旋转变化:",{frame:this.debugFrameCount,cameraYaw:n.toFixed(2),northYaw:s.toFixed(2),needleYaw:n.toFixed(2),diskRotationY:this.mesh.rotation.y,needleRotationY:(u=this.needleMesh)==null?void 0:u.rotation.y,diskPosition:this.mesh.position}),this.lastRotationY=this.mesh.rotation.y));const l=I((this.showPitchDeg-e.pitch)/this.fadeRangeDeg),p=1-Math.exp(-(i||16.7)/this.fadeTauMs);this.opacity=this.opacity+(l-this.opacity)*p;const o=this.mesh.material;o.opacity=this.opacity;const b=this.isDebugVisible&&this.opacity>.01;if(this.mesh.visible=b,this.needleMesh){this.needleMesh.visible=b;const m=this.needleMesh.material;m.opacity=this.opacity*.9}this.labelSprites.forEach(m=>{m.visible=b;const x=m.material;x.opacity=this.opacity*.85}),this.debugHelper&&(this.debugHelper.visible=b)}createLabelSprites(t,e,i){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:s})=>{const d=document.createElement("canvas"),r=128;d.width=r,d.height=r;const a=d.getContext("2d");if(!a)return;a.clearRect(0,0,r,r),a.save(),a.shadowColor="rgba(255, 255, 255, 0.8)",a.shadowBlur=8,a.shadowOffsetX=0,a.shadowOffsetY=0,a.fillStyle="rgba(255, 255, 255, 0.85)",a.font=`600 ${Math.round(r*.5)}px system-ui, -apple-system, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif`,a.textAlign="center",a.textBaseline="middle",a.fillText(s,r/2,r/2),a.restore();const l=new D(d);l.colorSpace=H,l.needsUpdate=!0;const p=new T({map:l,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1}),o=new k(p);o.name=`NadirPatch-label-${s}`,o.position.set(0,-i+.52,0),o.renderOrder=10001,o.visible=!1;const b=e*.15;o.scale.set(b,b,1),t.add(o),this.labelSprites.set(s,o)})}updateLabelSprites(t){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:i,baseAngle:n})=>{const s=this.labelSprites.get(i);if(!s)return;const d=n+t,r=this.patchRadius*.56,a=g.degToRad(d),l=-this.radius+.5,p=Math.sin(a)*r,o=Math.cos(a)*r;s.position.set(p,l+.02,o);const b=new A(0,0,0);s.lookAt(b)})}dispose(t){t.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose(),this.needleMesh&&(t.remove(this.needleMesh),this.needleMesh.geometry.dispose(),this.needleMesh.material.dispose()),this.labelSprites.forEach(e=>{t.remove(e),e.material.dispose(),e.material.map&&e.material.map.dispose()}),this.labelSprites.clear(),this.debugHelper&&(t.remove(this.debugHelper),this.debugHelper.dispose())}}export{B as NadirPatch};
