var a=Object.defineProperty;var r=(s,e,t)=>e in s?a(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var i=(s,e,t)=>r(s,typeof e!="symbol"?e+"":e,t);const n=typeof window<"u"&&"requestIdleCallback"in window?window.requestIdleCallback:null,d=typeof window<"u"&&"cancelIdleCallback"in window?window.cancelIdleCallback:null;function h(){const e=navigator.connection,t=(e==null?void 0:e.effectiveType)||"",u=!!(e!=null&&e.saveData),l=(e==null?void 0:e.downlink)||0;return u||t.includes("2g")?{maxConcurrent:1,staggerMs:260,idleTimeoutMs:2200}:t.includes("3g")||l<1.5?{maxConcurrent:1,staggerMs:180,idleTimeoutMs:1800}:l>0&&l<5?{maxConcurrent:2,staggerMs:140,idleTimeoutMs:1500}:{maxConcurrent:3,staggerMs:100,idleTimeoutMs:1200}}class c{constructor(){i(this,"disposed",!1);i(this,"started",!1);i(this,"queue",[]);i(this,"active",0);i(this,"budget",h());i(this,"idleHandle",null);i(this,"timerHandle",null)}schedule(e,t="idle"){if(!(this.disposed||this.started||e.length===0)){if(this.started=!0,this.queue=e.slice(),t==="immediate"){this.pump();return}this.startWhenIdle()}}dispose(){this.disposed=!0,this.queue=[],this.idleHandle!==null&&(n&&d?d(this.idleHandle):clearTimeout(this.idleHandle),this.idleHandle=null),this.timerHandle!==null&&(clearTimeout(this.timerHandle),this.timerHandle=null)}startWhenIdle(){if(!this.disposed){if(n&&d){this.idleHandle=n(()=>{this.idleHandle=null,this.pump()},{timeout:this.budget.idleTimeoutMs});return}this.idleHandle=window.setTimeout(()=>{this.idleHandle=null,this.pump()},220)}}pump(){if(!this.disposed)for(;this.active<this.budget.maxConcurrent&&this.queue.length>0;){const e=this.queue.shift();e&&(this.active+=1,Promise.resolve(e()).catch(()=>{}).finally(()=>{this.active=Math.max(0,this.active-1),!this.disposed&&(this.queue.length===0&&this.active===0||(this.timerHandle!==null&&clearTimeout(this.timerHandle),this.timerHandle=window.setTimeout(()=>{this.timerHandle=null,this.pump()},this.budget.staggerMs)))}))}}}export{c as W};
