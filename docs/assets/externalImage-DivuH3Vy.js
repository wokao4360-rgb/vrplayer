function I(t){try{const n=new URL(t).hostname;if(n==="i.ibb.co"||n==="s41.ax1x.com")return`/_img?u=${encodeURIComponent(t)}`}catch{}return t}class g extends Error{constructor(i,n,o){super(n),this.url=i,this.originalError=o,this.name="ExternalImageLoadError"}}let E=0;const $=[];function T(t){return new Promise((i,n)=>{const o=async()=>{E++;try{const l=await t();i(l)}catch(l){n(l)}finally{E--,$.length>0&&$.shift()()}};E<2?o():$.push(o)})}async function M(t,i,n,o,l,h="from-image"){let c=null;for(let s=0;s<=n;s++){const e=new AbortController,w=setTimeout(()=>e.abort(),i);try{const u={mode:"cors",referrerPolicy:"no-referrer",signal:e.signal};l&&(u.priority=l);const r=await fetch(t,u);if(clearTimeout(w),!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const m=await r.blob();return await createImageBitmap(m,{imageOrientation:h,premultiplyAlpha:"none"})}catch(u){if(clearTimeout(w),c=u instanceof Error?u:new Error(String(u)),s<n){const r=o*Math.pow(2,s);console.warn(`外链图片 fetch 重试 ${s+1}/${n+1}: ${t}`,c.message),await new Promise(m=>setTimeout(m,r))}}}throw new g(t,`fetch 加载失败（${n+1} 次尝试）: ${(c==null?void 0:c.message)||"未知错误"}`,c||void 0)}async function b(t,i={}){const{timeoutMs:n=15e3,retries:o=2,retryBaseDelayMs:l=300,referrerPolicy:h="no-referrer",crossOrigin:c="anonymous",priority:s}=i,e=I(t);return T(async()=>new Promise((w,u)=>{let r=null,m=0,y=null,f=null;const p=()=>{m++;const a=new Image;f=a,a.decoding="async",a.referrerPolicy=h,a.crossOrigin=c,s&&(a.fetchPriority=s),r!==null&&(clearTimeout(r),r=null),r=window.setTimeout(()=>{if(r=null,y=new Error("加载超时"),f&&(f.onload=null,f.onerror=null,f=null),m<=o){const d=l*Math.pow(2,m-1);console.warn(`外链图片加载超时重试 ${m}/${o+1}: ${e}`),setTimeout(p,d)}else u(new g(t,`加载超时（${o+1} 次尝试）`,y))},n),a.onload=()=>{r!==null&&(clearTimeout(r),r=null),a.complete&&a.naturalWidth>0?w(a):setTimeout(()=>w(a),0)},a.onerror=d=>{if(r!==null&&(clearTimeout(r),r=null),y=new Error("图片加载失败"),f===a&&(f.onload=null,f.onerror=null,f=null),m<=o){const x=l*Math.pow(2,m-1);console.warn(`外链图片加载失败重试 ${m}/${o+1}: ${e}`,d),setTimeout(p,x)}else u(new g(t,`图片加载失败（${o+1} 次尝试）`,y))},a.src=e};p()}))}async function B(t,i={}){const{timeoutMs:n=15e3,retries:o=2,retryBaseDelayMs:l=300,allowFetchFallback:h=!1,imageOrientation:c="from-image"}=i,s=I(t);return T(async()=>{try{const e=await b(s,i);return await createImageBitmap(e,{imageOrientation:c,premultiplyAlpha:"none"})}catch(e){if(h){console.warn(`Image() 加载失败，尝试 fetch 兜底: ${s}`,e);try{return await M(s,n,o,l,i.priority,c)}catch{throw e instanceof g?e:new g(t,`Image() 和 fetch 均失败: ${e instanceof Error?e.message:String(e)}`,e instanceof Error?e:void 0)}}else throw e instanceof g?e:new g(t,`Image() 加载失败: ${e instanceof Error?e.message:String(e)}`,e instanceof Error?e:void 0)}})}export{g as ExternalImageLoadError,B as loadExternalImageBitmap,b as loadExternalImageElement,I as toProxiedImageUrl};
