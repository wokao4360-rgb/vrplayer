const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./structure3d-runtime-IYB4uYxD.js","./index-DLhNDJoj.js","./three.module-BpE9LMaq.js","./autoLayout-ZgSeGcPI.js","./sceneGraph-CaQzl5R8.js","./index-BfJu72vJ.css","./chat-community-Bh7n16cj.js","./store-B83L8bDT.js","./dollhouseScene-CGpe51EF.js"])))=>i.map(i=>d[i]);
var E=Object.defineProperty;var y=(h,e,t)=>e in h?E(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var s=(h,e,t)=>y(h,typeof e!="symbol"?e+"":e,t);import{_ as d,i as f,o as b,e as m,n as v}from"./index-DLhNDJoj.js";class g{constructor(e){s(this,"element");s(this,"container");s(this,"museum");s(this,"graph");s(this,"currentSceneId");s(this,"onClose");s(this,"onNodeClick");s(this,"statusEl",null);s(this,"webglErrorEl",null);s(this,"modelErrorEl",null);s(this,"runtime",null);s(this,"runtimeModulePromise",null);s(this,"runtimeInitPromise",null);s(this,"opened",!1);s(this,"disposed",!1);s(this,"handleKeyDown",e=>{e.key==="Escape"&&this.close()});this.museum=e.museum,this.graph=e.graph,this.currentSceneId=e.currentSceneId,this.onClose=e.onClose,this.onNodeClick=e.onNodeClick,this.element=document.createElement("div"),this.element.className="vr-structure3d-overlay",this.container=document.createElement("div"),this.container.className="vr-structure3d-canvas",this.render(),this.ensureRuntime()}getElement(){return this.element}updateContext(e){var t;this.museum=e.museum,this.graph=e.graph,this.currentSceneId=e.currentSceneId,(t=this.runtime)==null||t.updateContext(e),this.updateStatusText("loading")}open(){this.element.classList.add("is-visible"),this.opened=!0,document.addEventListener("keydown",this.handleKeyDown),this.ensureRuntime().then(()=>{var e;this.disposed||!this.opened||((e=this.runtime)==null||e.open(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{var t;(t=this.runtime)==null||t.open()})}))})}close(){var e;this.element.classList.remove("is-visible"),this.opened=!1,document.removeEventListener("keydown",this.handleKeyDown),(e=this.onClose)==null||e.call(this)}remove(){var e;this.disposed||(this.disposed=!0,this.opened=!1,document.removeEventListener("keydown",this.handleKeyDown),(e=this.runtime)==null||e.dispose(),this.runtime=null,this.element.remove())}render(){const e=document.createElement("div");e.className="vr-structure3d-header";const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="4px";const n=document.createElement("div");n.className="vr-structure3d-title",n.textContent="三维模型",this.statusEl=document.createElement("div"),this.statusEl.className="vr-structure3d-status",this.updateStatusText("loading");const i=document.createElement("button");i.className="vr-btn vr-structure3d-close",i.innerHTML="✕",i.setAttribute("aria-label","关闭"),i.addEventListener("click",()=>{this.close()}),t.appendChild(n),t.appendChild(this.statusEl),e.appendChild(t),e.appendChild(i),this.webglErrorEl=document.createElement("div"),this.webglErrorEl.className="vr-structure3d-webgl-error",this.webglErrorEl.style.display="none",this.webglErrorEl.innerHTML=`
      <div style="text-align: center; padding: 40px 20px;">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">WebGL 不可用</div>
        <div style="font-size: 13px; opacity: 0.8;">请尝试更换浏览器或设备</div>
      </div>
    `,this.modelErrorEl=document.createElement("div"),this.modelErrorEl.className="vr-structure3d-model-error",this.modelErrorEl.style.display="none",this.modelErrorEl.innerHTML=`
      <div style="text-align: center; padding: 40px 20px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: rgba(255,200,100,0.95);">模型加载失败</div>
        <div style="font-size: 13px; opacity: 0.8;">请检查 URL 或网络连接</div>
      </div>
    `,this.element.appendChild(e),this.element.appendChild(this.container),this.element.appendChild(this.webglErrorEl),this.element.appendChild(this.modelErrorEl)}async ensureRuntime(){if(this.runtime||this.disposed)return;if(this.runtimeInitPromise){await this.runtimeInitPromise;return}const e=(async()=>{const{StructureSceneRuntime:t}=await this.loadRuntimeModule();if(this.disposed)return;const n=new t({container:this.container,museum:this.museum,graph:this.graph,currentSceneId:this.currentSceneId,onNodeClick:this.onNodeClick,onStatusChange:l=>{this.updateStatusText(l.modelStatus,l.nodeCount,l.edgeCount,l.width,l.height)},onWebGlUnavailable:()=>{this.webglErrorEl&&(this.webglErrorEl.style.display="block")},onModelError:l=>{this.modelErrorEl&&(this.modelErrorEl.style.display=l?"block":"none")}});if(!await n.init()||this.disposed){n.dispose();return}this.runtime=n,this.opened&&n.open()})().finally(()=>{this.runtimeInitPromise===e&&(this.runtimeInitPromise=null)});this.runtimeInitPromise=e,await e}loadRuntimeModule(){return this.runtimeModulePromise||(this.runtimeModulePromise=d(()=>import("./structure3d-runtime-IYB4uYxD.js"),__vite__mapDeps([0,1,2,3,4,5]),import.meta.url)),this.runtimeModulePromise}updateStatusText(e="loading",t=0,n=0,i=0,l=0){if(this.statusEl){if(t===0){this.statusEl.textContent=`model: ${e}, no nodes`,this.statusEl.style.color="rgba(255,200,100,0.9)";return}this.statusEl.textContent=`model: ${e}, nodes: ${t}, edges: ${n}, size: ${i}x${l}`,this.statusEl.style.color="rgba(255,255,255,0.65)"}}}const _=Object.freeze(Object.defineProperty({__proto__:null,StructureView3D:g},Symbol.toStringTag,{value:"Module"}));class S{constructor(e){s(this,"element");s(this,"currentTab");s(this,"sceneId");s(this,"sceneName");s(this,"museum");s(this,"scenes");s(this,"currentSceneId");s(this,"communityPanel",null);s(this,"mapPanel",null);s(this,"dollhousePanel",null);s(this,"handleClosePanels",null);s(this,"handlePanelClickCapture",null);s(this,"renderToken",0);this.currentTab=e.initialTab,this.sceneId=e.sceneId,this.sceneName=e.sceneName,this.museum=e.museum,this.scenes=e.scenes,this.currentSceneId=e.currentSceneId||e.sceneId,this.element=document.createElement("div"),this.element.className="vr-panl vr-glass hidden",this.handlePanelClickCapture=()=>{f.emitUIEngaged()},this.element.addEventListener("click",this.handlePanelClickCapture,!0),this.handleClosePanels=()=>{this.closeAllPanels()},window.addEventListener("vr:close-panels",this.handleClosePanels),this.render()}disposeCommunityPanel(){this.communityPanel&&(this.communityPanel.remove(),this.communityPanel=null)}disposeMapPanel(){this.mapPanel&&(this.mapPanel.remove(),this.mapPanel=null)}disposeDollhousePanel(){this.dollhousePanel&&(this.dollhousePanel.remove(),this.dollhousePanel=null)}async ensureCommunityPanel(){const e=this.sceneId||"unknown";if(this.communityPanel)this.communityPanel.setScene(e,this.sceneName);else{const{CommunityPanel:t}=await d(async()=>{const{CommunityPanel:n}=await import("./chat-community-Bh7n16cj.js").then(i=>i.C);return{CommunityPanel:n}},__vite__mapDeps([6,7,1,5]),import.meta.url);this.communityPanel=new t({sceneId:e,sceneName:this.sceneName,onClose:()=>{this.disposeCommunityPanel(),this.element.classList.add("hidden"),this.element.innerHTML=""}})}return this.communityPanel}async ensureMapPanel(e){if(!this.museum||!this.scenes||this.scenes.length===0)return null;if(this.mapPanel)this.mapPanel.updateCurrentScene(e);else{const{MapPanel:t}=await d(async()=>{const{MapPanel:n}=await Promise.resolve().then(()=>w);return{MapPanel:n}},void 0,import.meta.url);this.mapPanel=new t({museum:this.museum,scenes:this.scenes,currentSceneId:e,onClose:()=>{window.dispatchEvent(new CustomEvent("vr:close-panels"))}})}return this.mapPanel}async ensureDollhousePanel(e){if(!this.museum||!this.scenes||this.scenes.length===0)return null;if(this.dollhousePanel)this.dollhousePanel.updateCurrentScene(e);else{const{Dollhouse3DPanel:t}=await d(async()=>{const{Dollhouse3DPanel:n}=await Promise.resolve().then(()=>L);return{Dollhouse3DPanel:n}},void 0,import.meta.url);this.dollhousePanel=new t({museum:this.museum,scenes:this.scenes,currentSceneId:e,onClose:()=>{window.dispatchEvent(new CustomEvent("vr:close-panels"))}})}return this.dollhousePanel}async render(){var t,n,i,l;const e=++this.renderToken;if(this.element.classList.remove("vr-panel--community","vr-panel--map","vr-panel--dollhouse"),!this.currentTab){this.element.classList.add("hidden"),this.element.innerHTML="",this.disposeCommunityPanel(),this.disposeMapPanel(),this.disposeDollhousePanel();return}if(this.currentTab==="community"){this.element.classList.add("vr-panel--community"),this.element.innerHTML="",this.disposeMapPanel(),this.disposeDollhousePanel();const a=await this.ensureCommunityPanel();if(!a||e!==this.renderToken||this.currentTab!=="community")return;this.element.appendChild(a.getElement());return}if(this.currentTab==="map"){this.element.classList.add("vr-panel--map"),this.element.innerHTML="",this.disposeCommunityPanel(),this.disposeDollhousePanel();const a=this.currentSceneId||this.sceneId||((n=(t=this.scenes)==null?void 0:t[0])==null?void 0:n.id);if(!a){this.element.innerHTML=`
          <div class="vr-panel-title">平面图</div>
          <div class="vr-panel-body">此展馆暂无平面图</div>
        `;return}const o=await this.ensureMapPanel(a);if(!o||e!==this.renderToken||this.currentTab!=="map")return;this.element.appendChild(o.getElement());return}if(this.currentTab==="dollhouse"){this.element.classList.add("vr-panel--dollhouse"),this.element.innerHTML="",this.disposeCommunityPanel(),this.disposeMapPanel();const a=this.currentSceneId||this.sceneId||((l=(i=this.scenes)==null?void 0:i[0])==null?void 0:l.id);if(!a){this.element.innerHTML=`
          <div class="vr-panel-title">三维图</div>
          <div class="vr-panel-body">此展馆暂无三维图</div>
        `;return}const o=await this.ensureDollhousePanel(a);if(!o||e!==this.renderToken||this.currentTab!=="dollhouse")return;this.element.appendChild(o.getElement());return}this.disposeCommunityPanel(),this.disposeMapPanel(),this.disposeDollhousePanel(),this.element.classList.add("hidden"),this.element.innerHTML=""}setSceneContext(e,t){this.sceneId=e,this.sceneName=t,this.currentSceneId=e,this.currentTab==="community"&&(this.communityPanel?this.communityPanel.setScene(e,t):this.render()),this.currentTab==="map"&&(this.mapPanel?this.mapPanel.updateCurrentScene(e):this.render()),this.currentTab==="dollhouse"&&(this.dollhousePanel?this.dollhousePanel.updateCurrentScene(e):this.render())}setMuseumContext(e,t,n){this.museum=e,this.scenes=t,this.currentSceneId=n,this.currentTab==="map"&&(this.mapPanel?this.mapPanel.updateMuseum(e,t,n):this.render()),this.currentTab==="dollhouse"&&(this.dollhousePanel?this.dollhousePanel.updateMuseum(e,t,n):this.render())}setVisible(e){this.element.classList.remove("hidden","visible"),this.element.classList.add(e?"visible":"hidden")}setTab(e){this.currentTab=e,this.setVisible(!1),window.setTimeout(()=>{this.render(),this.setVisible(!0)},40)}closeAllPanels(){this.renderToken+=1,this.currentTab=null,this.disposeCommunityPanel(),this.disposeMapPanel(),this.disposeDollhousePanel(),this.element.classList.add("hidden"),this.element.innerHTML=""}getElement(){return this.element}remove(){this.renderToken+=1,this.handleClosePanels&&(window.removeEventListener("vr:close-panels",this.handleClosePanels),this.handleClosePanels=null),this.handlePanelClickCapture&&(this.element.removeEventListener("click",this.handlePanelClickCapture,!0),this.handlePanelClickCapture=null),this.disposeCommunityPanel(),this.disposeMapPanel(),this.disposeDollhousePanel(),this.element.remove()}}const x=Object.freeze(Object.defineProperty({__proto__:null,DockPanels:S},Symbol.toStringTag,{value:"Module"}));class T{constructor(e){s(this,"element");s(this,"museum");s(this,"scenes");s(this,"currentSceneId");s(this,"onClose");s(this,"mapContainer");s(this,"mapImage");s(this,"pointsContainer");s(this,"unsubscribeFocus",null);this.museum=e.museum,this.scenes=e.scenes,this.currentSceneId=e.currentSceneId,this.onClose=e.onClose,this.element=document.createElement("div"),this.element.className="vr-map-panel",this.render()}render(){const e=document.createElement("div");e.className="vr-map-header";const t=document.createElement("div");t.className="vr-map-title",t.textContent="平面图";const n=document.createElement("button");n.className="vr-btn vr-map-close",n.innerHTML="✕",n.setAttribute("aria-label","关闭"),n.addEventListener("click",()=>{this.onClose&&this.onClose()}),e.appendChild(t),e.appendChild(n),this.mapContainer=document.createElement("div"),this.mapContainer.className="vr-map-container",this.mapImage=document.createElement("img"),this.mapImage.className="vr-map-image",this.mapImage.src=this.museum.map.image,this.mapImage.alt=`${this.museum.name} 平面图`,this.mapImage.style.width="100%",this.mapImage.style.height="auto",this.mapImage.style.display="block",this.pointsContainer=document.createElement("div"),this.pointsContainer.className="vr-map-points",this.mapContainer.appendChild(this.mapImage),this.mapContainer.appendChild(this.pointsContainer);const i=document.createElement("div");i.className="vr-map-body",i.appendChild(this.mapContainer),this.element.appendChild(e),this.element.appendChild(i),this.mapImage.addEventListener("load",()=>{this.renderPoints()}),this.mapImage.complete&&this.renderPoints(),this.unsubscribeFocus=b(l=>{this.handleSceneFocus(l)})}handleSceneFocus(e){if(e.type==="focus"&&e.source!=="map"){const t=this.pointsContainer.querySelector(`[data-scene-id="${e.sceneId}"]`);t&&(t.classList.add("vr-map-point--focus-flash"),setTimeout(()=>{t.classList.remove("vr-map-point--focus-flash")},300))}}renderPoints(){if(this.pointsContainer.innerHTML="",!this.mapImage.complete||!this.mapContainer.offsetWidth){setTimeout(()=>this.renderPoints(),100);return}const e=this.museum.map.width,t=this.museum.map.height,n=this.mapContainer.offsetWidth,i=n*t/e;this.mapContainer.style.height=`${i}px`;const l=n/e,a=i/t;this.scenes.forEach(o=>{if(!o.mapPoint)return;const r=document.createElement("button");r.className="vr-btn vr-map-point",r.setAttribute("data-scene-id",o.id),r.setAttribute("aria-label",o.name),o.id===this.currentSceneId&&r.classList.add("vr-map-point--current");const C=o.mapPoint.x*l,P=o.mapPoint.y*a;r.style.left=`${C}px`,r.style.top=`${P}px`;const c=document.createElement("div");c.className="vr-map-point-marker",r.appendChild(c);const u=document.createElement("div");u.className="vr-map-point-tooltip",u.textContent=o.name,r.appendChild(u),r.addEventListener("mouseenter",()=>{m({type:"hover",museumId:this.museum.id,sceneId:o.id,source:"map",ts:Date.now()})}),r.addEventListener("mouseleave",()=>{m({type:"hover",museumId:this.museum.id,sceneId:null,source:"map",ts:Date.now()})}),r.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),m({type:"focus",museumId:this.museum.id,sceneId:o.id,source:"map",ts:Date.now()}),v(this.museum.id,o.id),this.onClose&&this.onClose()}),this.pointsContainer.appendChild(r)})}updateCurrentScene(e){this.currentSceneId=e,this.renderPoints()}updateMuseum(e,t,n){this.museum=e,this.scenes=t,this.currentSceneId=n,this.mapImage.src=e.map.image,this.renderPoints()}getElement(){return this.element}remove(){this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=null),this.element.remove()}}const w=Object.freeze(Object.defineProperty({__proto__:null,MapPanel:T},Symbol.toStringTag,{value:"Module"}));class I{constructor(e){s(this,"element");s(this,"museum");s(this,"scenes");s(this,"currentSceneId");s(this,"onClose");s(this,"container");s(this,"dollhouseScene",null);s(this,"initToken",0);s(this,"handleCanvasClick",null);s(this,"handleCanvasMove",null);this.museum=e.museum,this.scenes=e.scenes,this.currentSceneId=e.currentSceneId,this.onClose=e.onClose,this.element=document.createElement("div"),this.element.className="vr-dollhouse-panel",this.render()}render(){const e=document.createElement("div");e.className="vr-dollhouse-header";const t=document.createElement("div");t.className="vr-dollhouse-title",t.textContent="三维图";const n=document.createElement("button");n.className="vr-btn vr-dollhouse-close",n.innerHTML="✕",n.setAttribute("aria-label","关闭"),n.addEventListener("click",()=>{this.onClose&&this.onClose()}),e.appendChild(t),e.appendChild(n),this.container=document.createElement("div"),this.container.className="vr-dollhouse-container";const i=document.createElement("div");i.className="vr-dollhouse-body",i.appendChild(this.container),this.element.appendChild(e),this.element.appendChild(i),this.initDollhouseScene()}teardownDollhouseScene(){if(!this.dollhouseScene)return;const e=this.dollhouseScene.getDomElement();this.handleCanvasClick&&(e.removeEventListener("click",this.handleCanvasClick),this.handleCanvasClick=null),this.handleCanvasMove&&(e.removeEventListener("mousemove",this.handleCanvasMove),this.handleCanvasMove=null),this.dollhouseScene.dispose(),this.dollhouseScene=null}async initDollhouseScene(){this.initToken+=1;const e=this.initToken;this.teardownDollhouseScene();const{DollhouseScene:t}=await d(async()=>{const{DollhouseScene:l}=await import("./dollhouseScene-CGpe51EF.js");return{DollhouseScene:l}},__vite__mapDeps([8,1,2,5]),import.meta.url);if(e!==this.initToken)return;const n=new t(this.container,this.museum.id,this.scenes,this.currentSceneId,(l,a)=>{v(l,a),this.onClose&&this.onClose()},this.museum);if(e!==this.initToken){n.dispose();return}this.dollhouseScene=n;const i=this.dollhouseScene.getDomElement();this.handleCanvasClick=l=>{var a;(a=this.dollhouseScene)==null||a.handleClick(l)},this.handleCanvasMove=l=>{var a;(a=this.dollhouseScene)==null||a.handleMouseMove(l)},i.addEventListener("click",this.handleCanvasClick),i.addEventListener("mousemove",this.handleCanvasMove)}updateCurrentScene(e){this.currentSceneId=e,this.dollhouseScene&&this.dollhouseScene.updateCurrentScene(e)}updateMuseum(e,t,n){this.museum=e,this.scenes=t,this.currentSceneId=n,this.dollhouseScene?this.dollhouseScene.updateScenes(t,n):this.initDollhouseScene()}getElement(){return this.element}remove(){this.initToken+=1,this.teardownDollhouseScene(),this.element.remove()}}const L=Object.freeze(Object.defineProperty({__proto__:null,Dollhouse3DPanel:I},Symbol.toStringTag,{value:"Module"}));export{x as D,_ as S};
