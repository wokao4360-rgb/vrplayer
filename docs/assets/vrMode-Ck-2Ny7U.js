import{V as v,j as i,aM as F,Q as b}from"./three.module-Brkpord5.js";import{s as T,l as O}from"./index-CntEWe8z.js";let a=!1,c=null,m=null,w=null,g=!1,s=0,r=0,p=!0;const x=new v(0,0,1),I=new F,A=new b,C=new b(-Math.sqrt(.5),0,0,Math.sqrt(.5)),h=new b,Q=new v(0,0,-1),z=new v(0,1,0);let M=null;function L(){const e=screen.orientation,t=e&&typeof e.angle=="number"?e.angle:typeof window.orientation=="number"?window.orientation:0;return i.degToRad(t||0)}function S(e,t,o){const n=i.degToRad(e||0),u=i.degToRad(t||0),P=i.degToRad(o||0),d=L();return I.set(u,n,-P,"YXZ"),h.setFromEuler(I),h.multiply(C),h.multiply(A.setFromAxisAngle(x,-d)),h.clone()}function y(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function B(e,t,o){e=y(e),t=y(t);let n=t-e;return n>Math.PI&&(n-=2*Math.PI),n<-Math.PI&&(n+=2*Math.PI),y(e+n*o)}function N(){return/iPhone|iPad|iPod/i.test(navigator.userAgent)}async function Y(){if(!N())return!0;if(typeof DeviceOrientationEvent.requestPermission=="function")try{return await DeviceOrientationEvent.requestPermission()==="granted"}catch(e){return console.warn("[VRMode] iOS permission request failed:",e),!1}return!0}function X(e){M=e}async function j(e){var o;if(a)return!0;if(!await Y())return T("未获得陀螺仪权限，无法进入VR模式"),!1;g=!1,w=null,s=0,r=0,p=!0,m=e;try{(o=screen.orientation)!=null&&o.lock&&await screen.orientation.lock("landscape")}catch{}return c=n=>{if(!a||!m||n.alpha===null||n.beta===null||n.gamma===null)return;const u=S(n.alpha,n.beta,n.gamma);if(!g){w=u.clone(),g=!0;return}if(M&&M())return;const P=w.clone().invert(),d=u.clone().multiply(P),R=Q.clone().applyQuaternion(d),q=z.clone().applyQuaternion(d);let f=Math.atan2(R.x,-R.z);f=-f;let l=Math.atan2(q.z,q.y);l=-l;const D=i.degToRad(85);l=Math.max(-D,Math.min(D,l)),p?(s=f,r=l,p=!1):(s=B(s,f,.15),r=r+(l-r)*.2);const V=i.radToDeg(s),k=i.radToDeg(r);m(V,k)},window.addEventListener("deviceorientation",c),a=!0,!0}function E(){var e;if(a){c&&(window.removeEventListener("deviceorientation",c),c=null),m=null,a=!1,g=!1,w=null,s=0,r=0,p=!0,M=null;try{(e=screen.orientation)!=null&&e.unlock&&screen.orientation.unlock()}catch{}}}async function Z(e){return a?(E(),!1):await j(e)}function G(){return a}function J(){const e=()=>{!O()&&a&&E()};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}export{E as disableVrMode,j as enableVrMode,J as initVrMode,G as isVrModeEnabled,X as setInteractingCallback,Z as toggleVrMode};
