const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./NadirPatch-Hks7_dwJ.js","./three.module-BpE9LMaq.js","./three-renderer-DqCmgmK_.js","./index-DLhNDJoj.js","./index-BfJu72vJ.css","./tile-ktx2-C_kom5yP.js","./externalImage-Cn8sVw7v.js","./three-extras-DfqxZlMR.js","./qualityPreference-BRkZdVpy.js"])))=>i.map(i=>d[i]);
var ue=Object.defineProperty;var me=(m,e,t)=>e in m?ue(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var a=(m,e,t)=>me(m,typeof e!="symbol"?e+"":e,t);import{i as M,n as pe,o as ge,d as g,e as H,r as x,A as R,L as f,_ as ae,s as re}from"./index-DLhNDJoj.js";import{R as fe,V as we,M as C,C as Y,a as T,L as z,S as G,s as B,b as ce,c as $,d as V,e as ve,f as be,P as ye,g as oe,A as Le,N as Me,W as Se}from"./three-renderer-DqCmgmK_.js";import{g as Ie}from"./qualityPreference-BRkZdVpy.js";import{loadExternalImageBitmap as _,ExternalImageLoadError as Pe}from"./externalImage-Cn8sVw7v.js";function Te(m,e,t){const s=(m-t.left)/t.width*2-1,i=-((e-t.top)/t.height*2-1);return{x:s,y:i}}function ke(m,e,t,s=500){const i=new fe;i.setFromCamera(new we(m,e),t);const r=i.ray.direction;if(!r||r.length()===0)return null;const o=r.normalize(),h=Math.asin(Math.max(-1,Math.min(1,o.y))),n=C.radToDeg(h),l=Math.atan2(o.x,o.z);return{yaw:C.radToDeg(l),pitch:n}}const Q=-55,De=-90;function q(m){const e=Math.max(0,Math.min(1,(m-Q)/(De-Q))),t=e,s=-e*8,i=1-e*.7,r=e*2;return{opacity:t,translateY:s,scaleY:i,blur:r,clarity:e}}function Z(m){return m<=Q}class Ce{constructor(e={}){a(this,"root");a(this,"disk");a(this,"mask");a(this,"polemask");a(this,"northLabel");a(this,"eastLabel");a(this,"southLabel");a(this,"westLabel");a(this,"needle");a(this,"currentYaw",0);a(this,"currentPitch",0);a(this,"northYaw",0);a(this,"sceneId","");a(this,"northYawLabel",null);a(this,"isVisible",!1);a(this,"unsubscribeInteracting",null);a(this,"unsubscribeIdle",null);a(this,"unsubscribeUIEngaged",null);a(this,"baseOpacity",0);this.root=document.createElement("div"),this.root.className="vr-compass",this.root.setAttribute("data-ui","CompassDisk"),this.root.style.outline="2px solid #ff00ff",this.disk=document.createElement("div"),this.disk.className="vr-compass__disk",this.disk.setAttribute("data-ui","CompassDisk-disk"),this.mask=document.createElement("div"),this.mask.className="vr-compass__mask",this.polemask=document.createElement("div"),this.polemask.className="vr-compass__polemask",this.polemask.setAttribute("aria-hidden","true"),this.northLabel=document.createElement("div"),this.northLabel.className="vr-compass__label vr-compass__label--north",this.northLabel.textContent="北",this.eastLabel=document.createElement("div"),this.eastLabel.className="vr-compass__label vr-compass__label--east",this.eastLabel.textContent="东",this.southLabel=document.createElement("div"),this.southLabel.className="vr-compass__label vr-compass__label--south",this.southLabel.textContent="南",this.westLabel=document.createElement("div"),this.westLabel.className="vr-compass__label vr-compass__label--west",this.westLabel.textContent="西",this.needle=document.createElement("div"),this.needle.className="vr-compass__needle",this.needle.setAttribute("data-ui","CompassDisk-needle"),this.northYawLabel=document.createElement("div"),this.northYawLabel.className="vr-compass__north-yaw-label",this.northYawLabel.style.cssText=`
      position: absolute;
      bottom: -20px;
      right: 10px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
      font-family: monospace;
      pointer-events: none;
      display: none;
    `,this.disk.appendChild(this.mask),this.disk.appendChild(this.polemask),this.disk.appendChild(this.northLabel),this.disk.appendChild(this.eastLabel),this.disk.appendChild(this.southLabel),this.disk.appendChild(this.westLabel),this.disk.appendChild(this.needle),this.root.appendChild(this.disk),this.root.appendChild(this.northYawLabel),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--compass-disk-rot","0deg"),this.root.style.setProperty("--compass-needle-rot","0deg"),this.root.style.setProperty("--compass-label-counter-rot","0deg"),this.setupInteractionListeners()}setupInteractionListeners(){this.unsubscribeInteracting=M.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=M.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=M.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}mount(e){e.appendChild(this.root)}setSceneId(e){this.sceneId=e,this.updateNorthYawLabel()}setNorthYaw(e){this.northYaw=e,this.updateNorthYawLabel()}updateNorthYawLabel(){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}updateYawLabel(e){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)} Yaw=${e.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,Z(t)){const i=q(t);this.baseOpacity=i.opacity,this.root.style.setProperty("--vr-ground-clarity",String(i.clarity)),this.root.style.opacity=i.opacity.toString();const r=`translateX(-50%) translateY(${i.translateY}px) scaleY(${i.scaleY})`;this.root.classList.contains("vr-ui-interacting")?this.root.style.transform=r:this.root.style.transform=r,this.root.style.setProperty("--vr-ground-base-blur",`${i.blur}px`);const o=e,n=-(this.northYaw??0),l=o;this.root.style.setProperty("--compass-disk-rot",`${n}deg`),this.root.style.setProperty("--compass-needle-rot",`${l}deg`);const u=42,d=(c,w)=>{const p=w+n,b=p+180;c.style.transform=`rotate(${p}deg) translateY(-${u}%) rotate(${b}deg)`};d(this.northLabel,0),d(this.eastLabel,270),d(this.southLabel,180),d(this.westLabel,90),this.updateYawLabel(e),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.northLabel.style.transform="",this.eastLabel.style.transform="",this.southLabel.style.transform="",this.westLabel.style.transform="",this.isVisible=!1,this.baseOpacity=0)}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=null),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=null),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=null),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}const ne=60,X=14,Ae=4,he=650,Ee=120,le=900,F=-62,xe=150;class Re{constructor(e){a(this,"root");a(this,"container");a(this,"dots",new Map);a(this,"dotYawDeg",new Map);a(this,"currentYaw",0);a(this,"currentPitch",0);a(this,"isVisible",!1);a(this,"museumId");a(this,"currentSceneId");a(this,"sceneHotspots");a(this,"hoverSceneId",null);a(this,"onNavigateToScene");a(this,"unsubscribeFocus");a(this,"lastYawDeg",0);a(this,"lastPitchDeg",0);a(this,"aimedSceneId",null);a(this,"isInteracting",!1);a(this,"unsubscribeInteracting");a(this,"unsubscribeIdle");a(this,"unsubscribeUIEngaged");a(this,"idleRecoveryTimer",null);a(this,"lastAimChangeTs",0);a(this,"autoNavTimer",null);a(this,"autoNavTargetSceneId",null);a(this,"lastAutoNavTs",0);a(this,"aimDebounceTimer",null);this.museumId=e.museumId,this.currentSceneId=e.currentSceneId,this.sceneHotspots=e.sceneHotspots,this.onNavigateToScene=e.onNavigateToScene||pe,this.root=document.createElement("div"),this.root.className="vr-groundnav",this.root.setAttribute("data-ui","GroundNavDots"),this.root.style.outline="2px solid #00ffff",this.container=document.createElement("div"),this.container.className="vr-groundnav__container",this.root.appendChild(this.container),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.unsubscribeFocus=ge(t=>{this.handleSceneFocus(t)}),this.setupInteractionListeners(),this.renderDots()}setupInteractionListeners(){this.unsubscribeInteracting=M.on("user-interacting",()=>{g("统一终止触发点: 用户交互"),this.isInteracting=!0,this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav()}),this.unsubscribeIdle=M.on("user-idle",()=>{this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.idleRecoveryTimer=window.setTimeout(()=>{if(this.idleRecoveryTimer=null,!this.root.parentNode){g("idleRecoveryTimer: component disposed, skipping");return}this.isInteracting=!1},400)}),this.unsubscribeUIEngaged=M.on("ui-engaged",()=>{g("统一终止触发点: UI 点击"),this.clearAllTimers(),this.isInteracting=!1,this.clearAimed(),this.cancelAutoNav()})}clearAimDebounce(){this.aimDebounceTimer!==null&&(window.clearTimeout(this.aimDebounceTimer),this.aimDebounceTimer=null)}clearAllTimers(){this.clearAimDebounce(),this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.autoNavTimer!==null&&(clearTimeout(this.autoNavTimer),this.autoNavTimer=null)}normalizeDeg(e){return(e%360+360)%360}shortestDeltaDeg(e,t){return(this.normalizeDeg(e)-this.normalizeDeg(t)+180)%360-180}clearAimed(){if(this.aimedSceneId!==null){const e=this.dots.get(this.aimedSceneId);e&&(e.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId)),this.aimedSceneId=null,this.clearAimDebounce(),this.emitSceneAim("clear",null)}this.cancelAutoNav()}cancelAutoNav(){if(this.autoNavTimer!=null&&(window.clearTimeout(this.autoNavTimer),this.autoNavTimer=null),this.autoNavTargetSceneId!==null){const e=this.autoNavTargetSceneId;if(e){this.removeProgress(e);const t=this.dots.get(e);t&&t.classList.remove("is-autonav","is-autonav-progress"),this.emitSceneAutoNav("cancel",e)}this.autoNavTargetSceneId=null}}removeProgress(e){const t=this.dots.get(e);if(!t)return;const s=t.querySelector(".vr-groundnav__progress");s&&t.removeChild(s)}addProgress(e){const t=this.dots.get(e);if(!t)return;this.removeProgress(e);const s=document.createElement("div");s.className="vr-groundnav__progress",s.style.setProperty("--progress-duration",`${he}ms`),t.appendChild(s),t.classList.add("is-autonav-progress")}scheduleAutoNavIfAllowed(e){if(!e){g("scheduleAutoNavIfAllowed: sceneId is missing, skipping");return}const t=Date.now();if(this.isInteracting){g("scheduleAutoNavIfAllowed: isInteracting, skipping");return}if(this.lastPitchDeg>F){g("scheduleAutoNavIfAllowed: pitch too high, skipping",this.lastPitchDeg);return}if(t-this.lastAutoNavTs<le){g("scheduleAutoNavIfAllowed: cooldown, skipping");return}if(t-this.lastAimChangeTs<Ee){g("scheduleAutoNavIfAllowed: min dwell, skipping");return}if(this.currentSceneId&&e===this.currentSceneId){g("scheduleAutoNavIfAllowed: same as current scene, skipping");return}this.autoNavTargetSceneId!==null&&this.autoNavTargetSceneId!==e&&this.cancelAutoNav(),g("scene-autonav: start",{sceneId:e}),this.autoNavTargetSceneId=e;const s=this.dots.get(e);s&&(s.classList.add("is-autonav"),this.addProgress(e)),this.emitSceneAutoNav("start",e),this.autoNavTimer=window.setTimeout(()=>{if(this.autoNavTimer=null,!this.root.parentNode){g("autoNavTimer: component disposed, skipping");return}if(!e){g("autoNavTimer: sceneId is missing, skipping");return}this.tryAutoNavigate(e)},he)}tryAutoNavigate(e){if(!e){g("tryAutoNavigate: sceneId is missing, skipping"),this.cancelAutoNav();return}if(this.isInteracting){g("tryAutoNavigate: isInteracting, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.aimedSceneId||this.aimedSceneId!==e){g("tryAutoNavigate: aimedSceneId mismatch, canceling",{aimedSceneId:this.aimedSceneId,sceneId:e}),this.cancelAutoNav(),this.clearAimed();return}if(this.lastPitchDeg>F){g("tryAutoNavigate: pitch too high, canceling",this.lastPitchDeg),this.cancelAutoNav(),this.clearAimed();return}const t=Date.now();if(t-this.lastAutoNavTs<le){g("tryAutoNavigate: cooldown, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.museumId){g("tryAutoNavigate: museumId is missing, canceling"),this.cancelAutoNav(),this.clearAimed();return}g("scene-autonav: trigger",{museumId:this.museumId,sceneId:e});const s=e;this.cancelAutoNav(),this.clearAimed(),this.lastAutoNavTs=t,window.dispatchEvent(new CustomEvent("vr:close-panels")),H({type:"focus",museumId:this.museumId,sceneId:s,source:"pano-auto",ts:t}),this.onNavigateToScene(this.museumId,s)}maybeRescheduleOrCancelByPitch(e){e>F?(this.autoNavTargetSceneId&&this.cancelAutoNav(),this.aimedSceneId&&this.clearAimed()):this.aimedSceneId&&e<=F&&!this.isInteracting&&!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(this.aimedSceneId)}emitSceneAim(e,t){if(!this.museumId){g("emitSceneAim: museumId is missing, skipping");return}g("scene-aim",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-aim",{detail:{type:e,museumId:this.museumId,sceneId:t||void 0,source:"groundnav",ts:Date.now()}}))}emitSceneAutoNav(e,t){if(!this.museumId){g("emitSceneAutoNav: museumId is missing, skipping");return}g("scene-autonav",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-autonav",{detail:{type:e,museumId:this.museumId,sceneId:t??void 0,ts:Date.now()}}))}updateAimed(e){if(this.isInteracting||!this.isVisible){this.clearAimed();return}const t=this.sceneHotspots.filter(o=>{var h;return(h=o.target)==null?void 0:h.sceneId});if(t.length===0){this.clearAimed();return}let s=null,i=1/0;t.forEach(o=>{const h=o.target.sceneId;if(h===this.currentSceneId)return;const n=o.yaw,l=Math.abs(this.shortestDeltaDeg(e,n));l<i&&(i=l,s=h)});let r=!1;if(s!==null&&(this.aimedSceneId===null?r=i<=X:s===this.aimedSceneId?r=i<=X+Ae:r=i<=X),this.isInteracting){this.clearAimed();return}if(r&&s!==null)if(this.aimedSceneId!==s){if(this.lastAimChangeTs=Date.now(),this.cancelAutoNav(),this.aimedSceneId!==null){const h=this.dots.get(this.aimedSceneId);h&&(h.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId))}this.aimedSceneId=s;const o=this.dots.get(s);o&&o.classList.add("is-aimed"),this.clearAimDebounce(),this.aimDebounceTimer=window.setTimeout(()=>{if(this.aimDebounceTimer=null,!this.root.parentNode){g("aimDebounceTimer: component disposed, skipping");return}this.aimedSceneId===s&&!this.isInteracting&&this.isVisible?(this.emitSceneAim("aim",s),this.scheduleAutoNavIfAllowed(s)):this.aimedSceneId===s&&this.clearAimed()},xe)}else!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(s);else this.clearAimed()}handleSceneFocus(e){e.type==="hover"?this.hoverSceneId=e.sceneId:e.type==="focus"&&(g("统一终止触发点: 场景切换",{sceneId:e.sceneId}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),e.sceneId&&(this.currentSceneId=e.sceneId),this.hoverSceneId=null),this.updateDotStates()}updateDotStates(){this.dots.forEach((e,t)=>{e.classList.remove("is-current","is-hover"),t===this.currentSceneId?e.classList.add("is-current"):t===this.hoverSceneId&&e.classList.add("is-hover")})}renderDots(){this.container.innerHTML="",this.dots.clear(),this.dotYawDeg.clear(),this.aimedSceneId=null,this.sceneHotspots.filter(t=>{var s;return(s=t.target)==null?void 0:s.sceneId}).forEach(t=>{const s=t.target.sceneId,i=document.createElement("div");i.className="vr-groundnav__dot",i.setAttribute("data-scene-id",s),i.setAttribute("title",t.label),this.dotYawDeg.set(s,t.yaw),i.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),M.emitUIEngaged(),H({type:"focus",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()}),window.dispatchEvent(new CustomEvent("vr:close-panels")),t.target.museumId&&t.target.sceneId?this.onNavigateToScene(t.target.museumId,t.target.sceneId):g("dot click: museumId or sceneId is missing, skipping navigation")}),i.addEventListener("mouseenter",()=>{H({type:"hover",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()})}),i.addEventListener("mouseleave",()=>{H({type:"hover",museumId:t.target.museumId,sceneId:null,source:"pano",ts:Date.now()})}),this.container.appendChild(i),this.dots.set(t.target.sceneId,i)}),this.updateDotStates(),this.updateDotPositions()}updateDotPositions(){this.sceneHotspots.filter(t=>{var s;return(s=t.target)==null?void 0:s.sceneId}).forEach(t=>{const s=this.dots.get(t.target.sceneId);if(!s)return;const i=t.yaw*Math.PI/180,r=Math.sin(i)*ne,o=-Math.cos(i)*ne;s.style.transform=`translate(${r}px, ${o}px)`})}setYawPitch(e,t){this.currentYaw=e,this.currentPitch=t;const s=Math.abs(this.lastYawDeg-e)>.1;if(this.lastYawDeg=e,this.lastPitchDeg=t,Z(t)){const r=q(t),o=String(r.clarity);this.root.style.getPropertyValue("--vr-ground-clarity")!==o&&this.root.style.setProperty("--vr-ground-clarity",o);const h=r.opacity.toString();this.root.style.opacity!==h&&(this.root.style.opacity=h);const n=`translateX(-50%) translateY(${r.translateY}px) scaleY(${r.scaleY})`;this.root.style.transform!==n&&(this.root.style.transform=n);const l=`${r.blur}px`;this.root.style.getPropertyValue("--vr-ground-base-blur")!==l&&this.root.style.setProperty("--vr-ground-base-blur",l),this.isVisible||(this.isVisible=!0),!this.isInteracting&&s&&(this.updateAimed(e),this.maybeRescheduleOrCancelByPitch(t))}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1,this.clearAimed());s&&this.updateDotPositions()}updateScene(e,t,s){if(g("统一终止触发点: 博物馆/场景切换",{museumId:e,currentSceneId:t}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),!e){g("updateScene: museumId is missing");return}this.museumId=e,this.currentSceneId=t,this.sceneHotspots=s,this.hoverSceneId=null,this.renderDots()}mount(e){e.appendChild(this.root)}dispose(){this.clearAllTimers(),this.cancelAutoNav(),this.clearAimed(),this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=void 0),this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}class Ne{constructor(e,t={}){a(this,"root");a(this,"inner");a(this,"wedge");a(this,"northTick");a(this,"needle");a(this,"currentYaw",0);a(this,"currentPitch",0);a(this,"northYaw",0);a(this,"isVisible",!1);a(this,"unsubscribeInteracting");a(this,"unsubscribeIdle");a(this,"unsubscribeUIEngaged");this.root=document.createElement("div"),this.root.className="vr-groundheading",this.root.setAttribute("data-ui","GroundHeadingMarker"),this.root.style.outline="2px solid #00ffff",this.inner=document.createElement("div"),this.inner.className="vr-groundheading__inner",this.wedge=document.createElement("div"),this.wedge.className="vr-groundheading__wedge",this.northTick=document.createElement("div"),this.northTick.className="vr-groundheading__northTick",this.needle=document.createElement("div"),this.needle.className="vr-groundheading__needle",this.inner.appendChild(this.wedge),this.inner.appendChild(this.northTick),this.inner.appendChild(this.needle),this.root.appendChild(this.inner),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--groundheading-disk-rot","0deg"),this.root.style.setProperty("--groundheading-needle-rot","0deg"),e.appendChild(this.root),this.setupInteractionListeners()}setNorthYaw(e){this.northYaw=e}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,Z(t)){const i=q(t);this.root.style.setProperty("--vr-ground-clarity",String(i.clarity)),this.root.style.opacity=i.opacity.toString(),this.root.style.transform=`translateX(-50%) translateY(${i.translateY}px) scaleY(${i.scaleY})`,this.root.style.setProperty("--vr-ground-base-blur",`${i.blur}px`);const r=e,h=-(this.northYaw??0),n=r;this.root.style.setProperty("--groundheading-disk-rot",`${h}deg`),this.root.style.setProperty("--groundheading-needle-rot",`${n}deg`),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1)}setInteracting(e){e?this.root.classList.add("vr-ui-interacting"):this.root.classList.remove("vr-ui-interacting")}setupInteractionListeners(){this.unsubscribeInteracting=M.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=M.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=M.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}const k=class k{constructor(){a(this,"element",null);a(this,"textEl",null);a(this,"hideTimer",null)}ensure(){this.element||(this.element=document.createElement("div"),this.element.className="vr-zoom-hud",this.textEl=document.createElement("div"),this.textEl.className="vr-zoom-hud__text",this.textEl.textContent="缩放 100%",this.element.appendChild(this.textEl),document.body.appendChild(this.element))}show(e){this.ensure(),!(!this.element||!this.textEl)&&(this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.textEl.textContent=`缩放 ${e}%`,this.element.classList.add("is-on"),this.hideTimer=window.setTimeout(()=>{this.hide()},600))}hide(){this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.element&&this.element.classList.remove("is-on")}static ensure(){return k.instance||(k.instance=new k),k.instance}static show(e){k.ensure().show(e)}static hide(){k.instance&&k.instance.hide()}};a(k,"instance",null);let j=k,A=null,Ye=0;const N=new Map;function _e(){return typeof Worker>"u"?null:A||(A=new Worker(new URL(""+new URL("bitmapDecode.worker-FGbDVlpY.js",import.meta.url).href,import.meta.url),{type:"module"}),A.onmessage=m=>{const{id:e,bitmap:t,error:s}=m.data||{},i=N.get(e);i&&(N.delete(e),i.timer&&window.clearTimeout(i.timer),s?i.reject(new Error(s)):t?i.resolve(t):i.reject(new Error("worker 返回空结果")))},A.onerror=()=>{N.forEach(m=>m.reject(new Error("worker error"))),N.clear()},A)}async function He(m,e={}){const t=_e();if(!t||typeof createImageBitmap>"u")return null;const s=++Ye,i=Math.max(1e3,e.timeoutMs??12e3),r=e.priority??"high",o=e.imageOrientation??"from-image";return new Promise((h,n)=>{const l={resolve:h,reject:n};l.timer=window.setTimeout(()=>{N.delete(s),n(new Error("worker decode timeout"))},i+500),N.set(s,l),t.postMessage({id:s,url:m,timeoutMs:i,priority:r,imageOrientation:o})})}class Fe{constructor(e,t,s,i=0){a(this,"maxTextureSize");a(this,"manifest",null);a(this,"canvas",null);a(this,"ctx",null);a(this,"texture",null);a(this,"mesh",null);a(this,"pendingLow",[]);a(this,"pendingHigh",[]);a(this,"activeLoads",0);a(this,"activeLowLoads",0);a(this,"activeHighLoads",0);a(this,"maxConcurrent",6);a(this,"maxHighWhileLow",2);a(this,"defaultMaxConcurrent",6);a(this,"defaultMaxHighWhileLow",2);a(this,"lastUpdate",0);a(this,"tilesMap",new Map);a(this,"highestLevel",null);a(this,"lowLevel",null);a(this,"lowReadyCount",0);a(this,"lowTotalCount",0);a(this,"lowFullyReady",!1);a(this,"highSeeded",!1);a(this,"tilesVisible",!1);a(this,"tilesLoadedCount",0);a(this,"tilesLoadingCount",0);a(this,"tilesQueuedCount",0);a(this,"tilesFailedCount",0);a(this,"tilesRetryCount",0);a(this,"lastTileUrl","");a(this,"lastError","");a(this,"lruLimit",64);a(this,"highReady",!1);a(this,"canvasScale",1);a(this,"fallbackVisible",!1);a(this,"prefetchSeeded",!1);this.scene=e,this.onFirstDraw=t,this.onHighReady=s,this.maxTextureSize=Math.max(0,i)}async load(e,t){var w;if(this.manifest=e,this.fallbackVisible=!!(t!=null&&t.fallbackVisible),this.highestLevel=e.levels.reduce((p,b)=>b.z>p.z?b:p),!this.highestLevel)throw new Error("manifest 缺少 level");this.lruLimit=Math.max(64,Math.min(this.highestLevel.cols*this.highestLevel.rows,256));const s=e.levels.filter(p=>p.z<this.highestLevel.z);this.lowLevel=s.length?s.reduce((p,b)=>b.z>p.z?b:p):null,this.lowReadyCount=0,this.lowTotalCount=this.lowLevel?this.lowLevel.cols*this.lowLevel.rows:0,this.lowFullyReady=this.lowTotalCount===0,this.highSeeded=!1,this.prefetchSeeded=!1,this.tilesVisible=!1,this.tilesLoadedCount=0,this.tilesLoadingCount=0,this.tilesQueuedCount=0,this.tilesFailedCount=0,this.tilesRetryCount=0,this.activeLoads=0,this.activeLowLoads=0,this.activeHighLoads=0;const i=this.highestLevel.cols,r=this.highestLevel.rows,o=e.tileSize,h=o*i,n=o*r;let l=h,u=n;if(this.canvasScale=1,this.maxTextureSize>0&&(l>this.maxTextureSize||u>this.maxTextureSize)){const p=Math.min(this.maxTextureSize/l,this.maxTextureSize/u);l=Math.max(1,Math.floor(l*p)),u=Math.max(1,Math.floor(u*p)),this.canvasScale=p}this.canvas=document.createElement("canvas"),this.canvas.width=l,this.canvas.height=u,this.ctx=this.canvas.getContext("2d",{alpha:!0}),this.fallbackVisible&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.texture=new Y(this.canvas),this.texture.flipY=!1,this.texture.wrapS=T,this.texture.wrapT=T,this.texture.minFilter=z,this.texture.magFilter=z,this.texture.generateMipmaps=!1,"colorSpace"in this.texture?this.texture.colorSpace=G:this.texture.encoding=B,this.texture.needsUpdate=!0;const d=new ce(500,64,64);d.scale(-1,1,1);const c=new $({map:this.texture,transparent:!0,opacity:0,depthWrite:!1,depthTest:!1});if(c.toneMapped=!1,this.mesh=new V(d,c),this.mesh.renderOrder=1,this.mesh.frustumCulled=!1,this.scene.add(this.mesh),!this.fallbackVisible){if(!e.levels.find(y=>y.z===0))throw new Error("manifest 缺少 z0");const b=`${e.baseUrl}/z0/0_0.jpg`,S=await this.fetchTileBitmap(b,"high"),I={z:0,col:0,row:0,url:b,state:"ready",priority:"low",bitmap:S,lastUsed:performance.now(),failCount:0};await this.drawTile(I),(w=S.close)==null||w.call(S)}this.lowLevel&&this.enqueueLevel(this.lowLevel,"low")}setPerformanceMode(e){e==="throttle"?(this.maxConcurrent=2,this.maxHighWhileLow=0):(this.maxConcurrent=this.defaultMaxConcurrent,this.maxHighWhileLow=this.defaultMaxHighWhileLow)}dispose(){if(this.tilesMap.forEach(e=>{var t,s;return(s=(t=e.bitmap)==null?void 0:t.close)==null?void 0:s.call(t)}),this.tilesMap.clear(),this.mesh){this.mesh.geometry&&this.mesh.geometry.dispose();const e=this.mesh.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.mesh)}}update(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;const t=performance.now();if(t-this.lastUpdate<150)return;if(this.lastUpdate=t,(!this.lowLevel||this.lowFullyReady||this.highSeeded)&&this.highestLevel){const o=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});for(const{col:h,row:n,rank:l}of o){const u=`${this.highestLevel.z}_${h}_${n}`;let d=this.tilesMap.get(u);d||(d={z:this.highestLevel.z,col:h,row:n,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${h}_${n}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(u,d)),d.priority="high",d.priorityRank=l,d.lastUsed=t,d.state==="empty"&&!d.retryTimer&&(d.state="loading",this.pendingHigh.push(d))}}const i=Array.from(this.tilesMap.values()).filter(o=>o.state==="loading").length,r=Array.from(this.tilesMap.values()).filter(o=>o.state==="ready").length;if(this.lowLevel&&!this.lowFullyReady){const o=Array.from(this.tilesMap.values()).filter(h=>h.z===this.lowLevel.z&&h.state==="loading").length;this.pendingLow.length===0&&o===0&&(this.lowFullyReady=!0)}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=i,this.tilesLoadedCount=r,this.processQueue(),this.runLru(t)}prime(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;e.updateMatrixWorld(!0);const t=performance.now();if(this.highestLevel&&!this.highSeeded){const s=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});if(s.length>0){for(const{col:i,row:r,rank:o}of s){const h=`${this.highestLevel.z}_${i}_${r}`;let n=this.tilesMap.get(h);n||(n={z:this.highestLevel.z,col:i,row:r,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${i}_${r}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(h,n)),n.priority="high",n.priorityRank=o,n.lastUsed=t,n.state==="empty"&&!n.retryTimer&&(n.state="loading",this.pendingHigh.push(n))}this.highSeeded=!0}}this.reprioritizeLowQueue(e),this.seedHighPreload(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(s=>s.state==="loading").length,this.processQueue()}getStatus(){var e,t;return{tilesVisible:this.tilesVisible,fallbackVisible:this.fallbackVisible,tilesLoadedCount:this.tilesLoadedCount,tilesLoadingCount:this.tilesLoadingCount,tilesQueuedCount:this.tilesQueuedCount,tilesFailedCount:this.tilesFailedCount,tilesRetryCount:this.tilesRetryCount,lastTileUrl:this.lastTileUrl,lastError:this.lastError,canvasSize:this.canvas?`${this.canvas.width}x${this.canvas.height}`:"0x0",canvasScale:this.canvasScale,maxLevel:this.highestLevel?`${this.highestLevel.cols}x${this.highestLevel.rows}`:"",highReady:this.highReady,zMax:((e=this.highestLevel)==null?void 0:e.z)??0,levels:this.manifest?this.manifest.levels.map(s=>s.z).join(","):"",lowReady:this.lowFullyReady,lowLevel:((t=this.lowLevel)==null?void 0:t.z)??""}}enqueueLevel(e,t){const s=performance.now();for(let i=0;i<e.rows;i++)for(let r=0;r<e.cols;r++){const o=`${e.z}_${r}_${i}`;let h=this.tilesMap.get(o);h||(h={z:e.z,col:r,row:i,url:`${this.manifest.baseUrl}/z${e.z}/${r}_${i}.jpg`,state:"empty",priority:t,lastUsed:s,failCount:0},this.tilesMap.set(o,h)),h.priority=t,h.lastUsed=s,h.state==="empty"&&!h.retryTimer&&(h.state="loading",t==="low"?this.pendingLow.push(h):this.pendingHigh.push(h))}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(i=>i.state==="loading").length,this.processQueue()}processQueue(){for(this.sortPendingHighQueue();this.activeLoads<this.maxConcurrent&&(this.pendingLow.length>0||this.pendingHigh.length>0);){const e=this.pendingLow.length>0,s=this.pendingHigh.length>0&&(!e||this.activeHighLoads<this.maxHighWhileLow)?this.pendingHigh.shift():this.pendingLow.shift();this.loadTile(s)}}async loadTile(e){(e.failCount===void 0||e.failCount===null)&&(e.failCount=0),e.priority||(e.priority="high"),this.activeLoads+=1,e.priority==="high"?this.activeHighLoads+=1:this.activeLowLoads+=1,this.lastTileUrl=e.url;try{const t=await this.fetchTileBitmap(e.url,e.priority);e.bitmap=t,e.state="ready",e.failCount=0,e.retryTimer&&(clearTimeout(e.retryTimer),e.retryTimer=void 0),this.drawTile(e),this.tilesLoadedCount+=1,this.lowLevel&&e.z===this.lowLevel.z&&(this.lowReadyCount+=1,this.lowReadyCount>=this.lowTotalCount&&(this.lowFullyReady=!0))}catch(t){this.lastError=t instanceof Error?t.message:String(t),e.state="empty",e.failCount+=1,this.tilesFailedCount+=1;const s=Math.min(1e3*Math.pow(2,Math.max(0,e.failCount-1)),15e3);this.scheduleRetry(e,s)}finally{this.activeLoads-=1,e.priority==="high"?this.activeHighLoads=Math.max(0,this.activeHighLoads-1):this.activeLowLoads=Math.max(0,this.activeLowLoads-1),this.processQueue()}}scheduleRetry(e,t){e.retryTimer||(this.tilesRetryCount+=1,e.retryTimer=window.setTimeout(()=>{e.retryTimer=void 0,e.state==="empty"&&(e.priority==="low"?this.pendingLow.push(e):this.pendingHigh.push(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.processQueue())},t))}async fetchTileBitmap(e,t,s=12e3){try{const o=await He(e,{timeoutMs:s,priority:t});if(o)return o}catch{}const i=new AbortController,r=window.setTimeout(()=>i.abort(),s);try{const o={mode:"cors",cache:"default",referrerPolicy:"no-referrer",signal:i.signal};o.priority=t==="high"?"high":"low";const h=await fetch(e,o);if(!h.ok)throw new Error(`tile HTTP ${h.status}: ${e}`);const n=await h.blob();return await createImageBitmap(n)}finally{clearTimeout(r)}}hasHigherReadyTile(e,t,s){if(!this.highestLevel)return!1;const i=this.highestLevel.z;if(e>=i)return!1;const r=1<<i-e;for(let o=0;o<r;o++)for(let h=0;h<r;h++){const n=`${i}_${t*r+h}_${s*r+o}`,l=this.tilesMap.get(n);if(l&&l.state==="ready")return!0}return!1}async drawTile(e){var l,u;if(!this.manifest||!this.highestLevel||!this.ctx||!this.canvas)return;const t=this.manifest.levels.find(d=>d.z===e.z);if(!t||this.hasHigherReadyTile(e.z,e.col,e.row))return;const s=this.canvas.width/t.cols,i=this.canvas.height/t.rows,r=e.col*s,o=e.row*i;if(r<0||o<0||r+s>this.canvas.width||o+i>this.canvas.height){this.lastError=`tile out of canvas: z${e.z} ${e.col}_${e.row}`;return}const h=e.bitmap;if(h)this.ctx.drawImage(h,r,o,s,i);else{const d=e.url||`${this.manifest.baseUrl}/z${e.z}/${e.col}_${e.row}.jpg`,c=await _(d,{timeoutMs:12e3,retries:1,priority:e.priority,channel:"tile"});this.ctx.drawImage(c,r,o,s,i),(l=c.close)==null||l.call(c)}this.texture&&(this.texture.needsUpdate=!0),this.tilesVisible||(this.tilesVisible=!0,this.onFirstDraw());const n=(u=this.mesh)==null?void 0:u.material;n&&(n.opacity=1,n.needsUpdate=!0),this.highestLevel&&e.z===this.highestLevel.z&&!this.highReady&&(this.highReady=!0,this.onHighReady())}computeNeededTiles(e,t,s={}){const{yaw:i,pitch:r}=this.getViewAngles(e),o=C.degToRad(e.fov),h=C.degToRad(s.marginDeg??20),n=o/2+h,l=o*e.aspect/2+h,u=this.normAngle(i-l),d=this.normAngle(i+l),c=C.clamp(r-n,-Math.PI/2,Math.PI/2),w=C.clamp(r+n,-Math.PI/2,Math.PI/2),p=this.yawToCols(u,d,t.cols),b=this.yawToCols(i-1e-6,i+1e-6,t.cols)[0]??0;p.includes(b)||p.push(b);const S=Math.max(0,Math.floor((w*-1+Math.PI/2)/Math.PI*t.rows)),I=Math.min(t.rows-1,Math.floor((c*-1+Math.PI/2)/Math.PI*t.rows)),y=[];for(let v=S;v<=I;v++)y.push(v);const D=Math.min(t.rows-1,Math.max(0,Math.floor((-r+Math.PI/2)/Math.PI*t.rows)));y.includes(D)||y.push(D);const L=s.expandNeighbors!==!1,U=[...p];if(L)for(const v of p)U.push(((v+1)%t.cols+t.cols)%t.cols),U.push(((v-1)%t.cols+t.cols)%t.cols);const O=[...y];if(L)for(const v of y)v+1<t.rows&&O.push(v+1),v-1>=0&&O.push(v-1);const W=new Map,de=(v,P)=>{const J=`${v}_${P}`,K=Math.abs(v-b),ee=Math.min(K,t.cols-K),te=Math.abs(P-D),se=ee*ee+te*te,ie=W.get(J);(!ie||se<ie.rank)&&W.set(J,{col:v,row:P,rank:se})};for(const v of U)for(const P of O)de(v,P);return Array.from(W.values()).sort((v,P)=>v.rank!==P.rank?v.rank-P.rank:v.row!==P.row?v.row-P.row:v.col-P.col)}sortPendingHighQueue(){this.pendingHigh.length<2||this.pendingHigh.sort((e,t)=>{const s=e.priorityRank??Number.POSITIVE_INFINITY,i=t.priorityRank??Number.POSITIVE_INFINITY;return s!==i?s-i:t.lastUsed-e.lastUsed})}reprioritizeLowQueue(e){if(!this.lowLevel||this.pendingLow.length<2)return;const t=this.computeNeededTiles(e,this.lowLevel);if(t.length===0)return;const s=new Map;for(const r of t)s.set(`${r.col}_${r.row}`,r.rank);const i=new Map;this.pendingLow.forEach((r,o)=>i.set(r,o)),this.pendingLow.sort((r,o)=>{const h=s.get(`${r.col}_${r.row}`),n=s.get(`${o.col}_${o.row}`),l=h!==void 0,u=n!==void 0;return l&&u&&h!==n?h-n:l&&!u?-1:!l&&u?1:(i.get(r)??0)-(i.get(o)??0)})}seedHighPreload(e){if(this.prefetchSeeded||!this.manifest||!this.highestLevel)return;this.prefetchSeeded=!0;const{yaw:t,pitch:s}=this.getViewAngles(e),i=this.highestLevel,r=Math.PI*2/i.cols,o=Math.PI/i.rows,h=performance.now();for(let n=0;n<i.rows;n++){const l=Math.PI/2-(n+.5)*o,u=Math.abs(l-s);for(let d=0;d<i.cols;d++){const c=-Math.PI+(d+.5)*r,w=this.angularDistance(c,t),b=(w<=Math.PI/2?0:1)*1e6+Math.round(w*1e3)+Math.round(u*10),S=`${i.z}_${d}_${n}`;if(this.tilesMap.has(S))continue;const I={z:i.z,col:d,row:n,url:`${this.manifest.baseUrl}/z${i.z}/${d}_${n}.jpg`,state:"loading",priority:"high",priorityRank:b,lastUsed:h,failCount:0};this.tilesMap.set(S,I),this.pendingHigh.push(I)}}}yawToCols(e,t,s){const i=c=>(c%(Math.PI*2)+Math.PI*2)%(Math.PI*2),r=Math.PI,o=i(e+r),h=i(t+r),n=[],l=c=>{const w=(c%s+s)%s;n.includes(w)||n.push(w)},u=Math.floor(o/(Math.PI*2)*s),d=Math.floor(h/(Math.PI*2)*s);if(o<=h)for(let c=u;c<=d;c++)l(c);else{for(let c=u;c<s;c++)l(c);for(let c=0;c<=d;c++)l(c)}return n}normAngle(e){return(e+Math.PI)%(2*Math.PI)-Math.PI}angularDistance(e,t){return Math.abs(this.normAngle(e-t))}getViewAngles(e){const t=new ve;return e.getWorldDirection(t),{yaw:-Math.atan2(t.x,t.z),pitch:Math.asin(t.y)}}runLru(e){var i,r;if(!this.highestLevel)return;const t=Array.from(this.tilesMap.values()).filter(o=>o.z===this.highestLevel.z&&o.state==="ready");if(t.length<=this.lruLimit)return;t.sort((o,h)=>o.lastUsed-h.lastUsed);const s=t.slice(0,t.length-this.lruLimit);for(const o of s)(r=(i=o.bitmap)==null?void 0:i.close)==null||r.call(i),o.bitmap=void 0,o.state="empty",this.tilesMap.delete(`${o.z}_${o.col}_${o.row}`)}}function $e(m,e){var s;const t=m.trim();if(!t||t.startsWith("/")||t.startsWith("//")||/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(t))return t;try{const i=new URL(t,e),r=typeof window<"u"&&((s=window.location)!=null&&s.origin)?window.location.origin:typeof location<"u"?location.origin:"";return r&&i.origin===r?`${i.pathname}${i.search}${i.hash}`:i.toString()}catch{return t}}async function Ve(m){const e={cache:"default"};e.priority="high";const t=await fetch(m,e);if(!t.ok)throw new Error(`manifest 加载失败: ${m}`);const s=await t.json();return s.tileFormat||(s.tileFormat="jpg"),s.baseUrl=x($e(s.baseUrl,m),R.PANO),s}class ze{constructor(e,t){a(this,"dom");a(this,"options");a(this,"eventDisposers",[]);a(this,"pickEventDisposers",[]);a(this,"disposed",!1);a(this,"animationId",null);a(this,"lastFrameTimeMs",null);a(this,"longPressTimer",null);this.dom=e,this.options=t}bindBaseEvents(){this.disposed||(this.addDomListener("mousedown",e=>this.options.onPointerDown(e)),this.addDomListener("mousemove",e=>this.options.onPointerMove(e)),this.addDomListener("mouseup",()=>this.options.onPointerUp()),this.addDomListener("mouseleave",()=>this.options.onPointerUp()),this.addDomListener("touchstart",e=>this.options.onTouchStart(e),{passive:!1}),this.addDomListener("touchmove",e=>this.options.onTouchMove(e),{passive:!1}),this.addDomListener("touchend",()=>this.options.onTouchEnd()),this.addDomListener("wheel",e=>this.options.onWheel(e),{passive:!1}),window.addEventListener("resize",this.options.onResize),this.eventDisposers.push(()=>{window.removeEventListener("resize",this.options.onResize)}),this.options.debugMode&&(this.addDomListener("dblclick",e=>{const t=e;this.options.onDebugClick(t.clientX,t.clientY)}),this.addDomListener("touchstart",e=>{const t=e;if(t.touches.length!==1)return;const s=t.touches[0].clientX,i=t.touches[0].clientY;this.clearLongPressTimer(),this.longPressTimer=window.setTimeout(()=>{this.options.onDebugClick(s,i),this.longPressTimer=null},this.options.longPressThreshold)},{passive:!0}),this.addDomListener("touchmove",()=>{this.clearLongPressTimer()},{passive:!0}),this.addDomListener("touchend",()=>{this.clearLongPressTimer()},{passive:!0})))}startAnimationLoop(){if(this.disposed||this.animationId!==null)return;this.lastFrameTimeMs=null;const e=()=>{if(this.disposed)return;const t=performance.now(),s=this.lastFrameTimeMs?t-this.lastFrameTimeMs:16.7;this.lastFrameTimeMs=t,this.options.onTick(s),!this.disposed&&(this.animationId=requestAnimationFrame(e))};this.animationId=requestAnimationFrame(e)}stopAnimationLoop(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.lastFrameTimeMs=null}enablePickMode(e){if(this.disablePickMode(),this.disposed)return;const t=(h,n)=>{if(h instanceof TouchEvent){const l=n?h.changedTouches:h.touches;return l.length!==1?null:{clientX:l[0].clientX,clientY:l[0].clientY}}return{clientX:h.clientX,clientY:h.clientY}},s=(h,n,l)=>{this.dom.addEventListener(h,n,l),this.pickEventDisposers.push(()=>{this.dom.removeEventListener(h,n,l)})},i=h=>{const n=t(h,!1);n&&e.onStart(n.clientX,n.clientY)},r=h=>{const n=t(h,!1);n&&e.onMove(n.clientX,n.clientY)},o=h=>{const n=t(h,!0);n&&e.onEnd(n.clientX,n.clientY)};s("pointerdown",i),s("mousedown",i),s("touchstart",i,{passive:!0}),s("pointermove",r),s("mousemove",r),s("touchmove",r,{passive:!0}),s("pointerup",o),s("mouseup",o),s("touchend",o,{passive:!0})}disablePickMode(){for(const e of this.pickEventDisposers)e();this.pickEventDisposers.length=0}dispose(){if(!this.disposed){this.disposed=!0,this.stopAnimationLoop(),this.disablePickMode(),this.clearLongPressTimer();for(const e of this.eventDisposers)e();this.eventDisposers.length=0}}addDomListener(e,t,s){this.dom.addEventListener(e,t,s),this.eventDisposers.push(()=>{this.dom.removeEventListener(e,t,s)})}clearLongPressTimer(){this.longPressTimer!==null&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)}}const E={original:{renderer:{pixelRatio:Math.min(window.devicePixelRatio||1,2),toneMapping:Me,toneMappingExposure:1,output:"srgb",clearColor:void 0},camera:{defaultFov:75},texture:{anisotropyLimit:8,minFilter:oe,magFilter:z,generateMipmaps:!0,colorSpace:"srgb"}},enhanced:{renderer:{pixelRatio:Math.min(window.devicePixelRatio,2),toneMapping:Le,toneMappingExposure:.95,output:"srgb",clearColor:{color:0,alpha:1}},camera:{defaultFov:70},texture:{anisotropyLimit:12,minFilter:oe,magFilter:z,generateMipmaps:!0,colorSpace:"srgb"}}};class Ue{constructor(e,t=!1){a(this,"scene");a(this,"camera");a(this,"renderer");a(this,"sphere",null);a(this,"tilePano",null);a(this,"fallbackSphere",null);a(this,"container");a(this,"lifecycleRuntime");a(this,"disposed",!1);a(this,"frameListeners",[]);a(this,"nadirPatch",null);a(this,"nadirPatchModulePromise",null);a(this,"pendingNorthYaw",null);a(this,"compassDisk",null);a(this,"groundNavDots",null);a(this,"groundHeading",null);a(this,"renderProfile","enhanced");a(this,"isDragging",!1);a(this,"lastMouseX",0);a(this,"lastMouseY",0);a(this,"yaw",0);a(this,"pitch",0);a(this,"fov",75);a(this,"onLoadCallback");a(this,"onErrorCallback");a(this,"onStatusChangeCallback");a(this,"debugMode",!1);a(this,"onDebugClick");a(this,"longPressThreshold",500);a(this,"tilesDebugEl",null);a(this,"tilesVisibleStableFrames",0);a(this,"tilesLastError","");a(this,"tilesLowReady",!1);a(this,"tilesLastLoadedCount",0);a(this,"tilesLastProgressAt",0);a(this,"tilesHighStartAt",0);a(this,"tilesDegradedNotified",!1);a(this,"renderSource","none");a(this,"perfSamples",[]);a(this,"perfMode","normal");a(this,"allowTilePerfThrottle",!1);a(this,"perfLastChangeAt",0);a(this,"renderSwitchReason","");a(this,"clearedCount",0);a(this,"aspectWarnedUrls",new Set);a(this,"metrics",{sceneId:"",startAt:0,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:"normal",renderSource:"none",lastError:""});a(this,"lastMetricsEmitAt",0);a(this,"loadStatus",f.LOADING_LOW);a(this,"isDegradedMode",!1);a(this,"pickMode",!1);a(this,"pickStartX",0);a(this,"pickStartY",0);a(this,"pickStartTime",0);a(this,"pickHasMoved",!1);a(this,"pickDragThreshold",8);a(this,"pickTimeThreshold",250);a(this,"lastYaw",0);a(this,"lastPitch",0);a(this,"lastFov",75);a(this,"isViewChanging",!1);a(this,"viewChangeThreshold",.5);a(this,"pendingYawDelta",0);a(this,"pendingPitchDelta",0);a(this,"hasPendingViewDelta",!1);a(this,"vrModeEnabled",!1);a(this,"touchStartX",0);a(this,"touchStartY",0);a(this,"lastTouchDistance",0);a(this,"isPinching",!1);this.container=e,this.debugMode=t,this.renderProfile=this.detectRenderProfile(),this.allowTilePerfThrottle=this.detectTileThrottleEnabled(),this.scene=new be,this.camera=new ye(E[this.renderProfile].camera.defaultFov,e.clientWidth/e.clientHeight,.1,1e3),this.camera.position.set(0,0,0),this.fov=E[this.renderProfile].camera.defaultFov,this.renderer=new Se({antialias:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.applyRendererProfile(),e.appendChild(this.renderer.domElement),this.compassDisk=new Ce,this.compassDisk.mount(e),this.compassDisk.getElement().style.display="none",this.groundNavDots=new Re({museumId:"",currentSceneId:"",sceneHotspots:[]}),this.groundNavDots.mount(e),this.groundNavDots.getElement().style.display="none",this.groundHeading=new Ne(e),this.groundHeading.getElement().style.display="none",this.lifecycleRuntime=new ze(this.renderer.domElement,{debugMode:this.debugMode,longPressThreshold:this.longPressThreshold,onPointerDown:s=>this.onPointerDown(s),onPointerMove:s=>this.onPointerMove(s),onPointerUp:()=>this.onPointerUp(),onTouchStart:s=>this.onTouchStart(s),onTouchMove:s=>this.onTouchMove(s),onTouchEnd:()=>this.onTouchEnd(),onWheel:s=>this.onWheel(s),onDebugClick:(s,i)=>this.handleDebugClick(s,i),onResize:()=>this.handleResize(),onTick:s=>this.renderFrame(s)}),this.lifecycleRuntime.bindBaseEvents(),this.lifecycleRuntime.startAnimationLoop()}async ensureNadirPatch(){if(!(this.nadirPatch||this.disposed)){this.nadirPatchModulePromise||(this.nadirPatchModulePromise=ae(()=>import("./NadirPatch-Hks7_dwJ.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url));try{const{NadirPatch:e}=await this.nadirPatchModulePromise;if(this.disposed||this.nadirPatch)return;this.nadirPatch=new e(this.scene,500),typeof this.pendingNorthYaw=="number"&&this.nadirPatch.setNorthYaw(this.pendingNorthYaw)}catch{}}}handleDebugClick(e,t){if(this.onDebugClick&&this.debugMode){const s=this.getCurrentView();this.onDebugClick(e,t,s.yaw,s.pitch,s.fov)}}setOnDebugClick(e){this.onDebugClick=e}onPointerDown(e){this.isDragging=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,M.emitInteracting()}onPointerMove(e){if(!this.isDragging)return;const t=e.clientX-this.lastMouseX,s=e.clientY-this.lastMouseY;this.queueViewDelta(t*.5,s*.5),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY}onPointerUp(){this.isDragging=!1}onTouchStart(e){if(e.touches.length===1)this.isDragging=!0,this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY,this.lastMouseX=this.touchStartX,this.lastMouseY=this.touchStartY,M.emitInteracting();else if(e.touches.length===2){this.isPinching=!0,this.isDragging=!1;const t=e.touches[0].clientX-e.touches[1].clientX,s=e.touches[0].clientY-e.touches[1].clientY;this.lastTouchDistance=Math.sqrt(t*t+s*s),M.emitInteracting()}}onTouchMove(e){if(e.preventDefault(),e.touches.length===1&&this.isDragging){const t=e.touches[0].clientX-this.lastMouseX,s=e.touches[0].clientY-this.lastMouseY;this.queueViewDelta(t*.5,s*.5),this.lastMouseX=e.touches[0].clientX,this.lastMouseY=e.touches[0].clientY}else if(e.touches.length===2&&this.isPinching){const t=e.touches[0].clientX-e.touches[1].clientX,s=e.touches[0].clientY-e.touches[1].clientY,i=Math.sqrt(t*t+s*s),r=this.lastTouchDistance-i,o=this.fov+r*.5;this.setFovInternal(o),this.lastTouchDistance=i}}onTouchEnd(){this.isDragging=!1,this.isPinching=!1}onWheel(e){e.preventDefault();const t=this.fov+e.deltaY*.1;if(this.setFovInternal(t),M.emitInteracting(),this.debugMode&&this.onDebugClick){const s=this.getCurrentView();this.onDebugClick(this.lastMouseX,this.lastMouseY,s.yaw,s.pitch,s.fov)}}updateCamera(){const e=C.degToRad(this.yaw),t=C.degToRad(this.pitch),s=Math.cos(t)*Math.sin(e),i=Math.sin(t),r=Math.cos(t)*Math.cos(e);this.camera.lookAt(s,i,r)}queueViewDelta(e,t){this.pendingYawDelta+=e,this.pendingPitchDelta+=t,this.hasPendingViewDelta=!0}applyPendingViewDelta(){this.hasPendingViewDelta&&(this.yaw+=this.pendingYawDelta,this.pitch=Math.max(-90,Math.min(90,this.pitch+this.pendingPitchDelta)),this.pendingYawDelta=0,this.pendingPitchDelta=0,this.hasPendingViewDelta=!1)}loadScene(e,t){var d;if(this.isDegradedMode=!1,this.resetMetrics(e.id),this.updateLoadStatus(f.LOADING_LOW),this.renderSource="none",this.clearedCount=0,this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const c=this.sphere.material;c.map&&c.map.dispose(),c.dispose()}if(!((t==null?void 0:t.preserveView)===!0)){const c=e.initialView,w=c.yaw||0;this.yaw===0&&w!==0&&(this.yaw=-w),this.pitch=c.pitch||0;const p=E[this.renderProfile];this.fov=c.fov!==void 0?c.fov:p.camera.defaultFov,this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),this.updateCamera()}this.lastYaw=this.yaw,this.lastPitch=this.pitch,this.lastFov=this.fov,this.isViewChanging=!1;const r=-(typeof e.northYaw=="number"?e.northYaw:((d=e.initialView)==null?void 0:d.yaw)??0);this.nadirPatch?this.nadirPatch.setNorthYaw(r):this.pendingNorthYaw=r,this.compassDisk&&(this.compassDisk.setSceneId(e.id),this.compassDisk.setNorthYaw(r)),this.groundHeading&&this.groundHeading.setNorthYaw(r);const o=new ce(500,64,64);o.scale(-1,1,1);const h=e.panoTiles;if(h!=null&&h.manifest){const c=x(h.manifest,R.PANO),w=h.fallbackPanoLow||e.panoLow,p=h.fallbackPano||e.pano,b=!!(w||p);this.tilesVisibleStableFrames=0,this.tilesLastError="",this.tilesLowReady=!1,this.tilesLastLoadedCount=0,this.tilesLastProgressAt=performance.now(),this.tilesHighStartAt=0,this.tilesDegradedNotified=!1,w?this.showFallbackTexture(x(w,R.PANO_LOW),o,!0):p&&this.showFallbackTexture(x(p,R.PANO),o,!1);const S=()=>{this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(f.LOW_READY),this.setRenderSource("low","tiles 首屏可见"),this.onLoadCallback&&this.onLoadCallback()),this.loadStatus!==f.HIGH_READY&&this.updateLoadStatus(f.LOADING_HIGH)},I=()=>{this.updateLoadStatus(f.HIGH_READY),this.setRenderSource("tiles","tiles 高清可见"),this.isDegradedMode=!1};Ve(c).then(async y=>{if(y.tileFormat==="ktx2"){const{TileMeshPano:D}=await ae(async()=>{const{TileMeshPano:L}=await import("./tile-ktx2-C_kom5yP.js");return{TileMeshPano:L}},__vite__mapDeps([5,3,1,6,7,2,8,4]),import.meta.url);this.tilePano=new D(this.scene,this.renderer,S,I)}else this.tilePano=new Fe(this.scene,S,I,this.renderer.capabilities.maxTextureSize||0);return this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode(this.perfMode),this.tilePano.load(y,{fallbackVisible:b})}).then(()=>{var y;this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(f.LOW_READY),this.onLoadCallback&&this.onLoadCallback()),(y=this.tilePano)==null||y.prime(this.camera)}).catch(y=>{console.error("瓦片加载失败，回退传统全景",y),this.tilesLastError=y instanceof Error?y.message:String(y),re("瓦片加载失败，已回退到全景图",2e3),this.fallbackToLegacy(e,h)});return}const n=x(e.panoLow,R.PANO_LOW),l=x(e.pano,R.PANO);if(Ie()==="low"){if(n){this.loadSingleTexture(o,n,!0);return}if(l){this.loadSingleTexture(o,l,!1);return}}else{if(!n&&l){this.loadSingleTexture(o,l,!1);return}if(n&&!l){this.loadSingleTexture(o,n,!0);return}if(n&&l){this.loadProgressiveTextures(o,n,l);return}}this.updateLoadStatus(f.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("场景未提供全景图 URL"))}async loadSingleTexture(e,t,s){s?this.updateLoadStatus(f.LOADING_LOW):this.updateLoadStatus(f.LOADING_HIGH);try{const i=await _(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY",channel:"pano"}),r=new Y(i);this.applyTextureSettings(r),this.warnIfNotPanoAspect(r,t),r.flipY=!1,r.wrapS=T,r.wrapT=T,r.needsUpdate=!0;const o=new $({map:r});this.sphere=new V(e,o),this.scene.add(this.sphere),this.setRenderSource(s?"low":"tiles",s?"panoLow 可见":"pano 可见"),s?this.updateLoadStatus(f.LOW_READY):this.updateLoadStatus(f.HIGH_READY),this.onLoadCallback&&this.onLoadCallback()}catch(i){if(console.error("加载全景图失败",t,i),this.updateLoadStatus(f.ERROR),this.onErrorCallback){const r=i instanceof Pe?`加载全景图失败：${t} - ${i.message}`:`加载全景图失败：${t}`;this.onErrorCallback(new Error(r))}}}async loadProgressiveTextures(e,t,s){this.updateLoadStatus(f.LOADING_LOW);try{const i=await _(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY",channel:"pano"}),r=new Y(i);this.applyTextureSettings(r),this.warnIfNotPanoAspect(r,t),r.flipY=!1,r.wrapS=T,r.wrapT=T,r.needsUpdate=!0;const o=new $({map:r});this.sphere=new V(e,o),this.scene.add(this.sphere),this.setRenderSource("low","panoLow 可见"),this.updateLoadStatus(f.LOW_READY),this.onLoadCallback&&this.onLoadCallback(),this.updateLoadStatus(f.LOADING_HIGH);try{const h=await _(s,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"low",imageOrientation:"flipY",channel:"pano"}),n=new Y(h);this.applyTextureSettings(n),this.warnIfNotPanoAspect(n,s),n.flipY=!1,n.wrapS=T,n.wrapT=T,n.needsUpdate=!0;const l=this.getCurrentView();if(this.sphere&&this.sphere.material&&"map"in this.sphere.material){const u=this.sphere.material;u.map&&u.map.dispose(),u.map=n,u.needsUpdate=!0,this.setRenderSource("tiles","pano 高清可见")}this.setView(l.yaw,l.pitch,l.fov),this.updateLoadStatus(f.HIGH_READY),this.isDegradedMode=!1}catch(h){console.error("高清全景图加载失败，继续使用低清",s,h),this.isDegradedMode=!0,this.updateLoadStatus(f.DEGRADED)}}catch(i){console.error("低清全景图加载失败，尝试加载高清兜底",t,i),await this.loadSingleTexture(e,s,!1)}}setOnLoad(e){this.onLoadCallback=e}setOnError(e){this.onErrorCallback=e}setOnStatusChange(e){this.onStatusChangeCallback=e}getLoadStatus(){return this.loadStatus}resetMetrics(e){const t=performance.now();this.metrics={sceneId:e,startAt:t,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:this.perfMode,renderSource:this.renderSource,lastError:""},this.emitMetrics("reset",!0)}emitMetrics(e,t=!1){var w;const s=performance.now();if(!t&&s-this.lastMetricsEmitAt<800)return;const i=(w=this.tilePano)==null?void 0:w.getStatus(),r=(i==null?void 0:i.tilesLoadedCount)??0,o=(i==null?void 0:i.tilesFailedCount)??0,h=(i==null?void 0:i.tilesRetryCount)??0,n=r+o,l=n>0?Number((r/n*100).toFixed(2)):0;this.metrics.tilesLoaded=r,this.metrics.tilesFailed=o,this.metrics.tilesRetries=h,this.metrics.tileHitRate=l,this.metrics.perfMode=this.perfMode,this.metrics.renderSource=this.renderSource,this.metrics.lastError=this.tilesLastError||((i==null?void 0:i.lastError)??"");const u=this.metrics.lowReadyAt?Math.round(this.metrics.lowReadyAt-this.metrics.startAt):-1,d=this.metrics.highReadyAt?Math.round(this.metrics.highReadyAt-this.metrics.startAt):-1,c={...this.metrics,lowReadyMs:u,highReadyMs:d,reason:e,at:Math.round(s)};window.__VR_METRICS__=c,window.dispatchEvent(new CustomEvent("vr:metrics",{detail:c})),this.lastMetricsEmitAt=s}isInDegradedMode(){return this.isDegradedMode}updateLoadStatus(e){if(this.loadStatus===e)return;this.loadStatus=e;const t=performance.now();e===f.LOW_READY&&this.metrics.lowReadyAt===0&&(this.metrics.lowReadyAt=t),e===f.HIGH_READY&&this.metrics.highReadyAt===0&&(this.metrics.highReadyAt=t),this.onStatusChangeCallback&&this.onStatusChangeCallback(e),this.emitMetrics(`status:${e}`)}getCurrentView(){return{yaw:this.yaw,pitch:this.pitch,fov:this.fov}}setView(e,t,s){this.yaw=e,this.pitch=Math.max(-90,Math.min(90,t)),s!==void 0&&this.setFovInternal(s,!1),this.updateCamera()}setFovInternal(e,t=!0){if(this.fov=Math.max(30,Math.min(120,e)),this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),t){const s=E[this.renderProfile].camera.defaultFov,i=Math.round(s/this.fov*100),r=Math.max(50,Math.min(250,i));j.show(r)}}setFov(e){this.setFovInternal(e,!0)}setVrModeEnabled(e){this.vrModeEnabled=e,e||(this.isDragging=!1)}isVrModeEnabled(){return this.vrModeEnabled}isInteracting(){return this.isDragging||this.isPinching}handleResize(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}updatePerformanceGuard(e){const t=1e3/Math.max(1,e);if(this.perfSamples.push(t),this.perfSamples.length>30&&this.perfSamples.shift(),!this.allowTilePerfThrottle)return;const s=this.perfSamples.reduce((r,o)=>r+o,0)/this.perfSamples.length,i=performance.now();s<28&&this.perfMode==="normal"&&i-this.perfLastChangeAt>2e3&&(this.perfMode="throttle",this.perfLastChangeAt=i,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("throttle"),this.emitMetrics("perf:throttle",!0)),s>45&&this.perfMode==="throttle"&&i-this.perfLastChangeAt>3e3&&(this.perfMode="normal",this.perfLastChangeAt=i,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("normal"),this.emitMetrics("perf:normal",!0))}updateTilesDebug(){var D;const e=new URLSearchParams(window.location.search);if(!(e.get("tilesDebug")==="1"||e.get("tilesDebug")==="true"||e.get("tilesDebug")==="on")){this.tilesDebugEl&&(this.tilesDebugEl.remove(),this.tilesDebugEl=null);return}if(!this.tilesDebugEl){const L=document.createElement("div");L.style.position="absolute",L.style.left="8px",L.style.top="8px",L.style.padding="6px 8px",L.style.background="rgba(0,0,0,0.55)",L.style.color="#fff",L.style.fontSize="12px",L.style.lineHeight="1.4",L.style.borderRadius="6px",L.style.zIndex="9999",L.style.pointerEvents="none",this.tilesDebugEl=L,this.container.appendChild(L)}const s=(D=this.tilePano)==null?void 0:D.getStatus(),i=this.tilePano?"tiles":"fallback",r=s!=null&&s.tilesVisible?"true":"false",o=(s==null?void 0:s.tilesLoadedCount)??0,h=(s==null?void 0:s.tilesLoadingCount)??0,n=(s==null?void 0:s.tilesQueuedCount)??0,l=(s==null?void 0:s.lastTileUrl)??"",u=this.tilesLastError||(s==null?void 0:s.lastError)||"",d=this.fallbackSphere?"true":"false",c=(s==null?void 0:s.canvasSize)??"",w=(s==null?void 0:s.maxLevel)??"",p=s!=null&&s.highReady?"true":"false",b=(s==null?void 0:s.levels)??"",S=this.renderSource,I=this.renderSwitchReason,y=this.clearedCount;this.tilesDebugEl.textContent=`mode=${i}
renderSource=${S}
switchReason=${I}
cleared=${y}
fallbackVisible=${d}
tilesVisible=${r}
tilesLoaded=${o}
tilesLoading=${h}
tilesQueued=${n}
lastTileUrl=${l}
lastError=${u}
canvas=${c} zMax=${w} levels=${b} highReady=${p}
lowReady=${this.tilesLowReady}`}renderFrame(e){if(this.disposed)return;const t=performance.now();this.updatePerformanceGuard(e),this.applyPendingViewDelta();const s=this.getCurrentView(),i=Math.abs(s.yaw-this.lastYaw),r=Math.abs(s.pitch-this.lastPitch),o=Math.abs(s.fov-this.lastFov);if(i>this.viewChangeThreshold||r>this.viewChangeThreshold||o>this.viewChangeThreshold?this.isViewChanging||(this.isViewChanging=!0,M.emitInteracting()):this.isViewChanging&&(this.isViewChanging=!1,M.scheduleIdle()),this.lastYaw=s.yaw,this.lastPitch=s.pitch,this.lastFov=s.fov,this.updateCamera(),this.tilePano){this.tilePano.update(this.camera);const n=this.tilePano.getStatus(),l=!!this.fallbackSphere,u=n.tilesVisible,d=n.lowReady;l&&u&&d?(this.tilesVisibleStableFrames+=1,this.tilesVisibleStableFrames>=2&&this.clearFallback()):this.tilesVisibleStableFrames=0,!l&&!u&&this.noteCleared("无可见源"),u&&this.renderSource==="fallback"&&this.tilesLowReady&&this.setRenderSource("low","tiles 低清覆盖可见"),u&&n.highReady&&this.setRenderSource("tiles","tiles 高清可见"),n.lastError&&(this.tilesLastError=n.lastError),!this.tilesLowReady&&n.tilesLoadedCount>0&&(this.tilesLowReady=!0,this.updateLoadStatus(f.LOW_READY)),n.highReady&&(this.updateLoadStatus(f.HIGH_READY),this.isDegradedMode=!1,this.tilesDegradedNotified=!1),n.tilesLoadedCount>this.tilesLastLoadedCount&&(this.tilesLastLoadedCount=n.tilesLoadedCount,this.tilesLastProgressAt=t,this.tilesDegradedNotified&&!n.highReady&&(this.tilesDegradedNotified=!1)),this.tilesHighStartAt===0&&(n.tilesQueuedCount>0||n.tilesLoadingCount>0)&&(this.tilesHighStartAt=t,this.tilesLastProgressAt===0&&(this.tilesLastProgressAt=t)),this.tilesHighStartAt>0&&t-this.tilesLastProgressAt>12e3&&!n.highReady&&!this.tilesDegradedNotified&&this.tilesLowReady&&(this.isDegradedMode=!0,this.updateLoadStatus(f.DEGRADED),this.tilesDegradedNotified=!0)}this.updateTilesDebug(),this.emitMetrics("frame"),!this.nadirPatch&&s.pitch<=-20&&this.ensureNadirPatch(),this.nadirPatch&&this.nadirPatch.update(this.camera,{yaw:s.yaw,pitch:s.pitch},e),this.compassDisk&&this.compassDisk.setYawPitch(s.yaw,s.pitch),this.groundNavDots&&this.groundNavDots.setYawPitch(s.yaw,s.pitch),this.groundHeading&&this.groundHeading.setYawPitch(s.yaw,s.pitch);for(const n of this.frameListeners)n(e);this.disposed||this.renderer.render(this.scene,this.camera)}onFrame(e){return this.frameListeners.push(e),()=>{const t=this.frameListeners.indexOf(e);t>=0&&this.frameListeners.splice(t,1)}}getCamera(){return this.camera}getDomElement(){return this.renderer.domElement}setSceneData(e,t,s){if(this.groundNavDots){const i=s.filter(r=>{var o;return r.type==="scene"&&((o=r.target)==null?void 0:o.sceneId)}).map(r=>({id:r.id,label:r.label,yaw:r.yaw,pitch:r.pitch,target:{museumId:r.target.museumId,sceneId:r.target.sceneId}}));this.groundNavDots.updateScene(e,t,i)}}getSphereRadius(){return 500}getViewportSize(){return{width:this.container.clientWidth,height:this.container.clientHeight}}enablePickMode(){this.pickMode||(this.pickMode=!0,this.lifecycleRuntime.enablePickMode({onStart:(e,t)=>{this.pickStartX=e,this.pickStartY=t,this.pickStartTime=Date.now(),this.pickHasMoved=!1},onMove:(e,t)=>{const s=Math.abs(e-this.pickStartX),i=Math.abs(t-this.pickStartY);Math.sqrt(s*s+i*i)>this.pickDragThreshold&&(this.pickHasMoved=!0)},onEnd:(e,t)=>{const s=Date.now()-this.pickStartTime,i=Math.abs(e-this.pickStartX),r=Math.abs(t-this.pickStartY);Math.sqrt(i*i+r*r)>this.pickDragThreshold||s>this.pickTimeThreshold&&this.pickHasMoved||this.handlePick(e,t),this.pickHasMoved=!1}}))}disablePickMode(){this.pickMode&&(this.pickMode=!1,this.lifecycleRuntime.disablePickMode())}togglePickMode(){return this.pickMode?this.disablePickMode():this.enablePickMode(),this.pickMode}isPickModeEnabled(){return this.pickMode}handlePick(e,t){const s=this.renderer.domElement.getBoundingClientRect(),i=Te(e,t,s),r=ke(i.x,i.y,this.camera,this.getSphereRadius());if(!r){typeof __VR_DEBUG__<"u"&&__VR_DEBUG__&&console.debug("[pick] 无法计算 yaw/pitch（ray.direction 为空）");return}const{yaw:o,pitch:h}=r,n=`yaw: ${o.toFixed(2)}, pitch: ${h.toFixed(2)}`;console.log(`[pick] yaw=${o.toFixed(2)}, pitch=${h.toFixed(2)}`),navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(n).catch(()=>{}),window.dispatchEvent(new CustomEvent("vr:pick",{detail:{x:e,y:t,yaw:o,pitch:h}}))}warnIfNotPanoAspect(e,t){if(!e.image)return;const s=e.image,i=s.width,r=s.height;if(!i||!r)return;const o=i/r;Math.abs(o-2)>.02&&!this.aspectWarnedUrls.has(t)&&(console.warn(`[PanoViewer] 全景图比例不是 2:1，可能出现轻微变形（实际 ${o.toFixed(2)}），来源: ${t}`),this.aspectWarnedUrls.add(t))}dispose(){if(!this.disposed){if(this.disposed=!0,this.lifecycleRuntime.dispose(),this.pickMode=!1,this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const e=this.sphere.material;e.map&&e.map.dispose(),e.dispose()}this.nadirPatch&&(this.nadirPatch.dispose(this.scene),this.nadirPatch=null),this.compassDisk&&(this.compassDisk.dispose(),this.compassDisk=null),this.groundNavDots&&(this.groundNavDots.dispose(),this.groundNavDots=null),this.groundHeading&&(this.groundHeading.dispose(),this.groundHeading=null),this.frameListeners=[],this.renderer.dispose()}}applyRendererProfile(){const e=E[this.renderProfile];this.renderer.setPixelRatio(e.renderer.pixelRatio),"outputColorSpace"in this.renderer?this.renderer.outputColorSpace=G:this.renderer.outputEncoding=B,this.renderer.toneMapping=e.renderer.toneMapping,this.renderer.toneMappingExposure=e.renderer.toneMappingExposure,e.renderer.clearColor&&this.renderer.setClearColor(e.renderer.clearColor.color,e.renderer.clearColor.alpha)}detectRenderProfile(){try{const t=new URLSearchParams(window.location.search).get("render");if(t&&t.toLowerCase()==="original")return"original"}catch{}return"enhanced"}detectTileThrottleEnabled(){try{return new URLSearchParams(window.location.search).get("tileThrottle")==="1"}catch{return!1}}fallbackToLegacy(e,t){const s={...e,pano:(t==null?void 0:t.fallbackPano)??e.pano,panoLow:(t==null?void 0:t.fallbackPanoLow)??e.panoLow,panoTiles:void 0};s.pano||s.panoLow?(re("瓦片加载失败，已回退到全景图",2e3),this.setRenderSource("fallback","tiles 失败自动回退"),this.loadScene(s,{preserveView:!0})):(this.updateLoadStatus(f.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("瓦片与全景资源均不可用")))}setRenderSource(e,t){(this.renderSource!==e||t)&&(this.renderSource=e,this.renderSwitchReason=t)}noteCleared(e){this.clearedCount+=1,this.renderSwitchReason=e}async showFallbackTexture(e,t,s){try{const i=await _(e,{timeoutMs:15e3,retries:1,allowFetchFallback:!0,priority:"high",imageOrientation:"flipY",channel:"pano"}),r=new Y(i);this.applyTextureSettings(r),r.flipY=!1,r.wrapS=T,r.wrapT=T,r.needsUpdate=!0;const o=new $({map:r,depthWrite:!1,depthTest:!1}),h=new V(t.clone(),o);h.renderOrder=0,this.fallbackSphere=h,this.scene.add(h),this.updateLoadStatus(s?f.LOW_READY:f.HIGH_READY),this.setRenderSource("fallback",s?"fallback 低清可见":"fallback 高清可见"),s&&(this.tilesLowReady=!0),this.onLoadCallback&&this.onLoadCallback()}catch(i){console.error("fallback 贴图加载失败",i)}}clearFallback(){if(this.fallbackSphere){this.fallbackSphere.geometry&&this.fallbackSphere.geometry.dispose();const e=this.fallbackSphere.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.fallbackSphere),this.fallbackSphere=null}}applyTextureSettings(e){const t=E[this.renderProfile],s=this.renderer.capabilities.getMaxAnisotropy?this.renderer.capabilities.getMaxAnisotropy():1;if(e.anisotropy=Math.min(t.texture.anisotropyLimit,Math.max(1,s||1)),e.minFilter=t.texture.minFilter,e.magFilter=t.texture.magFilter,e.generateMipmaps=t.texture.generateMipmaps,"colorSpace"in e?e.colorSpace=G:e.encoding=B,e.needsUpdate=!0,this.debugMode){const i=e.image||{};console.log("pano texture",{w:i.width,h:i.height,colorSpace:e.colorSpace,encoding:e.encoding,anisotropy:e.anisotropy,minFilter:e.minFilter,magFilter:e.magFilter})}}}const Qe=Object.freeze(Object.defineProperty({__proto__:null,PanoViewer:Ue},Symbol.toStringTag,{value:"Module"}));export{Qe as P,He as d};
