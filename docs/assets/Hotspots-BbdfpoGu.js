var T=Object.defineProperty;var k=(i,e,o)=>e in i?T(i,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[e]=o;var r=(i,e,o)=>k(i,typeof e!="symbol"?e+"":e,o);import{e as w,M as I}from"./three-renderer-DqCmgmK_.js";import{o as L,s as b,p as x}from"./index-DhGXQL-R.js";function H(i,e){const o=I.degToRad(i),s=I.degToRad(e),n=Math.cos(s)*Math.sin(o),l=Math.sin(s),t=Math.cos(s)*Math.cos(o);return new w(n,l,t)}function C(i,e,o){const s=new w,n=new w;if(e.getWorldPosition(s),e.getWorldDirection(n),new w().copy(i).sub(s).dot(n)<=0)return{x:0,y:0,visible:!1};const t=new w().copy(i).project(e);if(!(t.x>=-1&&t.x<=1&&t.y>=-1&&t.y<=1&&t.z>=-1&&t.z<=1))return{x:0,y:0,visible:!1};const c=o.clientWidth,d=o.clientHeight,f=(t.x+1)*.5*c,u=(1-(t.y+1)*.5)*d;return{x:f,y:u,visible:!0}}function M(i,e,o,s,n=500){const t=H(i,e).clone().multiplyScalar(n);return C(t,o,s)}function F(){return`
<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" />
  <path d="M16.2 16.2 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
</svg>`}function P(){return`
<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M9 7.5v9l8-4.5-8-4.5Z"/>
</svg>`}function N(i){const e=document.createElement("div");return e.className="hotspot-tooltip",e.textContent=i||"",e.setAttribute("role","tooltip"),e}function y(i,e){const o=document.createElement("div");return o.className=`hotspot-icon-circle${e?` ${e}`:""}`,o.innerHTML=i,o}function D(){return`
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 4v16M12 4l6 6M12 4l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`}function $(i){const e=N(i.tooltip),o=i.isGround??!1;let s="hotspot hotspot--unknown",n=document.createElement("div");n.className="hotspot-dot";const l=i.type;if(o){s="hotspot hotspot--ground";const t=document.createElement("div");t.className="hotspot-ground-ring",n=t}else l==="scene"?(s="hotspot hotspot--scene",n=y(D(),"hotspot-icon hotspot-icon-arrow")):l==="image"?(s="hotspot hotspot--image",n=y(F(),"hotspot-icon")):l==="info"?(s="hotspot hotspot--info",n=y('<span class="hotspot-info-text">i</span>',"hotspot-icon")):l==="video"&&(s="hotspot hotspot--video",n=y(P(),"hotspot-icon hotspot-icon-play"));return{rootClassName:s,contentEl:n,tooltipEl:e}}class E{constructor(e){r(this,"data");r(this,"el");r(this,"contentEl");r(this,"tooltipEl");r(this,"labelEl",null);r(this,"worldPos");r(this,"radius",500);r(this,"tooltipTimer",null);var t,a;this.data=e,this.el=document.createElement("div");const o=e.pitch<-20,s=$({id:e.id,type:e.type,tooltip:e.tooltip,isGround:o});if(this.el.className=s.rootClassName,o&&this.el.classList.add("hotspot--ground"),this.el.setAttribute("data-hotspot-id",e.id),this.el.setAttribute("data-hotspot-type",e.type),this.el.style.pointerEvents="auto",this.el.style.position="absolute",this.el.style.left="0",this.el.style.top="0",this.contentEl=s.contentEl,this.tooltipEl=s.tooltipEl,e.label){const c=document.createElement("div");c.className="hotspot-label",c.textContent=e.label,c.setAttribute("aria-hidden","true"),this.labelEl=c}this.el.appendChild(this.contentEl),this.el.appendChild(this.tooltipEl),this.labelEl&&this.el.appendChild(this.labelEl),(((a=(t=window.matchMedia)==null?void 0:t.call(window,"(hover: hover) and (pointer: fine)"))==null?void 0:a.matches)??!1)&&(this.el.addEventListener("mouseenter",()=>this.showTooltip()),this.el.addEventListener("mouseleave",()=>this.hideTooltip())),this.el.addEventListener("pointerdown",c=>{c.stopPropagation(),this.el.classList.add("is-pressed")});const l=()=>this.el.classList.remove("is-pressed");this.el.addEventListener("pointerup",l),this.el.addEventListener("pointercancel",l),this.el.addEventListener("pointerleave",l)}getElement(){return this.el}getData(){return this.data}updateScreenPosition(e,o){const s=M(this.data.yaw,this.data.pitch,e,o,this.radius);if(!s.visible){this.el.style.display="none",this.el.style.opacity="0";return}this.el.style.display="",this.el.style.opacity="1",this.el.style.setProperty("--hs-x",`${s.x}px`),this.el.style.setProperty("--hs-y",`${s.y}px`),this.el.style.transform=`translate3d(${s.x}px, ${s.y}px, 0) translate(-50%, -50%)`}showTooltip(e){this.data.tooltip&&(this.tooltipEl.classList.add("show"),this.tooltipTimer&&(window.clearTimeout(this.tooltipTimer),this.tooltipTimer=null),e&&e>0&&(this.tooltipTimer=window.setTimeout(()=>this.hideTooltip(),e)))}hideTooltip(){this.tooltipEl.classList.remove("show"),this.tooltipTimer&&(window.clearTimeout(this.tooltipTimer),this.tooltipTimer=null)}}class U extends E{onClick(){console.log("[hotspot] scene click",{id:this.data.id,targetSceneId:this.data.targetSceneId})}}class A extends E{onClick(){if(!this.data.imageUrl){console.warn("[hotspot] image click but no src configured",this.data),b("未配置内容",1500);return}x({type:"image",payload:{src:this.data.imageUrl,title:this.data.title||this.data.tooltip}})}}class B extends E{onClick(){if(!!!(this.data.text||this.data.title||this.data.tooltip)){console.warn("[hotspot] info click but no text/title configured",this.data),b("未配置内容",1500);return}x({type:"info",payload:{title:this.data.title||this.data.tooltip,text:this.data.text}})}}class G extends E{onClick(){if(!this.data.url){console.warn("[hotspot] video click but no src/url configured",this.data),b("未配置内容",1500);return}x({type:"video",payload:{src:this.data.url,poster:this.data.poster,title:this.data.title||this.data.tooltip}})}}class z{constructor(e,o,s={}){r(this,"element");r(this,"viewer");r(this,"disposeFrameListener",null);r(this,"hotspotInstances",[]);r(this,"options");r(this,"unsubscribeFocus",null);r(this,"hoveredSceneId",null);this.viewer=e,this.options=s,this.element=document.createElement("div"),this.element.className="hotspots-container",this.element.style.pointerEvents="none",this.updateHotspots(o);const n=this.viewer.getDomElement();this.disposeFrameListener=this.viewer.onFrame(()=>{const l=this.viewer.getCamera();for(const t of this.hotspotInstances)t.updateScreenPosition(l,n)}),this.unsubscribeFocus=L(l=>{this.handleSceneFocus(l)})}handleSceneFocus(e){if(e.type==="hover"&&e.source!=="pano"){if(this.options.museumId&&e.museumId!==this.options.museumId)return;const o=e.sceneId;this.hoveredSceneId!==o&&(this.hoveredSceneId&&this.setHotspotHighlight(this.hoveredSceneId,!1),this.hoveredSceneId=o,o&&this.setHotspotHighlight(o,!0))}}setHotspotHighlight(e,o){this.hotspotInstances.forEach(s=>{const n=s.getData();if(n.type==="scene"&&n.targetSceneId===e){const t=s.getElement();o?t.classList.add("hotspot--external-hover"):t.classList.remove("hotspot--external-hover")}})}updateHotspots(e){var n,l;this.hotspotInstances=[],this.element.innerHTML="";const o=((l=(n=window.matchMedia)==null?void 0:n.call(window,"(hover: none) and (pointer: coarse)"))==null?void 0:l.matches)??!1,s=t=>{var a,c,d,f,u,g,m,S;if(t.type==="scene"){const h=(a=t.target)==null?void 0:a.sceneId,p=h?(d=(c=this.options).resolveSceneName)==null?void 0:d.call(c,h):void 0,v=`进入：${p||t.label||h||"未知场景"}`;return new U({id:t.id,type:"scene",yaw:t.yaw,pitch:t.pitch,label:t.label||p||h,tooltip:v,targetSceneId:h})}if(t.type==="video"){const h=((f=t.target)==null?void 0:f.url)||t.src,p=((u=t.target)==null?void 0:u.poster)||t.poster,v=t.title||t.label;return new G({id:t.id,type:"video",yaw:t.yaw,pitch:t.pitch,label:t.label,tooltip:v,url:h,poster:p,title:v})}if(t.type==="image"){const h=((g=t.target)==null?void 0:g.imageUrl)||((m=t.target)==null?void 0:m.url)||t.src,p=t.title||t.label;return new A({id:t.id,type:"image",yaw:t.yaw,pitch:t.pitch,label:t.label,tooltip:p,imageUrl:h,title:p})}if(t.type==="info"){const h=t.title||t.label,p=((S=t.target)==null?void 0:S.text)||t.text;return new B({id:t.id,type:"info",yaw:t.yaw,pitch:t.pitch,label:t.label,tooltip:h,text:p,title:h})}return null};for(const t of e){const a=s(t);a&&(a.getElement().addEventListener("click",c=>{var u,g;c.preventDefault(),c.stopPropagation();const d=a.getData(),f=d.type==="scene";if(o&&a.showTooltip(1200),f){const m=d.targetSceneId;if(m&&this.options.onEnterScene){b(`进入 ${((g=(u=this.options).resolveSceneName)==null?void 0:g.call(u,m))||m}`,1e3),this.options.onEnterScene(m);return}}a.onClick()}),this.hotspotInstances.push(a),this.element.appendChild(a.getElement()))}}getElement(){return this.element}remove(){this.disposeFrameListener&&(this.disposeFrameListener(),this.disposeFrameListener=null),this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=null),this.element.remove()}}export{z as Hotspots,A as ImageHotspot,B as InfoHotspot,U as SceneLinkHotspot,G as VideoHotspot};
