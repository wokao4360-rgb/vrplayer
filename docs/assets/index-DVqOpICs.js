const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./tile-ktx2-19dlhglf.js","./three-core-0fX1SOzE.js","./three-extras-u7VkRAqM.js","./editor-debug-_leEjMgs.js","./draftStorage-Be1LM_rK.js","./VideoPlayer-CtL_iDts.js","./GuideTray-CLq_IAOO.js","./SceneGuideDrawer-ChkoUG81.js","./index-DnDnySW2.js","./BottomDock-BigA--sM.js","./Hotspots-BXkkbW0U.js","./chat-community-N43F3_Ud.js","./store-B83L8bDT.js","./dock-panels-Ctb3AQYB.js"])))=>i.map(i=>d[i]);
var kt=Object.defineProperty;var Dt=(s,e,t)=>e in s?kt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var r=(s,e,t)=>Dt(s,typeof e!="symbol"?e+"":e,t);import{aM as B,r as de,aN as Rt,a2 as oe,a1 as Vt,M as ae,aO as Ot,aP as Ht,j as x,aQ as Ut,aR as Yt,V as me,R as $t,e as Ft,_ as H,U as Me,an as ke,c as pt,S as Gt,P as Bt,H as Xe,aS as zt,aT as Wt,W as qt,aU as Xt,Q as $e}from"./three-core-0fX1SOzE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const jt="modulepreload",Qt=function(s,e){return new URL(s,e).href},je={},D=function(e,t,i){let n=Promise.resolve();if(t&&t.length>0){const a=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),l=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));n=Promise.allSettled(t.map(h=>{if(h=Qt(h,i),h in je)return;je[h]=!0;const u=h.endsWith(".css"),d=u?'[rel="stylesheet"]':"";if(!!i)for(let w=a.length-1;w>=0;w--){const y=a[w];if(y.href===h&&(!u||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${h}"]${d}`))return;const v=document.createElement("link");if(v.rel=u?"stylesheet":jt,u||(v.as="script"),v.crossOrigin="",v.href=h,l&&v.setAttribute("nonce",l),document.head.appendChild(v),u)return new Promise((w,y)=>{v.addEventListener("load",w),v.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${h}`)))})}))}function o(a){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=a,window.dispatchEvent(c),!c.defaultPrevented)throw a}return n.then(a=>{for(const c of a||[])c.status==="rejected"&&o(c.reason);return e().catch(o)})};var f=(s=>(s.INVALID_ROOT="INVALID_ROOT",s.MISSING_APP_NAME="MISSING_APP_NAME",s.MUSEUMS_NOT_ARRAY="MUSEUMS_NOT_ARRAY",s.MUSEUMS_EMPTY="MUSEUMS_EMPTY",s.MISSING_MUSEUM_ID="MISSING_MUSEUM_ID",s.DUPLICATE_MUSEUM_ID="DUPLICATE_MUSEUM_ID",s.MISSING_MUSEUM_NAME="MISSING_MUSEUM_NAME",s.MISSING_MUSEUM_COVER="MISSING_MUSEUM_COVER",s.MISSING_MUSEUM_MAP="MISSING_MUSEUM_MAP",s.MISSING_MAP_IMAGE="MISSING_MAP_IMAGE",s.INVALID_MAP_WIDTH="INVALID_MAP_WIDTH",s.INVALID_MAP_HEIGHT="INVALID_MAP_HEIGHT",s.SCENES_NOT_ARRAY="SCENES_NOT_ARRAY",s.SCENES_EMPTY="SCENES_EMPTY",s.MISSING_SCENE_ID="MISSING_SCENE_ID",s.DUPLICATE_SCENE_ID="DUPLICATE_SCENE_ID",s.MISSING_SCENE_NAME="MISSING_SCENE_NAME",s.MISSING_PANO="MISSING_PANO",s.INVALID_PANO_URL="INVALID_PANO_URL",s.INVALID_PANOLOW_URL="INVALID_PANOLOW_URL",s.MISSING_THUMB="MISSING_THUMB",s.MISSING_INITIAL_VIEW="MISSING_INITIAL_VIEW",s.INVALID_YAW="INVALID_YAW",s.INVALID_PITCH="INVALID_PITCH",s.INVALID_FOV="INVALID_FOV",s.MISSING_MAP_POINT="MISSING_MAP_POINT",s.INVALID_MAP_POINT_X="INVALID_MAP_POINT_X",s.INVALID_MAP_POINT_Y="INVALID_MAP_POINT_Y",s.HOTSPOTS_NOT_ARRAY="HOTSPOTS_NOT_ARRAY",s.MISSING_HOTSPOT_ID="MISSING_HOTSPOT_ID",s.DUPLICATE_HOTSPOT_ID="DUPLICATE_HOTSPOT_ID",s.INVALID_HOTSPOT_TYPE="INVALID_HOTSPOT_TYPE",s.MISSING_HOTSPOT_LABEL="MISSING_HOTSPOT_LABEL",s.INVALID_HOTSPOT_YAW="INVALID_HOTSPOT_YAW",s.INVALID_HOTSPOT_PITCH="INVALID_HOTSPOT_PITCH",s.MISSING_HOTSPOT_TARGET="MISSING_HOTSPOT_TARGET",s.MISSING_TARGET_MUSEUM_ID="MISSING_TARGET_MUSEUM_ID",s.MISSING_TARGET_SCENE_ID="MISSING_TARGET_SCENE_ID",s.INVALID_TARGET_YAW="INVALID_TARGET_YAW",s.INVALID_TARGET_PITCH="INVALID_TARGET_PITCH",s.INVALID_TARGET_FOV="INVALID_TARGET_FOV",s.MISSING_TARGET_URL="MISSING_TARGET_URL",s))(f||{});function Kt(s){const e=[];if(!s||typeof s!="object")return e.push({code:"INVALID_ROOT",path:"root",message:"配置必须是对象",fieldName:"配置根对象"}),e;if((!s.appName||typeof s.appName!="string"||s.appName.trim()==="")&&e.push({code:"MISSING_APP_NAME",path:"appName",message:"appName 必须是非空字符串",fieldName:"应用名称"}),!Array.isArray(s.museums))return e.push({code:"MUSEUMS_NOT_ARRAY",path:"museums",message:"museums 必须是数组",fieldName:"博物馆列表"}),e;s.museums.length===0&&e.push({code:"MUSEUMS_EMPTY",path:"museums",message:"museums 数组不能为空",fieldName:"博物馆列表"});const t=new Set;return s.museums.forEach((i,n)=>{const o=`museums[${n}]`,a=i.name&&typeof i.name=="string"?i.name:void 0;if(!i.id||typeof i.id!="string"||i.id.trim()===""?e.push({code:"MISSING_MUSEUM_ID",path:`${o}.id`,message:"id 必须是非空字符串",museumName:a,fieldName:"博物馆 ID"}):(t.has(i.id)&&e.push({code:"DUPLICATE_MUSEUM_ID",path:`${o}.id`,message:`博物馆 ID "${i.id}" 重复`,museumName:a,fieldName:"博物馆 ID"}),t.add(i.id)),(!i.name||typeof i.name!="string"||i.name.trim()==="")&&e.push({code:"MISSING_MUSEUM_NAME",path:`${o}.name`,message:"name 必须是非空字符串",museumName:void 0,fieldName:"博物馆名称"}),(!i.cover||typeof i.cover!="string"||i.cover.trim()==="")&&e.push({code:"MISSING_MUSEUM_COVER",path:`${o}.cover`,message:"cover 必须是有效的 URL 字符串",museumName:a,fieldName:"封面图"}),!i.map||typeof i.map!="object"?e.push({code:"MISSING_MUSEUM_MAP",path:`${o}.map`,message:"map 必须是对象",museumName:a,fieldName:"地图配置"}):((!i.map.image||typeof i.map.image!="string"||i.map.image.trim()==="")&&e.push({code:"MISSING_MAP_IMAGE",path:`${o}.map.image`,message:"map.image 必须是有效的 URL 字符串",museumName:a,fieldName:"地图图片"}),(typeof i.map.width!="number"||i.map.width<=0)&&e.push({code:"INVALID_MAP_WIDTH",path:`${o}.map.width`,message:"map.width 必须是大于 0 的数字",museumName:a,fieldName:"地图宽度"}),(typeof i.map.height!="number"||i.map.height<=0)&&e.push({code:"INVALID_MAP_HEIGHT",path:`${o}.map.height`,message:"map.height 必须是大于 0 的数字",museumName:a,fieldName:"地图高度"})),!Array.isArray(i.scenes))e.push({code:"SCENES_NOT_ARRAY",path:`${o}.scenes`,message:"scenes 必须是数组",museumName:a,fieldName:"场景列表"});else{i.scenes.length===0&&e.push({code:"SCENES_EMPTY",path:`${o}.scenes`,message:"scenes 数组不能为空",museumName:a,fieldName:"场景列表"});const c=new Set;i.scenes.forEach((l,h)=>{var y;const u=`${o}.scenes[${h}]`,d=l.name&&typeof l.name=="string"?l.name:void 0;!l.id||typeof l.id!="string"||l.id.trim()===""?e.push({code:"MISSING_SCENE_ID",path:`${u}.id`,message:"id 必须是非空字符串",museumName:a,sceneName:d,fieldName:"场景 ID"}):(c.has(l.id)&&e.push({code:"DUPLICATE_SCENE_ID",path:`${u}.id`,message:`场景 ID "${l.id}" 在博物馆内重复`,museumName:a,sceneName:d,fieldName:"场景 ID"}),c.add(l.id)),(!l.name||typeof l.name!="string"||l.name.trim()==="")&&e.push({code:"MISSING_SCENE_NAME",path:`${u}.name`,message:"name 必须是非空字符串",museumName:a,sceneName:void 0,fieldName:"场景名称"});const m=!!l.pano,v=!!l.panoLow,w=!!((y=l.panoTiles)!=null&&y.manifest);if(!m&&!v&&!w?e.push({code:"MISSING_PANO",path:`${u}.pano`,message:"pano / panoLow / panoTiles 至少需要提供一个",museumName:a,sceneName:d,fieldName:"全景图"}):(l.pano&&(typeof l.pano!="string"||l.pano.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${u}.pano`,message:"pano 必须是有效的 URL 字符串",museumName:a,sceneName:d,fieldName:"高清全景图"}),l.panoLow&&(typeof l.panoLow!="string"||l.panoLow.trim()==="")&&e.push({code:"INVALID_PANOLOW_URL",path:`${u}.panoLow`,message:"panoLow 必须是有效的 URL 字符串",museumName:a,sceneName:d,fieldName:"低清全景图"}),l.panoTiles&&(typeof l.panoTiles!="object"?e.push({code:"INVALID_PANO_URL",path:`${u}.panoTiles`,message:"panoTiles 必须是对象，包含 manifest",museumName:a,sceneName:d,fieldName:"瓦片元数据"}):(!l.panoTiles.manifest||typeof l.panoTiles.manifest!="string"||l.panoTiles.manifest.trim()==="")&&e.push({code:"INVALID_PANO_URL",path:`${u}.panoTiles.manifest`,message:"panoTiles.manifest 必须是有效的字符串",museumName:a,sceneName:d,fieldName:"瓦片 manifest"}))),(!l.thumb||typeof l.thumb!="string"||l.thumb.trim()==="")&&e.push({code:"MISSING_THUMB",path:`${u}.thumb`,message:"thumb 必须是有效的 URL 字符串",museumName:a,sceneName:d,fieldName:"缩略图"}),!l.initialView||typeof l.initialView!="object"?e.push({code:"MISSING_INITIAL_VIEW",path:`${u}.initialView`,message:"initialView 必须是对象",museumName:a,sceneName:d,fieldName:"初始视角"}):(typeof l.initialView.yaw!="number"&&e.push({code:"INVALID_YAW",path:`${u}.initialView.yaw`,message:"initialView.yaw 必须是数字",museumName:a,sceneName:d,fieldName:"水平角度"}),typeof l.initialView.pitch!="number"&&e.push({code:"INVALID_PITCH",path:`${u}.initialView.pitch`,message:"initialView.pitch 必须是数字",museumName:a,sceneName:d,fieldName:"垂直角度"}),l.initialView.fov!==void 0&&typeof l.initialView.fov!="number"&&e.push({code:"INVALID_FOV",path:`${u}.initialView.fov`,message:"initialView.fov 必须是数字",museumName:a,sceneName:d,fieldName:"视野角度"})),!l.mapPoint||typeof l.mapPoint!="object"?e.push({code:"MISSING_MAP_POINT",path:`${u}.mapPoint`,message:"mapPoint 必须是对象",museumName:a,sceneName:d,fieldName:"地图点位"}):(typeof l.mapPoint.x!="number"&&e.push({code:"INVALID_MAP_POINT_X",path:`${u}.mapPoint.x`,message:"mapPoint.x 必须是数字",museumName:a,sceneName:d,fieldName:"地图点位 X 坐标"}),typeof l.mapPoint.y!="number"&&e.push({code:"INVALID_MAP_POINT_Y",path:`${u}.mapPoint.y`,message:"mapPoint.y 必须是数字",museumName:a,sceneName:d,fieldName:"地图点位 Y 坐标"})),!Array.isArray(l.hotspots))e.push({code:"HOTSPOTS_NOT_ARRAY",path:`${u}.hotspots`,message:"hotspots 必须是数组",museumName:a,sceneName:d,fieldName:"热点列表"});else{const g=new Set;l.hotspots.forEach((p,b)=>{const I=`${u}.hotspots[${b}]`;!p.id||typeof p.id!="string"||p.id.trim()===""?e.push({code:"MISSING_HOTSPOT_ID",path:`${I}.id`,message:"id 必须是非空字符串",museumName:a,sceneName:d,fieldName:"热点 ID"}):(g.has(p.id)&&e.push({code:"DUPLICATE_HOTSPOT_ID",path:`${I}.id`,message:`热点 ID "${p.id}" 在场景内重复`,museumName:a,sceneName:d,fieldName:"热点 ID"}),g.add(p.id)),p.type!=="scene"&&p.type!=="video"&&p.type!=="image"&&p.type!=="info"&&e.push({code:"INVALID_HOTSPOT_TYPE",path:`${I}.type`,message:'type 必须是 "scene"、"video"、"image" 或 "info"',museumName:a,sceneName:d,fieldName:"热点类型"}),(!p.label||typeof p.label!="string"||p.label.trim()==="")&&e.push({code:"MISSING_HOTSPOT_LABEL",path:`${I}.label`,message:"label 必须是非空字符串",museumName:a,sceneName:d,fieldName:"热点标签"}),typeof p.yaw!="number"&&e.push({code:"INVALID_HOTSPOT_YAW",path:`${I}.yaw`,message:"yaw 必须是数字",museumName:a,sceneName:d,fieldName:"热点水平角度"}),typeof p.pitch!="number"&&e.push({code:"INVALID_HOTSPOT_PITCH",path:`${I}.pitch`,message:"pitch 必须是数字",museumName:a,sceneName:d,fieldName:"热点垂直角度"}),p.type==="scene"?!p.target||typeof p.target!="object"?e.push({code:"MISSING_HOTSPOT_TARGET",path:`${I}.target`,message:"scene 类型热点必须提供 target 对象",museumName:a,sceneName:d,fieldName:"热点目标配置"}):((!p.target.museumId||typeof p.target.museumId!="string")&&e.push({code:"MISSING_TARGET_MUSEUM_ID",path:`${I}.target.museumId`,message:"scene 类型热点的 target.museumId 必须是非空字符串",museumName:a,sceneName:d,fieldName:"目标博物馆 ID"}),typeof p.target.sceneId!="string"&&e.push({code:"MISSING_TARGET_SCENE_ID",path:`${I}.target.sceneId`,message:"scene 类型热点的 target.sceneId 必须是字符串（允许空字符串，用户后续补全）",museumName:a,sceneName:d,fieldName:"目标场景 ID"}),p.target.yaw!==void 0&&typeof p.target.yaw!="number"&&e.push({code:"INVALID_TARGET_YAW",path:`${I}.target.yaw`,message:"target.yaw 必须是数字",museumName:a,sceneName:d,fieldName:"目标水平角度"}),p.target.pitch!==void 0&&typeof p.target.pitch!="number"&&e.push({code:"INVALID_TARGET_PITCH",path:`${I}.target.pitch`,message:"target.pitch 必须是数字",museumName:a,sceneName:d,fieldName:"目标垂直角度"}),p.target.fov!==void 0&&typeof p.target.fov!="number"&&e.push({code:"INVALID_TARGET_FOV",path:`${I}.target.fov`,message:"target.fov 必须是数字",museumName:a,sceneName:d,fieldName:"目标视野角度"})):p.type==="video"&&p.target&&typeof p.target!="object"&&e.push({code:"MISSING_HOTSPOT_TARGET",path:`${I}.target`,message:"video 类型热点的 target 必须是对象（如果提供）",museumName:a,sceneName:d,fieldName:"热点目标配置"})})}})}}),e}let j=null;async function Qe(){if(j)return j;try{const s=await fetch("./config.json",{cache:"no-store"});if(!s.ok)throw new Error(`加载配置失败: ${s.status}`);const e=await s.json(),t=Kt(e);if(t.length>0){const i=new Error("配置校验失败");throw i.validationErrors=t,i}return j=e,j}catch(s){throw console.error("加载配置失败:",s),s}}function Ke(){j=null}function De(s){if(j)return j.museums.find(e=>e.id===s)}function Jt(s,e){const t=De(s);if(t)return t.scenes.find(i=>i.id===e)}function ft(s){const e=new URL(window.location.href);return e.search="",Object.entries(s).forEach(([t,i])=>{i!=null&&i!==""&&e.searchParams.set(t,String(i))}),e.pathname+e.search+e.hash}function Zt(){return window.location.pathname}function ei(){if(window.location.pathname.includes("//")){const s=window.location.pathname.replace(/\/{2,}/g,"/");history.replaceState({},"",s+window.location.search+window.location.hash)}}let Je=null,Ze=0;const ti=200;function re(s){if(s.type==="focus"){const e=`${s.museumId}:${s.sceneId}`,t=Date.now();if(e===Je&&t-Ze<ti)return;Je=e,Ze=t}window.dispatchEvent(new CustomEvent("vr:scene-focus",{detail:s}))}function ii(s){const e=t=>{s(t.detail)};return window.addEventListener("vr:scene-focus",e),()=>{window.removeEventListener("vr:scene-focus",e)}}function et(){const s=new URLSearchParams(window.location.search),e=s.get("yaw"),t=s.get("pitch"),i=s.get("fov");return{museumId:s.get("museum")||void 0,sceneId:s.get("scene")||void 0,yaw:e?parseFloat(e):void 0,pitch:t?parseFloat(t):void 0,fov:i?parseFloat(i):void 0}}function si(){return new URLSearchParams(window.location.search).get("debug")==="1"}function ni(){const s=new URLSearchParams(window.location.search);return s.get("editor")==="1"||s.get("debug")==="1"}function tt(){const s=Zt();window.history.pushState({},"",s),window.dispatchEvent(new Event("popstate"))}function Re(s){const e=ft({museum:s});window.history.pushState({},"",e),window.dispatchEvent(new Event("popstate"))}function W(s,e,t){const i=ft({museum:s,scene:e,yaw:t==null?void 0:t.yaw,pitch:t==null?void 0:t.pitch,fov:t==null?void 0:t.fov});window.history.pushState({},"",i),re({type:"focus",museumId:s,sceneId:e,source:"dock",ts:Date.now()}),window.dispatchEvent(new Event("popstate"))}var Y=(s=>(s.THUMB="thumb",s.PANO_LOW="panoLow",s.PANO="pano",s.VIDEO="video",s.COVER="cover",s.MAP="map",s.DOLLHOUSE="dollhouse",s))(Y||{});const oi=["/assets/panos/"],ai=[],ri="/config.json",li=1800,ce="vrplayer.assetCdn.lastSuccess",ci=12*60*60*1e3;let se=null,Q=null,F="idle",X=0;function hi(s){const e=s.trim();return e?e.startsWith("/")?e:`/${e}`:""}function it(s,e){const t=Array.isArray(s)&&s.length>0?s:e,i=new Set;for(const n of t){if(typeof n!="string")continue;const o=hi(n);o&&i.add(o)}return Array.from(i)}function gt(s){return s.replace(/\/+$/,"")}function di(s){const e=[];Array.isArray(s.baseUrls)&&e.push(...s.baseUrls),typeof s.baseUrl=="string"&&e.push(s.baseUrl);const t=new Set;for(const i of e){if(typeof i!="string")continue;const n=gt(i.trim());n&&t.add(n)}return Array.from(t)}function ui(){var s;return typeof window<"u"&&((s=window.location)!=null&&s.origin)?window.location.origin:typeof location<"u"&&location.origin?location.origin:null}function Fe(){if(typeof window>"u")return null;try{return window.localStorage}catch{return null}}function mi(s){const e=Fe();if(!e)return null;try{const t=e.getItem(ce);if(!t)return null;const i=JSON.parse(t),n=typeof i.baseUrl=="string"?gt(i.baseUrl.trim()):"",o=typeof i.expiresAt=="number"&&Number.isFinite(i.expiresAt)?i.expiresAt:0;return!n||o<=Date.now()||!s.baseUrls.includes(n)?(e.removeItem(ce),null):n}catch{return e.removeItem(ce),null}}function pi(s,e){const t=Fe();if(!t||!e.baseUrls.includes(s))return;const i=Date.now(),n={baseUrl:s,updatedAt:i,expiresAt:i+ci};try{t.setItem(ce,JSON.stringify(n))}catch{}}function st(){const s=Fe();if(s)try{s.removeItem(ce)}catch{}}function vt(s){const e=s.match(/^([^?#]*)([?#].*)?$/);return e?{path:e[1]||"",suffix:e[2]||""}:{path:s,suffix:""}}function nt(s,e){return e.some(t=>s.startsWith(t))}function wt(s,e){return!(!nt(s,e.includePrefixes)||nt(s,e.excludePrefixes))}function yt(s,e){const{path:t,suffix:i}=vt(s);return`${e}${t}${i}`}function fi(s,e,t){if(!/^https?:\/\//i.test(s))return null;try{const i=new URL(s),n=ui();return!n||i.origin!==n||!wt(i.pathname,e)?null:yt(`${i.pathname}${i.search}${i.hash}`,t)}catch{return null}}function gi(s){if(typeof s!="string"||s.trim()==="")return ri;const e=s.trim();return e.startsWith("/")?e:`/${e}`}function vi(s,e){const t=e.includes("?")?"&":"?";return`${s}${e}${t}__cdn_probe=${Date.now()}`}async function wi(s,e,t){if(t!==X||typeof window>"u"||typeof fetch!="function")return!1;const i=typeof AbortController<"u"?new AbortController:null,n=window.setTimeout(()=>i==null?void 0:i.abort(),e.probeTimeoutMs);try{return(await fetch(vi(s,e.probePath),{method:"GET",mode:"cors",cache:"no-store",referrerPolicy:"no-referrer",signal:i==null?void 0:i.signal})).ok}catch{return!1}finally{window.clearTimeout(n)}}function Ve(s=!1){const e=se;if(!e||!e.enabled||!s&&Q||F==="probing")return;if(typeof window>"u"||typeof fetch!="function"){F="failed";return}F="probing";const t=++X;(async()=>{for(const i of e.baseUrls){const n=await wi(i,e,t);if(t!==X)return;if(n){Q=i,pi(i,e),F="ok";return}}t===X&&(Q=null,st(),F="failed")})().catch(()=>{t===X&&(Q=null,st(),F="failed")}).finally(()=>{})}function Ne(s){if(X+=1,Q=null,F="idle",!s||s.enabled===!1){se=null;return}const e=di(s);if(e.length===0){se=null;return}se={enabled:!0,baseUrls:e,includePrefixes:it(s.includePrefixes,oi),excludePrefixes:it(s.excludePrefixes,ai),probePath:gi(s.probePath),probeTimeoutMs:typeof s.probeTimeoutMs=="number"&&Number.isFinite(s.probeTimeoutMs)?Math.max(200,Math.floor(s.probeTimeoutMs)):li};const t=mi(se);if(t){Q=t,F="ok",Ve(!0);return}Ve(!1)}function G(s,e){if(!s||typeof s!="string"||s.trim()==="")return"";const t=s.trim(),i=se;if(!i||!i.enabled)return t;const n=Q;if(!n)return Ve(),t;const o=fi(t,i,n);if(o)return o;if(t.startsWith("//"))return t;const{path:a}=vt(t);return!a.startsWith("/")||!wt(a,i)?t:yt(t,n)}function ue(){const s=document;return!!(document.fullscreenElement||s.webkitFullscreenElement)}function yi(){const s=()=>{};document.addEventListener("fullscreenchange",s),document.addEventListener("webkitfullscreenchange",s)}var E=(s=>(s.LOADING_LOW="loadingLow",s.LOW_READY="lowReady",s.LOADING_HIGH="loadingHigh",s.HIGH_READY="highReady",s.DEGRADED="degraded",s.ERROR="error",s))(E||{});class bi{constructor(){r(this,"element");r(this,"currentStatus","loadingLow");r(this,"autoHideTimer",null);r(this,"maxVisibleTimer",null);r(this,"maxVisibleMs",1e4);r(this,"readyHideMs",2500);r(this,"metricsText","");this.element=document.createElement("div"),this.element.className="quality-indicator",this.render(),this.applyStyles()}updateStatus(e){if(ue()){this.hide();return}if(this.currentStatus=e,this.render(),this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),this.maxVisibleTimer&&(clearTimeout(this.maxVisibleTimer),this.maxVisibleTimer=null),e==="loadingLow"||e==="loadingHigh"||e==="error"||e==="degraded"){this.show(),this.maxVisibleTimer=window.setTimeout(()=>{this.hide()},this.maxVisibleMs);return}(e==="highReady"||e==="lowReady")&&(this.show(),this.autoHideTimer=window.setTimeout(()=>{this.hide()},this.readyHideMs))}updateMetrics(e){const t=new URLSearchParams(window.location.search);if(!(t.get("metrics")==="1"||t.get("metrics")==="true"||t.get("tilesDebug")==="1"))return;const n=e.lowReadyMs??-1,o=e.highReadyMs??-1,a=e.tileHitRate??0,c=e.tilesFailed??0,l=e.tilesRetries??0,h=e.perfMode??"",u=e.renderSource??"";this.metricsText=`low:${n}ms high:${o}ms hit:${a}% fail:${c} retry:${l} `+`${h?`perf:${h} `:""}${u?`src:${u}`:""}`.trim(),this.render()}render(){const{text:e,icon:t,className:i}=this.getStatusInfo();this.element.innerHTML=`
      <div class="quality-indicator-content ${i}">
        <span class="quality-icon">${t}</span>
        <span class="quality-text">${e}</span>
        ${this.metricsText?`<span class="quality-metrics">${this.metricsText}</span>`:""}
      </div>
    `}getStatusInfo(){switch(this.currentStatus){case"loadingLow":return{text:"正在加载低清图...",icon:"⏳",className:"status-loading"};case"lowReady":return{text:"低清图已加载",icon:"✨",className:"status-ready"};case"loadingHigh":return{text:"正在加载高清图...",icon:"⏳",className:"status-loading"};case"highReady":return{text:"已切换至高清",icon:"✨",className:"status-ready"};case"degraded":return{text:"网络较慢，已先使用低清",icon:"⚠️",className:"status-degraded"};case"error":return{text:"加载失败",icon:"❌",className:"status-error"};default:return{text:"",icon:"",className:""}}}show(){this.element.classList.add("show")}hide(){this.element.classList.remove("show")}getElement(){return this.element}remove(){this.autoHideTimer&&clearTimeout(this.autoHideTimer),this.maxVisibleTimer&&clearTimeout(this.maxVisibleTimer),this.element.remove()}applyStyles(){const e=document.createElement("style");e.textContent=`
      .quality-indicator {
        position: fixed;
        left: 50%;
        top: calc(16px + env(safe-area-inset-top, 0px));
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transform: translateX(-50%) translateY(10px);
        transition: opacity 0.3s, transform 0.3s;
      }
      .quality-indicator.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      .quality-indicator-content {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.75);
        border-radius: 20px;
        backdrop-filter: blur(10px);
        font-size: 13px;
        color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .quality-icon {
        font-size: 14px;
      }
      .quality-text {
        white-space: nowrap;
      }
      .quality-metrics {
        margin-left: 6px;
        font-size: 11px;
        opacity: 0.7;
        white-space: nowrap;
      }
      .status-loading {
        border-left: 3px solid #4a90e2;
      }
      .status-ready {
        border-left: 3px solid #27ae60;
      }
      .status-degraded {
        border-left: 3px solid #f39c12;
      }
      .status-error {
        border-left: 3px solid #e74c3c;
      }
      @media (max-width: 480px), ((max-width: 520px) and (pointer: coarse)) {
        .quality-indicator-content {
          padding: 6px 12px;
          font-size: 12px;
        }
      }
    `,document.head.appendChild(e)}}const Ii=Object.freeze(Object.defineProperty({__proto__:null,LoadStatus:E,QualityIndicator:bi},Symbol.toStringTag,{value:"Module"})),bt="vr_quality";function Oe(){if(typeof window>"u")return"high";try{const s=window.localStorage.getItem(bt);if(s==="low"||s==="high")return s}catch{}return"high"}function Ei(s){if(!(typeof window>"u"))try{window.localStorage.setItem(bt,s)}catch{}}function Si(s=512){const e=document.createElement("canvas");e.width=s,e.height=s;const t=e.getContext("2d");if(!t){const h=new B(e);return h.needsUpdate=!0,h}const i=s/2,n=s/2,o=s/2*.92;t.clearRect(0,0,s,s);const a=t.createRadialGradient(i,n,o*.25,i,n,o);a.addColorStop(0,"rgba(0,0,0,0.00)"),a.addColorStop(.55,"rgba(0,0,0,0.18)"),a.addColorStop(1,"rgba(0,0,0,0.55)"),t.fillStyle=a,t.beginPath(),t.arc(i,n,o,0,Math.PI*2),t.closePath(),t.fill(),t.fillStyle="rgba(0,0,0,0.55)",t.beginPath(),t.arc(i,n,o*.28,0,Math.PI*2),t.closePath(),t.fill();const c=t.createRadialGradient(i,n,0,i,n,o*.42);c.addColorStop(0,"rgba(0,0,0,0.22)"),c.addColorStop(1,"rgba(0,0,0,0.00)"),t.fillStyle=c,t.beginPath(),t.arc(i,n,o*.42,0,Math.PI*2),t.closePath(),t.fill(),t.save(),t.translate(i,n);for(let h=0;h<360;h+=30){const u=h*Math.PI/180,d=h%90===0,m=d?o*.12:o*.07,v=d?2:1;t.strokeStyle=d?"rgba(255,255,255,0.25)":"rgba(255,255,255,0.14)",t.lineWidth=v,t.beginPath(),t.moveTo(Math.sin(u)*(o-m),-Math.cos(u)*(o-m)),t.lineTo(Math.sin(u)*o,-Math.cos(u)*o),t.stroke()}t.restore(),t.strokeStyle="rgba(255,255,255,0.08)",t.lineWidth=2,t.beginPath(),t.arc(i,n,o,0,Math.PI*2),t.closePath(),t.stroke();const l=new B(e);return l.colorSpace=de,l.center.set(.5,.5),l.rotation=0,l.flipY=!1,l.needsUpdate=!0,l}const P=typeof window<"u"?new URLSearchParams(window.location.search).get("debug")==="1":!1;function M(...s){P&&console.debug("[VR Debug]",...s)}function Mi(s){return Math.max(0,Math.min(1,s))}function Ti(s){const e=Mi(s);return e*e*(3-2*e)}class Li{constructor(e,t){r(this,"mesh");r(this,"needleMesh",null);r(this,"texture");r(this,"radius");r(this,"opacity",0);r(this,"northYaw",0);r(this,"debugHelper",null);r(this,"labelSprites",new Map);r(this,"patchRadius",0);r(this,"showPitchDeg",-45);r(this,"fadeRangeDeg",18);r(this,"fadeTauMs",140);r(this,"lastRotationY",0);r(this,"debugFrameCount",0);r(this,"isDebugVisible",!0);this.radius=t;const i=t*.18;this.patchRadius=i;const n=new Rt(i,96);n.rotateX(Math.PI/2),this.texture=Si(512);const o=new oe({map:this.texture,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1,side:Vt});this.mesh=new ae(n,o),this.mesh.name="NadirPatch-compass-disk",this.mesh.position.set(0,-t+.5,0),this.mesh.renderOrder=9999,this.mesh.visible=!1,this.mesh.rotation.y=0,e.add(this.mesh);const a=i*.008,c=i*.35,l=new Ot(a,a,c,8);l.rotateX(Math.PI/2),l.translate(0,0,c/2);const h=new oe({color:16777215,transparent:!0,opacity:.9,depthTest:!1,depthWrite:!1});if(this.needleMesh=new ae(l,h),this.needleMesh.name="NadirPatch-compass-needle",this.needleMesh.position.set(0,-t+.51,0),this.needleMesh.rotation.order="YXZ",this.needleMesh.renderOrder=1e4,this.needleMesh.visible=!1,e.add(this.needleMesh),this.createLabelSprites(e,i,t),P&&(o.color.setHex(65535),this.debugHelper=new Ht(i*.5),this.debugHelper.position.copy(this.mesh.position),this.debugHelper.renderOrder=10001,e.add(this.debugHelper),console.debug("[NadirPatch] 对象已创建:",{uuid:this.mesh.uuid,name:this.mesh.name,type:this.mesh.type,position:this.mesh.position,rotation:this.mesh.rotation})),typeof window<"u"){const u=d=>{(d.key==="N"||d.key==="n")&&!(d.target instanceof HTMLInputElement||d.target instanceof HTMLTextAreaElement)&&(d.preventDefault(),this.isDebugVisible=!this.isDebugVisible,this.mesh.visible=this.isDebugVisible&&this.opacity>.01,this.needleMesh&&(this.needleMesh.visible=this.isDebugVisible&&this.opacity>.01),this.debugHelper&&(this.debugHelper.visible=this.isDebugVisible&&this.opacity>.01),console.debug(`[NadirPatch] 显示状态切换为: ${this.isDebugVisible?"显示":"隐藏"}`))};window.addEventListener("keydown",u)}}setNorthYaw(e){this.northYaw=e}update(e,t,i){var v;const n=t.yaw,o=this.northYaw??0,a=x.degToRad(-o);this.mesh.rotation.y=a,this.texture.rotation=0,this.texture.center.set(.5,.5);const c=-o;this.updateLabelSprites(c),this.needleMesh&&(this.needleMesh.rotation.y=x.degToRad(n)),P&&(this.debugFrameCount++,this.debugFrameCount%30===0&&(Math.abs(this.mesh.rotation.y-this.lastRotationY)>.001&&console.debug("[NadirPatch] 旋转变化:",{frame:this.debugFrameCount,cameraYaw:n.toFixed(2),northYaw:o.toFixed(2),needleYaw:n.toFixed(2),diskRotationY:this.mesh.rotation.y,needleRotationY:(v=this.needleMesh)==null?void 0:v.rotation.y,diskPosition:this.mesh.position}),this.lastRotationY=this.mesh.rotation.y));const h=Ti((this.showPitchDeg-t.pitch)/this.fadeRangeDeg),u=1-Math.exp(-(i||16.7)/this.fadeTauMs);this.opacity=this.opacity+(h-this.opacity)*u;const d=this.mesh.material;d.opacity=this.opacity;const m=this.isDebugVisible&&this.opacity>.01;if(this.mesh.visible=m,this.needleMesh){this.needleMesh.visible=m;const w=this.needleMesh.material;w.opacity=this.opacity*.9}this.labelSprites.forEach(w=>{w.visible=m;const y=w.material;y.opacity=this.opacity*.85}),this.debugHelper&&(this.debugHelper.visible=m)}createLabelSprites(e,t,i){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:o})=>{const a=document.createElement("canvas"),c=128;a.width=c,a.height=c;const l=a.getContext("2d");if(!l)return;l.clearRect(0,0,c,c),l.save(),l.shadowColor="rgba(255, 255, 255, 0.8)",l.shadowBlur=8,l.shadowOffsetX=0,l.shadowOffsetY=0,l.fillStyle="rgba(255, 255, 255, 0.85)",l.font=`600 ${Math.round(c*.5)}px system-ui, -apple-system, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif`,l.textAlign="center",l.textBaseline="middle",l.fillText(o,c/2,c/2),l.restore();const h=new B(a);h.colorSpace=de,h.needsUpdate=!0;const u=new Ut({map:h,transparent:!0,opacity:0,depthTest:!1,depthWrite:!1}),d=new Yt(u);d.name=`NadirPatch-label-${o}`,d.position.set(0,-i+.52,0),d.renderOrder=10001,d.visible=!1;const m=t*.15;d.scale.set(m,m,1),e.add(d),this.labelSprites.set(o,d)})}updateLabelSprites(e){[{text:"北",baseAngle:0},{text:"东",baseAngle:270},{text:"南",baseAngle:180},{text:"西",baseAngle:90}].forEach(({text:i,baseAngle:n})=>{const o=this.labelSprites.get(i);if(!o)return;const a=n+e,c=this.patchRadius*.56,l=x.degToRad(a),h=-this.radius+.5,u=Math.sin(l)*c,d=Math.cos(l)*c;o.position.set(u,h+.02,d);const m=new me(0,0,0);o.lookAt(m)})}dispose(e){e.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose(),this.needleMesh&&(e.remove(this.needleMesh),this.needleMesh.geometry.dispose(),this.needleMesh.material.dispose()),this.labelSprites.forEach(t=>{e.remove(t),t.material.dispose(),t.material.map&&t.material.map.dispose()}),this.labelSprites.clear(),this.debugHelper&&(e.remove(this.debugHelper),this.debugHelper.dispose())}}function Ni(s,e,t){const i=(s-t.left)/t.width*2-1,n=-((e-t.top)/t.height*2-1);return{x:i,y:n}}function Ci(s,e,t,i=500){const n=new $t;n.setFromCamera(new Ft(s,e),t);const o=n.ray.direction;if(!o||o.length()===0)return null;const a=o.normalize(),c=Math.asin(Math.max(-1,Math.min(1,a.y))),l=x.radToDeg(c),h=Math.atan2(a.x,a.z);return{yaw:x.radToDeg(h),pitch:l}}const He=-55,Pi=-90;function Ge(s){const e=Math.max(0,Math.min(1,(s-He)/(Pi-He))),t=e,i=-e*8,n=1-e*.7,o=e*2;return{opacity:t,translateY:i,scaleY:n,blur:o,clarity:e}}function Be(s){return s<=He}class xi{constructor(){r(this,"listeners",new Map);r(this,"lastInteractionTs",0);r(this,"idleDelay",800);r(this,"idleTimer",null);r(this,"rafId",null);r(this,"isScheduled",!1);this.listeners.set("user-interacting",new Set),this.listeners.set("user-idle",new Set),this.listeners.set("ui-engaged",new Set)}on(e,t){const i=this.listeners.get(e);return i?(i.add(t),()=>{i.delete(t)}):(console.warn(`[InteractionBus] 未知事件类型: ${e}`),()=>{})}off(e,t){const i=this.listeners.get(e);i&&i.delete(t)}emit(e){this.isScheduled||(this.isScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.isScheduled=!1;const t=this.listeners.get(e);t&&t.forEach(i=>{try{i()}catch(n){console.error("[InteractionBus] 事件监听器执行失败:",n)}})}))}emitInteracting(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("user-interacting")}scheduleIdle(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.idleTimer=window.setTimeout(()=>{Date.now()-this.lastInteractionTs>=this.idleDelay&&(this.idleTimer=null,this.emit("user-idle"))},this.idleDelay)}emitUIEngaged(){this.lastInteractionTs=Date.now(),this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.emit("ui-engaged")}dispose(){this.idleTimer!==null&&(clearTimeout(this.idleTimer),this.idleTimer=null),this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.listeners.forEach(e=>e.clear()),this.listeners.clear()}}const C=new xi;class _i{constructor(e={}){r(this,"root");r(this,"disk");r(this,"mask");r(this,"polemask");r(this,"northLabel");r(this,"eastLabel");r(this,"southLabel");r(this,"westLabel");r(this,"needle");r(this,"currentYaw",0);r(this,"currentPitch",0);r(this,"northYaw",0);r(this,"sceneId","");r(this,"northYawLabel",null);r(this,"isVisible",!1);r(this,"unsubscribeInteracting",null);r(this,"unsubscribeIdle",null);r(this,"unsubscribeUIEngaged",null);r(this,"baseOpacity",0);this.root=document.createElement("div"),this.root.className="vr-compass",this.root.setAttribute("data-ui","CompassDisk"),this.root.style.outline="2px solid #ff00ff",this.disk=document.createElement("div"),this.disk.className="vr-compass__disk",this.disk.setAttribute("data-ui","CompassDisk-disk"),this.mask=document.createElement("div"),this.mask.className="vr-compass__mask",this.polemask=document.createElement("div"),this.polemask.className="vr-compass__polemask",this.polemask.setAttribute("aria-hidden","true"),this.northLabel=document.createElement("div"),this.northLabel.className="vr-compass__label vr-compass__label--north",this.northLabel.textContent="北",this.eastLabel=document.createElement("div"),this.eastLabel.className="vr-compass__label vr-compass__label--east",this.eastLabel.textContent="东",this.southLabel=document.createElement("div"),this.southLabel.className="vr-compass__label vr-compass__label--south",this.southLabel.textContent="南",this.westLabel=document.createElement("div"),this.westLabel.className="vr-compass__label vr-compass__label--west",this.westLabel.textContent="西",this.needle=document.createElement("div"),this.needle.className="vr-compass__needle",this.needle.setAttribute("data-ui","CompassDisk-needle"),this.northYawLabel=document.createElement("div"),this.northYawLabel.className="vr-compass__north-yaw-label",this.northYawLabel.style.cssText=`
      position: absolute;
      bottom: -20px;
      right: 10px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
      font-family: monospace;
      pointer-events: none;
      display: none;
    `,this.disk.appendChild(this.mask),this.disk.appendChild(this.polemask),this.disk.appendChild(this.northLabel),this.disk.appendChild(this.eastLabel),this.disk.appendChild(this.southLabel),this.disk.appendChild(this.westLabel),this.disk.appendChild(this.needle),this.root.appendChild(this.disk),this.root.appendChild(this.northYawLabel),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--compass-disk-rot","0deg"),this.root.style.setProperty("--compass-needle-rot","0deg"),this.root.style.setProperty("--compass-label-counter-rot","0deg"),this.setupInteractionListeners()}setupInteractionListeners(){this.unsubscribeInteracting=C.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=C.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=C.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}mount(e){e.appendChild(this.root)}setSceneId(e){this.sceneId=e,this.updateNorthYawLabel()}setNorthYaw(e){this.northYaw=e,this.updateNorthYawLabel()}updateNorthYawLabel(){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}updateYawLabel(e){this.northYawLabel&&(this.sceneId==="gate"&&typeof this.northYaw=="number"?(this.northYawLabel.textContent=`N=${this.northYaw.toFixed(1)} Yaw=${e.toFixed(1)}`,this.northYawLabel.style.display="block"):this.northYawLabel.style.display="none")}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,Be(t)){const n=Ge(t);this.baseOpacity=n.opacity,this.root.style.setProperty("--vr-ground-clarity",String(n.clarity)),this.root.style.opacity=n.opacity.toString();const o=`translateX(-50%) translateY(${n.translateY}px) scaleY(${n.scaleY})`;this.root.classList.contains("vr-ui-interacting")?this.root.style.transform=o:this.root.style.transform=o,this.root.style.setProperty("--vr-ground-base-blur",`${n.blur}px`);const a=e,l=-(this.northYaw??0),h=a;this.root.style.setProperty("--compass-disk-rot",`${l}deg`),this.root.style.setProperty("--compass-needle-rot",`${h}deg`);const u=42,d=(m,v)=>{const w=v+l,y=w+180;m.style.transform=`rotate(${w}deg) translateY(-${u}%) rotate(${y}deg)`};d(this.northLabel,0),d(this.eastLabel,270),d(this.southLabel,180),d(this.westLabel,90),this.updateYawLabel(e),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.northLabel.style.transform="",this.eastLabel.style.transform="",this.southLabel.style.transform="",this.westLabel.style.transform="",this.isVisible=!1,this.baseOpacity=0)}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=null),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=null),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=null),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}const ot=60,Ce=14,Ai=4,at=650,ki=120,rt=900,ve=-62,Di=150;class Ri{constructor(e){r(this,"root");r(this,"container");r(this,"dots",new Map);r(this,"dotYawDeg",new Map);r(this,"currentYaw",0);r(this,"currentPitch",0);r(this,"isVisible",!1);r(this,"museumId");r(this,"currentSceneId");r(this,"sceneHotspots");r(this,"hoverSceneId",null);r(this,"onNavigateToScene");r(this,"unsubscribeFocus");r(this,"lastYawDeg",0);r(this,"lastPitchDeg",0);r(this,"aimedSceneId",null);r(this,"isInteracting",!1);r(this,"unsubscribeInteracting");r(this,"unsubscribeIdle");r(this,"unsubscribeUIEngaged");r(this,"idleRecoveryTimer",null);r(this,"lastAimChangeTs",0);r(this,"autoNavTimer",null);r(this,"autoNavTargetSceneId",null);r(this,"lastAutoNavTs",0);r(this,"aimDebounceTimer",null);this.museumId=e.museumId,this.currentSceneId=e.currentSceneId,this.sceneHotspots=e.sceneHotspots,this.onNavigateToScene=e.onNavigateToScene||W,this.root=document.createElement("div"),this.root.className="vr-groundnav",this.root.setAttribute("data-ui","GroundNavDots"),this.root.style.outline="2px solid #00ffff",this.container=document.createElement("div"),this.container.className="vr-groundnav__container",this.root.appendChild(this.container),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.unsubscribeFocus=ii(t=>{this.handleSceneFocus(t)}),this.setupInteractionListeners(),this.renderDots()}setupInteractionListeners(){this.unsubscribeInteracting=C.on("user-interacting",()=>{M("统一终止触发点: 用户交互"),this.isInteracting=!0,this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav()}),this.unsubscribeIdle=C.on("user-idle",()=>{this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.idleRecoveryTimer=window.setTimeout(()=>{if(this.idleRecoveryTimer=null,!this.root.parentNode){M("idleRecoveryTimer: component disposed, skipping");return}this.isInteracting=!1},400)}),this.unsubscribeUIEngaged=C.on("ui-engaged",()=>{M("统一终止触发点: UI 点击"),this.clearAllTimers(),this.isInteracting=!1,this.clearAimed(),this.cancelAutoNav()})}clearAimDebounce(){this.aimDebounceTimer!==null&&(window.clearTimeout(this.aimDebounceTimer),this.aimDebounceTimer=null)}clearAllTimers(){this.clearAimDebounce(),this.idleRecoveryTimer!==null&&(clearTimeout(this.idleRecoveryTimer),this.idleRecoveryTimer=null),this.autoNavTimer!==null&&(clearTimeout(this.autoNavTimer),this.autoNavTimer=null)}normalizeDeg(e){return(e%360+360)%360}shortestDeltaDeg(e,t){return(this.normalizeDeg(e)-this.normalizeDeg(t)+180)%360-180}clearAimed(){if(this.aimedSceneId!==null){const e=this.dots.get(this.aimedSceneId);e&&(e.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId)),this.aimedSceneId=null,this.clearAimDebounce(),this.emitSceneAim("clear",null)}this.cancelAutoNav()}cancelAutoNav(){if(this.autoNavTimer!=null&&(window.clearTimeout(this.autoNavTimer),this.autoNavTimer=null),this.autoNavTargetSceneId!==null){const e=this.autoNavTargetSceneId;if(e){this.removeProgress(e);const t=this.dots.get(e);t&&t.classList.remove("is-autonav","is-autonav-progress"),this.emitSceneAutoNav("cancel",e)}this.autoNavTargetSceneId=null}}removeProgress(e){const t=this.dots.get(e);if(!t)return;const i=t.querySelector(".vr-groundnav__progress");i&&t.removeChild(i)}addProgress(e){const t=this.dots.get(e);if(!t)return;this.removeProgress(e);const i=document.createElement("div");i.className="vr-groundnav__progress",i.style.setProperty("--progress-duration",`${at}ms`),t.appendChild(i),t.classList.add("is-autonav-progress")}scheduleAutoNavIfAllowed(e){if(!e){M("scheduleAutoNavIfAllowed: sceneId is missing, skipping");return}const t=Date.now();if(this.isInteracting){M("scheduleAutoNavIfAllowed: isInteracting, skipping");return}if(this.lastPitchDeg>ve){M("scheduleAutoNavIfAllowed: pitch too high, skipping",this.lastPitchDeg);return}if(t-this.lastAutoNavTs<rt){M("scheduleAutoNavIfAllowed: cooldown, skipping");return}if(t-this.lastAimChangeTs<ki){M("scheduleAutoNavIfAllowed: min dwell, skipping");return}if(this.currentSceneId&&e===this.currentSceneId){M("scheduleAutoNavIfAllowed: same as current scene, skipping");return}this.autoNavTargetSceneId!==null&&this.autoNavTargetSceneId!==e&&this.cancelAutoNav(),M("scene-autonav: start",{sceneId:e}),this.autoNavTargetSceneId=e;const i=this.dots.get(e);i&&(i.classList.add("is-autonav"),this.addProgress(e)),this.emitSceneAutoNav("start",e),this.autoNavTimer=window.setTimeout(()=>{if(this.autoNavTimer=null,!this.root.parentNode){M("autoNavTimer: component disposed, skipping");return}if(!e){M("autoNavTimer: sceneId is missing, skipping");return}this.tryAutoNavigate(e)},at)}tryAutoNavigate(e){if(!e){M("tryAutoNavigate: sceneId is missing, skipping"),this.cancelAutoNav();return}if(this.isInteracting){M("tryAutoNavigate: isInteracting, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.aimedSceneId||this.aimedSceneId!==e){M("tryAutoNavigate: aimedSceneId mismatch, canceling",{aimedSceneId:this.aimedSceneId,sceneId:e}),this.cancelAutoNav(),this.clearAimed();return}if(this.lastPitchDeg>ve){M("tryAutoNavigate: pitch too high, canceling",this.lastPitchDeg),this.cancelAutoNav(),this.clearAimed();return}const t=Date.now();if(t-this.lastAutoNavTs<rt){M("tryAutoNavigate: cooldown, canceling"),this.cancelAutoNav(),this.clearAimed();return}if(!this.museumId){M("tryAutoNavigate: museumId is missing, canceling"),this.cancelAutoNav(),this.clearAimed();return}M("scene-autonav: trigger",{museumId:this.museumId,sceneId:e});const i=e;this.cancelAutoNav(),this.clearAimed(),this.lastAutoNavTs=t,window.dispatchEvent(new CustomEvent("vr:close-panels")),re({type:"focus",museumId:this.museumId,sceneId:i,source:"pano-auto",ts:t}),this.onNavigateToScene(this.museumId,i)}maybeRescheduleOrCancelByPitch(e){e>ve?(this.autoNavTargetSceneId&&this.cancelAutoNav(),this.aimedSceneId&&this.clearAimed()):this.aimedSceneId&&e<=ve&&!this.isInteracting&&!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(this.aimedSceneId)}emitSceneAim(e,t){if(!this.museumId){M("emitSceneAim: museumId is missing, skipping");return}M("scene-aim",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-aim",{detail:{type:e,museumId:this.museumId,sceneId:t||void 0,source:"groundnav",ts:Date.now()}}))}emitSceneAutoNav(e,t){if(!this.museumId){M("emitSceneAutoNav: museumId is missing, skipping");return}M("scene-autonav",{type:e,museumId:this.museumId,sceneId:t}),window.dispatchEvent(new CustomEvent("vr:scene-autonav",{detail:{type:e,museumId:this.museumId,sceneId:t??void 0,ts:Date.now()}}))}updateAimed(e){if(this.isInteracting||!this.isVisible){this.clearAimed();return}const t=this.sceneHotspots.filter(a=>{var c;return(c=a.target)==null?void 0:c.sceneId});if(t.length===0){this.clearAimed();return}let i=null,n=1/0;t.forEach(a=>{const c=a.target.sceneId;if(c===this.currentSceneId)return;const l=a.yaw,h=Math.abs(this.shortestDeltaDeg(e,l));h<n&&(n=h,i=c)});let o=!1;if(i!==null&&(this.aimedSceneId===null?o=n<=Ce:i===this.aimedSceneId?o=n<=Ce+Ai:o=n<=Ce),this.isInteracting){this.clearAimed();return}if(o&&i!==null)if(this.aimedSceneId!==i){if(this.lastAimChangeTs=Date.now(),this.cancelAutoNav(),this.aimedSceneId!==null){const c=this.dots.get(this.aimedSceneId);c&&(c.classList.remove("is-aimed","is-autonav","is-autonav-progress"),this.removeProgress(this.aimedSceneId))}this.aimedSceneId=i;const a=this.dots.get(i);a&&a.classList.add("is-aimed"),this.clearAimDebounce(),this.aimDebounceTimer=window.setTimeout(()=>{if(this.aimDebounceTimer=null,!this.root.parentNode){M("aimDebounceTimer: component disposed, skipping");return}this.aimedSceneId===i&&!this.isInteracting&&this.isVisible?(this.emitSceneAim("aim",i),this.scheduleAutoNavIfAllowed(i)):this.aimedSceneId===i&&this.clearAimed()},Di)}else!this.autoNavTimer&&this.aimedSceneId!==this.autoNavTargetSceneId&&this.scheduleAutoNavIfAllowed(i);else this.clearAimed()}handleSceneFocus(e){e.type==="hover"?this.hoverSceneId=e.sceneId:e.type==="focus"&&(M("统一终止触发点: 场景切换",{sceneId:e.sceneId}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),e.sceneId&&(this.currentSceneId=e.sceneId),this.hoverSceneId=null),this.updateDotStates()}updateDotStates(){this.dots.forEach((e,t)=>{e.classList.remove("is-current","is-hover"),t===this.currentSceneId?e.classList.add("is-current"):t===this.hoverSceneId&&e.classList.add("is-hover")})}renderDots(){this.container.innerHTML="",this.dots.clear(),this.dotYawDeg.clear(),this.aimedSceneId=null,this.sceneHotspots.filter(t=>{var i;return(i=t.target)==null?void 0:i.sceneId}).forEach(t=>{const i=t.target.sceneId,n=document.createElement("div");n.className="vr-groundnav__dot",n.setAttribute("data-scene-id",i),n.setAttribute("title",t.label),this.dotYawDeg.set(i,t.yaw),n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),C.emitUIEngaged(),re({type:"focus",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()}),window.dispatchEvent(new CustomEvent("vr:close-panels")),t.target.museumId&&t.target.sceneId?this.onNavigateToScene(t.target.museumId,t.target.sceneId):M("dot click: museumId or sceneId is missing, skipping navigation")}),n.addEventListener("mouseenter",()=>{re({type:"hover",museumId:t.target.museumId,sceneId:t.target.sceneId,source:"pano",ts:Date.now()})}),n.addEventListener("mouseleave",()=>{re({type:"hover",museumId:t.target.museumId,sceneId:null,source:"pano",ts:Date.now()})}),this.container.appendChild(n),this.dots.set(t.target.sceneId,n)}),this.updateDotStates(),this.updateDotPositions()}updateDotPositions(){this.sceneHotspots.filter(t=>{var i;return(i=t.target)==null?void 0:i.sceneId}).forEach(t=>{const i=this.dots.get(t.target.sceneId);if(!i)return;const n=t.yaw*Math.PI/180,o=Math.sin(n)*ot,a=-Math.cos(n)*ot;i.style.transform=`translate(${o}px, ${a}px)`})}setYawPitch(e,t){this.currentYaw=e,this.currentPitch=t;const i=Math.abs(this.lastYawDeg-e)>.1;if(this.lastYawDeg=e,this.lastPitchDeg=t,Be(t)){const o=Ge(t),a=String(o.clarity);this.root.style.getPropertyValue("--vr-ground-clarity")!==a&&this.root.style.setProperty("--vr-ground-clarity",a);const c=o.opacity.toString();this.root.style.opacity!==c&&(this.root.style.opacity=c);const l=`translateX(-50%) translateY(${o.translateY}px) scaleY(${o.scaleY})`;this.root.style.transform!==l&&(this.root.style.transform=l);const h=`${o.blur}px`;this.root.style.getPropertyValue("--vr-ground-base-blur")!==h&&this.root.style.setProperty("--vr-ground-base-blur",h),this.isVisible||(this.isVisible=!0),!this.isInteracting&&i&&(this.updateAimed(e),this.maybeRescheduleOrCancelByPitch(t))}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1,this.clearAimed());i&&this.updateDotPositions()}updateScene(e,t,i){if(M("统一终止触发点: 博物馆/场景切换",{museumId:e,currentSceneId:t}),this.clearAllTimers(),this.clearAimed(),this.cancelAutoNav(),!e){M("updateScene: museumId is missing");return}this.museumId=e,this.currentSceneId=t,this.sceneHotspots=i,this.hoverSceneId=null,this.renderDots()}mount(e){e.appendChild(this.root)}dispose(){this.clearAllTimers(),this.cancelAutoNav(),this.clearAimed(),this.unsubscribeFocus&&(this.unsubscribeFocus(),this.unsubscribeFocus=void 0),this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}class Vi{constructor(e,t={}){r(this,"root");r(this,"inner");r(this,"wedge");r(this,"northTick");r(this,"needle");r(this,"currentYaw",0);r(this,"currentPitch",0);r(this,"northYaw",0);r(this,"isVisible",!1);r(this,"unsubscribeInteracting");r(this,"unsubscribeIdle");r(this,"unsubscribeUIEngaged");this.root=document.createElement("div"),this.root.className="vr-groundheading",this.root.setAttribute("data-ui","GroundHeadingMarker"),this.root.style.outline="2px solid #00ffff",this.inner=document.createElement("div"),this.inner.className="vr-groundheading__inner",this.wedge=document.createElement("div"),this.wedge.className="vr-groundheading__wedge",this.northTick=document.createElement("div"),this.northTick.className="vr-groundheading__northTick",this.needle=document.createElement("div"),this.needle.className="vr-groundheading__needle",this.inner.appendChild(this.wedge),this.inner.appendChild(this.northTick),this.inner.appendChild(this.needle),this.root.appendChild(this.inner),this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.root.style.setProperty("--groundheading-disk-rot","0deg"),this.root.style.setProperty("--groundheading-needle-rot","0deg"),e.appendChild(this.root),this.setupInteractionListeners()}setNorthYaw(e){this.northYaw=e}setYawPitch(e,t){if(this.currentYaw=e,this.currentPitch=t,Be(t)){const n=Ge(t);this.root.style.setProperty("--vr-ground-clarity",String(n.clarity)),this.root.style.opacity=n.opacity.toString(),this.root.style.transform=`translateX(-50%) translateY(${n.translateY}px) scaleY(${n.scaleY})`,this.root.style.setProperty("--vr-ground-base-blur",`${n.blur}px`);const o=e,c=-(this.northYaw??0),l=o;this.root.style.setProperty("--groundheading-disk-rot",`${c}deg`),this.root.style.setProperty("--groundheading-needle-rot",`${l}deg`),this.isVisible||(this.isVisible=!0)}else this.isVisible&&(this.root.style.opacity="0",this.root.style.transform="translateX(-50%) translateY(0px) scaleY(1)",this.root.style.setProperty("--vr-ground-base-blur","0px"),this.isVisible=!1)}setInteracting(e){e?this.root.classList.add("vr-ui-interacting"):this.root.classList.remove("vr-ui-interacting")}setupInteractionListeners(){this.unsubscribeInteracting=C.on("user-interacting",()=>{this.root.classList.add("vr-ui-interacting")}),this.unsubscribeIdle=C.on("user-idle",()=>{this.root.classList.remove("vr-ui-interacting")}),this.unsubscribeUIEngaged=C.on("ui-engaged",()=>{this.root.classList.remove("vr-ui-interacting")})}dispose(){this.unsubscribeInteracting&&(this.unsubscribeInteracting(),this.unsubscribeInteracting=void 0),this.unsubscribeIdle&&(this.unsubscribeIdle(),this.unsubscribeIdle=void 0),this.unsubscribeUIEngaged&&(this.unsubscribeUIEngaged(),this.unsubscribeUIEngaged=void 0),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}function ze(s){try{const t=new URL(s).hostname;if(t==="i.ibb.co"||t==="s41.ax1x.com")return`/_img?u=${encodeURIComponent(s)}`}catch{}return s}class z extends Error{constructor(e,t,i){super(t),this.url=e,this.originalError=i,this.name="ExternalImageLoadError"}}let Pe=0;const xe=[];function It(s){return new Promise((e,t)=>{const i=async()=>{Pe++;try{const n=await s();e(n)}catch(n){t(n)}finally{Pe--,xe.length>0&&xe.shift()()}};Pe<2?i():xe.push(i)})}async function Oi(s,e,t,i,n,o="from-image"){let a=null;for(let c=0;c<=t;c++){const l=new AbortController,h=setTimeout(()=>l.abort(),e);try{const u={mode:"cors",referrerPolicy:"no-referrer",signal:l.signal};n&&(u.priority=n);const d=await fetch(s,u);if(clearTimeout(h),!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const m=await d.blob();return await createImageBitmap(m,{imageOrientation:o,premultiplyAlpha:"none"})}catch(u){if(clearTimeout(h),a=u instanceof Error?u:new Error(String(u)),c<t){const d=i*Math.pow(2,c);console.warn(`外链图片 fetch 重试 ${c+1}/${t+1}: ${s}`,a.message),await new Promise(m=>setTimeout(m,d))}}}throw new z(s,`fetch 加载失败（${t+1} 次尝试）: ${(a==null?void 0:a.message)||"未知错误"}`,a||void 0)}async function Hi(s,e={}){const{timeoutMs:t=15e3,retries:i=2,retryBaseDelayMs:n=300,referrerPolicy:o="no-referrer",crossOrigin:a="anonymous",priority:c}=e,l=ze(s);return It(async()=>new Promise((h,u)=>{let d=null,m=0,v=null,w=null;const y=()=>{m++;const g=new Image;w=g,g.decoding="async",g.referrerPolicy=o,g.crossOrigin=a,c&&(g.fetchPriority=c),d!==null&&(clearTimeout(d),d=null),d=window.setTimeout(()=>{if(d=null,v=new Error("加载超时"),w&&(w.onload=null,w.onerror=null,w=null),m<=i){const p=n*Math.pow(2,m-1);console.warn(`外链图片加载超时重试 ${m}/${i+1}: ${l}`),setTimeout(y,p)}else u(new z(s,`加载超时（${i+1} 次尝试）`,v))},t),g.onload=()=>{d!==null&&(clearTimeout(d),d=null),g.complete&&g.naturalWidth>0?h(g):setTimeout(()=>h(g),0)},g.onerror=p=>{if(d!==null&&(clearTimeout(d),d=null),v=new Error("图片加载失败"),w===g&&(w.onload=null,w.onerror=null,w=null),m<=i){const b=n*Math.pow(2,m-1);console.warn(`外链图片加载失败重试 ${m}/${i+1}: ${l}`,p),setTimeout(y,b)}else u(new z(s,`图片加载失败（${i+1} 次尝试）`,v))},g.src=l};y()}))}async function le(s,e={}){const{timeoutMs:t=15e3,retries:i=2,retryBaseDelayMs:n=300,allowFetchFallback:o=!1,imageOrientation:a="from-image"}=e,c=ze(s);return It(async()=>{try{const l=await Hi(c,e);return await createImageBitmap(l,{imageOrientation:a,premultiplyAlpha:"none"})}catch(l){if(o){console.warn(`Image() 加载失败，尝试 fetch 兜底: ${c}`,l);try{return await Oi(c,t,i,n,e.priority,a)}catch{throw l instanceof z?l:new z(s,`Image() 和 fetch 均失败: ${l instanceof Error?l.message:String(l)}`,l instanceof Error?l:void 0)}}else throw l instanceof z?l:new z(s,`Image() 加载失败: ${l instanceof Error?l.message:String(l)}`,l instanceof Error?l:void 0)}})}const U=class U{constructor(){r(this,"element",null);r(this,"textEl",null);r(this,"hideTimer",null)}ensure(){this.element||(this.element=document.createElement("div"),this.element.className="vr-zoom-hud",this.textEl=document.createElement("div"),this.textEl.className="vr-zoom-hud__text",this.textEl.textContent="缩放 100%",this.element.appendChild(this.textEl),document.body.appendChild(this.element))}show(e){this.ensure(),!(!this.element||!this.textEl)&&(this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.textEl.textContent=`缩放 ${e}%`,this.element.classList.add("is-on"),this.hideTimer=window.setTimeout(()=>{this.hide()},600))}hide(){this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.element&&this.element.classList.remove("is-on")}static ensure(){return U.instance||(U.instance=new U),U.instance}static show(e){U.ensure().show(e)}static hide(){U.instance&&U.instance.hide()}};r(U,"instance",null);let Ue=U,K=null;function Z(s,e=1500){if(ue())return;const t=document.querySelector(".vr-toast"),i=t??document.createElement("div");i.className="vr-toast",i.textContent=s,t||document.body.appendChild(i),window.requestAnimationFrame(()=>i.classList.add("show")),K&&window.clearTimeout(K),K=window.setTimeout(()=>{i.classList.remove("show"),window.setTimeout(()=>i.remove(),220),K=null},e)}function Ui(){const s=document.querySelector(".vr-toast");s&&(s.classList.remove("show"),window.setTimeout(()=>s.remove(),220)),K&&(window.clearTimeout(K),K=null)}let ee=null,Yi=0;const ne=new Map;function $i(){return typeof Worker>"u"?null:ee||(ee=new Worker(new URL(""+new URL("bitmapDecode.worker-FGbDVlpY.js",import.meta.url).href,import.meta.url),{type:"module"}),ee.onmessage=s=>{const{id:e,bitmap:t,error:i}=s.data||{},n=ne.get(e);n&&(ne.delete(e),n.timer&&window.clearTimeout(n.timer),i?n.reject(new Error(i)):t?n.resolve(t):n.reject(new Error("worker 返回空结果")))},ee.onerror=()=>{ne.forEach(s=>s.reject(new Error("worker error"))),ne.clear()},ee)}async function Fi(s,e={}){const t=$i();if(!t||typeof createImageBitmap>"u")return null;const i=++Yi,n=Math.max(1e3,e.timeoutMs??12e3),o=e.priority??"high",a=e.imageOrientation??"from-image";return new Promise((c,l)=>{const h={resolve:c,reject:l};h.timer=window.setTimeout(()=>{ne.delete(i),l(new Error("worker decode timeout"))},n+500),ne.set(i,h),t.postMessage({id:i,url:s,timeoutMs:n,priority:o,imageOrientation:a})})}class Gi{constructor(e,t,i,n=0){r(this,"maxTextureSize");r(this,"manifest",null);r(this,"canvas",null);r(this,"ctx",null);r(this,"texture",null);r(this,"mesh",null);r(this,"pendingLow",[]);r(this,"pendingHigh",[]);r(this,"activeLoads",0);r(this,"activeLowLoads",0);r(this,"activeHighLoads",0);r(this,"maxConcurrent",6);r(this,"maxHighWhileLow",2);r(this,"defaultMaxConcurrent",6);r(this,"defaultMaxHighWhileLow",2);r(this,"lastUpdate",0);r(this,"tilesMap",new Map);r(this,"highestLevel",null);r(this,"lowLevel",null);r(this,"lowReadyCount",0);r(this,"lowTotalCount",0);r(this,"lowFullyReady",!1);r(this,"highSeeded",!1);r(this,"tilesVisible",!1);r(this,"tilesLoadedCount",0);r(this,"tilesLoadingCount",0);r(this,"tilesQueuedCount",0);r(this,"tilesFailedCount",0);r(this,"tilesRetryCount",0);r(this,"lastTileUrl","");r(this,"lastError","");r(this,"lruLimit",64);r(this,"highReady",!1);r(this,"canvasScale",1);r(this,"fallbackVisible",!1);r(this,"prefetchSeeded",!1);this.scene=e,this.onFirstDraw=t,this.onHighReady=i,this.maxTextureSize=Math.max(0,n)}async load(e,t){var v;if(this.manifest=e,this.fallbackVisible=!!(t!=null&&t.fallbackVisible),this.highestLevel=e.levels.reduce((w,y)=>y.z>w.z?y:w),!this.highestLevel)throw new Error("manifest 缺少 level");this.lruLimit=Math.max(64,Math.min(this.highestLevel.cols*this.highestLevel.rows,256));const i=e.levels.filter(w=>w.z<this.highestLevel.z);this.lowLevel=i.length?i.reduce((w,y)=>y.z>w.z?y:w):null,this.lowReadyCount=0,this.lowTotalCount=this.lowLevel?this.lowLevel.cols*this.lowLevel.rows:0,this.lowFullyReady=this.lowTotalCount===0,this.highSeeded=!1,this.prefetchSeeded=!1,this.tilesVisible=!1,this.tilesLoadedCount=0,this.tilesLoadingCount=0,this.tilesQueuedCount=0,this.tilesFailedCount=0,this.tilesRetryCount=0,this.activeLoads=0,this.activeLowLoads=0,this.activeHighLoads=0;const n=this.highestLevel.cols,o=this.highestLevel.rows,a=e.tileSize,c=a*n,l=a*o;let h=c,u=l;if(this.canvasScale=1,this.maxTextureSize>0&&(h>this.maxTextureSize||u>this.maxTextureSize)){const w=Math.min(this.maxTextureSize/h,this.maxTextureSize/u);h=Math.max(1,Math.floor(h*w)),u=Math.max(1,Math.floor(u*w)),this.canvasScale=w}this.canvas=document.createElement("canvas"),this.canvas.width=h,this.canvas.height=u,this.ctx=this.canvas.getContext("2d",{alpha:!0}),this.fallbackVisible&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.texture=new B(this.canvas),this.texture.flipY=!1,this.texture.wrapS=H,this.texture.wrapT=H,this.texture.minFilter=Me,this.texture.magFilter=Me,this.texture.generateMipmaps=!1,"colorSpace"in this.texture?this.texture.colorSpace=de:this.texture.encoding=ke,this.texture.needsUpdate=!0;const d=new pt(500,64,64);d.scale(-1,1,1);const m=new oe({map:this.texture,transparent:!0,opacity:0,depthWrite:!1,depthTest:!1});if(m.toneMapped=!1,this.mesh=new ae(d,m),this.mesh.renderOrder=1,this.mesh.frustumCulled=!1,this.scene.add(this.mesh),!this.fallbackVisible){if(!e.levels.find(b=>b.z===0))throw new Error("manifest 缺少 z0");const y=`${e.baseUrl}/z0/0_0.jpg`,g=await this.fetchTileBitmap(y,"high"),p={z:0,col:0,row:0,url:y,state:"ready",priority:"low",bitmap:g,lastUsed:performance.now(),failCount:0};await this.drawTile(p),(v=g.close)==null||v.call(g)}this.lowLevel&&this.enqueueLevel(this.lowLevel,"low")}setPerformanceMode(e){e==="throttle"?(this.maxConcurrent=2,this.maxHighWhileLow=0):(this.maxConcurrent=this.defaultMaxConcurrent,this.maxHighWhileLow=this.defaultMaxHighWhileLow)}dispose(){if(this.tilesMap.forEach(e=>{var t,i;return(i=(t=e.bitmap)==null?void 0:t.close)==null?void 0:i.call(t)}),this.tilesMap.clear(),this.mesh){this.mesh.geometry&&this.mesh.geometry.dispose();const e=this.mesh.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.mesh)}}update(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;const t=performance.now();if(t-this.lastUpdate<150)return;if(this.lastUpdate=t,(!this.lowLevel||this.lowFullyReady||this.highSeeded)&&this.highestLevel){const a=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});for(const{col:c,row:l,rank:h}of a){const u=`${this.highestLevel.z}_${c}_${l}`;let d=this.tilesMap.get(u);d||(d={z:this.highestLevel.z,col:c,row:l,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${c}_${l}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(u,d)),d.priority="high",d.priorityRank=h,d.lastUsed=t,d.state==="empty"&&!d.retryTimer&&(d.state="loading",this.pendingHigh.push(d))}}const n=Array.from(this.tilesMap.values()).filter(a=>a.state==="loading").length,o=Array.from(this.tilesMap.values()).filter(a=>a.state==="ready").length;if(this.lowLevel&&!this.lowFullyReady){const a=Array.from(this.tilesMap.values()).filter(c=>c.z===this.lowLevel.z&&c.state==="loading").length;this.pendingLow.length===0&&a===0&&(this.lowFullyReady=!0)}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=n,this.tilesLoadedCount=o,this.processQueue(),this.runLru(t)}prime(e){if(!this.manifest||!this.highestLevel||!this.ctx)return;e.updateMatrixWorld(!0);const t=performance.now();if(this.highestLevel&&!this.highSeeded){const i=this.computeNeededTiles(e,this.highestLevel,{marginDeg:10,expandNeighbors:!1});if(i.length>0){for(const{col:n,row:o,rank:a}of i){const c=`${this.highestLevel.z}_${n}_${o}`;let l=this.tilesMap.get(c);l||(l={z:this.highestLevel.z,col:n,row:o,url:`${this.manifest.baseUrl}/z${this.highestLevel.z}/${n}_${o}.jpg`,state:"empty",priority:"high",lastUsed:t,failCount:0},this.tilesMap.set(c,l)),l.priority="high",l.priorityRank=a,l.lastUsed=t,l.state==="empty"&&!l.retryTimer&&(l.state="loading",this.pendingHigh.push(l))}this.highSeeded=!0}}this.reprioritizeLowQueue(e),this.seedHighPreload(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(i=>i.state==="loading").length,this.processQueue()}getStatus(){var e,t;return{tilesVisible:this.tilesVisible,fallbackVisible:this.fallbackVisible,tilesLoadedCount:this.tilesLoadedCount,tilesLoadingCount:this.tilesLoadingCount,tilesQueuedCount:this.tilesQueuedCount,tilesFailedCount:this.tilesFailedCount,tilesRetryCount:this.tilesRetryCount,lastTileUrl:this.lastTileUrl,lastError:this.lastError,canvasSize:this.canvas?`${this.canvas.width}x${this.canvas.height}`:"0x0",canvasScale:this.canvasScale,maxLevel:this.highestLevel?`${this.highestLevel.cols}x${this.highestLevel.rows}`:"",highReady:this.highReady,zMax:((e=this.highestLevel)==null?void 0:e.z)??0,levels:this.manifest?this.manifest.levels.map(i=>i.z).join(","):"",lowReady:this.lowFullyReady,lowLevel:((t=this.lowLevel)==null?void 0:t.z)??""}}enqueueLevel(e,t){const i=performance.now();for(let n=0;n<e.rows;n++)for(let o=0;o<e.cols;o++){const a=`${e.z}_${o}_${n}`;let c=this.tilesMap.get(a);c||(c={z:e.z,col:o,row:n,url:`${this.manifest.baseUrl}/z${e.z}/${o}_${n}.jpg`,state:"empty",priority:t,lastUsed:i,failCount:0},this.tilesMap.set(a,c)),c.priority=t,c.lastUsed=i,c.state==="empty"&&!c.retryTimer&&(c.state="loading",t==="low"?this.pendingLow.push(c):this.pendingHigh.push(c))}this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.tilesLoadingCount=Array.from(this.tilesMap.values()).filter(n=>n.state==="loading").length,this.processQueue()}processQueue(){for(this.sortPendingHighQueue();this.activeLoads<this.maxConcurrent&&(this.pendingLow.length>0||this.pendingHigh.length>0);){const e=this.pendingLow.length>0,i=this.pendingHigh.length>0&&(!e||this.activeHighLoads<this.maxHighWhileLow)?this.pendingHigh.shift():this.pendingLow.shift();this.loadTile(i)}}async loadTile(e){(e.failCount===void 0||e.failCount===null)&&(e.failCount=0),e.priority||(e.priority="high"),this.activeLoads+=1,e.priority==="high"?this.activeHighLoads+=1:this.activeLowLoads+=1,this.lastTileUrl=e.url;try{const t=await this.fetchTileBitmap(e.url,e.priority);e.bitmap=t,e.state="ready",e.failCount=0,e.retryTimer&&(clearTimeout(e.retryTimer),e.retryTimer=void 0),this.drawTile(e),this.tilesLoadedCount+=1,this.lowLevel&&e.z===this.lowLevel.z&&(this.lowReadyCount+=1,this.lowReadyCount>=this.lowTotalCount&&(this.lowFullyReady=!0))}catch(t){this.lastError=t instanceof Error?t.message:String(t),e.state="empty",e.failCount+=1,this.tilesFailedCount+=1;const i=Math.min(1e3*Math.pow(2,Math.max(0,e.failCount-1)),15e3);this.scheduleRetry(e,i)}finally{this.activeLoads-=1,e.priority==="high"?this.activeHighLoads=Math.max(0,this.activeHighLoads-1):this.activeLowLoads=Math.max(0,this.activeLowLoads-1),this.processQueue()}}scheduleRetry(e,t){e.retryTimer||(this.tilesRetryCount+=1,e.retryTimer=window.setTimeout(()=>{e.retryTimer=void 0,e.state==="empty"&&(e.priority==="low"?this.pendingLow.push(e):this.pendingHigh.push(e),this.tilesQueuedCount=this.pendingLow.length+this.pendingHigh.length,this.processQueue())},t))}async fetchTileBitmap(e,t,i=12e3){try{const a=await Fi(e,{timeoutMs:i,priority:t});if(a)return a}catch{}const n=new AbortController,o=window.setTimeout(()=>n.abort(),i);try{const a={mode:"cors",cache:"default",referrerPolicy:"no-referrer",signal:n.signal};a.priority=t==="high"?"high":"low";const c=await fetch(e,a);if(!c.ok)throw new Error(`tile HTTP ${c.status}: ${e}`);const l=await c.blob();return await createImageBitmap(l)}finally{clearTimeout(o)}}hasHigherReadyTile(e,t,i){if(!this.highestLevel)return!1;const n=this.highestLevel.z;if(e>=n)return!1;const o=1<<n-e;for(let a=0;a<o;a++)for(let c=0;c<o;c++){const l=`${n}_${t*o+c}_${i*o+a}`,h=this.tilesMap.get(l);if(h&&h.state==="ready")return!0}return!1}async drawTile(e){var h,u;if(!this.manifest||!this.highestLevel||!this.ctx||!this.canvas)return;const t=this.manifest.levels.find(d=>d.z===e.z);if(!t||this.hasHigherReadyTile(e.z,e.col,e.row))return;const i=this.canvas.width/t.cols,n=this.canvas.height/t.rows,o=e.col*i,a=e.row*n;if(o<0||a<0||o+i>this.canvas.width||a+n>this.canvas.height){this.lastError=`tile out of canvas: z${e.z} ${e.col}_${e.row}`;return}const c=e.bitmap;if(c)this.ctx.drawImage(c,o,a,i,n);else{const d=e.url||`${this.manifest.baseUrl}/z${e.z}/${e.col}_${e.row}.jpg`,m=await le(d,{timeoutMs:12e3,retries:1,priority:e.priority});this.ctx.drawImage(m,o,a,i,n),(h=m.close)==null||h.call(m)}this.texture&&(this.texture.needsUpdate=!0),this.tilesVisible||(this.tilesVisible=!0,this.onFirstDraw());const l=(u=this.mesh)==null?void 0:u.material;l&&(l.opacity=1,l.needsUpdate=!0),this.highestLevel&&e.z===this.highestLevel.z&&!this.highReady&&(this.highReady=!0,this.onHighReady())}computeNeededTiles(e,t,i={}){const{yaw:n,pitch:o}=this.getViewAngles(e),a=x.degToRad(e.fov),c=x.degToRad(i.marginDeg??20),l=a/2+c,h=a*e.aspect/2+c,u=this.normAngle(n-h),d=this.normAngle(n+h),m=x.clamp(o-l,-Math.PI/2,Math.PI/2),v=x.clamp(o+l,-Math.PI/2,Math.PI/2),w=this.yawToCols(u,d,t.cols),y=this.yawToCols(n-1e-6,n+1e-6,t.cols)[0]??0;w.includes(y)||w.push(y);const g=Math.max(0,Math.floor((v*-1+Math.PI/2)/Math.PI*t.rows)),p=Math.min(t.rows-1,Math.floor((m*-1+Math.PI/2)/Math.PI*t.rows)),b=[];for(let L=g;L<=p;L++)b.push(L);const I=Math.min(t.rows-1,Math.max(0,Math.floor((-o+Math.PI/2)/Math.PI*t.rows)));b.includes(I)||b.push(I);const S=i.expandNeighbors!==!1,_=[...w];if(S)for(const L of w)_.push(((L+1)%t.cols+t.cols)%t.cols),_.push(((L-1)%t.cols+t.cols)%t.cols);const A=[...b];if(S)for(const L of b)L+1<t.rows&&A.push(L+1),L-1>=0&&A.push(L-1);const T=new Map,R=(L,k)=>{const N=`${L}_${k}`,O=Math.abs(L-y),pe=Math.min(O,t.cols-O),fe=Math.abs(k-I),ge=pe*pe+fe*fe,qe=T.get(N);(!qe||ge<qe.rank)&&T.set(N,{col:L,row:k,rank:ge})};for(const L of _)for(const k of A)R(L,k);return Array.from(T.values()).sort((L,k)=>L.rank!==k.rank?L.rank-k.rank:L.row!==k.row?L.row-k.row:L.col-k.col)}sortPendingHighQueue(){this.pendingHigh.length<2||this.pendingHigh.sort((e,t)=>{const i=e.priorityRank??Number.POSITIVE_INFINITY,n=t.priorityRank??Number.POSITIVE_INFINITY;return i!==n?i-n:t.lastUsed-e.lastUsed})}reprioritizeLowQueue(e){if(!this.lowLevel||this.pendingLow.length<2)return;const t=this.computeNeededTiles(e,this.lowLevel);if(t.length===0)return;const i=new Map;for(const o of t)i.set(`${o.col}_${o.row}`,o.rank);const n=new Map;this.pendingLow.forEach((o,a)=>n.set(o,a)),this.pendingLow.sort((o,a)=>{const c=i.get(`${o.col}_${o.row}`),l=i.get(`${a.col}_${a.row}`),h=c!==void 0,u=l!==void 0;return h&&u&&c!==l?c-l:h&&!u?-1:!h&&u?1:(n.get(o)??0)-(n.get(a)??0)})}seedHighPreload(e){if(this.prefetchSeeded||!this.manifest||!this.highestLevel)return;this.prefetchSeeded=!0;const{yaw:t,pitch:i}=this.getViewAngles(e),n=this.highestLevel,o=Math.PI*2/n.cols,a=Math.PI/n.rows,c=performance.now();for(let l=0;l<n.rows;l++){const h=Math.PI/2-(l+.5)*a,u=Math.abs(h-i);for(let d=0;d<n.cols;d++){const m=-Math.PI+(d+.5)*o,v=this.angularDistance(m,t),y=(v<=Math.PI/2?0:1)*1e6+Math.round(v*1e3)+Math.round(u*10),g=`${n.z}_${d}_${l}`;if(this.tilesMap.has(g))continue;const p={z:n.z,col:d,row:l,url:`${this.manifest.baseUrl}/z${n.z}/${d}_${l}.jpg`,state:"loading",priority:"high",priorityRank:y,lastUsed:c,failCount:0};this.tilesMap.set(g,p),this.pendingHigh.push(p)}}}yawToCols(e,t,i){const n=m=>(m%(Math.PI*2)+Math.PI*2)%(Math.PI*2),o=Math.PI,a=n(e+o),c=n(t+o),l=[],h=m=>{const v=(m%i+i)%i;l.includes(v)||l.push(v)},u=Math.floor(a/(Math.PI*2)*i),d=Math.floor(c/(Math.PI*2)*i);if(a<=c)for(let m=u;m<=d;m++)h(m);else{for(let m=u;m<i;m++)h(m);for(let m=0;m<=d;m++)h(m)}return l}normAngle(e){return(e+Math.PI)%(2*Math.PI)-Math.PI}angularDistance(e,t){return Math.abs(this.normAngle(e-t))}getViewAngles(e){const t=new me;return e.getWorldDirection(t),{yaw:-Math.atan2(t.x,t.z),pitch:Math.asin(t.y)}}runLru(e){var n,o;if(!this.highestLevel)return;const t=Array.from(this.tilesMap.values()).filter(a=>a.z===this.highestLevel.z&&a.state==="ready");if(t.length<=this.lruLimit)return;t.sort((a,c)=>a.lastUsed-c.lastUsed);const i=t.slice(0,t.length-this.lruLimit);for(const a of i)(o=(n=a.bitmap)==null?void 0:n.close)==null||o.call(n),a.bitmap=void 0,a.state="empty",this.tilesMap.delete(`${a.z}_${a.col}_${a.row}`)}}function Bi(s,e){var i;const t=s.trim();if(!t||t.startsWith("/")||t.startsWith("//")||/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(t))return t;try{const n=new URL(t,e),o=typeof window<"u"&&((i=window.location)!=null&&i.origin)?window.location.origin:typeof location<"u"?location.origin:"";return o&&n.origin===o?`${n.pathname}${n.search}${n.hash}`:n.toString()}catch{return t}}async function zi(s){const e={cache:"default"};e.priority="high";const t=await fetch(s,e);if(!t.ok)throw new Error(`manifest 加载失败: ${s}`);const i=await t.json();return i.tileFormat||(i.tileFormat="jpg"),i.baseUrl=G(Bi(i.baseUrl,s),Y.PANO),i}const te={original:{renderer:{pixelRatio:Math.min(window.devicePixelRatio||1,2),toneMapping:Wt,toneMappingExposure:1,output:"srgb",clearColor:void 0},camera:{defaultFov:75},texture:{anisotropyLimit:8,minFilter:Xe,magFilter:Me,generateMipmaps:!0,colorSpace:"srgb"}},enhanced:{renderer:{pixelRatio:Math.min(window.devicePixelRatio,2),toneMapping:zt,toneMappingExposure:.95,output:"srgb",clearColor:{color:0,alpha:1}},camera:{defaultFov:70},texture:{anisotropyLimit:12,minFilter:Xe,magFilter:Me,generateMipmaps:!0,colorSpace:"srgb"}}};class Wi{constructor(e,t=!1){r(this,"scene");r(this,"camera");r(this,"renderer");r(this,"sphere",null);r(this,"tilePano",null);r(this,"fallbackSphere",null);r(this,"container");r(this,"handleWindowResize",()=>this.handleResize());r(this,"frameListeners",[]);r(this,"nadirPatch",null);r(this,"compassDisk",null);r(this,"groundNavDots",null);r(this,"groundHeading",null);r(this,"renderProfile","enhanced");r(this,"isDragging",!1);r(this,"lastMouseX",0);r(this,"lastMouseY",0);r(this,"yaw",0);r(this,"pitch",0);r(this,"fov",75);r(this,"onLoadCallback");r(this,"onErrorCallback");r(this,"onStatusChangeCallback");r(this,"debugMode",!1);r(this,"onDebugClick");r(this,"longPressTimer",null);r(this,"tilesDebugEl",null);r(this,"tilesVisibleStableFrames",0);r(this,"tilesLastError","");r(this,"tilesLowReady",!1);r(this,"tilesLastLoadedCount",0);r(this,"tilesLastProgressAt",0);r(this,"tilesHighStartAt",0);r(this,"tilesDegradedNotified",!1);r(this,"longPressThreshold",500);r(this,"renderSource","none");r(this,"perfSamples",[]);r(this,"perfMode","normal");r(this,"perfLastChangeAt",0);r(this,"renderSwitchReason","");r(this,"clearedCount",0);r(this,"aspectWarnedUrls",new Set);r(this,"metrics",{sceneId:"",startAt:0,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:"normal",renderSource:"none",lastError:""});r(this,"lastMetricsEmitAt",0);r(this,"loadStatus",E.LOADING_LOW);r(this,"isDegradedMode",!1);r(this,"pickMode",!1);r(this,"pickModeListeners",[]);r(this,"pickStartX",0);r(this,"pickStartY",0);r(this,"pickStartTime",0);r(this,"pickHasMoved",!1);r(this,"pickDragThreshold",8);r(this,"pickTimeThreshold",250);r(this,"lastYaw",0);r(this,"lastPitch",0);r(this,"lastFov",75);r(this,"isViewChanging",!1);r(this,"viewChangeThreshold",.5);r(this,"vrModeEnabled",!1);r(this,"touchStartX",0);r(this,"touchStartY",0);r(this,"lastTouchDistance",0);r(this,"isPinching",!1);r(this,"lastFrameTimeMs",null);this.container=e,this.debugMode=t,this.renderProfile=this.detectRenderProfile(),this.scene=new Gt,this.camera=new Bt(te[this.renderProfile].camera.defaultFov,e.clientWidth/e.clientHeight,.1,1e3),this.camera.position.set(0,0,0),this.fov=te[this.renderProfile].camera.defaultFov,this.renderer=new qt({antialias:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.applyRendererProfile(),e.appendChild(this.renderer.domElement),this.nadirPatch=new Li(this.scene,500),this.compassDisk=new _i,this.compassDisk.mount(e),this.compassDisk.getElement().style.display="none",this.groundNavDots=new Ri({museumId:"",currentSceneId:"",sceneHotspots:[]}),this.groundNavDots.mount(e),this.groundNavDots.getElement().style.display="none",this.groundHeading=new Vi(e),this.groundHeading.getElement().style.display="none",this.setupEvents(),this.animate(),window.addEventListener("resize",this.handleWindowResize)}setupEvents(){const e=this.renderer.domElement;if(e.addEventListener("mousedown",t=>this.onPointerDown(t)),e.addEventListener("mousemove",t=>this.onPointerMove(t)),e.addEventListener("mouseup",()=>this.onPointerUp()),e.addEventListener("mouseleave",()=>this.onPointerUp()),e.addEventListener("touchstart",t=>this.onTouchStart(t),{passive:!1}),e.addEventListener("touchmove",t=>this.onTouchMove(t),{passive:!1}),e.addEventListener("touchend",()=>this.onTouchEnd()),e.addEventListener("wheel",t=>this.onWheel(t),{passive:!1}),this.debugMode){e.addEventListener("dblclick",n=>this.handleDebugClick(n.clientX,n.clientY));let t=0,i=0;e.addEventListener("touchstart",n=>{n.touches.length===1&&(t=n.touches[0].clientX,i=n.touches[0].clientY,this.longPressTimer=window.setTimeout(()=>{this.handleDebugClick(t,i)},this.longPressThreshold))},{passive:!0}),e.addEventListener("touchmove",()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},{passive:!0}),e.addEventListener("touchend",()=>{this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},{passive:!0})}}handleDebugClick(e,t){if(this.onDebugClick&&this.debugMode){const i=this.getCurrentView();this.onDebugClick(e,t,i.yaw,i.pitch,i.fov)}}setOnDebugClick(e){this.onDebugClick=e}onPointerDown(e){this.isDragging=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,C.emitInteracting()}onPointerMove(e){if(!this.isDragging)return;const t=e.clientX-this.lastMouseX,i=e.clientY-this.lastMouseY;if(this.yaw+=t*.5,this.pitch+=i*.5,this.pitch=Math.max(-90,Math.min(90,this.pitch)),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,this.updateCamera(),this.debugMode&&this.onDebugClick){const n=this.getCurrentView();this.onDebugClick(this.lastMouseX,this.lastMouseY,n.yaw,n.pitch,n.fov)}}onPointerUp(){this.isDragging=!1}onTouchStart(e){if(e.touches.length===1)this.isDragging=!0,this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY,this.lastMouseX=this.touchStartX,this.lastMouseY=this.touchStartY,C.emitInteracting();else if(e.touches.length===2){this.isPinching=!0,this.isDragging=!1;const t=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY;this.lastTouchDistance=Math.sqrt(t*t+i*i),C.emitInteracting()}}onTouchMove(e){if(e.preventDefault(),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),e.touches.length===1&&this.isDragging){const t=e.touches[0].clientX-this.lastMouseX,i=e.touches[0].clientY-this.lastMouseY;this.yaw+=t*.5,this.pitch+=i*.5,this.pitch=Math.max(-90,Math.min(90,this.pitch)),this.lastMouseX=e.touches[0].clientX,this.lastMouseY=e.touches[0].clientY,this.updateCamera()}else if(e.touches.length===2&&this.isPinching){const t=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY,n=Math.sqrt(t*t+i*i),o=this.lastTouchDistance-n,a=this.fov+o*.5;this.setFovInternal(a),this.lastTouchDistance=n}}onTouchEnd(){this.isDragging=!1,this.isPinching=!1}onWheel(e){e.preventDefault();const t=this.fov+e.deltaY*.1;if(this.setFovInternal(t),C.emitInteracting(),this.debugMode&&this.onDebugClick){const i=this.getCurrentView();this.onDebugClick(this.lastMouseX,this.lastMouseY,i.yaw,i.pitch,i.fov)}}updateCamera(){const e=x.degToRad(this.yaw),t=x.degToRad(this.pitch),i=Math.cos(t)*Math.sin(e),n=Math.sin(t),o=Math.cos(t)*Math.cos(e);this.camera.lookAt(i,n,o)}loadScene(e,t){var d;if(this.isDegradedMode=!1,this.resetMetrics(e.id),this.updateLoadStatus(E.LOADING_LOW),this.renderSource="none",this.clearedCount=0,this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const m=this.sphere.material;m.map&&m.map.dispose(),m.dispose()}if(!((t==null?void 0:t.preserveView)===!0)){const m=e.initialView,v=m.yaw||0;this.yaw===0&&v!==0&&(this.yaw=-v),this.pitch=m.pitch||0;const w=te[this.renderProfile];this.fov=m.fov!==void 0?m.fov:w.camera.defaultFov,this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),this.updateCamera()}this.lastYaw=this.yaw,this.lastPitch=this.pitch,this.lastFov=this.fov,this.isViewChanging=!1;const o=-(typeof e.northYaw=="number"?e.northYaw:((d=e.initialView)==null?void 0:d.yaw)??0);this.nadirPatch&&this.nadirPatch.setNorthYaw(o),this.compassDisk&&(this.compassDisk.setSceneId(e.id),this.compassDisk.setNorthYaw(o)),this.groundHeading&&this.groundHeading.setNorthYaw(o);const a=new pt(500,64,64);a.scale(-1,1,1);const c=e.panoTiles;if(c!=null&&c.manifest){const m=G(c.manifest,Y.PANO),v=c.fallbackPanoLow||e.panoLow,w=c.fallbackPano||e.pano,y=!!(v||w);this.tilesVisibleStableFrames=0,this.tilesLastError="",this.tilesLowReady=!1,this.tilesLastLoadedCount=0,this.tilesLastProgressAt=performance.now(),this.tilesHighStartAt=0,this.tilesDegradedNotified=!1,v?this.showFallbackTexture(G(v,Y.PANO_LOW),a,!0):w&&this.showFallbackTexture(G(w,Y.PANO),a,!1);const g=()=>{this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(E.LOW_READY),this.setRenderSource("low","tiles 首屏可见"),this.onLoadCallback&&this.onLoadCallback()),this.loadStatus!==E.HIGH_READY&&this.updateLoadStatus(E.LOADING_HIGH)},p=()=>{this.updateLoadStatus(E.HIGH_READY),this.setRenderSource("tiles","tiles 高清可见"),this.isDegradedMode=!1};zi(m).then(async b=>{if(b.tileFormat==="ktx2"){const{TileMeshPano:I}=await D(async()=>{const{TileMeshPano:S}=await import("./tile-ktx2-19dlhglf.js");return{TileMeshPano:S}},__vite__mapDeps([0,1,2]),import.meta.url);this.tilePano=new I(this.scene,this.renderer,g,p)}else this.tilePano=new Gi(this.scene,g,p,this.renderer.capabilities.maxTextureSize||0);return this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode(this.perfMode),this.tilePano.load(b,{fallbackVisible:y})}).then(()=>{var b;this.tilesLowReady||(this.tilesLowReady=!0,this.updateLoadStatus(E.LOW_READY),this.onLoadCallback&&this.onLoadCallback()),(b=this.tilePano)==null||b.prime(this.camera)}).catch(b=>{console.error("瓦片加载失败，回退传统全景",b),this.tilesLastError=b instanceof Error?b.message:String(b),Z("瓦片加载失败，已回退到全景图",2e3),this.fallbackToLegacy(e,c)});return}const l=G(e.panoLow,Y.PANO_LOW),h=G(e.pano,Y.PANO);if(Oe()==="low"){if(l){this.loadSingleTexture(a,l,!0);return}if(h){this.loadSingleTexture(a,h,!1);return}}else{if(!l&&h){this.loadSingleTexture(a,h,!1);return}if(l&&!h){this.loadSingleTexture(a,l,!0);return}if(l&&h){this.loadProgressiveTextures(a,l,h);return}}this.updateLoadStatus(E.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("场景未提供全景图 URL"))}async loadSingleTexture(e,t,i){i?this.updateLoadStatus(E.LOADING_LOW):this.updateLoadStatus(E.LOADING_HIGH);try{const n=await le(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY"}),o=new B(n);this.applyTextureSettings(o),this.warnIfNotPanoAspect(o,t),o.flipY=!1,o.wrapS=H,o.wrapT=H,o.needsUpdate=!0;const a=new oe({map:o});this.sphere=new ae(e,a),this.scene.add(this.sphere),this.setRenderSource(i?"low":"tiles",i?"panoLow 可见":"pano 可见"),i?this.updateLoadStatus(E.LOW_READY):this.updateLoadStatus(E.HIGH_READY),this.onLoadCallback&&this.onLoadCallback()}catch(n){if(console.error("加载全景图失败",t,n),this.updateLoadStatus(E.ERROR),this.onErrorCallback){const o=n instanceof z?`加载全景图失败：${t} - ${n.message}`:`加载全景图失败：${t}`;this.onErrorCallback(new Error(o))}}}async loadProgressiveTextures(e,t,i){this.updateLoadStatus(E.LOADING_LOW);try{const n=await le(t,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"high",imageOrientation:"flipY"}),o=new B(n);this.applyTextureSettings(o),this.warnIfNotPanoAspect(o,t),o.flipY=!1,o.wrapS=H,o.wrapT=H,o.needsUpdate=!0;const a=new oe({map:o});this.sphere=new ae(e,a),this.scene.add(this.sphere),this.setRenderSource("low","panoLow 可见"),this.updateLoadStatus(E.LOW_READY),this.onLoadCallback&&this.onLoadCallback(),this.updateLoadStatus(E.LOADING_HIGH);try{const c=await le(i,{timeoutMs:15e3,retries:2,retryBaseDelayMs:300,referrerPolicy:"no-referrer",crossOrigin:"anonymous",allowFetchFallback:!1,priority:"low",imageOrientation:"flipY"}),l=new B(c);this.applyTextureSettings(l),this.warnIfNotPanoAspect(l,i),l.flipY=!1,l.wrapS=H,l.wrapT=H,l.needsUpdate=!0;const h=this.getCurrentView();if(this.sphere&&this.sphere.material&&"map"in this.sphere.material){const u=this.sphere.material;u.map&&u.map.dispose(),u.map=l,u.needsUpdate=!0,this.setRenderSource("tiles","pano 高清可见")}this.setView(h.yaw,h.pitch,h.fov),this.updateLoadStatus(E.HIGH_READY),this.isDegradedMode=!1}catch(c){console.error("高清全景图加载失败，继续使用低清",i,c),this.isDegradedMode=!0,this.updateLoadStatus(E.DEGRADED)}}catch(n){console.error("低清全景图加载失败，尝试加载高清兜底",t,n),await this.loadSingleTexture(e,i,!1)}}setOnLoad(e){this.onLoadCallback=e}setOnError(e){this.onErrorCallback=e}setOnStatusChange(e){this.onStatusChangeCallback=e}getLoadStatus(){return this.loadStatus}resetMetrics(e){const t=performance.now();this.metrics={sceneId:e,startAt:t,lowReadyAt:0,highReadyAt:0,tilesLoaded:0,tilesFailed:0,tilesRetries:0,tileHitRate:0,perfMode:this.perfMode,renderSource:this.renderSource,lastError:""},this.emitMetrics("reset",!0)}emitMetrics(e,t=!1){var v;const i=performance.now();if(!t&&i-this.lastMetricsEmitAt<800)return;const n=(v=this.tilePano)==null?void 0:v.getStatus(),o=(n==null?void 0:n.tilesLoadedCount)??0,a=(n==null?void 0:n.tilesFailedCount)??0,c=(n==null?void 0:n.tilesRetryCount)??0,l=o+a,h=l>0?Number((o/l*100).toFixed(2)):0;this.metrics.tilesLoaded=o,this.metrics.tilesFailed=a,this.metrics.tilesRetries=c,this.metrics.tileHitRate=h,this.metrics.perfMode=this.perfMode,this.metrics.renderSource=this.renderSource,this.metrics.lastError=this.tilesLastError||((n==null?void 0:n.lastError)??"");const u=this.metrics.lowReadyAt?Math.round(this.metrics.lowReadyAt-this.metrics.startAt):-1,d=this.metrics.highReadyAt?Math.round(this.metrics.highReadyAt-this.metrics.startAt):-1,m={...this.metrics,lowReadyMs:u,highReadyMs:d,reason:e,at:Math.round(i)};window.__VR_METRICS__=m,window.dispatchEvent(new CustomEvent("vr:metrics",{detail:m})),this.lastMetricsEmitAt=i}isInDegradedMode(){return this.isDegradedMode}updateLoadStatus(e){if(this.loadStatus===e)return;this.loadStatus=e;const t=performance.now();e===E.LOW_READY&&this.metrics.lowReadyAt===0&&(this.metrics.lowReadyAt=t),e===E.HIGH_READY&&this.metrics.highReadyAt===0&&(this.metrics.highReadyAt=t),this.onStatusChangeCallback&&this.onStatusChangeCallback(e),this.emitMetrics(`status:${e}`)}getCurrentView(){return{yaw:this.yaw,pitch:this.pitch,fov:this.fov}}setView(e,t,i){this.yaw=e,this.pitch=Math.max(-90,Math.min(90,t)),i!==void 0&&this.setFovInternal(i,!1),this.updateCamera()}setFovInternal(e,t=!0){if(this.fov=Math.max(30,Math.min(120,e)),this.camera.fov=this.fov,this.camera.updateProjectionMatrix(),t){const i=te[this.renderProfile].camera.defaultFov,n=Math.round(i/this.fov*100),o=Math.max(50,Math.min(250,n));Ue.show(o)}}setFov(e){this.setFovInternal(e,!0)}setVrModeEnabled(e){this.vrModeEnabled=e,e||(this.isDragging=!1)}isVrModeEnabled(){return this.vrModeEnabled}isInteracting(){return this.isDragging||this.isPinching}handleResize(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}updatePerformanceGuard(e){const t=1e3/Math.max(1,e);this.perfSamples.push(t),this.perfSamples.length>30&&this.perfSamples.shift();const i=this.perfSamples.reduce((o,a)=>o+a,0)/this.perfSamples.length,n=performance.now();i<28&&this.perfMode==="normal"&&n-this.perfLastChangeAt>2e3&&(this.perfMode="throttle",this.perfLastChangeAt=n,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("throttle"),this.emitMetrics("perf:throttle",!0)),i>45&&this.perfMode==="throttle"&&n-this.perfLastChangeAt>3e3&&(this.perfMode="normal",this.perfLastChangeAt=n,this.tilePano&&"setPerformanceMode"in this.tilePano&&this.tilePano.setPerformanceMode("normal"),this.emitMetrics("perf:normal",!0))}updateTilesDebug(){var I;const e=new URLSearchParams(window.location.search);if(!(e.get("tilesDebug")==="1"||e.get("tilesDebug")==="true"||e.get("tilesDebug")==="on")){this.tilesDebugEl&&(this.tilesDebugEl.remove(),this.tilesDebugEl=null);return}if(!this.tilesDebugEl){const S=document.createElement("div");S.style.position="absolute",S.style.left="8px",S.style.top="8px",S.style.padding="6px 8px",S.style.background="rgba(0,0,0,0.55)",S.style.color="#fff",S.style.fontSize="12px",S.style.lineHeight="1.4",S.style.borderRadius="6px",S.style.zIndex="9999",S.style.pointerEvents="none",this.tilesDebugEl=S,this.container.appendChild(S)}const i=(I=this.tilePano)==null?void 0:I.getStatus(),n=this.tilePano?"tiles":"fallback",o=i!=null&&i.tilesVisible?"true":"false",a=(i==null?void 0:i.tilesLoadedCount)??0,c=(i==null?void 0:i.tilesLoadingCount)??0,l=(i==null?void 0:i.tilesQueuedCount)??0,h=(i==null?void 0:i.lastTileUrl)??"",u=this.tilesLastError||(i==null?void 0:i.lastError)||"",d=this.fallbackSphere?"true":"false",m=(i==null?void 0:i.canvasSize)??"",v=(i==null?void 0:i.maxLevel)??"",w=i!=null&&i.highReady?"true":"false",y=(i==null?void 0:i.levels)??"",g=this.renderSource,p=this.renderSwitchReason,b=this.clearedCount;this.tilesDebugEl.textContent=`mode=${n}
renderSource=${g}
switchReason=${p}
cleared=${b}
fallbackVisible=${d}
tilesVisible=${o}
tilesLoaded=${a}
tilesLoading=${c}
tilesQueued=${l}
lastTileUrl=${h}
lastError=${u}
canvas=${m} zMax=${v} levels=${y} highReady=${w}
lowReady=${this.tilesLowReady}`}animate(){requestAnimationFrame(()=>this.animate());const e=performance.now(),t=this.lastFrameTimeMs?e-this.lastFrameTimeMs:16.7;this.updatePerformanceGuard(t),this.lastFrameTimeMs=e;const i=this.getCurrentView(),n=Math.abs(i.yaw-this.lastYaw),o=Math.abs(i.pitch-this.lastPitch),a=Math.abs(i.fov-this.lastFov);if(n>this.viewChangeThreshold||o>this.viewChangeThreshold||a>this.viewChangeThreshold?this.isViewChanging||(this.isViewChanging=!0,C.emitInteracting()):this.isViewChanging&&(this.isViewChanging=!1,C.scheduleIdle()),this.lastYaw=i.yaw,this.lastPitch=i.pitch,this.lastFov=i.fov,this.updateCamera(),this.tilePano){this.tilePano.update(this.camera);const l=this.tilePano.getStatus(),h=!!this.fallbackSphere,u=l.tilesVisible,d=l.lowReady;h&&u&&d?(this.tilesVisibleStableFrames+=1,this.tilesVisibleStableFrames>=2&&this.clearFallback()):this.tilesVisibleStableFrames=0,!h&&!u&&this.noteCleared("无可见源"),u&&this.renderSource==="fallback"&&this.tilesLowReady&&this.setRenderSource("low","tiles 低清覆盖可见"),u&&l.highReady&&this.setRenderSource("tiles","tiles 高清可见"),l.lastError&&(this.tilesLastError=l.lastError),!this.tilesLowReady&&l.tilesLoadedCount>0&&(this.tilesLowReady=!0,this.updateLoadStatus(E.LOW_READY)),l.highReady&&(this.updateLoadStatus(E.HIGH_READY),this.isDegradedMode=!1,this.tilesDegradedNotified=!1),l.tilesLoadedCount>this.tilesLastLoadedCount&&(this.tilesLastLoadedCount=l.tilesLoadedCount,this.tilesLastProgressAt=e,this.tilesDegradedNotified&&!l.highReady&&(this.tilesDegradedNotified=!1)),this.tilesHighStartAt===0&&(l.tilesQueuedCount>0||l.tilesLoadingCount>0)&&(this.tilesHighStartAt=e,this.tilesLastProgressAt===0&&(this.tilesLastProgressAt=e)),this.tilesHighStartAt>0&&e-this.tilesLastProgressAt>12e3&&!l.highReady&&!this.tilesDegradedNotified&&this.tilesLowReady&&(this.isDegradedMode=!0,this.updateLoadStatus(E.DEGRADED),this.tilesDegradedNotified=!0)}this.updateTilesDebug(),this.emitMetrics("frame"),this.nadirPatch&&this.nadirPatch.update(this.camera,{yaw:i.yaw,pitch:i.pitch},t),this.compassDisk&&this.compassDisk.setYawPitch(i.yaw,i.pitch),this.groundNavDots&&this.groundNavDots.setYawPitch(i.yaw,i.pitch),this.groundHeading&&this.groundHeading.setYawPitch(i.yaw,i.pitch);for(const l of this.frameListeners)l(t);this.renderer.render(this.scene,this.camera)}onFrame(e){return this.frameListeners.push(e),()=>{const t=this.frameListeners.indexOf(e);t>=0&&this.frameListeners.splice(t,1)}}getCamera(){return this.camera}getDomElement(){return this.renderer.domElement}setSceneData(e,t,i){if(this.groundNavDots){const n=i.filter(o=>{var a;return o.type==="scene"&&((a=o.target)==null?void 0:a.sceneId)}).map(o=>({id:o.id,label:o.label,yaw:o.yaw,pitch:o.pitch,target:{museumId:o.target.museumId,sceneId:o.target.sceneId}}));this.groundNavDots.updateScene(e,t,n)}}getSphereRadius(){return 500}getViewportSize(){return{width:this.container.clientWidth,height:this.container.clientHeight}}enablePickMode(){this.pickMode||(this.pickMode=!0,this.setupPickModeListeners())}disablePickMode(){this.pickMode&&(this.pickMode=!1,this.removePickModeListeners())}togglePickMode(){return this.pickMode?this.disablePickMode():this.enablePickMode(),this.pickMode}isPickModeEnabled(){return this.pickMode}setupPickModeListeners(){const e=this.renderer.domElement,t=o=>{if(!this.pickMode)return;let a,c;if(o instanceof TouchEvent){if(o.touches.length!==1)return;a=o.touches[0].clientX,c=o.touches[0].clientY}else a=o.clientX,c=o.clientY;this.pickStartX=a,this.pickStartY=c,this.pickStartTime=Date.now(),this.pickHasMoved=!1},i=o=>{if(!this.pickMode)return;let a,c;if(o instanceof TouchEvent){if(o.touches.length!==1)return;a=o.touches[0].clientX,c=o.touches[0].clientY}else a=o.clientX,c=o.clientY;const l=Math.abs(a-this.pickStartX),h=Math.abs(c-this.pickStartY);Math.sqrt(l*l+h*h)>this.pickDragThreshold&&(this.pickHasMoved=!0)},n=o=>{if(!this.pickMode)return;let a,c;if(o instanceof TouchEvent){if(o.changedTouches.length!==1)return;a=o.changedTouches[0].clientX,c=o.changedTouches[0].clientY}else a=o.clientX,c=o.clientY;const l=Date.now()-this.pickStartTime,h=Math.abs(a-this.pickStartX),u=Math.abs(c-this.pickStartY);Math.sqrt(h*h+u*u)>this.pickDragThreshold||l>this.pickTimeThreshold&&this.pickHasMoved||this.handlePick(a,c),this.pickHasMoved=!1};e.addEventListener("pointerdown",t),e.addEventListener("mousedown",t),e.addEventListener("touchstart",t,{passive:!0}),e.addEventListener("pointermove",i),e.addEventListener("mousemove",i),e.addEventListener("touchmove",i,{passive:!0}),e.addEventListener("pointerup",n),e.addEventListener("mouseup",n),e.addEventListener("touchend",n,{passive:!0}),this.pickModeListeners.push(()=>{e.removeEventListener("pointerdown",t),e.removeEventListener("mousedown",t),e.removeEventListener("touchstart",t),e.removeEventListener("pointermove",i),e.removeEventListener("mousemove",i),e.removeEventListener("touchmove",i),e.removeEventListener("pointerup",n),e.removeEventListener("mouseup",n),e.removeEventListener("touchend",n)})}removePickModeListeners(){this.pickModeListeners.forEach(e=>e()),this.pickModeListeners=[]}handlePick(e,t){const i=this.renderer.domElement.getBoundingClientRect(),n=Ni(e,t,i),o=Ci(n.x,n.y,this.camera,this.getSphereRadius());if(!o){typeof __VR_DEBUG__<"u"&&__VR_DEBUG__&&console.debug("[pick] 无法计算 yaw/pitch（ray.direction 为空）");return}const{yaw:a,pitch:c}=o,l=`yaw: ${a.toFixed(2)}, pitch: ${c.toFixed(2)}`;console.log(`[pick] yaw=${a.toFixed(2)}, pitch=${c.toFixed(2)}`),navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(l).catch(()=>{}),window.dispatchEvent(new CustomEvent("vr:pick",{detail:{x:e,y:t,yaw:a,pitch:c}}))}warnIfNotPanoAspect(e,t){if(!e.image)return;const i=e.image,n=i.width,o=i.height;if(!n||!o)return;const a=n/o;Math.abs(a-2)>.02&&!this.aspectWarnedUrls.has(t)&&(console.warn(`[PanoViewer] 全景图比例不是 2:1，可能出现轻微变形（实际 ${a.toFixed(2)}），来源: ${t}`),this.aspectWarnedUrls.add(t))}dispose(){if(this.tilePano&&(this.tilePano.dispose(),this.tilePano=null),this.clearFallback(),this.sphere&&(this.scene.remove(this.sphere),this.sphere.geometry&&this.sphere.geometry.dispose(),this.sphere.material&&"map"in this.sphere.material)){const e=this.sphere.material;e.map&&e.map.dispose(),e.dispose()}this.nadirPatch&&(this.nadirPatch.dispose(this.scene),this.nadirPatch=null),this.compassDisk&&(this.compassDisk.dispose(),this.compassDisk=null),this.groundNavDots&&(this.groundNavDots.dispose(),this.groundNavDots=null),this.groundHeading&&(this.groundHeading.dispose(),this.groundHeading=null),this.renderer.dispose(),window.removeEventListener("resize",this.handleWindowResize)}applyRendererProfile(){const e=te[this.renderProfile];this.renderer.setPixelRatio(e.renderer.pixelRatio),"outputColorSpace"in this.renderer?this.renderer.outputColorSpace=de:this.renderer.outputEncoding=ke,this.renderer.toneMapping=e.renderer.toneMapping,this.renderer.toneMappingExposure=e.renderer.toneMappingExposure,e.renderer.clearColor&&this.renderer.setClearColor(e.renderer.clearColor.color,e.renderer.clearColor.alpha)}detectRenderProfile(){try{const t=new URLSearchParams(window.location.search).get("render");if(t&&t.toLowerCase()==="original")return"original"}catch{}return"enhanced"}fallbackToLegacy(e,t){const i={...e,pano:(t==null?void 0:t.fallbackPano)??e.pano,panoLow:(t==null?void 0:t.fallbackPanoLow)??e.panoLow,panoTiles:void 0};i.pano||i.panoLow?(Z("瓦片加载失败，已回退到全景图",2e3),this.setRenderSource("fallback","tiles 失败自动回退"),this.loadScene(i,{preserveView:!0})):(this.updateLoadStatus(E.ERROR),this.onErrorCallback&&this.onErrorCallback(new Error("瓦片与全景资源均不可用")))}setRenderSource(e,t){(this.renderSource!==e||t)&&(this.renderSource=e,this.renderSwitchReason=t)}noteCleared(e){this.clearedCount+=1,this.renderSwitchReason=e}async showFallbackTexture(e,t,i){try{const n=await le(e,{timeoutMs:15e3,retries:1,allowFetchFallback:!0,priority:"high",imageOrientation:"flipY"}),o=new B(n);this.applyTextureSettings(o),o.flipY=!1,o.wrapS=H,o.wrapT=H,o.needsUpdate=!0;const a=new oe({map:o,depthWrite:!1,depthTest:!1}),c=new ae(t.clone(),a);c.renderOrder=0,this.fallbackSphere=c,this.scene.add(c),this.updateLoadStatus(i?E.LOW_READY:E.HIGH_READY),this.setRenderSource("fallback",i?"fallback 低清可见":"fallback 高清可见"),i&&(this.tilesLowReady=!0),this.onLoadCallback&&this.onLoadCallback()}catch(n){console.error("fallback 贴图加载失败",n)}}clearFallback(){if(this.fallbackSphere){this.fallbackSphere.geometry&&this.fallbackSphere.geometry.dispose();const e=this.fallbackSphere.material;e.map&&e.map.dispose(),e.dispose(),this.scene.remove(this.fallbackSphere),this.fallbackSphere=null}}applyTextureSettings(e){const t=te[this.renderProfile],i=this.renderer.capabilities.getMaxAnisotropy?this.renderer.capabilities.getMaxAnisotropy():1;if(e.anisotropy=Math.min(t.texture.anisotropyLimit,Math.max(1,i||1)),e.minFilter=t.texture.minFilter,e.magFilter=t.texture.magFilter,e.generateMipmaps=t.texture.generateMipmaps,"colorSpace"in e?e.colorSpace=de:e.encoding=ke,e.needsUpdate=!0,this.debugMode){const n=e.image||{};console.log("pano texture",{w:n.width,h:n.height,colorSpace:e.colorSpace,encoding:e.encoding,anisotropy:e.anisotropy,minFilter:e.minFilter,magFilter:e.magFilter})}}}class lt{constructor(e){r(this,"element");this.element=document.createElement("div"),this.element.className="title-bar",this.element.innerHTML=`
      <div class="title-bar-content">
        <span class="title-text">${e}</span>
      </div>
    `,this.applyStyles()}applyStyles(){const e=document.createElement("style");e.textContent=`
      .title-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        padding-top: env(safe-area-inset-top, 0px);
        height: calc(44px + env(safe-area-inset-top, 0px));
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .title-bar-content {
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 60px;
      }
      .title-text {
        font-size: 16px;
        font-weight: 500;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    `,document.head.appendChild(e)}setTitle(e){const t=this.element.querySelector(".title-text");t&&(t.textContent=e)}getElement(){return this.element}remove(){this.element.remove()}}class qi{constructor(e){r(this,"element");r(this,"museums");this.museums=e,this.element=document.createElement("div"),this.element.className="museum-list",this.render(),this.applyStyles()}render(){const e=this.museums.filter(i=>i.id==="wangding"),t=this.museums.filter(i=>i.id!=="wangding");this.element.innerHTML=`
      <div class="museum-list-container">
        <h1 class="museum-list-title">王鼎纪念馆</h1>
        <p class="museum-list-subtitle">以王鼎生平为主线的红色研学展馆</p>
        <div class="museum-grid">
          ${e.map(i=>`
            <div class="museum-card museum-card-active" data-museum-id="${i.id}">
              <div class="museum-cover">
                <img src="${i.cover}" alt="${i.name}" loading="lazy">
                <div class="museum-overlay">
                  <h2 class="museum-name">${i.name}</h2>
                  ${i.description?`<p class="museum-desc">${i.description}</p>`:""}
                  <p class="museum-scene-count">${i.scenes.length} 个场景</p>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
        ${t.length>0?`
        <div class="museum-grid muted">
          ${t.map(i=>`
            <div class="museum-card museum-card-disabled">
              <div class="museum-cover">
                <img src="${i.cover}" alt="${i.name}" loading="lazy">
                <div class="museum-overlay">
                  <h2 class="museum-name">${i.name}</h2>
                  <p class="museum-desc">建设中，敬请期待</p>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
        `:""}
      </div>
    `,this.element.querySelectorAll(".museum-card-active").forEach(i=>{i.addEventListener("click",()=>{const n=i.getAttribute("data-museum-id");n&&Re(n)})})}applyStyles(){const e=document.createElement("style");e.textContent=`
      .museum-list {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding-top: calc(44px + env(safe-area-inset-top, 0px));
      }
      .museum-list-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .museum-list-title {
        font-size: 28px;
        font-weight: 600;
        color: #fff;
        text-align: center;
        margin-bottom: 30px;
      }
      .museum-list-subtitle {
        font-size: 16px;
        color: rgba(255,255,255,0.9);
        text-align: center;
        margin-top: -12px;
        margin-bottom: 24px;
      }
      .museum-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }
      .museum-grid.muted {
        opacity: 0.7;
      }
      .museum-card {
        cursor: pointer;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .museum-card-disabled {
        cursor: not-allowed;
        filter: grayscale(0.3);
      }
      .museum-card:active {
        transform: scale(0.98);
      }
      .museum-card-disabled:active {
        transform: none;
      }
      .museum-cover {
        position: relative;
        width: 100%;
        padding-top: 60%;
        overflow: hidden;
      }
      .museum-cover img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .museum-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        padding: 20px;
        color: #fff;
      }
      .museum-name {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 5px;
      }
      .museum-desc {
        font-size: 14px;
        margin: 6px 0;
        line-height: 1.5;
      }
      .museum-scene-count {
        font-size: 14px;
        opacity: 0.9;
      }
    `,document.head.appendChild(e)}getElement(){return this.element}remove(){this.element.remove()}}class Xi{constructor(){r(this,"element");this.element=document.createElement("div"),this.element.className="loading-overlay",this.render(),this.applyStyles();const e=()=>{ue()&&this.hide()};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}render(){this.element.innerHTML=`
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">加载中...</p>
      </div>
    `}applyStyles(){const e=document.createElement("style");e.textContent=`
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .loading-overlay.show {
        opacity: 1;
        pointer-events: all;
      }
      .loading-spinner {
        text-align: center;
        color: #fff;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }
      .loading-text {
        font-size: 14px;
        margin: 0;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    `,document.head.appendChild(e)}show(){ue()||this.element.classList.add("show")}hide(){this.element.classList.remove("show")}getElement(){return this.element}remove(){this.element.remove()}}const ji={[f.INVALID_ROOT]:"配置格式错误",[f.MISSING_APP_NAME]:"缺少应用名称",[f.MUSEUMS_NOT_ARRAY]:"博物馆列表格式错误",[f.MUSEUMS_EMPTY]:"博物馆列表为空",[f.MISSING_MUSEUM_ID]:"缺少博物馆 ID",[f.DUPLICATE_MUSEUM_ID]:"博物馆 ID 重复",[f.MISSING_MUSEUM_NAME]:"缺少博物馆名称",[f.MISSING_MUSEUM_COVER]:"缺少封面图",[f.MISSING_MUSEUM_MAP]:"缺少地图配置",[f.MISSING_MAP_IMAGE]:"缺少地图图片",[f.INVALID_MAP_WIDTH]:"地图宽度无效",[f.INVALID_MAP_HEIGHT]:"地图高度无效",[f.SCENES_NOT_ARRAY]:"场景列表格式错误",[f.SCENES_EMPTY]:"场景列表为空",[f.MISSING_SCENE_ID]:"缺少场景 ID",[f.DUPLICATE_SCENE_ID]:"场景 ID 重复",[f.MISSING_SCENE_NAME]:"缺少场景名称",[f.MISSING_PANO]:"缺少全景图",[f.INVALID_PANO_URL]:"高清全景图 URL 无效",[f.INVALID_PANOLOW_URL]:"低清全景图 URL 无效",[f.MISSING_THUMB]:"缺少缩略图",[f.MISSING_INITIAL_VIEW]:"缺少初始视角配置",[f.INVALID_YAW]:"水平角度无效",[f.INVALID_PITCH]:"垂直角度无效",[f.INVALID_FOV]:"视野角度无效",[f.MISSING_MAP_POINT]:"缺少地图点位",[f.INVALID_MAP_POINT_X]:"地图点位 X 坐标无效",[f.INVALID_MAP_POINT_Y]:"地图点位 Y 坐标无效",[f.HOTSPOTS_NOT_ARRAY]:"热点列表格式错误",[f.MISSING_HOTSPOT_ID]:"缺少热点 ID",[f.DUPLICATE_HOTSPOT_ID]:"热点 ID 重复",[f.INVALID_HOTSPOT_TYPE]:"热点类型无效",[f.MISSING_HOTSPOT_LABEL]:"缺少热点标签",[f.INVALID_HOTSPOT_YAW]:"热点水平角度无效",[f.INVALID_HOTSPOT_PITCH]:"热点垂直角度无效",[f.MISSING_HOTSPOT_TARGET]:"缺少热点目标配置",[f.MISSING_TARGET_MUSEUM_ID]:"缺少目标博物馆 ID",[f.MISSING_TARGET_SCENE_ID]:"缺少目标场景 ID",[f.INVALID_TARGET_YAW]:"目标水平角度无效",[f.INVALID_TARGET_PITCH]:"目标垂直角度无效",[f.INVALID_TARGET_FOV]:"目标视野角度无效",[f.MISSING_TARGET_URL]:"缺少视频链接"},Qi={[f.INVALID_ROOT]:"请确保 config.json 是一个有效的 JSON 对象",[f.MISSING_APP_NAME]:'请在配置中添加 "appName" 字段，例如："appName": "我的 VR 展馆"',[f.MUSEUMS_NOT_ARRAY]:'请确保 "museums" 是一个数组，例如："museums": []',[f.MUSEUMS_EMPTY]:'请至少添加一个博物馆到 "museums" 数组中',[f.MISSING_MUSEUM_ID]:'请为该博物馆添加 "id" 字段，例如："id": "museum1"',[f.DUPLICATE_MUSEUM_ID]:'请确保每个博物馆的 "id" 都是唯一的，不能重复',[f.MISSING_MUSEUM_NAME]:'请为该博物馆添加 "name" 字段，例如："name": "第一展馆"',[f.MISSING_MUSEUM_COVER]:'请为该博物馆添加 "cover" 字段，填入封面图的 URL',[f.MISSING_MUSEUM_MAP]:'请为该博物馆添加 "map" 对象配置',[f.MISSING_MAP_IMAGE]:'请在地图配置中添加 "image" 字段，填入地图图片的 URL',[f.INVALID_MAP_WIDTH]:'请确保 "map.width" 是一个大于 0 的数字',[f.INVALID_MAP_HEIGHT]:'请确保 "map.height" 是一个大于 0 的数字',[f.SCENES_NOT_ARRAY]:'请确保 "scenes" 是一个数组，例如："scenes": []',[f.SCENES_EMPTY]:"请至少为该博物馆添加一个场景",[f.MISSING_SCENE_ID]:'请为该场景添加 "id" 字段，例如："id": "scene1"',[f.DUPLICATE_SCENE_ID]:'请确保同一博物馆内每个场景的 "id" 都是唯一的',[f.MISSING_SCENE_NAME]:'请为该场景添加 "name" 字段，例如："name": "正门"',[f.MISSING_PANO]:'请为该场景添加 "pano"、"panoLow" 或 "panoTiles" 字段，至少提供一种全景来源',[f.INVALID_PANO_URL]:'请确保 "pano" 字段是一个有效的图片 URL 字符串',[f.INVALID_PANOLOW_URL]:'请确保 "panoLow" 字段是一个有效的图片 URL 字符串',[f.MISSING_THUMB]:'请为该场景添加 "thumb" 字段，填入缩略图的 URL',[f.MISSING_INITIAL_VIEW]:'请为该场景添加 "initialView" 对象配置',[f.INVALID_YAW]:'请确保 "initialView.yaw" 是一个数字（水平角度，范围 -180 到 180）',[f.INVALID_PITCH]:'请确保 "initialView.pitch" 是一个数字（垂直角度，范围 -90 到 90）',[f.INVALID_FOV]:'请确保 "initialView.fov" 是一个数字（视野角度，范围 30 到 120）',[f.MISSING_MAP_POINT]:'请为该场景添加 "mapPoint" 对象配置',[f.INVALID_MAP_POINT_X]:'请确保 "mapPoint.x" 是一个数字（地图上的 X 坐标）',[f.INVALID_MAP_POINT_Y]:'请确保 "mapPoint.y" 是一个数字（地图上的 Y 坐标）',[f.HOTSPOTS_NOT_ARRAY]:'请确保 "hotspots" 是一个数组，例如："hotspots": []',[f.MISSING_HOTSPOT_ID]:'请为该热点添加 "id" 字段，例如："id": "hotspot1"',[f.DUPLICATE_HOTSPOT_ID]:'请确保同一场景内每个热点的 "id" 都是唯一的',[f.INVALID_HOTSPOT_TYPE]:'请确保 "type" 字段是 "scene" 或 "video" 之一',[f.MISSING_HOTSPOT_LABEL]:'请为该热点添加 "label" 字段，例如："label": "进入展厅"',[f.INVALID_HOTSPOT_YAW]:'请确保 "yaw" 是一个数字（热点在全景图中的水平位置）',[f.INVALID_HOTSPOT_PITCH]:'请确保 "pitch" 是一个数字（热点在全景图中的垂直位置）',[f.MISSING_HOTSPOT_TARGET]:'请为该热点添加 "target" 对象配置',[f.MISSING_TARGET_MUSEUM_ID]:'场景跳转类型的热点必须包含 "target.museumId" 字段',[f.MISSING_TARGET_SCENE_ID]:'场景跳转类型的热点必须包含 "target.sceneId" 字段',[f.INVALID_TARGET_YAW]:'请确保 "target.yaw" 是一个数字（跳转后的水平角度）',[f.INVALID_TARGET_PITCH]:'请确保 "target.pitch" 是一个数字（跳转后的垂直角度）',[f.INVALID_TARGET_FOV]:'请确保 "target.fov" 是一个数字（跳转后的视野角度）',[f.MISSING_TARGET_URL]:'视频类型的热点必须包含 "target.url" 字段，填入视频的 URL'};class Ki{constructor(e,t,i){r(this,"element");this.element=document.createElement("div"),this.element.className="config-error-panel",this.render(e,t,i),this.applyStyles()}render(e,t,i){this.element.innerHTML=`
      <div class="error-panel-content">
        <div class="error-panel-header">
          <h2>⚠️ 配置错误</h2>
          <p class="error-summary">发现 ${e.length} 个配置错误，请检查 config.json</p>
        </div>
        <div class="error-list">
          ${e.map((a,c)=>this.renderErrorCard(a,c)).join("")}
        </div>
        <div class="error-actions">
          <button class="btn btn-primary" id="retry-btn">🔄 刷新重试</button>
          <button class="btn btn-secondary" id="example-btn">📖 查看示例配置</button>
        </div>
      </div>
    `;const n=this.element.querySelector("#retry-btn"),o=this.element.querySelector("#example-btn");n&&n.addEventListener("click",t),o&&o.addEventListener("click",i)}renderErrorCard(e,t){const i=ji[e.code]||"配置错误",n=Qi[e.code]||"请检查配置文件的格式和内容",o=[];e.museumName&&o.push(`馆：${e.museumName}`),e.sceneName&&o.push(`场景：${e.sceneName}`);const a=o.length>0?o.join(" / "):"全局配置";return`
      <div class="error-card">
        <div class="error-card-header">
          <span class="error-icon">❌</span>
          <span class="error-title">${this.escapeHtml(i)}</span>
        </div>
        <div class="error-card-body">
          <div class="error-location">
            <span class="location-icon">📍</span>
            <span class="location-text">${this.escapeHtml(a)}</span>
          </div>
          ${e.fieldName?`
            <div class="error-field">
              <span class="field-label">字段：</span>
              <span class="field-name">${this.escapeHtml(e.fieldName)}</span>
            </div>
          `:""}
          <div class="error-path">
            <span class="path-label">技术路径：</span>
            <code class="path-code">${this.escapeHtml(e.path)}</code>
          </div>
          <div class="error-hint">
            <span class="hint-icon">💡</span>
            <span class="hint-text">${this.escapeHtml(n)}</span>
          </div>
        </div>
      </div>
    `}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}applyStyles(){const e=document.createElement("style");e.textContent=`
      .config-error-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      }
      .error-panel-content {
        max-width: 800px;
        width: 100%;
        background: #1a1a1a;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      .error-panel-header {
        margin-bottom: 24px;
        text-align: center;
      }
      .error-panel-header h2 {
        font-size: 24px;
        color: #ff6b6b;
        margin-bottom: 8px;
      }
      .error-summary {
        color: #ccc;
        font-size: 14px;
      }
      .error-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 24px;
        background: #0f0f0f;
        border-radius: 8px;
        padding: 16px;
      }
      .error-card {
        padding: 16px;
        margin-bottom: 12px;
        background: #252525;
        border-left: 4px solid #ff6b6b;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .error-card:hover {
        background: #2a2a2a;
      }
      .error-card:last-child {
        margin-bottom: 0;
      }
      .error-card-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .error-icon {
        font-size: 20px;
      }
      .error-title {
        font-size: 16px;
        font-weight: 600;
        color: #ff6b6b;
      }
      .error-card-body {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .error-location {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #4a90e2;
      }
      .location-icon {
        font-size: 14px;
      }
      .location-text {
        font-weight: 500;
      }
      .error-field {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #ccc;
      }
      .field-label {
        color: #999;
      }
      .field-name {
        color: #ffd93d;
        font-weight: 500;
      }
      .error-path {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        font-size: 12px;
        color: #999;
        margin-top: 4px;
      }
      .path-label {
        color: #666;
        white-space: nowrap;
      }
      .path-code {
        font-family: 'Courier New', monospace;
        color: #888;
        word-break: break-all;
        background: #1a1a1a;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
      }
      .error-hint {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-top: 8px;
        padding: 10px;
        background: #1a1a1a;
        border-radius: 6px;
        border-left: 3px solid #4a90e2;
      }
      .hint-icon {
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 2px;
      }
      .hint-text {
        font-size: 13px;
        color: #ccc;
        line-height: 1.5;
      }
      .error-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }
      .btn-primary {
        background: #4a90e2;
        color: #fff;
      }
      .btn-primary:hover {
        background: #357abd;
      }
      .btn-primary:active {
        transform: scale(0.98);
      }
      .btn-secondary {
        background: #555;
        color: #fff;
      }
      .btn-secondary:hover {
        background: #666;
      }
      .btn-secondary:active {
        transform: scale(0.98);
      }
      @media (max-width: 600px) {
        .error-panel-content {
          padding: 16px;
        }
        .error-actions {
          flex-direction: column;
        }
        .btn {
          width: 100%;
        }
      }
    `,document.head.appendChild(e)}getElement(){return this.element}remove(){this.element.remove()}}let $=null;function Et(){return $!==null?$:typeof navigator<"u"&&navigator.maxTouchPoints>0||typeof window<"u"&&("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)?($="touch",$):($="mouse",$)}function St(){return Et()==="touch"}function Mt(){return Et()==="mouse"}function Ji(){const s=document;return document.fullscreenElement||s.webkitFullscreenElement||null}function Te(){return!!Ji()}async function Zi(s){const e=s;if(e.requestFullscreen){await e.requestFullscreen();return}if(e.webkitRequestFullscreen){await e.webkitRequestFullscreen();return}throw new Error("Fullscreen API not supported")}async function es(){const s=document;if(document.exitFullscreen){await document.exitFullscreen();return}if(s.webkitExitFullscreen){await s.webkitExitFullscreen();return}}async function Tt(s){const e=s||document.body;!Te()&&Mt()&&Z("鼠标滑至最上方可退出全屏",700),await Zi(e)}async function Ye(){try{await es(),Lt()}catch(s){console.debug("[fullscreen] exitFullscreenBestEffort failed:",s)}}function Lt(){var s,e;try{(e=(s=screen.orientation)==null?void 0:s.unlock)==null||e.call(s)}catch{}}function ts(){return`
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M9 4H4V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M15 4H20V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M9 20H4V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M15 20H20V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`}function is(){return`
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M4 9V4h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M20 9V4h-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M4 15v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M20 15v5h-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M9 9l-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M15 9l3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M9 15l-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M15 15l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`}class ss{constructor(e={}){r(this,"element");r(this,"fullscreenBtn");r(this,"pickModeBtn",null);r(this,"northCalibrationBtn",null);r(this,"vrModeBtn",null);r(this,"handlePickModeChange",null);r(this,"handleFullscreenChange",null);r(this,"viewerRootEl");r(this,"onTogglePickMode");r(this,"onOpenNorthCalibration");r(this,"onToggleVrMode");r(this,"isPickModeActive",!1);r(this,"isVrModeActive",!1);this.viewerRootEl=e.viewerRootEl,this.onTogglePickMode=e.onTogglePickMode,this.onOpenNorthCalibration=e.onOpenNorthCalibration,this.onToggleVrMode=e.onToggleVrMode,this.element=document.createElement("div"),this.element.className="vr-topright-controls",this.handlePickModeChange=i=>{const n=i;this.updatePickModeState(n.detail.enabled)},window.addEventListener("vr:pickmode",this.handlePickModeChange),this.handleFullscreenChange=()=>{this.syncFullscreenState()},document.addEventListener("fullscreenchange",this.handleFullscreenChange),document.addEventListener("webkitfullscreenchange",this.handleFullscreenChange),this.fullscreenBtn=document.createElement("button"),this.fullscreenBtn.className="vr-topright-btn vr-top-icon-only vr-icon-btn",this.fullscreenBtn.setAttribute("aria-label","进入全屏"),this.fullscreenBtn.addEventListener("click",async i=>{i.preventDefault(),i.stopPropagation();const n=Te();try{if(n)await Ye();else{const o=this.viewerRootEl;if(!o){console.warn("[TopRightControls] fullscreen target not set");return}await Tt(o)}}catch(o){P&&console.debug("[TopRightControls] fullscreen toggle failed",o)}finally{window.setTimeout(()=>{this.syncFullscreenState()},100)}}),this.syncFullscreenState(),this.onTogglePickMode&&(this.pickModeBtn=document.createElement("button"),this.pickModeBtn.className="vr-topright-btn",this.pickModeBtn.setAttribute("aria-label","拾取模式"),this.pickModeBtn.title="拾取模式：点击画面获取 yaw/pitch",this.pickModeBtn.textContent="🎯",this.pickModeBtn.style.fontSize="18px",this.pickModeBtn.addEventListener("click",i=>{if(i.preventDefault(),i.stopPropagation(),this.onTogglePickMode){const n=this.onTogglePickMode();this.updatePickModeState(n)}}),this.element.appendChild(this.pickModeBtn)),e.showNorthCalibration!==!1&&(e.onOpenNorthCalibration||P)&&this.onOpenNorthCalibration&&(this.northCalibrationBtn=document.createElement("button"),this.northCalibrationBtn.className="vr-topright-btn",this.northCalibrationBtn.setAttribute("aria-label","校准北向"),this.northCalibrationBtn.title="校准北向：设置当前场景的北方向",this.northCalibrationBtn.textContent="🧭",this.northCalibrationBtn.style.fontSize="18px",this.northCalibrationBtn.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.onOpenNorthCalibration&&this.onOpenNorthCalibration()}),this.element.appendChild(this.northCalibrationBtn)),St()&&this.onToggleVrMode&&(this.vrModeBtn=document.createElement("button"),this.vrModeBtn.className="vr-topright-btn vr-top-icon-only vr-icon-btn",this.vrModeBtn.setAttribute("aria-label","VR眼镜"),this.vrModeBtn.title="VR眼镜：转动设备控制视角",this.vrModeBtn.textContent="🥽",this.vrModeBtn.style.fontSize="18px",this.vrModeBtn.addEventListener("click",async i=>{if(i.preventDefault(),i.stopPropagation(),this.onToggleVrMode)try{const n=await this.onToggleVrMode();this.updateVrModeState(n)}catch(n){P&&console.debug("[TopRightControls] VR mode toggle failed",n)}}),this.element.appendChild(this.vrModeBtn)),this.element.appendChild(this.fullscreenBtn)}updatePickModeState(e){this.isPickModeActive=e,this.pickModeBtn&&(this.pickModeBtn.setAttribute("aria-label",e?"关闭拾取模式":"开启拾取模式"),this.pickModeBtn.title=e?"关闭拾取模式":"开启拾取模式：点击画面获取 yaw/pitch",this.pickModeBtn.style.background=e?"rgba(255,255,255,0.18)":"")}updateVrModeState(e){this.isVrModeActive=e,this.vrModeBtn&&(this.vrModeBtn.setAttribute("aria-label",e?"退出VR模式":"进入VR模式"),this.vrModeBtn.title=e?"退出VR模式":"VR眼镜：转动设备控制视角",this.vrModeBtn.style.background=e?"rgba(255,255,255,0.18)":"")}setViewerRootEl(e){this.viewerRootEl=e}syncFullscreenState(){const e=Te();this.fullscreenBtn.setAttribute("aria-label",e?"退出全屏":"进入全屏"),this.fullscreenBtn.title=e?"退出全屏":"进入全屏",this.fullscreenBtn.innerHTML=e?is():ts()}getElement(){return this.element}remove(){this.handlePickModeChange&&(window.removeEventListener("vr:pickmode",this.handlePickModeChange),this.handlePickModeChange=null),this.handleFullscreenChange&&(document.removeEventListener("fullscreenchange",this.handleFullscreenChange),document.removeEventListener("webkitfullscreenchange",this.handleFullscreenChange),this.handleFullscreenChange=null),this.element.remove()}}async function ns(s){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(s),!0}catch(e){console.debug("[copyText] Clipboard API failed, using fallback:",e)}try{const e=document.createElement("textarea");e.value=s,e.style.position="fixed",e.style.top="-9999px",e.style.left="-9999px",e.style.opacity="0",e.setAttribute("readonly","readonly"),document.body.appendChild(e),e.select(),e.setSelectionRange(0,s.length);const t=document.execCommand("copy");return document.body.removeChild(e),t}catch(e){return console.debug("[copyText] execCommand fallback failed:",e),!1}}class os{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"options");this.options=e;const t=document.createElement("div");t.className="vr-modal vr-modal--media vr-modal--image";const i=document.createElement("div");i.className="vr-modal-mask",i.addEventListener("click",()=>this.handleClose());const n=document.createElement("div");n.className="vr-modal-card vr-modal-card--media vr-modal-card--image",n.addEventListener("click",u=>u.stopPropagation());const o=document.createElement("div");o.className="vr-modal-header";const a=document.createElement("div");a.className="vr-modal-title",a.textContent=e.title||"图片预览";const c=document.createElement("button");c.className="vr-btn vr-modal-close-icon",c.setAttribute("aria-label","关闭"),c.textContent="×",c.addEventListener("click",()=>this.handleClose()),o.appendChild(a),o.appendChild(c);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--image";const h=document.createElement("img");h.className="vr-modal-image",e.src&&(h.src=e.src),h.alt=e.title||"热点图片",h.loading="lazy",l.appendChild(h),n.appendChild(o),n.appendChild(l),t.appendChild(i),t.appendChild(n),this.element=t}handleClose(){var e,t;this.close(),(t=(e=this.options).onClose)==null||t.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class as{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"options");this.options=e;const t=document.createElement("div");t.className="vr-modal vr-modal--info";const i=document.createElement("div");i.className="vr-modal-mask",i.addEventListener("click",()=>this.handleClose());const n=document.createElement("div");n.className="vr-modal-card vr-modal-card--info",n.addEventListener("click",h=>h.stopPropagation());const o=document.createElement("div");o.className="vr-modal-header";const a=document.createElement("div");a.className="vr-modal-title",a.textContent=e.title||"详情";const c=document.createElement("button");c.className="vr-btn vr-modal-close-icon",c.setAttribute("aria-label","关闭"),c.textContent="×",c.addEventListener("click",()=>this.handleClose()),o.appendChild(a),o.appendChild(c);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--info",l.textContent=e.text||"未配置内容",n.appendChild(o),n.appendChild(l),t.appendChild(i),t.appendChild(n),this.element=t}handleClose(){var e,t;this.close(),(t=(e=this.options).onClose)==null||t.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){this.isOpen&&(this.isOpen=!1,this.element.classList.remove("open"))}getElement(){return this.element}destroy(){this.element.remove()}}class rs{constructor(e){r(this,"element");r(this,"isOpen",!1);r(this,"videoEl");r(this,"options");this.options=e;const t=document.createElement("div");t.className="vr-modal vr-modal--media vr-modal--video";const i=document.createElement("div");i.className="vr-modal-mask",i.addEventListener("click",()=>this.handleClose());const n=document.createElement("div");n.className="vr-modal-card vr-modal-card--media vr-modal-card--video",n.addEventListener("click",u=>u.stopPropagation());const o=document.createElement("div");o.className="vr-modal-header";const a=document.createElement("div");a.className="vr-modal-title",a.textContent=e.title||"视频";const c=document.createElement("button");c.className="vr-btn vr-modal-close-icon",c.setAttribute("aria-label","关闭"),c.textContent="×",c.addEventListener("click",()=>this.handleClose()),o.appendChild(a),o.appendChild(c);const l=document.createElement("div");l.className="vr-modal-body vr-modal-body--video";const h=document.createElement("video");h.className="vr-modal-video",e.src&&(h.src=e.src),e.poster&&(h.poster=e.poster),h.controls=!0,h.playsInline=!0,h.preload="metadata",this.videoEl=h,l.appendChild(h),n.appendChild(o),n.appendChild(l),t.appendChild(i),t.appendChild(n),this.element=t}handleClose(){var e,t;this.close(),(t=(e=this.options).onClose)==null||t.call(e)}open(){this.isOpen||(this.isOpen=!0,this.element.classList.add("open"))}close(){if(this.isOpen){this.isOpen=!1,this.element.classList.remove("open");try{this.videoEl.pause(),this.videoEl.currentTime=0,this.videoEl.removeAttribute("src"),this.videoEl.load()}catch{}}}getElement(){return this.element}destroy(){this.close(),this.element.remove()}}const Nt="vr:open-modal",Ct="vr:close-modal";function zs(s){window.dispatchEvent(new CustomEvent(Nt,{detail:s}))}function _e(){window.dispatchEvent(new CustomEvent(Ct))}class ls{constructor(e){r(this,"rootEl");r(this,"current",null);r(this,"handleKeyDownBound");this.rootEl=e,this.handleKeyDownBound=t=>this.handleKeyDown(t),window.addEventListener(Nt,t=>{const i=t;this.handleOpen(i.detail)}),window.addEventListener(Ct,()=>this.close()),window.addEventListener("keydown",this.handleKeyDownBound)}handleKeyDown(e){e.key==="Escape"&&this.close()}handleOpen(e){this.close();let t=null;e.type==="image"?t=new os({src:e.payload.src,title:e.payload.title,onClose:()=>_e()}):e.type==="info"?t=new as({title:e.payload.title,text:e.payload.text,onClose:()=>_e()}):e.type==="video"&&(t=new rs({src:e.payload.src,poster:e.payload.poster,title:e.payload.title,onClose:()=>_e()})),t&&(this.current=t,this.rootEl.innerHTML="",this.rootEl.appendChild(t.getElement()),t.open())}close(){this.current&&(this.current.close(),this.current.destroy(),this.current=null,this.rootEl.innerHTML="")}}let ct=null;function Pt(){if(ct)return;let s=document.getElementById("vr-modal-root");s||(s=document.createElement("div"),s.id="vr-modal-root",document.body.appendChild(s)),ct=new ls(s)}class cs{constructor(e={}){r(this,"root");r(this,"backdrop");r(this,"card");r(this,"closeBtn");r(this,"isOpen",!1);r(this,"onCloseCallback");r(this,"escapeHandler");this.onCloseCallback=e.onClose,this.root=document.createElement("div"),this.root.className="vr-teammodal",this.backdrop=document.createElement("div"),this.backdrop.className="vr-teammodal-backdrop",this.backdrop.addEventListener("click",()=>this.close()),this.root.appendChild(this.backdrop),this.card=document.createElement("div"),this.card.className="vr-teammodal-card",this.closeBtn=document.createElement("button"),this.closeBtn.className="vr-teammodal-close",this.closeBtn.innerHTML="×",this.closeBtn.setAttribute("aria-label","关闭"),this.closeBtn.addEventListener("click",()=>this.close()),this.closeBtn.addEventListener("touchstart",v=>{v.stopPropagation(),this.close()});const t=document.createElement("div");t.className="vr-teammodal-title",t.textContent="鼎虎清源";const i=document.createElement("div");i.className="vr-teammodal-subtitle",i.textContent="VR 研学项目";const n=document.createElement("div");n.className="vr-teammodal-content";const o=document.createElement("p");o.className="vr-teammodal-text",o.textContent="致力于打造沉浸式虚拟现实研学体验，让学习更生动、更直观。";const a=document.createElement("p");a.className="vr-teammodal-text",a.textContent="通过 360° 全景技术，为师生提供身临其境的探索之旅。";const c=document.createElement("p");c.className="vr-teammodal-text",c.textContent="融合创新科技与教育理念，开启数字化学习新篇章。";const l=document.createElement("div");l.className="vr-teammodal-support";const h=document.createElement("div");h.textContent="技术支持：kyu",l.appendChild(h);const u=document.createElement("div");u.className="copyable",u.setAttribute("data-copy","onekyu"),u.textContent="微信：onekyu(点此复制)",u.style.cursor="pointer",u.addEventListener("click",async()=>{const v=u.getAttribute("data-copy");v&&await ns(v)&&(Z("微信号已复制"),P&&console.debug("[TeamIntroModal] 微信号已复制:",v))}),l.appendChild(u);const d=document.createElement("div");d.className="vr-teammodal-footer",d.textContent="© 2025 鼎虎清源",n.appendChild(o),n.appendChild(a),n.appendChild(c),n.appendChild(l);const m=document.createElement("div");m.className="vr-teammodal-header",m.appendChild(t),m.appendChild(this.closeBtn),this.card.appendChild(m),this.card.appendChild(i),this.card.appendChild(n),this.card.appendChild(d),this.root.appendChild(this.card),this.escapeHandler=v=>{v.key==="Escape"&&this.isOpen&&this.close()},window.addEventListener("keydown",this.escapeHandler)}getModalRoot(){let e=document.getElementById("vr-modal-root");if(!e&&(Pt(),e=document.getElementById("vr-modal-root"),!e))throw new Error("vr-modal-root missing, please call ensureModalHost() first");return e}mount(e){this.root.parentNode!==e&&(this.root.parentNode&&this.root.parentNode.removeChild(this.root),e.appendChild(this.root))}open(){if(P&&console.debug("[TeamIntroModal] open called",new Error().stack),this.isOpen)return;const e=this.getModalRoot();this.root.parentNode!==e&&(this.root.parentNode&&this.root.parentNode.removeChild(this.root),e.appendChild(this.root)),this.isOpen=!0,requestAnimationFrame(()=>{this.root.classList.add("open")})}close(){this.isOpen&&(this.isOpen=!1,this.root.classList.remove("open"),this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.onCloseCallback&&this.onCloseCallback())}dispose(){this.escapeHandler&&window.removeEventListener("keydown",this.escapeHandler),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}getElement(){return this.root}}class hs{constructor(e={}){r(this,"element");r(this,"teamIntroModal");this.teamIntroModal=new cs({}),this.element=document.createElement("div"),this.element.className="vr-brandmark",this.element.textContent=e.brandText||"鼎虎清源"}getElement(){return this.element}getAboutModal(){return this.teamIntroModal}remove(){this.element.remove(),this.teamIntroModal.dispose()}}const ds={iterations:300,width:1e3,height:1e3,padding:40,repulsion:.15,spring:.12,damping:.88};function us(s,e,t){const i={...ds,...t},n=s.length;if(n===0)return{};const o={},a=Math.max(1,Math.sqrt(n)*.5);s.forEach((h,u)=>{const d=2*Math.PI*u/n,m=(Math.random()-.5)*.2;o[h.id]={x:a*Math.cos(d)+m,y:a*Math.sin(d)+m,vx:0,vy:0}});const c=e.length>0?e:s.length>1?s.slice(0,-1).map((h,u)=>({from:h.id,to:s[u+1].id})):[];for(let h=0;h<i.iterations;h++){for(let u=0;u<n;u++){const d=s[u],m=o[d.id];for(let v=u+1;v<n;v++){const w=s[v],y=o[w.id];let g=m.x-y.x,p=m.y-y.y;const b=g*g+p*p||1e-4,I=i.repulsion/b;g*=I,p*=I,m.vx+=g,m.vy+=p,y.vx-=g,y.vy-=p}}for(const u of c){const d=o[u.from],m=o[u.to];if(!d||!m)continue;const v=m.x-d.x,w=m.y-d.y,y=Math.sqrt(v*v+w*w)||1e-4,p=i.spring*(y-1),b=v/y*p,I=w/y*p;d.vx+=b,d.vy+=I,m.vx-=b,m.vy-=I}for(const u in o){const d=o[u];d.vx*=i.damping,d.vy*=i.damping,d.x+=d.vx*.1,d.y+=d.vy*.1}}const l={};for(const h in o)l[h]={x:o[h].x,y:o[h].y};return ms(l,i.width,i.height,i.padding)}function ms(s,e,t,i){const n=Object.entries(s);if(n.length===0)return{};let o=1/0,a=-1/0,c=1/0,l=-1/0;for(const[,p]of n)o=Math.min(o,p.x),a=Math.max(a,p.x),c=Math.min(c,p.y),l=Math.max(l,p.y);const h=a-o||1,u=l-c||1,d=e-2*i,m=t-2*i,v=d/h,w=m/u,y=Math.min(v,w),g={};for(const[p,b]of n)g[p]={x:i+(b.x-o)*y+(d-h*y)/2,y:i+(b.y-c)*y+(m-u*y)/2};return g}function ps(s){const e=s.filter(d=>d.mapPoint);if(e.length<s.length)return!0;if(e.length<2)return!1;const t=e.map(d=>d.mapPoint.x),i=e.map(d=>d.mapPoint.y),n=Math.min(...t),o=Math.max(...t),a=Math.min(...i),c=Math.max(...i),l=o-n,h=c-a,u=100;return l<u||h<u}class fs{constructor(e){r(this,"element");r(this,"canvasContainer");r(this,"svg");r(this,"floorplanImg",null);r(this,"statusEl",null);r(this,"toggleBtn",null);r(this,"museum");r(this,"graph");r(this,"currentSceneId");r(this,"onClose");r(this,"onNodeClick");r(this,"layout",{});r(this,"mode","graph");r(this,"hasFloorplan",!1);var t;this.museum=e.museum,this.graph=e.graph,this.currentSceneId=e.currentSceneId,this.onClose=e.onClose,this.onNodeClick=e.onNodeClick,this.hasFloorplan=!!((t=this.museum.map)!=null&&t.image),this.mode=this.hasFloorplan?"floorplan":"graph",this.element=document.createElement("div"),this.element.className="vr-structure2d-overlay",this.render(),this.bindEvents()}render(){var o;const e=document.createElement("div");e.className="vr-structure2d-header";const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="4px";const i=document.createElement("div");i.className="vr-structure2d-title",i.textContent="结构图",this.statusEl=document.createElement("div"),this.statusEl.className="vr-structure2d-status",this.updateStatusText(),t.appendChild(i),t.appendChild(this.statusEl),this.hasFloorplan&&(this.toggleBtn=document.createElement("button"),this.toggleBtn.className="vr-btn vr-structure2d-toggle",this.toggleBtn.textContent=this.mode==="floorplan"?"结构图":"平面图",this.toggleBtn.addEventListener("click",()=>{this.mode=this.mode==="floorplan"?"graph":"floorplan",this.toggleBtn.textContent=this.mode==="floorplan"?"结构图":"平面图",this.updateStatusText(),this.renderContent()}),e.appendChild(this.toggleBtn));const n=document.createElement("button");if(n.className="vr-btn vr-structure2d-close",n.innerHTML="✕",n.setAttribute("aria-label","关闭"),n.addEventListener("click",()=>{this.close()}),e.appendChild(t),e.appendChild(n),this.canvasContainer=document.createElement("div"),this.canvasContainer.className="vr-structure2d-canvas",this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%"),this.svg.setAttribute("class","vr-structure2d-svg"),this.canvasContainer.appendChild(this.svg),this.hasFloorplan&&((o=this.museum.map)!=null&&o.image)){const a=G(this.museum.map.image,Y.MAP);a&&(this.floorplanImg=document.createElement("img"),this.floorplanImg.className="vr-structure2d-floorplan",this.floorplanImg.src=a,this.floorplanImg.style.display="none",this.canvasContainer.appendChild(this.floorplanImg),this.floorplanImg.onload=()=>{this.mode==="floorplan"&&this.renderContent()})}this.element.appendChild(e),this.element.appendChild(this.canvasContainer),this.computeLayout(),this.renderContent()}updateStatusText(){if(!this.statusEl)return;const e=this.graph.nodes.length;this.statusEl.textContent=`mode: ${this.mode}, nodes: ${e}`}renderContent(){this.mode==="floorplan"?this.renderFloorplan():this.renderGraph()}computeLayout(){var n,o;const e=((n=this.museum.map)==null?void 0:n.width)||1e3,t=((o=this.museum.map)==null?void 0:o.height)||600;if(ps(this.graph.nodes))this.layout=us(this.graph.nodes,this.graph.edges,{width:e,height:t,iterations:300,padding:40});else{this.layout={};for(const a of this.graph.nodes)a.mapPoint&&(this.layout[a.id]={x:a.mapPoint.x,y:a.mapPoint.y})}}renderFloorplan(){var n,o;this.svg&&(this.svg.style.display="none"),this.floorplanImg&&(this.floorplanImg.style.display="block"),this.svg.innerHTML="",this.svg.style.display="block",this.svg.style.position="absolute",this.svg.style.top="0",this.svg.style.left="0",this.svg.style.pointerEvents="none";const e=((n=this.museum.map)==null?void 0:n.width)||1e3,t=((o=this.museum.map)==null?void 0:o.height)||600;this.svg.setAttribute("viewBox",`0 0 ${e} ${t}`),this.svg.style.pointerEvents="auto";const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttribute("class","vr-structure2d-nodes");for(const a of this.graph.nodes){const c=this.layout[a.id];if(!c)continue;const l=a.id===this.currentSceneId,h=document.createElementNS("http://www.w3.org/2000/svg","g");h.setAttribute("class",`vr-structure2d-node ${l?"is-current":""}`),h.setAttribute("data-scene-id",a.id),h.style.cursor="pointer";const u=document.createElementNS("http://www.w3.org/2000/svg","circle");u.setAttribute("cx",c.x.toString()),u.setAttribute("cy",c.y.toString()),u.setAttribute("r",l?"12":"8"),u.setAttribute("class","vr-structure2d-node-circle");const d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",c.x.toString()),d.setAttribute("y",(c.y+(l?25:20)).toString()),d.setAttribute("class","vr-structure2d-node-label"),d.setAttribute("text-anchor","middle"),d.textContent=a.name,h.appendChild(u),h.appendChild(d),i.appendChild(h),h.addEventListener("click",()=>{this.onNodeClick&&this.onNodeClick(this.museum.id,a.id)})}this.svg.appendChild(i)}renderGraph(){var o,a;this.floorplanImg&&(this.floorplanImg.style.display="none"),this.svg&&(this.svg.style.display="block",this.svg.style.position="",this.svg.style.pointerEvents="auto"),this.svg.innerHTML="";const e=((o=this.museum.map)==null?void 0:o.width)||1e3,t=((a=this.museum.map)==null?void 0:a.height)||600;this.svg.setAttribute("viewBox",`0 0 ${e} ${t}`);const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttribute("class","vr-structure2d-edges");for(const c of this.graph.edges){const l=this.layout[c.from],h=this.layout[c.to];if(!l||!h)continue;const u=document.createElementNS("http://www.w3.org/2000/svg","line");u.setAttribute("x1",l.x.toString()),u.setAttribute("y1",l.y.toString()),u.setAttribute("x2",h.x.toString()),u.setAttribute("y2",h.y.toString()),u.setAttribute("class","vr-structure2d-edge"),i.appendChild(u)}this.svg.appendChild(i);const n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("class","vr-structure2d-nodes");for(const c of this.graph.nodes){const l=this.layout[c.id];if(!l)continue;const h=c.id===this.currentSceneId,u=document.createElementNS("http://www.w3.org/2000/svg","g");u.setAttribute("class",`vr-structure2d-node ${h?"is-current":""}`),u.setAttribute("data-scene-id",c.id),u.style.cursor="pointer";const d=document.createElementNS("http://www.w3.org/2000/svg","circle");d.setAttribute("cx",l.x.toString()),d.setAttribute("cy",l.y.toString()),d.setAttribute("r",h?"12":"8"),d.setAttribute("class","vr-structure2d-node-circle");const m=document.createElementNS("http://www.w3.org/2000/svg","text");m.setAttribute("x",l.x.toString()),m.setAttribute("y",(l.y+(h?25:20)).toString()),m.setAttribute("class","vr-structure2d-node-label"),m.setAttribute("text-anchor","middle"),m.textContent=c.name,u.appendChild(d),u.appendChild(m),n.appendChild(u),u.addEventListener("click",()=>{this.onNodeClick&&this.onNodeClick(this.museum.id,c.id)})}this.svg.appendChild(n)}bindEvents(){const e=t=>{t.key==="Escape"&&this.close()};document.addEventListener("keydown",e),this.element.addEventListener("vr:cleanup",()=>{document.removeEventListener("keydown",e)})}updateContext(e){var t;this.museum=e.museum,this.graph=e.graph,this.currentSceneId=e.currentSceneId,this.hasFloorplan=!!((t=this.museum.map)!=null&&t.image),this.computeLayout(),this.updateStatusText(),this.renderContent()}open(){this.element.classList.add("is-visible")}close(){this.element.classList.remove("is-visible"),this.onClose&&this.onClose()}getElement(){return this.element}remove(){this.element.remove()}}function ht(s,e){var o;const t=s.scenes.map(a=>({id:a.id,name:a.name,scene:a,mapPoint:a.mapPoint,initialView:a.initialView})),i=new Set(t.map(a=>a.id)),n=[];for(const a of s.scenes)for(const c of a.hotspots){if(c.type!=="scene"||!((o=c.target)!=null&&o.sceneId))continue;const l=c.target.museumId??s.id,h=c.target.sceneId;l!==s.id||!i.has(h)||n.some(d=>d.from===a.id&&d.to===h)||n.push({from:a.id,to:h})}return{nodes:t,edges:n,currentNodeId:e&&i.has(e)?e:void 0}}function Ws(s,e){let t=0;for(const i of s.edges)(i.from===e||i.to===e)&&t++;return t}function gs(s,e,t){const i=s.getBoundingClientRect(),n=e-i.left,o=t-i.top,a=document.createElement("div");a.className="vr-pick-marker",a.style.position="absolute",a.style.left="0",a.style.top="0",a.style.transform=`translate3d(${n}px, ${o}px, 0)`,a.style.pointerEvents="none",a.style.zIndex="1000",s.style.position="relative",s.appendChild(a),window.requestAnimationFrame(()=>{a.classList.add("show")}),window.setTimeout(()=>{a.classList.remove("show"),window.setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},200)},1500)}const xt="vr_last_pick_v1";let We=null;function vs(){try{const s=localStorage.getItem(xt);if(s){const e=JSON.parse(s);typeof e.yaw=="number"&&typeof e.pitch=="number"&&typeof e.ts=="number"&&(We=e)}}catch{}}vs();function ws(s){We=s;try{localStorage.setItem(xt,JSON.stringify(s))}catch{}}function qs(){return We}const ys=150,bs=150,Is=400;function Es(){return{fadeMs:ys,restoreMs:bs,restoreDelayMs:Is}}function Ss(){C.on("user-interacting",()=>{}),C.on("user-idle",()=>{}),C.on("ui-engaged",()=>{})}let V=null;function Ms(){const s=Es();C.on("user-interacting",()=>{V!==null&&(clearTimeout(V),V=null),document.documentElement.classList.add("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")}),C.on("user-idle",()=>{V!==null&&(clearTimeout(V),V=null),document.documentElement.classList.remove("vr-ui-interacting"),V=window.setTimeout(()=>{document.documentElement.classList.remove("vr-ui-restoring"),V=null},s.restoreDelayMs)}),C.on("ui-engaged",()=>{V!==null&&(clearTimeout(V),V=null),document.documentElement.classList.remove("vr-ui-interacting"),document.documentElement.classList.remove("vr-ui-restoring")})}function Ts(){const s={};try{const e=new URLSearchParams(window.location.search),t=e.get("museum"),i=e.get("scene");t&&(s.museumId=t),i&&(s.currentSceneId=i)}catch{}try{const e=document.querySelector(".vr-groundnav");if(e){s.groundNavDots={};const t=e.querySelector(".vr-groundnav__dot.is-aimed");t&&(s.groundNavDots.aimedSceneId=t.getAttribute("data-scene-id")||void 0);const i=e.querySelector(".vr-groundnav__dot.is-autonav");if(i){s.groundNavDots.isAutoNavActive=!0,s.groundNavDots.autoNavTargetSceneId=i.getAttribute("data-scene-id")||void 0;const n=i.querySelector(".vr-groundnav__progress");s.groundNavDots.hasProgressElement=!!n}}}catch{}try{const e=document.querySelector(".vr-previewcard");if(e){s.scenePreviewCard={},s.scenePreviewCard.isVisible=e.classList.contains("is-visible");const t=e.querySelector(".vr-previewcard__hint");t&&(s.scenePreviewCard.hintVisible=t.classList.contains("is-visible"),s.scenePreviewCard.hintEmphasizing=t.classList.contains("is-emphasizing"))}}catch{}try{const e=document.querySelector(".vr-scenestrip");e&&(s.sceneStrip={},s.sceneStrip.userScrolling=e.classList.contains("is-user-scrolling"))}catch{}try{const e=document.documentElement,t=Array.from(e.classList).filter(i=>i==="vr-ui-interacting"||i==="vr-ui-restoring");t.length>0&&(s.yieldClassManager={classes:t})}catch{}return s}function Ls(s){try{window.dispatchEvent(new CustomEvent("vr:close-panels"))}catch{}try{s?(s.emitInteracting(),setTimeout(()=>{try{document.documentElement.classList.remove("vr-ui-interacting","vr-ui-restoring")}catch{}},100)):document.documentElement.classList.remove("vr-ui-interacting","vr-ui-restoring")}catch{}}let J=!1,he=null,be=null,Ie=null,Ee=!1,ie=0,q=0,Se=!0;const Ns=new me(0,0,1),dt=new Xt,Cs=new $e,Ps=new $e(-Math.sqrt(.5),0,0,Math.sqrt(.5)),we=new $e,xs=new me(0,0,-1),_s=new me(0,1,0);let Le=null;function As(){const s=screen.orientation,e=s&&typeof s.angle=="number"?s.angle:typeof window.orientation=="number"?window.orientation:0;return x.degToRad(e||0)}function ks(s,e,t){const i=x.degToRad(s||0),n=x.degToRad(e||0),o=x.degToRad(t||0),a=As();return dt.set(n,i,-o,"YXZ"),we.setFromEuler(dt),we.multiply(Ps),we.multiply(Cs.setFromAxisAngle(Ns,-a)),we.clone()}function Ae(s){for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;return s}function Ds(s,e,t){s=Ae(s),e=Ae(e);let i=e-s;return i>Math.PI&&(i-=2*Math.PI),i<-Math.PI&&(i+=2*Math.PI),Ae(s+i*t)}function Rs(){return/iPhone|iPad|iPod/i.test(navigator.userAgent)}async function Vs(){if(!Rs())return!0;if(typeof DeviceOrientationEvent.requestPermission=="function")try{return await DeviceOrientationEvent.requestPermission()==="granted"}catch(s){return console.warn("[VRMode] iOS permission request failed:",s),!1}return!0}function Os(s){Le=s}async function Hs(s){var t;if(J)return!0;if(!await Vs())return Z("未获得陀螺仪权限，无法进入VR模式"),!1;Ee=!1,Ie=null,ie=0,q=0,Se=!0,be=s;try{(t=screen.orientation)!=null&&t.lock&&await screen.orientation.lock("landscape")}catch{}return he=i=>{if(!J||!be||i.alpha===null||i.beta===null||i.gamma===null)return;const n=ks(i.alpha,i.beta,i.gamma);if(!Ee){Ie=n.clone(),Ee=!0;return}if(Le&&Le())return;const o=Ie.clone().invert(),a=n.clone().multiply(o),c=xs.clone().applyQuaternion(a),l=_s.clone().applyQuaternion(a);let h=Math.atan2(c.x,-c.z);h=-h;let u=Math.atan2(l.z,l.y);u=-u;const d=x.degToRad(85);u=Math.max(-d,Math.min(d,u)),Se?(ie=h,q=u,Se=!1):(ie=Ds(ie,h,.15),q=q+(u-q)*.2);const m=x.radToDeg(ie),v=x.radToDeg(q);be(m,v)},window.addEventListener("deviceorientation",he),J=!0,!0}function _t(){var s;if(J){he&&(window.removeEventListener("deviceorientation",he),he=null),be=null,J=!1,Ee=!1,Ie=null,ie=0,q=0,Se=!0,Le=null;try{(s=screen.orientation)!=null&&s.unlock&&screen.orientation.unlock()}catch{}}}function ye(){return J}function Us(){const s=()=>{!ue()&&J&&_t()};document.addEventListener("fullscreenchange",s),document.addEventListener("webkitfullscreenchange",s)}function Ys(){var s;return!!(document.querySelector(".vr-modal-overlay")||document.querySelector(".vr-guide-drawer.open")||document.querySelector(".fcchat-root")&&((s=document.querySelector(".fcchat-root"))==null?void 0:s.style.display)==="flex")}function ut(){Ys()?document.documentElement.classList.add("vr-overlay-open"):document.documentElement.classList.remove("vr-overlay-open")}function mt(s){const{title:e,contentEl:t,contentHtml:i,onClose:n,panelClassName:o}=s,a=document.createElement("div");a.className="vr-modal-overlay";const c=document.createElement("div");c.className="vr-modal-panel",o&&c.classList.add(o);const l=document.createElement("div");l.className="vr-modal-header";const h=document.createElement("div");h.className="vr-modal-header-title",h.textContent=e;const u=document.createElement("button");u.className="vr-modal-header-close vr-icon-btn",u.type="button",u.setAttribute("aria-label","关闭弹窗"),u.innerHTML="×",l.appendChild(h),l.appendChild(u);const d=document.createElement("div");d.className="vr-modal-body",t?d.appendChild(t):i&&(d.innerHTML=i),c.appendChild(l),c.appendChild(d),a.appendChild(c),document.body.appendChild(a),ut(),o==="vr-modal-settings"&&(document.documentElement.classList.add("vr-more-open"),requestAnimationFrame(()=>{c.classList.add("is-in")}));let m=!1;const v=p=>{p.key==="Escape"&&(p.stopPropagation(),g.close())},w=p=>{p.target===a&&g.close()},y=p=>{p.preventDefault(),p.stopPropagation(),g.close()};window.addEventListener("keydown",v),a.addEventListener("click",w),u.addEventListener("click",y);const g={close:()=>{if(!m&&(m=!0,window.removeEventListener("keydown",v),a.removeEventListener("click",w),u.removeEventListener("click",y),a.parentNode&&a.parentNode.removeChild(a),o==="vr-modal-settings"&&document.documentElement.classList.remove("vr-more-open"),ut(),n))try{n()}catch{}}};return g}P&&(window.__vrDump=()=>{const s=Ts();return console.debug("[VR State Snapshot]",s),s},window.__vrResetUI=()=>{console.debug("[VR Reset UI] 姝ｅ湪娓呯悊鎵€鏈?UI 鐘舵€?.."),Ls(C),console.debug("[VR Reset UI] 娓呯悊瀹屾垚")},console.debug("[VR Debug] 璋冭瘯妯″紡宸插惎鐢ㄣ€備娇鐢?__vrDump() 鏌ョ湅鐘舵€侊紝浣跨敤 __vrResetUI() 澶嶄綅 UI"));ei();Ss();Ms();yi();Us();const At=()=>{const s=document;!!(document.fullscreenElement||s.webkitFullscreenElement)&&Ui()};document.addEventListener("fullscreenchange",At);document.addEventListener("webkitfullscreenchange",At);function $s(){const s=new URLSearchParams(location.search);return s.has("development")||s.get("dev")==="1"||location.hash.includes("development")}class Fs{constructor(){r(this,"appElement");r(this,"config",null);r(this,"panoViewer",null);r(this,"titleBar",null);r(this,"topRightControls",null);r(this,"topModeTabs",null);r(this,"sceneTitleEl",null);r(this,"brandMark",null);r(this,"bottomDock",null);r(this,"sceneGuideDrawer",null);r(this,"guideTray",null);r(this,"museumList",null);r(this,"sceneList",null);r(this,"mapOverlay",null);r(this,"hotspots",null);r(this,"videoPlayer",null);r(this,"controlBar",null);r(this,"loading");r(this,"debugPanel",null);r(this,"configStudio",null);r(this,"qualityIndicator",null);r(this,"northCalibrationPanel",null);r(this,"currentMuseum",null);r(this,"currentScene",null);r(this,"hasBoundFullscreenEvents",!1);r(this,"mode","tour");r(this,"isStructureOverlayOpen",!1);r(this,"structureView2D",null);r(this,"structureView3D",null);r(this,"fcChatPanel",null);r(this,"infoModalMounted",null);r(this,"settingsModalMounted",null);r(this,"handlePopState",null);r(this,"handlePickEvent",null);r(this,"handlePickModeEvent",null);r(this,"handleMetricsEvent",null);r(this,"debugPanelRafId",null);r(this,"structure3DLoadToken",0);r(this,"chatInitToken",0);r(this,"chatFirstInteractionHandler",null);r(this,"uiErrorElement",null);const e=document.getElementById("app");if(!e)throw new Error("鎵句笉鍒?#app 鍏冪礌");this.appElement=e,Pt(),this.loading=new Xi,this.appElement.appendChild(this.loading.getElement()),this.bindFullscreenEventsOnce(),this.init()}bindFullscreenEventsOnce(){if(this.hasBoundFullscreenEvents)return;this.hasBoundFullscreenEvents=!0;const e=()=>{var t;(t=this.topRightControls)==null||t.syncFullscreenState(),Te()||(this.topRightControls&&!ye()&&this.topRightControls.updateVrModeState(!1),this.panoViewer&&this.panoViewer.isVrModeEnabled()&&this.panoViewer.setVrModeEnabled(!1),Lt())};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e)}async init(){try{if(this.loading.show(),ni()){await this.initEditorMode(),this.loading.hide();return}this.config=await Qe(),Ne(this.config.assetCdn),this.titleBar&&this.titleBar.setTitle(this.config.appName),this.handlePopState||(this.handlePopState=()=>{this.handleRoute()},window.addEventListener("popstate",this.handlePopState)),await this.handleRoute(),this.loading.hide()}catch(e){console.error("閰嶇疆鍔犺浇澶辫触:",e),this.loading.hide(),e.validationErrors&&Array.isArray(e.validationErrors)?this.showConfigErrorPanel(e.validationErrors):this.showError("鍔犺浇閰嶇疆澶辫触锛岃鍒锋柊椤甸潰閲嶈瘯")}}async initEditorMode(){try{this.config=await Qe(),Ne(this.config.assetCdn),this.appElement.innerHTML="";const{ConfigStudio:e}=await D(async()=>{const{ConfigStudio:t}=await import("./editor-debug-_leEjMgs.js").then(i=>i.C);return{ConfigStudio:t}},__vite__mapDeps([3,4]),import.meta.url);this.configStudio=new e(this.config,t=>{this.config=t,Ne(t.assetCdn),Ke()}),this.appElement.appendChild(this.configStudio.getElement())}catch(e){console.error("鍒濆鍖栫紪杈戝櫒妯″紡澶辫触:",e),e.validationErrors&&Array.isArray(e.validationErrors)?this.showConfigErrorPanel(e.validationErrors):this.showError("鍔犺浇閰嶇疆澶辫触锛岃鍒锋柊椤甸潰閲嶈瘯")}}showConfigErrorPanel(e){this.appElement.innerHTML="";const t=new Ki(e,()=>{Ke(),window.location.reload()},()=>{this.showConfigExample()});this.appElement.appendChild(t.getElement())}showConfigExample(){const e=window.open("","_blank");e&&e.document.write(`
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>config.json 绀轰緥</title>
          <style>
            body {
              font-family: 'Courier New', monospace;
              padding: 20px;
              background: #1a1a1a;
              color: #fff;
            }
            pre {
              background: #0f0f0f;
              padding: 20px;
              border-radius: 8px;
              overflow-x: auto;
            }
            code {
              color: #4a90e2;
            }
          </style>
        </head>
        <body>
          <h1>config.json 绀轰緥閰嶇疆</h1>
          <pre><code>{
  "appName": "搴旂敤鍚嶇О",
  "museums": [
    {
      "id": "museum_id",
      "name": "灞曢鍚嶇О",
      "cover": "https://example.com/cover.jpg",
      "map": {
        "image": "https://example.com/map.jpg",
        "width": 1000,
        "height": 600
      },
      "scenes": [
        {
          "id": "scene_id",
          "name": "鍦烘櫙鍚嶇О",
          "panoLow": "https://example.com/pano-low.jpg",
          "pano": "https://example.com/pano.jpg",
          "thumb": "https://example.com/thumb.jpg",
          "initialView": {
            "yaw": 0,
            "pitch": 0,
            "fov": 75
          },
          "mapPoint": {
            "x": 420,
            "y": 310
          },
          "hotspots": [
            {
              "id": "hotspot_id",
              "type": "scene",
              "label": "鐑偣鏍囩",
              "yaw": 35,
              "pitch": -5,
              "target": {
                "museumId": "museum_id",
                "sceneId": "target_scene_id",
                "yaw": 120,
                "pitch": 0
              }
            }
          ]
        }
      ]
    }
  ]
}</code></pre>
          <p>璇︾粏閰嶇疆璇存槑璇锋煡鐪?README.md</p>
        </body>
        </html>
      `)}async handleRoute(){if(!this.config)return;const e=et();if(this.clearView(),!e.museumId){const t=this.config.museums.find(i=>i.id==="wangding")||this.config.museums[0];if(t){if(t.scenes&&t.scenes.length>0){W(t.id,t.scenes[0].id);return}Re(t.id);return}}if(!e.museumId)this.showMuseumList();else if(e.sceneId){const t=De(e.museumId),i=Jt(e.museumId,e.sceneId);t&&i?await this.showScene(t,i):(this.showError("鏈壘鍒版寚瀹氱殑鍦烘櫙"),t?Re(t.id):tt())}else{const t=De(e.museumId);t?this.showSceneList(t):(this.showError("鏈壘鍒版寚瀹氱殑灞曢"),tt())}}showMuseumList(){this.config&&(this.titleBar=new lt(this.config.appName),this.appElement.appendChild(this.titleBar.getElement()),this.museumList=new qi(this.config.museums),this.appElement.appendChild(this.museumList.getElement()))}showSceneList(e){this.titleBar=new lt(e.name),this.appElement.appendChild(this.titleBar.getElement());const t=document.createElement("div");t.className="scene-list-page",t.innerHTML=`
      <div class="scene-list-container">
        <h1 class="scene-list-title">${e.name} - 鍦烘櫙鍒楄〃</h1>
        ${e.description?`<p class="scene-list-desc">${e.description}</p>`:""}
        <div class="scene-grid">
          ${e.scenes.map(n=>`
            <div class="scene-card" data-scene-id="${n.id}">
              <div class="scene-cover">
                <img src="${n.thumb}" alt="${n.name}" loading="lazy">
                <div class="scene-overlay">
                  <h2 class="scene-name">${n.name}</h2>
                </div>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `;const i=document.createElement("style");i.textContent=`
      .scene-list-page {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding-top: calc(44px + env(safe-area-inset-top, 0px));
      }
      .scene-list-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .scene-list-title {
        font-size: 24px;
        font-weight: 600;
        color: #fff;
        text-align: center;
        margin-bottom: 30px;
      }
      .scene-list-desc {
        max-width: 820px;
        margin: -12px auto 26px;
        color: rgba(255,255,255,0.92);
        font-size: 15px;
        line-height: 1.6;
        text-align: center;
      }
      .scene-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }
      .scene-card {
        cursor: pointer;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
      }
      .scene-card:active {
        transform: scale(0.98);
      }
      .scene-cover {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
        overflow: hidden;
      }
      .scene-cover img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .scene-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        padding: 15px;
        color: #fff;
      }
      .scene-name {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }
    `,document.head.appendChild(i),t.querySelectorAll(".scene-card").forEach(n=>{n.addEventListener("click",()=>{const o=n.getAttribute("data-scene-id");o&&W(e.id,o)})}),this.appElement.appendChild(t)}async showScene(e,t){var w,y;this.currentMuseum=e,this.currentScene=t,this.loading.show();const i=document.createElement("div");i.className="viewer-container",i.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    `,this.appElement.appendChild(i);const n=si();this.panoViewer=new Wi(i,n);const o=$s();try{this.topRightControls=new ss({viewerRootEl:i,onTogglePickMode:o?()=>this.panoViewer?(this.panoViewer.isPickModeEnabled()?this.panoViewer.disablePickMode():this.panoViewer.enablePickMode(),this.panoViewer.isPickModeEnabled()):!1:void 0,onOpenNorthCalibration:o?()=>{this.openNorthCalibration(t.id)}:void 0,showNorthCalibration:o,onToggleVrMode:async()=>this.toggleVrModeFromUI(i)}),this.appElement.appendChild(this.topRightControls.getElement())}catch(g){P&&console.debug("[showScene] TopRightControls 鍒涘缓澶辫触锛岃烦杩?",g),this.topRightControls=null}this.sceneTitleEl=document.createElement("div"),this.sceneTitleEl.className="vr-scenetitle",this.sceneTitleEl.textContent=t.name||((w=this.config)==null?void 0:w.appName)||"VR Player",this.appElement.appendChild(this.sceneTitleEl),this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickEvent=g=>{const p=g,{x:b,y:I,yaw:S,pitch:_}=p.detail;if(ws({yaw:S,pitch:_,ts:Date.now()}),Z(`宸插鍒?yaw: ${S.toFixed(2)}, pitch: ${_.toFixed(2)}`),this.panoViewer){const A=this.panoViewer.getDomElement();gs(A,b,I)}},window.addEventListener("vr:pick",this.handlePickEvent),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.handlePickModeEvent=g=>{const p=g;this.panoViewer&&!p.detail.enabled&&this.panoViewer.isPickModeEnabled()&&this.panoViewer.disablePickMode()},window.addEventListener("vr:pickmode",this.handlePickModeEvent);try{if(this.appElement.querySelector(".vr-brandmark"))P&&console.debug("[showScene] BrandMark 宸插瓨鍦紝璺宠繃閲嶅鍒涘缓");else{this.brandMark=new hs({appName:(y=this.config)==null?void 0:y.appName,brandText:"榧庤檸娓呮簮"});const p=this.brandMark.getElement();p.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),this.openDingHuQingYuan()}),this.appElement.appendChild(p)}}catch(g){P&&console.debug("[showScene] BrandMark 鍒涘缓澶辫触锛岃烦杩?",g),this.brandMark=null}if(n){const{DebugPanel:g}=await D(async()=>{const{DebugPanel:b}=await import("./editor-debug-_leEjMgs.js").then(I=>I.D);return{DebugPanel:b}},__vite__mapDeps([3,4]),import.meta.url);this.debugPanel=new g,this.appElement.appendChild(this.debugPanel.getElement()),this.panoViewer.setOnDebugClick((b,I,S,_,A)=>{this.debugPanel&&this.debugPanel.show(b,I,S,_,A)}),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null);const p=()=>{if(this.debugPanel&&this.panoViewer){const b=this.panoViewer.getCurrentView();this.debugPanel.updateView(b.yaw,b.pitch,b.fov)}this.debugPanelRafId=requestAnimationFrame(p)};p()}let a=!1,c=!1;const l=async()=>{if(!(a||c)&&this.panoViewer&&!(!this.currentScene||this.currentScene.id!==t.id)){c=!0;try{const[{VideoPlayer:g},{GuideTray:p},{SceneGuideDrawer:b},{BottomDock:I},{TopModeTabs:S},{Hotspots:_},{QualityIndicator:A}]=await Promise.all([D(()=>import("./VideoPlayer-CtL_iDts.js"),__vite__mapDeps([5,1]),import.meta.url),D(()=>import("./GuideTray-CLq_IAOO.js"),__vite__mapDeps([6,1]),import.meta.url),D(()=>import("./SceneGuideDrawer-ChkoUG81.js"),__vite__mapDeps([7,8,1]),import.meta.url),D(()=>import("./BottomDock-BigA--sM.js"),__vite__mapDeps([9,8,1]),import.meta.url),D(()=>import("./TopModeTabs-psisWFio.js"),[],import.meta.url),D(()=>import("./Hotspots-BXkkbW0U.js"),__vite__mapDeps([10,1]),import.meta.url),D(()=>Promise.resolve().then(()=>Ii),void 0,import.meta.url)]);if(a||!this.panoViewer||!this.currentScene||this.currentScene.id!==t.id)return;a=!0;try{this.videoPlayer=new g,this.appElement.appendChild(this.videoPlayer.getElement())}catch(T){P&&console.debug("[showScene] VideoPlayer 鍒涘缓澶辫触锛岃烦杩?",T),this.videoPlayer=null}try{this.guideTray=new p({museumId:e.id,currentSceneId:t.id,scenes:e.scenes,onSceneClick:T=>{W(e.id,T)},onMoreClick:()=>{if(!this.sceneGuideDrawer)try{this.sceneGuideDrawer=new b({museumId:e.id,currentSceneId:t.id,scenes:e.scenes,onClose:()=>{}}),this.appElement.appendChild(this.sceneGuideDrawer.getElement())}catch(T){P&&console.debug("[GuideTray] SceneGuideDrawer 鍒涘缓澶辫触:",T)}this.guideTray&&this.guideTray.setVisible(!1),this.sceneGuideDrawer&&this.sceneGuideDrawer.open()},onClose:()=>{this.guideTray&&this.guideTray.setVisible(!1),window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"guide"}}))}}),this.guideTray.setVisible(!1),this.appElement.appendChild(this.guideTray.getElement())}catch(T){P&&console.debug("[showScene] GuideTray 鍒涘缓澶辫触锛岃烦杩?",T),this.guideTray=null}try{this.bottomDock=new I({onGuideClick:()=>{this.guideTray&&this.guideTray.setVisible(!0)},onOpenInfo:()=>this.openInfoModal(),onOpenSettings:()=>this.openSettingsModal(),sceneId:t.id,sceneName:t.name,museum:e,scenes:e.scenes,currentSceneId:t.id}),this.appElement.appendChild(this.bottomDock.getElement())}catch(T){P&&console.debug("[showScene] BottomDock 鍒涘缓澶辫触锛岃烦杩?",T),this.bottomDock=null}try{this.topModeTabs=new S({initialMode:this.mode,onModeChange:T=>{this.setMode(T)}}),this.appElement.appendChild(this.topModeTabs.getElement())}catch(T){P&&console.debug("[showScene] TopModeTabs 鍒涘缓澶辫触锛岃烦杩?",T),this.topModeTabs=null}try{const T=new Map(e.scenes.map(R=>[R.id,R.name]));this.hotspots=new _(this.panoViewer,t.hotspots,{resolveSceneName:R=>T.get(R),onEnterScene:R=>{W(e.id,R)},museumId:e.id}),i.appendChild(this.hotspots.getElement())}catch(T){P&&console.debug("[showScene] Hotspots 鍒涘缓澶辫触锛岃烦杩?",T),this.hotspots=null}try{this.qualityIndicator=new A,this.appElement.appendChild(this.qualityIndicator.getElement()),this.panoViewer&&this.qualityIndicator.updateStatus(this.panoViewer.getLoadStatus())}catch(T){P&&console.debug("[showScene] QualityIndicator 鍒涘缓澶辫触锛岃烦杩?",T),this.qualityIndicator=null}this.handleMetricsEvent&&(window.removeEventListener("vr:metrics",this.handleMetricsEvent),this.handleMetricsEvent=null),this.handleMetricsEvent=T=>{if(!this.qualityIndicator)return;const R=T.detail||{};this.qualityIndicator.updateMetrics(R)},window.addEventListener("vr:metrics",this.handleMetricsEvent)}finally{c=!1}}};this.panoViewer.setOnStatusChange(g=>{this.qualityIndicator&&this.qualityIndicator.updateStatus(g),!a&&(g===E.LOW_READY||g===E.HIGH_READY||g===E.DEGRADED)&&window.setTimeout(()=>{l()},0),(g===E.LOW_READY||g===E.HIGH_READY||g===E.DEGRADED)&&this.loading.hide()}),this.panoViewer.setOnLoad(()=>{l(),this.loading.hide(),this.hideUIError(),this.preloadNextScene(e,t)}),this.panoViewer.setOnError(g=>{console.error("鍔犺浇鍦烘櫙澶辫触:",g),this.loading.hide(),this.showError("加载全景图失败，请检查网络连接"),this.qualityIndicator&&this.qualityIndicator.updateStatus(E.ERROR)});const h=et(),u=h.yaw!==void 0?h.yaw:t.initialView.yaw||0,d=h.pitch!==void 0?h.pitch:t.initialView.pitch||0,m=h.fov!==void 0?h.fov:t.initialView.fov||75,v=-u;this.panoViewer.setView(v,d,m),this.panoViewer.loadScene(t),this.panoViewer.setSceneData(e.id,t.id,t.hotspots),this.setupChatOnFirstInteraction(e,t)}setupChatOnFirstInteraction(e,t){var a;this.chatInitToken+=1,this.clearChatFirstInteractionListeners();const i=(a=this.config)==null?void 0:a.fcChat;if(!(i!=null&&i.endpoint)||!i.endpoint.trim())return;const n=this.chatInitToken,o=()=>{this.clearChatFirstInteractionListeners(),this.initChatPanel(n,i,e,t)};this.chatFirstInteractionHandler=o,window.addEventListener("pointerdown",o,{passive:!0}),window.addEventListener("touchstart",o,{passive:!0}),window.addEventListener("keydown",o)}async initChatPanel(e,t,i,n){if(e===this.chatInitToken&&!(!this.currentScene||this.currentScene.id!==n.id))try{const[{FcChatPanel:o},{FcChatClient:a}]=await Promise.all([D(()=>import("./chat-community-N43F3_Ud.js").then(h=>h.F),__vite__mapDeps([11,12]),import.meta.url),D(()=>import("./chat-community-N43F3_Ud.js").then(h=>h.f),__vite__mapDeps([11,12]),import.meta.url)]);if(e!==this.chatInitToken||!this.currentScene||this.currentScene.id!==n.id)return;const c={endpoint:t.endpoint,authToken:t.authToken,timeoutMs:15e3},l=new a(c);this.fcChatPanel&&(this.fcChatPanel.remove(),this.fcChatPanel=null),this.fcChatPanel=new o(l,{museumId:i.id,sceneId:n.id,sceneTitle:n.name,museumName:i.name,url:window.location.href})}catch(o){P&&console.debug("[showScene] FcChatPanel 鍒涘缓澶辫触锛岃烦杩?",o),this.fcChatPanel=null}}clearChatFirstInteractionListeners(){this.chatFirstInteractionHandler&&(window.removeEventListener("pointerdown",this.chatFirstInteractionHandler),window.removeEventListener("touchstart",this.chatFirstInteractionHandler),window.removeEventListener("keydown",this.chatFirstInteractionHandler),this.chatFirstInteractionHandler=null)}preloadNextScene(e,t){const n=(e.scenes.findIndex(a=>a.id===t.id)+1)%e.scenes.length,o=e.scenes[n];if(o&&o.thumb){const a=G(o.thumb,Y.THUMB);if(a){const c=new Image;c.referrerPolicy="no-referrer",c.crossOrigin="anonymous",c.loading="lazy",c.decoding="async",c.src=ze(a)}}}clearView(){if(this.chatInitToken+=1,this.clearChatFirstInteractionListeners(),this.structure3DLoadToken+=1,this.handlePickEvent&&(window.removeEventListener("vr:pick",this.handlePickEvent),this.handlePickEvent=null),this.handlePickModeEvent&&(window.removeEventListener("vr:pickmode",this.handlePickModeEvent),this.handlePickModeEvent=null),this.handleMetricsEvent&&(window.removeEventListener("vr:metrics",this.handleMetricsEvent),this.handleMetricsEvent=null),this.debugPanelRafId!==null&&(cancelAnimationFrame(this.debugPanelRafId),this.debugPanelRafId=null),this.panoViewer&&(this.panoViewer.dispose(),this.panoViewer=null),this.titleBar&&(this.titleBar.remove(),this.titleBar=null),this.topRightControls&&(this.topRightControls.remove(),this.topRightControls=null),this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),this.topModeTabs&&(this.topModeTabs.getElement().remove(),this.topModeTabs=null),this.sceneTitleEl&&(this.sceneTitleEl.remove(),this.sceneTitleEl=null),this.brandMark&&(this.brandMark.remove(),this.brandMark=null),this.bottomDock&&(this.bottomDock.remove(),this.bottomDock=null),this.guideTray&&(this.guideTray.remove(),this.guideTray=null),this.sceneGuideDrawer&&(this.sceneGuideDrawer.remove(),this.sceneGuideDrawer=null),this.museumList&&(this.museumList.remove(),this.museumList=null),this.sceneList&&(this.sceneList.remove(),this.sceneList=null),this.mapOverlay&&(this.mapOverlay.remove(),this.mapOverlay=null),this.hotspots&&(this.hotspots.remove(),this.hotspots=null),this.videoPlayer&&(this.videoPlayer.remove(),this.videoPlayer=null),this.controlBar&&(this.controlBar.remove(),this.controlBar=null),this.debugPanel&&(this.debugPanel.remove(),this.debugPanel=null),this.configStudio&&(this.configStudio.remove(),this.configStudio=null),this.qualityIndicator&&(this.qualityIndicator.remove(),this.qualityIndicator=null),this.structureView2D){const e=this.structureView2D.getElement();e&&e.parentNode&&e.parentNode.removeChild(e),this.structureView2D=null}if(this.structureView3D){const e=this.structureView3D.getElement();e&&e.parentNode&&e.parentNode.removeChild(e),this.structureView3D=null}this.isStructureOverlayOpen=!1,this.fcChatPanel&&(this.fcChatPanel.remove(),this.fcChatPanel=null),this.mode="tour",this.appElement.innerHTML="",this.appElement.appendChild(this.loading.getElement())}hideUIError(){this.uiErrorElement&&this.uiErrorElement.parentNode&&(this.uiErrorElement.parentNode.removeChild(this.uiErrorElement),this.uiErrorElement=null)}setMode(e){this.mode!==e&&(this.mode,this.mode=e,this.topModeTabs&&this.topModeTabs.setMode(e),e==="tour"&&this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),e==="structure2d"?this.openStructure2D():e==="structure3d"&&this.openStructure3D())}openStructure2D(){if(!this.currentMuseum||!this.currentScene)return;this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1});const e=ht(this.currentMuseum,this.currentScene.id);this.structureView2D?this.structureView2D.updateContext({museum:this.currentMuseum,graph:e,currentSceneId:this.currentScene.id}):(this.structureView2D=new fs({museum:this.currentMuseum,graph:e,currentSceneId:this.currentScene.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(t,i)=>{this.closeStructureOverlay({toTour:!1}),W(t,i)}}),this.appElement.appendChild(this.structureView2D.getElement())),this.isStructureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView2D.open()}async openStructure3D(){if(!this.currentMuseum||!this.currentScene)return;this.isStructureOverlayOpen&&this.closeStructureOverlay({toTour:!1}),this.structure3DLoadToken+=1;const e=this.structure3DLoadToken,t=ht(this.currentMuseum,this.currentScene.id);if(this.structureView3D){if(e!==this.structure3DLoadToken||this.mode!=="structure3d")return;this.structureView3D.updateContext({museum:this.currentMuseum,graph:t,currentSceneId:this.currentScene.id})}else{const{StructureView3D:i}=await D(async()=>{const{StructureView3D:n}=await import("./dock-panels-Ctb3AQYB.js").then(o=>o.S);return{StructureView3D:n}},__vite__mapDeps([13,1]),import.meta.url);if(e!==this.structure3DLoadToken||this.mode!=="structure3d")return;this.structureView3D=new i({museum:this.currentMuseum,graph:t,currentSceneId:this.currentScene.id,onClose:()=>{this.closeStructureOverlay({toTour:!0})},onNodeClick:(n,o)=>{this.closeStructureOverlay({toTour:!1}),W(n,o)}}),this.appElement.appendChild(this.structureView3D.getElement())}this.isStructureOverlayOpen=!0,document.body.style.overflow="hidden",this.structureView3D.open()}closeStructureOverlay(e){if(this.isStructureOverlayOpen){if(this.structure3DLoadToken+=1,this.isStructureOverlayOpen=!1,this.structureView2D){const t=this.structureView2D.getElement();t&&t.parentNode&&t.parentNode.removeChild(t),this.structureView2D=null}if(this.structureView3D){const t=this.structureView3D.getElement();t&&t.parentNode&&t.parentNode.removeChild(t),this.structureView3D=null}document.body.style.overflow="",document.body.style.touchAction="",document.body.style.overscrollBehavior="",e.toTour&&(this.mode="tour",this.topModeTabs&&this.topModeTabs.setMode("tour"))}}async openNorthCalibration(e){if(this.northCalibrationPanel&&(this.northCalibrationPanel.close(),this.northCalibrationPanel=null),!this.panoViewer){console.warn("[openNorthCalibration] PanoViewer 鏈垵濮嬪寲");return}try{const{NorthCalibrationPanel:t}=await D(async()=>{const{NorthCalibrationPanel:i}=await import("./editor-debug-_leEjMgs.js").then(n=>n.N);return{NorthCalibrationPanel:i}},__vite__mapDeps([3,4]),import.meta.url);this.northCalibrationPanel=new t({getCurrentYaw:()=>{var n;const i=(n=this.panoViewer)==null?void 0:n.getCurrentView();return(i==null?void 0:i.yaw)??0},sceneId:e,onClose:()=>{this.northCalibrationPanel=null}})}catch(t){console.error("[openNorthCalibration] 鍒涘缓鏍″噯闈㈡澘澶辫触:",t),this.northCalibrationPanel=null}}showError(e){this.hideUIError(),this.uiErrorElement=document.createElement("div"),this.uiErrorElement.className="error-message",this.uiErrorElement.textContent=e,this.uiErrorElement.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 16px;
      text-align: center;
      max-width: 80vw;
    `,this.appElement.appendChild(this.uiErrorElement),setTimeout(()=>{this.hideUIError()},3e3)}openDingHuQingYuan(){if(this.brandMark)try{this.brandMark.getAboutModal().open()}catch(e){P&&console.debug("[openDingHuQingYuan] 鎵撳紑鍥㈤槦浠嬬粛澶辫触:",e)}}openInfoModal(){var o,a,c;(o=this.infoModalMounted)==null||o.close(),this.infoModalMounted=null;const e=((a=this.currentMuseum)==null?void 0:a.name)||"-",t=((c=this.currentScene)==null?void 0:c.name)||"-",i=document.createElement("div");i.className="vr-modal-info-list",i.innerHTML=`
      <div><span class="vr-modal-info-row-label">灞曢</span><span>${e}</span></div>
      <div><span class="vr-modal-info-row-label">鍦烘櫙</span><span>${t}</span></div>
      <div><span class="vr-modal-info-row-label">閲囬泦鏃堕棿</span><span> 2025-12-27</span></div>
      <div class="vr-modal-info-copyright">
        <button type="button" role="button" class="vr-modal-info-copyright-btn">漏 2025 榧庤檸娓呮簮</button>
      </div>
    `;const n=i.querySelector(".vr-modal-info-copyright-btn");n&&n.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.infoModalMounted&&this.infoModalMounted.close(),setTimeout(()=>{this.openDingHuQingYuan()},0)}),this.infoModalMounted=mt({title:"淇℃伅",contentEl:i,onClose:()=>{this.infoModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"info"}}))}})}async toggleVrModeFromUI(e){if(!this.panoViewer)return!1;if(ye())return _t(),this.panoViewer.setVrModeEnabled(!1),this.topRightControls&&this.topRightControls.updateVrModeState(!1),await Ye(),!1;{try{await Tt(e)}catch(o){return P&&console.debug("[VRMode] fullscreen request failed",o),!1}const i=this.panoViewer.getCurrentView();return Os(()=>{var o;return((o=this.panoViewer)==null?void 0:o.isInteracting())??!1}),await Hs((o,a)=>{if(this.panoViewer){const c=i.yaw+o,l=Math.max(-90,Math.min(90,i.pitch+a));this.panoViewer.setView(c,l)}})?(this.panoViewer.setVrModeEnabled(!0),this.topRightControls&&this.topRightControls.updateVrModeState(!0),!0):(await Ye(),!1)}}openSettingsModal(){var k;(k=this.settingsModalMounted)==null||k.close(),this.settingsModalMounted=null;const e=St(),t=Mt(),i=Oe(),n=document.createElement("div");n.className="vr-modal-settings-list";const o=document.createElement("div");o.className="vr-modal-settings-item-label",o.textContent="鐢昏川";const a=document.createElement("div");a.className="vr-modal-settings-quality";const c=document.createElement("button");c.className="vr-modal-settings-quality-btn",c.textContent="楂樻竻",c.dataset.level="high";const l=document.createElement("button");l.className="vr-modal-settings-quality-btn",l.textContent="鐪佹祦",l.dataset.level="low";const h=N=>{c.classList.toggle("is-active",N==="high"),l.classList.toggle("is-active",N==="low")};h(i);const u=N=>{!this.currentScene||!this.panoViewer||Oe()===N||(Ei(N),h(N),this.panoViewer.loadScene(this.currentScene,{preserveView:!0}))};c.addEventListener("click",()=>u("high")),l.addEventListener("click",()=>u("low")),a.appendChild(c),a.appendChild(l);const d=document.createElement("div");d.appendChild(o),d.appendChild(a);const m=document.createElement("div");m.className="vr-modal-settings-item-label",m.textContent="瑙嗚";const v=document.createElement("button");v.className="vr-modal-settings-row-btn",v.type="button",v.textContent="鎭㈠鍒濆瑙嗚",v.addEventListener("click",()=>{if(!this.currentScene||!this.panoViewer)return;const N=this.currentScene.initialView||{yaw:0,pitch:0,fov:75},pe=-(N.yaw||0),fe=N.pitch||0,ge=N.fov??75;this.panoViewer.setView(pe,fe,ge)});const w=document.createElement("div");w.appendChild(m),w.appendChild(v);const y=document.createElement("div");y.className="vr-modal-settings-item-label",y.textContent="VR 鐪奸暅";const g=document.createElement("button");g.className="vr-modal-settings-row-btn",g.type="button",g.textContent="VR 鐪奸暅";const p=()=>{const N=ye();g.classList.toggle("is-on",N)};if(e)p(),g.addEventListener("click",async()=>{if(!this.panoViewer)return;const N=this.panoViewer.getDomElement(),O=await this.toggleVrModeFromUI(N);ye(),p()});else if(t){g.classList.add("is-disabled");const N=()=>{Z("移动端可体验此功能",1500)};g.addEventListener("mouseenter",N),g.addEventListener("click",N)}const b=document.createElement("div");b.appendChild(y),b.appendChild(g);const I=document.createElement("div");I.className="vr-modal-settings-item-label",I.textContent="缂╂斁";const S=document.createElement("div");S.className="vr-modal-settings-quality",S.style.gap="8px";const _=document.createElement("button");_.className="vr-modal-settings-quality-btn",_.textContent="缂╁皬",_.style.minWidth="70px";const A=document.createElement("button");A.className="vr-modal-settings-quality-btn",A.textContent="鏀惧ぇ",A.style.minWidth="70px";const T=()=>{if(!this.panoViewer)return;const N=this.panoViewer.getCurrentView(),O=Math.min(120,N.fov*1.12);this.panoViewer.setFov(O)},R=()=>{if(!this.panoViewer)return;const N=this.panoViewer.getCurrentView(),O=Math.max(30,N.fov/1.12);this.panoViewer.setFov(O)};_.addEventListener("click",T),A.addEventListener("click",R),S.appendChild(_),S.appendChild(A);const L=document.createElement("div");L.appendChild(I),L.appendChild(S),n.appendChild(d),n.appendChild(w),n.appendChild(L),n.appendChild(b),this.bottomDock&&this.bottomDock.setMoreOpen(!0),this.settingsModalMounted=mt({title:"鏇村",contentEl:n,panelClassName:"vr-modal-settings",onClose:()=>{this.bottomDock&&this.bottomDock.setMoreOpen(!1),this.settingsModalMounted=null,window.dispatchEvent(new CustomEvent("vr:dock-tab-close",{detail:{tab:"settings"}}))}})}}new Fs;"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").catch(()=>{})});export{Y as A,ji as E,D as _,ps as a,Qi as b,qs as c,ns as d,re as e,us as f,Ws as g,Fi as h,C as i,zs as j,le as l,mt as m,W as n,ii as o,G as r,Z as s,ze as t,Kt as v};
