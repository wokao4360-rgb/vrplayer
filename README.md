# VR å…¨æ™¯ Web æ’­æ”¾å™¨ï¼ˆvrplayerï¼‰

è‡ªç ”çš„ VR å…¨æ™¯ Web æ’­æ”¾å™¨ï¼ŒåŸºäº Three.js å®ç°ã€‚æ”¯æŒå¤šé¦†å¤šåœºæ™¯ã€çƒ­ç‚¹å¯¼èˆªã€åœ°å›¾å¯¼è§ˆç­‰åŠŸèƒ½ã€‚  
æœ¬é¡¹ç›®é‡‡ç”¨ **AI åä½œï¼ˆCodex / Cursorï¼‰** å¼€å‘ï¼Œåä½œé“å¾‹è§ï¼š`AGENTS.md`ã€‚

---

## åŠŸèƒ½ç‰¹æ€§

- ğŸ›ï¸ å¤šé¦†å¤šåœºæ™¯ï¼š`museums â†’ scenes â†’ hotspots`
- ğŸ¯ çƒ­ç‚¹å¯¼èˆªï¼šscene çƒ­ç‚¹è·³è½¬ / video çƒ­ç‚¹æ’­æ”¾
- ğŸ—ºï¸ åœ°å›¾å¯¼è§ˆï¼šåœ°å›¾ç‚¹ä½åˆ‡æ¢åœºæ™¯ï¼ˆå¯é€‰ï¼‰
- ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šè§¦æ§æ‹–æ‹½ã€åŒæŒ‡ç¼©æ”¾ï¼ˆFOVï¼‰
- ğŸ¬ è§†é¢‘æ’­æ”¾ï¼šè§†é¢‘çƒ­ç‚¹å¼¹çª—æ’­æ”¾
- âš¡ æ¸è¿›å¼åŠ è½½ï¼š`panoLow` ä¼˜å…ˆæ˜¾ç¤ºï¼Œåå°åŠ è½½ `pano` é«˜æ¸…æ›¿æ¢

---

## æŠ€æœ¯æ ˆ

- Three.jsï¼ˆå…¨æ™¯çƒæ¸²æŸ“ï¼‰
- TypeScript
- Vite
- åŸç”Ÿ HTML/CSS/JSï¼ˆæ— é‡ UI æ¡†æ¶ä¾èµ–ï¼‰

---

## æœ¬åœ°å¼€å‘

### å®‰è£…ä¾èµ–
```bash
npm install
å¯åŠ¨å¼€å‘
bash
å¤åˆ¶ä»£ç 
npm run dev
èµ„æºç­–ç•¥ï¼ˆå¼ºçº¦æŸï¼‰
é»˜è®¤ç¨³å®šæ–¹æ¡ˆï¼ˆæ¨èï¼‰
å…³é”®å…¨æ™¯å›¾ / çº¹ç† / å›¾ç‰‡å…¨éƒ¨åŒæºæ”¾ Pages ç«™ç‚¹ç›®å½•ä¸­ï¼ˆä¾‹å¦‚ /assets/ã€/panos/ï¼‰

é¿å… R2 ä½œä¸ºå…³é”®çº¹ç†å­˜å‚¨ï¼ˆCORS + ç¼“å­˜æ’éšœæˆæœ¬é«˜ï¼‰

é…ç½®ï¼špublic/config.jsonï¼ˆå”¯ä¸€é…ç½®æºï¼‰
public/config.json æ˜¯å”¯ä¸€æºæ–‡ä»¶ã€‚
dist/config.json ä¸ docs/config.json éƒ½æ˜¯æ„å»ºäº§ç‰©ï¼Œç¦æ­¢æ‰‹æ”¹ã€‚

ç»“æ„æ¦‚è§ˆï¼ˆç¤ºæ„ï¼‰
json
å¤åˆ¶ä»£ç 
{
  "appName": "åº”ç”¨åç§°",
  "museums": [
    {
      "id": "museum_id",
      "name": "å±•é¦†åç§°",
      "cover": "å°é¢å›¾ URL",
      "map": { "image": "åœ°å›¾å›¾ç‰‡ URL", "width": 1000, "height": 600 },
      "scenes": [
        {
          "id": "scene_id",
          "name": "åœºæ™¯åç§°",
          "panoLow": "/assets/panos/xxx-low.jpg",
          "pano": "/assets/panos/xxx.jpg",
          "thumb": "/assets/thumbs/xxx.jpg",
          "initialView": { "yaw": 0, "pitch": 0, "fov": 75 },
          "northYaw": 0,
          "mapPoint": { "x": 420, "y": 310 },
          "hotspots": []
        }
      ]
    }
  ]
}
å­—æ®µè¯­ä¹‰ï¼ˆé¡¹ç›®æœ€ç»ˆçº¦å®šï¼‰
initialView.yawï¼šé¦–å±æœå‘ï¼ˆç°å®ä¸–ç•Œè§’åº¦ï¼‰

initialView.pitchï¼šé¦–å±ä¿¯ä»°

northYawï¼šç°å®ä¸–ç•ŒåŒ—å‘è§’åº¦ï¼ˆç›˜é¢ N æŒ‡å‘çš„æ–¹å‘ï¼‰

hotspots[].yaw/pitchï¼šçƒ­ç‚¹ä½ç½®ï¼ˆç°å®ä¸–ç•Œè§’åº¦ï¼‰

çƒ­ç‚¹ï¼ˆHotspotsï¼‰
type: "scene"ï¼šè·³è½¬åˆ°ç›®æ ‡ museum/sceneï¼Œå¯é€‰è®¾ç½®ç›®æ ‡ yaw/pitch

type: "video"ï¼šå¼¹å‡ºè§†é¢‘æ’­æ”¾å™¨æ’­æ”¾ target.url

æ¸è¿›å¼åŠ è½½ï¼španoLow / pano
æ¨èåŒæ—¶æä¾›ï¼š

panoLowï¼š2048Ã—1024ï¼Œ<2MB

panoï¼š4096Ã—2048ï¼Œ<10MB

è¡Œä¸ºï¼š

å…ˆåŠ è½½ panoLow å¿«é€Ÿå¯äº¤äº’

åå°åŠ è½½ pano æˆåŠŸåè‡ªåŠ¨æ›¿æ¢

pano å¤±è´¥åˆ™ç»§ç»­ç”¨ panoLowï¼ˆä¸ç™½å±ï¼‰

éƒ¨ç½²ï¼ˆCloudflare Pages / GitHub Pagesï¼‰
Cloudflare Pagesï¼ˆå½“å‰ç¨³å®šæ–¹æ¡ˆï¼‰
Pages Root directory = docs

ä¸ä½¿ç”¨ Pages è‡ªåŠ¨ buildï¼ˆæœ¬åœ° buildï¼‰

å‘å¸ƒ SOPï¼ˆå”¯ä¸€æ­£ç¡®ç‰ˆæœ¬ï½œPowerShellï¼‰
å¿…é¡»åœ¨ ç³»ç»Ÿ PowerShellï¼Œå¹¶ä¸”åœ¨ D:\Projects\vrplayerï¼ˆå¸¦ .git çš„ç›®å½•ï¼‰æ‰§è¡Œã€‚

powershell
å¤åˆ¶ä»£ç 
cd D:\Projects\vrplayer
git checkout main
git pull --rebase origin main
npm run build
robocopy .\dist .\docs /MIR
git add -A
git commit -m "chore: publish"
git push origin main
å‘å¸ƒæˆåŠŸçš„å”¯ä¸€åˆ¤æ–­æ ‡å‡†ï¼š

git log -1 æ˜¯åˆšåˆšçš„ commit

GitHub ä»“åº“é¦–é¡µæœ€æ–° commit å·²æ›´æ–°

Pages å·²éƒ¨ç½²åˆ°è¯¥ commit

å†è¿›è¡Œæµè§ˆå™¨ç¡¬åˆ·æ–°éªŒè¯ï¼ˆCtrl+F5 / æ— ç—•ï¼‰

å¸¸è§çˆ†é›·ä¸æ’æŸ¥é¡ºåºï¼ˆåªæŒ‰è¿™ä¸ªé¡ºåºï¼‰
1) çº¿ä¸Šæ²¡å˜åŒ–ï¼ˆ90% ä¸æ˜¯ä»£ç ï¼‰
ä¼˜å…ˆæ£€æŸ¥ï¼šæ˜¯å¦æ¼äº† robocopy / æ˜¯å¦æ²¡æœ‰æ–° commit / push æ˜¯å¦æˆåŠŸ / Pages æ˜¯å¦éƒ¨ç½²åˆ°è¯¥ commit / æ˜¯å¦ç¼“å­˜

2) ç™½å± + module script MIME type is video/mp2t
ä¼˜å…ˆæ£€æŸ¥ï¼šPages Root directory ä¸äº§ç‰©ç›®å½•æ˜¯å¦å¯¹é½
æœ¬é¡¹ç›®è¦æ±‚ï¼šdist â†’ docs â†’ deploy

3) R2 èµ„æºèƒ½æ‰“å¼€ä½† three.js åŠ è½½å¤±è´¥
åŸå› é€šå¸¸æ˜¯ï¼šCORS å¤´æˆ–ç¼“å­˜å¯¼è‡´ WebGL è¢«æ‹’ç»
é»˜è®¤ç­–ç•¥ï¼šå…³é”®çº¹ç†åŒæºæ”¾ Pages

Agent Notes (Persistent) â€” ç»™â€œæ–° Codex çª—å£â€çš„å¿«é€Ÿå®šä½åŒº
æœ¬åŒºæ˜¯â€œæ–­ä¸Šä¸‹æ–‡æ¢å¤åŒºâ€ã€‚å½“å‘ç°æ–°çš„å…³é”®å‘æˆ–æ–°é“å¾‹æ—¶ï¼Œå¿…é¡»è¡¥å……åˆ°è¿™é‡Œï¼ˆä¿æŒçŸ­ã€å¯æœç´¢ï¼‰ã€‚

åä½œé“å¾‹ï¼ˆæ‘˜è¦ï¼‰
ç”¨æˆ·åªæ‰§è¡Œ Cursor/PowerShell

ä¸çœ‹æ§åˆ¶å°ï¼Œä¸æ‰‹æ”¹ configï¼Œä¸ç»™å¤šæ–¹æ¡ˆï¼Œä¸å…è®¸â€œè¯•è¯•çœ‹â€

ä¿®æ”¹å¿…é¡»å¯å‘å¸ƒã€ä¸”ç¡®è®¤å·²å‘å¸ƒåå†éªŒè¯

ä¸‰ç½—ç›˜ç³»ç»Ÿï¼ˆå¿…é¡»åŒæ­¥ä¿®æ”¹ï¼‰
src/ui/CompassDisk.ts

src/ui/GroundHeadingMarker.ts

src/viewer/NadirPatch.ts

åæ ‡ç³»é“å¾‹ï¼ˆåªå…è®¸ä¸€ä¸ªå…¥å£å–åä¸€æ¬¡ï¼‰
config/URL yaw = ç°å®ä¸–ç•Œè§’åº¦

internalYaw = -worldYawï¼ˆåªåœ¨ä¸€ä¸ªå…¥å£åšä¸€æ¬¡ï¼‰

ç½—ç›˜äº§å“æœ€ç»ˆå½¢æ€ï¼ˆä¸å…è®¸æ”¹è®¾è®¡ï¼‰
ç›˜é¢è¡¨ç¤º northYawï¼ˆä¸–ç•ŒåŒ—ï¼‰

æŒ‡é’ˆè¡¨ç¤º cameraYawï¼ˆç›¸æœºæœå‘ï¼‰

ç›˜é¢ä¸è·Ÿç›¸æœºè½¬ï¼›æŒ‡é’ˆè·Ÿç›¸æœºè½¬

å½“ cameraYaw == northYawï¼šæŒ‡é’ˆè§’åº¦å¿…é¡»ä¸º 0 ä¸”æŒ‡å‘ç›˜é¢ N


## Working Notes (Codex)
- 2026-01-26: ç“¦ç‰‡åŠ è½½æ›¿æ¢æ–¹æ¡ˆè½åœ°ï¼Œ`panoTiles.manifest` ä¼˜å…ˆï¼Œå¤±è´¥è‡ªåŠ¨å›é€€åˆ° fallbackPano/panoLowï¼›ä¸å†ä¾èµ–å¤–ç½‘ URLã€‚
- æºå›¾æ”¾ç½®ï¼š`public/assets/panos/demo.jpg`ï¼›ç“¦ç‰‡è¾“å‡ºå›ºå®šåœ¨ `public/assets/panos/tiles/<scene>/`ï¼Œç”Ÿæˆåéœ€å…¥åº“ã€‚
- ç”Ÿæˆè„šæœ¬ï¼š`npm run tiles:yhc-dongwu3`ï¼ˆå°è£… `scripts/generate-pano-tiles.mjs`ï¼Œå›ºå®š tileSize=512ï¼Œz0 1x1 â†’ z1 2x1 â†’ z2 4x2 â†’ z3 8x4ï¼‰ï¼Œå¯é‡å¤æ‰§è¡Œã€‚
- manifest ç»“æ„ï¼š`type`ã€`tileSize`ã€`levels[{z,cols,rows}]`ã€`baseUrl`ï¼›æ”¾åœ¨è¾“å‡ºç›®å½• `manifest.json`ã€‚
- Viewer åˆ¤å®šé¡ºåºï¼šè‹¥ scene.panoTiles.manifest å­˜åœ¨åˆ™èµ°ç“¦ç‰‡ â†’ å¤±è´¥åˆ™å›é€€ fallback â†’ è‹¥ä»æ— åˆ™æŒ‰æ—§ pano/panoLow æµç¨‹ã€‚
- é¦–å±ç­–ç•¥ï¼šå…ˆåŠ è½½ z0 å•å¼ åº•å›¾ï¼Œç«‹å³å‡ºç”»é¢ï¼›éšåæŒ‰è§†è§’ä¼˜å…ˆä¾æ¬¡è¡¥é½ z2ï¼ˆä½æ¸…ï¼‰â†’ z3ï¼ˆé«˜æ¸…ï¼‰ã€‚
- è§†è§’ä¼˜å…ˆç®—æ³•ï¼šåŸºäºç›¸æœº forward å‘é‡ä¸ tile ä¸­å¿ƒæ–¹å‘ç‚¹ç§¯ï¼›é˜ˆå€¼ `cos(fov/2+20Â°)`ï¼›æ¯ 150ms é‡æ–°æ’é˜Ÿï¼Œé¿å…æŠ–åŠ¨ã€‚
- åŠ è½½é¡ºåº/å¹¶å‘ï¼šz2 é˜Ÿåˆ—ä¼˜å…ˆï¼Œå…¶æ¬¡ z3ï¼›å¹¶å‘ 4ï¼›åŒä¸€ tile çŠ¶æ€ empty/loading/readyï¼Œä¸é‡å¤è¯·æ±‚ã€‚
- LRUï¼šz3 ä¿ç•™ 64 å¼ ï¼Œè¶…å‡ºç«‹å³é‡Šæ”¾çº¹ç†ï¼Œé˜²æ­¢å†…å­˜æš´æ¶¨ã€‚
- å›é€€ä¿éšœï¼šmanifest æ‹‰å–æˆ– tile å¤±è´¥ä¼šè‡ªåŠ¨è½¬ç”¨ fallback pano/panoLowï¼›ä»ç¼ºå¤±åˆ™æŠ¥é”™ï¼Œä¸ç™½å±ã€‚
- ç½—ç›˜/æ‹¾å–/çƒ­ç‚¹æ— æ”¹åŠ¨ï¼›ä»…æ¸²æŸ“ç®¡çº¿æ–°å¢ TilePanoSphereã€‚
- è·¯å¾„ä¸åŒæºï¼šæ‰€æœ‰ç“¦ç‰‡ä¸ manifest å‡åœ¨ `public/` ä¸‹ï¼Œé¿å…è·¨åŸŸä¸ MIME é—®é¢˜ã€‚
- å‘å¸ƒé“¾è·¯å¼ºåˆ¶ï¼š`npm run tiles:yhc-dongwu3 && npm run build && robocopy dist -> docs /MIR && git add -A && git commit && git push`ï¼Œç¦æ­¢ç›´æ¥æ”¹ docs/distã€‚
- ä¸è¦æ‰‹åŠ¨ç¼–è¾‘ `docs/`ã€`dist/`ï¼›ä»…é€šè¿‡ build+robocopy ç”Ÿæˆã€‚
- æ¨è™åŸçºªå¿µé¦†ã€Œä¸œå±‹3ã€å·²åˆ‡æ¢ä¸ºæœ¬åœ° demo.jpg ç“¦ç‰‡ï¼›åŸå¤–é“¾ URL è®°å½•åœ¨ `panoTiles.fallback*` ä¾¿äºå›é€€ã€‚
- çƒ­ç‚¹æ–‡æœ¬æ ‡ç­¾ä¿ç•™ï¼š`src/ui/Hotspots.ts` + `.hotspot-label`ï¼Œéšçƒ­ç‚¹ä¸€èµ·ç§»åŠ¨/æ˜¾éšã€‚
- ä¸­æ–‡ä¹±ç æ ¹å› ï¼šæ›¾ç”¨ PowerShell é‡å®šå‘ç”Ÿæˆ UTF-16 BOM æ–‡ä»¶ï¼Œæµè§ˆå™¨è§£ç é”™è¯¯å¯¼è‡´æ–‡å­—å¼‚å¸¸ï¼›å·²æ”¹ä¸º UTF-8 æ—  BOM å¹¶æ¢å¤ä¸­æ–‡å†…å®¹ã€‚
- é»‘å±æ ¹å› ï¼šç“¦ç‰‡æ¨¡å¼ç§»é™¤äº†æ•´å›¾åç­‰å¾…é¦–ç“¦ç‰‡ï¼Œæ–¹å‘åˆ¤å®šåå·®ä»…åŠ è½½å°‘é‡ç“¦ç‰‡ï¼›ç°æ–°å¢ panoLow/pano å…œåº•é¦–å±ï¼Œä¿®æ­£ tile ä¸­å¿ƒæ–¹å‘ & é˜Ÿåˆ—æŒç»­åŠ è½½ï¼Œä¿è¯â€œæ°¸ä¸é»‘å±â€ã€‚
- é»‘å±é—ªçƒäºŒæ¬¡æ ¹å› ï¼šç“¦ç‰‡ z0 å°±ç»ªå³ç§»é™¤å…œåº•ï¼Œå®é™…å¯è§ç“¦ç‰‡æœªç¨³å®šæ¸²æŸ“å¯¼è‡´å›é»‘ï¼›ç°æ”¹ä¸ºâ€œå¯è§å¸§ç¡®è®¤â€å¹¶ä¿ç•™å…œåº•è‡³è¿ç»­ 10 å¸§ tilesActiveCount>0ã€‚
- æ¸²æŸ“é¡ºåºï¼šfallback sphere renderOrder=0 ä¸” depthTest/depthWrite=falseï¼›tiles renderOrder=1ã€opacity å—æ§ï¼Œæœªå¯è§å‰ä¿æŒ 0ï¼Œä¸å†é®æŒ¡å…œåº•ã€‚
- çŠ¶æ€æ¡ï¼šåŠ  `?tilesDebug=1` å¯åœ¨å·¦ä¸Šè§’æŸ¥çœ‹ mode/tilesActiveCount/lastErrorï¼Œæ— éœ€æ§åˆ¶å°æ’æŸ¥ã€‚
- æ”¾å¼ƒå¤š mesh ç“¦ç‰‡ï¼šTilePanoSphere æ–¹æ¡ˆçš„ UV/å‡ ä½•æ‹†åˆ†å¯¼è‡´ equirect ç“¦ç‰‡ä¸å¯è§ï¼Œæ”¹ç”¨å•çƒ + CanvasTexture æ‹¼ç“¦ç‰‡ï¼ˆTileCanvasPanoï¼‰ï¼Œtile ä»…ä½œé€»è¾‘åˆ†å—ã€‚
- Canvas æ‹¼ç“¦ç‰‡ï¼šæŒ‰ manifest è¯»å– z0 é¦–å±ï¼Œz2/z3 è§†è§’é©±åŠ¨åŠ è½½å¹¶ç»˜åˆ¶åˆ°åŒä¸€ canvasï¼Œå†é©±åŠ¨ MeshBasicMaterial(map=CanvasTexture)ï¼›ä¿ç•™ manifest/ç”Ÿæˆå‘½ä»¤ä¸å˜ï¼Œä»…å½±å“ä¸œå±‹3ã€‚
- å‘å¸ƒé“å¾‹ï¼š`npm run build && robocopy dist docs /MIR && git add -A && git commit && git push`ï¼Œä¸¥ç¦ç›´æ¥ä¿®æ”¹ docs/distã€‚
- 2026-01-27: å†æ¬¡é»‘å±æ ¹å› ï¼šå¤š mesh æ–¹æ¡ˆå·²ç§»é™¤ï¼Œä½† Canvas æ¨¡å¼å­˜åœ¨ç”»å¸ƒå°ºå¯¸/é˜Ÿåˆ—è®¡ç®—ä¸ç¨³ï¼Œtiles è¯·æ±‚åœæ»ä¸” WebGL æŠ¥ offset æº¢å‡ºï¼Œä½æ¸…æç¤ºä¸æ¶ˆå¤±ã€‚ä¿®å¤ï¼šcanvas å°ºå¯¸å›ºå®šä¸º zMax(cols*tileSize, rows*tileSize)ï¼Œç»˜åˆ¶å‰ clamp åæ ‡ï¼Œä»…å…¨é‡ CanvasTexture æ›´æ–°ï¼›è§†è§’ç»çº¬åº¦â†’tile èŒƒå›´æ˜ å°„ï¼Œå§‹ç»ˆé˜Ÿåˆ—ä¸­å¿ƒ+é‚»è¿‘ tilesï¼Œä¿æŒ z0 é¦–å±ã€z2/z3 æŒç»­è¯·æ±‚ï¼›tilesDebug æ˜¾ç¤º queued/loading/loaded/lastErrorï¼Œä½æ¸…é¦–å¸§å³æ ‡è®° ready éšè—æç¤ºï¼Œä»…ä¸œå±‹3 å—å½±å“ã€‚
